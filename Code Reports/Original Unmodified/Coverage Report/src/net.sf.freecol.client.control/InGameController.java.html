<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>InGameController.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">src (May 7, 2016 6:04:12 PM)</a> &gt; <a href="../../index.html" class="el_group">FreeCol</a> &gt; <a href="../index.html" class="el_bundle">src</a> &gt; <a href="index.source.html" class="el_package">net.sf.freecol.client.control</a> &gt; <span class="el_source">InGameController.java</span></div><h1>InGameController.java</h1><pre class="source lang-java linenums"><span class="nc" id="L1">/**</span>
 *  Copyright (C) 2002-2016   The FreeCol Team
 *
 *  This file is part of FreeCol.
 *
 *  FreeCol is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  FreeCol is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with FreeCol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package net.sf.freecol.client.control;

import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.logging.Level;
import java.util.logging.Logger;
import java.util.stream.Collectors;

import net.sf.freecol.FreeCol;
import net.sf.freecol.client.ClientOptions;
import net.sf.freecol.client.FreeColClient;
import net.sf.freecol.client.gui.ChoiceItem;
import net.sf.freecol.client.gui.GUI;
import net.sf.freecol.client.gui.option.FreeColActionUI;
import net.sf.freecol.common.debug.DebugUtils;
import net.sf.freecol.common.debug.FreeColDebugger;
import net.sf.freecol.common.i18n.Messages;
import net.sf.freecol.common.i18n.NameCache;
import net.sf.freecol.common.io.FreeColDirectories;
import net.sf.freecol.common.model.Ability;
import net.sf.freecol.common.model.AbstractGoods;
import net.sf.freecol.common.model.AbstractUnit;
import net.sf.freecol.common.model.BuildableType;
import net.sf.freecol.common.model.Building;
import net.sf.freecol.common.model.Colony;
import net.sf.freecol.common.model.ColonyTile;
import net.sf.freecol.common.model.ColonyWas;
import static net.sf.freecol.common.model.Constants.*;
import net.sf.freecol.common.model.DiplomaticTrade;
import net.sf.freecol.common.model.DiplomaticTrade.TradeContext;
import net.sf.freecol.common.model.DiplomaticTrade.TradeStatus;
import net.sf.freecol.common.model.Europe;
import net.sf.freecol.common.model.Europe.MigrationType;
import net.sf.freecol.common.model.EuropeWas;
import net.sf.freecol.common.model.FoundingFather;
import net.sf.freecol.common.model.FreeColGameObject;
import net.sf.freecol.common.model.FreeColObject;
import net.sf.freecol.common.model.Game;
import net.sf.freecol.common.model.GameOptions;
import net.sf.freecol.common.model.GoldTradeItem;
import net.sf.freecol.common.model.Goods;
import net.sf.freecol.common.model.GoodsType;
import net.sf.freecol.common.model.HighScore;
import net.sf.freecol.common.model.IndianSettlement;
import net.sf.freecol.common.model.Location;
import net.sf.freecol.common.model.LostCityRumour;
import net.sf.freecol.common.model.Map;
import net.sf.freecol.common.model.Direction;
import net.sf.freecol.common.model.Market;
import net.sf.freecol.common.model.MarketWas;
import net.sf.freecol.common.model.ModelMessage;
import net.sf.freecol.common.model.ModelMessage.MessageType;
import net.sf.freecol.common.model.Monarch.MonarchAction;
import net.sf.freecol.common.model.Nameable;
import net.sf.freecol.common.model.NationSummary;
import net.sf.freecol.common.model.Ownable;
import net.sf.freecol.common.model.PathNode;
import net.sf.freecol.common.model.Player;
import net.sf.freecol.common.model.Player.NoClaimReason;
import net.sf.freecol.common.model.Stance;
import net.sf.freecol.common.model.Region;
import net.sf.freecol.common.model.Role;
import net.sf.freecol.common.model.Settlement;
import net.sf.freecol.common.model.Specification;
import net.sf.freecol.common.model.StanceTradeItem;
import net.sf.freecol.common.model.StringTemplate;
import net.sf.freecol.common.model.Tile;
import net.sf.freecol.common.model.TileImprovementType;
import net.sf.freecol.common.model.TradeLocation;
import net.sf.freecol.common.model.TradeRoute;
import net.sf.freecol.common.model.TradeRouteStop;
import net.sf.freecol.common.model.Turn;
import net.sf.freecol.common.model.Unit;
import net.sf.freecol.common.model.Unit.UnitState;
import net.sf.freecol.common.model.UnitType;
import net.sf.freecol.common.model.UnitTypeChange.ChangeType;
import net.sf.freecol.common.model.UnitWas;
import net.sf.freecol.common.model.WorkLocation;
import static net.sf.freecol.common.util.CollectionUtils.*;
import net.sf.freecol.common.util.LogBuilder;
import net.sf.freecol.common.networking.ServerAPI;
import net.sf.freecol.common.option.BooleanOption;
import net.sf.freecol.server.FreeColServer;


/**
 * The controller that will be used while the game is played.
 */
public final class InGameController extends FreeColClientHolder {

<span class="fc" id="L116">    private static final Logger logger = Logger.getLogger(InGameController.class.getName());</span>

    /**
     * Selecting next unit depends on mode--- either from the active list,
     * from the going-to list, or flush going-to and end the turn.
     */
<span class="fc" id="L122">    private static enum MoveMode {</span>
<span class="fc" id="L123">        NEXT_ACTIVE_UNIT,</span>
<span class="fc" id="L124">        EXECUTE_GOTO_ORDERS,</span>
<span class="fc" id="L125">        END_TURN;</span>

        public MoveMode minimize(MoveMode m) {
<span class="nc bnc" id="L128" title="All 2 branches missed.">            return (this.ordinal() &gt; m.ordinal()) ? m : this;</span>
        }

        public MoveMode maximize(MoveMode m) {
<span class="nc bnc" id="L132" title="All 2 branches missed.">            return (this.ordinal() &lt; m.ordinal()) ? m : this;</span>
        }
    }

    private static final short UNIT_LAST_MOVE_DELAY = 300;

    /** A template to use as a magic cookie for aborted trades. */
<span class="fc" id="L139">    private static final StringTemplate abortTrade</span>
<span class="fc" id="L140">        = StringTemplate.template(&quot;&quot;);</span>

    /** A comparator for ordering trade route units. */
<span class="fc" id="L143">    private static final Comparator&lt;Unit&gt; tradeRouteUnitComparator</span>
<span class="pc" id="L144">        = Comparator.comparing((Unit u) -&gt; u.getTradeRoute().getName())</span>
<span class="pc" id="L145">            .thenComparing(u -&gt; (FreeColObject)u);</span>

    /** Current mode for moving units. */
<span class="fc" id="L148">    private MoveMode moveMode = MoveMode.NEXT_ACTIVE_UNIT;</span>

    /** A map of messages to be ignored. */
<span class="fc" id="L151">    private final HashMap&lt;String, Integer&gt; messagesToIgnore = new HashMap&lt;&gt;();</span>

    /** The messages in the last turn report. */
<span class="fc" id="L154">    private final List&lt;ModelMessage&gt; turnReportMessages = new ArrayList&lt;&gt;();</span>


    /**
     * The constructor to use.
     *
     * @param freeColClient The &lt;code&gt;FreeColClient&lt;/code&gt; for the game.
     */
    public InGameController(FreeColClient freeColClient) {
<span class="fc" id="L163">        super(freeColClient);</span>

        // FIXME: fetch value of lastSaveGameFile from a persistent
        // client value
        //   lastSaveGameFile = new File(getClientOptions().getString(null));
<span class="fc" id="L168">    }</span>


    // Simple utilities

    /**
     * Play a sound.
     *
     * @param soundKey The sound resource key.
     */
    private void sound(String soundKey) {
<span class="nc" id="L179">        getSoundController().playSound(soundKey);</span>
<span class="nc" id="L180">    }</span>
    
    /**
     * Require that it is this client's player's turn.
     * Put up the notYourTurn message if not.
     *
     * @return True if it is our turn.
     */
    private boolean requireOurTurn() {
<span class="nc bnc" id="L189" title="All 2 branches missed.">        if (currentPlayerIsMyPlayer()) return true;</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">        if (getFreeColClient().isInGame()) {</span>
<span class="nc" id="L191">            getGUI().showInformationMessage(&quot;info.notYourTurn&quot;);</span>
        }
<span class="nc" id="L193">        return false;</span>
    }

    /**
     * Display the colony panel for a colony, and select the unit that just
     * arrived there if it is a carrier.
     *
     * @param colony The &lt;code&gt;Colony&lt;/code&gt; to display.
     * @param unit An optional &lt;code&gt;Unit&lt;/code&gt; to select.
     */
    private void colonyPanel(Colony colony, Unit unit) {
<span class="nc bnc" id="L204" title="All 2 branches missed.">        getGUI().showColonyPanel(colony, (unit.isCarrier()) ? unit : null);</span>
<span class="nc" id="L205">    }</span>

    /**
     * Convenience function to find an adjacent settlement.  Intended
     * to be called in contexts where we are expecting a settlement to
     * be there, such as when handling a particular move type.
     *
     * @param tile The &lt;code&gt;Tile&lt;/code&gt; to start at.
     * @param direction The &lt;code&gt;Direction&lt;/code&gt; to step.
     * @return A settlement on the adjacent tile if any.
     */
    private Settlement getSettlementAt(Tile tile, Direction direction) {
<span class="nc" id="L217">        return tile.getNeighbourOrNull(direction).getSettlement();</span>
    }

    /**
     * Convenience function to find the nation controlling an adjacent
     * settlement.  Intended to be called in contexts where we are
     * expecting a settlement or unit to be there, such as when
     * handling a particular move type.
     *
     * @param tile The &lt;code&gt;Tile&lt;/code&gt; to start at.
     * @param direction The &lt;code&gt;Direction&lt;/code&gt; to step.
     * @return The name of the nation controlling a settlement on the
     *         adjacent tile if any.
     */
    private StringTemplate getNationAt(Tile tile, Direction direction) {
<span class="nc" id="L232">        Tile newTile = tile.getNeighbourOrNull(direction);</span>
<span class="nc" id="L233">        Player player = null;</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">        if (newTile.hasSettlement()) {</span>
<span class="nc" id="L235">            player = newTile.getSettlement().getOwner();</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">        } else if (newTile.getFirstUnit() != null) {</span>
<span class="nc" id="L237">            player = newTile.getFirstUnit().getOwner();</span>
<span class="nc" id="L238">        } else { // should not happen</span>
<span class="nc" id="L239">            player = getGame().getUnknownEnemy();</span>
        }
<span class="nc" id="L241">        return player.getNationLabel();</span>
    }

    /**
     * Update the GUI and the active unit with a fallback tile.
     *
     * @param tile An optional fallback &lt;code&gt;Tile&lt;/code&gt; to display if
     *     no active unit is found, useful when the last unit might have
     *     died.
     */
    private void updateGUI(Tile tile) {
<span class="nc bnc" id="L252" title="All 2 branches missed.">        if (displayModelMessages(false, false)) {</span>
            ; // If messages are displayed they probably refer to the
              // current unit, so do not update it.
<span class="nc bnc" id="L255" title="All 2 branches missed.">        } else if (updateActiveUnit(tile)) {</span>
            ; // setActiveUnit will update the menu bar
<span class="nc" id="L257">        } else {</span>
<span class="nc" id="L258">            getGUI().updateMapControls();</span>
<span class="nc" id="L259">            getGUI().updateMenuBar();</span>
        }
<span class="nc" id="L261">    }</span>


    // Server access routines called from multiple places.

    /**
     * Ask the server to assign a trade route.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to assign to.
     * @param tradeRoute The &lt;code&gt;TradeRoute&lt;/code&gt; to assign.
     * @return True if the assignment succeeds.
     */
    private boolean askAssignTradeRoute(Unit unit, TradeRoute tradeRoute) {
<span class="nc bnc" id="L274" title="All 2 branches missed.">        if (tradeRoute == unit.getTradeRoute()) return true;</span>

<span class="nc bnc" id="L276" title="All 4 branches missed.">        if (tradeRoute != null &amp;&amp; unit.getTradeRoute() != null) {</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">            if (!getGUI().confirmClearTradeRoute(unit)) return false;</span>
        }

<span class="nc bnc" id="L280" title="All 2 branches missed.">        return askServer().assignTradeRoute(unit, tradeRoute)</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">            &amp;&amp; unit.getTradeRoute() == tradeRoute;</span>
    }

    /**
     * Claim a tile.
     *
     * @param player The &lt;code&gt;Player&lt;/code&gt; that is claiming.
     * @param tile The &lt;code&gt;Tile&lt;/code&gt; to claim.
     * @param claimant The &lt;code&gt;Unit&lt;/code&gt; or &lt;code&gt;Colony&lt;/code&gt; claiming.
     * @param price The price required.
     * @return True if the claim succeeded.
     */
    private boolean askClaimTile(Player player, Tile tile,
                                 FreeColGameObject claimant, int price) {
<span class="nc" id="L295">        final Player owner = tile.getOwner();</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">        if (price &lt; 0) { // not for sale</span>
<span class="nc" id="L297">            return false;</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">        } else if (price &gt; 0) { // for sale</span>
<span class="nc" id="L299">            ClaimAction act</span>
<span class="nc" id="L300">                = getGUI().getClaimChoice(tile, player, price, owner);</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">            if (act == null) return false; // Cancelled</span>
<span class="nc bnc" id="L302" title="All 3 branches missed.">            switch (act) {</span>
            case CLAIM_ACCEPT: // accepted price
<span class="nc" id="L304">                break;</span>
            case CLAIM_STEAL:
<span class="nc" id="L306">                price = STEAL_LAND;</span>
<span class="nc" id="L307">                break;</span>
            default:
<span class="nc" id="L309">                logger.warning(&quot;Claim dialog fail: &quot; + act);</span>
<span class="nc" id="L310">                return false;</span>
            }
        } // else price == 0 and we can just proceed to claim

        // Ask the server
<span class="nc bnc" id="L315" title="All 2 branches missed.">        return askServer().claimTile(tile, claimant, price)</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">            &amp;&amp; player.owns(tile);</span>
    }

    /**
     * Clears the goto orders of the given unit by setting its destination
     * to null.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to clear the destination for.
     * @return True if the unit now has no destination or trade route.
     */
    private boolean askClearGotoOrders(Unit unit) {
<span class="nc bnc" id="L327" title="All 2 branches missed.">        if (!askAssignTradeRoute(unit, null)) return false;</span>

<span class="nc bnc" id="L329" title="All 2 branches missed.">        if (unit.getDestination() == null) return true;</span>

<span class="nc bnc" id="L331" title="All 2 branches missed.">        if (askSetDestination(unit, null)) {</span>
<span class="nc" id="L332">            getGUI().clearGotoPath();</span>
<span class="nc" id="L333">            return true;</span>
        }
<span class="nc" id="L335">        return false;</span>
    }

    /**
     * Embark onto a carrier.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to embark.
     * @param carrier The carrier &lt;code&gt;Unit&lt;/code&gt; to board.
     * @return True if boarding succeeded.
     */
    private boolean askEmbark(Unit unit, Unit carrier) {
<span class="nc bnc" id="L346" title="All 2 branches missed.">        ColonyWas colonyWas = (unit.getColony() != null)</span>
<span class="nc" id="L347">            ? new ColonyWas(unit.getColony()) : null;</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">        EuropeWas europeWas = (unit.isInEurope())</span>
<span class="nc" id="L349">            ? new EuropeWas(unit.getOwner().getEurope()) : null;</span>
<span class="nc" id="L350">        UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">        if (askServer().embark(unit, carrier, null)</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">            &amp;&amp; unit.getLocation() == carrier) {</span>
<span class="nc" id="L353">            sound(&quot;sound.event.loadCargo&quot;);</span>
<span class="nc" id="L354">            unitWas.fireChanges();</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">            if (colonyWas != null) colonyWas.fireChanges();</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">            if (europeWas != null) europeWas.fireChanges();</span>
<span class="nc" id="L357">            return true;</span>
        }
<span class="nc" id="L359">        return false;</span>
    }
    
    /**
     * A unit in Europe emigrates.
     *
     * This is unusual for an ask* routine in that it uses a *Was
     * structure, but it is needed to extract the unit.
     *
     * @param europe The &lt;code&gt;Europe&lt;/code&gt; where the unit appears.
     * @param slot The slot to choose, [0..RECRUIT_COUNT].
     * @return The new &lt;code&gt;Unit&lt;/code&gt; or null on failure.
     */
    private Unit askEmigrate(Europe europe, int slot) {
<span class="nc bnc" id="L373" title="All 2 branches missed.">        if (europe == null</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">            || !MigrationType.validMigrantSlot(slot)) return null;</span>

<span class="nc" id="L376">        EuropeWas europeWas = new EuropeWas(europe);</span>
<span class="nc" id="L377">        Unit newUnit = null;</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">        if (askServer().emigrate(getGame(), slot)</span>
<span class="nc bnc" id="L379" title="All 2 branches missed.">            &amp;&amp; (newUnit = europeWas.getNewUnit()) != null) {</span>
<span class="nc" id="L380">            europeWas.fireChanges();</span>
        }
<span class="nc" id="L382">        return newUnit;</span>
    }

    /**
     * Select all the units to emigrate from Europe.  If they are all
     * the same they can be picked automatically, but otherwise use
     * the emigration dialog.  Only to be called if the player is
     * allowed to select the unit type (i.e. FoY or has Brewster).
     *
     * The server contains the count of available FoY-units, and
     * maintains the immigration/immigrationRequired amounts, so this
     * routine will fail harmlessly if it asks for too much.
     *
     * @param player The &lt;code&gt;Player&lt;/code&gt; that owns the unit.
     * @param n The number of units known to be eligible to emigrate.
     * @param fountainOfYouth True if this migration if due to a FoY.
     */
    private void emigration(Player player, int n, boolean fountainOfYouth) {
<span class="nc" id="L400">        final Europe europe = player.getEurope();</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">        if (europe == null) return;</span>

<span class="nc bnc" id="L403" title="All 4 branches missed.">        for (; n &gt; 0 || player.checkEmigrate() ; n--) {</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">            if (!allSame(europe.getRecruitables())) {</span>
<span class="nc" id="L405">                final int nf = n;</span>
<span class="nc" id="L406">                getGUI().showEmigrationDialog(player, fountainOfYouth,</span>
<span class="nc" id="L407">                    (Integer value) -&gt; { // Value is a valid slot</span>
<span class="nc" id="L408">                        emigrate(player,</span>
<span class="nc" id="L409">                            Europe.MigrationType.convertToMigrantSlot(value),</span>
<span class="nc" id="L410">                            nf-1, fountainOfYouth);</span>
<span class="nc" id="L411">                    });</span>
<span class="nc" id="L412">                return;</span>
            }
<span class="nc" id="L414">            Unit u = askEmigrate(europe, Europe.MigrationType.getDefaultSlot());</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">            if (u == null) break; // Give up on failure, try again next turn</span>
<span class="nc" id="L416">            player.addModelMessage(player.getEmigrationMessage(u));</span>
        }
<span class="nc" id="L418">    }</span>
   
    /**
     * Load some goods onto a carrier.
     *
     * @param loc The &lt;code&gt;Location&lt;/code&gt; to load from.
     * @param type The &lt;code&gt;GoodsType&lt;/code&gt; to load.
     * @param amount The amount of goods to load.
     * @param carrier The &lt;code&gt;Unit&lt;/code&gt; to load onto.
     * @return True if the load succeeded.
     */
    private boolean askLoadGoods(Location loc, GoodsType type, int amount,
                                 Unit carrier) {
<span class="nc" id="L431">        TradeLocation trl = carrier.getTradeLocation();</span>
<span class="nc bnc" id="L432" title="All 2 branches missed.">        if (trl == null) return false;</span>

        // Size check, if there are spare holds they can be filled, but...
<span class="nc" id="L435">        int loadable = carrier.getLoadableAmount(type);</span>
<span class="nc bnc" id="L436" title="All 2 branches missed.">        if (amount &gt; loadable) amount = loadable;</span>

<span class="nc" id="L438">        final Player player = carrier.getOwner();</span>
<span class="nc" id="L439">        final Market market = player.getMarket();</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">        MarketWas marketWas = (market != null) ? new MarketWas(player) : null;</span>

<span class="nc bnc" id="L442" title="All 2 branches missed.">        if (carrier.isInEurope()) {</span>
            // Are the goods boycotted?
<span class="nc bnc" id="L444" title="All 2 branches missed.">            if (!player.canTrade(type)) return false;</span>

            // Check that the purchase is funded.
<span class="nc bnc" id="L447" title="All 2 branches missed.">            if (!player.checkGold(market.getBidPrice(type, amount))) {</span>
<span class="nc" id="L448">                getGUI().showInformationMessage(&quot;info.notEnoughGold&quot;);</span>
<span class="nc" id="L449">                return false;</span>
            }
        }

        // Try to purchase.
<span class="nc" id="L454">        int oldAmount = carrier.getGoodsContainer().getGoodsCount(type);</span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">        if (askServer().loadGoods(loc, type, amount, carrier)</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">            &amp;&amp; carrier.getGoodsContainer().getGoodsCount(type) != oldAmount) {</span>
<span class="nc bnc" id="L457" title="All 2 branches missed.">            if (marketWas != null) marketWas.fireChanges(type, amount);</span>
<span class="nc" id="L458">            return true;</span>
        }
<span class="nc" id="L460">        return false;</span>
    }

    /**
     * Set a destination for a unit.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to direct.
     * @param destination The destination &lt;code&gt;Location&lt;/code&gt;.
     * @return True if the destination was set.
     */
    private boolean askSetDestination(Unit unit, Location destination) {
<span class="nc bnc" id="L471" title="All 2 branches missed.">        return askServer().setDestination(unit, destination)</span>
<span class="nc bnc" id="L472" title="All 2 branches missed.">            &amp;&amp; unit.getDestination() == destination;</span>
    }

    /**
     * Unload some goods from a carrier.
     *
     * @param type The &lt;code&gt;GoodsType&lt;/code&gt; to unload.
     * @param amount The amount of goods to unload.
     * @param carrier The &lt;code&gt;Unit&lt;/code&gt; carrying the goods.
     * @return True if the unload succeeded.
     */
    private boolean askUnloadGoods(GoodsType type, int amount, Unit carrier) {
        // Do not check for trade location, unloading can include dumping
        // which can happen anywhere
<span class="nc" id="L486">        final Player player = getMyPlayer();</span>
<span class="nc" id="L487">        final Market market = player.getMarket();</span>
<span class="nc bnc" id="L488" title="All 2 branches missed.">        MarketWas marketWas = (market != null) ? new MarketWas(player) : null;</span>

<span class="nc" id="L490">        int oldAmount = carrier.getGoodsContainer().getGoodsCount(type);</span>
<span class="nc bnc" id="L491" title="All 2 branches missed.">        if (askServer().unloadGoods(type, amount, carrier)</span>
<span class="nc bnc" id="L492" title="All 2 branches missed.">            &amp;&amp; carrier.getGoodsContainer().getGoodsCount(type) != oldAmount) {</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">            if (marketWas != null) marketWas.fireChanges(type, -amount);</span>
<span class="nc" id="L494">            return true;</span>
        }
<span class="nc" id="L496">        return false;</span>
    }


    // Utilities connected with saving the game

    /**
     * Get the trunk of the save game string.
     *
     * @param game The &lt;code&gt;Game&lt;/code&gt; to query.
     * @return The trunk of the file name to use for saved games.
     */
    private String getSaveGameString(Game game) {
<span class="nc" id="L509">        final Player player = getMyPlayer();</span>
<span class="nc" id="L510">        final String gid = Integer.toHexString(game.getUUID().hashCode());</span>
<span class="nc" id="L511">        final Turn turn = game.getTurn();</span>
<span class="nc" id="L512">        return (/* player.getName() + &quot;_&quot; */ gid</span>
<span class="nc" id="L513">            + &quot;_&quot; + Messages.message(player.getNationLabel())</span>
<span class="nc" id="L514">            + &quot;_&quot; + turn.getSaveGameSuffix()</span>
<span class="nc" id="L515">            + &quot;.&quot; + FreeCol.FREECOL_SAVE_EXTENSION)</span>
<span class="nc" id="L516">            .replaceAll(&quot; &quot;, &quot;_&quot;);</span>
    }

    /**
     * Creates at least one autosave game file of the currently played
     * game in the autosave directory.  Does nothing if there is no
     * game running.
     */
    private void autoSaveGame () {
<span class="nc" id="L525">        final Game game = getGame();</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">        if (game == null) return;</span>

        // unconditional save per round (fixed file &quot;last-turn&quot;)
<span class="nc" id="L529">        final ClientOptions options = getClientOptions();</span>
<span class="nc" id="L530">        final String prefix = options.getText(ClientOptions.AUTO_SAVE_PREFIX);</span>
<span class="nc" id="L531">        final String lastTurnName = prefix + &quot;-&quot;</span>
<span class="nc" id="L532">            + options.getText(ClientOptions.LAST_TURN_NAME)</span>
<span class="nc" id="L533">            + &quot;.&quot; + FreeCol.FREECOL_SAVE_EXTENSION;</span>
<span class="nc" id="L534">        final String beforeLastTurnName = prefix + &quot;-&quot;</span>
<span class="nc" id="L535">            + options.getText(ClientOptions.BEFORE_LAST_TURN_NAME)</span>
<span class="nc" id="L536">            + &quot;.&quot; + FreeCol.FREECOL_SAVE_EXTENSION;</span>
<span class="nc" id="L537">        File autoSaveDir = FreeColDirectories.getAutosaveDirectory();</span>
<span class="nc" id="L538">        File lastTurnFile = new File(autoSaveDir, lastTurnName);</span>
<span class="nc" id="L539">        File beforeLastTurnFile = new File(autoSaveDir, beforeLastTurnName);</span>
        // if &quot;last-turn&quot; file exists, shift it to &quot;before-last-turn&quot; file
<span class="nc bnc" id="L541" title="All 2 branches missed.">        if (lastTurnFile.exists()) {</span>
<span class="nc" id="L542">            beforeLastTurnFile.delete();</span>
<span class="nc" id="L543">            lastTurnFile.renameTo(beforeLastTurnFile);</span>
        }
<span class="nc" id="L545">        saveGame(lastTurnFile);</span>

        // conditional save after user-set period
<span class="nc" id="L548">        int saveGamePeriod = options.getInteger(ClientOptions.AUTOSAVE_PERIOD);</span>
<span class="nc" id="L549">        int turnNumber = game.getTurn().getNumber();</span>
<span class="nc bnc" id="L550" title="All 4 branches missed.">        if (saveGamePeriod &gt;= 1 &amp;&amp; turnNumber % saveGamePeriod == 0) {</span>
<span class="nc" id="L551">            String fileName = prefix + &quot;-&quot; + getSaveGameString(game);</span>
<span class="nc" id="L552">            saveGame(new File(autoSaveDir, fileName));</span>
        }
<span class="nc" id="L554">    }</span>

    /**
     * Saves the game to the given file.
     *
     * @param file The &lt;code&gt;File&lt;/code&gt;.
     * @return True if the game was saved.
     */
    private boolean saveGame(final File file) {
<span class="nc" id="L563">        final FreeColServer server = getFreeColServer();</span>
<span class="nc" id="L564">        boolean result = false;</span>
<span class="nc bnc" id="L565" title="All 2 branches missed.">        if (server != null) {</span>
<span class="nc" id="L566">            getGUI().showStatusPanel(Messages.message(&quot;status.savingGame&quot;));</span>
            try {
<span class="nc" id="L568">                server.saveGame(file, getClientOptions(), getGUI().getActiveUnit());</span>
<span class="nc" id="L569">                result = true;</span>
<span class="nc" id="L570">            } catch (IOException e) {</span>
<span class="nc" id="L571">                getGUI().showErrorMessage(FreeCol.badSave(file));</span>
<span class="nc" id="L572">            } finally {</span>
<span class="nc" id="L573">                getGUI().closeStatusPanel();</span>
<span class="nc" id="L574">            }</span>
        }
<span class="nc" id="L576">        return result;</span>
    }


    // Utilities for message handling.

    /**
     * Provides an opportunity to filter the messages delivered to the canvas.
     *
     * @param message the message that is candidate for delivery to the canvas
     * @return true if the message should be delivered
     */
    private boolean shouldAllowMessage(ModelMessage message) {
<span class="nc" id="L589">        BooleanOption option = getClientOptions().getBooleanOption(message);</span>
<span class="nc bnc" id="L590" title="All 2 branches missed.">        return (option == null) ? true : option.getValue();</span>
    }

    /**
     * Start ignoring a kind of message.
     *
     * @param key The key for a message to ignore.
     * @param turn The current &lt;code&gt;Turn&lt;/code&gt;.
     */
    private synchronized void startIgnoringMessage(String key, Turn turn) {
<span class="nc" id="L600">        messagesToIgnore.put(key, turn.getNumber());</span>
<span class="nc" id="L601">        logger.finer(&quot;Ignore message start: &quot; + key);</span>
<span class="nc" id="L602">    }</span>

    /**
     * Stop ignoring a kind of message.
     *
     * @param key The key for a message to stop ignoring.
     */
    private synchronized void stopIgnoringMessage(String key) {
<span class="nc" id="L610">        messagesToIgnore.remove(key);</span>
<span class="nc" id="L611">        logger.finer(&quot;Ignore message stop: &quot; + key);</span>
<span class="nc" id="L612">    }</span>

    /**
     * Reap all ignored message keys that are older than the given turn.
     *
     * @param turn The &lt;code&gt;Turn&lt;/code&gt; value to test against.
     */
    private synchronized void reapIgnoredMessages(Turn turn) {
<span class="nc" id="L620">        Iterator&lt;String&gt; keys = messagesToIgnore.keySet().iterator();</span>
<span class="nc bnc" id="L621" title="All 2 branches missed.">        while (keys.hasNext()) {</span>
<span class="nc" id="L622">            String key = keys.next();</span>
<span class="nc bnc" id="L623" title="All 2 branches missed.">            if (messagesToIgnore.get(key) &lt; turn.getNumber()) {</span>
<span class="nc" id="L624">                keys.remove();</span>
<span class="nc" id="L625">                logger.finer(&quot;Ignore message reap: &quot; + key);</span>
            }
        }
<span class="nc" id="L628">    }</span>

    /**
     * See if messages with a given key were ignored last turn.  If so,
     * continue to ignore them.
     *
     * @param key The key to check.
     * @param turn The current &lt;code&gt;Turn&lt;/code&gt;.
     * @return True if the message should continue to be ignored.
     */
    private synchronized boolean continueIgnoreMessage(String key, Turn turn) {
        Integer value;
<span class="nc bnc" id="L640" title="All 2 branches missed.">        if (key != null</span>
<span class="nc bnc" id="L641" title="All 2 branches missed.">            &amp;&amp; (value = messagesToIgnore.get(key)) != null</span>
<span class="nc bnc" id="L642" title="All 2 branches missed.">            &amp;&amp; value + 1 == turn.getNumber()) {</span>
<span class="nc" id="L643">            messagesToIgnore.put(key, value + 1);</span>
<span class="nc" id="L644">            logger.finer(&quot;Ignore message continue: &quot; + key);</span>
<span class="nc" id="L645">            return true;</span>
        }
<span class="nc" id="L647">        return false;</span>
    }

    /**
     * Displays the messages in the current turn report.
     */
    public void displayTurnReportMessages() {
<span class="nc" id="L654">        getGUI().showReportTurnPanel(turnReportMessages);</span>
<span class="nc" id="L655">    }</span>

    /**
     * Displays pending &lt;code&gt;ModelMessage&lt;/code&gt;s.
     *
     * @param allMessages Display all messages or just the undisplayed ones.
     * @param endOfTurn Use a turn report panel if necessary.
     * @return True if any messages were displayed.
     */
    public boolean displayModelMessages(final boolean allMessages,
                                        final boolean endOfTurn) {
<span class="nc" id="L666">        final Player player = getMyPlayer();</span>
<span class="nc" id="L667">        final Turn thisTurn = getGame().getTurn();</span>
<span class="nc" id="L668">        final ArrayList&lt;ModelMessage&gt; messages = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L670" title="All 4 branches missed.">        for (ModelMessage m : ((allMessages) ? player.getModelMessages()</span>
<span class="nc" id="L671">                : player.getNewModelMessages())) {</span>
<span class="nc bnc" id="L672" title="All 2 branches missed.">            if (shouldAllowMessage(m)</span>
<span class="nc bnc" id="L673" title="All 2 branches missed.">                &amp;&amp; !continueIgnoreMessage(m.getIgnoredMessageKey(), thisTurn)) {</span>
<span class="nc" id="L674">                messages.add(m);</span>
            }
<span class="nc" id="L676">            m.setBeenDisplayed(true);</span>
        }

<span class="nc" id="L679">        reapIgnoredMessages(thisTurn);</span>

<span class="nc bnc" id="L681" title="All 2 branches missed.">        if (!messages.isEmpty()) {</span>
            Runnable uiTask;
<span class="nc bnc" id="L683" title="All 2 branches missed.">            if (endOfTurn) {</span>
<span class="nc" id="L684">                turnReportMessages.addAll(messages);</span>
<span class="nc" id="L685">                uiTask = () -&gt; { displayTurnReportMessages(); };</span>
<span class="nc" id="L686">            } else {</span>
<span class="nc" id="L687">                uiTask = () -&gt; { getGUI().showModelMessages(messages); };</span>
            }
<span class="nc" id="L689">            getGUI().invokeNowOrWait(uiTask);</span>
        }
<span class="nc bnc" id="L691" title="All 2 branches missed.">        return !messages.isEmpty();</span>
    }


    // Utilities to handle the transitions between the active-unit,
    // execute-orders and end-turn states.

    /**
     * Do the goto orders operation.
     *
     * @return True if all goto orders have been performed and no units
     *     reached their destination and are free to move again.
     */
    private boolean doExecuteGotoOrders() {
<span class="nc bnc" id="L705" title="All 2 branches missed.">        if (getGUI().isShowingSubPanel()) return false; // Clear the panel first</span>

<span class="nc" id="L707">        final Player player = getMyPlayer();</span>
<span class="nc" id="L708">        final Unit active = getGUI().getActiveUnit();</span>
<span class="nc" id="L709">        Unit stillActive = null;</span>

        // Ensure the goto mode sticks.
<span class="nc" id="L712">        moveMode = moveMode.maximize(MoveMode.EXECUTE_GOTO_ORDERS);</span>

        // Deal with the trade route units first.
<span class="nc" id="L715">        List&lt;ModelMessage&gt; messages = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L716" title="All 2 branches missed.">        for (Unit unit : toSortedList(player.getUnits().stream()</span>
<span class="nc bnc" id="L717" title="All 4 branches missed.">                .filter(u -&gt; u.isReadyToTrade() &amp;&amp; player.owns(u)),</span>
<span class="nc" id="L718">                tradeRouteUnitComparator)) {</span>
<span class="nc" id="L719">            getGUI().setActiveUnit(unit);</span>
<span class="nc bnc" id="L720" title="All 2 branches missed.">            if (moveToDestination(unit, messages)) stillActive = unit;</span>
        }
<span class="nc bnc" id="L722" title="All 2 branches missed.">        if (!messages.isEmpty()) {</span>
<span class="nc bnc" id="L723" title="All 2 branches missed.">            for (ModelMessage m : messages) {</span>
<span class="nc" id="L724">                player.addModelMessage(m);</span>
<span class="nc" id="L725">                turnReportMessages.add(m);</span>
            }
<span class="nc" id="L727">            displayModelMessages(false, false);</span>
<span class="nc bnc" id="L728" title="All 2 branches missed.">            getGUI().setActiveUnit((stillActive != null) ? stillActive : active);</span>
<span class="nc" id="L729">            return false;</span>
        }

        // The active unit might also be a going-to unit.  Make sure it
        // gets processed first.  setNextGoingToUnit will fail harmlessly
        // if it is not a going-to unit so this is safe.
<span class="nc bnc" id="L735" title="All 2 branches missed.">        if (active != null) player.setNextGoingToUnit(active);</span>

        // Process all units.
<span class="nc" id="L738">        boolean fail = false;</span>
<span class="nc bnc" id="L739" title="All 2 branches missed.">        while (player.hasNextGoingToUnit()) {</span>
<span class="nc" id="L740">            Unit unit = player.getNextGoingToUnit();</span>
<span class="nc" id="L741">            getGUI().setActiveUnit(unit);</span>
            // Move the unit as much as possible
<span class="nc bnc" id="L743" title="All 2 branches missed.">            if (moveToDestination(unit, null)) stillActive = unit;</span>

            // Might have LCR messages to display
<span class="nc" id="L746">            displayModelMessages(false, false);</span>

            // Give the player a chance to deal with any problems
            // shown in a popup before pressing on with more moves.
<span class="nc bnc" id="L750" title="All 2 branches missed.">            if (getGUI().isShowingSubPanel()) {</span>
<span class="nc" id="L751">                getGUI().requestFocusForSubPanel();</span>
<span class="nc" id="L752">                fail = true;</span>
<span class="nc" id="L753">                break;</span>
            }
        }
<span class="nc bnc" id="L756" title="All 2 branches missed.">        getGUI().setActiveUnit((stillActive != null) ? stillActive : active);</span>
<span class="nc bnc" id="L757" title="All 4 branches missed.">        return stillActive == null &amp;&amp; !fail;</span>
    }

    /**
     * End the turn.
     *
     * @param showDialog Show the end turn dialog?
     * @return True if the turn ended.
     */
    private boolean doEndTurn(boolean showDialog) {
<span class="nc" id="L767">        final Player player = getMyPlayer();</span>
<span class="nc bnc" id="L768" title="All 2 branches missed.">        if (showDialog) {</span>
<span class="nc" id="L769">            List&lt;Unit&gt; units = transform(player.getUnits(), Unit::couldMove,</span>
<span class="nc" id="L770">                Collectors.toList());</span>
<span class="nc bnc" id="L771" title="All 2 branches missed.">            if (!units.isEmpty()) {</span>
                // Modal dialog takes over
<span class="nc" id="L773">                getGUI().showEndTurnDialog(units,</span>
<span class="nc" id="L774">                    (Boolean value) -&gt; {</span>
<span class="nc bnc" id="L775" title="All 4 branches missed.">                        if (value != null &amp;&amp; value) {</span>
<span class="nc" id="L776">                            endTurn(false);</span>
                        }
<span class="nc" id="L778">                    });</span>
<span class="nc" id="L779">                return false;</span>
            }
        }

        // Ensure end-turn mode sticks.
<span class="nc" id="L784">        moveMode = moveMode.maximize(MoveMode.END_TURN);</span>

        // Make sure all goto orders are complete before ending turn, and
        // that nothing (like a LCR exploration) has cancelled the end turn.
<span class="nc bnc" id="L788" title="All 2 branches missed.">        if (!doExecuteGotoOrders()</span>
<span class="nc bnc" id="L789" title="All 2 branches missed.">            || moveMode.ordinal() &lt; MoveMode.END_TURN.ordinal()) return false;</span>

        // Check for desync as last thing!
<span class="nc bnc" id="L792" title="All 2 branches missed.">        if (FreeColDebugger.isInDebugMode(FreeColDebugger.DebugMode.DESYNC)</span>
<span class="nc bnc" id="L793" title="All 2 branches missed.">            &amp;&amp; DebugUtils.checkDesyncAction(getFreeColClient())) {</span>
<span class="nc" id="L794">            getConnectController().reconnect();</span>
<span class="nc" id="L795">            return false;</span>
        }

        // Clean up lingering menus.
<span class="nc" id="L799">        getGUI().closeMenus();</span>

        // Clear active unit if any.
<span class="nc" id="L802">        getGUI().setActiveUnit(null);</span>

        // Unskip all skipped, some may have been faked in-client.
        // Server-side skipped units are set active in csNewTurn.
<span class="nc bnc" id="L806" title="All 2 branches missed.">        for (Unit unit : player.getUnits()) {</span>
<span class="nc bnc" id="L807" title="All 2 branches missed.">            if (unit.getState() == UnitState.SKIPPED) {</span>
<span class="nc" id="L808">                unit.setState(UnitState.ACTIVE);</span>
            }
        }

        // Restart the selection cycle.
<span class="nc" id="L813">        moveMode = MoveMode.NEXT_ACTIVE_UNIT;</span>

        // Clear outdated turn report messages.
<span class="nc" id="L816">        turnReportMessages.clear();</span>

        // Inform the server of end of turn.
<span class="nc" id="L819">        return askServer().endTurn(getGame());</span>
    }

    /**
     * Makes a new unit active if any, or focus on a tile (useful if the
     * current unit just died).
     *
     * Displays any new &lt;code&gt;ModelMessage&lt;/code&gt;s with
     * {@link #nextModelMessage}.
     *
     * @param tile The &lt;code&gt;Tile&lt;/code&gt; to select if no new unit can
     *     be made active.
     * @return True if the active unit changes.
     */
    private boolean updateActiveUnit(Tile tile) {
        // Make sure the active unit is done.
<span class="nc" id="L835">        final Player player = getMyPlayer();</span>
<span class="nc" id="L836">        Unit unit = getGUI().getActiveUnit();</span>
<span class="nc bnc" id="L837" title="All 4 branches missed.">        if (unit != null &amp;&amp; unit.couldMove()) return false;</span>

        // Flush any outstanding orders once the mode is raised.
<span class="nc bnc" id="L840" title="All 2 branches missed.">        if (moveMode != MoveMode.NEXT_ACTIVE_UNIT</span>
<span class="nc bnc" id="L841" title="All 2 branches missed.">            &amp;&amp; !doExecuteGotoOrders()) {</span>
<span class="nc" id="L842">            return false;</span>
        }

        // Successfully found a unit to display
<span class="nc bnc" id="L846" title="All 2 branches missed.">        if (player.hasNextActiveUnit()) {</span>
<span class="nc" id="L847">            getGUI().setActiveUnit(player.getNextActiveUnit());</span>
<span class="nc" id="L848">            return true;</span>
        }

        // No unit to find.
<span class="nc" id="L852">        getGUI().setActiveUnit(null);</span>

        // No active units left.  Do the goto orders.
<span class="nc bnc" id="L855" title="All 2 branches missed.">        if (!doExecuteGotoOrders()) return true;</span>

        // If not already ending the turn, use the fallback tile if
        // supplied, then check for automatic end of turn, otherwise
        // just select nothing and wait.
<span class="nc" id="L860">        final ClientOptions options = getClientOptions();</span>
<span class="nc bnc" id="L861" title="All 2 branches missed.">        if (tile != null) {</span>
<span class="nc" id="L862">            getGUI().setSelectedTile(tile);</span>
<span class="nc bnc" id="L863" title="All 2 branches missed.">        } else if (options.getBoolean(ClientOptions.AUTO_END_TURN)) {</span>
<span class="nc" id="L864">            doEndTurn(options.getBoolean(ClientOptions.SHOW_END_TURN_DIALOG));</span>
        }
<span class="nc" id="L866">        return true;</span>
    }


    // Movement support.

    /**
     * Moves the given unit towards its destination/s if possible.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to move.
     * @param messages An optional list in which to retain any
     *     trade route &lt;code&gt;ModelMessage&lt;/code&gt;s generated.
     * @return True if the unit reached its destination, is still alive,
     *     and has more moves to make.
     */
    private boolean moveToDestination(Unit unit, List&lt;ModelMessage&gt; messages) {
        Location destination;
<span class="nc bnc" id="L883" title="All 2 branches missed.">        if (!requireOurTurn()</span>
<span class="nc bnc" id="L884" title="All 2 branches missed.">            || unit.isAtSea()</span>
<span class="nc bnc" id="L885" title="All 2 branches missed.">            || unit.getMovesLeft() &lt;= 0</span>
<span class="nc bnc" id="L886" title="All 2 branches missed.">            || unit.getState() == UnitState.SKIPPED) {</span>
<span class="nc" id="L887">            return false;</span>
<span class="nc bnc" id="L888" title="All 2 branches missed.">        } else if (unit.getTradeRoute() != null) {</span>
<span class="nc" id="L889">            return followTradeRoute(unit, messages);</span>
<span class="nc bnc" id="L890" title="All 2 branches missed.">        } else if ((destination = unit.getDestination()) == null) {</span>
<span class="nc bnc" id="L891" title="All 2 branches missed.">            return unit.getMovesLeft() &gt; 0;</span>
<span class="nc bnc" id="L892" title="All 2 branches missed.">        } else if (!changeState(unit, UnitState.ACTIVE)) {</span>
<span class="nc" id="L893">            return false;</span>
        }
<span class="nc" id="L895">        getGUI().setActiveUnit(unit);</span>

        // Find a path to the destination and try to follow it.
<span class="nc" id="L898">        final Player player = getMyPlayer();</span>
<span class="nc" id="L899">        PathNode path = unit.findPath(destination);</span>
<span class="nc bnc" id="L900" title="All 2 branches missed.">        if (path == null) {</span>
<span class="nc" id="L901">            StringTemplate src = unit.getLocation()</span>
<span class="nc" id="L902">                .getLocationLabelFor(player);</span>
<span class="nc" id="L903">            StringTemplate dst = destination.getLocationLabelFor(player);</span>
<span class="nc" id="L904">            StringTemplate template = StringTemplate</span>
<span class="nc" id="L905">                .template(&quot;info.moveToDestinationFailed&quot;)</span>
<span class="nc" id="L906">                .addStringTemplate(&quot;%unit%&quot;,</span>
<span class="nc" id="L907">                    unit.getLabel(Unit.UnitLabelType.NATIONAL))</span>
<span class="nc" id="L908">                .addStringTemplate(&quot;%location%&quot;, src)</span>
<span class="nc" id="L909">                .addStringTemplate(&quot;%destination%&quot;, dst);</span>
<span class="nc" id="L910">            getGUI().showInformationMessage(unit, template);</span>
<span class="nc" id="L911">            return false;</span>
        }

        // Clear ordinary destinations if arrived.
<span class="nc bnc" id="L915" title="All 4 branches missed.">        if (movePath(unit, path) &amp;&amp; unit.isAtLocation(destination)) {</span>
<span class="nc" id="L916">            askClearGotoOrders(unit);</span>
<span class="nc bnc" id="L917" title="All 2 branches missed.">            Colony colony = (unit.hasTile()) ? unit.getTile().getColony()</span>
<span class="nc" id="L918">                : null;</span>
<span class="nc bnc" id="L919" title="All 4 branches missed.">            if (colony != null &amp;&amp; !checkCashInTreasureTrain(unit)) {</span>
<span class="nc" id="L920">                colonyPanel(colony, unit);</span>
            }
<span class="nc" id="L922">            return unit.couldMove();</span>
        }
<span class="nc" id="L924">        return false;</span>
    }

    /**
     * Move a unit in a given direction.
     *
     * Public for the test suite.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to move.
     * @param direction The &lt;code&gt;Direction&lt;/code&gt; to move in.
     * @param interactive Interactive mode: play sounds and emit errors.
     * @return True if the unit can possibly move further.
     */
    public boolean moveDirection(Unit unit, Direction direction,
                                 boolean interactive) {
        // If this move would reach the unit destination but we
        // discover that it would be permanently impossible to complete,
        // clear the destination.
<span class="nc" id="L942">        Unit.MoveType mt = unit.getMoveType(direction);</span>
<span class="nc" id="L943">        Location destination = unit.getDestination();</span>
<span class="nc" id="L944">        Tile oldTile = unit.getTile();</span>
<span class="nc bnc" id="L945" title="All 2 branches missed.">        boolean clearDestination = destination != null</span>
<span class="nc bnc" id="L946" title="All 2 branches missed.">            &amp;&amp; oldTile != null</span>
<span class="nc" id="L947">            &amp;&amp; Map.isSameLocation(oldTile.getNeighbourOrNull(direction),</span>
<span class="nc bnc" id="L948" title="All 2 branches missed.">                                  destination);</span>

        // Consider all the move types.
<span class="nc" id="L951">        boolean result = mt.isLegal();</span>
<span class="nc bnc" id="L952" title="All 25 branches missed.">        switch (mt) {</span>
        case MOVE_HIGH_SEAS:
<span class="nc bnc" id="L954" title="All 2 branches missed.">            if (getMyPlayer().getEurope() == null) {</span>
                ; // do nothing
<span class="nc bnc" id="L956" title="All 2 branches missed.">            } else if (destination == null) {</span>
<span class="nc" id="L957">                result = moveHighSeas(unit, direction);</span>
<span class="nc" id="L958">                break;</span>
<span class="nc bnc" id="L959" title="All 2 branches missed.">            } else if (destination instanceof Europe) {</span>
<span class="nc" id="L960">                result = moveTo(unit, destination);</span>
<span class="nc" id="L961">                break;</span>
            }
            // Fall through
        case MOVE:
<span class="nc" id="L965">            result = moveMove(unit, direction);</span>
<span class="nc" id="L966">            break;</span>
        case EXPLORE_LOST_CITY_RUMOUR:
<span class="nc" id="L968">            result = moveExplore(unit, direction);</span>
<span class="nc" id="L969">            break;</span>
        case ATTACK_UNIT:
<span class="nc" id="L971">            result = moveAttack(unit, direction);</span>
<span class="nc" id="L972">            break;</span>
        case ATTACK_SETTLEMENT:
<span class="nc" id="L974">            result = moveAttackSettlement(unit, direction);</span>
<span class="nc" id="L975">            break;</span>
        case EMBARK:
<span class="nc" id="L977">            result = moveEmbark(unit, direction);</span>
<span class="nc" id="L978">            break;</span>
        case ENTER_INDIAN_SETTLEMENT_WITH_FREE_COLONIST:
<span class="nc" id="L980">            result = moveLearnSkill(unit, direction);</span>
<span class="nc" id="L981">            break;</span>
        case ENTER_INDIAN_SETTLEMENT_WITH_SCOUT:
<span class="nc" id="L983">            result = moveScoutIndianSettlement(unit, direction);</span>
<span class="nc" id="L984">            break;</span>
        case ENTER_INDIAN_SETTLEMENT_WITH_MISSIONARY:
<span class="nc" id="L986">            result = moveUseMissionary(unit, direction);</span>
<span class="nc" id="L987">            break;</span>
        case ENTER_FOREIGN_COLONY_WITH_SCOUT:
<span class="nc" id="L989">            result = moveScoutColony(unit, direction);</span>
<span class="nc" id="L990">            break;</span>
        case ENTER_SETTLEMENT_WITH_CARRIER_AND_GOODS:
<span class="nc" id="L992">            result = moveTrade(unit, direction);</span>
<span class="nc" id="L993">            break;</span>

        // Illegal moves
        case MOVE_NO_ACCESS_BEACHED:
<span class="nc bnc" id="L997" title="All 4 branches missed.">            if (interactive || clearDestination) {</span>
<span class="nc" id="L998">                sound(&quot;sound.event.illegalMove&quot;);</span>
<span class="nc" id="L999">                StringTemplate nation = getNationAt(unit.getTile(), direction);</span>
<span class="nc" id="L1000">                getGUI().showInformationMessage(unit, StringTemplate</span>
<span class="nc" id="L1001">                    .template(&quot;move.noAccessBeached&quot;)</span>
<span class="nc" id="L1002">                    .addStringTemplate(&quot;%nation%&quot;, nation));</span>
            }
<span class="nc" id="L1004">            break;</span>
        case MOVE_NO_ACCESS_CONTACT:
<span class="nc bnc" id="L1006" title="All 4 branches missed.">            if (interactive || clearDestination) {</span>
<span class="nc" id="L1007">                sound(&quot;sound.event.illegalMove&quot;);</span>
<span class="nc" id="L1008">                StringTemplate nation = getNationAt(unit.getTile(), direction);</span>
<span class="nc" id="L1009">                getGUI().showInformationMessage(unit, StringTemplate</span>
<span class="nc" id="L1010">                    .template(&quot;move.noAccessContact&quot;)</span>
<span class="nc" id="L1011">                    .addStringTemplate(&quot;%nation%&quot;, nation));</span>
            }
<span class="nc" id="L1013">            break;</span>
        case MOVE_NO_ACCESS_GOODS:
<span class="nc bnc" id="L1015" title="All 4 branches missed.">            if (interactive || clearDestination) {</span>
<span class="nc" id="L1016">                sound(&quot;sound.event.illegalMove&quot;);</span>
<span class="nc" id="L1017">                StringTemplate nation = getNationAt(unit.getTile(), direction);</span>
<span class="nc" id="L1018">                getGUI().showInformationMessage(unit, StringTemplate</span>
<span class="nc" id="L1019">                    .template(&quot;move.noAccessGoods&quot;)</span>
<span class="nc" id="L1020">                    .addStringTemplate(&quot;%nation%&quot;, nation)</span>
<span class="nc" id="L1021">                    .addStringTemplate(&quot;%unit%&quot;,</span>
<span class="nc" id="L1022">                        unit.getLabel(Unit.UnitLabelType.NATIONAL)));</span>
            }
<span class="nc" id="L1024">            break;</span>
        case MOVE_NO_ACCESS_LAND:
<span class="nc bnc" id="L1026" title="All 2 branches missed.">            if (!moveDisembark(unit, direction)) {</span>
<span class="nc bnc" id="L1027" title="All 2 branches missed.">                if (interactive) {</span>
<span class="nc" id="L1028">                    sound(&quot;sound.event.illegalMove&quot;);</span>
                }
            }
<span class="nc" id="L1031">            break;</span>
        case MOVE_NO_ACCESS_MISSION_BAN:
<span class="nc bnc" id="L1033" title="All 4 branches missed.">            if (interactive || clearDestination) {</span>
<span class="nc" id="L1034">                sound(&quot;sound.event.illegalMove&quot;);</span>
<span class="nc" id="L1035">                StringTemplate nation = getNationAt(unit.getTile(), direction);</span>
<span class="nc" id="L1036">                getGUI().showInformationMessage(unit, StringTemplate</span>
<span class="nc" id="L1037">                    .template(&quot;move.noAccessMissionBan&quot;)</span>
<span class="nc" id="L1038">                    .addStringTemplate(&quot;%unit%&quot;,</span>
<span class="nc" id="L1039">                        unit.getLabel(Unit.UnitLabelType.NATIONAL))</span>
<span class="nc" id="L1040">                    .addStringTemplate(&quot;%nation%&quot;, nation));</span>
            }
<span class="nc" id="L1042">            break;</span>
        case MOVE_NO_ACCESS_SETTLEMENT:
<span class="nc bnc" id="L1044" title="All 4 branches missed.">            if (interactive || clearDestination) {</span>
<span class="nc" id="L1045">                sound(&quot;sound.event.illegalMove&quot;);</span>
<span class="nc" id="L1046">                StringTemplate nation = getNationAt(unit.getTile(), direction);</span>
<span class="nc" id="L1047">                getGUI().showInformationMessage(unit, StringTemplate</span>
<span class="nc" id="L1048">                    .template(&quot;move.noAccessSettlement&quot;)</span>
<span class="nc" id="L1049">                    .addStringTemplate(&quot;%unit%&quot;,</span>
<span class="nc" id="L1050">                        unit.getLabel(Unit.UnitLabelType.NATIONAL))</span>
<span class="nc" id="L1051">                    .addStringTemplate(&quot;%nation%&quot;, nation));</span>
            }
<span class="nc" id="L1053">            break;</span>
        case MOVE_NO_ACCESS_SKILL:
<span class="nc bnc" id="L1055" title="All 4 branches missed.">            if (interactive || clearDestination) {</span>
<span class="nc" id="L1056">                sound(&quot;sound.event.illegalMove&quot;);</span>
<span class="nc" id="L1057">                getGUI().showInformationMessage(unit, StringTemplate</span>
<span class="nc" id="L1058">                    .template(&quot;move.noAccessSkill&quot;)</span>
<span class="nc" id="L1059">                    .addStringTemplate(&quot;%unit%&quot;,</span>
<span class="nc" id="L1060">                        unit.getLabel(Unit.UnitLabelType.NATIONAL)));</span>
            }
<span class="nc" id="L1062">            break;</span>
        case MOVE_NO_ACCESS_TRADE:
<span class="nc bnc" id="L1064" title="All 4 branches missed.">            if (interactive || clearDestination) {</span>
<span class="nc" id="L1065">                sound(&quot;sound.event.illegalMove&quot;);</span>
<span class="nc" id="L1066">                StringTemplate nation = getNationAt(unit.getTile(), direction);</span>
<span class="nc" id="L1067">                getGUI().showInformationMessage(unit, StringTemplate</span>
<span class="nc" id="L1068">                    .template(&quot;move.noAccessTrade&quot;)</span>
<span class="nc" id="L1069">                    .addStringTemplate(&quot;%nation%&quot;, nation));</span>
            }
<span class="nc" id="L1071">            break;</span>
        case MOVE_NO_ACCESS_WAR:
<span class="nc bnc" id="L1073" title="All 4 branches missed.">            if (interactive || clearDestination) {</span>
<span class="nc" id="L1074">                sound(&quot;sound.event.illegalMove&quot;);</span>
<span class="nc" id="L1075">                StringTemplate nation = getNationAt(unit.getTile(), direction);</span>
<span class="nc" id="L1076">                getGUI().showInformationMessage(unit, StringTemplate</span>
<span class="nc" id="L1077">                    .template(&quot;move.noAccessWar&quot;)</span>
<span class="nc" id="L1078">                    .addStringTemplate(&quot;%nation%&quot;, nation));</span>
            }
<span class="nc" id="L1080">            break;</span>
        case MOVE_NO_ACCESS_WATER:
<span class="nc bnc" id="L1082" title="All 4 branches missed.">            if (interactive || clearDestination) {</span>
<span class="nc" id="L1083">                sound(&quot;sound.event.illegalMove&quot;);</span>
<span class="nc" id="L1084">                getGUI().showInformationMessage(unit, StringTemplate</span>
<span class="nc" id="L1085">                    .template(&quot;move.noAccessWater&quot;)</span>
<span class="nc" id="L1086">                    .addStringTemplate(&quot;%unit%&quot;,</span>
<span class="nc" id="L1087">                        unit.getLabel(Unit.UnitLabelType.NATIONAL)));</span>
            }
<span class="nc" id="L1089">            break;</span>
        case MOVE_NO_ATTACK_MARINE:
<span class="nc bnc" id="L1091" title="All 4 branches missed.">            if (interactive || clearDestination) {</span>
<span class="nc" id="L1092">                sound(&quot;sound.event.illegalMove&quot;);</span>
<span class="nc" id="L1093">                getGUI().showInformationMessage(unit, StringTemplate</span>
<span class="nc" id="L1094">                    .template(&quot;move.noAttackWater&quot;)</span>
<span class="nc" id="L1095">                    .addStringTemplate(&quot;%unit%&quot;,</span>
<span class="nc" id="L1096">                        unit.getLabel(Unit.UnitLabelType.NATIONAL)));</span>
            }
<span class="nc" id="L1098">            break;</span>
        case MOVE_NO_MOVES:
            // The unit may have some moves left, but not enough
            // to move to the next node.  The move is illegal
            // this turn, but might not be next turn, so do not cancel the
            // destination but set the state to skipped instead.
<span class="nc" id="L1104">            clearDestination = false;</span>
<span class="nc" id="L1105">            unit.setState(UnitState.SKIPPED);</span>
<span class="nc" id="L1106">            break;</span>
        case MOVE_NO_TILE:
<span class="nc bnc" id="L1108" title="All 4 branches missed.">            if (interactive || clearDestination) {</span>
<span class="nc" id="L1109">                sound(&quot;sound.event.illegalMove&quot;);</span>
<span class="nc" id="L1110">                getGUI().showInformationMessage(unit, StringTemplate</span>
<span class="nc" id="L1111">                    .template(&quot;move.noTile&quot;)</span>
<span class="nc" id="L1112">                    .addStringTemplate(&quot;%unit%&quot;,</span>
<span class="nc" id="L1113">                        unit.getLabel(Unit.UnitLabelType.NATIONAL)));</span>
            }
<span class="nc" id="L1115">            break;</span>
        default:
<span class="nc bnc" id="L1117" title="All 4 branches missed.">            if (interactive || clearDestination) {</span>
<span class="nc" id="L1118">                sound(&quot;sound.event.illegalMove&quot;);</span>
            }
<span class="nc" id="L1120">            result = false;</span>
            break;
        }
<span class="nc bnc" id="L1123" title="All 4 branches missed.">        if (clearDestination &amp;&amp; !unit.isDisposed()) {</span>
<span class="nc" id="L1124">            askClearGotoOrders(unit);</span>
        }
<span class="nc" id="L1126">        return result;</span>
    }

    /**
     * Follow a path.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to move.
     * @param path The path to follow.
     * @return True if the unit has completed the path and can move further.
     */
    private boolean movePath(Unit unit, PathNode path) {
<span class="nc bnc" id="L1137" title="All 2 branches missed.">        for (; path != null; path = path.next) {</span>
<span class="nc bnc" id="L1138" title="All 2 branches missed.">            if (unit.isAtLocation(path.getLocation())) continue;</span>

<span class="nc bnc" id="L1140" title="All 2 branches missed.">            if (path.getLocation() instanceof Europe) {</span>
<span class="nc bnc" id="L1141" title="All 2 branches missed.">                if (unit.hasTile()</span>
<span class="nc bnc" id="L1142" title="All 2 branches missed.">                    &amp;&amp; unit.getTile().isDirectlyHighSeasConnected()) {</span>
<span class="nc" id="L1143">                    moveTo(unit, path.getLocation());</span>
<span class="nc" id="L1144">                } else {</span>
<span class="nc" id="L1145">                    logger.warning(&quot;Can not move to Europe from &quot;</span>
<span class="nc" id="L1146">                        + unit.getLocation()</span>
<span class="nc" id="L1147">                        + &quot; on path: &quot; + path.fullPathToString());</span>
                }
<span class="nc" id="L1149">                return false;</span>
<span class="nc bnc" id="L1150" title="All 2 branches missed.">            } else if (path.getLocation() instanceof Tile) {</span>
<span class="nc bnc" id="L1151" title="All 2 branches missed.">                if (path.getDirection() == null) {</span>
<span class="nc bnc" id="L1152" title="All 2 branches missed.">                    if (unit.isInEurope()) {</span>
<span class="nc" id="L1153">                        moveTo(unit, unit.getGame().getMap());</span>
<span class="nc" id="L1154">                    } else {</span>
<span class="nc" id="L1155">                        logger.warning(&quot;Null direction on path: &quot;</span>
<span class="nc" id="L1156">                            + path.fullPathToString());</span>
                    }
<span class="nc" id="L1158">                    return false;</span>
                } else {
<span class="nc bnc" id="L1160" title="All 2 branches missed.">                    if (!moveDirection(unit, path.getDirection(), false)) {</span>
<span class="nc" id="L1161">                        return false;</span>
                    }
<span class="nc bnc" id="L1163" title="All 2 branches missed.">                    if (unit.hasTile()</span>
<span class="nc bnc" id="L1164" title="All 2 branches missed.">                        &amp;&amp; unit.getTile().getDiscoverableRegion() != null) {</span>
                        // Break up the goto to allow region naming to occur,
                        // BR#2707
<span class="nc" id="L1167">                        return false;</span>
                    }
                }
<span class="nc bnc" id="L1170" title="All 2 branches missed.">            } else if (path.getLocation() instanceof Unit) {</span>
<span class="nc" id="L1171">                return moveEmbark(unit, path.getDirection());</span>

            } else {
<span class="nc" id="L1174">                logger.warning(&quot;Bad path: &quot; + path.fullPathToString());</span>
            }
        }
<span class="nc" id="L1177">        return true;</span>
    }

    /**
     * Confirm attack or demand a tribute from a native settlement, following
     * an attacking move.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to perform the attack.
     * @param direction The direction in which to attack.
     * @return True if the unit could move further.
     */
    private boolean moveAttack(Unit unit, Direction direction) {
<span class="nc" id="L1189">        Tile tile = unit.getTile();</span>
<span class="nc" id="L1190">        Tile target = tile.getNeighbourOrNull(direction);</span>
<span class="nc" id="L1191">        Unit u = target.getFirstUnit();</span>
<span class="nc bnc" id="L1192" title="All 4 branches missed.">        if (u == null || unit.getOwner().owns(u)) return false;</span>

<span class="nc" id="L1194">        askClearGotoOrders(unit);</span>
<span class="nc bnc" id="L1195" title="All 2 branches missed.">        if (getGUI().confirmHostileAction(unit, target)</span>
<span class="nc bnc" id="L1196" title="All 2 branches missed.">            &amp;&amp; getGUI().confirmPreCombat(unit, target)) {</span>
<span class="nc" id="L1197">            askServer().attack(unit, direction);</span>
        }
        // Always return false, as the unit has either attacked and lost
        // its remaining moves, or the move can not proceed because it is
        // blocked.
<span class="nc" id="L1202">        return false;</span>
    }

    /**
     * Confirm attack or demand a tribute from a settlement, following
     * an attacking move.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to perform the attack.
     * @param direction The direction in which to attack.
     * @return True if the unit could move further.
     */
    private boolean moveAttackSettlement(Unit unit, Direction direction) {
<span class="nc" id="L1214">        Tile tile = unit.getTile();</span>
<span class="nc" id="L1215">        Tile target = tile.getNeighbourOrNull(direction);</span>
<span class="nc" id="L1216">        Settlement settlement = target.getSettlement();</span>
<span class="nc bnc" id="L1217" title="All 2 branches missed.">        if (settlement == null</span>
<span class="nc bnc" id="L1218" title="All 2 branches missed.">            || unit.getOwner().owns(settlement)) return false;</span>

<span class="nc" id="L1220">        ArmedUnitSettlementAction act</span>
<span class="nc" id="L1221">            = getGUI().getArmedUnitSettlementChoice(settlement);</span>
<span class="nc bnc" id="L1222" title="All 2 branches missed.">        if (act == null) return true; // Cancelled</span>
<span class="nc bnc" id="L1223" title="All 3 branches missed.">        switch (act) {</span>
        case SETTLEMENT_ATTACK:
<span class="nc bnc" id="L1225" title="All 2 branches missed.">            if (getGUI().confirmHostileAction(unit, target)</span>
<span class="nc bnc" id="L1226" title="All 2 branches missed.">                &amp;&amp; getGUI().confirmPreCombat(unit, target)) {</span>
<span class="nc" id="L1227">                askServer().attack(unit, direction);</span>
<span class="nc" id="L1228">                Colony col = target.getColony();</span>
<span class="nc bnc" id="L1229" title="All 4 branches missed.">                if (col != null &amp;&amp; unit.getOwner().owns(col)) {</span>
<span class="nc" id="L1230">                    colonyPanel(col, unit);</span>
                }
<span class="nc" id="L1232">                return false;</span>
            }
            break;
        case SETTLEMENT_TRIBUTE:
<span class="nc bnc" id="L1236" title="All 2 branches missed.">            int amount = (settlement instanceof Colony)</span>
<span class="nc" id="L1237">                ? getGUI().confirmEuropeanTribute(unit, (Colony)settlement,</span>
<span class="nc" id="L1238">                    getNationSummary(settlement.getOwner()))</span>
<span class="nc bnc" id="L1239" title="All 2 branches missed.">                : (settlement instanceof IndianSettlement)</span>
<span class="nc" id="L1240">                ? getGUI().confirmNativeTribute(unit, (IndianSettlement)settlement)</span>
<span class="nc" id="L1241">                : -1;</span>
<span class="nc bnc" id="L1242" title="All 2 branches missed.">            if (amount &lt;= 0) return true; // Cancelled</span>
<span class="nc" id="L1243">            return moveTribute(unit, amount, direction);</span>

        default:
<span class="nc" id="L1246">            logger.warning(&quot;showArmedUnitSettlementDialog fail: &quot; + act);</span>
            break;
        }
<span class="nc" id="L1249">        return true;</span>
    }

    /**
     * Initiates diplomacy with a foreign power.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; negotiating.
     * @param direction The direction of a settlement to negotiate with.
     * @param dt The base &lt;code&gt;DiplomaticTrade&lt;/code&gt; agreement to
     *     begin the negotiation with.
     * @return True if the unit can move further.
     */
    private boolean moveDiplomacy(Unit unit, Direction direction,
                                  DiplomaticTrade dt) {
<span class="nc" id="L1263">        Settlement settlement = getSettlementAt(unit.getTile(), direction);</span>
<span class="nc bnc" id="L1264" title="All 2 branches missed.">        if (settlement == null</span>
<span class="nc bnc" id="L1265" title="All 2 branches missed.">            || !(settlement instanceof Colony)) return false;</span>
<span class="nc" id="L1266">        Colony colony = (Colony)settlement;</span>

        // Can not negotiate with the REF.
<span class="nc" id="L1269">        final Game game = getGame();</span>
<span class="nc" id="L1270">        final Player player = unit.getOwner();</span>
<span class="nc" id="L1271">        final Player other = colony.getOwner();</span>
<span class="nc bnc" id="L1272" title="All 2 branches missed.">        if (other == player.getREFPlayer()) return false;</span>

<span class="nc" id="L1274">        StringTemplate nation = other.getNationLabel();</span>
<span class="nc bnc" id="L1275" title="All 2 branches missed.">        while (dt != null) {</span>
            // Inform server of current agreement.
<span class="nc" id="L1277">            dt = askServer().diplomacy(unit, colony, dt);</span>
            // Returned dt will be null if we sent or the other player
            // replied with an accept/reject.  Otherwise consider
            // counter proposal.
<span class="nc bnc" id="L1281" title="All 2 branches missed.">            if (dt != null) {</span>
<span class="nc" id="L1282">                dt = getGUI().showNegotiationDialog(unit, colony, dt,</span>
<span class="nc" id="L1283">                    dt.getSendMessage(player, colony));</span>
            }
        }
<span class="nc" id="L1286">        return false;</span>
    }

    /**
     * Check the carrier for passengers to disembark, possibly
     * snatching a useful result from the jaws of a
     * MOVE_NO_ACCESS_LAND failure.
     *
     * @param unit The carrier containing the unit to disembark.
     * @param direction The direction in which to disembark the unit.
     * @return True if the disembark &quot;succeeds&quot; (which deliberately includes
     *     declined disembarks).
     */
    private boolean moveDisembark(Unit unit, final Direction direction) {
<span class="nc" id="L1300">        Tile tile = unit.getTile().getNeighbourOrNull(direction);</span>
<span class="nc bnc" id="L1301" title="All 2 branches missed.">        if (tile.getFirstUnit() != null</span>
<span class="nc bnc" id="L1302" title="All 2 branches missed.">            &amp;&amp; tile.getFirstUnit().getOwner() != unit.getOwner()) {</span>
<span class="nc" id="L1303">            return false; // Can not disembark onto other nation units.</span>
        }

        // Disembark selected units able to move.
<span class="nc" id="L1307">        unit.setStateToAllChildren(UnitState.ACTIVE);</span>
<span class="nc" id="L1308">        final List&lt;Unit&gt; disembarkable = transform(unit.getUnitList(),</span>
<span class="nc" id="L1309">            u -&gt; u.getMoveType(tile).isProgress(), Collectors.toList());</span>
<span class="nc bnc" id="L1310" title="All 2 branches missed.">        if (disembarkable.isEmpty()) return false; // Fail, did not find one</span>
<span class="nc bnc" id="L1311" title="All 2 branches missed.">        if (disembarkable.size() == 1) {</span>
<span class="nc" id="L1312">            if (getGUI().confirm(tile,</span>
<span class="nc" id="L1313">                            StringTemplate.key(&quot;disembark.text&quot;),</span>
<span class="nc bnc" id="L1314" title="All 2 branches missed.">                            disembarkable.get(0), &quot;ok&quot;, &quot;cancel&quot;)) {</span>
<span class="nc" id="L1315">                moveDirection(disembarkable.get(0), direction, false);</span>
            }
<span class="nc" id="L1317">        } else {</span>
<span class="nc" id="L1318">            List&lt;ChoiceItem&lt;Unit&gt;&gt; choices = toList(map(disembarkable, u -&gt;</span>
<span class="nc" id="L1319">                    new ChoiceItem&lt;Unit&gt;(u.getDescription(Unit.UnitLabelType.NATIONAL), u)));</span>
<span class="nc" id="L1320">            choices.add(new ChoiceItem&lt;&gt;(Messages.message(&quot;all&quot;), unit));</span>

            // Use moveDirection() to disembark units as while the
            // destination tile is known to be clear of other player
            // units or settlements, it may have a rumour or need
            // other special handling.
<span class="nc" id="L1326">            Unit u = getGUI().getChoice(unit.getTile(),</span>
<span class="nc" id="L1327">                                   Messages.message(&quot;disembark.text&quot;),</span>
<span class="nc" id="L1328">                                   unit,</span>
<span class="nc" id="L1329">                                   &quot;none&quot;, choices);</span>
<span class="nc bnc" id="L1330" title="All 2 branches missed.">            if (u == null) {</span>
                // Cancelled, done.
<span class="nc bnc" id="L1332" title="All 2 branches missed.">            } else if (u == unit) {</span>
                // Disembark all.
<span class="nc bnc" id="L1334" title="All 2 branches missed.">                for (Unit dUnit : disembarkable) {</span>
                    // Guard against loss of control when asking the
                    // server to move the unit.
                    try {
<span class="nc" id="L1338">                        moveDirection(dUnit, direction, false);</span>
<span class="nc" id="L1339">                    } finally {</span>
                        continue;
                    }
                }
<span class="nc" id="L1343">            } else {</span>
<span class="nc" id="L1344">                moveDirection(u, direction, false);</span>
            }
        }
<span class="nc" id="L1347">        return true;</span>
    }

    /**
     * Embarks the specified unit onto a carrier in a specified direction
     * following a move of MoveType.EMBARK.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that wishes to embark.
     * @param direction The direction in which to embark.
     * @return True if the unit could move further.
     */
    private boolean moveEmbark(Unit unit, Direction direction) {
<span class="nc bnc" id="L1359" title="All 2 branches missed.">        if (unit.getColony() != null</span>
<span class="nc bnc" id="L1360" title="All 2 branches missed.">            &amp;&amp; !getGUI().confirmLeaveColony(unit)) return false;</span>

<span class="nc" id="L1362">        Tile sourceTile = unit.getTile();</span>
<span class="nc" id="L1363">        Tile destinationTile = sourceTile.getNeighbourOrNull(direction);</span>
<span class="nc" id="L1364">        Unit carrier = null;</span>
<span class="nc" id="L1365">        List&lt;ChoiceItem&lt;Unit&gt;&gt; choices = transform(destinationTile.getUnitList(),</span>
<span class="nc" id="L1366">            u -&gt; u.canAdd(unit),</span>
<span class="nc" id="L1367">            u -&gt; new ChoiceItem&lt;&gt;(u.getDescription(Unit.UnitLabelType.NATIONAL), u),</span>
<span class="nc" id="L1368">            Collectors.toList());</span>
<span class="nc bnc" id="L1369" title="All 2 branches missed.">        if (choices.isEmpty()) {</span>
<span class="nc" id="L1370">            throw new RuntimeException(&quot;Unit &quot; + unit.getId()</span>
<span class="nc" id="L1371">                + &quot; found no carrier to embark upon.&quot;);</span>
<span class="nc bnc" id="L1372" title="All 2 branches missed.">        } else if (choices.size() == 1) {</span>
<span class="nc" id="L1373">            carrier = choices.get(0).getObject();</span>
<span class="nc" id="L1374">        } else {</span>
<span class="nc" id="L1375">            carrier = getGUI().getChoice(unit.getTile(),</span>
<span class="nc" id="L1376">                                    Messages.message(&quot;embark.text&quot;),</span>
<span class="nc" id="L1377">                                    unit,</span>
<span class="nc" id="L1378">                                    &quot;none&quot;, choices);</span>
<span class="nc bnc" id="L1379" title="All 2 branches missed.">            if (carrier == null) return true; // User cancelled</span>
        }

        // Proceed to embark
<span class="nc" id="L1383">        askClearGotoOrders(unit);</span>
<span class="nc bnc" id="L1384" title="All 2 branches missed.">        if (!askServer().embark(unit, carrier, direction)</span>
<span class="nc bnc" id="L1385" title="All 2 branches missed.">            || unit.getLocation() != carrier) {</span>
<span class="nc" id="L1386">            unit.setState(UnitState.SKIPPED);</span>
<span class="nc" id="L1387">            return false;</span>
        }
<span class="nc" id="L1389">        unit.getOwner().invalidateCanSeeTiles();</span>
<span class="nc" id="L1390">        return false;</span>
    }

    /**
     * Confirm exploration of a lost city rumour, following a move of
     * MoveType.EXPLORE_LOST_CITY_RUMOUR.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is exploring.
     * @param direction The direction of a rumour.
     * @return True if the unit can move further.
     */
    private boolean moveExplore(Unit unit, Direction direction) {
<span class="nc" id="L1402">        Tile tile = unit.getTile().getNeighbourOrNull(direction);</span>
<span class="nc" id="L1403">        if (!getGUI().confirm(unit.getTile(),</span>
<span class="nc" id="L1404">                StringTemplate.key(&quot;exploreLostCityRumour.text&quot;), unit,</span>
<span class="nc bnc" id="L1405" title="All 2 branches missed.">                &quot;exploreLostCityRumour.yes&quot;, &quot;exploreLostCityRumour.no&quot;)) {</span>
<span class="nc bnc" id="L1406" title="All 2 branches missed.">            if (unit.getDestination() != null) {</span>
<span class="nc" id="L1407">                askClearGotoOrders(unit);</span>
<span class="nc" id="L1408">                return false; // Need to break out of movePath</span>
            }
<span class="nc" id="L1410">            return true;</span>
        }
<span class="nc bnc" id="L1412" title="All 2 branches missed.">        if (tile.getLostCityRumour().getType()== LostCityRumour.RumourType.MOUNDS</span>
<span class="nc" id="L1413">            &amp;&amp; !getGUI().confirm(unit.getTile(),</span>
<span class="nc" id="L1414">                StringTemplate.key(&quot;exploreMoundsRumour.text&quot;), unit,</span>
<span class="nc bnc" id="L1415" title="All 2 branches missed.">                &quot;exploreLostCityRumour.yes&quot;, &quot;exploreLostCityRumour.no&quot;)) {</span>
<span class="nc" id="L1416">            askServer().declineMounds(unit, direction); // LCR goes away</span>
        }
        // Prevent turn ending at once to allow FoY prompts to complete
<span class="nc" id="L1419">        moveMode = moveMode.minimize(MoveMode.EXECUTE_GOTO_ORDERS);</span>
<span class="nc" id="L1420">        return moveMove(unit, direction);</span>
    }

    /**
     * Moves a unit onto the &quot;high seas&quot; in a specified direction following
     * a move of MoveType.MOVE_HIGH_SEAS.
     * This may result in a move to Europe, no move, or an ordinary move.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to be moved.
     * @param direction The direction in which to move.
     * @return True if the unit can move further.
     */
    private boolean moveHighSeas(Unit unit, Direction direction) {
        // Confirm moving to Europe if told to move to a null tile
        // (FIXME: can this still happen?), or if crossing the boundary
        // between coastal and high sea.  Otherwise just move.
<span class="nc" id="L1436">        Tile oldTile = unit.getTile();</span>
<span class="nc" id="L1437">        Tile newTile = oldTile.getNeighbourOrNull(direction);</span>
<span class="nc bnc" id="L1438" title="All 2 branches missed.">        if (newTile == null</span>
<span class="nc bnc" id="L1439" title="All 2 branches missed.">            || (!oldTile.isDirectlyHighSeasConnected()</span>
<span class="nc bnc" id="L1440" title="All 2 branches missed.">                &amp;&amp; newTile.isDirectlyHighSeasConnected())) {</span>
<span class="nc bnc" id="L1441" title="All 2 branches missed.">            if (unit.getTradeRoute() != null) {</span>
<span class="nc" id="L1442">                TradeRouteStop stop = unit.getStop();</span>
<span class="nc bnc" id="L1443" title="All 4 branches missed.">                if (stop != null &amp;&amp; TradeRoute.isStopValid(unit, stop)</span>
<span class="nc bnc" id="L1444" title="All 2 branches missed.">                    &amp;&amp; stop.getLocation() instanceof Europe) {</span>
<span class="nc" id="L1445">                    moveTo(unit, stop.getLocation());</span>
<span class="nc" id="L1446">                    return false;</span>
                }
<span class="nc bnc" id="L1448" title="All 2 branches missed.">            } else if (unit.getDestination() instanceof Europe) {</span>
<span class="nc" id="L1449">                moveTo(unit, unit.getDestination());</span>
<span class="nc" id="L1450">                return false;</span>
            } else {
<span class="nc" id="L1452">                if (getGUI().confirm(oldTile, StringTemplate</span>
<span class="nc" id="L1453">                        .template(&quot;highseas.text&quot;)</span>
<span class="nc" id="L1454">                        .addAmount(&quot;%number%&quot;, unit.getSailTurns()),</span>
<span class="nc bnc" id="L1455" title="All 2 branches missed.">                        unit, &quot;highseas.yes&quot;, &quot;highseas.no&quot;)) {</span>
<span class="nc" id="L1456">                    moveTo(unit, unit.getOwner().getEurope());</span>
<span class="nc" id="L1457">                    return false;</span>
                }
            }
        }
<span class="nc" id="L1461">        return moveMove(unit, direction);</span>
    }

    /**
     * Move a free colonist to a native settlement to learn a skill following
     * a move of MoveType.ENTER_INDIAN_SETTLEMENT_WITH_FREE_COLONIST.
     * The colonist does not physically get into the village, it will
     * just stay where it is and gain the skill.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to learn the skill.
     * @param direction The direction in which the Indian settlement lies.
     * @return True if the unit can move further.
     */
    private boolean moveLearnSkill(Unit unit, Direction direction) {
<span class="nc" id="L1475">        askClearGotoOrders(unit);</span>
        // Refresh knowledge of settlement skill.  It may have been
        // learned by another player.
<span class="nc bnc" id="L1478" title="All 2 branches missed.">        if (!askServer().askSkill(unit, direction)) return false;</span>

<span class="nc" id="L1480">        IndianSettlement settlement</span>
<span class="nc" id="L1481">            = (IndianSettlement)getSettlementAt(unit.getTile(), direction);</span>
<span class="nc" id="L1482">        UnitType skill = settlement.getLearnableSkill();</span>
<span class="nc bnc" id="L1483" title="All 2 branches missed.">        if (skill == null) {</span>
<span class="nc" id="L1484">            getGUI().showInformationMessage(settlement, &quot;info.noMoreSkill&quot;);</span>
<span class="nc bnc" id="L1485" title="All 2 branches missed.">        } else if (!unit.getType().canBeUpgraded(skill, ChangeType.NATIVES)) {</span>
<span class="nc" id="L1486">            getGUI().showInformationMessage(settlement, StringTemplate</span>
<span class="nc" id="L1487">                .template(&quot;info.cantLearnSkill&quot;)</span>
<span class="nc" id="L1488">                .addStringTemplate(&quot;%unit%&quot;,</span>
<span class="nc" id="L1489">                    unit.getLabel(Unit.UnitLabelType.NATIONAL))</span>
<span class="nc" id="L1490">                .addNamed(&quot;%skill%&quot;, skill));</span>
<span class="nc" id="L1491">        } else if (getGUI().confirm(unit.getTile(), StringTemplate</span>
<span class="nc" id="L1492">                .template(&quot;learnSkill.text&quot;)</span>
<span class="nc" id="L1493">                .addNamed(&quot;%skill%&quot;, skill),</span>
<span class="nc bnc" id="L1494" title="All 2 branches missed.">                unit, &quot;learnSkill.yes&quot;, &quot;learnSkill.no&quot;)) {</span>
<span class="nc bnc" id="L1495" title="All 2 branches missed.">            if (askServer().learnSkill(unit, direction)) {</span>
<span class="nc bnc" id="L1496" title="All 2 branches missed.">                if (unit.isDisposed()) {</span>
<span class="nc" id="L1497">                    getGUI().showInformationMessage(settlement, &quot;learnSkill.die&quot;);</span>
<span class="nc" id="L1498">                    return false;</span>
                }
<span class="nc bnc" id="L1500" title="All 2 branches missed.">                if (unit.getType() != skill) {</span>
<span class="nc" id="L1501">                    getGUI().showInformationMessage(settlement, &quot;learnSkill.leave&quot;);</span>
                }
            }
        }
<span class="nc" id="L1505">        return false;</span>
    }

    /**
     * Actually move a unit in a specified direction, following a move
     * of MoveType.MOVE.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to be moved.
     * @param direction The direction in which to move the Unit.
     * @return True if the unit can move further.
     */
    private boolean moveMove(Unit unit, Direction direction) {
<span class="nc" id="L1517">        final ClientOptions options = getClientOptions();</span>
<span class="nc bnc" id="L1518" title="All 4 branches missed.">        if (unit.canCarryUnits() &amp;&amp; unit.hasSpaceLeft()</span>
<span class="nc bnc" id="L1519" title="All 2 branches missed.">            &amp;&amp; options.getBoolean(ClientOptions.AUTOLOAD_SENTRIES)) {</span>
            // Autoload sentries if selected
<span class="nc bnc" id="L1521" title="All 2 branches missed.">            List&lt;Unit&gt; waiting = (unit.getColony() != null)</span>
<span class="nc" id="L1522">                ? unit.getTile().getUnitList()</span>
<span class="nc" id="L1523">                : Collections.&lt;Unit&gt;emptyList();</span>
<span class="nc bnc" id="L1524" title="All 2 branches missed.">            for (Unit u : waiting) {</span>
<span class="nc bnc" id="L1525" title="All 2 branches missed.">                if (u.getState() != UnitState.SENTRY</span>
<span class="nc bnc" id="L1526" title="All 2 branches missed.">                    || !unit.couldCarry(u)) continue;</span>
                try {
<span class="nc" id="L1528">                    askEmbark(u, unit);</span>
<span class="nc" id="L1529">                } finally {</span>
<span class="nc bnc" id="L1530" title="All 2 branches missed.">                    if (u.getLocation() != unit) {</span>
<span class="nc" id="L1531">                        u.setState(UnitState.SKIPPED);</span>
                    }
                    continue;
                }
            }
            // Boarding consumed this unit's moves.
<span class="nc bnc" id="L1537" title="All 2 branches missed.">            if (unit.getMovesLeft() &lt;= 0) return false;</span>
        }

        // Ask the server
<span class="nc bnc" id="L1541" title="All 2 branches missed.">        if (!askServer().move(unit, direction)) {</span>
            // Can fail due to desynchronization.  Skip this unit so
            // we do not end up retrying indefinitely.
<span class="nc" id="L1544">            unit.setState(UnitState.SKIPPED);</span>
<span class="nc" id="L1545">            return false;</span>
        }

<span class="nc" id="L1548">        unit.getOwner().invalidateCanSeeTiles();</span>
        
<span class="nc" id="L1550">        final Tile tile = unit.getTile();</span>

        // Perform a short pause on an active unit's last move if
        // the option is enabled.
<span class="nc bnc" id="L1554" title="All 2 branches missed.">        if (unit.getMovesLeft() &lt;= 0</span>
<span class="nc bnc" id="L1555" title="All 2 branches missed.">            &amp;&amp; options.getBoolean(ClientOptions.UNIT_LAST_MOVE_DELAY)) {</span>
<span class="nc" id="L1556">            getGUI().paintImmediatelyCanvasInItsBounds();</span>
            try {
<span class="nc" id="L1558">                Thread.sleep(UNIT_LAST_MOVE_DELAY);</span>
<span class="nc" id="L1559">            } catch (InterruptedException e) {} // Ignore</span>
        }

        // Update the active unit and GUI.
<span class="nc bnc" id="L1563" title="All 4 branches missed.">        boolean ret = !unit.isDisposed() &amp;&amp; !checkCashInTreasureTrain(unit);</span>
<span class="nc bnc" id="L1564" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc bnc" id="L1565" title="All 4 branches missed.">            if (tile.getColony() != null &amp;&amp; unit.isCarrier()) {</span>
<span class="nc" id="L1566">                final Colony colony = tile.getColony();</span>
<span class="nc bnc" id="L1567" title="All 2 branches missed.">                if (unit.getTradeRoute() == null</span>
<span class="nc bnc" id="L1568" title="All 2 branches missed.">                    &amp;&amp; Map.isSameLocation(tile, unit.getDestination())) {</span>
<span class="nc" id="L1569">                    colonyPanel(colony, unit);</span>
                }
            }
<span class="nc bnc" id="L1572" title="All 2 branches missed.">            ret = unit.getMovesLeft() &gt; 0;</span>
        }
<span class="nc" id="L1574">        return ret;</span>
    }

    /**
     * Move to a foreign colony and either attack, negotiate with the
     * foreign power or spy on them.  Follows a move of
     * MoveType.ENTER_FOREIGN_COLONY_WITH_SCOUT.
     *
     * FIXME: Unify trade and negotiation.
     *
     * @param unit The unit that will spy, negotiate or attack.
     * @param direction The direction in which the foreign colony lies.
     * @return True if the unit can move further.
     */
    private boolean moveScoutColony(Unit unit, Direction direction) {
<span class="nc" id="L1589">        final Game game = getGame();</span>
<span class="nc" id="L1590">        Colony colony = (Colony) getSettlementAt(unit.getTile(), direction);</span>
<span class="nc bnc" id="L1591" title="All 2 branches missed.">        boolean canNeg = colony.getOwner() != unit.getOwner().getREFPlayer();</span>
<span class="nc" id="L1592">        askClearGotoOrders(unit);</span>

<span class="nc" id="L1594">        ScoutColonyAction act</span>
<span class="nc" id="L1595">            = getGUI().getScoutForeignColonyChoice(colony, unit, canNeg);</span>
<span class="nc bnc" id="L1596" title="All 2 branches missed.">        if (act == null) return true; // Cancelled</span>
<span class="nc bnc" id="L1597" title="All 4 branches missed.">        switch (act) {</span>
        case SCOUT_COLONY_ATTACK:
<span class="nc" id="L1599">            return moveAttackSettlement(unit, direction);</span>
        case SCOUT_COLONY_NEGOTIATE:
<span class="nc" id="L1601">            Player player = unit.getOwner();</span>
<span class="nc" id="L1602">            DiplomaticTrade agreement</span>
<span class="nc" id="L1603">                = new DiplomaticTrade(game, TradeContext.DIPLOMATIC,</span>
<span class="nc" id="L1604">                                      player, colony.getOwner(), null, 0);</span>
<span class="nc" id="L1605">            agreement = getGUI().showNegotiationDialog(unit, colony,</span>
<span class="nc" id="L1606">                agreement, agreement.getSendMessage(player, colony));</span>
<span class="nc bnc" id="L1607" title="All 2 branches missed.">            return (agreement == null</span>
<span class="nc bnc" id="L1608" title="All 2 branches missed.">                || agreement.getStatus() == TradeStatus.REJECT_TRADE) ? true</span>
<span class="nc" id="L1609">                : moveDiplomacy(unit, direction, agreement);</span>
        case SCOUT_COLONY_SPY:
<span class="nc" id="L1611">            return moveSpy(unit, direction);</span>
        default:
<span class="nc" id="L1613">            logger.warning(&quot;showScoutForeignColonyDialog fail: &quot; + act);</span>
            break;
        }
<span class="nc" id="L1616">        return true;</span>
    }

    /**
     * Move a scout into an Indian settlement to speak with the chief,
     * or demand a tribute following a move of
     * MoveType.ENTER_INDIAN_SETTLEMENT_WITH_SCOUT.
     * The scout does not physically get into the village, it will
     * just stay where it is.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is scouting.
     * @param direction The direction in which the Indian settlement lies.
     * @return True if the unit can move further.
     */
    private boolean moveScoutIndianSettlement(Unit unit, Direction direction) {
<span class="nc" id="L1631">        Tile unitTile = unit.getTile();</span>
<span class="nc" id="L1632">        Tile tile = unitTile.getNeighbourOrNull(direction);</span>
<span class="nc" id="L1633">        IndianSettlement settlement = tile.getIndianSettlement();</span>
<span class="nc" id="L1634">        Player player = unit.getOwner();</span>
<span class="nc" id="L1635">        askClearGotoOrders(unit);</span>

        // Offer the choices.
<span class="nc bnc" id="L1638" title="All 2 branches missed.">        if (!askServer().scoutSettlement(unit, direction)) return false;</span>
<span class="nc" id="L1639">        int count = player.getNationSummary(settlement.getOwner())</span>
<span class="nc" id="L1640">            .getNumberOfSettlements();</span>
<span class="nc bnc" id="L1641" title="All 2 branches missed.">        String number = (count &lt;= 0) ? Messages.message(&quot;many&quot;)</span>
<span class="nc" id="L1642">            : Integer.toString(count);</span>
<span class="nc" id="L1643">        ScoutIndianSettlementAction act</span>
<span class="nc" id="L1644">            = getGUI().getScoutIndianSettlementChoice(settlement, number);</span>
<span class="nc bnc" id="L1645" title="All 2 branches missed.">        if (act == null) return true; // Cancelled</span>
<span class="nc bnc" id="L1646" title="All 4 branches missed.">        switch (act) {</span>
        case SCOUT_SETTLEMENT_ATTACK:
<span class="nc bnc" id="L1648" title="All 2 branches missed.">            if (!getGUI().confirmPreCombat(unit, tile)) return true;</span>
<span class="nc" id="L1649">            askServer().attack(unit, direction);</span>
<span class="nc" id="L1650">            return false;</span>
        case SCOUT_SETTLEMENT_SPEAK:
            // Prevent turn ending to allow speaking results to complete
<span class="nc" id="L1653">            moveMode = moveMode.minimize(MoveMode.EXECUTE_GOTO_ORDERS);</span>
<span class="nc" id="L1654">            askServer().scoutSpeakToChief(unit, settlement);</span>
<span class="nc" id="L1655">            return false;</span>
        case SCOUT_SETTLEMENT_TRIBUTE:
<span class="nc" id="L1657">            return moveTribute(unit, 1, direction);</span>
        default:
<span class="nc" id="L1659">            logger.warning(&quot;showScoutIndianSettlementDialog fail: &quot; + act);</span>
            break;
        }
<span class="nc" id="L1662">        return true;</span>
    }

    /**
     * Spy on a foreign colony.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is spying.
     * @param direction The &lt;code&gt;Direction&lt;/code&gt; of a colony to spy on.
     * @return True if the unit can move further.
     */
    private boolean moveSpy(Unit unit, Direction direction) {
<span class="nc" id="L1673">        Settlement settlement = getSettlementAt(unit.getTile(), direction);</span>
<span class="nc bnc" id="L1674" title="All 2 branches missed.">        return (settlement instanceof Colony)</span>
<span class="nc" id="L1675">            ? askServer().spy(unit, settlement)</span>
<span class="nc" id="L1676">            : false;</span>
    }

    /**
     * Arrive at a settlement with a laden carrier following a move of
     * MoveType.ENTER_SETTLEMENT_WITH_CARRIER_AND_GOODS.
     *
     * @param unit The carrier.
     * @param direction The direction to the settlement.
     * @return True if the unit can move further.
     */
    private boolean moveTrade(Unit unit, Direction direction) {
<span class="nc" id="L1688">        askClearGotoOrders(unit);</span>

<span class="nc" id="L1690">        Settlement settlement = getSettlementAt(unit.getTile(), direction);</span>
<span class="nc bnc" id="L1691" title="All 2 branches missed.">        if (settlement instanceof Colony) {</span>
<span class="nc" id="L1692">            final Game game = getGame();</span>
<span class="nc" id="L1693">            final Player player = unit.getOwner();</span>
<span class="nc" id="L1694">            DiplomaticTrade agreement</span>
<span class="nc" id="L1695">                = new DiplomaticTrade(game, TradeContext.TRADE,</span>
<span class="nc" id="L1696">                    player, settlement.getOwner(), null, 0);</span>
<span class="nc" id="L1697">            agreement = getGUI().showNegotiationDialog(unit, settlement,</span>
<span class="nc" id="L1698">                agreement, agreement.getSendMessage(player, settlement));</span>
<span class="nc bnc" id="L1699" title="All 2 branches missed.">            return (agreement == null</span>
<span class="nc bnc" id="L1700" title="All 2 branches missed.">                || agreement.getStatus() == TradeStatus.REJECT_TRADE) ? true</span>
<span class="nc" id="L1701">                : moveDiplomacy(unit, direction, agreement);</span>
<span class="nc bnc" id="L1702" title="All 2 branches missed.">        } else if (settlement instanceof IndianSettlement) {</span>
<span class="nc" id="L1703">            return moveTradeIndianSettlement(unit, direction);</span>
        } else {
<span class="nc" id="L1705">            throw new RuntimeException(&quot;Bogus settlement: &quot;</span>
<span class="nc" id="L1706">                + settlement.getId());</span>
        }
    }

    /**
     * Trading with the natives, including buying, selling and
     * delivering gifts.  (Deliberate use of Settlement rather than
     * IndianSettlement throughout these routines as some unification
     * with colony trading is anticipated, and the native AI already
     * uses the same DeliverGiftMessage to deliver gifts to Colonies).
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is a carrier containing goods.
     * @param direction The direction the unit could move in order to enter a
     *            &lt;code&gt;Settlement&lt;/code&gt;.
     * @see Settlement
     * @return True if the unit can move further.
     */
    private boolean moveTradeIndianSettlement(Unit unit, Direction direction) {
<span class="nc" id="L1724">        IndianSettlement is</span>
<span class="nc" id="L1725">            = (IndianSettlement)getSettlementAt(unit.getTile(), direction);</span>

<span class="nc" id="L1727">        StringTemplate baseTemplate = StringTemplate</span>
<span class="nc" id="L1728">            .template(&quot;tradeProposition.welcome&quot;)</span>
<span class="nc" id="L1729">            .addStringTemplate(&quot;%nation%&quot;,</span>
<span class="nc" id="L1730">                is.getOwner().getNationLabel())</span>
<span class="nc" id="L1731">            .addName(&quot;%settlement%&quot;, is.getName());</span>
<span class="nc" id="L1732">        StringTemplate template = baseTemplate;</span>
<span class="nc" id="L1733">        boolean[] results = askServer()</span>
<span class="nc" id="L1734">            .openTransactionSession(unit, is);</span>
<span class="nc bnc" id="L1735" title="All 2 branches missed.">        while (results != null) {</span>
            // The session tracks buy/sell/gift events and disables
            // them when one happens.  So only offer such options if
            // the session allows it and the carrier is in good shape.
<span class="nc bnc" id="L1739" title="All 4 branches missed.">            boolean buy = results[0] &amp;&amp; unit.hasSpaceLeft();</span>
<span class="nc bnc" id="L1740" title="All 4 branches missed.">            boolean sel = results[1] &amp;&amp; unit.hasGoodsCargo();</span>
<span class="nc bnc" id="L1741" title="All 4 branches missed.">            boolean gif = results[2] &amp;&amp; unit.hasGoodsCargo();</span>
<span class="nc bnc" id="L1742" title="All 6 branches missed.">            if (!buy &amp;&amp; !sel &amp;&amp; !gif) break;</span>

<span class="nc" id="L1744">            TradeAction act = getGUI().getIndianSettlementTradeChoice(is,</span>
<span class="nc" id="L1745">                template, buy, sel, gif);</span>
<span class="nc bnc" id="L1746" title="All 2 branches missed.">            if (act == null) break;</span>
<span class="nc" id="L1747">            StringTemplate t = null;</span>
<span class="nc bnc" id="L1748" title="All 4 branches missed.">            switch (act) {</span>
            case BUY:
<span class="nc" id="L1750">                t = attemptBuyFromSettlement(unit, is);</span>
<span class="nc bnc" id="L1751" title="All 2 branches missed.">                if (t == null) {</span>
<span class="nc" id="L1752">                    results[0] = false;</span>
<span class="nc" id="L1753">                    template = baseTemplate;</span>
<span class="nc" id="L1754">                } else {</span>
<span class="nc" id="L1755">                    template = t;</span>
                }
<span class="nc" id="L1757">                break;</span>
            case SELL:
<span class="nc" id="L1759">                t = attemptSellToSettlement(unit, is);</span>
<span class="nc bnc" id="L1760" title="All 2 branches missed.">                if (t == null) {</span>
<span class="nc" id="L1761">                    results[1] = false;</span>
<span class="nc" id="L1762">                    template = baseTemplate;</span>
<span class="nc" id="L1763">                } else {</span>
<span class="nc" id="L1764">                    template = t;</span>
                }
<span class="nc" id="L1766">                break;</span>
            case GIFT:
<span class="nc" id="L1768">                t = attemptGiftToSettlement(unit, is);</span>
<span class="nc bnc" id="L1769" title="All 2 branches missed.">                if (t == null) {</span>
<span class="nc" id="L1770">                    results[2] = false;</span>
<span class="nc" id="L1771">                    template = baseTemplate;</span>
<span class="nc" id="L1772">                } else {</span>
<span class="nc" id="L1773">                    template = t;</span>
                }
<span class="nc" id="L1775">                break;</span>
            default:
<span class="nc" id="L1777">                logger.warning(&quot;showIndianSettlementTradeDialog fail: &quot;</span>
<span class="nc" id="L1778">                    + act);</span>
<span class="nc" id="L1779">                results = null;</span>
                break;
            }
<span class="nc bnc" id="L1782" title="All 2 branches missed.">            if (template == abortTrade) template = baseTemplate;</span>
        }

<span class="nc" id="L1785">        askServer().closeTransactionSession(unit, is);</span>
<span class="nc bnc" id="L1786" title="All 2 branches missed.">        if (unit.getMovesLeft() &gt; 0) getGUI().setActiveUnit(unit); // No trade?</span>
<span class="nc" id="L1787">        return false;</span>
    }

    /**
     * Displays an appropriate trade failure message.
     *
     * @param fail The failure state.
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; that failed to trade.
     * @param goods The &lt;code&gt;Goods&lt;/code&gt; that failed to trade.
     * @return A &lt;code&gt;StringTemplate&lt;/code&gt; describing the failure.
     */
    private StringTemplate tradeFailMessage(int fail, Settlement settlement,
                                            Goods goods) {
<span class="nc bnc" id="L1800" title="All 4 branches missed.">        switch (fail) {</span>
        case NO_TRADE_GOODS:
<span class="nc" id="L1802">            return StringTemplate.template(&quot;trade.noTradeGoods&quot;)</span>
<span class="nc" id="L1803">                .addNamed(&quot;%goods%&quot;, goods);</span>
        case NO_TRADE_HAGGLE:
<span class="nc" id="L1805">            return StringTemplate.template(&quot;trade.noTradeHaggle&quot;);</span>
        case NO_TRADE_HOSTILE:
<span class="nc" id="L1807">            return StringTemplate.template(&quot;trade.noTradeHostile&quot;);</span>
        case NO_TRADE: // Proposal was refused
        default:
            break;
        }
<span class="nc" id="L1812">        return StringTemplate.template(&quot;trade.noTrade&quot;)</span>
<span class="nc" id="L1813">            .addStringTemplate(&quot;%settlement%&quot;,</span>
<span class="nc" id="L1814">                settlement.getLocationLabelFor(getMyPlayer()));</span>
    }

    /**
     * User interaction for buying from the natives.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is trading.
     * @param is The &lt;code&gt;Settlement&lt;/code&gt; that is trading.
     * @return A &lt;code&gt;StringTemplate&lt;/code&gt; containing a message if
     *     there is problem, or null on success.
     */
    private StringTemplate attemptBuyFromSettlement(Unit unit,
                                                    IndianSettlement is) {
<span class="nc" id="L1827">        final Game game = getGame();</span>
<span class="nc" id="L1828">        Player player = getMyPlayer();</span>
<span class="nc" id="L1829">        Goods goods = null;</span>

        // Get list of goods for sale
<span class="nc bnc" id="L1832" title="All 2 branches missed.">        if (!askServer().getGoodsForSaleInSettlement(unit, is)) {</span>
<span class="nc" id="L1833">            return StringTemplate.template(&quot;trade.nothingToSell&quot;);</span>
        }
<span class="nc" id="L1835">        List&lt;Goods&gt; forSale = is.getGoodsForSale();</span>
        for (;;) {
<span class="nc bnc" id="L1837" title="All 2 branches missed.">            if (forSale.isEmpty()) { // Nothing to sell to the player</span>
<span class="nc" id="L1838">                return StringTemplate.template(&quot;trade.nothingToSell&quot;);</span>
            }

            // Choose goods to buy
<span class="nc" id="L1842">            goods = getGUI().getChoice(unit.getTile(),</span>
<span class="nc" id="L1843">                Messages.message(&quot;buyProposition.text&quot;), is, &quot;nothing&quot;,</span>
<span class="nc" id="L1844">                toList(map(forSale,</span>
<span class="nc" id="L1845">                        g -&gt; new ChoiceItem&lt;&gt;(Messages.message(g.getLabel()), g))));</span>
<span class="nc bnc" id="L1846" title="All 2 branches missed.">            if (goods == null) break; // Trade aborted by the player</span>

<span class="nc" id="L1848">            int gold = -1; // Initially ask for a price</span>
            for (;;) {
<span class="nc" id="L1850">                gold = askServer().buyProposition(unit, is, goods, gold);</span>
<span class="nc bnc" id="L1851" title="All 2 branches missed.">                if (gold &lt;= 0) {</span>
<span class="nc" id="L1852">                    return tradeFailMessage(gold, is, goods);</span>
                }

                // Show dialog for buy proposal
<span class="nc" id="L1856">                boolean canBuy = player.checkGold(gold);</span>
<span class="nc" id="L1857">                TradeBuyAction act</span>
<span class="nc" id="L1858">                    = getGUI().getBuyChoice(unit, is, goods, gold, canBuy);</span>
<span class="nc bnc" id="L1859" title="All 2 branches missed.">                if (act == null) break; // User cancelled</span>
<span class="nc bnc" id="L1860" title="All 3 branches missed.">                switch (act) {</span>
                case BUY: // Accept price, make purchase
<span class="nc" id="L1862">                    return (askServer().buyFromSettlement(unit,</span>
<span class="nc bnc" id="L1863" title="All 2 branches missed.">                            is, goods, gold)) ? null</span>
<span class="nc" id="L1864">                        : abortTrade;</span>
                case HAGGLE: // Try to negotiate a lower price
<span class="nc" id="L1866">                    gold = gold * 9 / 10;</span>
<span class="nc" id="L1867">                    break;</span>
                default:
<span class="nc" id="L1869">                    logger.warning(&quot;showBuyDialog fail: &quot; + act);</span>
<span class="nc" id="L1870">                    return null;</span>
                }
            }
        }
<span class="nc" id="L1874">        return abortTrade;</span>
    }

    /**
     * User interaction for selling to the natives.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is trading.
     * @param is The &lt;code&gt;IndianSettlement&lt;/code&gt; that is trading.
     * @return A &lt;code&gt;StringTemplate&lt;/code&gt; containing a message if
     *     there is problem, or null on success.
     */
    private StringTemplate attemptSellToSettlement(Unit unit,
                                                   IndianSettlement is) {
<span class="nc" id="L1887">        Goods goods = null;</span>
        for (;;) {
            // Choose goods to sell
<span class="nc" id="L1890">            goods = getGUI().getChoice(unit.getTile(),</span>
<span class="nc" id="L1891">                Messages.message(&quot;sellProposition.text&quot;), is, &quot;nothing&quot;,</span>
<span class="nc" id="L1892">                toList(map(unit.getGoodsList(), g -&gt;</span>
<span class="nc" id="L1893">                        new ChoiceItem&lt;&gt;(Messages.message(g.getLabel(true)), g))));</span>
<span class="nc bnc" id="L1894" title="All 2 branches missed.">            if (goods == null) break; // Trade aborted by the player</span>

<span class="nc" id="L1896">            int gold = -1; // Initially ask for a price</span>
            for (;;) {
<span class="nc" id="L1898">                gold = askServer().sellProposition(unit, is,</span>
<span class="nc" id="L1899">                                                   goods, gold);</span>
<span class="nc bnc" id="L1900" title="All 2 branches missed.">                if (gold &lt;= 0) {</span>
<span class="nc" id="L1901">                    return tradeFailMessage(gold, is, goods);</span>
                }

                // Show dialog for sale proposal
<span class="nc" id="L1905">                TradeSellAction act</span>
<span class="nc" id="L1906">                    = getGUI().getSellChoice(unit, is, goods, gold);</span>
<span class="nc bnc" id="L1907" title="All 2 branches missed.">                if (act == null) break; // Cancelled</span>
<span class="nc bnc" id="L1908" title="All 4 branches missed.">                switch (act) {</span>
                case SELL: // Accepted price, make the sale
<span class="nc bnc" id="L1910" title="All 2 branches missed.">                    return (askServer().sellToSettlement(unit, is, goods, gold))</span>
<span class="nc" id="L1911">                        ? null</span>
<span class="nc" id="L1912">                        : abortTrade;</span>
                case HAGGLE: // Ask for more money
<span class="nc" id="L1914">                    gold = (gold * 11) / 10;</span>
<span class="nc" id="L1915">                    break;</span>
                case GIFT: // Decide to make a gift of the goods
<span class="nc" id="L1917">                    askServer().deliverGiftToSettlement(unit,</span>
<span class="nc" id="L1918">                        is, goods);</span>
<span class="nc" id="L1919">                    return abortTrade;</span>
                default:
<span class="nc" id="L1921">                    logger.warning(&quot;showSellDialog fail: &quot; + act);</span>
<span class="nc" id="L1922">                    return null;</span>
                }
            }
        }
<span class="nc" id="L1926">        return abortTrade;</span>
    }

    /**
     * User interaction for delivering a gift to the natives.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is trading.
     * @param is The &lt;code&gt;IndianSettlement&lt;/code&gt; that is trading.
     * @return A &lt;code&gt;StringTemplate&lt;/code&gt; containing a message if
     *     there is problem, or null on success.
     */
    private StringTemplate attemptGiftToSettlement(Unit unit,
                                                   IndianSettlement is) {
<span class="nc" id="L1939">        Goods goods = getGUI().getChoice(unit.getTile(),</span>
<span class="nc" id="L1940">            Messages.message(&quot;gift.text&quot;), is, &quot;cancel&quot;,</span>
<span class="nc" id="L1941">            toList(map(unit.getGoodsList(), g -&gt;</span>
<span class="nc" id="L1942">                    new ChoiceItem&lt;&gt;(Messages.message(g.getLabel(true)), g))));</span>
<span class="nc bnc" id="L1943" title="All 2 branches missed.">        return (goods != null</span>
<span class="nc bnc" id="L1944" title="All 2 branches missed.">            &amp;&amp; askServer().deliverGiftToSettlement(unit, is, goods))</span>
<span class="nc" id="L1945">            ? null</span>
<span class="nc" id="L1946">            : abortTrade;</span>
    }

    /**
     * Demand a tribute.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to perform the attack.
     * @param amount An amount of tribute to demand.
     * @param direction The direction in which to attack.
     * @return True if the unit can move further.
     */
    private boolean moveTribute(Unit unit, int amount, Direction direction) {
<span class="nc" id="L1958">        final Game game = getGame();</span>
<span class="nc" id="L1959">        Player player = unit.getOwner();</span>
<span class="nc" id="L1960">        Tile tile = unit.getTile();</span>
<span class="nc" id="L1961">        Tile target = tile.getNeighbourOrNull(direction);</span>
<span class="nc" id="L1962">        Settlement settlement = target.getSettlement();</span>
<span class="nc" id="L1963">        Player other = settlement.getOwner();</span>

        // Indians are easy and can use the basic tribute mechanism.
<span class="nc bnc" id="L1966" title="All 2 branches missed.">        if (settlement.getOwner().isIndian()) {</span>
<span class="nc" id="L1967">            askServer().demandTribute(unit, direction);</span>
<span class="nc" id="L1968">            return false;</span>
        }
        
        // Europeans might be human players, so we convert to a diplomacy
        // dialog.
<span class="nc" id="L1973">        DiplomaticTrade agreement</span>
<span class="nc" id="L1974">            = new DiplomaticTrade(game, TradeContext.TRIBUTE, player, other,</span>
<span class="nc" id="L1975">                                  null, 0);</span>
<span class="nc" id="L1976">        agreement.add(new StanceTradeItem(game, player, other, Stance.PEACE));</span>
<span class="nc" id="L1977">        agreement.add(new GoldTradeItem(game, other, player, amount));</span>
<span class="nc" id="L1978">        return moveDiplomacy(unit, direction, agreement);</span>
    }

    /**
     * Move a missionary into a native settlement, following a move of
     * MoveType.ENTER_INDIAN_SETTLEMENT_WITH_MISSIONARY.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that will enter the settlement.
     * @param direction The direction in which the Indian settlement lies.
     * @return True if the unit can move further.
     */
    private boolean moveUseMissionary(Unit unit, Direction direction) {
<span class="nc" id="L1990">        IndianSettlement settlement</span>
<span class="nc" id="L1991">            = (IndianSettlement)getSettlementAt(unit.getTile(), direction);</span>
<span class="nc" id="L1992">        Player player = unit.getOwner();</span>
<span class="nc bnc" id="L1993" title="All 2 branches missed.">        boolean canEstablish = !settlement.hasMissionary();</span>
<span class="nc bnc" id="L1994" title="All 2 branches missed.">        boolean canDenounce = !canEstablish</span>
<span class="nc bnc" id="L1995" title="All 2 branches missed.">            &amp;&amp; !settlement.hasMissionary(player);</span>
<span class="nc" id="L1996">        askClearGotoOrders(unit);</span>

        // Offer the choices.
<span class="nc" id="L1999">        MissionaryAction act = getGUI().getMissionaryChoice(unit, settlement,</span>
<span class="nc" id="L2000">            canEstablish, canDenounce);</span>
<span class="nc bnc" id="L2001" title="All 2 branches missed.">        if (act == null) return true;</span>
<span class="nc bnc" id="L2002" title="All 3 branches missed.">        switch (act) {</span>
        case MISSIONARY_ESTABLISH_MISSION: case MISSIONARY_DENOUNCE_HERESY:
<span class="nc" id="L2004">            if (askServer().missionary(unit, direction,</span>
<span class="nc bnc" id="L2005" title="All 4 branches missed.">                    act == MissionaryAction.MISSIONARY_DENOUNCE_HERESY)</span>
<span class="nc bnc" id="L2006" title="All 2 branches missed.">                &amp;&amp; settlement.hasMissionary(player)) {</span>
<span class="nc" id="L2007">                sound(&quot;sound.event.missionEstablished&quot;);</span>
<span class="nc" id="L2008">                player.invalidateCanSeeTiles();</span>
            }
<span class="nc" id="L2010">            break;</span>
        case MISSIONARY_INCITE_INDIANS:
<span class="nc" id="L2012">            Player enemy = getGUI().getChoice(unit.getTile(),</span>
<span class="nc" id="L2013">                Messages.message(&quot;missionarySettlement.inciteQuestion&quot;),</span>
<span class="nc" id="L2014">                unit, &quot;missionarySettlement.cancel&quot;,</span>
<span class="nc" id="L2015">                toList(map(getGame().getLiveEuropeanPlayers(player), p -&gt;</span>
<span class="nc" id="L2016">                        new ChoiceItem&lt;&gt;(Messages.message(p.getCountryLabel()), p))));</span>
<span class="nc bnc" id="L2017" title="All 2 branches missed.">            if (enemy == null) return true;</span>
<span class="nc" id="L2018">            askServer().incite(unit, settlement, enemy, -1);</span>
<span class="nc" id="L2019">            break;</span>
        default:
<span class="nc" id="L2021">            logger.warning(&quot;showUseMissionaryDialog fail&quot;);</span>
            break;
        }
<span class="nc" id="L2024">        return false;</span>
    }


    // Trade route support.

    /**
     * Follows a trade route, doing load/unload actions, moving the unit,
     * and updating the stop and destination.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; on the route.
     * @param messages An optional list in which to retain any
     *     &lt;code&gt;ModelMessage&lt;/code&gt;s generated.
     * @return True if the unit should keep moving, which can only
     *     happen if the trade route is found to be broken and the
     *     unit is thrown off it.
     */
    private boolean followTradeRoute(Unit unit, List&lt;ModelMessage&gt; messages) {
<span class="nc" id="L2042">        final Player player = unit.getOwner();</span>
<span class="nc" id="L2043">        final TradeRoute tr = unit.getTradeRoute();</span>
<span class="nc" id="L2044">        final boolean detailed = getClientOptions()</span>
<span class="nc" id="L2045">            .getBoolean(ClientOptions.SHOW_GOODS_MOVEMENT);</span>
<span class="nc" id="L2046">        final boolean checkProduction = getClientOptions()</span>
<span class="nc" id="L2047">            .getBoolean(ClientOptions.STOCK_ACCOUNTS_FOR_PRODUCTION);</span>
<span class="nc" id="L2048">        final List&lt;TradeRouteStop&gt; stops = unit.getCurrentStops();</span>
<span class="nc" id="L2049">        boolean result = false;</span>

        // If required, accumulate a summary of all the activity of
        // this unit on its trade route.
<span class="nc bnc" id="L2053" title="All 4 branches missed.">        LogBuilder lb = new LogBuilder((detailed &amp;&amp; !tr.isSilent()) ? 256</span>
<span class="nc" id="L2054">            : -1);</span>
<span class="nc" id="L2055">        lb.mark();</span>

        // Validate the whole route.
<span class="nc" id="L2058">        boolean valid = true;</span>
<span class="nc bnc" id="L2059" title="All 2 branches missed.">        for (TradeRouteStop trs : stops) {</span>
<span class="nc bnc" id="L2060" title="All 2 branches missed.">            if (!TradeRoute.isStopValid(unit, trs)) {</span>
<span class="nc" id="L2061">                lb.add(&quot; &quot;, Messages.message(trs.invalidStopLabel(player)));</span>
<span class="nc" id="L2062">                valid = false;</span>
            }
        }
<span class="nc bnc" id="L2065" title="All 2 branches missed.">        if (!valid) {</span>
<span class="nc" id="L2066">            clearOrders(unit);</span>
<span class="nc" id="L2067">            stops.clear();</span>
<span class="nc bnc" id="L2068" title="All 2 branches missed.">            result = unit.getMovesLeft() &gt; 0;</span>
        }

        // Try to find work to do on the current list of stops.
<span class="nc bnc" id="L2072" title="All 2 branches missed.">        while (!stops.isEmpty()) {</span>
<span class="nc" id="L2073">            TradeRouteStop stop = stops.remove(0);</span>

<span class="nc bnc" id="L2075" title="All 2 branches missed.">            if (!unit.atStop(stop)) {</span>
                // Not at stop, give up if no moves left or the path was
                // exhausted on a previous round.
<span class="nc bnc" id="L2078" title="All 2 branches missed.">                if (unit.getMovesLeft() &lt;= 0</span>
<span class="nc bnc" id="L2079" title="All 2 branches missed.">                    || unit.getState() == UnitState.SKIPPED) {</span>
<span class="nc" id="L2080">                    lb.add(&quot; &quot;, Messages.message(stop</span>
<span class="nc" id="L2081">                            .getLabelFor(&quot;tradeRoute.toStop&quot;, player)));</span>
<span class="nc" id="L2082">                    break;</span>
                }

                // Find a path to the stop, skip if none.
<span class="nc" id="L2086">                Location destination = stop.getLocation();</span>
<span class="nc" id="L2087">                PathNode path = unit.findPath(destination);</span>
<span class="nc bnc" id="L2088" title="All 2 branches missed.">                if (path == null) {</span>
<span class="nc" id="L2089">                    lb.add(&quot;\n&quot;, Messages.message(stop</span>
<span class="nc" id="L2090">                            .getLabelFor(&quot;tradeRoute.pathStop&quot;, player)));</span>
<span class="nc" id="L2091">                    unit.setState(UnitState.SKIPPED);</span>
<span class="nc" id="L2092">                    break;</span>
                }
                
                // Try to follow the path.  If the unit does not reach
                // the stop it is finished for now.
<span class="nc" id="L2097">                movePath(unit, path);</span>
<span class="nc bnc" id="L2098" title="All 2 branches missed.">                if (!unit.atStop(stop)) {</span>
<span class="nc" id="L2099">                    unit.setState(UnitState.SKIPPED);</span>
<span class="nc" id="L2100">                    break;</span>
                }
            }

            // At the stop, do the work available.
<span class="nc" id="L2105">            lb.mark();</span>
<span class="nc" id="L2106">            unloadUnitAtStop(unit, lb); // Anything to unload?</span>
<span class="nc" id="L2107">            loadUnitAtStop(unit, lb); // Anything to load?</span>
<span class="nc" id="L2108">            lb.grew(&quot;\n&quot;, Messages.message(stop.getLabelFor(&quot;tradeRoute.atStop&quot;,</span>
<span class="nc" id="L2109">                                                            player)));</span>

            // If the un/load consumed the moves, break now before
            // updating the stop.  This allows next turn to retry
            // un/loading, but this time it will not consume the moves.
<span class="nc bnc" id="L2114" title="All 2 branches missed.">            if (unit.getMovesLeft() &lt;= 0) break;</span>

            // Find the next stop with work to do.
<span class="nc" id="L2117">            TradeRouteStop next = null;</span>
<span class="nc" id="L2118">            List&lt;TradeRouteStop&gt; moreStops = unit.getCurrentStops();</span>
<span class="nc bnc" id="L2119" title="All 2 branches missed.">            if (unit.atStop(moreStops.get(0))) moreStops.remove(0);</span>
<span class="nc bnc" id="L2120" title="All 2 branches missed.">            for (TradeRouteStop trs : moreStops) {</span>
<span class="nc bnc" id="L2121" title="All 2 branches missed.">                if (trs.hasWork(unit, (!checkProduction) ? 0</span>
<span class="nc bnc" id="L2122" title="All 2 branches missed.">                                : unit.getTurnsToReach(trs.getLocation()))) {</span>
<span class="nc" id="L2123">                    next = trs;</span>
<span class="nc" id="L2124">                    break;</span>
                }
            }
<span class="nc bnc" id="L2127" title="All 2 branches missed.">            if (next == null) {</span>
                // No work was found anywhere on the trade route,
                // so we should skip this unit.
<span class="nc" id="L2130">                lb.add(&quot; &quot;, Messages.message(&quot;tradeRoute.wait&quot;));</span>
<span class="nc" id="L2131">                unit.setState(UnitState.SKIPPED);</span>
<span class="nc" id="L2132">                unit.setMovesLeft(0);</span>
<span class="nc" id="L2133">                break;</span>
            }
            // Add a message for any skipped stops.
<span class="nc" id="L2136">            List&lt;TradeRouteStop&gt; skipped</span>
<span class="nc" id="L2137">                = tr.getStopSublist(stops.get(0), next);</span>
<span class="nc bnc" id="L2138" title="All 2 branches missed.">            if (!skipped.isEmpty()) {</span>
<span class="nc" id="L2139">                StringTemplate t = StringTemplate.label(&quot;&quot;)</span>
<span class="nc" id="L2140">                    .add(&quot;tradeRoute.skipped&quot;);</span>
<span class="nc" id="L2141">                String sep = &quot; &quot;;</span>
<span class="nc bnc" id="L2142" title="All 2 branches missed.">                for (TradeRouteStop trs : skipped) {</span>
<span class="nc" id="L2143">                    t.addName(sep)</span>
<span class="nc" id="L2144">                        .addStringTemplate(trs.getLocation()</span>
<span class="nc" id="L2145">                            .getLocationLabelFor(player));</span>
<span class="nc" id="L2146">                    sep = &quot;, &quot;;</span>
                }
<span class="nc" id="L2148">                t.addName(&quot;.&quot;);</span>
<span class="nc" id="L2149">                lb.add(&quot; &quot;, Messages.message(t));</span>
            }
            // Bring the next stop to the head of the stops list if it
            // is present.
<span class="nc bnc" id="L2153" title="All 4 branches missed.">            while (!stops.isEmpty() &amp;&amp; stops.get(0) != next) {</span>
<span class="nc" id="L2154">                stops.remove(0);</span>
            }
            // Set the new stop, skip on error.
<span class="nc bnc" id="L2157" title="All 2 branches missed.">            if (!askServer().setCurrentStop(unit, tr.getIndex(next))) {</span>
<span class="nc" id="L2158">                unit.setState(UnitState.SKIPPED);</span>
<span class="nc" id="L2159">                break;</span>
            }
        }

<span class="nc bnc" id="L2163" title="All 2 branches missed.">        if (lb.grew()) {</span>
<span class="nc" id="L2164">            ModelMessage m = new ModelMessage(MessageType.GOODS_MOVEMENT,</span>
<span class="nc" id="L2165">                                              &quot;tradeRoute.prefix&quot;, unit)</span>
<span class="nc" id="L2166">                .addName(&quot;%route%&quot;, tr.getName())</span>
<span class="nc" id="L2167">                .addStringTemplate(&quot;%unit%&quot;,</span>
<span class="nc" id="L2168">                    unit.getLabel(Unit.UnitLabelType.NATIONAL))</span>
<span class="nc" id="L2169">                .addName(&quot;%data%&quot;, lb.toString());</span>
<span class="nc bnc" id="L2170" title="All 2 branches missed.">            if (messages != null) {</span>
<span class="nc" id="L2171">                messages.add(m);</span>
<span class="nc" id="L2172">            } else {</span>
<span class="nc" id="L2173">                player.addModelMessage(m);</span>
<span class="nc" id="L2174">                turnReportMessages.add(m);</span>
            }
        }
<span class="nc" id="L2177">        return result;</span>
    }

    /**
     * Work out what goods to load onto a unit at a stop, and load them.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to load.
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to update.
     * @return True if goods were loaded.
     */
    private boolean loadUnitAtStop(Unit unit, LogBuilder lb) {
<span class="nc" id="L2188">        final boolean enhancedTradeRoutes = getSpecification()</span>
<span class="nc" id="L2189">            .getBoolean(GameOptions.ENHANCED_TRADE_ROUTES);</span>
<span class="nc" id="L2190">        final TradeRoute tradeRoute = unit.getTradeRoute();</span>
<span class="nc" id="L2191">        final TradeLocation trl = unit.getTradeLocation();</span>
<span class="nc bnc" id="L2192" title="All 2 branches missed.">        if (trl == null) return false;</span>

<span class="nc" id="L2194">        final TradeRouteStop stop = unit.getStop();</span>
<span class="nc" id="L2195">        boolean ret = false;</span>

        // A collapsed list of goods to load at this stop.
<span class="nc" id="L2198">        List&lt;AbstractGoods&gt; toLoad = stop.getCompactCargo();</span>
        // Templates to accumulate messages in.
<span class="nc" id="L2200">        StringTemplate unexpected = StringTemplate.label(&quot;, &quot;);</span>
<span class="nc" id="L2201">        StringTemplate noLoad = StringTemplate.label(&quot;, &quot;);</span>
<span class="nc" id="L2202">        StringTemplate left = StringTemplate.label(&quot;, &quot;);</span>
<span class="nc" id="L2203">        StringTemplate loaded = StringTemplate.label(&quot;, &quot;);</span>
<span class="nc" id="L2204">        StringTemplate nonePresent = StringTemplate.label(&quot;, &quot;);</span>
        
        // Check the goods already on board.  If it is not expected to
        // be loaded at this stop then complain (unload must have
        // failed somewhere).  If it is expected to load, reduce the
        // loading amount by what is already on board.
<span class="nc bnc" id="L2210" title="All 2 branches missed.">        for (Goods g : unit.getCompactGoods()) {</span>
<span class="nc" id="L2211">            AbstractGoods ag = AbstractGoods.findByType(g.getType(), toLoad);</span>
<span class="nc bnc" id="L2212" title="All 2 branches missed.">            if (ag == null) { // Excess goods on board, failed unload?</span>
<span class="nc" id="L2213">                unexpected.addStringTemplate(&quot;%goods%&quot;, ag.getLabel());</span>
<span class="nc" id="L2214">            } else {</span>
<span class="nc" id="L2215">                int goodsAmount = g.getAmount();</span>
<span class="nc bnc" id="L2216" title="All 2 branches missed.">                if (ag.getAmount() &lt;= goodsAmount) { // At capacity</span>
<span class="nc" id="L2217">                    noLoad.addStringTemplate(StringTemplate</span>
<span class="nc" id="L2218">                        .template(&quot;tradeRoute.loadStop.noLoad.carrier&quot;)</span>
<span class="nc" id="L2219">                            .addNamed(&quot;%goodsType%&quot;, ag.getType()));</span>
<span class="nc" id="L2220">                    toLoad.remove(ag);</span>
<span class="nc" id="L2221">                } else {</span>
<span class="nc" id="L2222">                    ag.setAmount(ag.getAmount() - goodsAmount);</span>
                }
            }
        }

        // Adjust toLoad with the actual amount to load.
        // Drop goods that are:
        // - missing
        // - do not have an export surplus
        // - (optionally) are not needed by the destination
        // and add messages for them.
        //
        // Similarly, for each goods type, add an entry to the limit
        // map, with value:
        // - the unit, when it lacks capacity for all the goods present
        // - the stop when there is a non-zero export limit
        // - (optionally) the destination stop when there is a non-zero
        //   import limit
        // - otherwise null
<span class="nc" id="L2241">        java.util.Map&lt;GoodsType, Location&gt; limit = new HashMap&lt;&gt;();</span>
<span class="nc" id="L2242">        Iterator&lt;AbstractGoods&gt; iterator = toLoad.iterator();</span>
<span class="nc bnc" id="L2243" title="All 2 branches missed.">        while (iterator.hasNext()) {</span>
<span class="nc" id="L2244">            AbstractGoods ag = iterator.next();</span>
<span class="nc" id="L2245">            final GoodsType type = ag.getType();</span>
<span class="nc" id="L2246">            int present = stop.getGoodsCount(type);</span>
<span class="nc" id="L2247">            int exportAmount = stop.getExportAmount(type, 0);</span>
<span class="nc" id="L2248">            int importAmount = FreeColObject.INFINITY;</span>
<span class="nc" id="L2249">            TradeRouteStop unload = null;</span>
<span class="nc bnc" id="L2250" title="All 2 branches missed.">            if (enhancedTradeRoutes) {</span>
<span class="nc" id="L2251">                final List&lt;TradeRouteStop&gt; stops = unit.getCurrentStops();</span>
<span class="nc" id="L2252">                stops.remove(0);</span>
<span class="nc" id="L2253">                Location start = unit.getLocation();</span>
<span class="nc" id="L2254">                int turns = 0;</span>
<span class="nc bnc" id="L2255" title="All 2 branches missed.">                for (TradeRouteStop trs : stops) {</span>
<span class="nc" id="L2256">                    turns += unit.getTurnsToReach(start, trs.getLocation());</span>
<span class="nc" id="L2257">                    int amountIn = trs.getImportAmount(type, turns),</span>
<span class="nc" id="L2258">                        amountOut = trs.getExportAmount(type, turns);</span>
<span class="nc bnc" id="L2259" title="All 2 branches missed.">                    if (AbstractGoods.findByType(type, trs.getCompactCargo()) == null</span>
<span class="nc bnc" id="L2260" title="All 2 branches missed.">                        || amountIn &gt; amountOut) {</span>
<span class="nc" id="L2261">                        importAmount = amountIn;</span>
<span class="nc" id="L2262">                        unload = trs;</span>
<span class="nc" id="L2263">                        break;</span>
                    }
<span class="nc" id="L2265">                    start = trs.getLocation();</span>
                }
            }
<span class="nc bnc" id="L2268" title="All 4 branches missed.">            if (enhancedTradeRoutes &amp;&amp; unload == null) {</span>
<span class="nc" id="L2269">                noLoad.addStringTemplate(StringTemplate</span>
<span class="nc" id="L2270">                    .template(&quot;tradeRoute.loadStop.noLoad.noUnload&quot;)</span>
<span class="nc" id="L2271">                        .addNamed(&quot;%goodsType%&quot;, type));</span>
<span class="nc" id="L2272">                ag.setAmount(0);</span>
<span class="nc bnc" id="L2273" title="All 2 branches missed.">            } else if (present &lt;= 0) { // None present</span>
<span class="nc" id="L2274">                nonePresent.addNamed(type);</span>
<span class="nc" id="L2275">                ag.setAmount(0);</span>
<span class="nc bnc" id="L2276" title="All 2 branches missed.">            } else if (exportAmount &lt;= 0) { // Export blocked</span>
<span class="nc" id="L2277">                noLoad.addStringTemplate(StringTemplate</span>
<span class="nc" id="L2278">                    .template(&quot;tradeRoute.loadStop.noLoad.export&quot;)</span>
<span class="nc" id="L2279">                        .addNamed(&quot;%goodsType%&quot;, type)</span>
<span class="nc" id="L2280">                        .addAmount(&quot;%more%&quot;, present));</span>
<span class="nc" id="L2281">                ag.setAmount(0);</span>
<span class="nc bnc" id="L2282" title="All 2 branches missed.">            } else if (importAmount &lt;= 0) { // Import blocked</span>
<span class="nc" id="L2283">                noLoad.addStringTemplate(StringTemplate</span>
<span class="nc" id="L2284">                    .template(&quot;tradeRoute.loadStop.noLoad.import&quot;)</span>
<span class="nc" id="L2285">                        .addNamed(&quot;%goodsType%&quot;, type)</span>
<span class="nc" id="L2286">                        .addAmount(&quot;%more%&quot;, present)</span>
<span class="nc" id="L2287">                        .addStringTemplate(&quot;%location%&quot;, unload.getLocation()</span>
<span class="nc" id="L2288">                            .getLocationLabelFor(unit.getOwner())));</span>
<span class="nc" id="L2289">                ag.setAmount(0);</span>
<span class="nc bnc" id="L2290" title="All 2 branches missed.">            } else if (exportAmount &lt; ag.getAmount() // Export limited</span>
<span class="nc bnc" id="L2291" title="All 2 branches missed.">                &amp;&amp; exportAmount &lt;= importAmount) {</span>
<span class="nc" id="L2292">                ag.setAmount(exportAmount);</span>
<span class="nc" id="L2293">                limit.put(type, stop.getLocation());</span>
<span class="nc bnc" id="L2294" title="All 2 branches missed.">            } else if (importAmount &lt; ag.getAmount() // Import limited</span>
<span class="nc bnc" id="L2295" title="All 2 branches missed.">                &amp;&amp; importAmount &lt;= exportAmount) {</span>
<span class="nc" id="L2296">                int already = unit.getGoodsCount(type);</span>
<span class="nc bnc" id="L2297" title="All 2 branches missed.">                if (already &gt;= importAmount) {</span>
<span class="nc bnc" id="L2298" title="All 2 branches missed.">                    if (already &gt; importAmount) {</span>
<span class="nc" id="L2299">                        askUnloadGoods(type, already - importAmount, unit);</span>
                    }
<span class="nc" id="L2301">                    noLoad.addStringTemplate(StringTemplate</span>
<span class="nc" id="L2302">                        .template(&quot;tradeRoute.loadStop.noLoad.already&quot;)</span>
<span class="nc" id="L2303">                            .addNamed(&quot;%goodsType%&quot;, type));</span>
<span class="nc" id="L2304">                    ag.setAmount(0);</span>
<span class="nc" id="L2305">                } else {</span>
<span class="nc" id="L2306">                    ag.setAmount(importAmount - already);</span>
                }
<span class="nc" id="L2308">                limit.put(type, unload.getLocation());</span>
<span class="nc bnc" id="L2309" title="All 2 branches missed.">            } else if (present &gt; ag.getAmount()) { // Carrier limited (last!)</span>
<span class="nc" id="L2310">                limit.put(type, unit);</span>
<span class="nc" id="L2311">            } else { // Expecting to load everything present</span>
<span class="nc" id="L2312">                limit.put(type, null);</span>
            }

            // Do not load this goods type
<span class="nc bnc" id="L2316" title="All 2 branches missed.">            if (ag.getAmount() &lt;= 0) iterator.remove();</span>

<span class="nc" id="L2318">            logger.log(Level.FINEST, &quot;Load &quot; + tradeRoute.getName()</span>
<span class="nc" id="L2319">                + &quot; with &quot; + unit.getId() + &quot; at &quot; + stop.getLocation()</span>
<span class="nc" id="L2320">                + &quot; of &quot; + type.getSuffix() + &quot; from &quot; + present</span>
<span class="nc" id="L2321">                + &quot; exporting &quot; + exportAmount + &quot; importing &quot; + importAmount</span>
<span class="nc bnc" id="L2322" title="All 2 branches missed.">                + &quot; to &quot; + ((unload == null) ? &quot;?&quot;</span>
<span class="nc" id="L2323">                    : unload.getLocation().toString())</span>
<span class="nc" id="L2324">                + &quot; limited by &quot; + limit.get(type)</span>
<span class="nc" id="L2325">                + &quot; -&gt; &quot; + ag.getAmount());</span>
        }

<span class="nc bnc" id="L2328" title="All 2 branches missed.">        if (enhancedTradeRoutes) { // Prioritize by goods amount</span>
<span class="nc" id="L2329">            Collections.sort(toLoad, AbstractGoods.abstractGoodsComparator);</span>
        }
        
        // Load the goods.
<span class="nc" id="L2333">        boolean done = false;</span>
<span class="nc bnc" id="L2334" title="All 2 branches missed.">        for (AbstractGoods ag : toLoad) {</span>
<span class="nc" id="L2335">            final GoodsType type = ag.getType();</span>
<span class="nc" id="L2336">            final int amount = ag.getAmount();</span>
<span class="nc bnc" id="L2337" title="All 2 branches missed.">            if (!done) {</span>
<span class="nc bnc" id="L2338" title="All 2 branches missed.">                done = unit.getLoadableAmount(type) &lt; amount</span>
<span class="nc bnc" id="L2339" title="All 2 branches missed.">                    || !askLoadGoods(stop.getLocation(), type, amount, unit);</span>
            }
<span class="nc bnc" id="L2341" title="All 2 branches missed.">            if (done) {</span>
<span class="nc" id="L2342">                left.addNamed(ag);</span>
<span class="nc" id="L2343">                continue;</span>
            }
<span class="nc" id="L2345">            int present = stop.getGoodsCount(type);</span>
<span class="nc" id="L2346">            Location why = limit.get(type);</span>
<span class="nc bnc" id="L2347" title="All 2 branches missed.">            if (present == 0) {</span>
<span class="nc" id="L2348">                loaded.addStringTemplate(ag.getLabel());</span>
<span class="nc bnc" id="L2349" title="All 2 branches missed.">            } else if (why == null) {</span>
<span class="nc" id="L2350">                loaded.addStringTemplate(StringTemplate</span>
<span class="nc" id="L2351">                    .template(&quot;tradeRoute.loadStop.load.fail&quot;)</span>
<span class="nc" id="L2352">                        .addStringTemplate(&quot;%goods%&quot;, ag.getLabel())</span>
<span class="nc" id="L2353">                        .addAmount(&quot;%more%&quot;, present));</span>
<span class="nc bnc" id="L2354" title="All 2 branches missed.">            } else if (why == unit) {</span>
<span class="nc" id="L2355">                loaded.addStringTemplate(StringTemplate</span>
<span class="nc" id="L2356">                    .template(&quot;tradeRoute.loadStop.load.carrier&quot;)</span>
<span class="nc" id="L2357">                        .addStringTemplate(&quot;%goods%&quot;, ag.getLabel())</span>
<span class="nc" id="L2358">                        .addAmount(&quot;%more%&quot;, present));</span>
<span class="nc bnc" id="L2359" title="All 2 branches missed.">            } else if (Map.isSameLocation(why, stop.getLocation())) {</span>
<span class="nc" id="L2360">                loaded.addStringTemplate(StringTemplate</span>
<span class="nc" id="L2361">                    .template(&quot;tradeRoute.loadStop.load.export&quot;)</span>
<span class="nc" id="L2362">                    .addStringTemplate(&quot;%goods%&quot;, ag.getLabel())</span>
<span class="nc" id="L2363">                    .addAmount(&quot;%more%&quot;, present));</span>
<span class="nc" id="L2364">            } else {</span>
<span class="nc" id="L2365">                loaded.addStringTemplate(StringTemplate</span>
<span class="nc" id="L2366">                    .template(&quot;tradeRoute.loadStop.load.import&quot;)</span>
<span class="nc" id="L2367">                    .addStringTemplate(&quot;%goods%&quot;, ag.getLabel())</span>
<span class="nc" id="L2368">                    .addAmount(&quot;%more%&quot;, present)</span>
<span class="nc" id="L2369">                    .addStringTemplate(&quot;%location%&quot;,</span>
<span class="nc" id="L2370">                        why.getLocationLabelFor(unit.getOwner())));</span>
            }
<span class="nc" id="L2372">            ret = true;</span>
        }
<span class="nc bnc" id="L2374" title="All 2 branches missed.">        if (!loaded.isEmpty()) {</span>
<span class="nc" id="L2375">            lb.add(&quot;\n  &quot;, Messages.message(StringTemplate</span>
<span class="nc" id="L2376">                    .template(&quot;tradeRoute.loadStop.load&quot;)</span>
<span class="nc" id="L2377">                        .addStringTemplate(&quot;%goodsList%&quot;, loaded)));</span>
        }
<span class="nc bnc" id="L2379" title="All 2 branches missed.">        if (!unexpected.isEmpty()) {</span>
<span class="nc" id="L2380">            lb.add(&quot;\n  &quot;, Messages.message(StringTemplate</span>
<span class="nc" id="L2381">                    .template(&quot;tradeRoute.loadStop.unexpected&quot;)</span>
<span class="nc" id="L2382">                        .addStringTemplate(&quot;%goodsList%&quot;, unexpected)));</span>
        }
<span class="nc bnc" id="L2384" title="All 2 branches missed.">        if (!left.isEmpty()) {</span>
<span class="nc" id="L2385">            noLoad.addStringTemplate(StringTemplate</span>
<span class="nc" id="L2386">                .template(&quot;tradeRoute.loadStop.noLoad.left&quot;)</span>
<span class="nc" id="L2387">                    .addStringTemplate(&quot;%goodsList%&quot;, left));</span>
        }
<span class="nc bnc" id="L2389" title="All 2 branches missed.">        if (!nonePresent.isEmpty()) {</span>
<span class="nc" id="L2390">            noLoad.addStringTemplate(StringTemplate</span>
<span class="nc" id="L2391">                .template(&quot;tradeRoute.loadStop.noLoad.goods&quot;)</span>
<span class="nc" id="L2392">                    .addStringTemplate(&quot;%goodsList%&quot;, nonePresent));</span>
        }
<span class="nc bnc" id="L2394" title="All 2 branches missed.">        if (!noLoad.isEmpty()) {</span>
<span class="nc" id="L2395">            lb.add(&quot;\n  &quot;, Messages.message(StringTemplate</span>
<span class="nc" id="L2396">                    .template(&quot;tradeRoute.loadStop.noLoad&quot;)</span>
<span class="nc" id="L2397">                        .addStringTemplate(&quot;%goodsList%&quot;, noLoad)));</span>
        }
<span class="nc" id="L2399">        return ret;</span>
    }

    /**
     * Work out what goods to unload from a unit at a stop, and unload them.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to unload.
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to update.
     * @return True if something was unloaded.
     */
    private boolean unloadUnitAtStop(Unit unit, LogBuilder lb) {
<span class="nc" id="L2410">        final TradeLocation trl = unit.getTradeLocation();</span>
<span class="nc bnc" id="L2411" title="All 2 branches missed.">        if (trl == null) return false;</span>

<span class="nc" id="L2413">        final TradeRouteStop stop = unit.getStop();</span>
<span class="nc" id="L2414">        final List&lt;GoodsType&gt; goodsTypesToLoad = stop.getCargo();</span>
<span class="nc" id="L2415">        final StringTemplate unloaded = StringTemplate.label(&quot;, &quot;);</span>
<span class="nc" id="L2416">        final StringTemplate noUnload = StringTemplate.label(&quot;, &quot;);</span>
<span class="nc" id="L2417">        boolean ret = false;</span>

        // Unload everything that is on the carrier but not listed to
        // be loaded at this stop.
<span class="nc" id="L2421">        Game game = getGame();</span>
<span class="nc bnc" id="L2422" title="All 2 branches missed.">        for (Goods goods : unit.getCompactGoodsList()) {</span>
<span class="nc" id="L2423">            GoodsType type = goods.getType();</span>
<span class="nc bnc" id="L2424" title="All 2 branches missed.">            if (goodsTypesToLoad.contains(type)) continue; // Keep this cargo.</span>
<span class="nc" id="L2425">            int present = goods.getAmount();</span>
<span class="nc bnc" id="L2426" title="All 2 branches missed.">            if (present &lt;= 0) {</span>
<span class="nc" id="L2427">                logger.warning(&quot;Unexpected empty goods unload &quot; + goods);</span>
<span class="nc" id="L2428">                continue;</span>
            }
<span class="nc" id="L2430">            int toUnload = present;</span>
<span class="nc" id="L2431">            int atStop = trl.getImportAmount(type, 0);</span>
<span class="nc" id="L2432">            int amount = toUnload;</span>
<span class="nc bnc" id="L2433" title="All 2 branches missed.">            if (amount &gt; atStop) {</span>
<span class="nc" id="L2434">                StringTemplate locName = ((Location)trl).getLocationLabel();</span>
<span class="nc" id="L2435">                int option = getClientOptions()</span>
<span class="nc" id="L2436">                    .getInteger(ClientOptions.UNLOAD_OVERFLOW_RESPONSE);</span>
<span class="nc bnc" id="L2437" title="All 4 branches missed.">                switch (option) {</span>
                case ClientOptions.UNLOAD_OVERFLOW_RESPONSE_ASK:
<span class="nc" id="L2439">                    StringTemplate template = StringTemplate</span>
<span class="nc" id="L2440">                        .template(&quot;traderoute.warehouseCapacity&quot;)</span>
<span class="nc" id="L2441">                        .addStringTemplate(&quot;%unit%&quot;,</span>
<span class="nc" id="L2442">                            unit.getLabel(Unit.UnitLabelType.NATIONAL))</span>
<span class="nc" id="L2443">                        .addStringTemplate(&quot;%colony%&quot;, locName)</span>
<span class="nc" id="L2444">                        .addAmount(&quot;%amount%&quot;, toUnload - atStop)</span>
<span class="nc" id="L2445">                        .addNamed(&quot;%goods%&quot;, goods);</span>
<span class="nc" id="L2446">                    if (!getGUI().confirm(unit.getTile(), template,</span>
<span class="nc bnc" id="L2447" title="All 2 branches missed.">                                     unit, &quot;yes&quot;, &quot;no&quot;)) {</span>
<span class="nc bnc" id="L2448" title="All 2 branches missed.">                        if (atStop == 0) continue;</span>
<span class="nc" id="L2449">                        amount = atStop;</span>
                    }
<span class="nc" id="L2451">                    break;</span>
                case ClientOptions.UNLOAD_OVERFLOW_RESPONSE_NEVER:
<span class="nc" id="L2453">                    amount = atStop;</span>
<span class="nc" id="L2454">                    break;</span>
                case ClientOptions.UNLOAD_OVERFLOW_RESPONSE_ALWAYS:
<span class="nc" id="L2456">                    break;</span>
                default:
<span class="nc" id="L2458">                    logger.warning(&quot;Illegal UNLOAD_OVERFLOW_RESPONSE: &quot;</span>
<span class="nc" id="L2459">                        + Integer.toString(option));</span>
                    break;
                }
            }
<span class="nc bnc" id="L2463" title="All 2 branches missed.">            if (amount == 0) {</span>
<span class="nc" id="L2464">                noUnload.addStringTemplate(goods.getLabel());</span>
<span class="nc" id="L2465">                continue;</span>
            }
            // Try to unload.
<span class="nc" id="L2468">            ret = askUnloadGoods(type, amount, unit);</span>
<span class="nc" id="L2469">            int retained = unit.getGoodsCount(type);</span>
<span class="nc bnc" id="L2470" title="All 4 branches missed.">            if (!ret || present == retained) {</span>
<span class="nc" id="L2471">                noUnload.addStringTemplate(StringTemplate</span>
<span class="nc" id="L2472">                    .template(&quot;tradeRoute.unloadStop.noUnload.fail&quot;)</span>
<span class="nc" id="L2473">                    .addStringTemplate(&quot;%goods%&quot;, goods.getLabel()));</span>
<span class="nc" id="L2474">                ret = false;</span>
<span class="nc" id="L2475">                break;</span>
            }
<span class="nc bnc" id="L2477" title="All 2 branches missed.">            if (present - retained != amount) {</span>
<span class="nc" id="L2478">                unloaded.addStringTemplate(StringTemplate</span>
<span class="nc" id="L2479">                    .template(&quot;tradeRoute.unloadStop.unload.fail&quot;)</span>
<span class="nc" id="L2480">                    .addNamed(&quot;%goodsType%&quot;, type)</span>
<span class="nc" id="L2481">                    .addAmount(&quot;%amount%&quot;, amount)</span>
<span class="nc" id="L2482">                    .addAmount(&quot;%more%&quot;, retained));</span>
<span class="nc bnc" id="L2483" title="All 2 branches missed.">            } else if (amount &gt; atStop) {</span>
<span class="nc bnc" id="L2484" title="All 2 branches missed.">                if (retained &gt; 0) {</span>
<span class="nc" id="L2485">                    unloaded.addStringTemplate(StringTemplate</span>
<span class="nc" id="L2486">                        .template(&quot;tradeRoute.unloadStop.unload.keep&quot;)</span>
<span class="nc" id="L2487">                        .addNamed(&quot;%goodsType%&quot;, type)</span>
<span class="nc" id="L2488">                        .addAmount(&quot;%amount%&quot;, atStop)</span>
<span class="nc" id="L2489">                        .addAmount(&quot;%more%&quot;, retained));</span>
<span class="nc" id="L2490">                } else {</span>
<span class="nc" id="L2491">                    unloaded.addStringTemplate(StringTemplate</span>
<span class="nc" id="L2492">                        .template(&quot;tradeRoute.unloadStop.unload.overflow&quot;)</span>
<span class="nc" id="L2493">                        .addNamed(&quot;%goodsType%&quot;, type)</span>
<span class="nc" id="L2494">                        .addAmount(&quot;%amount%&quot;, atStop)</span>
<span class="nc" id="L2495">                        .addAmount(&quot;%more%&quot;, amount - atStop));</span>
                }
<span class="nc" id="L2497">            } else {</span>
<span class="nc" id="L2498">                unloaded.addStringTemplate(goods.getLabel());</span>
            }
        }
<span class="nc bnc" id="L2501" title="All 2 branches missed.">        if (!unloaded.isEmpty()) {</span>
<span class="nc" id="L2502">            lb.add(&quot;\n  &quot;, Messages.message(StringTemplate</span>
<span class="nc" id="L2503">                    .template(&quot;tradeRoute.unloadStop.unload&quot;)</span>
<span class="nc" id="L2504">                        .addStringTemplate(&quot;%goodsList%&quot;, unloaded)));</span>
        }
<span class="nc bnc" id="L2506" title="All 2 branches missed.">        if (!noUnload.isEmpty()) {</span>
<span class="nc" id="L2507">            lb.add(&quot;\n  &quot;, Messages.message(StringTemplate</span>
<span class="nc" id="L2508">                    .template(&quot;tradeRoute.unloadStop.noUnload&quot;)</span>
<span class="nc" id="L2509">                        .addStringTemplate(&quot;%goodsList%&quot;, noUnload)));</span>
        }

<span class="nc" id="L2512">        return ret;</span>
    }

    /**
     * Gets a message describing a goods unloading.
     *
     * Normally just state that a certain amount of goods was
     * unloaded.  Make special mention if the actual unloaded amount
     * was short (unloaded &amp;lt; amount), or an overflow is happening
     * (amount &amp;gt; atStop) in which case distinguish dumping (amount
     * == toUnload) from retaining on board).
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is unloading.
     * @param type The &lt;code&gt;GoodsType&lt;/code&gt; the type of goods being unloaded.
     * @param amount The amount of goods requested to be unloaded.
     * @param present The amount of goods originally on the unit.
     * @param atStop The amount of goods space available at the stop.
     * @param toUnload The amount of goods that should be unloaded according
     *     to the trade route orders.
     * @return A summary of the unload.
     */
    private String getUnloadGoodsMessage(Unit unit, GoodsType type,
                                         int amount, int present,
                                         int atStop, int toUnload) {
<span class="nc" id="L2536">        String key = null;</span>
<span class="nc" id="L2537">        int onBoard = unit.getGoodsCount(type);</span>
<span class="nc" id="L2538">        int unloaded = present - onBoard;</span>
<span class="nc" id="L2539">        int more = 0;</span>

<span class="nc bnc" id="L2541" title="All 2 branches missed.">        if (unloaded &lt; amount) {</span>
            // Tried to unload %amount% %goods%, but %more% was unloaded
<span class="nc" id="L2543">            key = &quot;tradeRoute.unloadStopFail&quot;;</span>
<span class="nc" id="L2544">            more = unloaded;</span>
<span class="nc bnc" id="L2545" title="All 2 branches missed.">        } else if (amount &gt; atStop) {</span>
<span class="nc bnc" id="L2546" title="All 2 branches missed.">            if (amount == toUnload) {</span>
                // Unloaded %amount% %goods% and dumped %more%.
<span class="nc" id="L2548">                key = &quot;tradeRoute.unloadStopImport&quot;;</span>
<span class="nc" id="L2549">                more = toUnload - atStop;</span>
<span class="nc" id="L2550">            } else {</span>
                // Unloaded %amount% %goods% with %more% more retained...
<span class="nc bnc" id="L2552" title="All 2 branches missed.">                key = (amount == 0) ? &quot;tradeRoute.unloadStopNoExport&quot;</span>
<span class="nc" id="L2553">                    : &quot;tradeRoute.unloadStopExport&quot;;</span>
<span class="nc" id="L2554">                more = onBoard;</span>
            }
<span class="nc" id="L2556">        } else {</span>
            // Unloaded %amount% %goods%
<span class="nc" id="L2558">            key = &quot;tradeRoute.unloadStop&quot;;</span>
        }

<span class="nc" id="L2561">        return Messages.message(StringTemplate.template(key)</span>
<span class="nc" id="L2562">            .addAmount(&quot;%amount%&quot;, amount)</span>
<span class="nc" id="L2563">            .addAmount(&quot;%more%&quot;, more)</span>
<span class="nc" id="L2564">            .addNamed(&quot;%goods%&quot;, type));</span>
    }


    // Routines from here on are mostly user commands.  That is they
    // are called directly as a result of keyboard, menu, mouse or
    // panel/dialog actions.  Some though are called indirectly after
    // a call to the server routes information back through the
    // InGameInputHandler.  They should all be annotated as such to
    // confirm where they can come from.
    //
    // User command all return a success/failure indication, except if
    // the game is stopped.  IGIH-initiated routines do not need to.
    //
    // Successfully executed commands should update the GUI.

    /**
     * Abandon a colony with no units.
     *
     * Called from ColonyPanel.closeColonyPanel
     *
     * @param colony The &lt;code&gt;Colony&lt;/code&gt; to be abandoned.
     * @return True if the colony was abandoned.
     */
    public boolean abandonColony(Colony colony) {
<span class="nc" id="L2589">        final Player player = getMyPlayer();</span>
<span class="nc bnc" id="L2590" title="All 4 branches missed.">        if (!requireOurTurn() || colony == null</span>
<span class="nc bnc" id="L2591" title="All 4 branches missed.">            || !player.owns(colony) || colony.getUnitCount() &gt; 0)</span>
<span class="nc" id="L2592">            return false;</span>

        // Proceed to abandon
<span class="nc" id="L2595">        final Tile tile = colony.getTile();</span>
<span class="nc bnc" id="L2596" title="All 2 branches missed.">        boolean ret = askServer().abandonColony(colony)</span>
<span class="nc bnc" id="L2597" title="All 2 branches missed.">            &amp;&amp; !tile.hasSettlement();</span>
<span class="nc bnc" id="L2598" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc" id="L2599">            player.invalidateCanSeeTiles();</span>
<span class="nc" id="L2600">            updateGUI(null);</span>
        }
<span class="nc" id="L2602">        return ret;</span>
    }

    /**
     * Animate an attack.
     *
     * Called from IGIH.animateAttack.
     *
     * @param attacker The attacking &lt;code&gt;Unit&lt;/code&gt;.
     * @param defender The defending &lt;code&gt;Unit&lt;/code&gt;.
     * @param attackerTile The &lt;code&gt;Tile&lt;/code&gt; the attack originates from.
     * @param defenderTile The &lt;code&gt;Tile&lt;/code&gt; the defence takes place on.
     * @param success True if the attack succeeds.
     */
    public void animateAttack(Unit attacker, Unit defender,
                              Tile attackerTile, Tile defenderTile,
                              boolean success) {
        // Note: we used to focus the map on the unit even when
        // animation is off as long as the center-active-unit option
        // was set.  However IR#115 requested that if animation is off
        // that we display nothing so as to speed up the other player
        // moves as much as possible.
<span class="nc bnc" id="L2624" title="All 2 branches missed.">        if (getFreeColClient().getAnimationSpeed(attacker.getOwner()) &gt; 0) {</span>
<span class="nc" id="L2625">            getGUI().animateUnitAttack(attacker, defender,</span>
<span class="nc" id="L2626">                                  attackerTile, defenderTile, success);</span>
        }
<span class="nc" id="L2628">        getGUI().refresh();</span>
<span class="nc" id="L2629">    }</span>

    /**
     * Animate a move.
     *
     * Called from IGIH.animateMove.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that moves.
     * @param oldTile The &lt;code&gt;Tile&lt;/code&gt; the move begins at.
     * @param newTile The &lt;code&gt;Tile&lt;/code&gt; the move ends at.
     */
    public void animateMove(Unit unit, Tile oldTile, Tile newTile) {
        // Note: we used to focus the map on the unit even when
        // animation is off as long as the center-active-unit option
        // was set.  However IR#115 requested that if animation is off
        // that we display nothing so as to speed up the other player
        // moves as much as possible.
<span class="nc bnc" id="L2646" title="All 2 branches missed.">        if (getFreeColClient().getAnimationSpeed(unit.getOwner()) &gt; 0) {</span>
<span class="nc" id="L2647">            getGUI().animateUnitMove(unit, oldTile, newTile);</span>
<span class="nc bnc" id="L2648" title="All 2 branches missed.">        } else if (getMyPlayer().owns(unit)) {</span>
<span class="nc" id="L2649">            getGUI().requireFocus(newTile);</span>
        }
<span class="nc" id="L2651">        getGUI().refresh();</span>
<span class="nc" id="L2652">    }</span>

    /**
     * Assigns a student to a teacher.
     *
     * Called from UnitLabel
     *
     * @param student The student &lt;code&gt;Unit&lt;/code&gt;.
     * @param teacher The teacher &lt;code&gt;Unit&lt;/code&gt;.
     * @return True if the student was assigned.
     */
    public boolean assignTeacher(Unit student, Unit teacher) {
<span class="nc" id="L2664">        final Player player = getMyPlayer();</span>
<span class="nc bnc" id="L2665" title="All 2 branches missed.">        if (!requireOurTurn()</span>
<span class="nc bnc" id="L2666" title="All 2 branches missed.">            || student == null</span>
<span class="nc bnc" id="L2667" title="All 2 branches missed.">            || !player.owns(student)</span>
<span class="nc bnc" id="L2668" title="All 2 branches missed.">            || student.getColony() == null</span>
<span class="nc bnc" id="L2669" title="All 2 branches missed.">            || !student.isInColony()</span>
<span class="nc bnc" id="L2670" title="All 2 branches missed.">            || teacher == null</span>
<span class="nc bnc" id="L2671" title="All 2 branches missed.">            || !player.owns(teacher)</span>
<span class="nc bnc" id="L2672" title="All 2 branches missed.">            || !student.canBeStudent(teacher)</span>
<span class="nc bnc" id="L2673" title="All 2 branches missed.">            || teacher.getColony() == null</span>
<span class="nc bnc" id="L2674" title="All 2 branches missed.">            || student.getColony() != teacher.getColony()</span>
<span class="nc bnc" id="L2675" title="All 2 branches missed.">            || !teacher.getColony().canTrain(teacher))</span>
<span class="nc" id="L2676">            return false;</span>

<span class="nc" id="L2678">        UnitWas unitWas = new UnitWas(student);</span>
<span class="nc bnc" id="L2679" title="All 2 branches missed.">        boolean ret = askServer().assignTeacher(student, teacher)</span>
<span class="nc bnc" id="L2680" title="All 2 branches missed.">            &amp;&amp; student.getTeacher() == teacher;</span>
<span class="nc bnc" id="L2681" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc" id="L2682">            unitWas.fireChanges();</span>
<span class="nc" id="L2683">            updateGUI(null);</span>
        }
<span class="nc" id="L2685">        return ret;</span>
    }

    /**
     * Assigns a trade route to a unit.
     *
     * Called from EuropePanel.DestinationPanel, TradeRoutePanel(),
     * TradeRoutePanel.newRoute
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to assign a trade route to.
     * @param tradeRoute The &lt;code&gt;TradeRoute&lt;/code&gt; to assign.
     * @return True if the route was successfully assigned.
     */
    public boolean assignTradeRoute(Unit unit, TradeRoute tradeRoute) {
<span class="nc bnc" id="L2699" title="All 2 branches missed.">        if (unit == null) return false;</span>

<span class="nc" id="L2701">        UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc" id="L2702">        boolean ret = askAssignTradeRoute(unit, tradeRoute);</span>
<span class="nc bnc" id="L2703" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc" id="L2704">            unitWas.fireChanges();</span>
<span class="nc" id="L2705">            updateGUI(null);</span>
        }
<span class="nc" id="L2707">        return ret;</span>
    }

    /**
     * Boards a specified unit onto a carrier.
     * The carrier must be at the same location as the boarding unit.
     *
     * Called from CargoPanel, TilePopup.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; which is to board the carrier.
     * @param carrier The carrier to board.
     * @return True if the unit boards the carrier.
     */
    public boolean boardShip(Unit unit, Unit carrier) {
<span class="nc bnc" id="L2721" title="All 6 branches missed.">        if (!requireOurTurn() || unit == null || unit.isCarrier()</span>
<span class="nc bnc" id="L2722" title="All 4 branches missed.">            || carrier == null || !carrier.canCarryUnits()</span>
<span class="nc bnc" id="L2723" title="All 2 branches missed.">            || !unit.isAtLocation(carrier.getLocation())) return false;</span>

<span class="nc" id="L2725">        boolean ret = askEmbark(unit, carrier);</span>
<span class="nc bnc" id="L2726" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc" id="L2727">            updateGUI(null);</span>
        }
<span class="nc" id="L2729">        return ret;</span>
    }

    /**
     * Use the active unit to build a colony.
     *
     * Called from BuildColonyAction.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to build the colony.
     * @return True if a colony was built.
     */
    public boolean buildColony(Unit unit) {
<span class="nc bnc" id="L2741" title="All 4 branches missed.">        if (!requireOurTurn() || unit == null) return false;</span>

        // Check unit, which must be on the map and able to build.
<span class="nc bnc" id="L2744" title="All 2 branches missed.">        if (unit == null) return false;</span>
<span class="nc" id="L2745">        final Tile tile = unit.getTile();</span>
<span class="nc bnc" id="L2746" title="All 2 branches missed.">        if (tile == null) return false;</span>
<span class="nc bnc" id="L2747" title="All 2 branches missed.">        if (!unit.canBuildColony()) {</span>
<span class="nc" id="L2748">            getGUI().showInformationMessage(unit, StringTemplate</span>
<span class="nc" id="L2749">                .template(&quot;buildColony.badUnit&quot;)</span>
<span class="nc" id="L2750">                .addName(&quot;%unit%&quot;, unit.getName()));</span>
<span class="nc" id="L2751">            return false;</span>
        }

        // Join existing colony if present
<span class="nc bnc" id="L2755" title="All 4 branches missed.">        if (joinColony(unit) || tile.getColony() != null) return false;</span>

        // Check for other impediments.
<span class="nc" id="L2758">        final Player player = getMyPlayer();</span>
<span class="nc" id="L2759">        NoClaimReason reason = player.canClaimToFoundSettlementReason(tile);</span>
<span class="nc bnc" id="L2760" title="All 2 branches missed.">        switch (reason) {</span>
        case NONE:
        case NATIVES: // Tile can still be claimed
<span class="nc" id="L2763">            break;</span>
        default:
<span class="nc" id="L2765">            getGUI().showInformationMessage(reason.getDescriptionKey());</span>
<span class="nc" id="L2766">            return false;</span>
        }

        // Show the warnings if applicable.
<span class="nc bnc" id="L2770" title="All 2 branches missed.">        if (getClientOptions().getBoolean(ClientOptions.SHOW_COLONY_WARNINGS)) {</span>
<span class="nc" id="L2771">            StringTemplate warnings = tile.getBuildColonyWarnings(unit);</span>
<span class="nc bnc" id="L2772" title="All 2 branches missed.">            if (!warnings.getReplacements().isEmpty()</span>
<span class="nc" id="L2773">                &amp;&amp; !getGUI().confirm(tile, warnings,</span>
<span class="nc bnc" id="L2774" title="All 2 branches missed.">                                unit, &quot;buildColony.yes&quot;, &quot;buildColony.no&quot;)) {</span>
<span class="nc" id="L2775">                return false;</span>
            }
        }

        // Get and check the name.
<span class="nc" id="L2780">        String name = getGUI().getNewColonyName(player, tile);</span>
<span class="nc bnc" id="L2781" title="All 2 branches missed.">        if (name == null) return false;</span>

        // Claim tile from other owners before founding a settlement.
        // Only native owners that we can steal, buy from, or use a
        // bonus center tile exception should be possible by this point.
<span class="nc" id="L2786">        UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc" id="L2787">        boolean ret = player.owns(tile);</span>
<span class="nc bnc" id="L2788" title="All 2 branches missed.">        if (!ret) {</span>
<span class="nc" id="L2789">            ret = askClaimTile(player, tile, unit, player.getLandPrice(tile));</span>
<span class="nc bnc" id="L2790" title="All 2 branches missed.">            if (!ret) NameCache.putSettlementName(player, name);</span>
        }            
<span class="nc bnc" id="L2792" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc bnc" id="L2793" title="All 2 branches missed.">            ret = askServer().buildColony(name, unit)</span>
<span class="nc bnc" id="L2794" title="All 2 branches missed.">                &amp;&amp; tile.hasSettlement();</span>
<span class="nc bnc" id="L2795" title="All 2 branches missed.">            if (ret) {</span>
<span class="nc" id="L2796">                sound(&quot;sound.event.buildingComplete&quot;);</span>
<span class="nc" id="L2797">                player.invalidateCanSeeTiles();</span>
<span class="nc" id="L2798">                unitWas.fireChanges();</span>
                // Check units present for treasure cash-in as they are now
                // at a colony.
<span class="nc bnc" id="L2801" title="All 2 branches missed.">                for (Unit u : tile.getUnitList()) checkCashInTreasureTrain(u);</span>
<span class="nc" id="L2802">                colonyPanel((Colony)tile.getSettlement(), unit);</span>
            }
<span class="nc" id="L2804">            updateGUI(null);</span>
        }
<span class="nc" id="L2806">        return ret;</span>
    }

    /**
     * Buy goods in Europe.
     * The amount of goods is adjusted to the space in the carrier.
     *
     * Called from CargoPanel, TilePopup, loadCargo()
     *
     * @param type The type of goods to buy.
     * @param amount The amount of goods to buy.
     * @param carrier The &lt;code&gt;Unit&lt;/code&gt; acting as carrier.
     * @return True if the purchase succeeds.
     */
    public boolean buyGoods(GoodsType type, int amount, Unit carrier) {
<span class="nc bnc" id="L2821" title="All 6 branches missed.">        if (!requireOurTurn() || type == null || amount &lt;= 0</span>
<span class="nc bnc" id="L2822" title="All 2 branches missed.">            || carrier == null</span>
<span class="nc bnc" id="L2823" title="All 2 branches missed.">            || !carrier.isInEurope()</span>
<span class="nc bnc" id="L2824" title="All 2 branches missed.">            || !getMyPlayer().owns(carrier)) return false;</span>

<span class="nc" id="L2826">        final Europe europe = carrier.getOwner().getEurope();</span>
<span class="nc" id="L2827">        EuropeWas europeWas = new EuropeWas(europe);</span>
<span class="nc" id="L2828">        UnitWas unitWas = new UnitWas(carrier);</span>
<span class="nc" id="L2829">        boolean ret = askLoadGoods(europe, type, amount, carrier);</span>
<span class="nc bnc" id="L2830" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc" id="L2831">            sound(&quot;sound.event.loadCargo&quot;);</span>
<span class="nc" id="L2832">            europeWas.fireChanges();</span>
<span class="nc" id="L2833">            unitWas.fireChanges();</span>
<span class="nc" id="L2834">            updateGUI(null);</span>
        }
<span class="nc" id="L2836">        return ret;</span>
    }

    /**
     * Chat with another player.
     *
     * Called from IGIH.chat.
     *
     * @param player The &lt;code&gt;Player&lt;/code&gt; to chat with.
     * @param message What to say.
     * @param pri If true, the message is private.
     */
    public void chat(Player player, String message, boolean pri) {
<span class="nc" id="L2849">        getGUI().displayChatMessage(player, message, pri);</span>
<span class="nc" id="L2850">    }</span>

    /**
     * Changes the state of this &lt;code&gt;Unit&lt;/code&gt;.
     *
     * Called from FortifyAction, SentryAction, TilePopup, UnitLabel
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt;
     * @param state The state of the unit.
     * @return True if the state was changed.
     */
    public boolean changeState(Unit unit, UnitState state) {
<span class="nc bnc" id="L2862" title="All 4 branches missed.">        if (!requireOurTurn() || unit == null) return false;</span>
<span class="nc bnc" id="L2863" title="All 2 branches missed.">        if (unit.getState() == state) return true;</span>
<span class="nc bnc" id="L2864" title="All 2 branches missed.">        if (!unit.checkSetState(state)) return false;</span>

        // Check if this is a hostile fortification, and give the player
        // a chance to confirm.
<span class="nc" id="L2868">        final Player player = getMyPlayer();</span>
<span class="nc bnc" id="L2869" title="All 4 branches missed.">        if (state == UnitState.FORTIFYING &amp;&amp; unit.isOffensiveUnit()</span>
<span class="nc bnc" id="L2870" title="All 2 branches missed.">            &amp;&amp; !unit.hasAbility(Ability.PIRACY)) {</span>
<span class="nc" id="L2871">            Tile tile = unit.getTile();</span>
<span class="nc bnc" id="L2872" title="All 4 branches missed.">            if (tile != null &amp;&amp; tile.getOwningSettlement() != null) {</span>
<span class="nc" id="L2873">                Player enemy = tile.getOwningSettlement().getOwner();</span>
<span class="nc bnc" id="L2874" title="All 2 branches missed.">                if (player != enemy</span>
<span class="nc bnc" id="L2875" title="All 2 branches missed.">                    &amp;&amp; player.getStance(enemy) != Stance.ALLIANCE</span>
<span class="nc bnc" id="L2876" title="All 2 branches missed.">                    &amp;&amp; !getGUI().confirmHostileAction(unit, tile))</span>
<span class="nc" id="L2877">                    return false; // Aborted</span>
            }
        }

<span class="nc" id="L2881">        UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc bnc" id="L2882" title="All 2 branches missed.">        boolean ret = askServer().changeState(unit, state)</span>
<span class="nc bnc" id="L2883" title="All 2 branches missed.">            &amp;&amp; unit.getState() == state;</span>
<span class="nc bnc" id="L2884" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc" id="L2885">            unitWas.fireChanges();</span>
<span class="nc" id="L2886">            updateGUI(null);</span>
        }
<span class="nc" id="L2888">        return ret;</span>
    }

    /**
     * Changes the work type of this &lt;code&gt;Unit&lt;/code&gt;.
     *
     * Called from ImprovementAction.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt;
     * @param improvementType a &lt;code&gt;TileImprovementType&lt;/code&gt; value
     * @return True if the improvement was changed.
     */
    public boolean changeWorkImprovementType(Unit unit,
        TileImprovementType improvementType) {
<span class="nc bnc" id="L2902" title="All 6 branches missed.">        if (!requireOurTurn() || unit == null || improvementType == null</span>
<span class="nc bnc" id="L2903" title="All 2 branches missed.">            || !unit.hasTile()</span>
<span class="nc bnc" id="L2904" title="All 2 branches missed.">            || !unit.checkSetState(UnitState.IMPROVING)</span>
<span class="nc bnc" id="L2905" title="All 2 branches missed.">            || improvementType.isNatural()) return false;</span>

        // May need to claim the tile first
<span class="nc" id="L2908">        final Player player = getMyPlayer();</span>
<span class="nc" id="L2909">        final Tile tile = unit.getTile();</span>
<span class="nc" id="L2910">        UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc bnc" id="L2911" title="All 2 branches missed.">        boolean ret = player.owns(tile)</span>
<span class="nc bnc" id="L2912" title="All 2 branches missed.">            || askClaimTile(player, tile, unit, player.getLandPrice(tile));</span>
<span class="nc bnc" id="L2913" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc" id="L2914">            ret = askServer()</span>
<span class="nc bnc" id="L2915" title="All 2 branches missed.">                .changeWorkImprovementType(unit, improvementType)</span>
<span class="nc bnc" id="L2916" title="All 2 branches missed.">                &amp;&amp; unit.getWorkImprovement() != null</span>
<span class="nc bnc" id="L2917" title="All 2 branches missed.">                &amp;&amp; unit.getWorkImprovement().getType() == improvementType;</span>
<span class="nc bnc" id="L2918" title="All 2 branches missed.">            if (ret) {</span>
<span class="nc" id="L2919">                unitWas.fireChanges();</span>
            }
<span class="nc" id="L2921">            updateGUI(null);</span>
        }
<span class="nc" id="L2923">        return ret;</span>
    }

    /**
     * Changes the work type of this &lt;code&gt;Unit&lt;/code&gt;.
     *
     * Called from ColonyPanel.tryWork, UnitLabel
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt;
     * @param workType The new &lt;code&gt;GoodsType&lt;/code&gt; to produce.
     * @return True if the work type was changed.
     */
    public boolean changeWorkType(Unit unit, GoodsType workType) {
<span class="nc bnc" id="L2936" title="All 4 branches missed.">        if (!requireOurTurn() || unit == null) return false;</span>

<span class="nc" id="L2938">        UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc bnc" id="L2939" title="All 2 branches missed.">        boolean ret = askServer().changeWorkType(unit, workType)</span>
<span class="nc bnc" id="L2940" title="All 2 branches missed.">            &amp;&amp; unit.getWorkType() == workType;</span>
<span class="nc bnc" id="L2941" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc" id="L2942">            unitWas.fireChanges();</span>
<span class="nc" id="L2943">            updateGUI(null);</span>
        }
<span class="nc" id="L2945">        return ret;</span>
    }

    /**
     * Check if a unit is a treasure train, and if it should be cashed in.
     * Transfers the gold carried by this unit to the {@link Player owner}.
     *
     * Called from TilePopup
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to be checked.
     * @return True if the unit was cashed in (and disposed).
     */
    public boolean checkCashInTreasureTrain(Unit unit) {
<span class="nc bnc" id="L2958" title="All 4 branches missed.">        if (!requireOurTurn() || unit == null</span>
<span class="nc bnc" id="L2959" title="All 4 branches missed.">            || !unit.canCarryTreasure() || !unit.canCashInTreasureTrain())</span>
<span class="nc" id="L2960">            return false; // Fail quickly if just not a candidate.</span>

<span class="nc" id="L2962">        final Tile tile = unit.getTile();</span>
<span class="nc" id="L2963">        final Europe europe = unit.getOwner().getEurope();</span>
<span class="nc bnc" id="L2964" title="All 4 branches missed.">        if (europe == null || unit.isInEurope()) {</span>
            ;// No need to check for transport.
<span class="nc" id="L2966">        } else {</span>
<span class="nc" id="L2967">            int fee = unit.getTransportFee();</span>
            StringTemplate template;
<span class="nc bnc" id="L2969" title="All 2 branches missed.">            if (fee == 0) {</span>
<span class="nc" id="L2970">                template = StringTemplate.template(&quot;cashInTreasureTrain.free&quot;);</span>
<span class="nc" id="L2971">            } else {</span>
<span class="nc" id="L2972">                int percent = getSpecification()</span>
<span class="nc" id="L2973">                    .getInteger(GameOptions.TREASURE_TRANSPORT_FEE);</span>
<span class="nc" id="L2974">                template = StringTemplate.template(&quot;cashInTreasureTrain.pay&quot;)</span>
<span class="nc" id="L2975">                    .addAmount(&quot;%fee%&quot;, percent);</span>
            }
<span class="nc" id="L2977">            if (!getGUI().confirm(unit.getTile(), template, unit,</span>
<span class="nc bnc" id="L2978" title="All 2 branches missed.">                             &quot;accept&quot;, &quot;reject&quot;)) return false;</span>
        }

<span class="nc" id="L2981">        UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc bnc" id="L2982" title="All 2 branches missed.">        boolean ret = askServer().cashInTreasureTrain(unit)</span>
<span class="nc bnc" id="L2983" title="All 2 branches missed.">            &amp;&amp; unit.isDisposed();</span>
<span class="nc bnc" id="L2984" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc" id="L2985">            sound(&quot;sound.event.cashInTreasureTrain&quot;);</span>
<span class="nc" id="L2986">            unitWas.fireChanges();</span>
<span class="nc" id="L2987">            updateGUI(tile);</span>
        }
<span class="nc" id="L2989">        return ret;</span>
    }

    /**
     * Choose a founding father from an offered list.
     *
     * Called from GUI.showChooseFoundingFatherDialog
     *
     * @param ffs A list of &lt;code&gt;FoundingFather&lt;/code&gt;s to choose from.
     * @param ff The chosen &lt;code&gt;FoundingFather&lt;/code&gt; (may be null).
     * @return True if a father was chosen.
     */
    public boolean chooseFoundingFather(List&lt;FoundingFather&gt; ffs,
                                        FoundingFather ff) {
<span class="nc bnc" id="L3003" title="All 2 branches missed.">        if (ffs == null) return false;</span>

<span class="nc" id="L3005">        final Player player = getMyPlayer();</span>
<span class="nc" id="L3006">        player.setCurrentFather(ff);</span>
<span class="nc" id="L3007">        return askServer().chooseFoundingFather(ffs, ff);</span>
    }

    /**
     * Choose a founding father from an offered list.
     *
     * Called from IGIH.chooseFoundingFather.
     *
     * @param ffs A list of &lt;code&gt;FoundingFather&lt;/code&gt;s to choose from.
     */
    public void chooseFoundingFather(List&lt;FoundingFather&gt; ffs) {
<span class="nc bnc" id="L3018" title="All 2 branches missed.">        if (ffs == null) return;</span>
<span class="nc" id="L3019">        getGUI().showChooseFoundingFatherDialog(ffs,</span>
<span class="nc" id="L3020">            (FoundingFather ff) -&gt; chooseFoundingFather(ffs, ff));</span>
<span class="nc" id="L3021">    }</span>

    /**
     * Claim a tile.
     *
     * Called from ColonyPanel.ASingleTilePanel, UnitLabel and work()
     *
     * @param tile The &lt;code&gt;Tile&lt;/code&gt; to claim.
     * @param claimant The &lt;code&gt;Unit&lt;/code&gt; or &lt;code&gt;Colony&lt;/code&gt; claiming.
     * @return True if the claim succeeded.
     */
    public boolean claimTile(Tile tile, FreeColGameObject claimant) {
<span class="nc bnc" id="L3033" title="All 4 branches missed.">        if (!requireOurTurn() || tile == null</span>
<span class="nc bnc" id="L3034" title="All 2 branches missed.">            || claimant == null) return false;</span>

<span class="nc" id="L3036">        final Player player = getMyPlayer();</span>
<span class="nc bnc" id="L3037" title="All 2 branches missed.">        final int price = ((claimant instanceof Settlement)</span>
<span class="nc bnc" id="L3038" title="All 2 branches missed.">                ? player.canClaimForSettlement(tile)</span>
<span class="nc bnc" id="L3039" title="All 2 branches missed.">                : player.canClaimForImprovement(tile))</span>
<span class="nc" id="L3040">            ? 0</span>
<span class="nc" id="L3041">            : player.getLandPrice(tile);</span>
<span class="nc bnc" id="L3042" title="All 2 branches missed.">        UnitWas unitWas = (claimant instanceof Unit)</span>
<span class="nc" id="L3043">            ? new UnitWas((Unit)claimant) : null;</span>
<span class="nc" id="L3044">        boolean ret = askClaimTile(player, tile, claimant, price);</span>
<span class="nc bnc" id="L3045" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc bnc" id="L3046" title="All 2 branches missed.">            if (unitWas != null) unitWas.fireChanges();</span>
<span class="nc" id="L3047">            updateGUI(null);</span>
        }
<span class="nc" id="L3049">        return ret;</span>
    }

    /**
     * Clears the goto orders of the given unit by setting its destination
     * to null.
     *
     * Called from CanvasMouseListener
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to clear the destination for.
     * @return True if the unit has no destination.
     */
    public boolean clearGotoOrders(Unit unit) {
<span class="nc bnc" id="L3062" title="All 4 branches missed.">        if (!requireOurTurn() || unit == null) return false;</span>

<span class="nc" id="L3064">        UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc" id="L3065">        boolean ret = askClearGotoOrders(unit);</span>
<span class="nc bnc" id="L3066" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc" id="L3067">            unitWas.fireChanges();</span>
<span class="nc" id="L3068">            updateGUI(null);</span>
        }
<span class="nc" id="L3070">        return ret;</span>
    }

    /**
     * Clears the orders of the given unit.
     * Make the unit active and set a null destination and trade route.
     *
     * Called from ClearOrdersAction, TilePopup, TradeRoutePanel, UnitLabel
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to clear the orders of
     * @return boolean &lt;b&gt;true&lt;/b&gt; if the orders were cleared
     */
    public boolean clearOrders(Unit unit) {
<span class="nc bnc" id="L3083" title="All 4 branches missed.">        if (!requireOurTurn() || unit == null) return false;</span>

<span class="nc bnc" id="L3085" title="All 2 branches missed.">        if (unit.getState() == UnitState.IMPROVING</span>
<span class="nc" id="L3086">            &amp;&amp; !getGUI().confirm(unit.getTile(), StringTemplate</span>
<span class="nc" id="L3087">                .template(&quot;clearOrders.text&quot;)</span>
<span class="nc" id="L3088">                .addAmount(&quot;%turns%&quot;, unit.getWorkTurnsLeft()),</span>
<span class="nc bnc" id="L3089" title="All 2 branches missed.">                unit, &quot;ok&quot;, &quot;cancel&quot;)) {</span>
<span class="nc" id="L3090">            return false;</span>
        }

<span class="nc" id="L3093">        UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc bnc" id="L3094" title="All 2 branches missed.">        boolean ret = askClearGotoOrders(unit)</span>
<span class="nc bnc" id="L3095" title="All 2 branches missed.">            &amp;&amp; (unit.getState() == UnitState.ACTIVE</span>
<span class="nc bnc" id="L3096" title="All 2 branches missed.">                || askServer().changeState(unit, UnitState.ACTIVE));</span>
<span class="nc bnc" id="L3097" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc" id="L3098">            unitWas.fireChanges();</span>
<span class="nc" id="L3099">            updateGUI(null);</span>
        }
<span class="nc" id="L3101">        return ret;</span>
    }

    /**
     * Clear the speciality of a Unit, making it a Free Colonist.
     *
     * Called from UnitLabel
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to clear the speciality of.
     * @return True if the speciality was cleared.
     */
    public boolean clearSpeciality(Unit unit) {
<span class="nc bnc" id="L3113" title="All 4 branches missed.">        if (!requireOurTurn() || unit == null) return false;</span>

<span class="nc" id="L3115">        UnitType oldType = unit.getType();</span>
<span class="nc" id="L3116">        UnitType newType = oldType.getTargetType(ChangeType.CLEAR_SKILL,</span>
<span class="nc" id="L3117">                                                 unit.getOwner());</span>
<span class="nc bnc" id="L3118" title="All 2 branches missed.">        if (newType == null) {</span>
<span class="nc" id="L3119">            getGUI().showInformationMessage(unit, StringTemplate</span>
<span class="nc" id="L3120">                .template(&quot;clearSpeciality.impossible&quot;)</span>
<span class="nc" id="L3121">                .addStringTemplate(&quot;%unit%&quot;,</span>
<span class="nc" id="L3122">                    unit.getLabel(Unit.UnitLabelType.NATIONAL)));</span>
<span class="nc" id="L3123">            return false;</span>
        }

<span class="nc bnc" id="L3126" title="All 2 branches missed.">        final Tile tile = (getGUI().isShowingSubPanel()) ? null : unit.getTile();</span>
<span class="nc" id="L3127">        if (!getGUI().confirm(tile, StringTemplate</span>
<span class="nc" id="L3128">                .template(&quot;clearSpeciality.areYouSure&quot;)</span>
<span class="nc" id="L3129">                .addStringTemplate(&quot;%oldUnit%&quot;,</span>
<span class="nc" id="L3130">                    unit.getLabel(Unit.UnitLabelType.NATIONAL))</span>
<span class="nc" id="L3131">                .addNamed(&quot;%unit%&quot;, newType),</span>
<span class="nc bnc" id="L3132" title="All 2 branches missed.">                unit, &quot;ok&quot;, &quot;cancel&quot;)) {</span>
<span class="nc" id="L3133">            return false;</span>
        }

        // Try to clear.
        // Note that this routine is only called out of UnitLabel,
        // where the unit icon is always updated anyway.
<span class="nc" id="L3139">        UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc bnc" id="L3140" title="All 2 branches missed.">        boolean ret = askServer().clearSpeciality(unit)</span>
<span class="nc bnc" id="L3141" title="All 2 branches missed.">            &amp;&amp; unit.getType() == newType;</span>
<span class="nc bnc" id="L3142" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc" id="L3143">            unitWas.fireChanges();</span>
<span class="nc" id="L3144">            updateGUI(null);</span>
        }
<span class="nc" id="L3146">        return ret;</span>
    }

    /**
     * Close any open GUI menus.
     *
     * Called from IGIH.closeMenus.
     */
    public void closeMenus() {
<span class="nc" id="L3155">        getGUI().closeMenus();</span>
<span class="nc" id="L3156">    }</span>

    /**
     * Declares independence for the home country.
     *
     * Called from DeclareIndependenceAction
     *
     * @return True if independence was declared.
     */
    public boolean declareIndependence() {
<span class="nc bnc" id="L3166" title="All 2 branches missed.">        if (!requireOurTurn()) return false;</span>

<span class="nc" id="L3168">        final Player player = getMyPlayer();</span>
<span class="nc bnc" id="L3169" title="All 2 branches missed.">        if (player.getNewLandName() == null) {</span>
<span class="nc" id="L3170">            return false; // Can only happen in debug mode.</span>
        }

        // Check for adequate support.
<span class="nc" id="L3174">        StringTemplate declare = player.checkDeclareIndependence();</span>
<span class="nc bnc" id="L3175" title="All 2 branches missed.">        if (declare != null) {</span>
<span class="nc" id="L3176">            getGUI().showInformationMessage(declare);</span>
<span class="nc" id="L3177">            return false;</span>
        }

        // Confirm intention, and collect nation+country names.
<span class="nc" id="L3181">        List&lt;String&gt; names = getGUI().confirmDeclaration();</span>
<span class="nc bnc" id="L3182" title="All 2 branches missed.">        if (names == null</span>
<span class="nc bnc" id="L3183" title="All 4 branches missed.">            || names.get(0) == null || names.get(0).isEmpty()</span>
<span class="nc bnc" id="L3184" title="All 4 branches missed.">            || names.get(1) == null || names.get(1).isEmpty()) {</span>
            // Empty name =&gt; user cancelled.
<span class="nc" id="L3186">            return false;</span>
        }

        // Ask server.
<span class="nc" id="L3190">        boolean ret = askServer()</span>
<span class="nc bnc" id="L3191" title="All 2 branches missed.">            .declareIndependence(getGame(), names.get(0), names.get(1))</span>
<span class="nc bnc" id="L3192" title="All 2 branches missed.">            &amp;&amp; player.isRebel();</span>
<span class="nc bnc" id="L3193" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc" id="L3194">            getGUI().showDeclarationPanel();</span>
<span class="nc" id="L3195">            updateGUI(null);</span>
        }
<span class="nc" id="L3197">        return ret;</span>
    }

    /**
     * Delete a trade route.
     *
     * Called from TradeRoutePanel button.
     *
     * @param tradeRoute The &lt;code&gt;TradeRoute&lt;/code&gt; to delete.
     * @return True if the route was successfully deleted.
     */
    public boolean deleteTradeRoute(TradeRoute tradeRoute) {
<span class="nc" id="L3209">        final Player player = getMyPlayer();</span>
<span class="nc" id="L3210">        final String name = tradeRoute.getName();</span>
<span class="nc" id="L3211">        boolean ret = askServer().deleteTradeRoute(tradeRoute);</span>
<span class="nc bnc" id="L3212" title="All 4 branches missed.">        return ret &amp;&amp; player.getTradeRouteByName(name, null) == null;</span>
    }

    /**
     * Handle a diplomatic offer.
     *
     * Called from IGIH.diplomacy
     *
     * @param our Our &lt;code&gt;FreeColGameObject&lt;/code&gt; that is negotiating.
     * @param other The other &lt;code&gt;FreeColGameObject&lt;/code&gt;.
     * @param agreement The &lt;code&gt;DiplomaticTrade&lt;/code&gt; agreement.
     * @return A counter agreement, a rejected agreement, or null if
     *     the original agreement was already decided.
     */
    public DiplomaticTrade diplomacy(FreeColGameObject our,
                                     FreeColGameObject other,
                                     DiplomaticTrade agreement) {
<span class="nc" id="L3229">        final Player player = getMyPlayer();</span>
<span class="nc" id="L3230">        final Player otherPlayer = agreement.getOtherPlayer(player);</span>
<span class="nc" id="L3231">        StringTemplate t, nation = otherPlayer.getNationLabel();</span>

<span class="nc bnc" id="L3233" title="All 4 branches missed.">        switch (agreement.getStatus()) {</span>
        case ACCEPT_TRADE:
<span class="nc" id="L3235">            boolean visibilityChange = false;</span>
<span class="nc bnc" id="L3236" title="All 2 branches missed.">            for (Colony c : agreement.getColoniesGivenBy(player)) {</span>
<span class="nc" id="L3237">                player.removeSettlement(c);//-vis(player)</span>
<span class="nc" id="L3238">                visibilityChange = true;</span>
            }
<span class="nc bnc" id="L3240" title="All 2 branches missed.">            for (Unit u : agreement.getUnitsGivenBy(player)) {</span>
<span class="nc" id="L3241">                player.removeUnit(u);//-vis(player)</span>
<span class="nc" id="L3242">                visibilityChange = true;</span>
            }
<span class="nc bnc" id="L3244" title="All 2 branches missed.">            if (visibilityChange) player.invalidateCanSeeTiles();//+vis(player)</span>
<span class="nc" id="L3245">            ModelMessage mm</span>
<span class="nc" id="L3246">                = new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,</span>
<span class="nc" id="L3247">                                   &quot;diplomacy.offerAccepted&quot;, otherPlayer)</span>
<span class="nc" id="L3248">                    .addStringTemplate(&quot;%nation%&quot;, nation);</span>
<span class="nc" id="L3249">            player.addModelMessage(mm);</span>
<span class="nc" id="L3250">            updateGUI(null);</span>
<span class="nc" id="L3251">            break;</span>
        case REJECT_TRADE:
<span class="nc" id="L3253">            t = StringTemplate.template(&quot;diplomacy.offerRejected&quot;)</span>
<span class="nc" id="L3254">                .addStringTemplate(&quot;%nation%&quot;, nation);</span>
<span class="nc" id="L3255">            getGUI().showInformationMessage(t);</span>
<span class="nc" id="L3256">            break;</span>
        case PROPOSE_TRADE:
<span class="nc" id="L3258">            t = agreement.getReceiveMessage(otherPlayer);</span>
<span class="nc" id="L3259">            DiplomaticTrade ourAgreement</span>
<span class="nc" id="L3260">                = getGUI().showNegotiationDialog(our, other, agreement, t);</span>
<span class="nc bnc" id="L3261" title="All 2 branches missed.">            if (ourAgreement == null) {</span>
<span class="nc" id="L3262">                agreement.setStatus(TradeStatus.REJECT_TRADE);</span>
<span class="nc" id="L3263">            } else {</span>
<span class="nc" id="L3264">                agreement = ourAgreement;</span>
            }
<span class="nc" id="L3266">            return agreement;</span>
        default:
<span class="nc" id="L3268">            logger.warning(&quot;Bogus trade status: &quot; + agreement.getStatus());</span>
            break;
        }
<span class="nc" id="L3271">        return null;</span>
    }

    /**
     * Disbands the active unit.
     *
     * Called from DisbandUnitAction.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to disband.
     * @return True if the unit was disbanded.
     */
    public boolean disbandUnit(Unit unit) {
<span class="nc bnc" id="L3283" title="All 4 branches missed.">        if (!requireOurTurn() || unit == null) return false;</span>

<span class="nc bnc" id="L3285" title="All 2 branches missed.">        if (unit.getColony() != null</span>
<span class="nc bnc" id="L3286" title="All 2 branches missed.">            &amp;&amp; !getGUI().confirmLeaveColony(unit)) return false;</span>
<span class="nc bnc" id="L3287" title="All 2 branches missed.">        final Tile tile = (getGUI().isShowingSubPanel()) ? null : unit.getTile();</span>
<span class="nc" id="L3288">        if (!getGUI().confirm(tile, StringTemplate.key(&quot;disbandUnit.text&quot;),</span>
<span class="nc bnc" id="L3289" title="All 2 branches missed.">                         unit, &quot;disbandUnit.yes&quot;, &quot;cancel&quot;))</span>
<span class="nc" id="L3290">            return false;</span>

        // Try to disband
<span class="nc bnc" id="L3293" title="All 4 branches missed.">        boolean ret = askServer().disbandUnit(unit) &amp;&amp; unit.isDisposed();</span>
<span class="nc bnc" id="L3294" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc" id="L3295">            updateGUI(tile);</span>
        }
<span class="nc" id="L3297">        return ret;</span>
    }

    /**
     * Display the high scores.
     *
     * Called from IGIH.gameEnded, ReportHighScoresAction
     *
     * @param high A &lt;code&gt;Boolean&lt;/code&gt; whose values indicates whether
     *     a new high score has been achieved, or no information if null.
     * @return True if the server interaction succeeded.
     */
    public boolean displayHighScores(Boolean high) {
<span class="nc" id="L3310">        final Game game = getGame();</span>
<span class="nc" id="L3311">        return askServer().getHighScores(game,</span>
<span class="nc bnc" id="L3312" title="All 2 branches missed.">            (high == null) ? null</span>
<span class="nc bnc" id="L3313" title="All 2 branches missed.">            : (high) ? &quot;highscores.yes&quot;</span>
<span class="nc" id="L3314">            : &quot;highscores.no&quot;);</span>
    }

    /**
     * Display the high scores.
     *
     * Called from IGIH.highScore.
     *
     * @param key An optional message key.
     * @param scores The list of &lt;code&gt;HighScore&lt;/code&gt; records to display.
     */
    public void displayHighScores(String key, List&lt;HighScore&gt; scores) {
<span class="nc" id="L3326">        getGUI().showHighScoresPanel(key, scores);</span>
<span class="nc" id="L3327">    }</span>

    /**
     * Displays pending &lt;code&gt;ModelMessage&lt;/code&gt;s.
     *
     * Called from IGIH.displayModelMessagesRunnable
     *
     * @param allMessages Display all messages or just the undisplayed ones.
     * @return True if any messages were displayed.
     */
    public boolean displayModelMessages(boolean allMessages) {
<span class="nc" id="L3338">        return displayModelMessages(allMessages, false);</span>
    }

    /**
     * Emigrate a unit from Europe.
     *
     * Called from GUI.showEmigrationDialog.
     *
     * @param player The &lt;code&gt;Player&lt;/code&gt; that owns the unit.
     * @param slot The slot to emigrate from, [0..RECRUIT_COUNT].
     * @param n The number of remaining units known to be eligible to migrate.
     * @param foY True if this migration is due to a fountain of youth event.
     */
    public void emigrate(Player player, int slot, int n, boolean foY) {
<span class="nc bnc" id="L3352" title="All 4 branches missed.">        if (player == null || !player.isColonial()</span>
<span class="nc bnc" id="L3353" title="All 2 branches missed.">            || !MigrationType.validMigrantSlot(slot)) return;</span>

<span class="nc bnc" id="L3355" title="All 2 branches missed.">        if (askEmigrate(player.getEurope(), slot) != null) {</span>
<span class="nc" id="L3356">            emigration(player, n, foY);</span>
        }
<span class="nc" id="L3358">    }</span>

    /**
     * End the turn command.
     *
     * Called from EndTurnAction, GUI.showEndTurnDialog
     *
     * @param showDialog If false, suppress showing the end turn dialog.
     * @return True if the turn was ended.
     */
    public boolean endTurn(boolean showDialog) {
<span class="nc bnc" id="L3369" title="All 2 branches missed.">        if (!requireOurTurn()) return false;</span>

<span class="nc bnc" id="L3371" title="All 2 branches missed.">        return doEndTurn(showDialog</span>
<span class="nc bnc" id="L3372" title="All 2 branches missed.">            &amp;&amp; getClientOptions().getBoolean(ClientOptions.SHOW_END_TURN_DIALOG));</span>
    }

    /**
     * Change the role-equipment a unit has.
     *
     * Called from DefaultTransferHandler, QuickActionMenu
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt;.
     * @param role The &lt;code&gt;Role&lt;/code&gt; to assume.
     * @param roleCount The role count.
     * @return True if the role is taken.
     */
    public boolean equipUnitForRole(Unit unit, Role role, int roleCount) {
<span class="nc bnc" id="L3386" title="All 8 branches missed.">        if (!requireOurTurn() || unit == null || role == null || 0 &gt; roleCount</span>
<span class="nc bnc" id="L3387" title="All 2 branches missed.">            || roleCount &gt; role.getMaximumCount()) return false;</span>
<span class="nc bnc" id="L3388" title="All 2 branches missed.">        if (role == unit.getRole()</span>
<span class="nc bnc" id="L3389" title="All 2 branches missed.">            &amp;&amp; roleCount == unit.getRoleCount()) return true;</span>

<span class="nc" id="L3391">        final Player player = getMyPlayer();</span>
<span class="nc" id="L3392">        final Colony colony = unit.getColony();</span>
<span class="nc bnc" id="L3393" title="All 2 branches missed.">        ColonyWas colonyWas = (colony != null) ? new ColonyWas(colony) : null;</span>
<span class="nc" id="L3394">        final Europe europe = player.getEurope();</span>
<span class="nc bnc" id="L3395" title="All 2 branches missed.">        EuropeWas europeWas = (europe != null) ? new EuropeWas(europe) : null;</span>
<span class="nc bnc" id="L3396" title="All 2 branches missed.">        final Market market = (europe != null) ? player.getMarket() : null;</span>
<span class="nc bnc" id="L3397" title="All 2 branches missed.">        MarketWas marketWas = (market != null) ? new MarketWas(player) : null;</span>
<span class="nc" id="L3398">        int price = -1;</span>

<span class="nc" id="L3400">        List&lt;AbstractGoods&gt; req = unit.getGoodsDifference(role, roleCount);</span>
<span class="nc bnc" id="L3401" title="All 2 branches missed.">        if (unit.isInEurope()) {</span>
<span class="nc bnc" id="L3402" title="All 2 branches missed.">            for (AbstractGoods ag : req) {</span>
<span class="nc" id="L3403">                GoodsType goodsType = ag.getType();</span>
<span class="nc bnc" id="L3404" title="All 4 branches missed.">                if (!player.canTrade(goodsType) &amp;&amp; !payArrears(goodsType)) {</span>
<span class="nc" id="L3405">                    return false; // payment failed</span>
                }
            }
<span class="nc" id="L3408">            price = player.getEurope().priceGoods(req);</span>
<span class="nc bnc" id="L3409" title="All 4 branches missed.">            if (price &lt; 0 || !player.checkGold(price)) return false;</span>
<span class="nc bnc" id="L3410" title="All 2 branches missed.">        } else if (colony != null) {</span>
<span class="nc bnc" id="L3411" title="All 2 branches missed.">            for (AbstractGoods ag : req) {</span>
<span class="nc bnc" id="L3412" title="All 2 branches missed.">                if (colony.getGoodsCount(ag.getType()) &lt; ag.getAmount()) {</span>
<span class="nc" id="L3413">                    StringTemplate template = StringTemplate</span>
<span class="nc" id="L3414">                        .template(&quot;equipUnit.impossible&quot;)</span>
<span class="nc" id="L3415">                        .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="nc" id="L3416">                        .addNamed(&quot;%equipment%&quot;, ag.getType())</span>
<span class="nc" id="L3417">                        .addStringTemplate(&quot;%unit%&quot;,</span>
<span class="nc" id="L3418">                            unit.getLabel(Unit.UnitLabelType.NATIONAL));</span>
<span class="nc" id="L3419">                    getGUI().showInformationMessage(unit, template);</span>
<span class="nc" id="L3420">                    return false;</span>
                }
            }
<span class="nc" id="L3423">        } else {</span>
<span class="nc" id="L3424">            return false;</span>
        }

<span class="nc" id="L3427">        UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc bnc" id="L3428" title="All 2 branches missed.">        boolean ret = askServer().equipUnitForRole(unit, role, roleCount)</span>
<span class="nc bnc" id="L3429" title="All 2 branches missed.">            &amp;&amp; unit.getRole() == role;</span>
<span class="nc bnc" id="L3430" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc bnc" id="L3431" title="All 2 branches missed.">            if (colonyWas != null) colonyWas.fireChanges();</span>
<span class="nc bnc" id="L3432" title="All 2 branches missed.">            if (europeWas != null) europeWas.fireChanges();</span>
<span class="nc bnc" id="L3433" title="All 2 branches missed.">            if (marketWas != null) marketWas.fireChanges(req);</span>
<span class="nc" id="L3434">            unitWas.fireChanges();</span>
<span class="nc" id="L3435">            updateGUI(null);</span>
        }
<span class="nc" id="L3437">        return ret;</span>
    }

    /**
     * Display an error.
     *
     * Called from IGIH.error.
     *
     * @param messageId The i18n-keyname of the error message to display.
     * @param message An alternative non-i18n message to display if
     *     the resource specified by &lt;code&gt;messageId&lt;/code&gt; is unavailable.
     */
    public void error(String messageId, String message) {
<span class="nc" id="L3450">        logger.warning(&quot;Error: &quot; + messageId + &quot;/&quot; + message);</span>
<span class="nc" id="L3451">        getGUI().showErrorMessage(messageId, message);</span>
<span class="nc" id="L3452">    }</span>

    /**
     * Execute goto orders command.
     *
     * Called from ExecuteGotoOrdersAction.
     *
     * @return True if all goto orders have been performed and no units
     *     reached their destination and are free to move again.
     */
    public boolean executeGotoOrders() {
<span class="nc bnc" id="L3463" title="All 2 branches missed.">        if (!requireOurTurn()) return false;</span>

<span class="nc" id="L3465">        return doExecuteGotoOrders();</span>
    }

    /**
     * A player makes first contact with a native player.
     *
     * Called from GUI.showFirstContactDialog
     *
     * @param player The &lt;code&gt;Player&lt;/code&gt; making contact.
     * @param other The native &lt;code&gt;Player&lt;/code&gt; being contacted.
     * @param tile An optional &lt;code&gt;Tile&lt;/code&gt; to offer the player if
     *     they have made a first landing.
     * @param result Whether the initial treaty was accepted.
     * @return True if first contact occurs.
     */
    public boolean firstContact(Player player, Player other, Tile tile,
                                boolean result) {
<span class="nc bnc" id="L3482" title="All 6 branches missed.">        if (player == null || player == null || player == other</span>
<span class="nc bnc" id="L3483" title="All 2 branches missed.">            || tile == null) return false;</span>

<span class="nc" id="L3485">        boolean ret = askServer().firstContact(player, other, tile, result);</span>
<span class="nc bnc" id="L3486" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc" id="L3487">            updateGUI(null);</span>
        }
<span class="nc" id="L3489">        return ret;</span>
    }

    /**
     * A player makes first contact with a native player.
     *
     * Called from IGIH.firstContact.
     *
     * @param player The &lt;code&gt;Player&lt;/code&gt; making contact.
     * @param other The native &lt;code&gt;Player&lt;/code&gt; being contacted.
     * @param tile An optional &lt;code&gt;Tile&lt;/code&gt; to offer the player if
     *     they have made a first landing.
     * @param n The number of settlements claimed by the native player.
     */
    public void firstContact(Player player, Player other, Tile tile, int n) {
<span class="nc" id="L3504">        getGUI().showFirstContactDialog(player, other, tile, n,</span>
<span class="nc" id="L3505">            (Boolean b) -&gt; firstContact(player, other, tile, b));</span>
<span class="nc" id="L3506">    }</span>

    /**
     * Handle a fountain of youth event.
     *
     * Called from IGIH.fountainOfYouth.
     *
     * @param n The number of migrants available for selection.
     */
    public void fountainOfYouth(int n) {
<span class="nc" id="L3516">        final Player player = getMyPlayer();</span>
<span class="nc" id="L3517">        final boolean fountainOfYouth = true;</span>
<span class="nc" id="L3518">        getGUI().showEmigrationDialog(player, fountainOfYouth,</span>
<span class="nc" id="L3519">            (Integer value) -&gt; { // Value is a valid slot</span>
<span class="nc" id="L3520">                emigrate(player,</span>
<span class="nc" id="L3521">                         Europe.MigrationType.convertToMigrantSlot(value),</span>
<span class="nc" id="L3522">                         n-1, fountainOfYouth);</span>
<span class="nc" id="L3523">            });</span>
<span class="nc" id="L3524">    }</span>

    /**
     * Get the nation summary for a player.
     *
     * Called from DiplomaticTradePanel, ReportForeignAffairsPanel,
     * ReportIndianPanel
     *
     * @param player The &lt;code&gt;Player&lt;/code&gt; to summarize.
     * @return A summary of that nation, or null on error.
     */
    public NationSummary getNationSummary(Player player) {
<span class="nc bnc" id="L3536" title="All 2 branches missed.">        if (player == null) return null;</span>

<span class="nc" id="L3538">        final Player myPlayer = getMyPlayer();</span>
<span class="nc" id="L3539">        NationSummary ns = myPlayer.getNationSummary(player);</span>
<span class="nc bnc" id="L3540" title="All 2 branches missed.">        if (ns != null) return ns;</span>
        // Refresh from server
<span class="nc bnc" id="L3542" title="All 2 branches missed.">        if (askServer().nationSummary(myPlayer, player)) {</span>
<span class="nc" id="L3543">            return myPlayer.getNationSummary(player);</span>
        }
<span class="nc" id="L3545">        return null;</span>
    }

    /**
     * Go to a tile.
     *
     * Called from CanvasMouseListener, TilePopup
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to move.
     * @param tile The &lt;code&gt;Tile&lt;/code&gt; to move to.
     * @return True if the destination change was successful.
     */
    public boolean goToTile(Unit unit, Tile tile) {
<span class="nc bnc" id="L3558" title="All 4 branches missed.">        if (!requireOurTurn() || unit == null</span>
<span class="nc bnc" id="L3559" title="All 2 branches missed.">            || !getMyPlayer().owns(unit)) return false;</span>

<span class="nc bnc" id="L3561" title="All 2 branches missed.">        if (!getGUI().confirmClearTradeRoute(unit)) return false;</span>

<span class="nc" id="L3563">        UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc" id="L3564">        boolean ret = askSetDestination(unit, tile);</span>
<span class="nc bnc" id="L3565" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc" id="L3566">            moveToDestination(unit, null);</span>
<span class="nc" id="L3567">            unitWas.fireChanges();</span>
<span class="nc" id="L3568">            updateGUI(null);</span>
        }
<span class="nc" id="L3570">        return ret;</span>
    }

    /**
     * Ignore this ModelMessage from now on until it is not generated
     * in a turn.
     *
     * Called from ReportTurnPanel
     *
     * @param message a &lt;code&gt;ModelMessage&lt;/code&gt; value
     * @param flag whether to ignore the ModelMessage or not
     * @return True, ignore message status changes can not fail.
     */
    public boolean ignoreMessage(ModelMessage message, boolean flag) {
        String key;
<span class="nc bnc" id="L3585" title="All 2 branches missed.">        if (message == null</span>
<span class="nc bnc" id="L3586" title="All 2 branches missed.">            || (key = message.getIgnoredMessageKey()) == null) return false;</span>

<span class="nc bnc" id="L3588" title="All 2 branches missed.">        if (flag) {</span>
<span class="nc" id="L3589">            final Turn turn = getGame().getTurn();</span>
<span class="nc bnc" id="L3590" title="All 2 branches missed.">            if (!continueIgnoreMessage(key, turn)) {</span>
<span class="nc" id="L3591">                startIgnoringMessage(key, turn);</span>
            }
<span class="nc" id="L3593">        } else {</span>
<span class="nc" id="L3594">            stopIgnoringMessage(key);</span>
        }
<span class="nc" id="L3596">        return true;</span>
    }

    /**
     * Handle an incite response.
     *
     * Called from IGIH.incite.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is inciting.
     * @param is The &lt;code&gt;IndianSettlement&lt;/code&gt; being incited.
     * @param enemy The &lt;code&gt;Player&lt;/code&gt; incited against.
     * @param gold The gold required by the natives to become hostile.
     */
    public void incite(Unit unit, IndianSettlement is, Player enemy, int gold) {
<span class="nc" id="L3610">        final Player player = getMyPlayer();</span>
        
<span class="nc bnc" id="L3612" title="All 2 branches missed.">        if (gold &lt; 0) {</span>
            ; // protocol fail
<span class="nc bnc" id="L3614" title="All 2 branches missed.">        } else if (!player.checkGold(gold)) {</span>
<span class="nc" id="L3615">            getGUI().showInformationMessage(is, StringTemplate</span>
<span class="nc" id="L3616">                .template(&quot;missionarySettlement.inciteGoldFail&quot;)</span>
<span class="nc" id="L3617">                .add(&quot;%player%&quot;, enemy.getName())</span>
<span class="nc" id="L3618">                .addAmount(&quot;%amount%&quot;, gold));</span>
<span class="nc" id="L3619">        } else if (getGUI().confirm(unit.getTile(), StringTemplate</span>
<span class="nc" id="L3620">                .template(&quot;missionarySettlement.inciteConfirm&quot;)</span>
<span class="nc" id="L3621">                .addStringTemplate(&quot;%enemy%&quot;, enemy.getNationLabel())</span>
<span class="nc" id="L3622">                .addAmount(&quot;%amount%&quot;, gold),</span>
<span class="nc bnc" id="L3623" title="All 2 branches missed.">                unit, &quot;yes&quot;, &quot;no&quot;)) {</span>
<span class="nc" id="L3624">            askServer().incite(unit, is, enemy, gold);</span>
        }
<span class="nc" id="L3626">    }</span>

    /**
     * Handle a native demand at a colony.
     *
     * Called from IGIH.indianDemand
     *
     * @param unit The native &lt;code&gt;Unit&lt;/code&gt; making the demand.
     * @param colony The &lt;code&gt;Colony&lt;/code&gt; demanded of.
     * @param type The &lt;code&gt;GoodsType&lt;/code&gt; demanded (null means gold).
     * @param amount The amount of goods/gold demanded.
     * @return Whether the demand was accepted or not.
     */
    public boolean indianDemand(Unit unit, Colony colony,
                                GoodsType type, int amount) {
<span class="nc bnc" id="L3641" title="All 4 branches missed.">        if (unit == null || colony == null) return false;</span>

<span class="nc" id="L3643">        final Player player = getMyPlayer();</span>
<span class="nc" id="L3644">        final int opt = getClientOptions()</span>
<span class="nc" id="L3645">            .getInteger(ClientOptions.INDIAN_DEMAND_RESPONSE);</span>
        boolean accepted;
<span class="nc" id="L3647">        ModelMessage m = null;</span>
<span class="nc" id="L3648">        String nation = Messages.message(unit.getOwner().getNationLabel());</span>
<span class="nc bnc" id="L3649" title="All 2 branches missed.">        if (type == null) {</span>
<span class="nc bnc" id="L3650" title="All 4 branches missed.">            switch (opt) {</span>
            case ClientOptions.INDIAN_DEMAND_RESPONSE_ASK:
<span class="nc" id="L3652">                accepted = getGUI().confirm(colony.getTile(), StringTemplate</span>
<span class="nc" id="L3653">                    .template(&quot;indianDemand.gold.text&quot;)</span>
<span class="nc" id="L3654">                    .addName(&quot;%nation%&quot;, nation)</span>
<span class="nc" id="L3655">                    .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="nc" id="L3656">                    .addAmount(&quot;%amount%&quot;, amount),</span>
<span class="nc" id="L3657">                    unit, &quot;accept&quot;, &quot;indianDemand.gold.no&quot;);</span>
<span class="nc" id="L3658">                break;</span>
            case ClientOptions.INDIAN_DEMAND_RESPONSE_ACCEPT:
<span class="nc" id="L3660">                m = new ModelMessage(ModelMessage.MessageType.DEMANDS,</span>
<span class="nc" id="L3661">                                     &quot;indianDemand.gold.text&quot;, colony, unit)</span>
<span class="nc" id="L3662">                    .addName(&quot;%nation%&quot;, nation)</span>
<span class="nc" id="L3663">                    .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="nc" id="L3664">                    .addAmount(&quot;%amount%&quot;, amount);</span>
<span class="nc" id="L3665">                accepted = true;</span>
<span class="nc" id="L3666">                break;</span>
            case ClientOptions.INDIAN_DEMAND_RESPONSE_REJECT:
<span class="nc" id="L3668">                m = new ModelMessage(ModelMessage.MessageType.DEMANDS,</span>
<span class="nc" id="L3669">                                     &quot;indianDemand.gold.text&quot;, colony, unit)</span>
<span class="nc" id="L3670">                    .addName(&quot;%nation%&quot;, nation)</span>
<span class="nc" id="L3671">                    .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="nc" id="L3672">                    .addAmount(&quot;%amount%&quot;, amount);</span>
<span class="nc" id="L3673">                accepted = false;</span>
<span class="nc" id="L3674">                break;</span>
            default:
<span class="nc" id="L3676">                throw new RuntimeException(&quot;Impossible option value.&quot;);</span>
            }
<span class="nc" id="L3678">        } else {</span>
<span class="nc bnc" id="L3679" title="All 4 branches missed.">            switch (opt) {</span>
            case ClientOptions.INDIAN_DEMAND_RESPONSE_ASK:
<span class="nc bnc" id="L3681" title="All 2 branches missed.">                if (type.isFoodType()) {</span>
<span class="nc" id="L3682">                    accepted = getGUI().confirm(colony.getTile(),</span>
<span class="nc" id="L3683">                        StringTemplate.template(&quot;indianDemand.food.text&quot;)</span>
<span class="nc" id="L3684">                            .addName(&quot;%nation%&quot;, nation)</span>
<span class="nc" id="L3685">                            .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="nc" id="L3686">                            .addAmount(&quot;%amount%&quot;, amount),</span>
<span class="nc" id="L3687">                        unit, &quot;indianDemand.food.yes&quot;, &quot;indianDemand.food.no&quot;);</span>
<span class="nc" id="L3688">                } else {</span>
<span class="nc" id="L3689">                    accepted = getGUI().confirm(colony.getTile(),</span>
<span class="nc" id="L3690">                        StringTemplate.template(&quot;indianDemand.other.text&quot;)</span>
<span class="nc" id="L3691">                            .addName(&quot;%nation%&quot;, nation)</span>
<span class="nc" id="L3692">                            .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="nc" id="L3693">                            .addAmount(&quot;%amount%&quot;, amount)</span>
<span class="nc" id="L3694">                            .addNamed(&quot;%goods%&quot;, type),</span>
<span class="nc" id="L3695">                        unit, &quot;accept&quot;, &quot;indianDemand.other.no&quot;);</span>
                }
<span class="nc" id="L3697">                break;</span>
            case ClientOptions.INDIAN_DEMAND_RESPONSE_ACCEPT:
<span class="nc bnc" id="L3699" title="All 2 branches missed.">                if (type.isFoodType()) {</span>
<span class="nc" id="L3700">                    m = new ModelMessage(ModelMessage.MessageType.DEMANDS,</span>
<span class="nc" id="L3701">                                         &quot;indianDemand.food.text&quot;,</span>
<span class="nc" id="L3702">                                         colony, unit)</span>
<span class="nc" id="L3703">                        .addName(&quot;%nation%&quot;, nation)</span>
<span class="nc" id="L3704">                        .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="nc" id="L3705">                        .addAmount(&quot;%amount%&quot;, amount);</span>
<span class="nc" id="L3706">                } else {</span>
<span class="nc" id="L3707">                    m = new ModelMessage(ModelMessage.MessageType.DEMANDS,</span>
<span class="nc" id="L3708">                                         &quot;indianDemand.other.text&quot;,</span>
<span class="nc" id="L3709">                                         colony, unit)</span>
<span class="nc" id="L3710">                        .addName(&quot;%nation%&quot;, nation)</span>
<span class="nc" id="L3711">                        .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="nc" id="L3712">                        .addAmount(&quot;%amount%&quot;, amount)</span>
<span class="nc" id="L3713">                        .addNamed(&quot;%goods%&quot;, type);</span>
                }
<span class="nc" id="L3715">                accepted = true;</span>
<span class="nc" id="L3716">                break;</span>
            case ClientOptions.INDIAN_DEMAND_RESPONSE_REJECT:
<span class="nc bnc" id="L3718" title="All 2 branches missed.">                if (type.isFoodType()) {</span>
<span class="nc" id="L3719">                    m = new ModelMessage(ModelMessage.MessageType.DEMANDS,</span>
<span class="nc" id="L3720">                                         &quot;indianDemand.food.text&quot;,</span>
<span class="nc" id="L3721">                                         colony, unit)</span>
<span class="nc" id="L3722">                        .addName(&quot;%nation%&quot;, nation)</span>
<span class="nc" id="L3723">                        .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="nc" id="L3724">                        .addAmount(&quot;%amount%&quot;, amount);</span>
<span class="nc" id="L3725">                } else {</span>
<span class="nc" id="L3726">                    m = new ModelMessage(ModelMessage.MessageType.DEMANDS,</span>
<span class="nc" id="L3727">                                         &quot;indianDemand.other.text&quot;,</span>
<span class="nc" id="L3728">                                         colony, unit)</span>
<span class="nc" id="L3729">                        .addName(&quot;%nation%&quot;, nation)</span>
<span class="nc" id="L3730">                        .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="nc" id="L3731">                        .addAmount(&quot;%amount%&quot;, amount)</span>
<span class="nc" id="L3732">                        .addNamed(&quot;%goods%&quot;, type);</span>
                }
<span class="nc" id="L3734">                accepted = false;</span>
<span class="nc" id="L3735">                break;</span>
            default:
<span class="nc" id="L3737">                throw new RuntimeException(&quot;Impossible option value.&quot;);</span>
            }
        }
<span class="nc bnc" id="L3740" title="All 2 branches missed.">        if (m != null) {</span>
<span class="nc" id="L3741">            player.addModelMessage(m);</span>
<span class="nc" id="L3742">            displayModelMessages(false);</span>
        }
<span class="nc" id="L3744">        return accepted;</span>
    }

    /**
     * Join the colony at a unit's current location.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to use.
     * @return True if the unit joined a colony.
     */
    public boolean joinColony(Unit unit) {
<span class="nc" id="L3754">        final Tile tile = unit.getTile();</span>
<span class="nc bnc" id="L3755" title="All 2 branches missed.">        final Colony colony = (tile == null) ? null : tile.getColony();</span>
<span class="nc bnc" id="L3756" title="All 4 branches missed.">        boolean ret = colony != null &amp;&amp; askServer().joinColony(unit, colony)</span>
<span class="nc bnc" id="L3757" title="All 2 branches missed.">            &amp;&amp; unit.getState() == UnitState.IN_COLONY;</span>
<span class="nc bnc" id="L3758" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc" id="L3759">            updateGUI(null);</span>
<span class="nc" id="L3760">            colonyPanel(colony, unit);</span>
        }
<span class="nc" id="L3762">        return ret;</span>
    }
    
    /**
     * Leave a ship.  The ship must be in harbour.
     *
     * Called from CargoPanel, ColonyPanel, EuropePanel.unloadAction,
     * UnitLabel
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; which is to leave the ship.
     * @return True if the unit left the ship.
     */
    public boolean leaveShip(Unit unit) {
        Unit carrier;
<span class="nc bnc" id="L3776" title="All 4 branches missed.">        if (!requireOurTurn() || unit == null</span>
<span class="nc bnc" id="L3777" title="All 2 branches missed.">            || (carrier = unit.getCarrier()) == null) return false;</span>

        // Proceed to disembark
<span class="nc" id="L3780">        UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc bnc" id="L3781" title="All 2 branches missed.">        boolean ret = askServer().disembark(unit)</span>
<span class="nc bnc" id="L3782" title="All 2 branches missed.">            &amp;&amp; unit.getLocation() != carrier;</span>
<span class="nc bnc" id="L3783" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc" id="L3784">            checkCashInTreasureTrain(unit);</span>
<span class="nc" id="L3785">            unitWas.fireChanges();</span>
<span class="nc" id="L3786">            updateGUI(null);</span>
        }
<span class="nc" id="L3788">        return ret;</span>
    }

    /**
     * Loads a cargo onto a carrier.
     *
     * Called from CargoPanel, ColonyPanel, LoadAction, TilePopup.
     *
     * @param goods The &lt;code&gt;Goods&lt;/code&gt; which are going aboard the carrier.
     * @param carrier The &lt;code&gt;Unit&lt;/code&gt; acting as carrier.
     * @return True if the goods were loaded.
     */
    public boolean loadCargo(Goods goods, Unit carrier) {
<span class="nc bnc" id="L3801" title="All 6 branches missed.">        if (!requireOurTurn() || goods == null || goods.getAmount() &lt;= 0</span>
<span class="nc bnc" id="L3802" title="All 2 branches missed.">            || goods.getLocation() == null</span>
<span class="nc bnc" id="L3803" title="All 4 branches missed.">            || carrier == null || !carrier.isCarrier()) return false;</span>

<span class="nc bnc" id="L3805" title="All 2 branches missed.">        if (goods.getLocation() instanceof Europe) {</span>
<span class="nc" id="L3806">            return buyGoods(goods.getType(), goods.getAmount(), carrier);</span>
        }
<span class="nc" id="L3808">        UnitWas carrierWas = new UnitWas(carrier);</span>
<span class="nc" id="L3809">        UnitWas sourceWas = null;</span>
<span class="nc" id="L3810">        ColonyWas colonyWas = null;</span>
<span class="nc bnc" id="L3811" title="All 2 branches missed.">        if (goods.getLocation() instanceof Unit) {</span>
<span class="nc" id="L3812">            Unit source = (Unit)goods.getLocation();</span>
<span class="nc" id="L3813">            sourceWas = new UnitWas(source);</span>
<span class="nc" id="L3814">        } else {</span>
<span class="nc" id="L3815">            Colony colony = carrier.getColony();</span>
<span class="nc bnc" id="L3816" title="All 2 branches missed.">            if (colony == null) return false;</span>
<span class="nc" id="L3817">            colonyWas = new ColonyWas(colony);</span>
        }

<span class="nc" id="L3820">        boolean ret = askLoadGoods(goods.getLocation(), goods.getType(),</span>
<span class="nc" id="L3821">                                   goods.getAmount(), carrier);</span>
<span class="nc bnc" id="L3822" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc" id="L3823">            sound(&quot;sound.event.loadCargo&quot;);</span>
<span class="nc bnc" id="L3824" title="All 2 branches missed.">            if (colonyWas != null) colonyWas.fireChanges();</span>
<span class="nc bnc" id="L3825" title="All 2 branches missed.">            if (sourceWas != null) sourceWas.fireChanges();</span>
<span class="nc" id="L3826">            carrierWas.fireChanges();</span>
<span class="nc" id="L3827">            updateGUI(null);</span>
        }
<span class="nc" id="L3829">        return ret;</span>
    }

    /**
     * Opens a dialog where the user should specify the filename and
     * loads the game.
     *
     * Called from OpenAction.
     *
     * Returns no status as this game is stopped.
     */
    public void loadGame() {
<span class="nc" id="L3841">        File file = getGUI().showLoadSaveFileDialog();</span>
<span class="nc bnc" id="L3842" title="All 2 branches missed.">        if (file == null) return;</span>
<span class="nc bnc" id="L3843" title="All 2 branches missed.">        if (getFreeColClient().isInGame()</span>
<span class="nc bnc" id="L3844" title="All 2 branches missed.">            &amp;&amp; !getGUI().confirmStopGame()) return;</span>

<span class="nc" id="L3846">        getConnectController().quitGame(true);</span>
<span class="nc" id="L3847">        turnReportMessages.clear();</span>
<span class="nc" id="L3848">        getGUI().setActiveUnit(null);</span>
<span class="nc" id="L3849">        getGUI().removeInGameComponents();</span>
<span class="nc" id="L3850">        FreeColDirectories.setSavegameFile(file.getPath());</span>
<span class="nc" id="L3851">        getConnectController().startSavedGame(file, null);</span>
<span class="nc" id="L3852">    }</span>

    /**
     * Loot some cargo.
     *
     * Called from GUI.showCaptureGoodsDialog
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is looting.
     * @param goods A list of &lt;code&gt;Goods&lt;/code&gt; to choose from.
     * @param defenderId The identifier of the defender unit (may have sunk).
     * @return True if looting occurs.
     */
    public boolean lootCargo(Unit unit, List&lt;Goods&gt; goods, String defenderId) {
<span class="nc bnc" id="L3865" title="All 6 branches missed.">        if (unit == null || goods == null || goods.isEmpty()</span>
<span class="nc bnc" id="L3866" title="All 2 branches missed.">            || defenderId == null) return false;</span>

<span class="nc" id="L3868">        UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc" id="L3869">        boolean ret = askServer().loot(unit, defenderId, goods);</span>
<span class="nc bnc" id="L3870" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc" id="L3871">            unitWas.fireChanges();</span>
<span class="nc" id="L3872">            updateGUI(null);</span>
        }
<span class="nc" id="L3874">        return ret;</span>
    }

    /**
     * Loot some cargo.
     *
     * Called from IGIH.lootCargo.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is looting.
     * @param goods A list of &lt;code&gt;Goods&lt;/code&gt; to choose from.
     * @param defenderId The identifier of the defender unit (may have sunk).
     */
    public void loot(Unit unit, List&lt;Goods&gt; goods, String defenderId) {
<span class="nc" id="L3887">        getGUI().showCaptureGoodsDialog(unit, goods,</span>
<span class="nc" id="L3888">            (List&lt;Goods&gt; gl) -&gt; lootCargo(unit, gl, defenderId));</span>
<span class="nc" id="L3889">    }</span>

    /**
     * Accept or reject a monarch action.
     *
     * Called from GUI.showMonarchDialog
     *
     * @param action The &lt;code&gt;MonarchAction&lt;/code&gt; performed.
     * @param accept If true, accept the action.
     * @return True if the monarch was answered.
     */
    public boolean monarchAction(MonarchAction action, boolean accept) {
<span class="nc bnc" id="L3901" title="All 2 branches missed.">        if (action == null) return false;</span>

<span class="nc" id="L3903">        boolean ret = false;</span>
<span class="nc bnc" id="L3904" title="All 2 branches missed.">        switch (action) {</span>
        case RAISE_TAX_ACT: case RAISE_TAX_WAR:
        case MONARCH_MERCENARIES: case HESSIAN_MERCENARIES:
<span class="nc" id="L3907">            ret = askServer().answerMonarch(getGame(), action, accept);</span>
<span class="nc" id="L3908">            break;</span>
        default:
            break;
        }
<span class="nc bnc" id="L3912" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc" id="L3913">            updateGUI(null);</span>
        }
<span class="nc" id="L3915">        return ret;</span>
    }

    /**
     * Do a monarch interaction.
     *
     * Called from IGIH.monarchAction.
     *
     * @param action The &lt;code&gt;MonarchAction&lt;/code&gt; to perform.
     * @param template A &lt;code&gt;StringTemplate&lt;/code&gt; describing the action.
     * @param monarchKey A key for the monarch involved.
     */
    public void monarch(MonarchAction action, StringTemplate template,
                        String monarchKey) {
<span class="nc" id="L3929">        getGUI().showMonarchDialog(action, template, monarchKey,</span>
<span class="nc" id="L3930">            (Boolean b) -&gt; monarchAction(action, b));</span>
<span class="nc" id="L3931">    }</span>

    /**
     * Moves the specified unit somewhere that requires crossing the
     * high seas.
     *
     * Called from EuropePanel.DestinationPanel, TilePopup
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to be moved.
     * @param destination The &lt;code&gt;Location&lt;/code&gt; to be moved to.
     * @return True if the unit can possibly move further.
     */
    public boolean moveTo(Unit unit, Location destination) {
<span class="nc bnc" id="L3944" title="All 4 branches missed.">        if (!requireOurTurn() || unit == null</span>
<span class="nc bnc" id="L3945" title="All 2 branches missed.">            || destination == null) return false;</span>

        // Sanity check current state.
<span class="nc bnc" id="L3948" title="All 2 branches missed.">        if (destination instanceof Europe) {</span>
<span class="nc bnc" id="L3949" title="All 2 branches missed.">            if (unit.isInEurope()) {</span>
<span class="nc" id="L3950">                sound(&quot;sound.event.illegalMove&quot;);</span>
<span class="nc" id="L3951">                return false;</span>
            }
<span class="nc bnc" id="L3953" title="All 2 branches missed.">        } else if (destination instanceof Map) {</span>
<span class="nc bnc" id="L3954" title="All 4 branches missed.">            if (unit.hasTile() &amp;&amp; unit.getTile().getMap() == destination) {</span>
<span class="nc" id="L3955">                sound(&quot;sound.event.illegalMove&quot;);</span>
<span class="nc" id="L3956">                return false;</span>
            }
<span class="nc bnc" id="L3958" title="All 2 branches missed.">        } else if (destination instanceof Settlement) {</span>
<span class="nc bnc" id="L3959" title="All 2 branches missed.">            if (unit.hasTile()) {</span>
<span class="nc" id="L3960">                sound(&quot;sound.event.illegalMove&quot;);</span>
<span class="nc" id="L3961">                return false;</span>
            }
        } else {
<span class="nc" id="L3964">            return false;</span>
        }

        // Autoload?
<span class="nc" id="L3968">        boolean update = false;</span>
<span class="nc bnc" id="L3969" title="All 2 branches missed.">        if (getClientOptions().getBoolean(ClientOptions.AUTOLOAD_EMIGRANTS)</span>
<span class="nc bnc" id="L3970" title="All 2 branches missed.">            &amp;&amp; unit.isInEurope()) {</span>
<span class="nc bnc" id="L3971" title="All 2 branches missed.">            for (Unit u : unit.getOwner().getEurope().getUnitList()) {</span>
<span class="nc bnc" id="L3972" title="All 2 branches missed.">                if (!u.isNaval()</span>
<span class="nc bnc" id="L3973" title="All 2 branches missed.">                    &amp;&amp; u.getState() == UnitState.SENTRY</span>
<span class="nc bnc" id="L3974" title="All 2 branches missed.">                    &amp;&amp; unit.canAdd(u)) {</span>
<span class="nc bnc" id="L3975" title="All 2 branches missed.">                    if (askEmbark(u, unit)) update = true;</span>
                }
            }
        }

<span class="nc" id="L3980">        UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc" id="L3981">        boolean ret = askServer().moveTo(unit, destination);</span>
<span class="nc bnc" id="L3982" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc" id="L3983">            unitWas.fireChanges();</span>
<span class="nc" id="L3984">            update = true;</span>
        }
<span class="nc bnc" id="L3986" title="All 2 branches missed.">        if (update) updateGUI(null);</span>
<span class="nc" id="L3987">        return ret;</span>
    }

    /**
     * Moves the active unit in a specified direction. This may result in an
     * attack, move... action.
     *
     * Called from MoveAction, CornerMapControls
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to move.
     * @param direction The &lt;code&gt;Direction&lt;/code&gt; in which to move
     *     the active unit.
     * @return True if the unit may move further.
     */
    public boolean moveUnit(Unit unit, Direction direction) {
<span class="nc bnc" id="L4002" title="All 4 branches missed.">        if (!requireOurTurn() || unit == null</span>
<span class="nc bnc" id="L4003" title="All 4 branches missed.">            || direction == null || !unit.hasTile()) return false;</span>

<span class="nc bnc" id="L4005" title="All 2 branches missed.">        if (!askClearGotoOrders(unit)) return false;</span>

<span class="nc" id="L4007">        final int unitCount = unit.getUnitCount(),</span>
<span class="nc" id="L4008">            goodsCount = unit.getGoodsList().size();</span>
<span class="nc" id="L4009">        final Tile oldTile = unit.getTile();</span>
<span class="nc" id="L4010">        UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc bnc" id="L4011" title="All 2 branches missed.">        ColonyWas colonyWas = (unit.getColony() == null) ? null</span>
<span class="nc" id="L4012">            : new ColonyWas(unit.getColony());</span>
<span class="nc" id="L4013">        unit.setState(UnitState.ACTIVE);</span>
<span class="nc" id="L4014">        moveDirection(unit, direction, true);</span>
<span class="nc bnc" id="L4015" title="All 2 branches missed.">        boolean ret = unit.getTile() != oldTile</span>
<span class="nc bnc" id="L4016" title="All 2 branches missed.">            || unitWas.fireChanges();</span>
<span class="nc bnc" id="L4017" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc bnc" id="L4018" title="All 2 branches missed.">            if (colonyWas != null) colonyWas.fireChanges();</span>
<span class="nc" id="L4019">            updateGUI(null);</span>
<span class="nc bnc" id="L4020" title="All 4 branches missed.">            if (!unit.couldMove() &amp;&amp; unit.hasTile()) {</span>
                // Show colony panel if unit out of moves
<span class="nc" id="L4022">                Colony colony = unit.getTile().getColony();</span>
<span class="nc bnc" id="L4023" title="All 2 branches missed.">                if (colony != null) colonyPanel(colony, unit);</span>
            }
        }
<span class="nc" id="L4026">        return ret;</span>
    }

   /**
     * Move the tile cursor.
     *
     * Called from MoveAction in terrain mode.
     *
     * @param direction The &lt;code&gt;Direction&lt;/code&gt; to move the tile cursor.
     * @return True if the tile cursor is moved.
     */
    public boolean moveTileCursor(Direction direction) {
<span class="nc bnc" id="L4038" title="All 2 branches missed.">        if (direction == null) return false;</span>

<span class="nc" id="L4040">        final Tile tile = getGUI().getSelectedTile();</span>
<span class="nc bnc" id="L4041" title="All 2 branches missed.">        if (tile == null) return false;</span>

<span class="nc" id="L4043">        final Tile newTile = tile.getNeighbourOrNull(direction);</span>
<span class="nc bnc" id="L4044" title="All 2 branches missed.">        if (newTile == null) return false;</span>

<span class="nc" id="L4046">        getGUI().setSelectedTile(newTile);</span>
<span class="nc" id="L4047">        return true;</span>
    } 

    /**
     * A player names the New World.
     *
     * Called from GUI.showNameNewLandDialog
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that landed.
     * @param name The name to use.
     * @return True if the new land was named.
     */
    public boolean nameNewLand(Unit unit, String name) {
<span class="nc bnc" id="L4060" title="All 4 branches missed.">        if (unit == null || name == null) return false;</span>

        // Respond to the server.
<span class="nc bnc" id="L4063" title="All 2 branches missed.">        if (!askServer().newLandName(unit, name)) return false;</span>

        // The name is set, bring up the first landing panel.
<span class="nc" id="L4066">        final Player player = unit.getOwner();</span>
<span class="nc" id="L4067">        StringTemplate t = StringTemplate.template(&quot;event.firstLanding&quot;)</span>
<span class="nc" id="L4068">            .addName(&quot;%name%&quot;, name);</span>
<span class="nc" id="L4069">        getGUI().showEventPanel(Messages.message(t), &quot;image.flavor.event.firstLanding&quot;,</span>
<span class="nc" id="L4070">                           null);</span>

        // Add tutorial message.
<span class="nc" id="L4073">        final String key = FreeColActionUI</span>
<span class="nc" id="L4074">            .getHumanKeyStrokeText(getFreeColClient()</span>
<span class="nc" id="L4075">                .getActionManager().getFreeColAction(&quot;buildColonyAction&quot;)</span>
<span class="nc" id="L4076">                .getAccelerator());</span>
<span class="nc" id="L4077">        player.addModelMessage(new ModelMessage(ModelMessage.MessageType.TUTORIAL,</span>
<span class="nc" id="L4078">                               &quot;buildColony.tutorial&quot;, player)</span>
<span class="nc" id="L4079">            .addName(&quot;%colonyKey%&quot;, key)</span>
<span class="nc" id="L4080">            .add(&quot;%colonyMenuItem%&quot;, &quot;buildColonyAction.name&quot;)</span>
<span class="nc" id="L4081">            .add(&quot;%ordersMenuItem%&quot;, &quot;menuBar.orders&quot;));</span>
<span class="nc" id="L4082">        displayModelMessages(false);</span>
<span class="nc" id="L4083">        return true;</span>
    }

    /**
     * The player names a new region.
     *
     * Called from newRegionName, GUI.showNameNewRegionDialog
     *
     * @param tile The &lt;code&gt;Tile&lt;/code&gt; within the region.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that has discovered the region.
     * @param region The &lt;code&gt;Region&lt;/code&gt; to name.
     * @param name The name to offer.
     * @return True if the new region was named.
     */
    public boolean nameNewRegion(final Tile tile, final Unit unit,
                                 final Region region, final String name) {
<span class="nc bnc" id="L4099" title="All 6 branches missed.">        if (tile == null || unit == null || region == null) return false;</span>

<span class="nc" id="L4101">        return askServer().newRegionName(region, tile, unit, name);</span>
    }

    /**
     * Ask the player to name the new land.
     *
     * Called from IGIH.newLandName.
     *
     * @param defaultName The default name to use.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that has landed.
     */
    public void newLandName(String defaultName, Unit unit) {
<span class="nc" id="L4113">        getGUI().showNamingDialog(</span>
<span class="nc" id="L4114">            StringTemplate.key(&quot;newLand.text&quot;), defaultName, unit,</span>
<span class="nc" id="L4115">            (String name) -&gt; {</span>
<span class="nc bnc" id="L4116" title="All 4 branches missed.">                if (name == null || name.isEmpty()) name = defaultName;</span>
<span class="nc" id="L4117">                nameNewLand(unit, name);</span>
<span class="nc" id="L4118">            });</span>
<span class="nc" id="L4119">    }</span>

    /**
     * Ask the player to name a new region.
     *
     * Called from IGIH.newRegionName.
     *
     * @param region The &lt;code&gt;Region&lt;/code&gt; to name.
     * @param defaultName The default name to use.
     * @param tile The &lt;code&gt;Tile&lt;/code&gt; the unit landed at.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that has landed.
     */
    public void newRegionName(Region region, String defaultName, Tile tile,
                              Unit unit) {
<span class="nc bnc" id="L4133" title="All 2 branches missed.">        if (region.hasName()) {</span>
<span class="nc bnc" id="L4134" title="All 2 branches missed.">            if (region.isPacific()) {</span>
<span class="nc" id="L4135">                getGUI().showEventPanel(Messages.message(&quot;event.discoverPacific&quot;),</span>
<span class="nc" id="L4136">                                   &quot;image.flavor.event.discoverPacific&quot;, null);</span>
            }
<span class="nc" id="L4138">            nameNewRegion(tile, unit, region, defaultName);</span>
<span class="nc" id="L4139">        } else {</span>
<span class="nc" id="L4140">            getGUI().showNamingDialog(</span>
<span class="nc" id="L4141">                StringTemplate.template(&quot;nameRegion.text&quot;)</span>
<span class="nc" id="L4142">                              .addStringTemplate(&quot;%type%&quot;, region.getLabel()),</span>
<span class="nc" id="L4143">                defaultName, unit,</span>
<span class="nc" id="L4144">                (String name) -&gt; {</span>
<span class="nc bnc" id="L4145" title="All 4 branches missed.">                    if (name == null || name.isEmpty()) name = defaultName;</span>
<span class="nc" id="L4146">                    nameNewRegion(tile, unit, region, name);</span>
<span class="nc" id="L4147">                });</span>
        }
<span class="nc" id="L4149">    }</span>

    /**
     * Gets a new trade route for a player.
     *
     * Called from TradeRoutePanel.newRoute.  Relies on new trade routes
     * being added at the end of the trade route list.
     *
     * @param player The &lt;code&gt;Player&lt;/code&gt; to get a new trade route for.
     * @return A new &lt;code&gt;TradeRoute&lt;/code&gt;.
     */
    public TradeRoute newTradeRoute(Player player) {
<span class="nc bnc" id="L4161" title="All 2 branches missed.">        if (player == null) return null;</span>

<span class="nc" id="L4163">        final int n = player.getTradeRouteCount();</span>
<span class="nc bnc" id="L4164" title="All 2 branches missed.">        return (askServer().newTradeRoute(getGame())</span>
<span class="nc bnc" id="L4165" title="All 2 branches missed.">            &amp;&amp; player.getTradeRouteCount() == n + 1)</span>
<span class="nc" id="L4166">            ? player.getNewestTradeRoute()</span>
<span class="nc" id="L4167">            : null;</span>
    }

    /**
     * Switch to a new turn.
     *
     * Called from IGIH.newTurn
     *
     * @param turn The turn number.
     * @return True if the new turn occurs.
     */
    public boolean newTurn(int turn) {
<span class="nc" id="L4179">        final Game game = getGame();</span>
<span class="nc" id="L4180">        final Player player = getMyPlayer();</span>

<span class="nc bnc" id="L4182" title="All 2 branches missed.">        if (turn &lt; 0) {</span>
<span class="nc" id="L4183">            logger.warning(&quot;Bad turn in newTurn: &quot; + turn);</span>
<span class="nc" id="L4184">            return false;</span>
        }
<span class="nc" id="L4186">        Turn newTurn = new Turn(turn);</span>
<span class="nc" id="L4187">        game.setTurn(newTurn);</span>
<span class="nc" id="L4188">        logger.info(&quot;New turn: &quot; + newTurn + &quot;/&quot; + turn);</span>

<span class="nc" id="L4190">        final boolean alert = getClientOptions().getBoolean(ClientOptions.AUDIO_ALERTS);</span>
<span class="nc bnc" id="L4191" title="All 2 branches missed.">        if (alert) sound(&quot;sound.event.alertSound&quot;);</span>

<span class="nc" id="L4193">        final Turn currTurn = game.getTurn();</span>
<span class="nc bnc" id="L4194" title="All 2 branches missed.">        if (currTurn.isFirstSeasonTurn()) {</span>
<span class="nc" id="L4195">            player.addModelMessage(new ModelMessage(MessageType.WARNING,</span>
<span class="nc" id="L4196">                                                    &quot;twoTurnsPerYear&quot;, player)</span>
<span class="nc" id="L4197">                .addStringTemplate(&quot;%year%&quot;, currTurn.getLabel())</span>
<span class="nc" id="L4198">                .addAmount(&quot;%amount%&quot;, currTurn.getSeasonNumber()));</span>
        }
<span class="nc" id="L4200">        player.clearNationCache();</span>
<span class="nc" id="L4201">        return true;</span>
    }

    /**
     * Makes a new unit active.
     *
     * Called from PGC.startGame, ColonyPanel.closeColonyPanel
     *
     * @return True unless it was not our turn.
     */
    public boolean nextActiveUnit() {
<span class="nc bnc" id="L4212" title="All 2 branches missed.">        if (!requireOurTurn()) return false;</span>

<span class="nc" id="L4214">        updateGUI(null);</span>
<span class="nc" id="L4215">        return true;</span>
    }

    /**
     * Displays the next &lt;code&gt;ModelMessage&lt;/code&gt;.
     *
     * Called from CC.reconnect, CargoPanel,
     * ColonyPanel.closeColonyPanel, EuropePanel.exitAction,
     * EuropePanel.MarketPanel
     *
     * @return True if any messages were displayed.
     */
    public boolean nextModelMessage() {
<span class="nc" id="L4228">        return displayModelMessages(false, false);</span>
    }

    /**
     * Pays the tax arrears on this type of goods.
     *
     * Called from CargoPanel, EuropePanel.MarketPanel,
     * EuropePanel.unloadAction, QuickActionMenu
     *
     * @param type The type of goods for which to pay arrears.
     * @return True if the arrears were paid.
     */
    public boolean payArrears(GoodsType type) {
<span class="nc bnc" id="L4241" title="All 4 branches missed.">        if (!requireOurTurn() || type == null) return false;</span>

<span class="nc" id="L4243">        final Player player = getMyPlayer();</span>
<span class="nc" id="L4244">        int arrears = player.getArrears(type);</span>
<span class="nc bnc" id="L4245" title="All 2 branches missed.">        if (arrears &lt;= 0) return false;</span>
<span class="nc bnc" id="L4246" title="All 2 branches missed.">        if (!player.checkGold(arrears)) {</span>
<span class="nc" id="L4247">            getGUI().showInformationMessage(StringTemplate</span>
<span class="nc" id="L4248">                .template(&quot;payArrears.noGold&quot;)</span>
<span class="nc" id="L4249">                    .addAmount(&quot;%amount%&quot;, arrears));</span>
<span class="nc" id="L4250">            return false;</span>
        }

<span class="nc" id="L4253">        StringTemplate t = StringTemplate.template(&quot;payArrears.text&quot;)</span>
<span class="nc" id="L4254">            .addAmount(&quot;%amount%&quot;, arrears);</span>
<span class="nc bnc" id="L4255" title="All 2 branches missed.">        if (!getGUI().confirm(null, t, type, &quot;ok&quot;, &quot;cancel&quot;)) return false;</span>

<span class="nc bnc" id="L4257" title="All 2 branches missed.">        boolean ret = askServer().payArrears(getGame(), type)</span>
<span class="nc bnc" id="L4258" title="All 2 branches missed.">            &amp;&amp; player.canTrade(type);</span>
<span class="nc bnc" id="L4259" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc" id="L4260">            updateGUI(null);</span>
        }
<span class="nc" id="L4262">        return ret;</span>
    }

    /**
     * Buys the remaining hammers and tools for the {@link Building} currently
     * being built in the given &lt;code&gt;Colony&lt;/code&gt;.
     *
     * Called from BuildQueuePanel
     *
     * @param colony The &lt;code&gt;Colony&lt;/code&gt; where the building should be
     *     bought.
     * @return True if the building was bought.
     */
    public boolean payForBuilding(Colony colony) {
<span class="nc bnc" id="L4276" title="All 4 branches missed.">        if (!requireOurTurn() || colony == null) return false;</span>

<span class="nc bnc" id="L4278" title="All 2 branches missed.">        if (!getSpecification().getBoolean(GameOptions.PAY_FOR_BUILDING)) {</span>
<span class="nc" id="L4279">            getGUI().showInformationMessage(&quot;payForBuilding.disabled&quot;);</span>
<span class="nc" id="L4280">            return false;</span>
        }

<span class="nc bnc" id="L4283" title="All 2 branches missed.">        if (!colony.canPayToFinishBuilding()) {</span>
<span class="nc" id="L4284">            getGUI().showInformationMessage(&quot;info.notEnoughGold&quot;);</span>
<span class="nc" id="L4285">            return false;</span>
        }

<span class="nc" id="L4288">        final int price = colony.getPriceForBuilding();</span>
<span class="nc" id="L4289">        StringTemplate t = StringTemplate.template(&quot;payForBuilding.text&quot;)</span>
<span class="nc" id="L4290">            .addAmount(&quot;%amount%&quot;, price);</span>
<span class="nc bnc" id="L4291" title="All 2 branches missed.">        if (!getGUI().confirm(null, t, colony, &quot;yes&quot;, &quot;no&quot;)) return false;</span>

<span class="nc" id="L4293">        ColonyWas colonyWas = new ColonyWas(colony);</span>
<span class="nc bnc" id="L4294" title="All 2 branches missed.">        boolean ret = askServer().payForBuilding(colony)</span>
<span class="nc bnc" id="L4295" title="All 2 branches missed.">            &amp;&amp; colony.getPriceForBuilding() == 0;</span>
<span class="nc bnc" id="L4296" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc" id="L4297">            colonyWas.fireChanges();</span>
<span class="nc" id="L4298">            updateGUI(null);</span>
        }
<span class="nc" id="L4300">        return ret;</span>
    }

    /**
     * Puts the specified unit outside the colony.
     *
     * Called from ColonyPanel.OutsideColonyPanel, UnitLabel
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt;
     * @return True if the unit was successfully put outside the colony.
     */
    public boolean putOutsideColony(Unit unit) {
        Colony colony;
<span class="nc bnc" id="L4313" title="All 4 branches missed.">        if (!requireOurTurn() || unit == null</span>
<span class="nc bnc" id="L4314" title="All 2 branches missed.">            || (colony = unit.getColony()) == null) return false;</span>

<span class="nc bnc" id="L4316" title="All 2 branches missed.">        if (!getGUI().confirmLeaveColony(unit)) return false;</span>

<span class="nc" id="L4318">        ColonyWas colonyWas = new ColonyWas(colony);</span>
<span class="nc" id="L4319">        UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc bnc" id="L4320" title="All 2 branches missed.">        boolean ret = askServer().putOutsideColony(unit)</span>
<span class="nc bnc" id="L4321" title="All 2 branches missed.">            &amp;&amp; unit.getLocation() == colony.getTile();</span>
<span class="nc bnc" id="L4322" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc" id="L4323">            colonyWas.fireChanges();</span>
<span class="nc" id="L4324">            unitWas.fireChanges();</span>
<span class="nc" id="L4325">            updateGUI(null);</span>
        }
<span class="nc" id="L4327">        return ret;</span>
    }

    /**
     * Query whether the user wants to reconnect?
     *
     * Called from ReconnectAction, IGIH.reconnectRunnable
     *
     * Returns no status, this game is going away.
     */
    public void reconnect() {
<span class="nc bnc" id="L4338" title="All 2 branches missed.">        if (getGUI().confirm(&quot;reconnect.text&quot;, &quot;reconnect.no&quot;, &quot;reconnect.yes&quot;)) {</span>
<span class="nc" id="L4339">            logger.finest(&quot;Reconnect quit.&quot;);</span>
<span class="nc" id="L4340">            getFreeColClient().quit();</span>
<span class="nc" id="L4341">        } else {</span>
<span class="nc" id="L4342">            logger.finest(&quot;Reconnect accepted.&quot;);</span>
<span class="nc" id="L4343">            getConnectController().reconnect();</span>
        }
<span class="nc" id="L4345">    }</span>

    /**
     * Recruit a unit from a specified index in Europe.
     *
     * Called from RecruitPanel
     *
     * @param index The index in Europe to recruit from, [0..RECRUIT_COUNT).
     * @return True if a unit was recruited.
     */
    public boolean recruitUnitInEurope(int index) {
<span class="nc bnc" id="L4356" title="All 2 branches missed.">        if (!requireOurTurn()</span>
<span class="nc bnc" id="L4357" title="All 2 branches missed.">            || !MigrationType.validMigrantIndex(index)) return false;</span>

<span class="nc" id="L4359">        final Player player = getMyPlayer();</span>
<span class="nc bnc" id="L4360" title="All 2 branches missed.">        if (!player.isColonial()) return false;</span>

<span class="nc bnc" id="L4362" title="All 2 branches missed.">        if (!player.checkGold(player.getRecruitPrice())) {</span>
<span class="nc" id="L4363">            getGUI().showInformationMessage(&quot;info.notEnoughGold&quot;);</span>
<span class="nc" id="L4364">            return false;</span>
        }

<span class="nc" id="L4367">        Unit newUnit = askEmigrate(player.getEurope(),</span>
<span class="nc" id="L4368">                                   MigrationType.migrantIndexToSlot(index));</span>
<span class="nc bnc" id="L4369" title="All 2 branches missed.">        if (newUnit != null) {</span>
<span class="nc" id="L4370">            player.setNextActiveUnit(newUnit);</span>
<span class="nc" id="L4371">            getGUI().setActiveUnit(newUnit);</span>
<span class="nc" id="L4372">            updateGUI(null);</span>
        }
<span class="nc bnc" id="L4374" title="All 2 branches missed.">        return newUnit != null;</span>
    }

    /**
     * Remove game objects.
     *
     * Called from IGIH.remove().
     *
     * @param objects A list of &lt;code&gt;FreeColGameObject&lt;/code&gt;s to remove.
     * @param divert An object to divert to when the original disappears.
     */
    public void remove(List&lt;FreeColGameObject&gt; objects,
                       FreeColGameObject divert) {
<span class="nc" id="L4387">        final Player player = getMyPlayer();</span>
<span class="nc" id="L4388">        boolean visibilityChange = false;</span>
<span class="nc bnc" id="L4389" title="All 2 branches missed.">        for (FreeColGameObject fcgo : objects) {</span>
<span class="nc bnc" id="L4390" title="All 2 branches missed.">            if (divert != null) player.divertModelMessages(fcgo, divert);</span>
        
<span class="nc bnc" id="L4392" title="All 2 branches missed.">            if (fcgo instanceof Settlement) {</span>
<span class="nc" id="L4393">                Settlement settlement = (Settlement)fcgo;</span>
<span class="nc bnc" id="L4394" title="All 4 branches missed.">                if (settlement != null &amp;&amp; settlement.getOwner() != null) {</span>
<span class="nc" id="L4395">                    settlement.getOwner().removeSettlement(settlement);</span>
                }
<span class="nc" id="L4397">                visibilityChange = true;//-vis(player)</span>
                
<span class="nc bnc" id="L4399" title="All 2 branches missed.">            } else if (fcgo instanceof Unit) {</span>
                // Deselect the object if it is the current active unit.
<span class="nc" id="L4401">                Unit u = (Unit)fcgo;</span>
<span class="nc bnc" id="L4402" title="All 2 branches missed.">                if (u == getGUI().getActiveUnit()) getGUI().setActiveUnit(null);</span>

                // Temporary hack until we have real containers.
<span class="nc bnc" id="L4405" title="All 4 branches missed.">                if (u != null &amp;&amp; u.getOwner() != null) {</span>
<span class="nc" id="L4406">                    u.getOwner().removeUnit(u);</span>
                }
<span class="nc" id="L4408">                visibilityChange = true;//-vis(player)</span>
            }

            // Do just the low level dispose that removes
            // reference to this object in the client.  The other
            // updates should have done the rest.
<span class="nc" id="L4414">            fcgo.disposeResources();</span>
        }
<span class="nc bnc" id="L4416" title="All 2 branches missed.">        if (visibilityChange) player.invalidateCanSeeTiles();//+vis(player)</span>

<span class="nc" id="L4418">        getGUI().refresh();</span>
<span class="nc" id="L4419">    }</span>
        
    /**
     * Renames a &lt;code&gt;Nameable&lt;/code&gt;.
     *
     * Apparently this can be done while it is not your turn.
     *
     * Called from RenameAction, TilePopup.
     *
     * @param object The object to rename.
     * @return True if the object was renamed.
     */
    public boolean rename(Nameable object) {
<span class="nc" id="L4432">        final Player player = getMyPlayer();</span>
<span class="nc bnc" id="L4433" title="All 2 branches missed.">        if (!(object instanceof Ownable)</span>
<span class="nc bnc" id="L4434" title="All 2 branches missed.">            || !player.owns((Ownable)object)) return false;</span>

<span class="nc" id="L4436">        String name = null;</span>
<span class="nc bnc" id="L4437" title="All 2 branches missed.">        if (object instanceof Colony) {</span>
<span class="nc" id="L4438">            Colony colony = (Colony) object;</span>
<span class="nc" id="L4439">            name = getGUI().getInput(colony.getTile(),</span>
<span class="nc" id="L4440">                                StringTemplate.key(&quot;renameColony.text&quot;),</span>
<span class="nc" id="L4441">                                colony.getName(), &quot;rename&quot;, &quot;cancel&quot;);</span>
<span class="nc bnc" id="L4442" title="All 2 branches missed.">            if (name == null) { // User cancelled</span>
<span class="nc" id="L4443">                return false;</span>
<span class="nc bnc" id="L4444" title="All 2 branches missed.">            } else if (name.isEmpty()) { // Zero length invalid</span>
<span class="nc" id="L4445">                getGUI().showInformationMessage(&quot;info.enterSomeText&quot;);</span>
<span class="nc" id="L4446">                return false;</span>
<span class="nc bnc" id="L4447" title="All 2 branches missed.">            } else if (colony.getName().equals(name)) { // No change</span>
<span class="nc" id="L4448">                return false;</span>
<span class="nc bnc" id="L4449" title="All 2 branches missed.">            } else if (player.getSettlementByName(name) != null) {</span>
                // Colony name must be unique.
<span class="nc" id="L4451">                getGUI().showInformationMessage((Colony)object, StringTemplate</span>
<span class="nc" id="L4452">                    .template(&quot;nameColony.notUnique&quot;)</span>
<span class="nc" id="L4453">                    .addName(&quot;%name%&quot;, name));</span>
<span class="nc" id="L4454">                return false;</span>
            }
<span class="nc bnc" id="L4456" title="All 2 branches missed.">        } else if (object instanceof Unit) {</span>
<span class="nc" id="L4457">            Unit unit = (Unit) object;</span>
<span class="nc" id="L4458">            name = getGUI().getInput(unit.getTile(),</span>
<span class="nc" id="L4459">                                StringTemplate.key(&quot;renameUnit.text&quot;),</span>
<span class="nc" id="L4460">                                unit.getName(), &quot;rename&quot;, &quot;cancel&quot;);</span>
<span class="nc bnc" id="L4461" title="All 2 branches missed.">            if (name == null) return false; // User cancelled</span>
        } else {
<span class="nc" id="L4463">            logger.warning(&quot;Tried to rename an unsupported Nameable: &quot;</span>
<span class="nc" id="L4464">                + object);</span>
<span class="nc" id="L4465">            return false;</span>
        }

<span class="nc bnc" id="L4468" title="All 2 branches missed.">        if (askServer().rename((FreeColGameObject)object, name)) {</span>
<span class="nc" id="L4469">            updateGUI(null);</span>
<span class="nc" id="L4470">            return true;</span>
        }
<span class="nc" id="L4472">        return false;</span>
    }

    /**
     * Opens a dialog where the user should specify the filename and
     * saves the game.
     *
     * Called from SaveAction and SaveAndQuitAction.
     *
     * @return True if the game was saved.
     */
    public boolean saveGame() {
<span class="nc bnc" id="L4484" title="All 2 branches missed.">        if (!getFreeColClient().canSaveCurrentGame()) return false;</span>

<span class="nc" id="L4486">        final Game game = getGame();</span>
<span class="nc bnc" id="L4487" title="All 2 branches missed.">        if (game == null) return false; // Keyboard handling can race init</span>
<span class="nc" id="L4488">        String fileName = getSaveGameString(game);</span>
<span class="nc" id="L4489">        File file = getGUI().showSaveDialog(FreeColDirectories.getSaveDirectory(),</span>
<span class="nc" id="L4490">                                       fileName);</span>
<span class="nc bnc" id="L4491" title="All 2 branches missed.">        if (file == null) return false;</span>
<span class="nc bnc" id="L4492" title="All 2 branches missed.">        if (!getClientOptions().getBoolean(ClientOptions.CONFIRM_SAVE_OVERWRITE)</span>
<span class="nc bnc" id="L4493" title="All 2 branches missed.">            || !file.exists()</span>
<span class="nc" id="L4494">            || getGUI().confirm(&quot;saveConfirmationDialog.areYouSure.text&quot;,</span>
<span class="nc bnc" id="L4495" title="All 2 branches missed.">                           &quot;ok&quot;, &quot;cancel&quot;)) {</span>
<span class="nc" id="L4496">            FreeColDirectories.setSavegameFile(file.getPath());</span>
<span class="nc" id="L4497">            return saveGame(file);</span>
        }
<span class="nc" id="L4499">        return false;</span>
    }

    /**
     * Display the results of speaking to a chief.
     *
     * Called from IGIH.scoutSpeakToChief.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that was speaking.
     * @param settlement The &lt;code&gt;IndianSettlement&lt;/code&gt; spoken to.
     * @param result The result.
     */
    public void scoutSpeakToChief(Unit unit, IndianSettlement settlement,
                                  String result) {
<span class="nc bnc" id="L4513" title="All 16 branches missed.">        switch (result) {</span>
        case &quot;&quot;:
            break;
        case &quot;die&quot;:
<span class="nc" id="L4517">            getGUI().showInformationMessage(settlement,</span>
<span class="nc" id="L4518">                &quot;scoutSettlement.speakDie&quot;);</span>
<span class="nc" id="L4519">            break;</span>
        case &quot;expert&quot;:
<span class="nc" id="L4521">            getGUI().showInformationMessage(settlement, StringTemplate</span>
<span class="nc" id="L4522">                .template(&quot;scoutSettlement.expertScout&quot;)</span>
<span class="nc" id="L4523">                .addNamed(&quot;%unit%&quot;, unit.getType()));</span>
<span class="nc" id="L4524">            break;</span>
        case &quot;tales&quot;:
<span class="nc" id="L4526">            getGUI().showInformationMessage(settlement,</span>
<span class="nc" id="L4527">                &quot;scoutSettlement.speakTales&quot;);</span>
<span class="nc" id="L4528">            break;</span>
        case &quot;nothing&quot;:
<span class="nc" id="L4530">            getGUI().showInformationMessage(settlement, StringTemplate</span>
<span class="nc" id="L4531">                .template(&quot;scoutSettlement.speakNothing&quot;)</span>
<span class="nc" id="L4532">                .addStringTemplate(&quot;%nation%&quot;, unit.getOwner().getNationLabel()));</span>
<span class="nc" id="L4533">            break;</span>
        default: // result == amount of gold
<span class="nc" id="L4535">            getGUI().showInformationMessage(settlement, StringTemplate</span>
<span class="nc" id="L4536">                .template(&quot;scoutSettlement.speakBeads&quot;)</span>
<span class="nc" id="L4537">                .add(&quot;%amount%&quot;, result));</span>
            break;
        }
<span class="nc" id="L4540">    }</span>
    
    /**
     * Selects a destination for this unit. Europe and the player's
     * colonies are valid destinations.
     *
     * Called from GotoAction.
     *
     * @param unit The unit for which to select a destination.
     * @return True if the destination change succeeds.
     */
    public boolean selectDestination(Unit unit) {
<span class="nc bnc" id="L4552" title="All 4 branches missed.">        if (!requireOurTurn() || unit == null) return false;</span>

<span class="nc bnc" id="L4554" title="All 2 branches missed.">        if (!getGUI().confirmClearTradeRoute(unit)) return false;</span>
<span class="nc" id="L4555">        Location destination = getGUI().showSelectDestinationDialog(unit);</span>
<span class="nc bnc" id="L4556" title="All 2 branches missed.">        if (destination == null) return false;</span>

<span class="nc" id="L4558">        UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc" id="L4559">        boolean ret = askSetDestination(unit, destination);</span>
<span class="nc bnc" id="L4560" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc bnc" id="L4561" title="All 2 branches missed.">            if (destination instanceof Europe) {</span>
<span class="nc bnc" id="L4562" title="All 2 branches missed.">                if (unit.hasTile()</span>
<span class="nc bnc" id="L4563" title="All 2 branches missed.">                    &amp;&amp; unit.getTile().isDirectlyHighSeasConnected()) {</span>
<span class="nc" id="L4564">                    moveTo(unit, destination);</span>
<span class="nc" id="L4565">                } else {</span>
<span class="nc" id="L4566">                    moveToDestination(unit, null);</span>
                }
<span class="nc" id="L4568">            } else {</span>
<span class="nc bnc" id="L4569" title="All 2 branches missed.">                if (unit.isInEurope()) {</span>
<span class="nc" id="L4570">                    moveTo(unit, destination);</span>
<span class="nc" id="L4571">                } else {</span>
<span class="nc" id="L4572">                    moveToDestination(unit, null);</span>
                }
            }
<span class="nc" id="L4575">            unitWas.fireChanges();</span>
<span class="nc" id="L4576">            updateGUI(null);</span>
        }
<span class="nc" id="L4578">        return ret;</span>
    }

    /**
     * Sells goods in Europe.
     *
     * Called from EuropePanel.MarketPanel, EuropePanel.unloadAction,
     * unload(), unloadCargo()
     *
     * @param goods The goods to be sold.
     * @return True if the sale succeeds.
     */
    public boolean sellGoods(Goods goods) {
<span class="nc bnc" id="L4591" title="All 4 branches missed.">        if (!requireOurTurn() || goods == null</span>
<span class="nc bnc" id="L4592" title="All 2 branches missed.">            || !(goods.getLocation() instanceof Unit)) return false;</span>

<span class="nc" id="L4594">        final Player player = getMyPlayer();</span>
<span class="nc" id="L4595">        Unit carrier = (Unit)goods.getLocation();</span>

<span class="nc" id="L4597">        Europe europe = player.getEurope();</span>
<span class="nc" id="L4598">        EuropeWas europeWas = new EuropeWas(europe);</span>
<span class="nc" id="L4599">        UnitWas unitWas = new UnitWas(carrier);</span>
<span class="nc" id="L4600">        boolean ret = askUnloadGoods(goods.getType(), goods.getAmount(), carrier);</span>
<span class="nc bnc" id="L4601" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc" id="L4602">            sound(&quot;sound.event.sellCargo&quot;);</span>
<span class="nc" id="L4603">            europeWas.fireChanges();</span>
<span class="nc" id="L4604">            unitWas.fireChanges();</span>
<span class="nc" id="L4605">            updateGUI(null);</span>
        }
<span class="nc" id="L4607">        return ret;</span>
    }

    /**
     * Sends a public chat message.
     *
     * Called from ChatPanel
     *
     * @param chat The text of the message.
     * @return True if the message was sent.
     */
    public boolean sendChat(String chat) {
<span class="nc bnc" id="L4619" title="All 2 branches missed.">        if (chat == null) return false;</span>

<span class="nc" id="L4621">        return askServer().chat(getMyPlayer(), chat);</span>
    }

    /**
     * Changes the current construction project of a &lt;code&gt;Colony&lt;/code&gt;.
     *
     * Called from BuildQueuePanel
     *
     * @param colony The &lt;code&gt;Colony&lt;/code&gt;
     * @param buildQueue List of &lt;code&gt;BuildableType&lt;/code&gt;
     * @return True if the build queue was changed.
     */
    public boolean setBuildQueue(Colony colony,
                                 List&lt;BuildableType&gt; buildQueue) {
<span class="nc bnc" id="L4635" title="All 4 branches missed.">        if (!requireOurTurn() || colony == null</span>
<span class="nc bnc" id="L4636" title="All 2 branches missed.">            || buildQueue == null) return false;</span>

<span class="nc" id="L4638">        ColonyWas colonyWas = new ColonyWas(colony);</span>
<span class="nc" id="L4639">        boolean ret = askServer().setBuildQueue(colony, buildQueue);</span>
<span class="nc bnc" id="L4640" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc" id="L4641">            colonyWas.fireChanges();</span>
<span class="nc" id="L4642">            updateGUI(null);</span>
        }
<span class="nc" id="L4644">        return ret;</span>
    }

    /**
     * Set a player to be the new current player.
     *
     * Called from IGIH.newTurn, IGIH.setCurrentPlayer, CC.login
     *
     * @param player The &lt;code&gt;Player&lt;/code&gt; to be the new current player.
     * @return True if the current player changes.
     */
    public boolean setCurrentPlayer(Player player) {
<span class="nc bnc" id="L4656" title="All 2 branches missed.">        if (FreeColDebugger.isInDebugMode(FreeColDebugger.DebugMode.MENUS)</span>
<span class="nc bnc" id="L4657" title="All 2 branches missed.">            &amp;&amp; currentPlayerIsMyPlayer()) {</span>
<span class="nc" id="L4658">            getGUI().closeMenus();</span>
        }

<span class="nc" id="L4661">        final Game game = getGame();</span>
<span class="nc" id="L4662">        game.setCurrentPlayer(player);</span>

<span class="nc bnc" id="L4664" title="All 2 branches missed.">        if (getMyPlayer().equals(player)) {</span>
<span class="nc" id="L4665">            FreeColDebugger.finishDebugRun(getFreeColClient(), false);</span>
<span class="nc bnc" id="L4666" title="All 2 branches missed.">            if (FreeColDebugger.isInDebugMode(FreeColDebugger.DebugMode.DESYNC)</span>
<span class="nc bnc" id="L4667" title="All 2 branches missed.">                &amp;&amp; DebugUtils.checkDesyncAction(getFreeColClient())) {</span>
<span class="nc" id="L4668">                getConnectController().reconnect();</span>
<span class="nc" id="L4669">                return false;</span>
            }

            // Save the game (if it isn't newly loaded)
<span class="nc bnc" id="L4673" title="All 2 branches missed.">            if (getFreeColServer() != null</span>
<span class="nc bnc" id="L4674" title="All 2 branches missed.">                &amp;&amp; game.getTurn().getNumber() &gt; 0) autoSaveGame();</span>

            // Get turn report out quickly before more message display occurs.
<span class="nc" id="L4677">            player.removeDisplayedModelMessages();</span>
<span class="nc" id="L4678">            displayModelMessages(true, true);</span>

<span class="nc" id="L4680">            player.invalidateCanSeeTiles();</span>

            // Check for emigration.
<span class="nc" id="L4683">            Europe europe = player.getEurope();</span>
<span class="nc bnc" id="L4684" title="All 2 branches missed.">            if (player.hasAbility(Ability.SELECT_RECRUIT)) {</span>
<span class="nc" id="L4685">                emigration(player, 0, false);</span>
<span class="nc" id="L4686">            } else {</span>
<span class="nc bnc" id="L4687" title="All 2 branches missed.">                while (player.checkEmigrate()) {</span>
<span class="nc" id="L4688">                    askEmigrate(europe,</span>
<span class="nc" id="L4689">                        Europe.MigrationType.getUnspecificSlot());</span>
                }
            }
            
            // Wake up human!
<span class="nc bnc" id="L4694" title="All 2 branches missed.">            if (!getFreeColClient().isSinglePlayer()) {</span>
<span class="nc" id="L4695">                sound(&quot;sound.anthem.&quot; + player.getNationId());</span>
            }

<span class="nc" id="L4698">            player.resetIterators();</span>
<span class="nc" id="L4699">            updateGUI(player.getFallbackTile());</span>
        }
<span class="nc" id="L4701">        return true;</span>
    }

    /**
     * Set a player to be dead.
     *
     * Called from IGIH.setDead
     *
     * @param dead The dead &lt;code&gt;Player&lt;/code&gt;.
     * @return True if the player is marked as dead.
     */
    public boolean setDead(Player dead) {
<span class="nc bnc" id="L4713" title="All 2 branches missed.">        if (dead == null) return false;</span>

<span class="nc" id="L4715">        final Player player = getMyPlayer();</span>
<span class="nc bnc" id="L4716" title="All 2 branches missed.">        if (player == dead) {</span>
<span class="nc" id="L4717">            FreeColDebugger.finishDebugRun(getFreeColClient(), true);</span>
<span class="nc bnc" id="L4718" title="All 2 branches missed.">            if (getFreeColClient().isSinglePlayer()) {</span>
<span class="nc bnc" id="L4719" title="All 2 branches missed.">                if (player.getPlayerType() == Player.PlayerType.RETIRED) {</span>
                    ; // Do nothing, retire routine will quit

<span class="nc bnc" id="L4722" title="All 2 branches missed.">                } else if (player.getPlayerType() != Player.PlayerType.UNDEAD</span>
<span class="nc" id="L4723">                    &amp;&amp; getGUI().confirm(&quot;defeatedSinglePlayer.text&quot;,</span>
<span class="nc bnc" id="L4724" title="All 2 branches missed.">                                   &quot;defeatedSinglePlayer.yes&quot;, &quot;quit&quot;)) {</span>
<span class="nc" id="L4725">                    askServer().enterRevengeMode(getGame());</span>
<span class="nc" id="L4726">                } else {</span>
<span class="nc" id="L4727">                    getFreeColClient().quit();</span>
                }
<span class="nc" id="L4729">            } else {</span>
<span class="nc" id="L4730">                if (!getGUI().confirm(&quot;defeated.text&quot;, &quot;defeated.yes&quot;,</span>
<span class="nc bnc" id="L4731" title="All 2 branches missed.">                                 &quot;quit&quot;)) getFreeColClient().quit();</span>
            }
<span class="nc" id="L4733">        } else {</span>
<span class="nc" id="L4734">            player.setStance(dead, null);</span>
        }
<span class="nc" id="L4736">        return true;</span>
    }

    /**
     * Informs this controller that a game has been newly loaded.
     *
     * Called from ConnectController.startSavedGame
     *
     * No status returned to connect controller.
     */
    public void setGameConnected () {
<span class="nc" id="L4747">        final Player player = getMyPlayer();</span>
<span class="nc bnc" id="L4748" title="All 2 branches missed.">        if (player != null) {</span>
<span class="nc" id="L4749">            player.refilterModelMessages(getClientOptions());</span>
        }
<span class="nc" id="L4751">    }</span>

    /**
     * Sets the export settings of the custom house.
     *
     * Called from WarehouseDialog
     *
     * @param colony The colony with the custom house.
     * @param goodsType The goods for which to set the settings.
     * @return True if the levels were set.
     */
    public boolean setGoodsLevels(Colony colony, GoodsType goodsType) {
<span class="nc bnc" id="L4763" title="All 4 branches missed.">        if (colony == null || goodsType == null) return false;</span>

<span class="nc" id="L4765">        return askServer().setGoodsLevels(colony,</span>
<span class="nc" id="L4766">                                          colony.getExportData(goodsType));</span>
    }

    /**
     * Sets the debug mode to include the extra menu commands.
     *
     * Called from DebugAction
     *
     * @return True, always succeeds.
     */
    public boolean setInDebugMode() {
<span class="nc" id="L4777">        FreeColDebugger.enableDebugMode(FreeColDebugger.DebugMode.MENUS);</span>
<span class="nc" id="L4778">        updateGUI(null);</span>
<span class="nc" id="L4779">        return true;</span>
    }

    /**
     * Notify the player that the stance between two players has changed.
     *
     * Called from IGIH.setStance
     *
     * @param stance The changed &lt;code&gt;Stance&lt;/code&gt;.
     * @param first The first &lt;code&gt;Player&lt;/code&gt;.
     * @param second The second &lt;code&gt;Player&lt;/code&gt;.
     * @return True if the stance change succeeds.
     */
    public boolean setStance(Stance stance, Player first, Player second) {
<span class="nc bnc" id="L4793" title="All 6 branches missed.">        if (stance == null || first == null || second == null) return false;</span>

<span class="nc" id="L4795">        final Player player = getMyPlayer();</span>
<span class="nc" id="L4796">        Stance old = first.getStance(second);</span>
        try {
<span class="nc" id="L4798">            first.setStance(second, stance);</span>
<span class="nc" id="L4799">        } catch (IllegalStateException e) {</span>
<span class="nc" id="L4800">            logger.log(Level.WARNING, &quot;Illegal stance transition&quot;, e);</span>
<span class="nc" id="L4801">            return false;</span>
        }
<span class="nc bnc" id="L4803" title="All 4 branches missed.">        if (player == first &amp;&amp; old == Stance.UNCONTACTED) {</span>
<span class="nc" id="L4804">            sound(&quot;sound.event.meet.&quot; + second.getNationId());</span>
        }
<span class="nc" id="L4806">        return true;</span>
    }

    /**
     * Spy on a colony.
     *
     * Called from IGIH.spyResult.
     *
     * @param tile A special copy of the &lt;code&gt;Tile&lt;/code&gt; with the colony.
     */
    public void spyColony(Tile tile) {
<span class="nc" id="L4817">        getGUI().showSpyColonyPanel(tile);</span>
<span class="nc" id="L4818">    }</span>
    
    /**
     * Trains a unit of a specified type in Europe.
     *
     * Called from NewUnitPanel
     *
     * @param unitType The type of unit to be trained.
     * @return True if a new unit was trained.
     */
    public boolean trainUnitInEurope(UnitType unitType) {
<span class="nc bnc" id="L4829" title="All 4 branches missed.">        if (!requireOurTurn() || unitType == null) return false;</span>

<span class="nc" id="L4831">        final Player player = getMyPlayer();</span>
<span class="nc" id="L4832">        final Europe europe = player.getEurope();</span>
<span class="nc bnc" id="L4833" title="All 2 branches missed.">        if (!player.checkGold(europe.getUnitPrice(unitType))) {</span>
<span class="nc" id="L4834">            getGUI().showInformationMessage(&quot;info.notEnoughGold&quot;);</span>
<span class="nc" id="L4835">            return false;</span>
        }

<span class="nc" id="L4838">        EuropeWas europeWas = new EuropeWas(europe);</span>
<span class="nc" id="L4839">        Unit newUnit = null;</span>
<span class="nc bnc" id="L4840" title="All 2 branches missed.">        boolean ret = askServer().trainUnitInEurope(getGame(), unitType)</span>
<span class="nc bnc" id="L4841" title="All 2 branches missed.">            &amp;&amp; (newUnit = europeWas.getNewUnit()) != null;</span>
<span class="nc bnc" id="L4842" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc" id="L4843">            europeWas.fireChanges();</span>
<span class="nc" id="L4844">            player.setNextActiveUnit(newUnit);</span>
<span class="nc" id="L4845">            getGUI().setActiveUnit(newUnit);</span>
<span class="nc" id="L4846">            updateGUI(null);</span>
        }
<span class="nc" id="L4848">        return ret;</span>
    }

    /**
     * Unload, including dumping cargo.
     *
     * Called from UnloadAction, UnitLabel
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is dumping.
     * @return True if the unit unloaded.
     */
    public boolean unload(Unit unit) {
<span class="nc bnc" id="L4860" title="All 4 branches missed.">        if (!requireOurTurn() || unit == null</span>
<span class="nc bnc" id="L4861" title="All 2 branches missed.">            || !unit.isCarrier()) return false;</span>

<span class="nc" id="L4863">        boolean ret = true;</span>
<span class="nc" id="L4864">        Colony colony = unit.getColony();</span>
<span class="nc bnc" id="L4865" title="All 2 branches missed.">        if (colony != null) { // In colony, unload units and goods.</span>
<span class="nc bnc" id="L4866" title="All 2 branches missed.">            for (Unit u : unit.getUnitList()) {</span>
<span class="nc bnc" id="L4867" title="All 4 branches missed.">                ret = leaveShip(u) &amp;&amp; ret;</span>
            }
<span class="nc bnc" id="L4869" title="All 2 branches missed.">            for (Goods goods : unit.getGoodsList()) {</span>
<span class="nc bnc" id="L4870" title="All 4 branches missed.">                ret = unloadCargo(goods, false) &amp;&amp; ret;</span>
            }
<span class="nc bnc" id="L4872" title="All 2 branches missed.">        } else if (unit.isInEurope()) { // In Europe, unload non-boycotted goods</span>
<span class="nc" id="L4873">            final Player player = getMyPlayer();</span>
<span class="nc bnc" id="L4874" title="All 2 branches missed.">            for (Goods goods : unit.getCompactGoodsList()) {</span>
<span class="nc bnc" id="L4875" title="All 2 branches missed.">                if (player.canTrade(goods.getType())) {</span>
<span class="nc bnc" id="L4876" title="All 4 branches missed.">                    ret = sellGoods(goods) &amp;&amp; ret;</span>
                }
            }
<span class="nc bnc" id="L4879" title="All 2 branches missed.">            if (unit.hasGoodsCargo()) { // Goods left here must be dumped.</span>
<span class="nc" id="L4880">                getGUI().showDumpCargoDialog(unit,</span>
<span class="nc" id="L4881">                    (List&lt;Goods&gt; goodsList) -&gt; {</span>
<span class="nc bnc" id="L4882" title="All 2 branches missed.">                        for (Goods g : goodsList) unloadCargo(g, true);</span>
<span class="nc" id="L4883">                    });</span>
<span class="nc" id="L4884">                return false;</span>
            }
        } else { // Dump goods, units dislike jumping overboard
<span class="nc bnc" id="L4887" title="All 2 branches missed.">            for (Goods goods : unit.getGoodsList()) {</span>
<span class="nc bnc" id="L4888" title="All 4 branches missed.">                ret = unloadCargo(goods, false) &amp;&amp; ret;</span>
            }
        }
<span class="nc" id="L4891">        return ret;</span>
    }

    /**
     * Unload cargo.  If the unit carrying the cargo is not in a
     * harbour, or if the given boolean is true, the goods will be
     * dumped.
     *
     * Called from CargoPanel, ColonyPanel, EuropePanel.MarketPanel,
     * GUI.showDumpCargoDialog, QuickActionMenu, unload()
     *
     * @param goods The &lt;code&gt;Goods&lt;/code&gt; to unload.
     * @param dump If true, dump the goods.
     * @return True if the unload succeeds.
     */
    public boolean unloadCargo(Goods goods, boolean dump) {
<span class="nc bnc" id="L4907" title="All 4 branches missed.">        if (!requireOurTurn() || goods == null</span>
<span class="nc bnc" id="L4908" title="All 2 branches missed.">            || goods.getAmount() &lt;= 0</span>
<span class="nc bnc" id="L4909" title="All 2 branches missed.">            || !(goods.getLocation() instanceof Unit)) return false;</span>

        // Find the carrier
<span class="nc" id="L4912">        final Unit carrier = (Unit)goods.getLocation();</span>

        // Use Europe-specific routine if needed
<span class="nc bnc" id="L4915" title="All 2 branches missed.">        if (carrier.isInEurope()) return sellGoods(goods);</span>

        // Check for a colony
<span class="nc" id="L4918">        final Colony colony = carrier.getColony();</span>

        // Unload
<span class="nc bnc" id="L4921" title="All 2 branches missed.">        ColonyWas colonyWas = (colony == null) ? null : new ColonyWas(colony);</span>
<span class="nc" id="L4922">        UnitWas unitWas = new UnitWas(carrier);</span>
<span class="nc" id="L4923">        boolean ret = askUnloadGoods(goods.getType(), goods.getAmount(), carrier);</span>
<span class="nc bnc" id="L4924" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc bnc" id="L4925" title="All 2 branches missed.">            if (!dump) sound(&quot;sound.event.unloadCargo&quot;);</span>
<span class="nc bnc" id="L4926" title="All 2 branches missed.">            if (colonyWas != null) colonyWas.fireChanges();</span>
<span class="nc" id="L4927">            unitWas.fireChanges();</span>
<span class="nc" id="L4928">            updateGUI(null);</span>
        }
<span class="nc" id="L4930">        return ret;</span>
    }

    /**
     * Updates a trade route.
     *
     * Called from TradeRoutePanel(), TradeRoutePanel.newRoute
     *
     * @param route The trade route to update.
     * @return True if the trade route was updated.
     */
    public boolean updateTradeRoute(TradeRoute route) {
<span class="nc bnc" id="L4942" title="All 2 branches missed.">        if (route == null) return false;</span>

<span class="nc" id="L4944">        return askServer().updateTradeRoute(route);</span>
    }

    /**
     * The player has won, show the high scores and victory dialog.
     *
     * Called from IGIH.gameEnded.
     *
     * @param score If &quot;true&quot;, a new high score was reached.
     */
    public void victory(String score) {
<span class="nc" id="L4955">        displayHighScores(&quot;true&quot;.equalsIgnoreCase(score));</span>
<span class="nc" id="L4956">        getGUI().showVictoryDialog((Boolean result) -&gt; victory(result));</span>
<span class="nc" id="L4957">    }</span>

    /**
     * The player has won!
     *
     * Called from GUI.showVictoryDialog
     *
     * @param quit If true, leave this game and start a new one.
     * @return True.
     */
    public boolean victory(Boolean quit) {
<span class="nc bnc" id="L4968" title="All 2 branches missed.">        if (quit) {</span>
<span class="nc" id="L4969">            getFreeColClient().newGame(false);</span>
<span class="nc" id="L4970">        } else {</span>
<span class="nc" id="L4971">            askServer().continuePlaying();</span>
        }
<span class="nc" id="L4973">        return true;</span>
    }
        
    /**
     * Tell a unit to wait.
     *
     * Called from WaitAction.
     *
     * @return True, this can not fail.
     */
    public boolean waitUnit() {
<span class="nc bnc" id="L4984" title="All 2 branches missed.">        if (!requireOurTurn()) return false;</span>

        // Defeat the normal check for whether the current unit can move.
<span class="nc" id="L4987">        getGUI().setActiveUnit(null);</span>
<span class="nc" id="L4988">        updateGUI(null);</span>
<span class="nc" id="L4989">        return true;</span>
    }

    /**
     * Moves a &lt;code&gt;Unit&lt;/code&gt; to a &lt;code&gt;WorkLocation&lt;/code&gt;.
     *
     * Called from ColonyPanel.tryWork, UnitLabel
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt;.
     * @param workLocation The new &lt;code&gt;WorkLocation&lt;/code&gt;.
     * @return True if the unit is now working at the new work location.
     */
    public boolean work(Unit unit, WorkLocation workLocation) {
<span class="nc bnc" id="L5002" title="All 4 branches missed.">        if (!requireOurTurn() || unit == null</span>
<span class="nc bnc" id="L5003" title="All 2 branches missed.">            || workLocation == null) return false;</span>

        StringTemplate template;
<span class="nc bnc" id="L5006" title="All 2 branches missed.">        if (unit.getStudent() != null</span>
<span class="nc bnc" id="L5007" title="All 2 branches missed.">            &amp;&amp; !getGUI().confirmAbandonEducation(unit, false)) return false;</span>

<span class="nc" id="L5009">        Colony colony = workLocation.getColony();</span>
<span class="nc bnc" id="L5010" title="All 2 branches missed.">        if (workLocation instanceof ColonyTile) {</span>
<span class="nc" id="L5011">            Tile tile = ((ColonyTile)workLocation).getWorkTile();</span>
<span class="nc bnc" id="L5012" title="All 2 branches missed.">            if (tile.hasLostCityRumour()) {</span>
<span class="nc" id="L5013">                getGUI().showInformationMessage(&quot;tileHasRumour&quot;);</span>
<span class="nc" id="L5014">                return false;</span>
            }
<span class="nc bnc" id="L5016" title="All 2 branches missed.">            if (!unit.getOwner().owns(tile)) {</span>
<span class="nc bnc" id="L5017" title="All 2 branches missed.">                if (!claimTile(tile, colony)) return false;</span>
            }
        }

        // Try to change the work location.
<span class="nc" id="L5022">        ColonyWas colonyWas = new ColonyWas(colony);</span>
<span class="nc" id="L5023">        UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc bnc" id="L5024" title="All 2 branches missed.">        boolean ret = askServer().work(unit, workLocation)</span>
<span class="nc bnc" id="L5025" title="All 2 branches missed.">            &amp;&amp; unit.getLocation() == workLocation;</span>
<span class="nc bnc" id="L5026" title="All 2 branches missed.">        if (ret) {</span>
<span class="nc" id="L5027">            colonyWas.fireChanges();</span>
<span class="nc" id="L5028">            unitWas.fireChanges();</span>
<span class="nc" id="L5029">            updateGUI(null);</span>
        }
<span class="nc" id="L5031">        return ret;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span>src (May 7, 2016 6:04:12 PM)</div></body></html>