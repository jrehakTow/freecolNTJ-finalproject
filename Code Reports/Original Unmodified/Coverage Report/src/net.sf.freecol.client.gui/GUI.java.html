<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>GUI.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">src (May 7, 2016 6:04:12 PM)</a> &gt; <a href="../../index.html" class="el_group">FreeCol</a> &gt; <a href="../index.html" class="el_bundle">src</a> &gt; <a href="index.source.html" class="el_package">net.sf.freecol.client.gui</a> &gt; <span class="el_source">GUI.java</span></div><h1>GUI.java</h1><pre class="source lang-java linenums">/**
 *  Copyright (C) 2002-2016   The FreeCol Team
 *
 *  This file is part of FreeCol.
 *
 *  FreeCol is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  FreeCol is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with FreeCol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package net.sf.freecol.client.gui;

import java.awt.Dimension;
import java.awt.Graphics2D;
import java.awt.Rectangle;
import java.awt.image.BufferedImage;
import java.io.File;
import java.io.InputStream;
import java.lang.reflect.InvocationTargetException;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.logging.Level;
import java.util.logging.Logger;
import java.util.Map;

import javax.swing.SwingUtilities;

import net.sf.freecol.client.ClientOptions;
import net.sf.freecol.client.FreeColClient;
import net.sf.freecol.client.control.FreeColClientHolder;
import net.sf.freecol.client.gui.panel.MiniMap;
import net.sf.freecol.client.gui.panel.Parameters;
import net.sf.freecol.common.FreeColException;
import net.sf.freecol.common.debug.FreeColDebugger;
import net.sf.freecol.common.i18n.Messages;
import net.sf.freecol.common.io.FreeColDirectories;
import net.sf.freecol.common.model.Ability;
import net.sf.freecol.common.model.Building;
import net.sf.freecol.common.model.Colony;
import net.sf.freecol.common.model.Constants;
import net.sf.freecol.common.model.Constants.*;
import net.sf.freecol.common.model.DiplomaticTrade;
import net.sf.freecol.common.model.Europe;
import net.sf.freecol.common.model.FoundingFather;
import net.sf.freecol.common.model.FreeColGameObject;
import net.sf.freecol.common.model.FreeColObject;
import net.sf.freecol.common.model.Game;
import net.sf.freecol.common.model.Goods;
import net.sf.freecol.common.model.GoodsType;
import net.sf.freecol.common.model.HighScore;
import net.sf.freecol.common.model.IndianNationType;
import net.sf.freecol.common.model.IndianSettlement;
import net.sf.freecol.common.model.Location;
import net.sf.freecol.common.model.ModelMessage;
import net.sf.freecol.common.model.Monarch.MonarchAction;
import net.sf.freecol.common.model.Nation;
import net.sf.freecol.common.model.NationSummary;
import net.sf.freecol.common.model.Player;
import net.sf.freecol.common.model.Settlement;
import net.sf.freecol.common.model.Specification;
import net.sf.freecol.common.model.Stance;
import net.sf.freecol.common.model.StringTemplate;
import net.sf.freecol.common.model.Tension;
import net.sf.freecol.common.model.Tile;
import net.sf.freecol.common.model.TradeRoute;
import net.sf.freecol.common.model.Unit;
import net.sf.freecol.common.option.Option;
import net.sf.freecol.common.option.OptionGroup;
import net.sf.freecol.common.resources.ResourceManager;


/**
 * The API and common reusable functionality for the overall GUI.
 */
public class GUI extends FreeColClientHolder {

<span class="fc" id="L87">    protected static final Logger logger = Logger.getLogger(GUI.class.getName());</span>

    /** Warning levels. */
<span class="fc" id="L90">    protected static final String levels[] = {</span>
<span class="fc" id="L91">        &quot;low&quot;, &quot;normal&quot;, &quot;high&quot;</span>
    };

    /** View modes. */
    public static final int MOVE_UNITS_MODE = 0;
<span class="fc" id="L96">    public static final int VIEW_TERRAIN_MODE = 1;</span>

    /** An image library to use. */
    protected final ImageLibrary imageLibrary;


    /**
     * Create the GUI.
     *
     * @param freeColClient The &lt;code&gt;FreeColClient&lt;/code&gt; for the game.
     * @param scaleFactor The scale factor for the GUI.
     */
    public GUI(FreeColClient freeColClient, float scaleFactor) {
<span class="fc" id="L109">        super(freeColClient);</span>

<span class="fc" id="L111">        this.imageLibrary = new ImageLibrary(scaleFactor);</span>
<span class="fc" id="L112">    }</span>


    // Simple accessors

    public ImageLibrary getImageLibrary() {
<span class="nc" id="L118">        return this.imageLibrary;</span>
    }

    public boolean isWindowed() {
<span class="nc" id="L122">        return true;</span>
    }

    // Initialization related methods

    /** 
     * Swing system and look-and-feel initialization.
     * 
     * @param fontName An optional font name to be used.
     * @exception FreeColException if the LAF is incompatible with the GUI.
     */
<span class="nc" id="L133">    public void installLookAndFeel(String fontName) throws FreeColException {}</span>

    /**
     * Quit the GUI.  All that is required is to exit the full screen.
     */
<span class="nc" id="L138">    public void quit() {}</span>

    /**
     * In game initializations.
     *
     * Called from PreGameController.startGame().
     */
<span class="nc" id="L145">    public void initializeInGame() {}</span>

    /**
     * Set up the mouse listeners for the canvas and map viewer.
     */
<span class="nc" id="L150">    public void setupMouseListeners() {}</span>

    /**
     * Display the splash screen.
     *
     * @param splashStream A stream to find the image in.
     */
<span class="fc" id="L157">    public void displaySplashScreen(final InputStream splashStream) {}</span>

    /**
     * Hide the splash screen.
     */
<span class="fc" id="L162">    public void hideSplashScreen() {}</span>

    /**
     * Shows the &lt;code&gt;VideoPanel&lt;/code&gt;.
     *
     * @param userMsg An optional user message.
     */
<span class="nc" id="L169">    public void showOpeningVideo(final String userMsg) {}</span>

    /**
     * Starts the GUI by creating and displaying the GUI-objects.
     *
     * @param desiredWindowSize The desired size of the GUI window.
     */
    public void startGUI(final Dimension desiredWindowSize) {
<span class="fc" id="L177">        logger.info(&quot;It seems that the GraphicsEnvironment is headless!&quot;);</span>
<span class="fc" id="L178">    }</span>

    /**
     * Change the windowed mode.
     */
<span class="nc" id="L183">    public void changeWindowedMode() {}</span>

    /**
     * Start the GUI for the map editor.
     */
<span class="nc" id="L188">    public void startMapEditorGUI() {}</span>


    // Non-trivial public routines.

    /**
     * Start/stop the goto path display.
     */
<span class="nc" id="L196">    public void activateGotoPath() {}</span>

    /**
     * Stop the goto path display.
     */
<span class="nc" id="L201">    public void clearGotoPath() {}</span>

    /**
     * Create a thumbnail for the minimap.
     * 
     * FIXME: Delete all code inside this method and replace it with
     *        sensible code directly drawing in necessary size,
     *        without creating a throwaway GUI panel, drawing in wrong
     *        size and immediately resizing.
     * @return The created &lt;code&gt;BufferedImage&lt;/code&gt;.
     */
    public BufferedImage createMiniMapThumbNail() {
<span class="nc" id="L213">        MiniMap miniMap = new MiniMap(getFreeColClient());</span>
<span class="nc" id="L214">        miniMap.setTileSize(MiniMap.MAX_TILE_SIZE);</span>
<span class="nc" id="L215">        Game game = getGame();</span>
<span class="nc" id="L216">        int width = game.getMap().getWidth() * MiniMap.MAX_TILE_SIZE</span>
<span class="nc" id="L217">            + MiniMap.MAX_TILE_SIZE / 2;</span>
<span class="nc" id="L218">        int height = game.getMap().getHeight() * MiniMap.MAX_TILE_SIZE / 4;</span>
<span class="nc" id="L219">        BufferedImage image = new BufferedImage(</span>
<span class="nc" id="L220">            width, height, BufferedImage.TYPE_INT_ARGB);</span>
<span class="nc" id="L221">        Graphics2D g1 = image.createGraphics();</span>
<span class="nc" id="L222">        miniMap.paintMap(g1);</span>
<span class="nc" id="L223">        g1.dispose();</span>

<span class="nc" id="L225">        int scaledWidth = Math.min((int)((64 * width) / (float)height), 128);</span>
<span class="nc" id="L226">        BufferedImage scaledImage = new BufferedImage(scaledWidth, 64,</span>
<span class="nc" id="L227">            BufferedImage.TYPE_INT_ARGB);</span>
<span class="nc" id="L228">        Graphics2D g2 = scaledImage.createGraphics();</span>
<span class="nc" id="L229">        g2.drawImage(image, 0, 0, scaledWidth, 64, null);</span>
<span class="nc" id="L230">        g2.dispose();</span>
<span class="nc" id="L231">        return scaledImage;</span>
    }

    /**
     * Tells the map controls that a chat message was received.
     *
     * @param player The player who sent the chat message.
     * @param message The chat message.
     * @param privateChat 'true' if the message is a private one, 'false'
     *     otherwise.
     * @see GUIMessage
     */
    public void displayChatMessage(Player player, String message,
<span class="nc" id="L244">                                   boolean privateChat) {}</span>

    /**
     * Refresh the GUI.
     */
<span class="nc" id="L249">    public void refresh() {}</span>

    /**
     * Reset the menu bar.
     */
<span class="nc" id="L254">    public void resetMenuBar() {}</span>

    protected void resetMapZoom() {
<span class="nc" id="L257">        ResourceManager.clean();</span>
<span class="nc" id="L258">    }</span>

    public boolean canZoomInMap() {
<span class="nc" id="L261">        return false;</span>
    }

    public boolean canZoomOutMap() {
<span class="nc" id="L265">        return false;</span>
    }

    public void zoomInMap() {
<span class="nc" id="L269">        ResourceManager.clean();</span>
<span class="nc" id="L270">    }</span>

    public void zoomOutMap() {
<span class="nc" id="L273">        ResourceManager.clean();</span>
<span class="nc" id="L274">    }</span>

    /**
     * Set the active unit.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to activate.
     * @return True if the focus was set.
     */
    public boolean setActiveUnit(Unit unit) {
<span class="nc" id="L283">        return false;</span>
    }

    /**
     * Update the menu bar.
     */
<span class="nc" id="L289">    public void updateMenuBar() {}</span>


    // Animation handling

    /**
     * Require the given tile to be in the onScreen()-area.
     *
     * @param tile The &lt;code&gt;Tile&lt;/code&gt; to check.
     * @return True if the focus was set.
     */
    public boolean requireFocus(Tile tile) {
<span class="nc" id="L301">        return false;</span>
    }
    
    /**
     * Animate a unit attack.
     *
     * @param attacker The attacking &lt;code&gt;Unit&lt;/code&gt;.
     * @param defender The defending &lt;code&gt;Unit&lt;/code&gt;.
     * @param attackerTile The &lt;code&gt;Tile&lt;/code&gt; to show the attacker on.
     * @param defenderTile The &lt;code&gt;Tile&lt;/code&gt; to show the defender on.
     * @param success Did the attack succeed?
     */
    public void animateUnitAttack(Unit attacker, Unit defender,
                                  Tile attackerTile, Tile defenderTile,
<span class="nc" id="L315">                                  boolean success) {}</span>

    /**
     * Animate a unit move.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is moving.
     * @param srcTile The &lt;code&gt;Tile&lt;/code&gt; the unit starts at.
     * @param dstTile The &lt;code&gt;Tile&lt;/code&gt; the unit moves to.
     */
<span class="nc" id="L324">    public void animateUnitMove(Unit unit, Tile srcTile, Tile dstTile) {}</span>


    // MapControls handling

    /**
     * Enable the map controls.
     *
     * Called from the MapControlsAction.
     *
     * @param enable If true then enable.
     */
<span class="fc" id="L336">    public void enableMapControls(boolean enable) {}</span>

<span class="nc" id="L338">    public void updateMapControls() {}</span>

<span class="nc" id="L340">    public void zoomInMapControls() {}</span>

<span class="nc" id="L342">    public void zoomOutMapControls() {}</span>

    public boolean canZoomInMapControls() {
<span class="nc" id="L345">        return false;</span>
    }

    public boolean canZoomOutMapControls() {
<span class="nc" id="L349">        return false;</span>
    }

<span class="nc" id="L352">    public void miniMapToggleViewControls() {}</span>

<span class="nc" id="L354">    public void miniMapToggleFogOfWarControls() {}</span>


    // Dialogs that return values

    /**
     * Simple modal confirmation dialog.
     *
     * @param textKey A string to use as the message key.
     * @param okKey A key for the &quot;ok&quot; button.
     * @param cancelKey A key for the &quot;cancel&quot; button.
     * @return True if the &quot;ok&quot; button was selected.
     */
    public boolean confirm(String textKey, String okKey, String cancelKey) {
<span class="nc" id="L368">        return false;</span>
    }

    /**
     * General modal confirmation dialog.
     *
     * @param tile An optional &lt;code&gt;Tile&lt;/code&gt; to expose.
     * @param template The &lt;code&gt;StringTemplate&lt;/code&gt; explaining the choice.
     * @param okKey A key for the &quot;ok&quot; button.
     * @param cancelKey A key for the &quot;cancel&quot; button.
     * @return True if the &quot;ok&quot; button was selected.
     */
    public boolean confirm(Tile tile, StringTemplate template,
                           String okKey, String cancelKey) {
<span class="nc" id="L382">        return false;</span>
    }

    /**
     * General modal confirmation dialog.
     *
     * @param tile An optional &lt;code&gt;Tile&lt;/code&gt; to expose.
     * @param template The &lt;code&gt;StringTemplate&lt;/code&gt; explaining the choice.
     * @param unit An optional unit to make an icon for the dialog from.
     * @param okKey A key for the &quot;ok&quot; button.
     * @param cancelKey A key for the &quot;cancel&quot; button.
     * @return True if the &quot;ok&quot; button was selected.
     */
    public boolean confirm(Tile tile, StringTemplate template, Unit unit,
                           String okKey, String cancelKey) {
<span class="nc" id="L397">        return false;</span>
    }

    public boolean confirm(Tile tile, StringTemplate template,
                           Settlement settlement,
                           String okKey, String cancelKey) {
<span class="nc" id="L403">        return false;</span>
    }

    public boolean confirm(Tile tile, StringTemplate template,
                           GoodsType goodsType,
                           String okKey, String cancelKey) {
<span class="nc" id="L409">        return false;</span>
    }

    /**
     * Confirm that a unit should abandon its educational activity.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to check.
     * @param leaveColony True if the unit is about to leave the colony,
     *     not just the education building.
     * @return True if the unit can proceed.
     */
    public boolean confirmAbandonEducation(Unit unit, boolean leaveColony) {
<span class="nc bnc" id="L421" title="All 2 branches missed.">        if (!unit.isInColony()) return true;</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">        boolean teacher = unit.getStudent() != null;</span>
        // if leaving the colony, the student loses learning spot, so
        // check with player
<span class="nc bnc" id="L425" title="All 4 branches missed.">        boolean student = leaveColony &amp;&amp; unit.getTeacher() != null;</span>
<span class="nc bnc" id="L426" title="All 4 branches missed.">        if (!teacher &amp;&amp; !student) return true;</span>

<span class="nc bnc" id="L428" title="All 2 branches missed.">        Building school = (Building)((teacher) ? unit.getLocation()</span>
<span class="nc" id="L429">            : unit.getTeacher().getLocation());</span>
<span class="nc" id="L430">        StringTemplate label = unit.getLabel(Unit.UnitLabelType.NATIONAL);</span>
<span class="nc bnc" id="L431" title="All 2 branches missed.">        StringTemplate template = (leaveColony) ? StringTemplate</span>
<span class="nc" id="L432">            .template(&quot;abandonEducation.text&quot;)</span>
<span class="nc" id="L433">            .addStringTemplate(&quot;%unit%&quot;, label)</span>
<span class="nc" id="L434">            .addName(&quot;%colony%&quot;, school.getColony().getName())</span>
<span class="nc" id="L435">            .addNamed(&quot;%building%&quot;, school)</span>
<span class="nc bnc" id="L436" title="All 2 branches missed.">            .addStringTemplate(&quot;%action%&quot;, (teacher)</span>
<span class="nc" id="L437">                ? StringTemplate.key(&quot;abandonEducation.action.teaching&quot;)</span>
<span class="nc" id="L438">                : StringTemplate.key(&quot;abandonEducation.action.studying&quot;))</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">            : (teacher)</span>
<span class="nc" id="L440">            ? StringTemplate.template(&quot;abandonTeaching.text&quot;)</span>
<span class="nc" id="L441">                .addStringTemplate(&quot;%unit%&quot;, label)</span>
<span class="nc" id="L442">                .addNamed(&quot;%building%&quot;, school)</span>
<span class="nc" id="L443">            : null;</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">        return template == null</span>
<span class="nc" id="L445">            || confirm(unit.getTile(), template, unit,</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">                       &quot;abandonEducation.yes&quot;, &quot;abandonEducation.no&quot;);</span>
    }

    /**
     * If a unit has a trade route, get confirmation that it is
     * ok to clear it and set a destination.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to check.
     * @return Whether it is acceptable to set a destination for this unit.
     */
    public boolean confirmClearTradeRoute(Unit unit) {
<span class="nc" id="L457">        TradeRoute tr = unit.getTradeRoute();</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">        if (tr == null) return true;</span>
<span class="nc" id="L459">        StringTemplate template = StringTemplate</span>
<span class="nc" id="L460">            .template(&quot;clearTradeRoute.text&quot;)</span>
<span class="nc" id="L461">            .addStringTemplate(&quot;%unit%&quot;,</span>
<span class="nc" id="L462">                unit.getLabel(Unit.UnitLabelType.NATIONAL))</span>
<span class="nc" id="L463">            .addName(&quot;%route%&quot;, tr.getName());</span>
<span class="nc" id="L464">        return confirm(unit.getTile(), template, unit, &quot;yes&quot;, &quot;no&quot;);</span>
    }

    /**
     * Confirm declaration of independence.
     *
     * @return A list of new nation and country names.
     */
    public List&lt;String&gt; confirmDeclaration() {
<span class="nc" id="L473">        return Collections.&lt;String&gt;emptyList();</span>
    }

    /**
     * Confirm whether the player wants to demand tribute from a colony.
     *
     * @param attacker The potential attacking &lt;code&gt;Unit&lt;/code&gt;.
     * @param colony The target &lt;code&gt;Colony&lt;/code&gt;.
     * @param ns A &lt;code&gt;NationSummary&lt;/code&gt; of the other nation.
     * @return The amount of tribute to demand, positive if the demand
     *     should proceed.
     */
    public int confirmEuropeanTribute(Unit attacker, Colony colony,
                                      NationSummary ns) {
<span class="nc" id="L487">        Player player = attacker.getOwner();</span>
<span class="nc" id="L488">        Player other = colony.getOwner();</span>
<span class="nc" id="L489">        int strength = player.calculateStrength(false);</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">        int otherStrength = (ns == null) ? strength : ns.getMilitaryStrength();</span>
<span class="nc bnc" id="L491" title="All 4 branches missed.">        int mil = (otherStrength &lt;= 1 || otherStrength * 5 &lt; strength) ? 0</span>
<span class="nc bnc" id="L492" title="All 4 branches missed.">            : (strength == 0 || strength * 5 &lt; otherStrength) ? 2</span>
<span class="nc" id="L493">            : 1;</span>

        StringTemplate t;
<span class="nc bnc" id="L496" title="All 2 branches missed.">        int gold = (ns == null) ? 0 : ns.getGold();</span>
<span class="nc bnc" id="L497" title="All 2 branches missed.">        if (gold == 0) {</span>
<span class="nc" id="L498">            t = StringTemplate.template(&quot;confirmTribute.broke&quot;)</span>
<span class="nc" id="L499">                .addStringTemplate(&quot;%nation%&quot;, other.getNationLabel());</span>
<span class="nc" id="L500">            showInformationMessage(t);</span>
<span class="nc" id="L501">            return -1;</span>
        }

<span class="nc bnc" id="L504" title="All 4 branches missed.">        int fin = (gold &lt;= 100) ? 0 : (gold &lt;= 1000) ? 1 : 2;</span>
<span class="nc" id="L505">        t = StringTemplate.template(&quot;confirmTribute.european&quot;)</span>
<span class="nc" id="L506">            .addStringTemplate(&quot;%nation%&quot;, other.getNationLabel())</span>
<span class="nc" id="L507">            .addStringTemplate(&quot;%danger%&quot;,</span>
<span class="nc" id="L508">                StringTemplate.template(&quot;danger.&quot; + levels[mil]))</span>
<span class="nc" id="L509">            .addStringTemplate(&quot;%finance%&quot;,</span>
<span class="nc" id="L510">                StringTemplate.template(&quot;finance.&quot; + levels[fin]));</span>
<span class="nc" id="L511">        return showSelectTributeAmountDialog(t, gold);</span>
    }

    /**
     * Check if an attack results in a transition from peace or cease fire to
     * war and, if so, warn the player.
     *
     * @param attacker The potential attacking &lt;code&gt;Unit&lt;/code&gt;.
     * @param target The target &lt;code&gt;Tile&lt;/code&gt;.
     * @return True to attack, false to abort.
     */
    public boolean confirmHostileAction(Unit attacker, Tile target) {
<span class="nc bnc" id="L523" title="All 2 branches missed.">        if (attacker.hasAbility(Ability.PIRACY)) {</span>
            // Privateers can attack and remain at peace
<span class="nc" id="L525">            return true;</span>
        }

        Player enemy;
<span class="nc bnc" id="L529" title="All 2 branches missed.">        if (target.hasSettlement()) {</span>
<span class="nc" id="L530">            enemy = target.getSettlement().getOwner();</span>
<span class="nc bnc" id="L531" title="All 2 branches missed.">        } else if (target == attacker.getTile()) {</span>
            // Fortify on tile owned by another nation
<span class="nc" id="L533">            enemy = target.getOwner();</span>
<span class="nc bnc" id="L534" title="All 2 branches missed.">            if (enemy == null) return true;</span>
        } else {
<span class="nc" id="L536">            Unit defender = target.getDefendingUnit(attacker);</span>
<span class="nc bnc" id="L537" title="All 2 branches missed.">            if (defender == null) {</span>
<span class="nc" id="L538">                logger.warning(&quot;Attacking, but no defender - will try!&quot;);</span>
<span class="nc" id="L539">                return true;</span>
            }
<span class="nc bnc" id="L541" title="All 2 branches missed.">            if (defender.hasAbility(Ability.PIRACY)) {</span>
                // Privateers can be attacked and remain at peace
<span class="nc" id="L543">                return true;</span>
            }
<span class="nc" id="L545">            enemy = defender.getOwner();</span>
        }

        String messageId;
<span class="nc bnc" id="L549" title="All 4 branches missed.">        switch (attacker.getOwner().getStance(enemy)) {</span>
        case WAR:
<span class="nc" id="L551">            logger.finest(&quot;Player at war, no confirmation needed&quot;);</span>
<span class="nc" id="L552">            return true;</span>
        case CEASE_FIRE:
<span class="nc" id="L554">            messageId = &quot;confirmHostile.ceaseFire&quot;;</span>
<span class="nc" id="L555">            break;</span>
        case ALLIANCE:
<span class="nc" id="L557">            messageId = &quot;confirmHostile.alliance&quot;;</span>
<span class="nc" id="L558">            break;</span>
        case UNCONTACTED: case PEACE: default:
<span class="nc" id="L560">            messageId = &quot;confirmHostile.peace&quot;;</span>
            break;
        }
<span class="nc" id="L563">        return confirm(attacker.getTile(), StringTemplate</span>
<span class="nc" id="L564">            .template(messageId)</span>
<span class="nc" id="L565">            .addStringTemplate(&quot;%nation%&quot;, enemy.getNationLabel()),</span>
<span class="nc" id="L566">            attacker, &quot;confirmHostile.yes&quot;, &quot;cancel&quot;);</span>
    }

    /**
     * Confirm that a unit can leave its colony.
     * - Check for population limit.
     * - Query if education should be abandoned.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is leaving the colony.
     * @return True if the unit is allowed to leave.
     */
    public boolean confirmLeaveColony(Unit unit) {
<span class="nc" id="L578">        Colony colony = unit.getColony();</span>
<span class="nc" id="L579">        StringTemplate message = colony.getReducePopulationMessage();</span>
<span class="nc bnc" id="L580" title="All 2 branches missed.">        if (message != null) {</span>
<span class="nc" id="L581">            showInformationMessage(message);</span>
<span class="nc" id="L582">            return false;</span>
        }
<span class="nc" id="L584">        return confirmAbandonEducation(unit, true);</span>
    }

    /**
     * Confirm whether the player wants to demand tribute from a native
     * settlement.
     *
     * @param attacker The potential attacking &lt;code&gt;Unit&lt;/code&gt;.
     * @param is The target &lt;code&gt;IndianSettlement&lt;/code&gt;.
     * @return The amount of tribute to demand, positive if the demand
     *     should proceed.
     */
    public int confirmNativeTribute(Unit attacker, IndianSettlement is) {
<span class="nc" id="L597">        Player player = attacker.getOwner();</span>
<span class="nc" id="L598">        Player other = is.getOwner();</span>
<span class="nc" id="L599">        int strength = player.calculateStrength(false);</span>
<span class="nc bnc" id="L600" title="All 2 branches missed.">        String messageId = (other.getSettlements().size() &gt;= strength)</span>
<span class="nc" id="L601">            ? &quot;confirmTribute.unwise&quot;</span>
<span class="nc bnc" id="L602" title="All 2 branches missed.">            : (other.getStance(player) == Stance.CEASE_FIRE)</span>
<span class="nc" id="L603">            ? &quot;confirmTribute.warLikely&quot;</span>
<span class="nc bnc" id="L604" title="All 2 branches missed.">            : (is.getAlarm(player).getLevel() == Tension.Level.HAPPY)</span>
<span class="nc" id="L605">            ? &quot;confirmTribute.happy&quot;</span>
<span class="nc" id="L606">            : &quot;confirmTribute.normal&quot;;</span>
<span class="nc" id="L607">        return (confirm(is.getTile(), StringTemplate.template(messageId)</span>
<span class="nc" id="L608">                .addName(&quot;%settlement%&quot;, is.getName())</span>
<span class="nc" id="L609">                .addStringTemplate(&quot;%nation%&quot;, other.getNationLabel()),</span>
<span class="nc bnc" id="L610" title="All 2 branches missed.">                attacker, &quot;confirmTribute.yes&quot;, &quot;confirmTribute.no&quot;))</span>
<span class="nc" id="L611">            ? 1 : -1;</span>
    }

    /**
     * Shows the pre-combat dialog if enabled, allowing the user to
     * view the odds and possibly cancel the attack.
     *
     * @param attacker The attacking &lt;code&gt;Unit&lt;/code&gt;.
     * @param tile The target &lt;code&gt;Tile&lt;/code&gt;.
     * @return True to attack, false to abort.
     */
    public boolean confirmPreCombat(Unit attacker, Tile tile) {
<span class="nc bnc" id="L623" title="All 2 branches missed.">        if (getClientOptions().getBoolean(ClientOptions.SHOW_PRECOMBAT)) {</span>
<span class="nc" id="L624">            Settlement settlement = tile.getSettlement();</span>
            // Don't tell the player how a settlement is defended!
<span class="nc bnc" id="L626" title="All 2 branches missed.">            FreeColGameObject defender = (settlement != null) ? settlement</span>
<span class="nc" id="L627">                : tile.getDefendingUnit(attacker);</span>
<span class="nc" id="L628">            return showPreCombatDialog(attacker, defender, tile);</span>
        }
<span class="nc" id="L630">        return true;</span>
    }

    /**
     * Confirm whether to stop the current game.
     *
     * @return True if confirmation was given.
     */
    public boolean confirmStopGame() {
<span class="nc" id="L639">        return confirm(&quot;stopCurrentGame.text&quot;,</span>
<span class="nc" id="L640">                       &quot;stopCurrentGame.yes&quot;, &quot;stopCurrentGame.no&quot;);</span>
    }

    /**
     * Get the choice of what a user wants to do with an armed unit at
     * a foreign settlement.
     *
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; to consider.
     * @return The chosen action, tribute, attack or cancel.
     */
    public ArmedUnitSettlementAction getArmedUnitSettlementChoice(Settlement settlement) {
<span class="nc" id="L651">        final Player player = getMyPlayer();</span>

<span class="nc" id="L653">        List&lt;ChoiceItem&lt;ArmedUnitSettlementAction&gt;&gt; choices = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L654">        choices.add(new ChoiceItem&lt;&gt;(Messages.message(&quot;armedUnitSettlement.tribute&quot;),</span>
<span class="nc" id="L655">                ArmedUnitSettlementAction.SETTLEMENT_TRIBUTE));</span>
<span class="nc" id="L656">        choices.add(new ChoiceItem&lt;&gt;(Messages.message(&quot;armedUnitSettlement.attack&quot;),</span>
<span class="nc" id="L657">                ArmedUnitSettlementAction.SETTLEMENT_ATTACK));</span>

<span class="nc" id="L659">        return getChoice(settlement.getTile(),</span>
<span class="nc" id="L660">            settlement.getAlarmLevelLabel(player),</span>
<span class="nc" id="L661">            settlement, &quot;cancel&quot;, choices);</span>
    }

    /**
     * Get the user choice of whether to pay arrears for boycotted
     * goods or to dump them instead.
     *
     * @param goods The &lt;code&gt;Goods&lt;/code&gt; to possibly dump.
     * @param europe The player &lt;code&gt;Europe&lt;/code&gt; where the boycott
     *     is in force.
     * @return The chosen &lt;code&gt;BoycottAction&lt;/code&gt;.
     */
    public BoycottAction getBoycottChoice(Goods goods, Europe europe) {
<span class="nc" id="L674">        int arrears = europe.getOwner().getArrears(goods.getType());</span>
<span class="nc" id="L675">        StringTemplate template = StringTemplate</span>
<span class="nc" id="L676">            .template(&quot;boycottedGoods.text&quot;)</span>
<span class="nc" id="L677">            .addNamed(&quot;%goods%&quot;, goods)</span>
<span class="nc" id="L678">            .addNamed(&quot;%europe%&quot;, europe)</span>
<span class="nc" id="L679">            .addAmount(&quot;%amount%&quot;, arrears);</span>

<span class="nc" id="L681">        List&lt;ChoiceItem&lt;BoycottAction&gt;&gt; choices = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L682">        choices.add(new ChoiceItem&lt;&gt;(Messages.message(&quot;payArrears&quot;),</span>
<span class="nc" id="L683">                                     BoycottAction.BOYCOTT_PAY_ARREARS));</span>
<span class="nc" id="L684">        choices.add(new ChoiceItem&lt;&gt;(Messages.message(&quot;boycottedGoods.dumpGoods&quot;),</span>
<span class="nc" id="L685">                                     BoycottAction.BOYCOTT_DUMP_CARGO));</span>

<span class="nc" id="L687">        return getChoice(null, template,</span>
<span class="nc" id="L688">                         goods.getType(), &quot;cancel&quot;, choices);</span>
    }

    /**
     * Gets the user choice when negotiating a purchase from a settlement.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is buying.
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; to buy from.
     * @param goods The &lt;code&gt;Goods&lt;/code&gt; to buy.
     * @param gold The current negotiated price.
     * @param canBuy True if buy is a valid option.
     * @return The chosen action, buy, haggle, or cancel.
     */
    public TradeBuyAction getBuyChoice(Unit unit, Settlement settlement,
                                       Goods goods, int gold, boolean canBuy) {
<span class="nc" id="L703">        StringTemplate template = StringTemplate.template(&quot;buy.text&quot;)</span>
<span class="nc" id="L704">            .addStringTemplate(&quot;%nation%&quot;, settlement.getOwner().getNationLabel())</span>
<span class="nc" id="L705">            .addStringTemplate(&quot;%goods%&quot;, goods.getLabel(true))</span>
<span class="nc" id="L706">            .addAmount(&quot;%gold%&quot;, gold);</span>

<span class="nc" id="L708">        List&lt;ChoiceItem&lt;TradeBuyAction&gt;&gt; choices = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L709">        choices.add(new ChoiceItem&lt;&gt;(Messages.message(&quot;buy.takeOffer&quot;),</span>
<span class="nc" id="L710">                                     TradeBuyAction.BUY, canBuy));</span>
<span class="nc" id="L711">        choices.add(new ChoiceItem&lt;&gt;(Messages.message(&quot;buy.moreGold&quot;),</span>
<span class="nc" id="L712">                                     TradeBuyAction.HAGGLE));</span>

<span class="nc" id="L714">        return getChoice(unit.getTile(), template,</span>
<span class="nc" id="L715">                         goods.getType(), &quot;cancel&quot;, choices);</span>
    }

    /**
     * Gets the user choice for claiming a tile.
     *
     * @param tile The &lt;code&gt;Tile&lt;/code&gt; to claim.
     * @param player The &lt;code&gt;Player&lt;/code&gt; that is claiming.
     * @param price An asking price, if any.
     * @param owner The &lt;code&gt;Player&lt;/code&gt; that owns the land.
     * @return The chosen action, accept, steal or cancel.
     */
    public ClaimAction getClaimChoice(Tile tile, Player player, int price,
                                      Player owner) {
<span class="nc" id="L729">        List&lt;ChoiceItem&lt;ClaimAction&gt;&gt; choices = new ArrayList&lt;&gt;();</span>
        StringTemplate template;
<span class="nc bnc" id="L731" title="All 2 branches missed.">        if (owner.hasContacted(player)) {</span>
<span class="nc" id="L732">            template = StringTemplate.template(&quot;indianLand.text&quot;)</span>
<span class="nc" id="L733">                .addStringTemplate(&quot;%player%&quot;, owner.getNationLabel());</span>
<span class="nc" id="L734">            StringTemplate pay = StringTemplate.template(&quot;indianLand.pay&quot;)</span>
<span class="nc" id="L735">                .addAmount(&quot;%amount%&quot;, price);</span>
<span class="nc" id="L736">            choices.add(new ChoiceItem&lt;&gt;(Messages.message(pay),</span>
<span class="nc" id="L737">                                         ClaimAction.CLAIM_ACCEPT,</span>
<span class="nc" id="L738">                                         player.checkGold(price)));</span>
<span class="nc" id="L739">        } else {</span>
<span class="nc" id="L740">            template = StringTemplate.template(&quot;indianLand.unknown&quot;);</span>
        }

<span class="nc" id="L743">        choices.add(new ChoiceItem&lt;&gt;(Messages.message(&quot;indianLand.take&quot;),</span>
<span class="nc" id="L744">                                     ClaimAction.CLAIM_STEAL));</span>

<span class="nc" id="L746">        return getChoice(tile, template,</span>
<span class="nc" id="L747">                         owner.getNation(), &quot;indianLand.cancel&quot;, choices);</span>
    }

    /**
     * Get the user choice when trading with a native settlement.
     *
     * @param settlement The native settlement to trade with.
     * @param template A &lt;code&gt;StringTemplate&lt;/code&gt; containing the message
     *     to display.
     * @param canBuy Show a &quot;buy&quot; option.
     * @param canSell Show a &quot;sell&quot; option.
     * @param canGift Show a &quot;gift&quot; option.
     * @return The chosen action, buy, sell, gift or cancel.
     */
    public TradeAction getIndianSettlementTradeChoice(Settlement settlement,
                                                      StringTemplate template,
                                                      boolean canBuy,
                                                      boolean canSell,
                                                      boolean canGift) {

<span class="nc" id="L767">        ArrayList&lt;ChoiceItem&lt;TradeAction&gt;&gt; choices = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L768" title="All 2 branches missed.">        if (canBuy) {</span>
<span class="nc" id="L769">            choices.add(new ChoiceItem&lt;&gt;(Messages.message(&quot;tradeProposition.toBuy&quot;),</span>
<span class="nc" id="L770">                                         TradeAction.BUY, canBuy));</span>
        }
<span class="nc bnc" id="L772" title="All 2 branches missed.">        if (canSell) {</span>
<span class="nc" id="L773">            choices.add(new ChoiceItem&lt;&gt;(Messages.message(&quot;tradeProposition.toSell&quot;),</span>
<span class="nc" id="L774">                                         TradeAction.SELL, canSell));</span>
        }
<span class="nc bnc" id="L776" title="All 2 branches missed.">        if (canGift) {</span>
<span class="nc" id="L777">            choices.add(new ChoiceItem&lt;&gt;(Messages.message(&quot;tradeProposition.toGift&quot;),</span>
<span class="nc" id="L778">                                         TradeAction.GIFT, canGift));</span>
        }
<span class="nc bnc" id="L780" title="All 2 branches missed.">        if (choices.isEmpty()) return null;</span>

<span class="nc" id="L782">        return getChoice(settlement.getTile(), template,</span>
<span class="nc" id="L783">                         settlement, &quot;cancel&quot;, choices);</span>
    }

    /**
     * Get the user choice of what to do with a missionary at a native
     * settlement.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; speaking to the settlement.
     * @param settlement The &lt;code&gt;IndianSettlement&lt;/code&gt; being visited.
     * @param canEstablish Is establish a valid option.
     * @param canDenounce Is denounce a valid option.
     * @return The chosen action, establish mission, denounce, incite
     *     or cancel.
     */
    public MissionaryAction getMissionaryChoice(Unit unit,
                                                IndianSettlement settlement,
                                                boolean canEstablish,
                                                boolean canDenounce) {
<span class="nc" id="L801">        StringTemplate template = StringTemplate.label(&quot;\n\n&quot;)</span>
<span class="nc" id="L802">            .addStringTemplate(settlement.getAlarmLevelLabel(unit.getOwner()))</span>
<span class="nc" id="L803">            .addStringTemplate(StringTemplate</span>
<span class="nc" id="L804">                .template(&quot;missionarySettlement.question&quot;)</span>
<span class="nc" id="L805">                .addName(&quot;%settlement%&quot;, settlement.getName()));</span>

<span class="nc" id="L807">        List&lt;ChoiceItem&lt;MissionaryAction&gt;&gt; choices = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L808" title="All 2 branches missed.">        if (canEstablish) {</span>
<span class="nc" id="L809">            choices.add(new ChoiceItem&lt;&gt;(Messages.message(&quot;missionarySettlement.establish&quot;),</span>
<span class="nc" id="L810">                    MissionaryAction.MISSIONARY_ESTABLISH_MISSION,</span>
<span class="nc" id="L811">                    canEstablish));</span>
        }
<span class="nc bnc" id="L813" title="All 2 branches missed.">        if (canDenounce) {</span>
<span class="nc" id="L814">            choices.add(new ChoiceItem&lt;&gt;(Messages.message(&quot;missionarySettlement.heresy&quot;),</span>
<span class="nc" id="L815">                    MissionaryAction.MISSIONARY_DENOUNCE_HERESY,</span>
<span class="nc" id="L816">                    canDenounce));</span>
        }
<span class="nc" id="L818">        choices.add(new ChoiceItem&lt;&gt;(Messages.message(&quot;missionarySettlement.incite&quot;),</span>
<span class="nc" id="L819">                MissionaryAction.MISSIONARY_INCITE_INDIANS));</span>

<span class="nc" id="L821">        return getChoice(unit.getTile(), template,</span>
<span class="nc" id="L822">                         settlement, &quot;cancel&quot;, choices);</span>
    }

    /**
     * Get a name for a new colony for a player.
     *
     * @param player The &lt;code&gt;Player&lt;/code&gt; to get the colony name for.
     * @param tile The &lt;code&gt;Tile&lt;/code&gt; for the new colony.
     * @return A colony name, or null if the user has reconsidered.
     */
    public String getNewColonyName(Player player, Tile tile) {
<span class="nc" id="L833">        String suggested = player.getSettlementName(null);</span>
<span class="nc" id="L834">        String name = getInput(tile, StringTemplate</span>
<span class="nc" id="L835">            .template(&quot;nameColony.text&quot;), suggested,</span>
<span class="nc" id="L836">            &quot;accept&quot;, &quot;cancel&quot;);</span>
<span class="nc bnc" id="L837" title="All 2 branches missed.">        if (name == null) {</span>
            // Cancelled
<span class="nc bnc" id="L839" title="All 2 branches missed.">        } else if (name.isEmpty()) {</span>
<span class="nc" id="L840">            showInformationMessage(&quot;enterSomeText&quot;); // 0-length is invalid</span>
<span class="nc bnc" id="L841" title="All 2 branches missed.">        } else if (player.getSettlementByName(name) != null) {</span>
            // Must be unique
<span class="nc" id="L843">            showInformationMessage(tile, StringTemplate</span>
<span class="nc" id="L844">                .template(&quot;nameColony.notUnique&quot;)</span>
<span class="nc" id="L845">                .addName(&quot;%name%&quot;, name));</span>
<span class="nc" id="L846">        } else {</span>
<span class="nc" id="L847">            return name;</span>
        }
<span class="nc" id="L849">        player.putSettlementName(suggested);</span>
<span class="nc" id="L850">        return null;</span>
    }

    /**
     * Get the user choice for what to do with a scout at a foreign colony.
     *
     * @param colony The &lt;code&gt;Colony&lt;/code&gt; to be scouted.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is scouting.
     * @param neg True if negotation is a valid choice.
     * @return The selected action, either negotiate, spy, attack or cancel.
     */
    public ScoutColonyAction getScoutForeignColonyChoice(Colony colony,
                                                         Unit unit,
                                                         boolean neg) {
<span class="nc" id="L864">        StringTemplate template = StringTemplate.template(&quot;scoutColony.text&quot;)</span>
<span class="nc" id="L865">            .addStringTemplate(&quot;%unit%&quot;, unit.getLabel(Unit.UnitLabelType.NATIONAL))</span>
<span class="nc" id="L866">            .addName(&quot;%colony%&quot;, colony.getName());</span>

<span class="nc" id="L868">        List&lt;ChoiceItem&lt;ScoutColonyAction&gt;&gt; choices = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L869">        choices.add(new ChoiceItem&lt;&gt;(Messages.message(&quot;scoutColony.negotiate&quot;),</span>
<span class="nc" id="L870">                                     ScoutColonyAction.SCOUT_COLONY_NEGOTIATE,</span>
<span class="nc" id="L871">                                     neg));</span>
<span class="nc" id="L872">        choices.add(new ChoiceItem&lt;&gt;(Messages.message(&quot;scoutColony.spy&quot;),</span>
<span class="nc" id="L873">                                     ScoutColonyAction.SCOUT_COLONY_SPY));</span>
<span class="nc" id="L874">        choices.add(new ChoiceItem&lt;&gt;(Messages.message(&quot;scoutColony.attack&quot;),</span>
<span class="nc" id="L875">                                     ScoutColonyAction.SCOUT_COLONY_ATTACK));</span>

<span class="nc" id="L877">        return getChoice(unit.getTile(), template,</span>
<span class="nc" id="L878">                         colony, &quot;cancel&quot;, choices);</span>
    }

    /**
     * Get the user choice for what to do at a native settlement.
     *
     * @param settlement The &lt;code&gt;IndianSettlement&lt;/code&gt; to be scouted.
     * @param numberString The number of settlements in the settlement
     *     owner nation.
     * @return The chosen action, speak, tribute, attack or cancel.
     */
    public ScoutIndianSettlementAction getScoutIndianSettlementChoice(IndianSettlement settlement,
        String numberString) {
<span class="nc" id="L891">        final Player player = getMyPlayer();</span>
<span class="nc" id="L892">        final Player owner = settlement.getOwner();</span>

<span class="nc" id="L894">        StringTemplate template = StringTemplate.label(&quot;&quot;)</span>
<span class="nc" id="L895">            .addStringTemplate(settlement.getAlarmLevelLabel(player))</span>
<span class="nc" id="L896">            .addName(&quot;\n\n&quot;)</span>
<span class="nc" id="L897">            .addStringTemplate(StringTemplate</span>
<span class="nc" id="L898">                .template(&quot;scoutSettlement.greetings&quot;)</span>
<span class="nc" id="L899">                .addStringTemplate(&quot;%nation%&quot;, owner.getNationLabel())</span>
<span class="nc" id="L900">                .addName(&quot;%settlement%&quot;, settlement.getName())</span>
<span class="nc" id="L901">                .addName(&quot;%number%&quot;, numberString)</span>
<span class="nc" id="L902">                .add(&quot;%settlementType%&quot;,</span>
<span class="nc" id="L903">                    ((IndianNationType)owner.getNationType()).getSettlementTypeKey(true)))</span>
<span class="nc" id="L904">            .addName(&quot; &quot;);</span>
<span class="nc bnc" id="L905" title="All 2 branches missed.">        if (settlement.getLearnableSkill() != null) {</span>
<span class="nc" id="L906">            template</span>
<span class="nc" id="L907">                .addStringTemplate(StringTemplate</span>
<span class="nc" id="L908">                    .template(&quot;scoutSettlement.skill&quot;)</span>
<span class="nc" id="L909">                    .addNamed(&quot;%skill%&quot;, settlement.getLearnableSkill()))</span>
<span class="nc" id="L910">                .addName(&quot; &quot;);</span>
        }
<span class="nc" id="L912">        GoodsType[] wantedGoods = settlement.getWantedGoods();</span>
<span class="nc" id="L913">        int present = 0;</span>
<span class="nc bnc" id="L914" title="All 2 branches missed.">        for (; present &lt; wantedGoods.length; present++) {</span>
<span class="nc bnc" id="L915" title="All 2 branches missed.">            if (wantedGoods[present] == null) break;</span>
        }
<span class="nc bnc" id="L917" title="All 2 branches missed.">        if (present &gt; 0) {</span>
<span class="nc" id="L918">            StringTemplate t = StringTemplate.template(&quot;scoutSettlement.trade.&quot;</span>
<span class="nc" id="L919">                + Integer.toString(present));</span>
<span class="nc bnc" id="L920" title="All 2 branches missed.">            for (int i = 0; i &lt; present; i++) {</span>
<span class="nc" id="L921">                String tradeKey = &quot;%goods&quot; + Integer.toString(i+1) + &quot;%&quot;;</span>
<span class="nc" id="L922">                t.addNamed(tradeKey, wantedGoods[i]);</span>
            }
<span class="nc" id="L924">            template.addStringTemplate(t).addName(&quot;\n\n&quot;);</span>
        }

<span class="nc" id="L927">        List&lt;ChoiceItem&lt;ScoutIndianSettlementAction&gt;&gt; choices</span>
<span class="nc" id="L928">            = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L929">        choices.add(new ChoiceItem&lt;&gt;(Messages.message(&quot;scoutSettlement.speak&quot;),</span>
<span class="nc" id="L930">                                     ScoutIndianSettlementAction.SCOUT_SETTLEMENT_SPEAK));</span>
<span class="nc" id="L931">        choices.add(new ChoiceItem&lt;&gt;(Messages.message(&quot;scoutSettlement.tribute&quot;),</span>
<span class="nc" id="L932">                                     ScoutIndianSettlementAction.SCOUT_SETTLEMENT_TRIBUTE));</span>
<span class="nc" id="L933">        choices.add(new ChoiceItem&lt;&gt;(Messages.message(&quot;scoutSettlement.attack&quot;),</span>
<span class="nc" id="L934">                                     ScoutIndianSettlementAction.SCOUT_SETTLEMENT_ATTACK));</span>

<span class="nc" id="L936">        return getChoice(settlement.getTile(), template,</span>
<span class="nc" id="L937">                         settlement, &quot;cancel&quot;, choices);</span>
    }

    /**
     * Get the user choice for negotiating a sale to a settlement.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is selling.
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; to sell to.
     * @param goods The &lt;code&gt;Goods&lt;/code&gt; to sell.
     * @param gold The current negotiated price.
     * @return The chosen action, sell, gift or haggle, or null.
     */
    public TradeSellAction getSellChoice(Unit unit, Settlement settlement,
                                         Goods goods, int gold) {
<span class="nc" id="L951">        StringTemplate goodsTemplate = goods.getLabel(true);</span>
<span class="nc" id="L952">        StringTemplate template = StringTemplate.template(&quot;sell.text&quot;)</span>
<span class="nc" id="L953">            .addStringTemplate(&quot;%nation%&quot;, settlement.getOwner().getNationLabel())</span>
<span class="nc" id="L954">            .addStringTemplate(&quot;%goods%&quot;, goodsTemplate)</span>
<span class="nc" id="L955">            .addAmount(&quot;%gold%&quot;, gold);</span>

<span class="nc" id="L957">        List&lt;ChoiceItem&lt;TradeSellAction&gt;&gt; choices = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L958">        choices.add(new ChoiceItem&lt;&gt;(Messages.message(&quot;sell.takeOffer&quot;),</span>
<span class="nc" id="L959">                                     TradeSellAction.SELL));</span>
<span class="nc" id="L960">        choices.add(new ChoiceItem&lt;&gt;(Messages.message(&quot;sell.moreGold&quot;),</span>
<span class="nc" id="L961">                                     TradeSellAction.HAGGLE));</span>
<span class="nc" id="L962">        choices.add(new ChoiceItem&lt;&gt;(Messages.message(StringTemplate</span>
<span class="nc" id="L963">                    .template(&quot;sell.gift&quot;)</span>
<span class="nc" id="L964">                    .addStringTemplate(&quot;%goods%&quot;, goodsTemplate)),</span>
<span class="nc" id="L965">                TradeSellAction.GIFT));</span>

<span class="nc" id="L967">        return getChoice(unit.getTile(), template,</span>
<span class="nc" id="L968">                         goods.getType(), &quot;cancel&quot;, choices);</span>
    }


    /**
     * General modal choice dialog.
     *
     * @param &lt;T&gt; The choice type.
     * @param tile An optional &lt;code&gt;Tile&lt;/code&gt; to expose.
     * @param explain An object explaining the choice.
     * @param cancelKey A key for the &quot;cancel&quot; button.
     * @param choices A list a &lt;code&gt;ChoiceItem&lt;/code&gt;s to choose from.
     * @return The selected value of the selected &lt;code&gt;ChoiceItem&lt;/code&gt;,
     *     or null if cancelled.
     */
    public &lt;T&gt; T getChoice(Tile tile, Object explain,
                           String cancelKey, List&lt;ChoiceItem&lt;T&gt;&gt; choices) {
<span class="nc" id="L985">        return null;</span>
    }

    public &lt;T&gt; T getChoice(Tile tile, Object explain, Unit unit,
                           String cancelKey, List&lt;ChoiceItem&lt;T&gt;&gt; choices) {
<span class="nc" id="L990">        return null;</span>
    }

    public &lt;T&gt; T getChoice(Tile tile, Object explain, Settlement settlement,
                           String cancelKey, List&lt;ChoiceItem&lt;T&gt;&gt; choices) {
<span class="nc" id="L995">        return null;</span>
    }

    public &lt;T&gt; T getChoice(Tile tile, Object explain, GoodsType goodsType,
                           String cancelKey, List&lt;ChoiceItem&lt;T&gt;&gt; choices) {
<span class="nc" id="L1000">        return null;</span>
    }

    public &lt;T&gt; T getChoice(Tile tile, Object explain, Nation nation,
                           String cancelKey, List&lt;ChoiceItem&lt;T&gt;&gt; choices) {
<span class="nc" id="L1005">        return null;</span>
    }

    /**
     * General modal string input dialog.
     *
     * @param tile An optional &lt;code&gt;Tile&lt;/code&gt; to expose.
     * @param template A &lt;code&gt;StringTemplate&lt;/code&gt; explaining the choice.
     * @param defaultValue The default value to show initially.
     * @param okKey A key for the &quot;ok&quot; button.
     * @param cancelKey A key for the &quot;cancel&quot; button.
     * @return The chosen value.
     */
    public String getInput(Tile tile, StringTemplate template,
                           String defaultValue,
                           String okKey, String cancelKey) {
<span class="nc" id="L1021">        return null;</span>
    }

<span class="nc" id="L1024">    public void closeMainPanel() {}</span>

<span class="nc" id="L1026">    public void closeMenus() {}</span>

<span class="nc" id="L1028">    public void closeStatusPanel() {}</span>

    public boolean containsInGameComponents() {
<span class="nc" id="L1031">        return false;</span>
    }

    public LoadingSavegameInfo getLoadingSavegameInfo() {
<span class="nc" id="L1035">        return null;</span>
    }

    public boolean isClientOptionsDialogShowing() {
<span class="fc" id="L1039">        return false;</span>
    }

    public boolean isMapboardActionsEnabled() {
<span class="fc" id="L1043">        return false;</span>
    }

    public boolean isShowingSubPanel() {
<span class="fc" id="L1047">        return false;</span>
    }

<span class="nc" id="L1050">    public void paintImmediatelyCanvasIn(Rectangle rectangle) {}</span>

<span class="nc" id="L1052">    public void paintImmediatelyCanvasInItsBounds() {}</span>

<span class="nc" id="L1054">    public void refreshPlayersTable() {}</span>

<span class="nc" id="L1056">    public void removeInGameComponents() {}</span>

<span class="nc" id="L1058">    public void requestFocusForSubPanel() {}</span>

    public boolean requestFocusInWindow() {
<span class="nc" id="L1061">        return false;</span>
    }

<span class="nc" id="L1064">    public void returnToTitle() {}</span>

<span class="nc" id="L1066">    public void showAboutPanel() {}</span>

    public void showCaptureGoodsDialog(final Unit unit, List&lt;Goods&gt; gl,
                                       DialogHandler&lt;List&lt;Goods&gt;&gt; handler) {
<span class="nc" id="L1070">    }</span>

<span class="nc" id="L1072">    public void showChatPanel() {}</span>

    public void showChooseFoundingFatherDialog(final List&lt;FoundingFather&gt; ffs,
            DialogHandler&lt;FoundingFather&gt; handler) {
<span class="nc" id="L1076">    }</span>

<span class="nc" id="L1078">    public void showClientOptionsDialog() {}</span>

    /**
     * Display the appropriate panel for a given settlement.
     *
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; to display.
     */
    void showSettlement(Settlement settlement) {
<span class="nc bnc" id="L1086" title="All 2 branches missed.">        if (settlement instanceof Colony) {</span>
<span class="nc bnc" id="L1087" title="All 2 branches missed.">            if (settlement.getOwner().equals(getMyPlayer())) {</span>
<span class="nc" id="L1088">                showColonyPanel((Colony)settlement, null);</span>
<span class="nc bnc" id="L1089" title="All 2 branches missed.">            } else if (FreeColDebugger.isInDebugMode(FreeColDebugger.DebugMode.MENUS)) {</span>
<span class="nc" id="L1090">                showForeignColony(settlement);</span>
            }
<span class="nc bnc" id="L1092" title="All 2 branches missed.">        } else if (settlement instanceof IndianSettlement) {</span>
<span class="nc" id="L1093">            showIndianSettlementPanel((IndianSettlement)settlement);</span>
<span class="nc" id="L1094">        } else {</span>
<span class="nc" id="L1095">            throw new IllegalStateException(&quot;Bogus settlement&quot;);</span>
        }
<span class="nc" id="L1097">    }</span>

<span class="nc" id="L1099">    protected void showForeignColony(Settlement settlement) {}</span>

<span class="nc" id="L1101">    public void showColonyPanel(Colony colony, Unit unit) {}</span>

<span class="nc" id="L1103">    public void showColopediaPanel(String nodeId) {}</span>

<span class="nc" id="L1105">    public void showCompactLabourReport() {}</span>

<span class="nc" id="L1107">    public void showDeclarationPanel() {}</span>

    public OptionGroup showDifficultyDialog() {
<span class="nc" id="L1110">        return null;</span>
    }

    public void showDumpCargoDialog(Unit unit,
<span class="nc" id="L1114">                                    DialogHandler&lt;List&lt;Goods&gt;&gt; handler) {}</span>

    public boolean showEditOptionDialog(Option option) {
<span class="nc" id="L1117">        return false;</span>
    }

    public void showEmigrationDialog(final Player player,
                                     final boolean fountainOfYouth,
<span class="nc" id="L1122">                                     DialogHandler&lt;Integer&gt; handler) {}</span>

    public void showEndTurnDialog(final List&lt;Unit&gt; units,
<span class="nc" id="L1125">                                  DialogHandler&lt;Boolean&gt; handler) {}</span>

<span class="nc" id="L1127">    public void showErrorMessage(StringTemplate template) {}</span>

<span class="fc" id="L1129">    public void showErrorMessage(String messageId) {}</span>

<span class="fc" id="L1131">    public void showErrorMessage(String messageID, String message) {}</span>

<span class="nc" id="L1133">    public void showEuropePanel() {}</span>

<span class="nc" id="L1135">    public void showEventPanel(String header, String image, String footer) {}</span>

<span class="nc" id="L1137">    public void showFindSettlementPanel() {}</span>

    public OptionGroup showGameOptionsDialog(boolean editable, boolean custom) {
<span class="nc" id="L1140">        return null;</span>
    }

<span class="nc" id="L1143">    public void showHighScoresPanel(String messageId, List&lt;HighScore&gt; scores) {}</span>

<span class="nc" id="L1145">    public void showIndianSettlementPanel(IndianSettlement indianSettlement) {}</span>

    public void showInformationMessage(String messageId) {
<span class="nc" id="L1148">        alertSound();</span>
<span class="nc" id="L1149">    }</span>

    public void showInformationMessage(StringTemplate template) {
<span class="nc" id="L1152">        alertSound();</span>
<span class="nc" id="L1153">    }</span>

    final public void showInformationMessage(Settlement displayObject,
                                       String messageId) {
<span class="nc" id="L1157">        showInformationMessage(displayObject, StringTemplate.key(messageId));</span>
<span class="nc" id="L1158">    }</span>

    public void showInformationMessage(Settlement displayObject,
                                       StringTemplate template) {
<span class="nc" id="L1162">        alertSound();</span>
<span class="nc" id="L1163">    }</span>

    public void showInformationMessage(Unit displayObject,
                                       StringTemplate template) {
<span class="nc" id="L1167">        alertSound();</span>
<span class="nc" id="L1168">    }</span>

    final public void showInformationMessage(Tile displayObject,
                                       String messageId) {
<span class="nc" id="L1172">        showInformationMessage(displayObject, StringTemplate.key(messageId));</span>
<span class="nc" id="L1173">    }</span>

    public void showInformationMessage(Tile displayObject,
                                       StringTemplate template) {
<span class="nc" id="L1177">        alertSound();</span>
<span class="nc" id="L1178">    }</span>

    public void showInformationMessage(FreeColObject displayObject,
                                       String messageId) {
<span class="nc" id="L1182">        alertSound();</span>
<span class="nc" id="L1183">    }</span>

    public void showInformationMessage(FreeColObject displayObject,
                                       StringTemplate template) {
<span class="nc" id="L1187">        alertSound();</span>
<span class="nc" id="L1188">    }</span>

    public File showLoadDialog(File directory) {
<span class="nc" id="L1191">        return null;</span>
    }

    final public File showLoadSaveFileDialog() {
<span class="nc" id="L1195">        File file = showLoadDialog(FreeColDirectories.getSaveDirectory());</span>
<span class="nc bnc" id="L1196" title="All 4 branches missed.">        if (file != null &amp;&amp; !file.isFile()) {</span>
<span class="nc" id="L1197">            showErrorMessage(&quot;error.noSuchFile&quot;);</span>
<span class="nc" id="L1198">            file = null;</span>
        }
<span class="nc" id="L1200">        return file;</span>
    }

    public boolean showLoadingSavegameDialog(boolean publicServer,
                                             boolean singlePlayer) {
<span class="nc" id="L1205">        return false;</span>
    }

<span class="nc" id="L1208">    public void showLogFilePanel() {}</span>

<span class="fc" id="L1210">    public void showMainPanel(String userMsg) {}</span>

    public OptionGroup showMapGeneratorOptionsDialog(boolean editable) {
<span class="nc" id="L1213">        return null;</span>
    }

    public Dimension showMapSizeDialog() {
<span class="nc" id="L1217">        return null;</span>
    }

<span class="nc" id="L1220">    public void showModelMessages(List&lt;ModelMessage&gt; modelMessages) {}</span>

    public void showMonarchDialog(final MonarchAction action,
                                  StringTemplate template, String monarchKey,
<span class="nc" id="L1224">                                  DialogHandler&lt;Boolean&gt; handler) {}</span>

    public void showNamingDialog(StringTemplate template,
                                 final String defaultName,
                                 final Unit unit,
<span class="nc" id="L1229">                                 DialogHandler&lt;String&gt; handler) {}</span>

    public void showFirstContactDialog(final Player player, final Player other,
                                       final Tile tile, int settlementCount,
<span class="nc" id="L1233">                                       DialogHandler&lt;Boolean&gt; handler) {}</span>

    public DiplomaticTrade showNegotiationDialog(FreeColGameObject our,
                                                     FreeColGameObject other,
                                                     DiplomaticTrade agreement,
                                                     StringTemplate comment) {
<span class="nc" id="L1239">        return null;</span>
    }

<span class="nc" id="L1242">    public void showNewPanel() {}</span>

<span class="nc" id="L1244">    public void showNewPanel(Specification specification) {}</span>

<span class="nc" id="L1246">    public void showSpyColonyPanel(final Tile tile) {}</span>

    public Parameters showParametersDialog() {
<span class="nc" id="L1249">        return null;</span>
    }

    public boolean showPreCombatDialog(Unit attacker,
                                       FreeColGameObject defender, Tile tile) {
<span class="nc" id="L1254">        return false;</span>
    }

<span class="nc" id="L1257">    public void showReportCargoPanel() {}</span>

<span class="nc" id="L1259">    public void showReportColonyPanel() {}</span>

<span class="nc" id="L1261">    public void showReportContinentalCongressPanel() {}</span>

<span class="nc" id="L1263">    public void showReportEducationPanel() {}</span>

<span class="nc" id="L1265">    public void showReportExplorationPanel() {}</span>

<span class="nc" id="L1267">    public void showReportForeignAffairPanel() {}</span>

<span class="nc" id="L1269">    public void showReportHistoryPanel() {}</span>

<span class="nc" id="L1271">    public void showReportIndianPanel() {}</span>

<span class="nc" id="L1273">    public void showReportLabourPanel() {}</span>

<span class="nc" id="L1275">    public void showReportMilitaryPanel() {}</span>

<span class="nc" id="L1277">    public void showReportNavalPanel() {}</span>

<span class="nc" id="L1279">    public void showReportProductionPanel() {}</span>

<span class="nc" id="L1281">    public void showReportReligiousPanel() {}</span>

<span class="nc" id="L1283">    public void showReportRequirementsPanel() {}</span>

<span class="nc" id="L1285">    public void showReportTradePanel() {}</span>

<span class="nc" id="L1287">    public void showReportTurnPanel(List&lt;ModelMessage&gt; messages) {}</span>

    public File showSaveDialog(File directory, String defaultName) {
<span class="nc" id="L1290">        return null;</span>
    }

    public Dimension showScaleMapSizeDialog() {
<span class="nc" id="L1294">        return null;</span>
    }

    public int showSelectAmountDialog(GoodsType goodsType, int available,
                                      int defaultAmount, boolean needToPay) {
<span class="nc" id="L1299">        return -1;</span>
    }

    public int showSelectTributeAmountDialog(StringTemplate question,
                                             int maximum) {
<span class="nc" id="L1304">        return -1;</span>
    }

    public Location showSelectDestinationDialog(Unit unit) {
<span class="nc" id="L1308">        return null;</span>
    }

    public void showStartGamePanel(Game game, Player player,
<span class="nc" id="L1312">                                   boolean singlePlayerMode) {}</span>

    public void showStatisticsPanel(Map&lt;String, String&gt; serverStats,
<span class="nc" id="L1315">                                    Map&lt;String, String&gt; clientStats) {}</span>

<span class="nc" id="L1317">    public void showStatusPanel(String message) {}</span>

<span class="nc" id="L1319">    public void showTilePopUpAtSelectedTile() {}</span>

<span class="nc" id="L1321">    public void showTradeRoutePanel(Unit unit) {}</span>

<span class="nc" id="L1323">    public void showVictoryDialog(DialogHandler&lt;Boolean&gt; handler) {}</span>

<span class="nc" id="L1325">    public void updateGameOptions() {}</span>

<span class="nc" id="L1327">    public void updateMapGeneratorOptions() {}</span>

<span class="nc" id="L1329">    public void centerActiveUnit() {}</span>

<span class="nc" id="L1331">    public void changeViewMode(int newViewMode) {}</span>

    public Unit getActiveUnit() {
<span class="fc" id="L1334">        return null;</span>
    }

    public Tile getFocus() {
<span class="nc" id="L1338">        return null;</span>
    }

    public Tile getSelectedTile() {
<span class="nc" id="L1342">        return null;</span>
    }

    public int getViewMode() {
<span class="nc" id="L1346">        return -1;</span>
    }

<span class="nc" id="L1349">    public void setFocus(Tile tileToFocus) {}</span>

    public boolean setSelectedTile(Tile newTileToSelect) {
<span class="nc" id="L1352">        return true; // Pretending again.</span>
    }

<span class="nc" id="L1355">    public void toggleViewMode() {}</span>


    // Forwarding to SoundController, only for gui classes in need of sound

    /**
     * Play a sound.
     *
     * @param sound The sound resource to play, or if null stop playing.
     */
    public void playSound(String sound) {
<span class="nc" id="L1366">        getSoundController().playSound(sound);</span>
<span class="nc" id="L1367">    }</span>

    /**
     * Plays an alert sound for an information message if the
     * option for it is turned on.
     */
    private void alertSound() {
<span class="nc bnc" id="L1374" title="All 2 branches missed.">        if (getClientOptions().getBoolean(ClientOptions.AUDIO_ALERTS)) {</span>
<span class="nc" id="L1375">            playSound(&quot;sound.event.alertSound&quot;);</span>
        }
<span class="nc" id="L1377">    }</span>

    /**
     * Get the label text for the sound player mixer.
     *
     * Needed by the audio mixer option UI.
     *
     * @return The text.
     */
    public String getSoundMixerLabelText() {
<span class="nc" id="L1387">        return getSoundController().getSoundMixerLabelText();</span>
    }

    // invoke method forwarding

    /**
     * Wrapper for SwingUtilities.invokeLater that handles the case
     * where we are already in the EDT.
     *
     * @param runnable A &lt;code&gt;Runnable&lt;/code&gt; to run.
     */
    public void invokeNowOrLater(Runnable runnable) {
<span class="nc bnc" id="L1399" title="All 2 branches missed.">        if (SwingUtilities.isEventDispatchThread()) {</span>
<span class="nc" id="L1400">            runnable.run();</span>
<span class="nc" id="L1401">        } else {</span>
<span class="nc" id="L1402">            SwingUtilities.invokeLater(runnable);</span>
        }
<span class="nc" id="L1404">    }</span>

    /**
     * Wrapper for SwingUtilities.invokeAndWait that handles the case
     * where we are already in the EDT.
     *
     * @param runnable A &lt;code&gt;Runnable&lt;/code&gt; to run.
     */
    public void invokeNowOrWait(Runnable runnable) {
<span class="nc bnc" id="L1413" title="All 2 branches missed.">        if (SwingUtilities.isEventDispatchThread()) {</span>
<span class="nc" id="L1414">            runnable.run();</span>
<span class="nc" id="L1415">        } else {</span>
            try {
<span class="nc" id="L1417">                SwingUtilities.invokeAndWait(runnable);</span>
<span class="nc" id="L1418">            } catch (InterruptedException | InvocationTargetException ex) {</span>
<span class="nc" id="L1419">                logger.log(Level.WARNING, &quot;Client GUI interaction&quot;, ex);</span>
            }
        }
<span class="nc" id="L1422">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span>src (May 7, 2016 6:04:12 PM)</div></body></html>