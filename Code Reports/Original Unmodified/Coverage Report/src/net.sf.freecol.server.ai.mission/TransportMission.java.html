<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>TransportMission.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">src (May 7, 2016 6:04:12 PM)</a> &gt; <a href="../../index.html" class="el_group">FreeCol</a> &gt; <a href="../index.html" class="el_bundle">src</a> &gt; <a href="index.source.html" class="el_package">net.sf.freecol.server.ai.mission</a> &gt; <span class="el_source">TransportMission.java</span></div><h1>TransportMission.java</h1><pre class="source lang-java linenums"><span class="nc" id="L1">/**</span>
 *  Copyright (C) 2002-2016   The FreeCol Team
 *
 *  This file is part of FreeCol.
 *
 *  FreeCol is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  FreeCol is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with FreeCol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package net.sf.freecol.server.ai.mission;

import java.util.ArrayList;
import java.util.List;
import java.util.Iterator;
import java.util.logging.Logger;

import java.util.stream.Collectors;
import javax.xml.stream.XMLStreamException;

import net.sf.freecol.common.FreeColException;
import net.sf.freecol.common.io.FreeColXMLReader;
import net.sf.freecol.common.io.FreeColXMLWriter;
import net.sf.freecol.common.model.Colony;
import net.sf.freecol.common.model.CombatModel;
import net.sf.freecol.common.model.Europe;
import net.sf.freecol.common.model.Goods;
import net.sf.freecol.common.model.GoodsType;
import net.sf.freecol.common.model.Locatable;
import net.sf.freecol.common.model.Location;
import net.sf.freecol.common.model.Map;
import net.sf.freecol.common.model.Direction;
import net.sf.freecol.common.model.PathNode;
import net.sf.freecol.common.model.Tile;
import net.sf.freecol.common.model.Unit;
import net.sf.freecol.common.model.pathfinding.CostDecider;
import net.sf.freecol.common.model.pathfinding.CostDeciders;
import net.sf.freecol.common.util.LogBuilder;
import static net.sf.freecol.common.util.CollectionUtils.*;
import net.sf.freecol.server.ai.AIColony;
import net.sf.freecol.server.ai.AIGoods;
import net.sf.freecol.server.ai.AIMain;
import net.sf.freecol.server.ai.AIMessage;
import net.sf.freecol.server.ai.AIUnit;
import net.sf.freecol.server.ai.Cargo;
import net.sf.freecol.server.ai.EuropeanAIPlayer;
import net.sf.freecol.server.ai.TransportableAIObject;


/**
 * Mission for transporting units and goods on a carrier.
 *
 * @see net.sf.freecol.common.model.Unit Unit
 */
<span class="pc bpc" id="L64" title="1 of 2 branches missed.">public class TransportMission extends Mission {</span>

<span class="fc" id="L66">    private static final Logger logger = Logger.getLogger(TransportMission.class.getName());</span>

    private static final String tag = &quot;AI transport&quot;;

<span class="nc" id="L70">    private static enum CargoResult {</span>
<span class="nc" id="L71">        TCONTINUE,  // Cargo should continue</span>
<span class="nc" id="L72">        TDONE,      // Cargo completed successfully</span>
<span class="nc" id="L73">        TFAIL,      // Cargo failed badly</span>
<span class="nc" id="L74">        TNEXT,      // Cargo changed to its next state</span>
<span class="nc" id="L75">        TRETRY      // Cargo has blocked, retry</span>
    }

    /**
     * Insist transport lists remain simple by imposing an upper bound
     * on the distinct destination locations to visit.
     */
    private static final int DESTINATION_UPPER_BOUND = 4;

    private static final int MINIMUM_GOLD_TO_STAY_IN_EUROPE = 600;

    /** A list of &lt;code&gt;Cargo&lt;/code&gt;s to work on. */
<span class="pc" id="L87">    private final List&lt;Cargo&gt; cargoes = new ArrayList&lt;&gt;();</span>

    /** The current target location to travel to. */
    private Location target;


    /**
     * Creates a mission for the given &lt;code&gt;AIUnit&lt;/code&gt;.
     *
     * @param aiMain The main AI-object.
     * @param aiUnit The &lt;code&gt;AIUnit&lt;/code&gt; this mission is created for.
     */
    public TransportMission(AIMain aiMain, AIUnit aiUnit) {
<span class="fc" id="L100">        super(aiMain, aiUnit, aiUnit.getTrivialTarget());</span>
<span class="fc" id="L101">    }</span>

    /**
     * Creates a new &lt;code&gt;TransportMission&lt;/code&gt; and reads the given
     * element.
     *
     * @param aiMain The main AI-object.
     * @param aiUnit The &lt;code&gt;AIUnit&lt;/code&gt; this mission is created for.
     * @param xr The input stream containing the XML.
     * @throws XMLStreamException if a problem was encountered during parsing.
     * @see net.sf.freecol.server.ai.AIObject#readFromXML
     */
    public TransportMission(AIMain aiMain, AIUnit aiUnit,
                            FreeColXMLReader xr) throws XMLStreamException {
<span class="nc" id="L115">        super(aiMain, aiUnit);</span>

<span class="nc" id="L117">        readFromXML(xr);</span>
<span class="nc" id="L118">    }</span>


    /**
     * Disposes of this &lt;code&gt;Mission&lt;/code&gt;.
     */
    @Override
    public void dispose() {
<span class="fc" id="L126">        logger.finest(tag + &quot; disposing (&quot; + clearCargoes() + &quot;): &quot; + this</span>
            //+ &quot;\n&quot; + net.sf.freecol.common.debug.FreeColDebugger.stackTraceToString()
            );
<span class="fc" id="L129">        super.dispose();</span>
<span class="fc" id="L130">    }</span>


    // Simple internal utilities

    /**
     * Checks if the carrier using this mission is carrying the given
     * &lt;code&gt;TransportableAIObject&lt;/code&gt;.
     *
     * @param t The &lt;code&gt;TransportableAIObject&lt;/code&gt; to check.
     * @return True if the carrier is carrying the transportable.
     */
    private boolean isCarrying(TransportableAIObject t) {
<span class="pc bpc" id="L143" title="1 of 4 branches missed.">        return t != null &amp;&amp; t.getLocation() == getUnit();</span>
    }

    /**
     * Is a transportable waiting for delivery on the cargoes list?
     *
     * @param t The &lt;code&gt;TransportableAIObject&lt;/code&gt; to check.
     * @return True if the transportable is queued in this mission.
     */
    public boolean isTransporting(TransportableAIObject t) {
<span class="nc bnc" id="L153" title="All 2 branches missed.">        return tFind(t) != null;</span>
    }

    /**
     * Decide if this unit has a good chance of defeating another.
     * If there is cargo aboard, be more conservative.
     *
     * FIXME: magic numbers to the spec.
     *
     * @param other The other &lt;code&gt;Unit&lt;/code&gt; to attack.
     * @return True if the attack should proceed.
     */
    private boolean shouldAttack(Unit other) {
<span class="nc bnc" id="L166" title="All 2 branches missed.">        if (invalidAttackReason(getAIUnit(),</span>
<span class="nc" id="L167">                                other.getOwner()) != null) return false;</span>
<span class="nc" id="L168">        final Unit carrier = getUnit();</span>
<span class="nc" id="L169">        final CombatModel cm = getGame().getCombatModel();</span>
<span class="nc" id="L170">        double offence = cm.getOffencePower(carrier, other)</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">            * ((carrier.hasCargo()) ? 0.3 : 0.80);</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">        return offence &gt; cm.getOffencePower(other, carrier);</span>
    }


    // Cargoes handling.
    // *Nothing* should touch &quot;cargoes&quot; but these.
    // It needs synchronization because of possible changes due to the
    // carrier being destroyed.

    /**
     * Gets the cargoes.
     *
     * @return A copy of the list of cargoes.
     */
    private List&lt;Cargo&gt; tCopy() {
<span class="pc" id="L187">        synchronized (cargoes) {</span>
<span class="fc" id="L188">            return new ArrayList&lt;&gt;(cargoes);</span>
        }
    }

    /**
     * Clears the cargoes list.
     *
     * @return The old cargoes list.
     */
    private List&lt;Cargo&gt; tClear() {
<span class="fc" id="L198">        List&lt;Cargo&gt; old = new ArrayList&lt;&gt;();</span>
<span class="pc" id="L199">        synchronized (cargoes) {</span>
<span class="fc" id="L200">            old.addAll(cargoes);</span>
<span class="fc" id="L201">            cargoes.clear();</span>
        }
<span class="fc" id="L203">        return old;</span>
    }

    /**
     * Sets the cargoes to a new list.
     *
     * @param nxt The new cargoes list.
     * @param setSpace If true, call tSpace to reset the space left values.
     * @return The old cargoes list.
     */
    private List&lt;Cargo&gt; tSet(List&lt;Cargo&gt; nxt, boolean setSpace) {
<span class="nc" id="L214">        List&lt;Cargo&gt; old = tCopy();</span>
<span class="nc" id="L215">        synchronized (cargoes) {</span>
<span class="nc" id="L216">            cargoes.clear();</span>
<span class="nc" id="L217">            cargoes.addAll(transform(nxt, Cargo::isValid, Collectors.toList()));</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">            if (setSpace) tSpace();</span>
        }
<span class="nc" id="L220">        tRetarget();</span>
<span class="nc" id="L221">        return old;</span>
    }

    /**
     * Gets the size of the cargoes.
     *
     * @return The size of the cargoes.
     */
    private int tSize() {
        int size;
<span class="nc" id="L231">        synchronized (cargoes) {</span>
<span class="nc" id="L232">            size = cargoes.size();</span>
        }
<span class="nc" id="L234">        return size;</span>
    }

    /**
     * Find a &lt;code&gt;Cargo&lt;/code&gt; with the given
     * &lt;code&gt;TransportableAIObject&lt;/code&gt;.
     *
     * @param t The &lt;code&gt;TransportableAIObject&lt;/code&gt; to look for.
     * @return The &lt;code&gt;Cargo&lt;/code&gt; found, or null if none found.
     */
    private Cargo tFind(TransportableAIObject t) {
<span class="pc" id="L245">        synchronized (cargoes) {</span>
<span class="pc bnc" id="L246" title="All 2 branches missed.">            return find(cargoes, c -&gt; c.getTransportable() == t);</span>
        }
    }

    /**
     * Gets the first cargo.
     *
     * @return The first valid cargo, or null if none found.
     */
    private Cargo tFirst() {
<span class="pc" id="L256">        synchronized (cargoes) {</span>
<span class="fc" id="L257">            return find(cargoes, Cargo::isValid);</span>
        }
    }

    /**
     * Adds a cargo to the cargoes list.
     *
     * @param cargo The &lt;code&gt;Cargo&lt;/code&gt; to add.
     * @param index The position to add it.
     * @return True if the addition succeeded or the cargo was already present.
     */
    private boolean tAdd(Cargo cargo, int index) {
<span class="pc bpc" id="L269" title="1 of 2 branches missed.">        if (!cargo.isValid()) return false;</span>
<span class="pc bpc" id="L270" title="1 of 2 branches missed.">        if (tFind(cargo.getTransportable()) != null) return true;</span>
<span class="fc" id="L271">        boolean change = false;</span>
<span class="pc" id="L272">        synchronized (cargoes) {</span>
<span class="pc bpc" id="L273" title="3 of 4 branches missed.">            change = cargoes.isEmpty() || index == 0;</span>
<span class="pc bpc" id="L274" title="1 of 2 branches missed.">            if (index &gt;= 0) {</span>
<span class="fc" id="L275">                cargoes.add(index, cargo); </span>
<span class="fc" id="L276">            } else {</span>
<span class="nc" id="L277">                cargoes.add(cargo);</span>
            }
<span class="fc" id="L279">            tSpace();</span>
        }
<span class="pc bpc" id="L281" title="1 of 2 branches missed.">        if (change) tRetarget();</span>
<span class="fc" id="L282">        return true;</span>
    }

    /**
     * Remove a cargo from the cargoes list.
     *
     * @param cargo The &lt;code&gt;Cargo&lt;/code&gt; to remove.
     * @return True if the remove succeeded.
     */
    private boolean tRemove(Cargo cargo) {
<span class="nc" id="L292">        boolean result = false, change = false;</span>
<span class="nc" id="L293">        final TransportableAIObject t = cargo.getTransportable();</span>
<span class="nc" id="L294">        synchronized (cargoes) {</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">            for (int i = 0; i &lt; cargoes.size(); i++) {</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">                if (cargoes.get(i).getTransportable() == t) {</span>
<span class="nc" id="L297">                    cargoes.remove(i);</span>
<span class="nc" id="L298">                    tSpace();</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">                    change = i == 0;</span>
<span class="nc" id="L300">                    result = true;</span>
<span class="nc" id="L301">                    break;</span>
                }
            }
        }
<span class="nc bnc" id="L305" title="All 2 branches missed.">        if (change) tRetarget();</span>
<span class="nc" id="L306">        return result;</span>
    }

    /**
     * Sets the spaceLeft fields in the cargoes.
     * To be called with synchronized (cargoes).
     */
    private void tSpace() {
<span class="fc" id="L314">        final Unit carrier = getUnit();</span>
<span class="fc" id="L315">        final int maxHolds = carrier.getCargoCapacity();</span>
<span class="fc" id="L316">        int holds = carrier.getCargoSpaceTaken();</span>
<span class="fc bfc" id="L317" title="All 2 branches covered.">        for (Cargo cargo : cargoes) {</span>
<span class="pc bpc" id="L318" title="1 of 2 branches missed.">            if (!cargo.isValid()) continue;</span>
<span class="fc" id="L319">            holds += cargo.getNewSpace();</span>
<span class="fc" id="L320">            cargo.setSpaceLeft(maxHolds - holds);</span>
        }
<span class="fc" id="L322">    }</span>

    /**
     * Reset the carrier target after a change to the first cargo.
     */
    private void tRetarget() {
        Cargo c;
<span class="pc" id="L329">        synchronized (cargoes) {</span>
<span class="fc" id="L330">            c = find(cargoes, Cargo::isValid);</span>
        }
<span class="fc bfc" id="L332" title="All 2 branches covered.">        setTarget(Location.upLoc((c == null) ? getAIUnit().getTrivialTarget()</span>
<span class="fc" id="L333">                : c.getCarrierTarget()));</span>
<span class="fc" id="L334">    }</span>

    // Medium-level cargo and target manipulation, should be kept
    // private to TransportMission.

    /**
     * Count distinct non-adjacent destinations in a list of cargoes.
     *
     * @return The number of distinct destinations.
     */
    private int destinationCount() {
<span class="nc" id="L345">        Location now = null;</span>
<span class="nc" id="L346">        int ret = 0;</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">        for (Cargo cargo : tCopy()) {</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">            if (!Map.isSameLocation(now, cargo.getCarrierTarget())) {</span>
<span class="nc" id="L349">                ret++;</span>
<span class="nc" id="L350">                now = cargo.getCarrierTarget();</span>
            }
        }
<span class="nc" id="L353">        return ret;</span>
    }                

    /**
     * How many more destinations are desirable on the current cargoes list?
     * Must be public!  This is checked in European AI player.
     *
     * @return The number of desired extra destinations.
     */
    public int destinationCapacity() {
<span class="nc" id="L363">        return DESTINATION_UPPER_BOUND - destinationCount();</span>
    }

    /**
     * If this carrier is the current carrier of a transportable, drop it.
     *
     * @param t The &lt;code&gt;TransportableAIObject&lt;/code&gt; to check.
     */
    private void dropTransportable(TransportableAIObject t) {
<span class="nc" id="L372">        AIUnit carrier = getAIUnit();</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">        if (t.getTransport() == carrier) t.setTransport(null);</span>
<span class="nc" id="L374">    }</span>

    /**
     * If this carrier is the not the current carrier of a
     * transportable, make it so.
     *
     * @param t The &lt;code&gt;TransportableAIObject&lt;/code&gt; to check.
     */
    private void takeTransportable(TransportableAIObject t) {
<span class="fc" id="L383">        AIUnit carrier = getAIUnit();</span>
<span class="pc bpc" id="L384" title="1 of 2 branches missed.">        if (t.getTransport() != carrier) t.setTransport(carrier);</span>
<span class="fc" id="L385">    }</span>

    /**
     * Get the collection location for an uncollected transportable.
     *
     * Public so that mobile transportables (units) can move to the
     * collection point.
     *
     * @param t The &lt;code&gt;TransportableAIObject&lt;/code&gt; to collect.
     * @return The collection &lt;code&gt;Location&lt;/code&gt;, or null if not found.
     */
    public Location getTransportTarget(TransportableAIObject t) {
<span class="nc bnc" id="L397" title="All 2 branches missed.">        if (isCarrying(t)) return null;</span>
<span class="nc" id="L398">        Cargo cargo = tFind(t);</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">        return (cargo == null) ? null : cargo.getTransportTarget();</span>
    }

    /**
     * Get the expected turns for an uncollected transport
     *
     * Public so that mobile transportables (units) can renege on
     * transport if they find themselves better able to get there
     * themselves.
     *
     * @param t The &lt;code&gt;TransportableAIObject&lt;/code&gt; to collect.
     * @return The expected transport turns.
     */
    public int getTransportTurns(TransportableAIObject t) {
<span class="nc bnc" id="L413" title="All 2 branches missed.">        if (isCarrying(t)) return INFINITY;</span>
<span class="nc" id="L414">        Cargo cargo = tFind(t);</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">        return (cargo == null) ? INFINITY : cargo.getTurns();</span>
    }

    /**
     * Wrap up the compatible cargoes in a list.
     * O(N^2) alas.
     *
     * @return A wrapped list of cargoes.
     */
    private List&lt;Cargo&gt; wrapCargoes() {
<span class="nc" id="L425">        List&lt;Cargo&gt; ts = tCopy();</span>
<span class="nc bnc" id="L426" title="All 2 branches missed.">        for (int i = 0; i &lt; ts.size()-1; i++) {</span>
<span class="nc" id="L427">            Cargo head = ts.get(i);</span>
<span class="nc bnc" id="L428" title="All 4 branches missed.">            while (i+1 &lt; ts.size() &amp;&amp; head.couldWrap(ts.get(i+1))) {</span>
<span class="nc" id="L429">                head.wrap(ts.remove(i+1));</span>
            }
        }
<span class="nc" id="L432">        return ts;</span>
    }

    /**
     * Unwrap a wrapped list of cargoes.
     *
     * @param ts The list of &lt;code&gt;Cargo&lt;/code&gt;s to unwrap.
     * @return The unwrapped list of cargoes.
     */
    private List&lt;Cargo&gt; unwrapCargoes(List&lt;Cargo&gt; ts) {
<span class="nc bnc" id="L442" title="All 2 branches missed.">        for (int i = 0; i &lt; ts.size(); i++) {</span>
<span class="nc" id="L443">            Cargo t = ts.get(i);</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">            if (t.hasWrapped()) {</span>
<span class="nc" id="L445">                List&lt;Cargo&gt; tl = t.unwrap();</span>
<span class="nc" id="L446">                ts.addAll(i+1, tl);</span>
<span class="nc" id="L447">                i += tl.size();</span>
            }
        }
<span class="nc" id="L450">        return ts;</span>
    }

    /**
     * Clears all the cargoes.
     *
     * @return A message about the cargoes being cleared.
     */
    private String clearCargoes() {
<span class="fc" id="L459">        String log = &quot;cargoes cleared: &quot;;</span>
<span class="pc bpc" id="L460" title="1 of 2 branches missed.">        for (Cargo cargo : tClear()) {</span>
<span class="nc" id="L461">            dropTransportable(cargo.getTransportable());</span>
<span class="nc" id="L462">            log += &quot; &quot; + cargo;</span>
        }
<span class="fc" id="L464">        tRetarget();</span>
<span class="fc" id="L465">        return log;</span>
    }

    /**
     * Is there nothing currently queued for this carrier?
     *
     * @return True if there is no work allocated to this carrier.
     */
    public boolean isEmpty() {
<span class="nc bnc" id="L474" title="All 2 branches missed.">        return tSize() == 0;</span>
    }

    /**
     * For a given transportable, work out where the carrier has to go to
     * advance the cargo (target), and what to do there (mode), allowing
     * a new &lt;code&gt;Cargo&lt;/code&gt; to be defined.
     *
     * AIUnit cargo is harder than AIGoods, because AIUnits might have their
     * own inland paths, and thus we need to consider drop nodes.
     *
     * @param t The &lt;code&gt;TransportableAIObject&lt;/code&gt; to consider.
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     * @return A new &lt;code&gt;Cargo&lt;/code&gt; defining the action to take
     *     with the &lt;code&gt;TransportableAIObject&lt;/code&gt;, or null if impossible.
     */
    public Cargo makeCargo(TransportableAIObject t, LogBuilder lb) {
<span class="fc" id="L491">        final Unit carrier = getUnit();</span>
        String reason;
<span class="fc" id="L493">        Cargo cargo = null;</span>
<span class="pc bpc" id="L494" title="1 of 2 branches missed.">        if (t.getTransportDestination() == null) {</span>
<span class="nc bnc" id="L495" title="All 2 branches missed.">            if (!isCarrying(t)) {</span>
<span class="nc" id="L496">                reason = &quot;null transport destination&quot;;</span>
<span class="nc" id="L497">            } else {</span>
                // Can happen with carriers with units transferred in
                // Spanish succession.
<span class="nc" id="L500">                PathNode path = carrier.getTrivialPath();</span>
<span class="nc bnc" id="L501" title="All 2 branches missed.">                if (path == null) {</span>
<span class="nc" id="L502">                    reason = &quot;null transport destination&quot;;</span>
<span class="nc" id="L503">                } else {</span>
                    try {
<span class="nc" id="L505">                        reason = null;</span>
<span class="nc" id="L506">                        cargo = Cargo.newCargo(t, carrier,</span>
<span class="nc" id="L507">                            path.getLastNode().getLocation(), true);</span>
<span class="nc" id="L508">                    } catch (FreeColException fce) {</span>
<span class="nc" id="L509">                        reason = fce.getMessage();</span>
<span class="nc" id="L510">                        cargo = null;</span>
                    }
                }
            }
<span class="pc bpc" id="L514" title="1 of 4 branches missed.">        } else if (!isCarrying(t) &amp;&amp; !t.carriableBy(carrier)) {</span>
<span class="nc" id="L515">            reason = &quot;carrier &quot; + carrier.toShortString() + &quot; can not carry&quot;;</span>
<span class="nc" id="L516">        } else {</span>
            try {
<span class="fc" id="L518">                reason = null;</span>
<span class="fc" id="L519">                cargo = Cargo.newCargo(t, carrier);</span>
<span class="fc" id="L520">            } catch (FreeColException fce) {</span>
<span class="fc" id="L521">                reason = fce.getMessage();</span>
<span class="fc" id="L522">                cargo = null;</span>
            }
        }
<span class="fc bfc" id="L525" title="All 2 branches covered.">        if (reason == null) {</span>
<span class="fc" id="L526">            lb.add(&quot;, made &quot;, cargo.toShortString());</span>
<span class="fc" id="L527">            return cargo;</span>
        } else {
<span class="fc" id="L529">            lb.add(&quot;, failed to make cargo for &quot;, t, &quot; (&quot;, reason, &quot;)&quot;);</span>
<span class="fc" id="L530">            return null;</span>
        }
    }

    /**
     * Add the given Cargo to the cargoes list.
     *
     * @param cargo The &lt;code&gt;Cargo&lt;/code&gt; to add.
     * @param index The index of where to add the cargo.
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     * @return True if the cargo was added.
     */
    private boolean addCargo(Cargo cargo, int index, LogBuilder lb) {
<span class="fc" id="L543">        boolean result = tAdd(cargo, index);</span>
<span class="pc bpc" id="L544" title="1 of 2 branches missed.">        if (result) takeTransportable(cargo.getTransportable());</span>

<span class="pc bpc" id="L546" title="1 of 2 branches missed.">        if (result) {</span>
<span class="fc" id="L547">            lb.add(&quot;, added &quot;, cargo.toShortString(),</span>
<span class="pc bpc" id="L548" title="1 of 2 branches missed.">                   &quot; at &quot;, ((index &lt; 0) ? &quot;end&quot; : Integer.toString(index)));</span>
<span class="fc" id="L549">        } else {</span>
<span class="nc" id="L550">            lb.add(&quot;, failed to add &quot;, cargo.toShortString());</span>
        }
<span class="fc" id="L552">        return result;</span>
    }

    /**
     * Removes the given Cargo from the cargoes list.
     *
     * @param cargo The &lt;code&gt;Cargo&lt;/code&gt; to remove.
     */
    private void removeCargo(Cargo cargo) {
<span class="nc bnc" id="L561" title="All 2 branches missed.">        if (!tRemove(cargo)) {</span>
<span class="nc" id="L562">            throw new RuntimeException(&quot;removeCargo &quot; + cargo.toShortString());</span>
        }
<span class="nc" id="L564">        dropTransportable(cargo.getTransportable());</span>
<span class="nc" id="L565">    }</span>

    /**
     * Is there space available for a new cargo?
     *
     * @param cargo The &lt;code&gt;Cargo&lt;/code&gt; to check.
     * @return True if there is space available for this cargo.
     */
    public boolean spaceAvailable(Cargo cargo) {
<span class="nc" id="L574">        return spaceAvailable(cargo.getTransportable());</span>
    }

    /**
     * Is there space available for a new cargo?
     *
     * @param t The &lt;code&gt;TransportableAIObject&lt;/code&gt; to check.
     * @return True if there is space available for this transportable.
     */
    public boolean spaceAvailable(TransportableAIObject t) {
<span class="nc" id="L584">        final List&lt;Cargo&gt; ts = tCopy();</span>
<span class="nc" id="L585">        final int newSpace = t.getSpaceTaken();</span>

<span class="nc bnc" id="L587" title="All 2 branches missed.">        for (int i = ts.size()-1; i &gt;= 0; i--) {</span>
<span class="nc bnc" id="L588" title="All 2 branches missed.">            if (ts.get(i).getSpaceLeft() &lt; newSpace) return false;</span>
        }
<span class="nc" id="L590">        return true;</span>
    }

   
    /**
     * Incrementally queue a cargo to the cargoes list.
     *
     * If the carrier is at the collection point favour immediate
     * collection.  Otherwise try to place it with other cargoes with
     * the same target, but do not break the space restrictions.  If
     * this does not work, it has to go at the end.
     *
     * @param cargo The new &lt;code&gt;Cargo&lt;/code&gt; to add.
     * @param requireMatch Fail if an existing destination is not matched.
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     * @return True if the cargo was queued.
     */
    private boolean queueCargo(Cargo cargo, boolean requireMatch,
                               LogBuilder lb) {
<span class="fc" id="L609">        final Unit carrier = getUnit();</span>
<span class="fc" id="L610">        final List&lt;Cargo&gt; ts = tCopy();</span>
<span class="fc" id="L611">        int candidate = -1;</span>

<span class="pc bpc" id="L613" title="1 of 2 branches missed.">        if (ts.isEmpty() // Trivial case</span>
<span class="nc" id="L614">            || (Map.isSameLocation(carrier.getLocation(), // Carrier here?</span>
<span class="nc bnc" id="L615" title="All 2 branches missed.">                                   cargo.getCarrierTarget())</span>
<span class="nc bnc" id="L616" title="All 2 branches missed.">                &amp;&amp; cargo.canQueueAt(carrier, 0, ts))) {</span>
<span class="fc" id="L617">            candidate = 0;</span>
        }

<span class="pc bpc" id="L620" title="1 of 2 branches missed.">        if (candidate &lt; 0) { // Match an existing target?</span>
<span class="nc bnc" id="L621" title="All 2 branches missed.">            for (int i = 0; i &lt; ts.size(); i++) {</span>
<span class="nc" id="L622">                Cargo tr = ts.get(i);</span>
<span class="nc" id="L623">                if (Map.isSameLocation(tr.getCarrierTarget(),</span>
<span class="nc bnc" id="L624" title="All 2 branches missed.">                                       cargo.getCarrierTarget())) {</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">                    if (!cargo.canQueueAt(carrier, i, ts)) continue;</span>
<span class="nc" id="L626">                    candidate = i;</span>
<span class="nc" id="L627">                    break;</span>
                }
            }
        }
        
<span class="pc bpc" id="L632" title="1 of 2 branches missed.">        if (candidate &lt; 0) { // Queue at end unless match required</span>
<span class="nc bnc" id="L633" title="All 2 branches missed.">            if (requireMatch) return false;</span>
<span class="nc" id="L634">            candidate = ts.size();</span>
        }
<span class="fc" id="L636">        return addCargo(cargo, candidate, lb);</span>
    }

    /**
     * Dump a currently carried cargo.
     *
     * @param cargo The &lt;code&gt;Cargo&lt;/code&gt; to dump.
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     * @return True if the cargo is no longer on board and not on the
     *     transport list, or is on board but is scheduled to be dumped.
     */
    public boolean dumpCargo(Cargo cargo, LogBuilder lb) {
<span class="nc" id="L648">        TransportableAIObject t = cargo.getTransportable();</span>
<span class="nc bnc" id="L649" title="All 2 branches missed.">        if (isCarrying(t)) t.leaveTransport();</span>
<span class="nc bnc" id="L650" title="All 4 branches missed.">        if (!isCarrying(t) &amp;&amp; tFind(t) != null) removeCargo(cargo);</span>
<span class="nc bnc" id="L651" title="All 2 branches missed.">        if (tFind(t) != null) {</span>
<span class="nc" id="L652">            String reason = cargo.dump();</span>
<span class="nc bnc" id="L653" title="All 2 branches missed.">            if (reason != null) {</span>
<span class="nc" id="L654">                lb.add(&quot;, dump failed(&quot;, reason, &quot;)&quot;);</span>
<span class="nc" id="L655">                return false;</span>
            } else {
<span class="nc" id="L657">                lb.add(&quot;, dumping&quot;);</span>
            }
        }
<span class="nc" id="L660">        return true;</span>
    }

    /**
     * Requeue an existing cargo.  Typically done when the target changes.
     *
     * @param cargo The &lt;code&gt;Cargo&lt;/code&gt; to requeue.
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     * @return True if the queuing succeeded.
     */
    public boolean requeueCargo(Cargo cargo, LogBuilder lb) {
<span class="nc" id="L671">        final TransportableAIObject t = cargo.getTransportable();</span>
<span class="nc" id="L672">        boolean ret = false;</span>
<span class="nc bnc" id="L673" title="All 4 branches missed.">        assert tFind(t) == cargo;</span>
<span class="nc" id="L674">        String reason = cargo.update();</span>
<span class="nc bnc" id="L675" title="All 2 branches missed.">        if (reason != null) {</span>
<span class="nc" id="L676">            lb.add(&quot; requeue/update fail(&quot;, reason, &quot;) &quot;,</span>
<span class="nc" id="L677">                   cargo.toShortString());</span>
<span class="nc" id="L678">            dumpCargo(cargo, lb);</span>
<span class="nc bnc" id="L679" title="All 2 branches missed.">        } else if (!tRemove(cargo)) {</span>
<span class="nc" id="L680">            lb.add(&quot; requeue/remove fail &quot;, cargo.toShortString());</span>
<span class="nc bnc" id="L681" title="All 2 branches missed.">        } else if (!queueCargo(cargo, false, lb)) {</span>
<span class="nc" id="L682">            lb.add(&quot; requeue/queue fail &quot;, cargo.toShortString());</span>
<span class="nc" id="L683">            dropTransportable(t);</span>
<span class="nc" id="L684">        } else {</span>
<span class="nc" id="L685">            lb.add(&quot; requeued(&quot;, cargo.getTransportTarget(), &quot;) &quot;,</span>
<span class="nc" id="L686">                   cargo.toShortString());</span>
<span class="nc" id="L687">            takeTransportable(t);</span>
<span class="nc" id="L688">            ret = true;</span>
        }
<span class="nc" id="L690">        return ret;</span>
    }

    /**
     * Checks for invalid cargoes, and units and goods on board but
     * not in the cargoes list.  On exit from this routine, every
     * cargo on board should be on the cargoes list but the list is
     * not necessarily going to be in a sensible order.
     *
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     */
    private void checkCargoes(LogBuilder lb) {
<span class="fc" id="L702">        final Unit carrier = getUnit();</span>
<span class="pc bpc" id="L703" title="1 of 2 branches missed.">        if (carrier.isAtSea()) return; // Let it emerge.</span>
<span class="fc" id="L704">        final AIUnit aiCarrier = getAIUnit();</span>

<span class="fc" id="L706">        List&lt;Unit&gt; unitsPresent = carrier.getUnitList();</span>
<span class="fc" id="L707">        List&lt;Goods&gt; goodsPresent = carrier.getCompactGoods();</span>
<span class="fc" id="L708">        List&lt;TransportableAIObject&gt; todo = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L709">        List&lt;TransportableAIObject&gt; drop = new ArrayList&lt;&gt;();</span>

        String reason;
        PathNode path;
        boolean dump;
<span class="fc" id="L714">        lb.add(&quot; [check&quot;);</span>
<span class="fc bfc" id="L715" title="All 2 branches covered.">        for (Cargo cargo : tCopy()) {</span>
<span class="fc" id="L716">            dump = false;</span>
<span class="fc" id="L717">            TransportableAIObject t = cargo.getTransportable();</span>
<span class="fc" id="L718">            reason = invalidReason(aiCarrier, cargo.getCarrierTarget());</span>
<span class="pc bpc" id="L719" title="2 of 4 branches missed.">            if (reason != null || (reason = cargo.check(aiCarrier)) != null) {</span>
                // Just remove, it is invalid
<span class="nc" id="L721">                removeCargo(cargo);</span>
<span class="nc" id="L722">                lb.add(&quot;, INVALID(&quot;, reason, &quot;) &quot;, cargo.toShortString());</span>
<span class="pc bpc" id="L723" title="1 of 2 branches missed.">            } else if (cargo.isDelivered()) {</span>
<span class="nc" id="L724">                removeCargo(cargo);</span>
<span class="nc" id="L725">                lb.add(&quot;, COMPLETED &quot;, cargo.toShortString());</span>
<span class="pc bpc" id="L726" title="3 of 4 branches missed.">            } else if (!cargo.hasPath() &amp;&amp; !cargo.retry()) {</span>
<span class="nc" id="L727">                reason = &quot; no-path&quot;;</span>
<span class="nc" id="L728">                dump = true;</span>
<span class="pc bpc" id="L729" title="2 of 4 branches missed.">            } else if (carrier.hasTile() &amp;&amp; (reason = cargo.update()) != null) {</span>
<span class="nc bnc" id="L730" title="All 2 branches missed.">                if (reason.startsWith(&quot;invalid&quot;)) {</span>
<span class="nc" id="L731">                    removeCargo(cargo);</span>
<span class="nc" id="L732">                    lb.add(&quot;, FAIL(&quot;, reason, &quot;) &quot;, cargo.toShortString());</span>
<span class="nc bnc" id="L733" title="All 2 branches missed.">                } else if (cargo.retry()) {</span>
<span class="nc" id="L734">                    lb.add(&quot;, retry-&quot;, cargo.getTries(), &quot;(&quot;, reason, &quot;)&quot;);</span>
<span class="nc" id="L735">                } else {</span>
<span class="nc" id="L736">                    dump = true;</span>
                }
<span class="pc bpc" id="L738" title="1 of 2 branches missed.">            } else if (cargo.isCollectable()) {</span>
<span class="nc" id="L739">                lb.add(&quot;, collect &quot;, cargo.toShortString());</span>
<span class="pc bpc" id="L740" title="1 of 2 branches missed.">            } else if (cargo.isDeliverable()) {</span>
<span class="nc" id="L741">                lb.add(&quot;, deliver &quot;, cargo.toShortString());</span>
<span class="nc" id="L742">            } else {</span>
<span class="fc" id="L743">                lb.add(&quot;, ok &quot;, cargo.toShortString()); // Good</span>
<span class="fc" id="L744">                cargo.resetTries();</span>
            }
<span class="pc bpc" id="L746" title="1 of 2 branches missed.">            if (dump) {</span>
<span class="nc bnc" id="L747" title="All 2 branches missed.">                if (cargo.isCarried()) {</span>
<span class="nc" id="L748">                    dumpCargo(cargo, lb); // FIXME: can fail</span>
<span class="nc" id="L749">                } else {</span>
<span class="nc" id="L750">                    removeCargo(cargo);</span>
<span class="nc" id="L751">                    lb.add(&quot;, dropped(&quot;, reason, &quot;) &quot;, cargo.toShortString());</span>
                }
            }
<span class="pc bpc" id="L754" title="1 of 2 branches missed.">            if (t instanceof AIUnit) {</span>
<span class="nc" id="L755">                unitsPresent.remove(((AIUnit)t).getUnit());</span>
<span class="pc bpc" id="L756" title="1 of 2 branches missed.">            } else if (t instanceof AIGoods) {</span>
<span class="fc" id="L757">                Goods goods = ((AIGoods)t).getGoods();</span>
<span class="pc bpc" id="L758" title="1 of 2 branches missed.">                if (goods != null) {</span>
<span class="fc" id="L759">                    Iterator&lt;Goods&gt; gi = goodsPresent.iterator();</span>
<span class="pc bpc" id="L760" title="1 of 2 branches missed.">                    while (gi.hasNext()) {</span>
<span class="nc" id="L761">                        Goods g = gi.next();</span>
<span class="nc bnc" id="L762" title="All 2 branches missed.">                        if (g.getType() == goods.getType()) {</span>
<span class="nc" id="L763">                            gi.remove();</span>
<span class="nc" id="L764">                            break;</span>
                        }
                    }
                }
            }
        }

        // Find anything that was not on the cargoes list
<span class="pc bpc" id="L772" title="1 of 2 branches missed.">        if (!unitsPresent.isEmpty()) {</span>
<span class="nc" id="L773">            lb.add(&quot;, found unexpected units&quot;);</span>
<span class="nc bnc" id="L774" title="All 2 branches missed.">            for (Unit u : unitsPresent) {</span>
<span class="nc" id="L775">                AIUnit aiu = getAIMain().getAIUnit(u);</span>
<span class="nc bnc" id="L776" title="All 2 branches missed.">                if (aiu == null) throw new IllegalStateException(&quot;Bogus:&quot; + u);</span>
<span class="nc" id="L777">                todo.add(aiu);</span>
            }
        }
<span class="pc bpc" id="L780" title="1 of 2 branches missed.">        if (!goodsPresent.isEmpty()) {</span>
<span class="nc" id="L781">            lb.add(&quot;, found unexpected goods&quot;);</span>
<span class="nc bnc" id="L782" title="All 2 branches missed.">            for (Goods g : goodsPresent) {</span>
<span class="nc" id="L783">                AIGoods aig = new AIGoods(getAIMain(), carrier, g.getType(),</span>
<span class="nc" id="L784">                                          g.getAmount(), null);</span>
<span class="nc" id="L785">                todo.add(aig);</span>
            }
        }

        // Try to queue the surprise transportables.
<span class="pc bpc" id="L790" title="1 of 2 branches missed.">        while (!todo.isEmpty()) {</span>
<span class="nc" id="L791">            TransportableAIObject t = todo.remove(0);</span>
<span class="nc bnc" id="L792" title="All 2 branches missed.">            if (!queueTransportable(t, false, lb)) drop.add(t);</span>
        }

        // Drop transportables on the drop list, or queue them to be
        // dropped at the next port.
<span class="pc bpc" id="L797" title="1 of 2 branches missed.">        if (!drop.isEmpty()) {</span>
<span class="nc" id="L798">            path = carrier.getTrivialPath();</span>
<span class="nc bnc" id="L799" title="All 2 branches missed.">            Location end = (path == null) ? null</span>
<span class="nc" id="L800">                : path.getLastNode().getLocation();</span>
            
<span class="nc bnc" id="L802" title="All 2 branches missed.">            while (!drop.isEmpty()) {</span>
<span class="nc" id="L803">                TransportableAIObject t = drop.remove(0);</span>
<span class="nc bnc" id="L804" title="All 2 branches missed.">                if (t.leaveTransport()) {</span>
<span class="nc" id="L805">                    lb.add(&quot; &quot;, t, &quot; left&quot;);</span>
<span class="nc bnc" id="L806" title="All 2 branches missed.">                } else if (end != null) {</span>
                    try {
<span class="nc" id="L808">                        Cargo cargo = Cargo.newCargo(t, carrier, end, false);</span>
<span class="nc" id="L809">                        boolean result = queueCargo(cargo, false, lb);</span>
<span class="nc" id="L810">                        lb.add(&quot; to drop at &quot;, Location.upLoc(end),</span>
<span class="nc" id="L811">                            &quot;=&quot;, result);</span>
<span class="nc" id="L812">                    } catch (FreeColException fce) {</span>
<span class="nc" id="L813">                        lb.add(&quot; &quot;, t, &quot; drop-fail(&quot;, fce.getMessage(), &quot;)&quot;);</span>
                    }
<span class="nc" id="L815">                } else {</span>
<span class="nc" id="L816">                    lb.add(&quot; &quot;, t, &quot; stuck&quot;);</span>
                }
            }
        }

<span class="fc" id="L821">        lb.add(&quot;]&quot;);</span>
<span class="fc" id="L822">    }</span>

    /**
     * Check a &lt;code&gt;Cargo&lt;/code&gt; for continued validity and
     * whether action is needed at the current location.
     *
     * @param cargo The &lt;code&gt;Cargo&lt;/code&gt; to check.
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     * @return TCONTINUE if the &lt;code&gt;Cargo&lt;/code&gt; should continue,
     *     TDONE if it has completed,
     *     TFAIL if it has failed,
     *     TNEXT if it has progressed to the next stage,
     *     TRETRY if a blockage has occurred and it should be retried,
     */
    private CargoResult tryCargo(Cargo cargo, LogBuilder lb) {
<span class="nc" id="L837">        final Unit carrier = getUnit();</span>
<span class="nc" id="L838">        final Location here = carrier.getLocation();</span>
<span class="nc" id="L839">        final TransportableAIObject t = cargo.getTransportable();</span>
<span class="nc" id="L840">        final Locatable l = t.getTransportLocatable();</span>
<span class="nc bnc" id="L841" title="All 2 branches missed.">        if (l == null) {</span>
<span class="nc" id="L842">            logger.warning(&quot;Null-locatable: &quot; + cargo);</span>
<span class="nc" id="L843">            return CargoResult.TDONE;</span>
        }
<span class="nc bnc" id="L845" title="All 2 branches missed.">        if (!Map.isSameLocation(here, cargo.getCarrierTarget())) {</span>
<span class="nc" id="L846">            lb.add(&quot;, &quot;, t, &quot; unready&quot;);</span>
<span class="nc" id="L847">            return CargoResult.TCONTINUE;</span>
        }
<span class="nc" id="L849">        Direction d = null;</span>
<span class="nc" id="L850">        Location tloc = here;</span>

<span class="nc bnc" id="L852" title="All 6 branches missed.">        switch (cargo.getMode()) {</span>
        case PICKUP:
<span class="nc bnc" id="L854" title="All 2 branches missed.">            if (!t.canMove()) {</span>
<span class="nc" id="L855">                lb.add(&quot;, &quot;, t, &quot; out of moves&quot;);</span>
<span class="nc" id="L856">                return CargoResult.TCONTINUE;</span>
            }
<span class="nc bnc" id="L858" title="All 2 branches missed.">            if ((d = cargo.getJoinDirection()) == null) {</span>
<span class="nc" id="L859">                logger.warning(&quot;Null pickup direction&quot;</span>
<span class="nc" id="L860">                    + &quot; for &quot; + cargo.toShortString()</span>
<span class="nc" id="L861">                    + &quot; at &quot; + t.getLocation().toString()</span>
<span class="nc" id="L862">                    + &quot; to &quot; + carrier);</span>
<span class="nc" id="L863">                return CargoResult.TFAIL;</span>
            }                    
<span class="nc" id="L865">            tloc = tloc.getTile().getNeighbourOrNull(d.getReverseDirection());</span>
            // Fall through
        case LOAD:
<span class="nc bnc" id="L868" title="All 2 branches missed.">            if (!Map.isSameLocation(tloc, t.getLocation())) {</span>
<span class="nc" id="L869">                lb.add(&quot;, &quot;, t, &quot; at &quot;, t.getLocation(), &quot; not &quot;, tloc,</span>
<span class="nc" id="L870">                    &quot; # &quot;, cargo.toShortString());</span>
<span class="nc" id="L871">                return CargoResult.TCONTINUE;</span>
            }
<span class="nc bnc" id="L873" title="All 4 branches missed.">            switch (carrier.getNoAddReason(l)) {</span>
            case NONE:
<span class="nc bnc" id="L875" title="All 2 branches missed.">                if (!t.joinTransport(carrier, d)) {</span>
<span class="nc" id="L876">                    lb.add(&quot;, &quot;, t, &quot; NO-JOIN&quot;);</span>
<span class="nc" id="L877">                    return CargoResult.TFAIL;</span>
                }
                break;
            case ALREADY_PRESENT:
<span class="nc" id="L881">                break;</span>
            case CAPACITY_EXCEEDED:
<span class="nc" id="L883">                lb.add(&quot;, &quot;, t, &quot; NO-ROOM on &quot;, carrier);</span>
<span class="nc" id="L884">                return CargoResult.TFAIL;</span>
            default:
<span class="nc" id="L886">                lb.add(&quot;, &quot;, t, &quot; retry-&quot;, carrier.getNoAddReason(l));</span>
<span class="nc" id="L887">                return CargoResult.TRETRY;</span>
            }
            
<span class="nc" id="L890">            String reason = cargo.update();</span>
<span class="nc bnc" id="L891" title="All 2 branches missed.">            if (reason != null) {</span>
<span class="nc" id="L892">                lb.add(&quot;, &quot;, t, &quot; NO-UPDATE(&quot;, reason, &quot;)&quot;);</span>
<span class="nc" id="L893">                return CargoResult.TFAIL;</span>
            }
<span class="nc" id="L895">            lb.add(&quot;, &quot;, t, &quot; collected&quot;);</span>
<span class="nc" id="L896">            return CargoResult.TNEXT;</span>

        case DROPOFF:
<span class="nc bnc" id="L899" title="All 2 branches missed.">            if (!t.canMove()) {</span>
<span class="nc" id="L900">                lb.add(&quot;, &quot;, t, &quot; about to leave&quot;);</span>
<span class="nc" id="L901">                return CargoResult.TCONTINUE;</span>
            }
<span class="nc bnc" id="L903" title="All 2 branches missed.">            if ((d = cargo.getLeaveDirection()) == null) {</span>
<span class="nc" id="L904">                Unit.MoveType mt = ((AIUnit)t).getUnit()</span>
<span class="nc" id="L905">                    .getSimpleMoveType(t.getLocation().getTile(),</span>
<span class="nc" id="L906">                                       cargo.getTransportTarget().getTile());</span>
<span class="nc bnc" id="L907" title="All 2 branches missed.">                switch (mt) {</span>
                case ATTACK_UNIT: case MOVE_NO_ATTACK_CIVILIAN:
<span class="nc" id="L909">                    return CargoResult.TRETRY;</span>
                default:
<span class="nc" id="L911">                    PathNode path = t.getDeliveryPath(carrier,</span>
<span class="nc" id="L912">                        cargo.getTransportTarget());</span>
<span class="nc" id="L913">                    logger.warning(&quot;Null direction&quot;</span>
<span class="nc" id="L914">                        + &quot; for &quot; + cargo.toShortString()</span>
<span class="nc" id="L915">                        + &quot; at &quot; + t.getLocation().toShortString()</span>
<span class="nc" id="L916">                        + &quot;/&quot; + carrier.getLocation().toShortString()</span>
<span class="nc" id="L917">                        + &quot; to &quot; + cargo.getTransportTarget()</span>
<span class="nc" id="L918">                        + &quot; mov=&quot; + mt</span>
<span class="nc bnc" id="L919" title="All 2 branches missed.">                        + &quot; path=&quot; + ((path == null) ? &quot;null&quot;</span>
<span class="nc" id="L920">                            : path.fullPathToString()));</span>
<span class="nc" id="L921">                    return CargoResult.TFAIL;</span>
                }
            }
            // Fall through
        case UNLOAD:
<span class="nc bnc" id="L926" title="All 4 branches missed.">            if (isCarrying(t) &amp;&amp; !t.leaveTransport(d)) {</span>
                //lb.add(&quot;, &quot;, t, &quot; NO-LEAVE&quot;);
<span class="nc" id="L928">                PathNode pn = t.getDeliveryPath(carrier, t.getTransportDestination());</span>
<span class="nc bnc" id="L929" title="All 2 branches missed.">                lb.add(&quot;, &quot;, t, &quot; NO-LEAVE(&quot;, here, &quot;~&quot;, cargo.getLeaveDirection(), &quot;~&quot;, t.getTransportDestination(), &quot; &quot;, ((pn == null) ? &quot;no-path&quot; : pn.fullPathToString()));</span>
<span class="nc" id="L930">                return CargoResult.TRETRY;</span>
            }
<span class="nc" id="L932">            lb.add(&quot;, &quot;, t, &quot; COMPLETED&quot;);</span>
<span class="nc" id="L933">            break;</span>

        case DUMP:
<span class="nc bnc" id="L936" title="All 2 branches missed.">            if (!t.leaveTransport()) {</span>
<span class="nc" id="L937">                lb.add(&quot;, &quot;, t, &quot; STUCK&quot;);</span>
<span class="nc" id="L938">                return CargoResult.TCONTINUE;</span>
            }
<span class="nc" id="L940">            lb.add(&quot;, &quot;, t, &quot; DUMPED at &quot;, t.getLocation());</span>
            break;
        }

        // Check for goods completing a wish
        Colony colony;
        AIColony aiColony;
<span class="nc bnc" id="L947" title="All 4 branches missed.">        if ((colony = (t.getLocation() == null) ? null</span>
<span class="nc" id="L948">                : t.getLocation().getColony()) != null</span>
<span class="nc bnc" id="L949" title="All 2 branches missed.">            &amp;&amp; (aiColony = getAIMain().getAIColony(colony)) != null</span>
<span class="nc bnc" id="L950" title="All 2 branches missed.">            &amp;&amp; aiColony.completeWish(t, lb)) {</span>
<span class="nc" id="L951">            aiColony.requestRearrange();</span>
        }
<span class="nc" id="L953">        return CargoResult.TDONE;</span>
    }

    /**
     * Perform the transport load/unload operations on arrival at the
     * target for the top cargo.
     *
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     */
    private void doTransport(LogBuilder lb) {
<span class="nc" id="L963">        final Unit unit = getUnit();</span>
<span class="nc bnc" id="L964" title="All 2 branches missed.">        if (tSize() &gt; 0) {</span>
            // Arrived at a target.  Deliver what can be delivered.
            // Check other deliveries, we might be in port so this is
            // a good time to decide to fail to deliver something.
<span class="nc" id="L968">            lbAt(lb);</span>
<span class="nc" id="L969">            lb.add(&quot;, delivering&quot;);</span>
<span class="nc" id="L970">            List&lt;Cargo&gt; cont = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L971">            List&lt;Cargo&gt; next = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L972">            List&lt;Cargo&gt; curr = tClear();</span>
<span class="nc bnc" id="L973" title="All 2 branches missed.">            for (Cargo cargo : curr) {</span>
<span class="nc bnc" id="L974" title="All 2 branches missed.">                CargoResult result = (cargo.getMode().isCollection())</span>
<span class="nc" id="L975">                    ? CargoResult.TCONTINUE</span>
<span class="nc" id="L976">                    : tryCargo(cargo, lb);</span>
<span class="nc bnc" id="L977" title="All 5 branches missed.">                switch (result) {</span>
                case TCONTINUE:
<span class="nc" id="L979">                    cont.add(cargo);</span>
<span class="nc" id="L980">                    break;</span>
                case TRETRY: // will check again below
<span class="nc bnc" id="L982" title="All 2 branches missed.">                    if (cargo.retry()) {</span>
<span class="nc" id="L983">                        cont.add(cargo);</span>
<span class="nc" id="L984">                        break;</span>
                    }
                    // Fall through
                case TFAIL:
<span class="nc bnc" id="L988" title="All 2 branches missed.">                    if (cargo.isCarried()) {</span>
<span class="nc" id="L989">                        cargo.dump();</span>
<span class="nc" id="L990">                        break;</span>
                    }
                    // Fall through
                case TDONE:
<span class="nc" id="L994">                    dropTransportable(cargo.getTransportable());</span>
<span class="nc" id="L995">                    cargo.clear();</span>
<span class="nc" id="L996">                    break;</span>
                case TNEXT: default:
<span class="nc" id="L998">                    throw new IllegalStateException(&quot;Can not happen&quot;);</span>
                }
            }
<span class="nc" id="L1001">            curr.clear();</span>
            // Rebuild the cargo list with the original members,
            // less the transportables that were dropped.
<span class="nc" id="L1004">            tSet(cont, true);</span>

            // Now try again, this time collecting as well as
            // delivering.
<span class="nc" id="L1008">            lb.add(&quot;, collecting&quot;);</span>
<span class="nc" id="L1009">            cont.clear();</span>
<span class="nc bnc" id="L1010" title="All 2 branches missed.">            for (Cargo cargo : tClear()) {</span>
<span class="nc bnc" id="L1011" title="All 2 branches missed.">                CargoResult result = (cargo.getMode().isCollection())</span>
<span class="nc" id="L1012">                    ? tryCargo(cargo, lb)</span>
<span class="nc" id="L1013">                    : CargoResult.TCONTINUE;</span>
<span class="nc bnc" id="L1014" title="All 5 branches missed.">                switch (result) {</span>
                case TCONTINUE:
<span class="nc" id="L1016">                    cont.add(cargo);</span>
<span class="nc" id="L1017">                    break;</span>
                case TNEXT:
<span class="nc" id="L1019">                    cont.add(cargo);</span>
<span class="nc" id="L1020">                    break;</span>
                case TRETRY:
<span class="nc bnc" id="L1022" title="All 2 branches missed.">                    if (cargo.retry()) { // Can not reach the target.</span>
<span class="nc" id="L1023">                        next.add(cargo); // Try again next turn.</span>
<span class="nc" id="L1024">                        break;</span>
                    }
                    // Fall through
                case TFAIL: case TDONE:
<span class="nc" id="L1028">                    dropTransportable(cargo.getTransportable());</span>
<span class="nc" id="L1029">                    cargo.clear();</span>
<span class="nc" id="L1030">                    break;</span>
                default:
<span class="nc" id="L1032">                    throw new IllegalStateException(&quot;Can not happen&quot;);</span>
                }
            }

            // Rebuild the cargo list with the original members,
            // less the transportables that were dropped.
<span class="nc" id="L1038">            tSet(cont, true);</span>

            // Add the new and blocked cargoes incrementally with
            // the current arrangement, which is likely to put them
            // at the end.
<span class="nc bnc" id="L1043" title="All 2 branches missed.">            if (!next.isEmpty()) {</span>
<span class="nc" id="L1044">                lb.add(&quot;, requeue&quot;);</span>
<span class="nc bnc" id="L1045" title="All 2 branches missed.">                for (Cargo c : next) queueCargo(c, false, lb);</span>
            }

            // Delivering might have invalidated other cargo missions.
            // It may be rare, but there have been cases where a scout
            // has disembarked onto an LCR, invalidating the mission
            // of a scout further down the transport list.  Run check
            // cargoes again to handle this.  Then optimize.
<span class="nc" id="L1053">            checkCargoes(lb);</span>
<span class="nc" id="L1054">            optimizeCargoes(lb);</span>
        }

        // Replenish cargoes up to available destination capacity
        // and 50% above maximum cargoes (FIXME: longer?)
<span class="nc" id="L1059">        final EuropeanAIPlayer euaip = getEuropeanAIPlayer();</span>
<span class="nc bnc" id="L1060" title="All 4 branches missed.">        while (destinationCapacity() &gt; 0</span>
<span class="nc" id="L1061">            &amp;&amp; tSize() &lt; unit.getCargoCapacity() * 3 / 2) {</span>
<span class="nc" id="L1062">            Cargo cargo = getBestCargo(unit);</span>
<span class="nc bnc" id="L1063" title="All 2 branches missed.">            if (cargo == null) break;</span>
<span class="nc bnc" id="L1064" title="All 2 branches missed.">            if (!queueCargo(cargo, false, lb)) break;</span>
<span class="nc" id="L1065">            euaip.claimTransportable(cargo.getTransportable());</span>
        }
<span class="nc" id="L1067">    }</span>

    /**
     * Calculates a score for a proposed list of
     * &lt;code&gt;Cargo&lt;/code&gt;s using the current unit.  Disallows
     * routes that would overfill the carrier.
     *
     * Useful for comparing proposed cargo delivery routes.  The
     * score is based primarily on the number of turns it takes, but
     * to break ties we also consider the hold*turn product to reduce
     * the risk of losses due to enemy action.
     *
     * @param initialLocation The initial &lt;code&gt;Location&lt;/code&gt;.
     * @param order An ordering of &lt;code&gt;Cargo&lt;/code&gt;s.
     * @return A score for the cargo ordering.
     */
    private float scoreCargoOrder(Location initialLocation, List&lt;Cargo&gt; order) {
<span class="nc" id="L1084">        final Unit carrier = getUnit();</span>
<span class="nc" id="L1085">        final int maxHolds = carrier.getCargoCapacity();</span>
<span class="nc" id="L1086">        int holds = carrier.getCargoSpaceTaken();</span>
<span class="nc" id="L1087">        Location now = initialLocation;</span>
<span class="nc" id="L1088">        float totalHoldTurns = 0.0f;</span>
<span class="nc" id="L1089">        float totalTurns = 0.0f;</span>
<span class="nc" id="L1090">        float favourEarly = 1.0f;</span>

<span class="nc bnc" id="L1092" title="All 2 branches missed.">        for (Cargo cargo : order) {</span>
<span class="nc" id="L1093">            int turns = carrier.getTurnsToReach(now, cargo.getCarrierTarget());</span>
<span class="nc" id="L1094">            totalTurns += turns; // Might be MANY_TURNS!</span>
<span class="nc" id="L1095">            totalHoldTurns += holds * turns * favourEarly;</span>
<span class="nc" id="L1096">            holds += cargo.getNewSpace();</span>
<span class="nc bnc" id="L1097" title="All 4 branches missed.">            if (holds &lt; 0 || holds &gt; maxHolds) return -1.0f;</span>
<span class="nc" id="L1098">            now = cargo.getCarrierTarget();</span>
<span class="nc" id="L1099">            favourEarly += 0.1f; // Slight preference for large loads first</span>
        }
<span class="nc" id="L1101">        return totalTurns + 0.001f * totalHoldTurns;</span>
    }

    /**
     * Sets the current target.
     * Tries all permutations of cargoes and picks the fastest/safest one.
     *
     * Leaves the cargoes in the order they are expected to
     * execute, with valid spaceLeft values.
     *
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     */
    private void optimizeCargoes(LogBuilder lb) {
<span class="nc" id="L1114">        lb.add(&quot;, optimize&quot;);</span>
<span class="nc" id="L1115">        Location oldTarget = getTarget();</span>

        // We wrap/unwrap the list to minimize the number of nodes
        // that need consideration.
<span class="nc" id="L1119">        List&lt;Cargo&gt; ts = wrapCargoes();</span>
<span class="nc" id="L1120">        List&lt;Cargo&gt; best = null;</span>
<span class="nc bnc" id="L1121" title="All 4 branches missed.">        if (1 &lt; ts.size() &amp;&amp; ts.size() &lt;= DESTINATION_UPPER_BOUND) {</span>
            // Try all the permutations of visiting order for the
            // locations, and set the target to the first location
            // of the best scoring route.
            //
            // The target may get recomputed every time a cargo change
            // occurs, so there is no guarantee that the route chosen
            // here is actually executed.  This seems rather
            // inefficient, but we need to be adaptable.
            //
<span class="nc" id="L1131">            final Location current = getUnit().getLocation();</span>
<span class="nc" id="L1132">            float bestValue = INFINITY;</span>
<span class="nc bnc" id="L1133" title="All 2 branches missed.">            for (List&lt;Cargo&gt; tl : getPermutations(ts)) {</span>
<span class="nc" id="L1134">                float value = scoreCargoOrder(current, tl);</span>
<span class="nc bnc" id="L1135" title="All 4 branches missed.">                if (value &gt; 0.0f &amp;&amp; bestValue &gt; value) {</span>
<span class="nc" id="L1136">                    bestValue = value;</span>
<span class="nc" id="L1137">                    best = tl;</span>
                }
            }
        }
<span class="nc bnc" id="L1141" title="All 2 branches missed.">        if (best != null) {</span>
<span class="nc" id="L1142">            tSet(unwrapCargoes(best), true);</span>
<span class="nc bnc" id="L1143" title="All 2 branches missed.">            if (oldTarget != getTarget()) lb.add(&quot;-&gt;&quot;, getTarget());</span>
<span class="nc" id="L1144">        } else {</span>
<span class="nc" id="L1145">            tSet(unwrapCargoes(ts), false);</span>
        }
<span class="nc" id="L1147">    }</span>

    /**
     * What is the best transportable for a carrier to collect?
     *
     * @param carrier The carrier &lt;code&gt;Unit&lt;/code&gt; to consider.
     * @return The best available new &lt;code&gt;Cargo&lt;/code&gt;, or null if
     *     none found.
     */
    private Cargo getBestCargo(Unit carrier) {
<span class="nc" id="L1157">        final EuropeanAIPlayer euaip = getEuropeanAIPlayer();</span>
<span class="nc" id="L1158">        Cargo bestDirect = null, bestFallback = null;</span>
<span class="nc" id="L1159">        float bestDirectValue = 0.0f, bestFallbackValue = 0.0f;</span>
<span class="nc bnc" id="L1160" title="All 2 branches missed.">        for (TransportableAIObject t : euaip.getUrgentTransportables()) {</span>
<span class="nc bnc" id="L1161" title="All 4 branches missed.">            if (t.isDisposed() || !t.carriableBy(carrier)) continue;</span>
<span class="nc" id="L1162">            Location loc = t.getTransportSource();</span>
            Cargo cargo;
            try {
<span class="nc" id="L1165">                cargo = Cargo.newCargo(t, carrier);</span>
<span class="nc" id="L1166">            } catch (FreeColException fce) {</span>
<span class="nc" id="L1167">                cargo = null;</span>
            }
<span class="nc bnc" id="L1169" title="All 2 branches missed.">            if (cargo == null) continue;</span>
<span class="nc" id="L1170">            float value = t.getTransportPriority() / (cargo.getTurns() + 1.0f);</span>
<span class="nc bnc" id="L1171" title="All 2 branches missed.">            if (cargo.isFallback()) {</span>
<span class="nc bnc" id="L1172" title="All 2 branches missed.">                if (bestFallbackValue &lt; value) {</span>
<span class="nc" id="L1173">                    bestFallbackValue = value;</span>
<span class="nc" id="L1174">                    bestFallback = cargo;</span>
                }
<span class="nc" id="L1176">            } else {</span>
<span class="nc bnc" id="L1177" title="All 2 branches missed.">                if (bestDirectValue &lt; value) {</span>
<span class="nc" id="L1178">                    bestDirectValue = value;</span>
<span class="nc" id="L1179">                    bestDirect = cargo;</span>
                }
            }
        }
<span class="nc bnc" id="L1183" title="All 2 branches missed.">        return (bestDirect != null) ? bestDirect</span>
<span class="nc bnc" id="L1184" title="All 2 branches missed.">            : (bestFallback != null) ? bestFallback</span>
<span class="nc" id="L1185">            : null;</span>
    }

    /**
     * Why would an TransportMission be invalid with the given unit?
     *
     * @param aiUnit The &lt;code&gt;AIUnit&lt;/code&gt; to test.
     * @return A reason why the mission would be invalid with the unit,
     *     or null if none found.
     */
    private static String invalidMissionReason(AIUnit aiUnit) {
<span class="fc" id="L1196">        String reason = invalidAIUnitReason(aiUnit);</span>
<span class="fc bfc" id="L1197" title="All 2 branches covered.">        return (reason != null)</span>
<span class="fc" id="L1198">            ? reason</span>
<span class="pc bpc" id="L1199" title="1 of 2 branches missed.">            : (!aiUnit.getUnit().isCarrier())</span>
<span class="nc" id="L1200">            ? &quot;unit-not-a-carrier&quot;</span>
<span class="fc" id="L1201">            : null;</span>
    }

    /**
     * Why would this mission be invalid with a given cargo?
     * Checks the cargo locations.
     * A location becomes invalid if:
     *   - step is a null location
     *   - step is disposed
     *   - step is a captured settlement
     *
     * @param cargo The &lt;code&gt;Cargo&lt;/code&gt; to test.
     * @return A reason why the mission would be invalid,
     *     or null if none found.
     */
    private static String invalidCargoReason(Cargo cargo) {
<span class="fc" id="L1217">        final TransportableAIObject t = cargo.getTransportable();</span>
        String reason;
<span class="pc bpc" id="L1219" title="1 of 2 branches missed.">        return (t == null) ? &quot;null-transportable&quot;</span>
<span class="pc bpc" id="L1220" title="1 of 2 branches missed.">            : ((reason = t.invalidReason()) != null) ? &quot;cargo-&quot; + reason</span>
<span class="fc" id="L1221">            : null;</span>
    }
            
    /**
     * Why would this mission be invalid with the given AI unit and location?
     *
     * @param aiUnit The &lt;code&gt;AIUnit&lt;/code&gt; to check.
     * @param loc The &lt;code&gt;Location&lt;/code&gt; to check.
     * @return A reason for invalidity, or null if none found.
     */
    public static String invalidReason(AIUnit aiUnit, Location loc) {
        String reason;
<span class="fc bfc" id="L1233" title="All 2 branches covered.">        return ((reason = invalidMissionReason(aiUnit)) != null)</span>
<span class="fc" id="L1234">            ? reason</span>
<span class="pc bpc" id="L1235" title="1 of 2 branches missed.">            : (loc instanceof Tile)</span>
<span class="nc" id="L1236">            ? null</span>
<span class="pc bpc" id="L1237" title="1 of 4 branches missed.">            : (loc instanceof Europe || loc instanceof Colony)</span>
<span class="fc" id="L1238">            ? invalidTargetReason(loc, aiUnit.getUnit().getOwner())</span>
<span class="nc" id="L1239">            : Mission.TARGETINVALID;</span>
    }

    /**
     * Why would this mission be invalid with the given AI unit?
     *
     * @param aiUnit The &lt;code&gt;AIUnit&lt;/code&gt; to check.
     * @return A reason for mission invalidity, or null if none found.
     */
    public static String invalidReason(AIUnit aiUnit) {
<span class="fc" id="L1249">        return invalidMissionReason(aiUnit);</span>
    }

    // End of cargoes handling.

    // Publically accessible routines to manipulate a TransportableAIObject.

    /**
     * Removes the given &lt;code&gt;TransportableAIObject&lt;/code&gt; from the
     * cargo list.
     *
     * @param t The &lt;code&gt;TransportableAIObject&lt;/code&gt; to remove.
     * @return True if the removal succeeded.
     */
    public boolean removeTransportable(TransportableAIObject t) {
<span class="nc" id="L1264">        Cargo cargo = tFind(t);</span>
<span class="nc bnc" id="L1265" title="All 2 branches missed.">        return (cargo == null) ? false : tRemove(cargo);</span>
    }

    /**
     * Retargets a transportable that should already be on board the carrier.
     *
     * @param t The &lt;code&gt;TransportableAIObject&lt;/code&gt; to retarget.
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     * @return True if the retargeting succeeded.
     */
    public boolean requeueTransportable(TransportableAIObject t,
                                        LogBuilder lb) {
<span class="nc" id="L1277">        Cargo cargo = tFind(t);</span>
<span class="nc bnc" id="L1278" title="All 2 branches missed.">        return (cargo == null) ? queueTransportable(t, false, lb)</span>
<span class="nc" id="L1279">            : requeueCargo(cargo, lb);</span>
    }

    /**
     * Wrapper for queueCargo.
     * Public for the benefit of EuropeanAIPlayer.allocateTransportables
     * and CashInTreasureTrain.doMission.
     *
     * @param t The &lt;code&gt;TransportableAIObject&lt;/code&gt; to add.
     * @param requireMatch Fail if an existing destination is not matched.
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     * @return True if the transportable was queued.
     */
    public boolean queueTransportable(TransportableAIObject t,
                                      boolean requireMatch, LogBuilder lb) {
<span class="fc" id="L1294">        Cargo cargo = makeCargo(t, lb);</span>
<span class="fc bfc" id="L1295" title="All 2 branches covered.">        return (cargo == null) ? false : queueCargo(cargo, requireMatch, lb);</span>
    }

    /**
     * Dump a transportable.
     *
     * @param t The &lt;code&gt;TransportableAIObject&lt;/code&gt; to dump.
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     * @return True if the transportable is no longer on board, queued, or
     *     was reset to be dumped at the next stop.
     */
    public boolean dumpTransportable(TransportableAIObject t, LogBuilder lb) {
<span class="nc bnc" id="L1307" title="All 2 branches missed.">        if (t == null) return true;</span>
<span class="nc" id="L1308">        Cargo cargo = tFind(t);</span>
<span class="nc bnc" id="L1309" title="All 2 branches missed.">        if (cargo == null) return true;</span>
<span class="nc bnc" id="L1310" title="All 2 branches missed.">        if (!isCarrying(t)) {</span>
<span class="nc" id="L1311">            removeTransportable(t);</span>
<span class="nc" id="L1312">            return true;</span>
        }
<span class="nc" id="L1314">        return dumpCargo(cargo, lb);</span>
    }

    /**
     * Drop all collections so that cargo is delivered only, then
     * collect this unit.  Useful for prioritizing treasure
     * collection.
     *
     * @param aiu The &lt;code&gt;AIUnit&lt;/code&gt; to collect.
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     * @return True if the unit was queued.
     */
    public boolean forceCollection(AIUnit aiu, LogBuilder lb) {
<span class="nc bnc" id="L1327" title="All 2 branches missed.">        for (Cargo c : tCopy()) {</span>
<span class="nc bnc" id="L1328" title="All 2 branches missed.">            if (c.getMode().isCollection()) removeCargo(c);</span>
        }            
<span class="nc" id="L1330">        return queueTransportable(aiu, false, lb);</span>
    }
    
    /**
     * Suppress European trade in a type of goods which is about to be
     * boycotted.
     *
     * @param type The &lt;code&gt;GoodsType&lt;/code&gt; to suppress.
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     */
    public void suppressEuropeanTrade(GoodsType type, LogBuilder lb) {
<span class="nc bnc" id="L1341" title="All 2 branches missed.">        for (Cargo c : tCopy()) {</span>
<span class="nc bnc" id="L1342" title="All 2 branches missed.">            if (c.isEuropeanTrade(type)) removeCargo(c);</span>
        }
<span class="nc" id="L1344">    }</span>


    // End of public TransportableAIObject manipulations

    // Implement Mission
    //   Inherit dispose, getBaseTransportPriority, isOneTime

    /**
     * {@inheritDoc}
     */
    @Override
    public Tile getTransportDestination() {
<span class="nc" id="L1357">        return null; // Can not transport a carrier unit.</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public Location getTarget() {
<span class="fc" id="L1365">        return target;</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public void setTarget(Location target) {
<span class="fc" id="L1373">        this.target = target;</span>
<span class="fc" id="L1374">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public Location findTarget() {
        // A noop.  The target is defined by the cargoes.
<span class="nc" id="L1382">        return null;</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public String invalidReason() {
<span class="fc" id="L1390">        final AIUnit aiUnit = getAIUnit();</span>
<span class="fc" id="L1391">        String reason = invalidReason(aiUnit, getTarget());</span>
        Cargo cargo;
<span class="fc bfc" id="L1393" title="All 2 branches covered.">        return (reason != null) ? reason</span>
<span class="fc bfc" id="L1394" title="All 2 branches covered.">            : ((cargo = tFirst()) == null) ? null</span>
<span class="fc" id="L1395">            : invalidCargoReason(cargo);</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public Mission doMission(LogBuilder lb) {
<span class="fc" id="L1403">        lb.add(tag);</span>
<span class="fc" id="L1404">        checkCargoes(lb);</span>
<span class="fc" id="L1405">        String reason = invalidReason();</span>
<span class="fc bfc" id="L1406" title="All 2 branches covered.">        if (reason != null) return lbFail(lb, false, reason);</span>

<span class="fc" id="L1408">        final AIUnit aiCarrier = getAIUnit();</span>
<span class="fc" id="L1409">        final Unit unit = getUnit();</span>
<span class="fc" id="L1410">        final CostDecider fallBackDecider</span>
<span class="fc" id="L1411">            = CostDeciders.avoidSettlementsAndBlockingUnits();</span>
<span class="fc" id="L1412">        final EuropeanAIPlayer euaip = getEuropeanAIPlayer();</span>
<span class="fc" id="L1413">        CostDecider costDecider = CostDeciders.defaultCostDeciderFor(unit);</span>
        for (;;) {
<span class="fc" id="L1415">            Unit.MoveType mt = travelToTarget(target, costDecider, lb);</span>
<span class="pc bpc" id="L1416" title="6 of 7 branches missed.">            switch (mt) {</span>
            case MOVE: // Arrived at transport target
<span class="nc" id="L1418">                doTransport(lb);</span>
<span class="nc bnc" id="L1419" title="All 4 branches missed.">                if (isEmpty() &amp;&amp; unit.isOffensiveUnit()) {</span>
<span class="nc" id="L1420">                    Mission m = euaip.getPrivateerMission(aiCarrier, null);</span>
<span class="nc bnc" id="L1421" title="All 2 branches missed.">                    if (m != null) return lbDone(lb, false, &quot;going pirate&quot;);</span>
                }                    
<span class="nc bnc" id="L1423" title="All 2 branches missed.">                if ((reason = invalidReason()) != null) {</span>
<span class="nc" id="L1424">                    logger.warning(tag + &quot; post-stop failure(&quot; + reason</span>
<span class="nc" id="L1425">                        + &quot;): &quot; + this.toFullString());</span>
<span class="nc" id="L1426">                    return lbFail(lb, false, reason);</span>
                }
<span class="nc bnc" id="L1428" title="All 2 branches missed.">                if (unit.isAtLocation(target)) {</span>
<span class="nc" id="L1429">                    return lbWait(lb, &quot;, waiting at &quot;, target);</span>
                }
                break;

            case MOVE_HIGH_SEAS: case MOVE_NO_MOVES: case MOVE_ILLEGAL:
<span class="fc" id="L1434">                return lbWait(lb);</span>

            case MOVE_NO_REPAIR:
<span class="nc" id="L1437">                return lbFail(lb, false, AIUNITDIED);</span>

            case MOVE_NO_TILE: // Another unit is blocking a river?
<span class="nc" id="L1440">                moveRandomly(tag, null);</span>
<span class="nc" id="L1441">                return lbDodge(lb);</span>

            case ATTACK_UNIT:
<span class="nc" id="L1444">                Location blocker = resolveBlockage(aiCarrier, target);</span>
<span class="nc bnc" id="L1445" title="All 4 branches missed.">                if (blocker instanceof Unit &amp;&amp; shouldAttack((Unit)blocker)) {</span>
<span class="nc" id="L1446">                    AIMessage.askAttack(aiCarrier,</span>
<span class="nc" id="L1447">                        unit.getTile().getDirection(blocker.getTile()));</span>
<span class="nc" id="L1448">                    return lbAttack(lb, blocker);</span>
                }
                // Fall through
            case MOVE_NO_ATTACK_CIVILIAN:
                // FIXME: See if the transportable can get around the
                // blockage using its own path finding.
<span class="nc bnc" id="L1454" title="All 2 branches missed.">                if (unit.getTile().isAdjacent(target.getTile())</span>
<span class="nc bnc" id="L1455" title="All 2 branches missed.">                    || costDecider == fallBackDecider) {</span>
<span class="nc" id="L1456">                    moveRandomly(tag, null);</span>
<span class="nc" id="L1457">                    return lbDodge(lb);</span>
                }
<span class="nc" id="L1459">                costDecider = fallBackDecider; // Retry</span>
<span class="nc" id="L1460">                lb.add(&quot;, retry blockage at &quot;, unit.getLocation());</span>
<span class="nc" id="L1461">                break;</span>

            case MOVE_NO_ACCESS_EMBARK: default:
<span class="nc" id="L1464">                return lbMove(lb, mt);</span>
            }
        }
    }


    // Serialization

    private static final String TARGET_TAG = &quot;target&quot;;
    // @compat 0.10.5
<span class="fc" id="L1474">    private static final String OLD_TRANSPORTABLE_TAG = &quot;transportable&quot;;</span>
    // end @compat


    /**
     * {@inheritDoc}
     */
    @Override
    protected void writeAttributes(FreeColXMLWriter xw) throws XMLStreamException {
<span class="nc" id="L1483">        super.writeAttributes(xw);</span>

<span class="nc bnc" id="L1485" title="All 2 branches missed.">        if (target != null) {</span>
<span class="nc" id="L1486">            xw.writeLocationAttribute(TARGET_TAG, target);</span>
        }
<span class="nc" id="L1488">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    protected void writeChildren(FreeColXMLWriter xw) throws XMLStreamException {
<span class="nc" id="L1495">        final AIUnit aiCarrier = getAIUnit();</span>
<span class="nc bnc" id="L1496" title="All 2 branches missed.">        for (Cargo cargo : tCopy()) {</span>
            // Sanity check first.  Another nation might have captured
            // or destroyed a target colony.
<span class="nc" id="L1499">            String reason = cargo.check(aiCarrier);</span>
<span class="nc bnc" id="L1500" title="All 2 branches missed.">            if (reason != null) continue;</span>
            // Do not bother writing cargoes that will be dumped.
            // On restore, checkCargoes will work out what to do with them.
<span class="nc bnc" id="L1503" title="All 2 branches missed.">            if (cargo.getMode() == Cargo.CargoMode.DUMP) continue;</span>
<span class="nc" id="L1504">            cargo.toXML(xw);</span>
        }
<span class="nc" id="L1506">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    protected void readAttributes(FreeColXMLReader xr) throws XMLStreamException {
<span class="nc" id="L1513">        super.readAttributes(xr);</span>

<span class="nc" id="L1515">        target = xr.getLocationAttribute(getGame(), TARGET_TAG, false);</span>
<span class="nc" id="L1516">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    protected void readChildren(FreeColXMLReader xr) throws XMLStreamException {
        // Clear containers.
<span class="nc" id="L1524">        tClear();</span>

<span class="nc" id="L1526">        super.readChildren(xr);</span>
<span class="nc" id="L1527">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    protected void readChild(FreeColXMLReader xr) throws XMLStreamException {
<span class="nc" id="L1534">        final String tag = xr.getLocalName();</span>

<span class="nc bnc" id="L1536" title="All 2 branches missed.">        if (Cargo.getTagName().equals(tag)) {</span>
<span class="nc" id="L1537">            tAdd(new Cargo(getAIMain(), xr), -1);</span>

        // @compat 0.10.5
<span class="nc bnc" id="L1540" title="All 2 branches missed.">        } else if (OLD_TRANSPORTABLE_TAG.equals(tag)) {</span>
            // Ignore the old format, let checkCargoes sort it out
<span class="nc" id="L1542">            xr.closeTag(OLD_TRANSPORTABLE_TAG);</span>
        // end @compat

<span class="nc" id="L1545">        } else {</span>
<span class="nc" id="L1546">            super.readChild(xr);</span>
        }
<span class="nc" id="L1548">    }</span>

    /**
     * More verbose version of toString().
     *
     * @return A summary of this mission including its transportables.
     */
    public String toFullString() {
<span class="nc" id="L1556">        LogBuilder lb = new LogBuilder(64);</span>
<span class="nc" id="L1557">        lb.add(this);</span>
<span class="nc bnc" id="L1558" title="All 2 branches missed.">        for (Cargo cargo : tCopy()) lb.add(&quot;\n  -&gt;&quot;, cargo);</span>
<span class="nc" id="L1559">        return lb.toString();</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
<span class="nc" id="L1566">    public String getXMLTagName() { return getTagName(); }</span>

    /**
     * Gets the tag name of the root element representing this object.
     *
     * @return &quot;transportMission&quot;.
     */
    public static String getTagName() {
<span class="nc" id="L1574">        return &quot;transportMission&quot;;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span>src (May 7, 2016 6:04:12 PM)</div></body></html>