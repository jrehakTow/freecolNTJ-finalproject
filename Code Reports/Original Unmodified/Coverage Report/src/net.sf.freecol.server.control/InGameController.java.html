<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>InGameController.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">src (May 7, 2016 6:04:12 PM)</a> &gt; <a href="../../index.html" class="el_group">FreeCol</a> &gt; <a href="../index.html" class="el_bundle">src</a> &gt; <a href="index.source.html" class="el_package">net.sf.freecol.server.control</a> &gt; <span class="el_source">InGameController.java</span></div><h1>InGameController.java</h1><pre class="source lang-java linenums">/**
 *  Copyright (C) 2002-2016   The FreeCol Team
 *
 *  This file is part of FreeCol.
 *
 *  FreeCol is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  FreeCol is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with FreeCol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package net.sf.freecol.server.control;

import java.io.IOException;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map.Entry;
import java.util.Random;
import java.util.Set;
import java.util.logging.Level;
import java.util.logging.Logger;
import java.util.stream.Collectors;

import net.sf.freecol.FreeCol;
import net.sf.freecol.common.debug.FreeColDebugger;
import net.sf.freecol.common.i18n.Messages;
import net.sf.freecol.common.model.Ability;
import net.sf.freecol.common.model.AbstractGoods;
import net.sf.freecol.common.model.AbstractUnit;
import net.sf.freecol.common.model.BuildableType;
import net.sf.freecol.common.model.Colony;
import net.sf.freecol.common.model.ColonyTile;
import net.sf.freecol.common.model.CombatModel.CombatResult;
import net.sf.freecol.common.model.DiplomaticTrade;
import net.sf.freecol.common.model.DiplomaticTrade.TradeStatus;
import net.sf.freecol.common.model.Disaster;
import net.sf.freecol.common.model.Europe;
import net.sf.freecol.common.model.Europe.MigrationType;
import net.sf.freecol.common.model.ExportData;
import net.sf.freecol.common.model.FoundingFather;
import net.sf.freecol.common.model.Force;
import net.sf.freecol.common.model.FreeColGameObject;
import net.sf.freecol.common.model.Game;
import net.sf.freecol.common.model.GameOptions;
import net.sf.freecol.common.model.Goods;
import net.sf.freecol.common.model.GoodsContainer;
import net.sf.freecol.common.model.GoodsLocation;
import net.sf.freecol.common.model.GoodsType;
import net.sf.freecol.common.model.HighScore;
import net.sf.freecol.common.model.HighSeas;
import net.sf.freecol.common.model.HistoryEvent;
import net.sf.freecol.common.model.IndianNationType;
import net.sf.freecol.common.model.IndianSettlement;
import net.sf.freecol.common.model.Location;
import net.sf.freecol.common.model.Map;
import net.sf.freecol.common.model.Market;
import net.sf.freecol.common.model.Market.Access;
import net.sf.freecol.common.model.ModelMessage;
import net.sf.freecol.common.model.ModelMessage.MessageType;
import net.sf.freecol.common.model.Monarch;
import net.sf.freecol.common.model.Monarch.MonarchAction;
import net.sf.freecol.common.model.Nameable;
import net.sf.freecol.common.model.Nation;
import net.sf.freecol.common.model.NationSummary;
import net.sf.freecol.common.model.Ownable;
import net.sf.freecol.common.model.Player;
import net.sf.freecol.common.model.Player.PlayerType;
import net.sf.freecol.common.model.Stance;
import net.sf.freecol.common.model.RandomRange;
import net.sf.freecol.common.model.Region;
import net.sf.freecol.common.model.Settlement;
import net.sf.freecol.common.model.Specification;
import net.sf.freecol.common.model.StringTemplate;
import net.sf.freecol.common.model.Tension;
import net.sf.freecol.common.model.Tile;
import net.sf.freecol.common.model.TileImprovement;
import net.sf.freecol.common.model.TileImprovementType;
import net.sf.freecol.common.model.TradeItem;
import net.sf.freecol.common.model.TradeRoute;
import net.sf.freecol.common.model.TradeRouteStop;
import net.sf.freecol.common.model.Turn;
import net.sf.freecol.common.model.Unit;
import net.sf.freecol.common.model.Role;
import net.sf.freecol.common.model.Unit.UnitState;
import net.sf.freecol.common.model.UnitLocation;
import net.sf.freecol.common.model.UnitType;
import net.sf.freecol.common.model.UnitTypeChange.ChangeType;
import net.sf.freecol.common.model.WorkLocation;
import net.sf.freecol.common.networking.BuyPropositionMessage;
import net.sf.freecol.common.networking.ChatMessage;
import net.sf.freecol.common.networking.Connection;
import net.sf.freecol.common.networking.DOMMessage;
import net.sf.freecol.common.networking.DiplomacyMessage;
import net.sf.freecol.common.networking.ErrorMessage;
import net.sf.freecol.common.networking.GoodsForSaleMessage;
import net.sf.freecol.common.networking.InciteMessage;
import net.sf.freecol.common.networking.IndianDemandMessage;
import net.sf.freecol.common.networking.LootCargoMessage;
import net.sf.freecol.common.networking.MonarchActionMessage;
import net.sf.freecol.common.networking.NationSummaryMessage;
import net.sf.freecol.common.networking.RearrangeColonyMessage;
import net.sf.freecol.common.networking.RearrangeColonyMessage.UnitChange;
import net.sf.freecol.common.networking.ScoutSpeakToChiefMessage;
import net.sf.freecol.common.networking.SellPropositionMessage;
import static net.sf.freecol.common.util.CollectionUtils.*;
import net.sf.freecol.common.util.LogBuilder;
import net.sf.freecol.common.util.RandomChoice;
import static net.sf.freecol.common.util.RandomUtils.*;
import net.sf.freecol.common.util.Utils;

import net.sf.freecol.server.FreeColServer;
import net.sf.freecol.server.ai.AIPlayer;
import net.sf.freecol.server.ai.REFAIPlayer;
import net.sf.freecol.server.control.ChangeSet.ChangePriority;
import net.sf.freecol.server.control.ChangeSet.See;
import net.sf.freecol.server.model.DiplomacySession;
import net.sf.freecol.server.model.LootSession;
import net.sf.freecol.server.model.MonarchSession;
import net.sf.freecol.server.model.ServerColony;
import net.sf.freecol.server.model.ServerEurope;
import net.sf.freecol.server.model.ServerGame;
import net.sf.freecol.server.model.ServerIndianSettlement;
import net.sf.freecol.server.model.ServerPlayer;
import net.sf.freecol.server.model.ServerRegion;
import net.sf.freecol.server.model.ServerUnit;
import net.sf.freecol.server.model.TradeSession;
import net.sf.freecol.server.model.TransactionSession;


/**
 * The main server controller.
 */
public final class InGameController extends Controller {

<span class="fc" id="L148">    private static final Logger logger = Logger.getLogger(InGameController.class.getName());</span>

    /** The server random number source. */
    private final Random random;

    /** Debug helpers, do not serialize. */
<span class="fc" id="L154">    private int debugOnlyAITurns = 0;</span>
<span class="fc" id="L155">    private MonarchAction debugMonarchAction = null;</span>
<span class="fc" id="L156">    private ServerPlayer debugMonarchPlayer = null;</span>


    /**
     * The constructor to use.
     *
     * @param freeColServer The main server object.
     * @param random The pseudo-random number source to use.
     */
    public InGameController(FreeColServer freeColServer, Random random) {
<span class="fc" id="L166">        super(freeColServer);</span>

<span class="fc" id="L168">        this.random = random;</span>
<span class="fc" id="L169">    }</span>


    /**
     * Asks a question of a player with a timeout.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; to ask.
     * @param request The &lt;code&gt;DOMMessage&lt;/code&gt; question.
     * @return The response to the question, or null if none.
     */
    private DOMMessage askTimeout(ServerPlayer serverPlayer,
                                  DOMMessage request) {
<span class="nc" id="L181">        final boolean single = getFreeColServer().getSinglePlayer();</span>
<span class="nc" id="L182">        return getGame().askTimeout(serverPlayer, FreeCol.getTimeout(single),</span>
<span class="nc" id="L183">                                    request);</span>
    }


    // Debug support

    /**
     * Gets the number of AI turns to skip through.
     *
     * @return The number of terms to skip.
     */
    public int getSkippedTurns() {
<span class="nc bnc" id="L195" title="All 2 branches missed.">        return (FreeColDebugger.isInDebugMode(FreeColDebugger.DebugMode.MENUS))</span>
<span class="nc" id="L196">            ? debugOnlyAITurns : -1;</span>
    }

    /**
     * Sets the number of AI turns to skip through as a debug helper.
     *
     * @param turns The number of turns to skip through.
     */
    public void setSkippedTurns(int turns) {
<span class="nc bnc" id="L205" title="All 2 branches missed.">        if (FreeColDebugger.isInDebugMode(FreeColDebugger.DebugMode.MENUS)) {</span>
<span class="nc" id="L206">            debugOnlyAITurns = turns;</span>
        }
<span class="nc" id="L208">    }</span>

    /**
     * Sets a monarch action to debug/test.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; whose monarch
     *     should act.
     * @param action The &lt;code&gt;MonarchAction&lt;/code&gt; to be taken.
     */
    public void setMonarchAction(ServerPlayer serverPlayer,
                                 MonarchAction action) {
<span class="nc bnc" id="L219" title="All 2 branches missed.">        if (FreeColDebugger.isInDebugMode(FreeColDebugger.DebugMode.MENUS)) {</span>
<span class="nc" id="L220">            debugMonarchPlayer = serverPlayer;</span>
<span class="nc" id="L221">            debugMonarchAction = action;</span>
        }
<span class="nc" id="L223">    }</span>

    /**
     * Debug convenience to step the random number generator.
     *
     * @return The next random number in series, in the range 0-99.
     */
    public int stepRandom() {
<span class="nc" id="L231">        return randomInt(logger, &quot;step random&quot;, random, 100);</span>
    }

    /**
     * Public version of csAddFoundingFather so it can be used in the
     * test code and DebugMenu.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; who gains a father.
     * @param father The &lt;code&gt;FoundingFather&lt;/code&gt; to add.
     */
    public void addFoundingFather(ServerPlayer serverPlayer,
                                  FoundingFather father) {
<span class="fc" id="L243">        ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L244">        serverPlayer.csAddFoundingFather(father, random, cs);</span>
<span class="fc" id="L245">        cs.addAttribute(See.only(serverPlayer), &quot;flush&quot;,</span>
<span class="fc" id="L246">                        Boolean.TRUE.toString());</span>
<span class="fc" id="L247">        getGame().sendTo(serverPlayer, cs);</span>
<span class="fc" id="L248">    }</span>

    /**
     * Public change stance and inform all routine.  Mostly used in the
     * test suite, but the AIs also call it.
     *
     * @param serverPlayer The originating &lt;code&gt;ServerPlayer&lt;/code&gt;.
     * @param stance The new &lt;code&gt;Stance&lt;/code&gt;.
     * @param other The &lt;code&gt;ServerPlayer&lt;/code&gt; wrt which the
     *     stance changes.
     * @param symmetric If true, change the otherPlayer stance as well.
     */
    public void changeStance(ServerPlayer serverPlayer, Stance stance,
                             ServerPlayer other, boolean symmetric) {
<span class="fc" id="L262">        ChangeSet cs = new ChangeSet();</span>
<span class="pc bpc" id="L263" title="1 of 2 branches missed.">        if (serverPlayer.csChangeStance(stance, other, symmetric, cs)) {</span>
<span class="fc" id="L264">            getGame().sendToAll(cs);</span>
        }
<span class="fc" id="L266">    }</span>

    /**
     * Change colony owner.  Public for DebugUtils.
     *
     * @param colony The &lt;code&gt;ServerColony&lt;/code&gt; to change.
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; to change to.
     */
    public void debugChangeOwner(ServerColony colony,
                                 ServerPlayer serverPlayer) {
<span class="fc" id="L276">        ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L277">        ServerPlayer owner = (ServerPlayer)colony.getOwner();</span>
<span class="fc" id="L278">        colony.csChangeOwner(serverPlayer, cs);//-vis(serverPlayer,owner)</span>
<span class="fc" id="L279">        cs.add(See.perhaps().always(owner), colony.getOwnedTiles());</span>
<span class="fc" id="L280">        serverPlayer.invalidateCanSeeTiles();//+vis(serverPlayer)</span>
<span class="fc" id="L281">        owner.invalidateCanSeeTiles();//+vis(owner)</span>
<span class="fc" id="L282">        getGame().sendToAll(cs);</span>
<span class="fc" id="L283">    }</span>

    /**
     * Change unit owner.  Public for DebugUtils.
     *
     * @param unit The &lt;code&gt;ServerUnit&lt;/code&gt; to change.
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; to change to.
     */
    public void debugChangeOwner(ServerUnit unit, ServerPlayer serverPlayer) {
<span class="nc" id="L292">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L293">        ServerPlayer owner = (ServerPlayer)unit.getOwner();</span>
<span class="nc" id="L294">        owner.csChangeOwner(unit, serverPlayer, null, null,</span>
<span class="nc" id="L295">                            cs);//-vis(serverPlayer,owner)</span>
<span class="nc" id="L296">        cs.add(See.perhaps().always(owner), unit.getTile());</span>
<span class="nc" id="L297">        serverPlayer.invalidateCanSeeTiles();//+vis(serverPlayer)</span>
<span class="nc" id="L298">        owner.invalidateCanSeeTiles();//+vis(owner)</span>
<span class="nc" id="L299">        getGame().sendToAll(cs);</span>
<span class="nc" id="L300">    }</span>

    /**
     * Apply a disaster to a colony.  Public for DebugUtils.
     *
     * @param colony The &lt;code&gt;Colony&lt;/code&gt; to apply the disaster to.
     * @param disaster The &lt;code&gt;Disaster&lt;/code&gt; to apply.
     * @return The number of messages generated.
     */
    public int debugApplyDisaster(ServerColony colony, Disaster disaster) {
<span class="nc" id="L310">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L311">        ServerPlayer owner = (ServerPlayer)colony.getOwner();</span>
<span class="nc" id="L312">        List&lt;ModelMessage&gt; messages</span>
<span class="nc" id="L313">            = owner.csApplyDisaster(random, colony, disaster, cs);</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">        if (!messages.isEmpty()) {</span>
<span class="nc" id="L315">            cs.addMessage(See.all(),</span>
<span class="nc" id="L316">                new ModelMessage(MessageType.DEFAULT,</span>
<span class="nc" id="L317">                                 &quot;model.disaster.strikes&quot;, owner)</span>
<span class="nc" id="L318">                    .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="nc" id="L319">                    .addName(&quot;%disaster%&quot;, disaster));</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">            for (ModelMessage message : messages) {</span>
<span class="nc" id="L321">                cs.addMessage(See.all(), message);</span>
            }
<span class="nc" id="L323">            getGame().sendToAll(cs);</span>
        }
<span class="nc" id="L325">        return messages.size();</span>
    }


    // Internal utilities

    /**
     * Create the Royal Expeditionary Force player corresponding to
     * a given player that is about to rebel.
     *
     * Public for the test suite.
     *
     * FIXME: this should eventually generate changes for the REF player.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; about to rebel.
     * @return The REF player.
     */
    public ServerPlayer createREFPlayer(ServerPlayer serverPlayer) {
<span class="fc" id="L343">        Nation refNation = serverPlayer.getNation().getREFNation();</span>
<span class="fc" id="L344">        Monarch monarch = serverPlayer.getMonarch();</span>
<span class="fc" id="L345">        ServerPlayer refPlayer = getFreeColServer().makeAIPlayer(refNation);</span>
<span class="fc" id="L346">        Europe europe = refPlayer.getEurope();</span>
        // Inherit rebel player knowledge of the seas, coasts, claimed
        // land but not full detailed scouting knowledge.
<span class="fc" id="L349">        Set&lt;Tile&gt; explore = new HashSet&lt;&gt;();</span>
<span class="fc bfc" id="L350" title="All 2 branches covered.">        for (Tile t : getGame().getMap().getAllTiles()) {</span>
<span class="pc bpc" id="L351" title="1 of 2 branches missed.">            if (!t.isExploredBy(serverPlayer)) continue;</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">            if (!t.isLand()</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">                || t.isCoastland()</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">                || t.getOwner() == serverPlayer) {</span>
<span class="nc" id="L355">                explore.add(t);</span>
            }
        }
<span class="fc" id="L358">        refPlayer.exploreTiles(explore);</span>

        // Trigger initial placement routine
<span class="fc" id="L361">        refPlayer.setEntryLocation(null);</span>
        // Will change, setup only
<span class="fc" id="L363">        Player.makeContact(serverPlayer, refPlayer);</span>

        // Instantiate the REF in Europe
<span class="fc" id="L366">        Force exf = monarch.getExpeditionaryForce();</span>
        // @compat 0.10.5
        // There was a bug that seriously under provisioned the navy back
        // around 0.10.5, the game in BR#2435 has it.  For now, just add
        // enough ships to carry all the units.
<span class="fc" id="L371">        UnitType ut = monarch.getNavalREFUnitType();</span>
<span class="fc bfc" id="L372" title="All 2 branches covered.">        while (exf.getSpaceRequired() &gt; exf.getCapacity()) {</span>
<span class="fc" id="L373">            AbstractUnit au</span>
<span class="fc" id="L374">                = new AbstractUnit(ut, Specification.DEFAULT_ROLE_ID, 1);</span>
<span class="fc" id="L375">            exf.add(au);</span>
        }
        // end @compat 0.10.5
<span class="fc" id="L378">        List&lt;Unit&gt; landUnits = refPlayer.createUnits(exf.getLandUnits(),</span>
<span class="fc" id="L379">                                                     europe);//-vis: safe!map</span>
<span class="fc" id="L380">        List&lt;Unit&gt; navalUnits = refPlayer.createUnits(exf.getNavalUnits(),</span>
<span class="fc" id="L381">                                                      europe);//-vis: safe!map</span>
<span class="fc" id="L382">        refPlayer.loadShips(landUnits, navalUnits, random);//-vis: safe!map</span>
<span class="fc" id="L383">        return refPlayer;</span>
    }

    /**
     * Move goods from one location to another.
     *
     * @param src The source &lt;code&gt;GoodsLocation&lt;/code&gt;.
     * @param goodsType The &lt;code&gt;GoodsType&lt;/code&gt; to move.
     * @param amount The amount of goods to move.
     * @param dst The new &lt;code&gt;GoodsLocation&lt;/code&gt;.
     */
    private void moveGoods(GoodsLocation src, GoodsType goodsType, int amount,
                           GoodsLocation dst) {
<span class="fc" id="L396">        src.getGoodsContainer().saveState();</span>
<span class="fc" id="L397">        src.removeGoods(goodsType, amount);</span>
<span class="fc bfc" id="L398" title="All 2 branches covered.">        if (dst != null) {</span>
<span class="fc" id="L399">            dst.getGoodsContainer().saveState();</span>
<span class="fc" id="L400">            dst.addGoods(goodsType, amount);</span>
        }
<span class="fc" id="L402">    }</span>

    /**
     * Visits a native settlement, possibly scouting it full if it is
     * as a result of a scout actually asking to speak to the chief,
     * or for other settlement-contacting events such as missionary
     * actions, demanding tribute, learning skills and trading if the
     * settlementActionsContactChief game option is enabled.  It is
     * still unclear what Col1 did here.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is contacting
     *     the settlement.
     * @param is The &lt;code&gt;IndianSettlement&lt;/code&gt; to contact.
     * @param scout Positive if this contact is due to a scout asking to
     *     speak to the chief, zero if it is another unit, negative if
     *     this is from the greeting dialog generation.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csVisit(ServerPlayer serverPlayer, IndianSettlement is,
                         int scout, ChangeSet cs) {
<span class="fc" id="L422">        final ServerPlayer owner = (ServerPlayer)is.getOwner();</span>
<span class="pc bpc" id="L423" title="1 of 2 branches missed.">        if (serverPlayer.csContact(owner, cs)) {</span>
<span class="fc" id="L424">            serverPlayer.csNativeFirstContact(owner, null, cs);</span>
        }
<span class="fc" id="L426">        is.setVisited(serverPlayer);</span>
<span class="pc bpc" id="L427" title="2 of 4 branches missed.">        if (scout &gt; 0 || (scout == 0 &amp;&amp; getGame().getSpecification()</span>
<span class="pc bpc" id="L428" title="1 of 2 branches missed.">                .getBoolean(GameOptions.SETTLEMENT_ACTIONS_CONTACT_CHIEF))) {</span>
<span class="nc" id="L429">            is.setScouted(serverPlayer);</span>
        }
<span class="fc" id="L431">    }</span>

    /**
     * Launch the REF.
     *
     * @param serverPlayer The REF &lt;code&gt;ServerPlayer&lt;/code&gt;.
     * @param teleport If true, teleport the REF in.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csLaunchREF(ServerPlayer serverPlayer, boolean teleport,
                             ChangeSet cs) {
        // Set the REF player entry location from the rebels.  Note
        // that the REF units will have their own unit-specific entry
        // locations set by their missions.  This just flags that the
        // REF is initialized.
<span class="nc bnc" id="L446" title="All 2 branches missed.">        for (Player p : serverPlayer.getRebels()) {</span>
<span class="nc" id="L447">            serverPlayer.setEntryLocation(p.getEntryLocation().getTile());</span>
            break;
        }

<span class="nc bnc" id="L451" title="All 2 branches missed.">        if (teleport) { // Teleport in the units.</span>
<span class="nc" id="L452">            Set&lt;Tile&gt; seen = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">            for (Unit u : serverPlayer.getUnits()) {</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">                if (!u.isNaval()) continue;</span>
<span class="nc" id="L455">                Tile entry = u.getEntryLocation().getTile();</span>
<span class="nc" id="L456">                u.setLocation(entry);//-vis(serverPlayer)</span>
<span class="nc" id="L457">                u.setWorkLeft(-1);</span>
<span class="nc" id="L458">                u.setState(Unit.UnitState.ACTIVE);</span>
<span class="nc bnc" id="L459" title="All 2 branches missed.">                if (!seen.contains(entry)) {</span>
<span class="nc" id="L460">                    seen.add(entry);</span>
<span class="nc" id="L461">                    cs.add(See.only(serverPlayer),</span>
<span class="nc" id="L462">                           serverPlayer.exploreForUnit(u));</span>
<span class="nc" id="L463">                    cs.add(See.perhaps().except(serverPlayer), entry);</span>
                }
            }
<span class="nc" id="L466">            serverPlayer.invalidateCanSeeTiles();//+vis(serverPlayer)</span>
<span class="nc" id="L467">        } else {</span>
            // Put navy on the high seas, with 1-turn sail time
<span class="nc bnc" id="L469" title="All 2 branches missed.">            for (Unit u : serverPlayer.getUnits()) {</span>
<span class="nc bnc" id="L470" title="All 2 branches missed.">                if (!u.isNaval()) continue;</span>
<span class="nc" id="L471">                u.setWorkLeft(1);</span>
<span class="nc" id="L472">                u.setDestination(u.getEntryLocation());</span>
<span class="nc" id="L473">                u.setLocation(u.getOwner().getHighSeas());//-vis: safe!map</span>
            }
        }
<span class="nc" id="L476">    }</span>

    /**
     * Give independence.  Note that the REF player is granting, but
     * most of the changes happen to the newly independent player.
     * hence the special handling.
     *
     * @param serverPlayer The REF &lt;code&gt;ServerPlayer&lt;/code&gt; that is granting.
     * @param independent The newly independent &lt;code&gt;ServerPlayer&lt;/code&gt;.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csGiveIndependence(ServerPlayer serverPlayer,
                                    ServerPlayer independent, ChangeSet cs) {
<span class="nc" id="L489">        serverPlayer.csChangeStance(Stance.PEACE, independent, true, cs);</span>
<span class="nc" id="L490">        independent.changePlayerType(PlayerType.INDEPENDENT);</span>
<span class="nc" id="L491">        Game game = getGame();</span>
<span class="nc" id="L492">        Turn turn = game.getTurn();</span>
<span class="nc" id="L493">        independent.setTax(0);</span>
<span class="nc" id="L494">        independent.reinitialiseMarket();</span>
<span class="nc" id="L495">        HistoryEvent h = new HistoryEvent(turn,</span>
<span class="nc" id="L496">            HistoryEvent.HistoryEventType.INDEPENDENCE, independent);</span>

        // The score for actual independence is actually a percentage
        // bonus depending on how many other nations are independent.
        // If we ever go for a more complex scoring algorithm it might
        // be better to replace the score int with a Modifier, but for
        // now we just set the score value to the number of
        // independent players other than the one we are granting
        // here, and generate the bonus with a special case in
        // ServerPlayer.updateScore().
<span class="nc" id="L506">        int n = count(game.getLiveEuropeanPlayers(independent),</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">                      p -&gt; p.getPlayerType() == PlayerType.INDEPENDENT);</span>
<span class="nc" id="L508">        h.setScore(n);</span>
<span class="nc" id="L509">        cs.addGlobalHistory(game, h);</span>
<span class="nc" id="L510">        cs.addMessage(See.only(independent),</span>
<span class="nc" id="L511">            new ModelMessage(MessageType.FOREIGN_DIPLOMACY,</span>
<span class="nc" id="L512">                             &quot;giveIndependence.announce&quot;, independent)</span>
<span class="nc" id="L513">                .addStringTemplate(&quot;%ref%&quot;, serverPlayer.getNationLabel()));</span>

        // Who surrenders?
<span class="nc" id="L516">        List&lt;Unit&gt; surrenderUnits = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L517" title="All 2 branches missed.">        for (Unit u : serverPlayer.getUnits()) {</span>
<span class="nc bnc" id="L518" title="All 6 branches missed.">            if (u.hasTile() &amp;&amp; !u.isNaval() &amp;&amp; !u.isOnCarrier()</span>
<span class="nc" id="L519">                &amp;&amp; serverPlayer.csChangeOwner(u, independent,</span>
<span class="nc bnc" id="L520" title="All 2 branches missed.">                    ChangeType.CAPTURE, null, cs)) {//-vis(both)</span>
<span class="nc" id="L521">                u.setMovesLeft(0);</span>
<span class="nc" id="L522">                u.setState(Unit.UnitState.ACTIVE);</span>
<span class="nc" id="L523">                cs.add(See.perhaps().always(serverPlayer), u.getTile());</span>
<span class="nc" id="L524">                surrenderUnits.add(u);</span>
            }
        }
<span class="nc bnc" id="L527" title="All 2 branches missed.">        if (!surrenderUnits.isEmpty()) {</span>
<span class="nc" id="L528">            cs.addMessage(See.only(independent),</span>
<span class="nc" id="L529">                new ModelMessage(MessageType.FOREIGN_DIPLOMACY,</span>
<span class="nc" id="L530">                                 &quot;giveIndependence.unitsAcquired&quot;, independent)</span>
<span class="nc" id="L531">                    .addStringTemplate(&quot;%units%&quot;,</span>
<span class="nc" id="L532">                         unitTemplate(&quot;, &quot;, surrenderUnits)));</span>
<span class="nc" id="L533">            independent.invalidateCanSeeTiles();//+vis(independent)</span>
<span class="nc" id="L534">            serverPlayer.invalidateCanSeeTiles();//+vis(serverPlayer)</span>
        }

        // Update player type.  Again, a pity to have to do a whole
        // player update, but a partial update works for other players.
<span class="nc" id="L539">        cs.addPartial(See.all().except(independent), independent, &quot;playerType&quot;);</span>
<span class="nc" id="L540">        cs.addMessage(See.all().except(independent),</span>
<span class="nc" id="L541">            new ModelMessage(MessageType.FOREIGN_DIPLOMACY,</span>
<span class="nc" id="L542">                             &quot;giveIndependence.otherAnnounce&quot;, independent)</span>
<span class="nc" id="L543">                .addStringTemplate(&quot;%nation%&quot;, independent.getNationLabel())</span>
<span class="nc" id="L544">                .addStringTemplate(&quot;%ref%&quot;, serverPlayer.getNationLabel()));</span>
<span class="nc" id="L545">        cs.add(See.only(independent), independent);</span>

        // Reveal the map on independence.
<span class="nc" id="L548">        cs.add(See.only(independent), independent.exploreMap(true));</span>
<span class="nc" id="L549">    }</span>

    private StringTemplate unitTemplate(String base, List&lt;Unit&gt; units) {
<span class="nc" id="L552">        StringTemplate template = StringTemplate.label(base);</span>
<span class="nc bnc" id="L553" title="All 2 branches missed.">        for (Unit u : units) {</span>
<span class="nc" id="L554">            template.addStringTemplate(u.getLabel(Unit.UnitLabelType.PLAIN));</span>
        }
<span class="nc" id="L556">        return template;</span>
    }

    /**
     * Resolves a tax raise.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; whose tax is rising.
     * @param taxRaise The amount of tax raise.
     * @param goods The &lt;code&gt;Goods&lt;/code&gt; for a goods party.
     * @param result Whether the tax was accepted or not.
     */
    private void raiseTax(ServerPlayer serverPlayer, int taxRaise, Goods goods,
                          boolean result) {
<span class="nc" id="L569">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L570">        serverPlayer.csRaiseTax(taxRaise, goods, result, cs);</span>
<span class="nc" id="L571">        getGame().sendTo(serverPlayer, cs);</span>
<span class="nc" id="L572">    }</span>

    /**
     * Performs a monarch action.
     *
     * Note that CHANGE_LATE is used so that these actions follow
     * setting the current player, so that it is the players turn when
     * they respond to a monarch action.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; being acted upon.
     * @param action The monarch action.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csMonarchAction(final ServerPlayer serverPlayer,
                                 MonarchAction action, ChangeSet cs) {
<span class="nc" id="L587">        final Monarch monarch = serverPlayer.getMonarch();</span>
<span class="nc" id="L588">        final Game game = getGame();</span>
<span class="nc" id="L589">        final Specification spec = game.getSpecification();</span>
<span class="nc" id="L590">        boolean valid = monarch.actionIsValid(action);</span>
<span class="nc bnc" id="L591" title="All 2 branches missed.">        if (!valid) return;</span>
<span class="nc" id="L592">        String messageId = action.getTextKey();</span>
        StringTemplate template;
        MonarchActionMessage message;
<span class="nc" id="L595">        String monarchKey = serverPlayer.getMonarchKey();</span>

<span class="nc bnc" id="L597" title="All 11 branches missed.">        switch (action) {</span>
        case NO_ACTION:
<span class="nc" id="L599">            break;</span>
        case RAISE_TAX_WAR: case RAISE_TAX_ACT:
<span class="nc" id="L601">            final int taxRaise = monarch.raiseTax(random);</span>
<span class="nc" id="L602">            final Goods goods = serverPlayer.getMostValuableGoods();</span>
<span class="nc bnc" id="L603" title="All 2 branches missed.">            if (goods == null) {</span>
<span class="nc" id="L604">                logger.finest(&quot;Ignoring tax raise, no goods to boycott.&quot;);</span>
<span class="nc" id="L605">                break;</span>
            }
<span class="nc" id="L607">            template = StringTemplate.template(messageId)</span>
<span class="nc" id="L608">                .addStringTemplate(&quot;%goods%&quot;, goods.getType().getLabel())</span>
<span class="nc" id="L609">                .addAmount(&quot;%amount%&quot;, taxRaise);</span>
<span class="nc bnc" id="L610" title="All 2 branches missed.">            if (action == MonarchAction.RAISE_TAX_WAR) {</span>
<span class="nc" id="L611">                template = template.add(&quot;%nation%&quot;,</span>
<span class="nc" id="L612">                    Nation.getRandomNonPlayerNationNameKey(game, random));</span>
<span class="nc bnc" id="L613" title="All 2 branches missed.">            } else if (action == MonarchAction.RAISE_TAX_ACT) {</span>
<span class="nc" id="L614">                template = template.addAmount(&quot;%number%&quot;,</span>
<span class="nc" id="L615">                    randomInt(logger, &quot;Tax act goods&quot;, random, 6))</span>
<span class="nc" id="L616">                    .addName(&quot;%newWorld%&quot;, serverPlayer.getNewLandName());</span>
            }
<span class="nc" id="L618">            message = new MonarchActionMessage(action, template, monarchKey)</span>
<span class="nc" id="L619">                .setTax(taxRaise);</span>
<span class="nc" id="L620">            cs.add(See.only(serverPlayer), ChangePriority.CHANGE_EARLY,</span>
<span class="nc" id="L621">                   message);</span>
<span class="nc" id="L622">            new MonarchSession(serverPlayer, action, taxRaise, goods);</span>
<span class="nc" id="L623">            break;</span>
        case LOWER_TAX_WAR: case LOWER_TAX_OTHER:
<span class="nc" id="L625">            int oldTax = serverPlayer.getTax();</span>
<span class="nc" id="L626">            int taxLower = monarch.lowerTax(random);</span>
<span class="nc" id="L627">            serverPlayer.csSetTax(taxLower, cs);</span>
<span class="nc" id="L628">            template = StringTemplate.template(messageId)</span>
<span class="nc" id="L629">                .addAmount(&quot;%difference%&quot;, oldTax - taxLower)</span>
<span class="nc" id="L630">                .addAmount(&quot;%newTax%&quot;, taxLower);</span>
<span class="nc bnc" id="L631" title="All 2 branches missed.">            if (action == MonarchAction.LOWER_TAX_WAR) {</span>
<span class="nc" id="L632">                template = template.add(&quot;%nation%&quot;,</span>
<span class="nc" id="L633">                    Nation.getRandomNonPlayerNationNameKey(game, random));</span>
<span class="nc" id="L634">            } else {</span>
<span class="nc" id="L635">                template = template.addAmount(&quot;%number%&quot;,</span>
<span class="nc" id="L636">                    randomInt(logger, &quot;Lower tax reason&quot;, random, 5));</span>
            }
<span class="nc" id="L638">            cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
<span class="nc" id="L639">                new MonarchActionMessage(action, template, monarchKey));</span>
<span class="nc" id="L640">            break;</span>
        case WAIVE_TAX:
<span class="nc" id="L642">            cs.add(See.only(serverPlayer), ChangePriority.CHANGE_NORMAL,</span>
<span class="nc" id="L643">                new MonarchActionMessage(action,</span>
<span class="nc" id="L644">                    StringTemplate.template(messageId), monarchKey));</span>
<span class="nc" id="L645">            break;</span>
        case ADD_TO_REF:
<span class="nc" id="L647">            AbstractUnit refAdditions = monarch.chooseForREF(random);</span>
<span class="nc bnc" id="L648" title="All 2 branches missed.">            if (refAdditions == null) break;</span>
<span class="nc" id="L649">            monarch.getExpeditionaryForce().add(refAdditions);</span>
<span class="nc" id="L650">            template = StringTemplate.template(messageId)</span>
<span class="nc" id="L651">                .addAmount(&quot;%number%&quot;, refAdditions.getNumber())</span>
<span class="nc" id="L652">                .addNamed(&quot;%unit%&quot;, refAdditions.getType(spec));</span>
<span class="nc" id="L653">            cs.add(See.only(serverPlayer), monarch);</span>
<span class="nc" id="L654">            cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
<span class="nc" id="L655">                new MonarchActionMessage(action, template, monarchKey));</span>
<span class="nc" id="L656">            break;</span>
        case DECLARE_PEACE:
<span class="nc" id="L658">            List&lt;Player&gt; friends = monarch.collectPotentialFriends();</span>
<span class="nc bnc" id="L659" title="All 2 branches missed.">            if (friends.isEmpty()) break;</span>
<span class="nc" id="L660">            Player friend = getRandomMember(logger, &quot;Choose friend&quot;,</span>
<span class="nc" id="L661">                                            friends, random);</span>
<span class="nc" id="L662">            serverPlayer.csChangeStance(Stance.PEACE, (ServerPlayer)friend,</span>
<span class="nc" id="L663">                                        true, cs);</span>
<span class="nc" id="L664">            cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
<span class="nc" id="L665">                new MonarchActionMessage(action, StringTemplate</span>
<span class="nc" id="L666">                    .template(messageId)</span>
<span class="nc" id="L667">                    .addStringTemplate(&quot;%nation%&quot;, friend.getNationLabel()),</span>
<span class="nc" id="L668">                    monarchKey));</span>
<span class="nc" id="L669">            break;</span>
        case DECLARE_WAR:
<span class="nc" id="L671">            List&lt;Player&gt; enemies = monarch.collectPotentialEnemies();</span>
<span class="nc bnc" id="L672" title="All 2 branches missed.">            if (enemies.isEmpty()) break;</span>
<span class="nc" id="L673">            Player enemy = getRandomMember(logger, &quot;Choose enemy&quot;,</span>
<span class="nc" id="L674">                                           enemies, random);</span>
<span class="nc" id="L675">            List&lt;AbstractUnit&gt; warSupport </span>
<span class="nc" id="L676">                = monarch.getWarSupport(enemy, random);</span>
<span class="nc" id="L677">            int warGold = 0;</span>
<span class="nc bnc" id="L678" title="All 2 branches missed.">            if (!warSupport.isEmpty()) {</span>
<span class="nc" id="L679">                serverPlayer.createUnits(warSupport,</span>
<span class="nc" id="L680">                    serverPlayer.getEurope());//-vis: safe, Europe</span>
<span class="nc" id="L681">                warGold = spec.getInteger(GameOptions.WAR_SUPPORT_GOLD);</span>
<span class="nc" id="L682">                warGold += (warGold/10) * (randomInt(logger, &quot;War support gold&quot;,</span>
<span class="nc" id="L683">                                                     random, 5) - 2);</span>
<span class="nc" id="L684">                serverPlayer.modifyGold(warGold);</span>
<span class="nc" id="L685">                cs.addPartial(See.only(serverPlayer), serverPlayer,</span>
<span class="nc" id="L686">                              &quot;gold&quot;, &quot;score&quot;);</span>
<span class="nc" id="L687">                logger.fine(&quot;War support v &quot; + enemy.getNation().getSuffix()</span>
<span class="nc" id="L688">                    + &quot; &quot; + warGold + &quot; gold + &quot; + Messages.message(AbstractUnit</span>
<span class="nc" id="L689">                        .getListLabel(&quot;, &quot;, warSupport)));</span>
            }
<span class="nc" id="L691">            serverPlayer.csChangeStance(Stance.WAR, (ServerPlayer)enemy,</span>
<span class="nc" id="L692">                                        true, cs);</span>
<span class="nc" id="L693">            cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
<span class="nc" id="L694">                new MonarchActionMessage(action, StringTemplate</span>
<span class="nc bnc" id="L695" title="All 2 branches missed.">                    .template((warSupport.isEmpty()) ? messageId</span>
<span class="nc" id="L696">                        : &quot;model.monarch.action.declareWarSupported.text&quot;)</span>
<span class="nc" id="L697">                        .addStringTemplate(&quot;%nation%&quot;, enemy.getNationLabel())</span>
<span class="nc" id="L698">                        .addStringTemplate(&quot;%force%&quot;,</span>
<span class="nc" id="L699">                            AbstractUnit.getListLabel(&quot;, &quot;, warSupport))</span>
<span class="nc" id="L700">                        .addAmount(&quot;%gold%&quot;, warGold),</span>
<span class="nc" id="L701">                    monarchKey));</span>
<span class="nc" id="L702">            break;</span>
        case SUPPORT_LAND: case SUPPORT_SEA:
<span class="nc bnc" id="L704" title="All 2 branches missed.">            boolean sea = action == MonarchAction.SUPPORT_SEA;</span>
<span class="nc" id="L705">            List&lt;AbstractUnit&gt; support = monarch.getSupport(random, sea);</span>
<span class="nc bnc" id="L706" title="All 2 branches missed.">            if (support.isEmpty()) break;</span>
<span class="nc" id="L707">            serverPlayer.createUnits(support,</span>
<span class="nc" id="L708">                serverPlayer.getEurope());//-vis: safe, Europe</span>
<span class="nc" id="L709">            cs.add(See.only(serverPlayer), serverPlayer.getEurope());</span>
<span class="nc" id="L710">            cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
<span class="nc" id="L711">                new MonarchActionMessage(action, StringTemplate</span>
<span class="nc" id="L712">                    .template(messageId)</span>
<span class="nc" id="L713">                    .addStringTemplate(&quot;%addition%&quot;,</span>
<span class="nc" id="L714">                        AbstractUnit.getListLabel(&quot;, &quot;, support)),</span>
<span class="nc" id="L715">                    monarchKey));</span>
<span class="nc" id="L716">            break;</span>
        case MONARCH_MERCENARIES:
<span class="nc" id="L718">            final List&lt;AbstractUnit&gt; mercenaries</span>
<span class="nc" id="L719">                = monarch.getMercenaries(random);</span>
<span class="nc bnc" id="L720" title="All 2 branches missed.">            if (mercenaries.isEmpty()) break;</span>
<span class="nc" id="L721">            final int mercPrice = serverPlayer.priceMercenaries(mercenaries);</span>
<span class="nc" id="L722">            message = new MonarchActionMessage(action, StringTemplate</span>
<span class="nc" id="L723">                .template(messageId)</span>
<span class="nc" id="L724">                .addAmount(&quot;%gold%&quot;, mercPrice)</span>
<span class="nc" id="L725">                .addStringTemplate(&quot;%mercenaries%&quot;,</span>
<span class="nc" id="L726">                    AbstractUnit.getListLabel(&quot;, &quot;, mercenaries)),</span>
<span class="nc" id="L727">                monarchKey);</span>
<span class="nc" id="L728">            cs.add(See.only(serverPlayer), ChangePriority.CHANGE_EARLY,</span>
<span class="nc" id="L729">                   message);</span>
<span class="nc" id="L730">            new MonarchSession(serverPlayer, action, mercenaries, mercPrice);</span>
<span class="nc" id="L731">            break;</span>
        case HESSIAN_MERCENARIES:
<span class="nc" id="L733">            serverPlayer.csMercenaries(monarch.getMercenaries(random), action,</span>
<span class="nc" id="L734">                                       random, cs);</span>
<span class="nc" id="L735">            break;</span>
        case DISPLEASURE: default:
<span class="nc" id="L737">            logger.warning(&quot;Bogus action: &quot; + action);</span>
            break;
        }
<span class="nc" id="L740">    }</span>


    // Diplomacy support

    /**
     * Accept a diplomatic trade.  Handles the transfers of TradeItems.
     *
     * Note that first contact contexts may not necessarily have a settlement,
     * but this is ok because first contact trade can only include stance
     * and gold trade items.
     *
     * @param agreement The &lt;code&gt;DiplomacyTrade&lt;/code&gt; agreement.
     * @param session The &lt;code&gt;DiplomacySession&lt;/code&gt; in scope.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     * @return True if the trade was valid.
     */
    private boolean csAcceptTrade(DiplomaticTrade agreement,
                                  DiplomacySession session, ChangeSet cs) {
<span class="nc" id="L759">        final ServerPlayer srcPlayer = (ServerPlayer)agreement.getSender();</span>
<span class="nc" id="L760">        final ServerPlayer dstPlayer = (ServerPlayer)agreement.getRecipient();</span>
<span class="nc" id="L761">        final Unit unit = session.getUnit();</span>
<span class="nc" id="L762">        final Settlement settlement = session.getSettlement();</span>
<span class="nc" id="L763">        boolean visibilityChange = false;</span>

        // Check trade carefully before committing.
<span class="nc" id="L766">        boolean fail = false;</span>
<span class="nc bnc" id="L767" title="All 2 branches missed.">        for (TradeItem tradeItem : agreement.getTradeItems()) {</span>
<span class="nc" id="L768">            final ServerPlayer source = (ServerPlayer)tradeItem.getSource();</span>
<span class="nc" id="L769">            final ServerPlayer dest = (ServerPlayer)tradeItem.getDestination();</span>
<span class="nc bnc" id="L770" title="All 2 branches missed.">            if (!tradeItem.isValid()) {</span>
<span class="nc" id="L771">                logger.warning(&quot;Trade with invalid tradeItem: &quot; + tradeItem);</span>
<span class="nc" id="L772">                fail = true;</span>
<span class="nc" id="L773">                continue;</span>
            }
<span class="nc bnc" id="L775" title="All 4 branches missed.">            if (source != srcPlayer &amp;&amp; source != dstPlayer) {</span>
<span class="nc" id="L776">                logger.warning(&quot;Trade with invalid source: &quot;</span>
<span class="nc bnc" id="L777" title="All 2 branches missed.">                               + ((source == null) ? &quot;null&quot; : source.getId()));</span>
<span class="nc" id="L778">                fail = true;</span>
<span class="nc" id="L779">                continue;</span>
            }
<span class="nc bnc" id="L781" title="All 4 branches missed.">            if (dest != srcPlayer &amp;&amp; dest != dstPlayer) {</span>
<span class="nc" id="L782">                logger.warning(&quot;Trade with invalid destination: &quot;</span>
<span class="nc bnc" id="L783" title="All 2 branches missed.">                               + ((dest == null) ? &quot;null&quot; : dest.getId()));</span>
<span class="nc" id="L784">                fail = true;</span>
<span class="nc" id="L785">                continue;</span>
            }

<span class="nc" id="L788">            Colony colony = tradeItem.getColony(getGame());</span>
<span class="nc bnc" id="L789" title="All 4 branches missed.">            if (colony != null &amp;&amp; !source.owns(colony)) {</span>
<span class="nc" id="L790">                logger.warning(&quot;Trade with invalid source owner: &quot; + colony);</span>
<span class="nc" id="L791">                fail = true;</span>
<span class="nc" id="L792">                continue;</span>
            }
<span class="nc" id="L794">            int gold = tradeItem.getGold();</span>
<span class="nc bnc" id="L795" title="All 4 branches missed.">            if (gold &gt; 0 &amp;&amp; !source.checkGold(gold)) {</span>
<span class="nc" id="L796">                logger.warning(&quot;Trade with invalid gold: &quot; + gold);</span>
<span class="nc" id="L797">                fail = true;</span>
<span class="nc" id="L798">                continue;</span>
            }

<span class="nc" id="L801">            Goods goods = tradeItem.getGoods();</span>
<span class="nc bnc" id="L802" title="All 2 branches missed.">            if (goods != null) {</span>
<span class="nc" id="L803">                Location loc = goods.getLocation();</span>
<span class="nc bnc" id="L804" title="All 2 branches missed.">                if (loc instanceof Ownable</span>
<span class="nc bnc" id="L805" title="All 2 branches missed.">                    &amp;&amp; !source.owns((Ownable)loc)) {</span>
<span class="nc" id="L806">                    logger.warning(&quot;Trade with invalid source owner: &quot; + loc);</span>
<span class="nc" id="L807">                    fail = true;</span>
<span class="nc bnc" id="L808" title="All 2 branches missed.">                } else if (!(loc instanceof GoodsLocation</span>
<span class="nc bnc" id="L809" title="All 2 branches missed.">                        &amp;&amp; loc.contains(goods))) {</span>
<span class="nc" id="L810">                    logger.warning(&quot;Trade of unavailable goods &quot; + goods</span>
<span class="nc" id="L811">                        + &quot; at &quot; + loc);</span>
<span class="nc" id="L812">                    fail = true;</span>
<span class="nc bnc" id="L813" title="All 4 branches missed.">                } else if (dest.owns(unit) &amp;&amp; !unit.couldCarry(goods)) {</span>
<span class="nc" id="L814">                    logger.warning(&quot;Trade unit can not carry traded goods: &quot;</span>
<span class="nc" id="L815">                        + goods);</span>
<span class="nc" id="L816">                    fail = true;</span>
                }
            }

            // Stance trade fail is harmless
<span class="nc" id="L821">            Unit u = tradeItem.getUnit();</span>
<span class="nc bnc" id="L822" title="All 2 branches missed.">            if (u != null) {</span>
<span class="nc bnc" id="L823" title="All 2 branches missed.">                if (!source.owns(u)) {</span>
<span class="nc" id="L824">                    logger.warning(&quot;Trade with invalid source owner: &quot; + u);</span>
<span class="nc" id="L825">                    fail = true;</span>
<span class="nc" id="L826">                    continue;</span>
<span class="nc bnc" id="L827" title="All 4 branches missed.">                } else if (dest.owns(unit) &amp;&amp; !unit.couldCarry(u)) {</span>
<span class="nc" id="L828">                    logger.warning(&quot;Trade unit can not carry traded unit: &quot;</span>
<span class="nc" id="L829">                        + u);</span>
<span class="nc" id="L830">                    fail = true;</span>
                }
            }
        }
<span class="nc bnc" id="L834" title="All 2 branches missed.">        if (fail) return false;</span>

<span class="nc bnc" id="L836" title="All 2 branches missed.">        for (TradeItem tradeItem : agreement.getTradeItems()) {</span>
<span class="nc" id="L837">            final ServerPlayer source = (ServerPlayer)tradeItem.getSource();</span>
<span class="nc" id="L838">            final ServerPlayer dest = (ServerPlayer)tradeItem.getDestination();</span>
            // Collect changes for updating.  Not very OO but
            // TradeItem should not know about server internals.
            // Take care to show items that change hands to the *old*
            // owner too.
<span class="nc" id="L843">            Stance stance = tradeItem.getStance();</span>
<span class="nc bnc" id="L844" title="All 2 branches missed.">            if (stance != null</span>
<span class="nc bnc" id="L845" title="All 2 branches missed.">                &amp;&amp; !source.csChangeStance(stance, dest, true, cs)) {</span>
<span class="nc" id="L846">                logger.warning(&quot;Stance trade failure: &quot; + stance);</span>
            }
<span class="nc" id="L848">            Colony colony = tradeItem.getColony(getGame());</span>
<span class="nc bnc" id="L849" title="All 2 branches missed.">            if (colony != null) {</span>
<span class="nc" id="L850">                ServerPlayer former = (ServerPlayer) colony.getOwner();</span>
<span class="nc bnc" id="L851" title="All 2 branches missed.">                for (Tile t : colony.getOwnedTiles()) {</span>
<span class="nc" id="L852">                    t.cacheUnseen(dest);//+til</span>
                }
<span class="nc" id="L854">                ((ServerColony)colony).csChangeOwner(dest, cs);//-vis(both),-til</span>
<span class="nc" id="L855">                cs.add(See.only(dest), dest.exploreForSettlement(colony));</span>
<span class="nc" id="L856">                cs.add(See.perhaps().always(former), colony.getOwnedTiles());</span>
<span class="nc" id="L857">                visibilityChange = true;</span>
            }
<span class="nc" id="L859">            int gold = tradeItem.getGold();</span>
<span class="nc bnc" id="L860" title="All 2 branches missed.">            if (gold &gt; 0) {</span>
<span class="nc" id="L861">                source.modifyGold(-gold);</span>
<span class="nc" id="L862">                dest.modifyGold(gold);</span>
<span class="nc" id="L863">                cs.addPartial(See.only(source), source, &quot;gold&quot;, &quot;score&quot;);</span>
<span class="nc" id="L864">                cs.addPartial(See.only(dest), dest, &quot;gold&quot;, &quot;score&quot;);</span>
            }
<span class="nc" id="L866">            Goods goods = tradeItem.getGoods();</span>
<span class="nc bnc" id="L867" title="All 4 branches missed.">            if (goods != null &amp;&amp; settlement != null) {</span>
<span class="nc bnc" id="L868" title="All 2 branches missed.">                if (dest.owns(settlement)) {</span>
<span class="nc" id="L869">                    goods.setLocation(unit);</span>
<span class="nc" id="L870">                    moveGoods(unit, goods.getType(), goods.getAmount(), settlement);</span>
<span class="nc" id="L871">                    cs.add(See.only(source), unit);</span>
<span class="nc" id="L872">                    cs.add(See.only(dest), settlement.getGoodsContainer());</span>
<span class="nc" id="L873">                } else {</span>
<span class="nc" id="L874">                    goods.setLocation(settlement);</span>
<span class="nc" id="L875">                    moveGoods(settlement, goods.getType(), goods.getAmount(), unit);</span>
<span class="nc" id="L876">                    cs.add(See.only(dest), unit);</span>
<span class="nc" id="L877">                    cs.add(See.only(source), settlement.getGoodsContainer());</span>
                }
            }
<span class="nc" id="L880">            ServerPlayer victim = (ServerPlayer)tradeItem.getVictim();</span>
<span class="nc bnc" id="L881" title="All 2 branches missed.">            if (victim != null) {</span>
<span class="nc bnc" id="L882" title="All 2 branches missed.">                if (source.csChangeStance(Stance.WAR, victim, true, cs)) {</span>
                    // Have to add in an explicit stance change and
                    // message because the player does not normally
                    // have visibility of stance changes between other nations.
<span class="nc" id="L886">                    cs.addStance(See.only(dest), source, Stance.WAR, victim);</span>
<span class="nc" id="L887">                    cs.addMessage(See.only(dest),</span>
<span class="nc" id="L888">                        new ModelMessage(MessageType.FOREIGN_DIPLOMACY,</span>
<span class="nc" id="L889">                                         Stance.WAR.getOtherStanceChangeKey(),</span>
<span class="nc" id="L890">                                         source)</span>
<span class="nc" id="L891">                            .addStringTemplate(&quot;%attacker%&quot;,</span>
<span class="nc" id="L892">                                source.getNationLabel())</span>
<span class="nc" id="L893">                            .addStringTemplate(&quot;%defender%&quot;,</span>
<span class="nc" id="L894">                                victim.getNationLabel()));</span>
<span class="nc" id="L895">                } else {</span>
<span class="nc" id="L896">                    logger.warning(&quot;Incite trade failure: &quot; + victim);</span>
                }
            }                
<span class="nc" id="L899">            ServerUnit newUnit = (ServerUnit)tradeItem.getUnit();</span>
<span class="nc bnc" id="L900" title="All 4 branches missed.">            if (newUnit != null &amp;&amp; settlement != null) {</span>
<span class="nc" id="L901">                ServerPlayer former = (ServerPlayer)newUnit.getOwner();</span>
<span class="nc" id="L902">                Tile oldTile = newUnit.getTile();</span>
                Location newLoc;
<span class="nc bnc" id="L904" title="All 2 branches missed.">                if (unit.isOnCarrier()) {</span>
<span class="nc" id="L905">                    Unit carrier = unit.getCarrier();</span>
<span class="nc bnc" id="L906" title="All 2 branches missed.">                    if (!carrier.couldCarry(newUnit)) {</span>
<span class="nc" id="L907">                        logger.warning(&quot;Can not add &quot; + newUnit</span>
<span class="nc" id="L908">                            + &quot; to &quot; + carrier);</span>
<span class="nc" id="L909">                        continue;</span>
                    }
<span class="nc" id="L911">                    newLoc = carrier;</span>
<span class="nc bnc" id="L912" title="All 2 branches missed.">                } else if (dest == unit.getOwner()) {</span>
<span class="nc" id="L913">                    newLoc = unit.getTile();</span>
<span class="nc" id="L914">                } else {</span>
<span class="nc" id="L915">                    newLoc = settlement.getTile();</span>
                }
<span class="nc" id="L917">                if (source.csChangeOwner(newUnit, dest, ChangeType.CAPTURE,</span>
<span class="nc bnc" id="L918" title="All 2 branches missed.">                                         newLoc, cs)) {//-vis(both)</span>
<span class="nc" id="L919">                    newUnit.setMovesLeft(0);</span>
<span class="nc" id="L920">                    cs.add(See.perhaps().always(former), oldTile);</span>
                }
<span class="nc" id="L922">                visibilityChange = true;</span>
            }
        }
<span class="nc bnc" id="L925" title="All 2 branches missed.">        if (visibilityChange) {</span>
<span class="nc" id="L926">            srcPlayer.invalidateCanSeeTiles();//+vis(srcPlayer)</span>
<span class="nc" id="L927">            dstPlayer.invalidateCanSeeTiles();//+vis(dstPlayer)</span>
        }
<span class="nc" id="L929">        return true;</span>
    }

    /**
     * Process a European diplomacy session according to an agreement.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; in the session.
     * @param otherPlayer The other &lt;code&gt;ServerPlayer&lt;/code&gt; in the session.
     * @param agreement The &lt;code&gt;DiplomaticTrade&lt;/code&gt; to consider.
     * @param session The &lt;code&gt;DiplomacySession&lt;/code&gt; underway.
     * @param message A &lt;code&gt;DiplomacyMessage&lt;/code&gt; to send.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to contain the trade changes
     *     if accepted.
     * @return True if a new DiplomacyMessage reply needs to be sent.
     */
    private boolean csDiplomacySession(ServerPlayer serverPlayer,
                                       ServerPlayer otherPlayer,
                                       DiplomaticTrade agreement, 
                                       DiplomacySession session,
                                       DiplomacyMessage message,
                                       ChangeSet cs) {
        // Consider the status, process acceptance and rejection,
        // which need no further action.
<span class="nc" id="L952">        TradeStatus status = agreement.getStatus();</span>
<span class="nc bnc" id="L953" title="All 3 branches missed.">        switch (status) {</span>
        case PROPOSE_TRADE:
<span class="nc" id="L955">            session.setAgreement(agreement);</span>
<span class="nc" id="L956">            break;</span>
        case ACCEPT_TRADE:
            // Process the agreement that was sent!
<span class="nc" id="L959">            agreement = session.getAgreement();</span>
<span class="nc" id="L960">            agreement.setStatus(TradeStatus.ACCEPT_TRADE);</span>
<span class="nc bnc" id="L961" title="All 2 branches missed.">            if (csAcceptTrade(agreement, session, cs)) {</span>
<span class="nc" id="L962">                session.complete(cs);</span>
<span class="nc" id="L963">                getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L964">                return false;</span>
            }
            // Trade was invalid, fall through into rejection.
        case REJECT_TRADE: default:
<span class="nc" id="L968">            agreement = session.getAgreement();</span>
<span class="nc" id="L969">            agreement.setStatus(TradeStatus.REJECT_TRADE);</span>
<span class="nc" id="L970">            session.complete(cs);</span>
<span class="nc" id="L971">            getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L972">            return false;</span>
        }

        // Ask the other player to consider the agreement.
        // Treat a missing reply as a rejection.
<span class="nc" id="L977">        DOMMessage reply = askTimeout(otherPlayer, message);</span>
<span class="nc bnc" id="L978" title="All 2 branches missed.">        if (reply instanceof DiplomacyMessage) {</span>
<span class="nc" id="L979">            agreement = ((DiplomacyMessage)reply).getAgreement();</span>
<span class="nc" id="L980">            status = agreement.getStatus();</span>
<span class="nc" id="L981">        } else {</span>
<span class="nc" id="L982">            status = TradeStatus.REJECT_TRADE;</span>
<span class="nc" id="L983">            agreement.setStatus(status);</span>
        }
<span class="nc" id="L985">        agreement.incrementVersion();</span>

        // Process the result.  Always return true here as the serverPlayer
        // needs to be informed of the other player's response.
<span class="nc bnc" id="L989" title="All 3 branches missed.">        switch (status) {</span>
        case PROPOSE_TRADE:
<span class="nc" id="L991">            session.setAgreement(agreement);</span>
<span class="nc" id="L992">            break;</span>
        case ACCEPT_TRADE:
<span class="nc" id="L994">            agreement = session.getAgreement(); // Accept offered agreement</span>
<span class="nc" id="L995">            agreement.setStatus(TradeStatus.ACCEPT_TRADE);</span>
<span class="nc bnc" id="L996" title="All 2 branches missed.">            if (csAcceptTrade(agreement, session, cs)) {</span>
<span class="nc" id="L997">                session.complete(cs);</span>
<span class="nc" id="L998">                getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L999">                break;</span>
            }
            // Trade was invalid, fall through into rejection.
        case REJECT_TRADE: default:
<span class="nc" id="L1003">            agreement.setStatus(TradeStatus.REJECT_TRADE);</span>
<span class="nc" id="L1004">            session.setAgreement(agreement);</span>
<span class="nc" id="L1005">            session.complete(cs);</span>
<span class="nc" id="L1006">            getGame().sendToOthers(serverPlayer, cs);</span>
            break;
        }
<span class="nc" id="L1009">        return true;</span>
    }


    // Routines that follow implement the controller response to
    // messages.  The convention is to return a change set back to the
    // invoking message handler, but handle changes for other players
    // directly here.


    /**
     * Abandon a settlement.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is abandoning.
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; to abandon.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet abandonSettlement(ServerPlayer serverPlayer,
                                       Settlement settlement) {
<span class="nc" id="L1028">        ChangeSet cs = new ChangeSet();</span>

        // Drop trade routes and create history event before disposing.
<span class="nc bnc" id="L1031" title="All 2 branches missed.">        if (settlement instanceof Colony) {</span>
<span class="nc" id="L1032">            serverPlayer.csLoseLocation(settlement, cs);</span>
<span class="nc" id="L1033">            cs.addHistory(serverPlayer,</span>
<span class="nc" id="L1034">                new HistoryEvent(getGame().getTurn(),</span>
<span class="nc" id="L1035">                    HistoryEvent.HistoryEventType.ABANDON_COLONY, serverPlayer)</span>
<span class="nc" id="L1036">                    .addName(&quot;%colony%&quot;, settlement.getName()));</span>
        }

        // Comprehensive dispose.
<span class="nc" id="L1040">        serverPlayer.csDisposeSettlement(settlement, cs);//+vis</span>

        // FIXME: Player.settlements is still being fixed on the client side.
<span class="nc" id="L1043">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L1044">        return cs;</span>
    }


    /**
     * Ask about learning a skill at an IndianSettlement.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is learning.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is learning.
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; to learn from.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet askLearnSkill(ServerPlayer serverPlayer, Unit unit,
                                   IndianSettlement settlement) {
<span class="nc" id="L1058">        ChangeSet cs = new ChangeSet();</span>

<span class="nc" id="L1060">        csVisit(serverPlayer, settlement, 0, cs);</span>
<span class="nc" id="L1061">        Tile tile = settlement.getTile();</span>
<span class="nc" id="L1062">        tile.updateIndianSettlement(serverPlayer);</span>
<span class="nc" id="L1063">        cs.add(See.only(serverPlayer), tile);</span>
<span class="nc" id="L1064">        unit.setMovesLeft(0);</span>
<span class="nc" id="L1065">        cs.addPartial(See.only(serverPlayer), unit, &quot;movesLeft&quot;);</span>

        // Do not update others, nothing to see yet.
<span class="nc" id="L1068">        return cs;</span>
    }


    /**
     * Assign a student to a teacher.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
     * @param student The student &lt;code&gt;Unit&lt;/code&gt;.
     * @param teacher The teacher &lt;code&gt;Unit&lt;/code&gt;.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet assignTeacher(ServerPlayer serverPlayer, Unit student,
                                   Unit teacher) {
<span class="nc" id="L1082">        Unit oldStudent = teacher.getStudent();</span>
<span class="nc" id="L1083">        Unit oldTeacher = student.getTeacher();</span>

        // Only update units that changed their teaching situation.
<span class="nc" id="L1086">        ChangeSet cs = new ChangeSet();</span>
<span class="nc bnc" id="L1087" title="All 2 branches missed.">        if (oldTeacher != null) {</span>
<span class="nc" id="L1088">            oldTeacher.setStudent(null);</span>
<span class="nc" id="L1089">            cs.add(See.only(serverPlayer), oldTeacher);</span>
        }
<span class="nc bnc" id="L1091" title="All 2 branches missed.">        if (oldStudent != null) {</span>
<span class="nc" id="L1092">            oldStudent.setTeacher(null);</span>
<span class="nc" id="L1093">            cs.add(See.only(serverPlayer), oldStudent);</span>
        }
<span class="nc" id="L1095">        teacher.setStudent(student);</span>
<span class="nc" id="L1096">        teacher.changeWorkType(null);</span>
<span class="nc" id="L1097">        student.setTeacher(teacher);</span>
<span class="nc" id="L1098">        cs.add(See.only(serverPlayer), student, teacher);</span>
<span class="nc" id="L1099">        return cs;</span>
    }


    /**
     * Assign a trade route to a unit.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
     * @param unit The unit &lt;code&gt;Unit&lt;/code&gt; to assign to.
     * @param tradeRoute The &lt;code&gt;TradeRoute&lt;/code&gt; to assign.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet assignTradeRoute(ServerPlayer serverPlayer, Unit unit,
                                      TradeRoute tradeRoute) {
        // If clearing a trade route and the unit is at sea, set
        // the destination to the next stop.  Otherwise just clear
        // the destination.
        TradeRouteStop stop;
<span class="nc bnc" id="L1117" title="All 4 branches missed.">        unit.setDestination((tradeRoute == null &amp;&amp; unit.isAtSea()</span>
<span class="nc bnc" id="L1118" title="All 2 branches missed.">                &amp;&amp; (stop = unit.getStop()) != null) ? stop.getLocation()</span>
<span class="nc" id="L1119">            : null);</span>
<span class="nc" id="L1120">        unit.setTradeRoute(tradeRoute);</span>
<span class="nc bnc" id="L1121" title="All 2 branches missed.">        if (tradeRoute != null) {</span>
<span class="nc" id="L1122">            List&lt;TradeRouteStop&gt; stops = tradeRoute.getStops();</span>
<span class="nc" id="L1123">            int found = -1;</span>
<span class="nc bnc" id="L1124" title="All 2 branches missed.">            for (int i = 0; i &lt; stops.size(); i++) {</span>
<span class="nc" id="L1125">                if (Map.isSameLocation(unit.getLocation(),</span>
<span class="nc bnc" id="L1126" title="All 2 branches missed.">                                       stops.get(i).getLocation())) {</span>
<span class="nc" id="L1127">                    found = i;</span>
<span class="nc" id="L1128">                    break;</span>
                }
            }
<span class="nc bnc" id="L1131" title="All 2 branches missed.">            if (found &lt; 0) found = 0;</span>
<span class="nc" id="L1132">            unit.setCurrentStop(found);</span>
        }

        // Only visible to the player
<span class="nc" id="L1136">        return new ChangeSet().add(See.only(serverPlayer), unit);</span>
    }


    /**
     * Build a settlement.
     *
     * +til: Resolves many tile appearance changes.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is building.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is building.
     * @param name The new settlement name.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet buildSettlement(ServerPlayer serverPlayer, Unit unit,
                                     String name) {
<span class="nc" id="L1152">        final ServerGame game = getGame();</span>
<span class="nc" id="L1153">        final Specification spec = game.getSpecification();</span>
<span class="nc" id="L1154">        ChangeSet cs = new ChangeSet();</span>

        // Build settlement
<span class="nc" id="L1157">        Tile tile = unit.getTile();</span>
        Settlement settlement;
<span class="nc bnc" id="L1159" title="All 2 branches missed.">        if (Player.ASSIGN_SETTLEMENT_NAME.equals(name)) {</span>
<span class="nc" id="L1160">            name = serverPlayer.getSettlementName(random);</span>
        }
<span class="nc bnc" id="L1162" title="All 2 branches missed.">        if (serverPlayer.isEuropean()) {</span>
<span class="nc" id="L1163">            StringTemplate nation = serverPlayer.getNationLabel();</span>
<span class="nc" id="L1164">            settlement = new ServerColony(game, serverPlayer, name, tile);</span>
<span class="nc bnc" id="L1165" title="All 2 branches missed.">            for (Tile t : tile.getSurroundingTiles(settlement.getRadius())) {</span>
<span class="nc" id="L1166">                t.cacheUnseen();//+til</span>
            }
<span class="nc" id="L1168">            serverPlayer.addSettlement(settlement);</span>
<span class="nc" id="L1169">            settlement.placeSettlement(false);//-vis(serverPlayer,?),-til</span>
<span class="nc" id="L1170">            cs.add(See.only(serverPlayer),</span>
<span class="nc" id="L1171">                   serverPlayer.exploreForSettlement(settlement));</span>

<span class="nc" id="L1173">            cs.addHistory(serverPlayer, new HistoryEvent(game.getTurn(),</span>
<span class="nc" id="L1174">                    HistoryEvent.HistoryEventType.FOUND_COLONY, serverPlayer)</span>
<span class="nc" id="L1175">                .addName(&quot;%colony%&quot;, settlement.getName()));</span>

            // Remove equipment from founder in case role confuses
            // placement.
<span class="nc" id="L1179">            settlement.equipForRole(unit, spec.getDefaultRole(), 0);</span>

            // Coronado
<span class="nc bnc" id="L1182" title="All 2 branches missed.">            for (ServerPlayer sp : game.getConnectedPlayers(serverPlayer)) {</span>
<span class="nc bnc" id="L1183" title="All 2 branches missed.">                if (!sp.hasAbility(Ability.SEE_ALL_COLONIES)) continue;</span>
<span class="nc" id="L1184">                cs.add(See.only(sp), sp.exploreForSettlement(settlement));//-vis(sp)</span>
<span class="nc" id="L1185">                sp.invalidateCanSeeTiles();//+vis(sp)</span>
<span class="nc" id="L1186">                cs.addMessage(See.only(sp),</span>
<span class="nc" id="L1187">                    new ModelMessage(MessageType.FOREIGN_DIPLOMACY,</span>
<span class="nc" id="L1188">                                     &quot;buildColony.others&quot;, settlement)</span>
<span class="nc" id="L1189">                        .addStringTemplate(&quot;%nation%&quot;, nation)</span>
<span class="nc" id="L1190">                        .addStringTemplate(&quot;%colony%&quot;,</span>
<span class="nc" id="L1191">                            settlement.getLocationLabelFor(sp))</span>
<span class="nc" id="L1192">                        .addStringTemplate(&quot;%region%&quot;,</span>
<span class="nc" id="L1193">                            tile.getRegion().getLabel()));</span>
            }
<span class="nc" id="L1195">        } else {</span>
<span class="nc" id="L1196">            IndianNationType nationType</span>
<span class="nc" id="L1197">                = (IndianNationType) serverPlayer.getNationType();</span>
<span class="nc" id="L1198">            UnitType skill = RandomChoice</span>
<span class="nc" id="L1199">                .getWeightedRandom(logger, &quot;Choose skill&quot;,</span>
<span class="nc" id="L1200">                                   nationType.generateSkillsForTile(tile),</span>
<span class="nc" id="L1201">                                   random);</span>
<span class="nc bnc" id="L1202" title="All 2 branches missed.">            if (skill == null) { // Seasoned Scout</span>
<span class="nc" id="L1203">                List&lt;UnitType&gt; scouts = spec</span>
<span class="nc" id="L1204">                    .getUnitTypesWithAbility(Ability.EXPERT_SCOUT);</span>
<span class="nc" id="L1205">                skill = getRandomMember(logger, &quot;Choose scout&quot;, scouts, random);</span>
            }
<span class="nc" id="L1207">            settlement = new ServerIndianSettlement(game, serverPlayer, name,</span>
<span class="nc" id="L1208">                                                    tile, false, skill, null);</span>
<span class="nc bnc" id="L1209" title="All 2 branches missed.">            for (Tile t : tile.getSurroundingTiles(settlement.getRadius())) {</span>
<span class="nc" id="L1210">                t.cacheUnseen();//+til</span>
            }
<span class="nc" id="L1212">            serverPlayer.addSettlement(settlement);</span>
<span class="nc" id="L1213">            settlement.placeSettlement(true);//-vis(serverPlayer),-til</span>
<span class="nc bnc" id="L1214" title="All 2 branches missed.">            for (Player p : getGame().getLivePlayers(serverPlayer)) {</span>
<span class="nc bnc" id="L1215" title="All 2 branches missed.">                if (p == serverPlayer) continue;</span>
<span class="nc bnc" id="L1216" title="All 2 branches missed.">                ((IndianSettlement)settlement).setAlarm(p, (p.isIndian())</span>
<span class="nc" id="L1217">                    ? new Tension(Tension.Level.CONTENT.getLimit())</span>
<span class="nc" id="L1218">                    : serverPlayer.getTension(p));//-til</span>
            }
        }

        // Join the settlement.
<span class="nc" id="L1223">        unit.setLocation(settlement);//-vis(serverPlayer),-til</span>
<span class="nc" id="L1224">        unit.setMovesLeft(0);</span>

        // Update with settlement tile, and newly owned tiles.
<span class="nc" id="L1227">        cs.add(See.perhaps(), settlement.getOwnedTiles());</span>
<span class="nc" id="L1228">        serverPlayer.invalidateCanSeeTiles();//+vis(serverPlayer)</span>

        // Others can see tile changes.
<span class="nc" id="L1231">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L1232">        return cs;</span>
    }


    /**
     * Buy from a settlement.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is buying.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that will carry the goods.
     * @param settlement The &lt;code&gt;ServerIndianSettlement&lt;/code&gt; to buy from.
     * @param goods The &lt;code&gt;Goods&lt;/code&gt; to buy.
     * @param amount How much gold to pay.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet buyFromSettlement(ServerPlayer serverPlayer, Unit unit,
                                       ServerIndianSettlement settlement,
                                       Goods goods, int amount) {
<span class="nc" id="L1249">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L1250">        csVisit(serverPlayer, settlement, 0, cs);</span>

<span class="nc" id="L1252">        TradeSession session</span>
<span class="nc" id="L1253">            = TradeSession.lookup(TradeSession.class, unit, settlement);</span>
<span class="nc bnc" id="L1254" title="All 2 branches missed.">        if (session == null) {</span>
<span class="nc" id="L1255">            return serverPlayer.clientError(&quot;Trying to buy without opening a transaction session&quot;);</span>
        }
<span class="nc bnc" id="L1257" title="All 2 branches missed.">        if (!session.getBuy()) {</span>
<span class="nc" id="L1258">            return serverPlayer.clientError(&quot;Trying to buy in a session where buying is not allowed.&quot;);</span>
        }
<span class="nc bnc" id="L1260" title="All 2 branches missed.">        if (!unit.hasSpaceLeft()) {</span>
<span class="nc" id="L1261">            return serverPlayer.clientError(&quot;Unit is full, unable to buy.&quot;);</span>
        }

        // Check that this is the agreement that was made
<span class="nc" id="L1265">        AIPlayer ai = getFreeColServer().getAIPlayer(settlement.getOwner());</span>
<span class="nc" id="L1266">        int returnGold = ai.buyProposition(unit, settlement, goods, amount);</span>
<span class="nc bnc" id="L1267" title="All 2 branches missed.">        if (returnGold != amount) {</span>
<span class="nc" id="L1268">            return serverPlayer.clientError(&quot;This was not the price we agreed upon! Cheater?&quot;);</span>
        }
<span class="nc bnc" id="L1270" title="All 2 branches missed.">        if (!serverPlayer.checkGold(amount)) { // Check this is funded.</span>
<span class="nc" id="L1271">            return serverPlayer.clientError(&quot;Insufficient gold to buy.&quot;);</span>
        }

        // Valid, make the trade.
<span class="nc" id="L1275">        moveGoods(settlement, goods.getType(), goods.getAmount(), unit);</span>
<span class="nc" id="L1276">        cs.add(See.perhaps(), unit);</span>

<span class="nc" id="L1278">        Player settlementPlayer = settlement.getOwner();</span>
<span class="nc" id="L1279">        Tile tile = settlement.getTile();</span>
<span class="nc" id="L1280">        settlement.updateWantedGoods();</span>
<span class="nc" id="L1281">        settlementPlayer.modifyGold(amount);</span>
<span class="nc" id="L1282">        serverPlayer.modifyGold(-amount);</span>
<span class="nc" id="L1283">        settlement.csModifyAlarm(serverPlayer, -amount / 50, true, cs);</span>
<span class="nc" id="L1284">        tile.updateIndianSettlement(serverPlayer);</span>
<span class="nc" id="L1285">        cs.add(See.only(serverPlayer), tile);</span>
<span class="nc" id="L1286">        cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;);</span>
<span class="nc" id="L1287">        session.setBuy();</span>
<span class="nc" id="L1288">        logger.finest(serverPlayer.getName() + &quot; &quot; + unit + &quot; buys &quot; + goods</span>
<span class="nc" id="L1289">                      + &quot; at &quot; + settlement.getName() + &quot; for &quot; + amount);</span>

        // Others can see the unit capacity.
<span class="nc" id="L1292">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L1293">        return cs;</span>
    }


    /**
     * Buy goods in Europe.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is buying.
     * @param type The &lt;code&gt;GoodsType&lt;/code&gt; to buy.
     * @param amount The amount of goods to buy.
     * @param carrier The &lt;code&gt;Unit&lt;/code&gt; to carry the goods.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet buyGoods(ServerPlayer serverPlayer, GoodsType type,
                              int amount, Unit carrier) {
<span class="fc bfc" id="L1308" title="All 2 branches covered.">        if (!serverPlayer.canTrade(type, Access.EUROPE)) {</span>
<span class="fc" id="L1309">            return serverPlayer.clientError(&quot;Can not trade boycotted goods&quot;);</span>
        }

<span class="fc" id="L1312">        ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L1313">        GoodsContainer container = carrier.getGoodsContainer();</span>
<span class="fc" id="L1314">        container.saveState();</span>
<span class="fc" id="L1315">        int gold = serverPlayer.getGold();</span>
<span class="fc" id="L1316">        int buyAmount = serverPlayer.buy(container, type, amount);</span>
<span class="fc bfc" id="L1317" title="All 2 branches covered.">        if (buyAmount &lt; 0) {</span>
<span class="fc" id="L1318">            return serverPlayer.clientError(&quot;Player &quot; + serverPlayer.getName()</span>
<span class="fc" id="L1319">                + &quot; tried to buy &quot; + amount + &quot; &quot; + type.getSuffix());</span>
        }
<span class="fc" id="L1321">        serverPlayer.propagateToEuropeanMarkets(type, -buyAmount, random);</span>
<span class="fc" id="L1322">        serverPlayer.csFlushMarket(type, cs);</span>
<span class="fc" id="L1323">        carrier.setMovesLeft(0);</span>
<span class="fc" id="L1324">        cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;);</span>
<span class="fc" id="L1325">        cs.add(See.only(serverPlayer), carrier);</span>
<span class="fc" id="L1326">        logger.finest(carrier + &quot; bought &quot; + amount + &quot;(&quot; + buyAmount + &quot;)&quot;</span>
<span class="fc" id="L1327">            + &quot; &quot; + type.getSuffix()</span>
<span class="fc" id="L1328">            + &quot; in Europe for &quot; + (serverPlayer.getGold() - gold));</span>
        // Action occurs in Europe, nothing is visible to other players.
<span class="fc" id="L1330">        return cs;</span>
    }


    /**
     * Price some goods for sale from a settlement.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is buying.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is trading.
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; that is trading.
     * @param goods The &lt;code&gt;Goods&lt;/code&gt; to buy.
     * @param price The buyers proposed price for the goods.
     * @return A &lt;code&gt;BuyPropositionMessage&lt;/code&gt; encapsulating this action,
     *     or an error message on failure.
     */
    public DOMMessage buyProposition(ServerPlayer serverPlayer,
        Unit unit, Settlement settlement, Goods goods, int price) {
<span class="nc" id="L1347">        TradeSession session</span>
<span class="nc" id="L1348">            = TradeSession.lookup(TradeSession.class, unit, settlement);</span>
<span class="nc bnc" id="L1349" title="All 2 branches missed.">        if (session == null) {</span>
<span class="nc" id="L1350">            return new ErrorMessage(&quot;Proposing to buy without opening a transaction session?!&quot;);</span>
        }
<span class="nc bnc" id="L1352" title="All 2 branches missed.">        if (!session.getBuy()) {</span>
<span class="nc" id="L1353">            return new ErrorMessage(&quot;Proposing to buy in a session where buying is not allowed.&quot;);</span>
        }
<span class="nc" id="L1355">        ChangeSet cs = new ChangeSet();</span>
<span class="nc bnc" id="L1356" title="All 2 branches missed.">        if (settlement instanceof IndianSettlement) {</span>
<span class="nc" id="L1357">            csVisit(serverPlayer, (IndianSettlement)settlement, 0, cs);</span>
        }

        // AI considers the proposition, return with a gold value
<span class="nc" id="L1361">        AIPlayer ai = getFreeColServer().getAIPlayer(settlement.getOwner());</span>
<span class="nc" id="L1362">        int gold = ai.buyProposition(unit, settlement, goods, price);</span>

        // Others can not see proposals.
<span class="nc" id="L1365">        return new BuyPropositionMessage(unit, settlement, goods, gold);</span>
    }


    /**
     * Cash in a treasure train.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is cashing in.
     * @param unit The treasure train &lt;code&gt;Unit&lt;/code&gt; to cash in.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet cashInTreasureTrain(ServerPlayer serverPlayer, Unit unit) {
<span class="fc" id="L1377">        ChangeSet cs = new ChangeSet();</span>

        // Work out the cash in amount and the message to send.
<span class="fc" id="L1380">        int fullAmount = unit.getTreasureAmount();</span>
        int cashInAmount;
        String messageId;
<span class="pc bpc" id="L1383" title="1 of 2 branches missed.">        if (serverPlayer.getPlayerType() == PlayerType.COLONIAL) {</span>
            // Charge transport fee and apply tax
<span class="fc" id="L1385">            cashInAmount = (fullAmount - unit.getTransportFee())</span>
<span class="fc" id="L1386">                * (100 - serverPlayer.getTax()) / 100;</span>
<span class="fc" id="L1387">            messageId = &quot;cashInTreasureTrain.colonial&quot;;</span>
<span class="fc" id="L1388">        } else {</span>
            // No fee possible, no tax applies.
<span class="nc" id="L1390">            cashInAmount = fullAmount;</span>
<span class="nc" id="L1391">            messageId = &quot;cashInTreasureTrain.independent&quot;;</span>
        }

<span class="fc" id="L1394">        serverPlayer.modifyGold(cashInAmount);</span>
<span class="fc" id="L1395">        cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;, &quot;score&quot;);</span>
<span class="fc" id="L1396">        cs.addMessage(See.only(serverPlayer),</span>
<span class="fc" id="L1397">            new ModelMessage(MessageType.FOREIGN_DIPLOMACY,</span>
<span class="fc" id="L1398">                             messageId, serverPlayer, unit)</span>
<span class="fc" id="L1399">                .addAmount(&quot;%amount%&quot;, fullAmount)</span>
<span class="fc" id="L1400">                .addAmount(&quot;%cashInAmount%&quot;, cashInAmount));</span>
<span class="pc bpc" id="L1401" title="1 of 2 branches missed.">        messageId = (serverPlayer.isRebel()</span>
<span class="pc bpc" id="L1402" title="1 of 2 branches missed.">                     || serverPlayer.getPlayerType() == PlayerType.INDEPENDENT)</span>
<span class="nc" id="L1403">            ? &quot;cashInTreasureTrain.otherIndependent&quot;</span>
<span class="fc" id="L1404">            : &quot;cashInTreasureTrain.otherColonial&quot;;</span>
<span class="fc" id="L1405">        cs.addMessage(See.all().except(serverPlayer),</span>
<span class="fc" id="L1406">            new ModelMessage(MessageType.FOREIGN_DIPLOMACY,</span>
<span class="fc" id="L1407">                             messageId, serverPlayer)</span>
<span class="fc" id="L1408">                .addAmount(&quot;%amount%&quot;, fullAmount)</span>
<span class="fc" id="L1409">                .addStringTemplate(&quot;%nation%&quot;, serverPlayer.getNationLabel()));</span>

        // Dispose of the unit, only visible to the owner.
<span class="fc" id="L1412">        cs.add(See.only(serverPlayer), (FreeColGameObject)unit.getLocation());</span>
<span class="fc" id="L1413">        cs.addRemove(See.only(serverPlayer), null, unit);//-vis: safe in colony</span>
<span class="fc" id="L1414">        unit.dispose();</span>

        // Others can see the cash in message.
<span class="fc" id="L1417">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="fc" id="L1418">        return cs;</span>
    }


    /**
     * Change a units state.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to change the state of.
     * @param state The new &lt;code&gt;UnitState&lt;/code&gt;.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet changeState(ServerPlayer serverPlayer, Unit unit,
                                 UnitState state) {
<span class="nc" id="L1432">        ChangeSet cs = new ChangeSet();</span>

<span class="nc" id="L1434">        Tile tile = unit.getTile();</span>
<span class="nc bnc" id="L1435" title="All 4 branches missed.">        boolean tileDirty = tile != null &amp;&amp; tile.getIndianSettlement() != null;</span>
<span class="nc bnc" id="L1436" title="All 4 branches missed.">        if (state == UnitState.FORTIFYING &amp;&amp; tile != null) {</span>
<span class="nc bnc" id="L1437" title="All 2 branches missed.">            ServerColony colony = (tile.getOwningSettlement() instanceof Colony)</span>
<span class="nc" id="L1438">                ? (ServerColony) tile.getOwningSettlement()</span>
<span class="nc" id="L1439">                : null;</span>
<span class="nc bnc" id="L1440" title="All 2 branches missed.">            Player owner = (colony == null) ? null : colony.getOwner();</span>
<span class="nc bnc" id="L1441" title="All 2 branches missed.">            if (owner != null</span>
<span class="nc bnc" id="L1442" title="All 2 branches missed.">                &amp;&amp; owner != unit.getOwner()</span>
<span class="nc bnc" id="L1443" title="All 2 branches missed.">                &amp;&amp; serverPlayer.getStance(owner) != Stance.ALLIANCE</span>
<span class="nc bnc" id="L1444" title="All 2 branches missed.">                &amp;&amp; serverPlayer.getStance(owner) != Stance.PEACE) {</span>
<span class="nc bnc" id="L1445" title="All 2 branches missed.">                if (colony.isTileInUse(tile)) {</span>
<span class="nc" id="L1446">                    colony.csEvictUsers(unit, cs);</span>
                }
<span class="nc bnc" id="L1448" title="All 2 branches missed.">                if (serverPlayer.getStance(owner) == Stance.WAR) {</span>
<span class="nc" id="L1449">                    tile.changeOwnership(null, null); // Clear owner if at war</span>
<span class="nc" id="L1450">                    tileDirty = true;</span>
                }
            }
        }

<span class="nc" id="L1455">        unit.setState(state);</span>
<span class="nc bnc" id="L1456" title="All 2 branches missed.">        if (tileDirty) {</span>
<span class="nc" id="L1457">            cs.add(See.perhaps(), tile);</span>
<span class="nc" id="L1458">        } else {</span>
<span class="nc" id="L1459">            cs.add(See.perhaps(), (FreeColGameObject)unit.getLocation());</span>
        }

        // Others might be able to see the unit.
<span class="nc" id="L1463">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L1464">        return cs;</span>
    }


    /**
     * Change improvement work type.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to change the work type of.
     * @param type The new &lt;code&gt;TileImprovementType&lt;/code&gt; to produce.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet changeWorkImprovementType(ServerPlayer serverPlayer,
                                               Unit unit,
                                               TileImprovementType type) {
<span class="fc" id="L1479">        Tile tile = unit.getTile();</span>
<span class="fc" id="L1480">        TileImprovement improvement = tile.getTileImprovement(type);</span>
<span class="fc bfc" id="L1481" title="All 2 branches covered.">        if (improvement == null) { // Create the new improvement.</span>
<span class="fc" id="L1482">            improvement = new TileImprovement(getGame(), tile, type);</span>
<span class="fc" id="L1483">            tile.add(improvement);</span>
        }

<span class="fc" id="L1486">        unit.setWorkImprovement(improvement);</span>
<span class="fc" id="L1487">        unit.setState(UnitState.IMPROVING);</span>

        // Private update of the tile.
<span class="fc" id="L1490">        return new ChangeSet().add(See.only(serverPlayer), tile);</span>
    }


    /**
     * Change work type.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to change the work type of.
     * @param type The new &lt;code&gt;GoodsType&lt;/code&gt; to produce.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet changeWorkType(ServerPlayer serverPlayer, Unit unit,
                                    GoodsType type) {
<span class="pc bpc" id="L1504" title="1 of 2 branches missed.">        if (unit.getWorkType() != type) {</span>
<span class="fc" id="L1505">            unit.setExperience(0);</span>
<span class="fc" id="L1506">            unit.changeWorkType(type);</span>
        }

        // Private update of the colony.
<span class="fc" id="L1510">        return new ChangeSet().add(See.only(serverPlayer), unit.getColony());</span>
    }


    /**
     * Chat.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is chatting.
     * @param message The chat message.
     * @param pri A privacy setting, currently a noop.
     */
    public void chat(ServerPlayer serverPlayer, String message, boolean pri) {
<span class="nc" id="L1522">        getGame().sendToOthers(serverPlayer, new ChangeSet()</span>
<span class="nc" id="L1523">            .add(See.all().except(serverPlayer),</span>
<span class="nc" id="L1524">                 ChangeSet.ChangePriority.CHANGE_NORMAL,</span>
<span class="nc" id="L1525">                 new ChatMessage(serverPlayer, message, false)));</span>
<span class="nc" id="L1526">    }</span>


    /**
     * Claim land.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; claiming.
     * @param tile The &lt;code&gt;Tile&lt;/code&gt; to claim.
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; to claim for.
     * @param price The price to pay for the land, which must agree
     *     with the owner valuation, unless negative which denotes stealing.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet claimLand(ServerPlayer serverPlayer, Tile tile,
                               Settlement settlement, int price) {
<span class="fc" id="L1541">        ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L1542">        serverPlayer.csClaimLand(tile, settlement, price, cs);</span>

<span class="pc bpc" id="L1544" title="3 of 4 branches missed.">        if (settlement != null &amp;&amp; serverPlayer.isEuropean()) {</span>
            // Define Coronado to make all colony-owned tiles visible
<span class="nc bnc" id="L1546" title="All 2 branches missed.">            for (ServerPlayer sp : getGame().getConnectedPlayers(serverPlayer)) {</span>
<span class="nc bnc" id="L1547" title="All 2 branches missed.">                if (sp.isEuropean()</span>
<span class="nc bnc" id="L1548" title="All 2 branches missed.">                    &amp;&amp; sp.hasAbility(Ability.SEE_ALL_COLONIES)) {</span>
<span class="nc" id="L1549">                    sp.exploreTile(tile);</span>
<span class="nc" id="L1550">                    cs.add(See.only(sp), tile);</span>
<span class="nc" id="L1551">                    sp.invalidateCanSeeTiles();//+vis(sp)</span>
                }
            }
        }

        // Others can see the tile.
<span class="fc" id="L1557">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="fc" id="L1558">        return cs;</span>
    }


    /**
     * Clear the specialty of a unit.
     *
     * FIXME: why not clear speciality in the open?  You can disband!
     * If we implement this remember to fix the visibility.
     *
     * @param serverPlayer The owner of the unit.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to clear the speciality of.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet clearSpeciality(ServerPlayer serverPlayer, Unit unit) {
<span class="fc" id="L1573">        UnitType newType = unit.getTypeChange(ChangeType.CLEAR_SKILL,</span>
<span class="fc" id="L1574">                                              serverPlayer);</span>
<span class="pc bpc" id="L1575" title="1 of 2 branches missed.">        if (newType == null) {</span>
<span class="nc" id="L1576">            return serverPlayer.clientError(&quot;Can not clear unit speciality: &quot;</span>
<span class="nc" id="L1577">                + unit.getId());</span>
        }

        // There can be some restrictions that may prevent the
        // clearing of the speciality.  AFAICT the only ATM is that a
        // teacher can not lose its speciality, but this will need to
        // be revisited if we invent a work location that requires a
        // particular unit type.
<span class="fc bfc" id="L1585" title="All 2 branches covered.">        if (unit.getStudent() != null) {</span>
<span class="fc" id="L1586">            return serverPlayer.clientError(&quot;Can not clear speciality of a teacher.&quot;);</span>
        }

        // Valid, change type.
<span class="fc" id="L1590">        unit.changeType(newType);//-vis: safe in colony</span>

        // Update just the unit, others can not see it as this only happens
        // in-colony.
<span class="fc" id="L1594">        return new ChangeSet().add(See.only(serverPlayer), unit);</span>
    }


    /**
     * Close a transaction.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is trading.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is trading.
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; that is trading.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet closeTransaction(ServerPlayer serverPlayer, Unit unit,
                                      Settlement settlement) {
<span class="nc" id="L1608">        TradeSession session</span>
<span class="nc" id="L1609">            = TradeSession.lookup(TradeSession.class, unit, settlement);</span>
<span class="nc bnc" id="L1610" title="All 2 branches missed.">        if (session == null) {</span>
<span class="nc" id="L1611">            return serverPlayer.clientError(&quot;No such transaction session.&quot;);</span>
        }

<span class="nc" id="L1614">        ChangeSet cs = new ChangeSet();</span>
        // Restore unit movement if no action taken.
<span class="nc bnc" id="L1616" title="All 2 branches missed.">        if (!session.getActionTaken()) {</span>
<span class="nc" id="L1617">            unit.setMovesLeft(session.getMovesLeft());</span>
<span class="nc" id="L1618">            cs.addPartial(See.only(serverPlayer), unit, &quot;movesLeft&quot;);</span>
        }
<span class="nc" id="L1620">        session.complete(cs);</span>

        // Others can not see end of transaction.
<span class="nc" id="L1623">        return cs;</span>
    }


    /**
     * Combat.  Public for the test suite.
     *
     * @param attackerPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; who is attacking.
     * @param attacker The &lt;code&gt;FreeColGameObject&lt;/code&gt; that is attacking.
     * @param defender The &lt;code&gt;FreeColGameObject&lt;/code&gt; that is defending.
     * @param crs A list of &lt;code&gt;CombatResult&lt;/code&gt;s defining the result.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet combat(ServerPlayer attackerPlayer,
                            FreeColGameObject attacker,
                            FreeColGameObject defender,
                            List&lt;CombatResult&gt; crs) {
<span class="fc" id="L1640">        ChangeSet cs = new ChangeSet();</span>
        try {
<span class="fc" id="L1642">            attackerPlayer.csCombat(attacker, defender, crs, random, cs);</span>
<span class="pc" id="L1643">        } catch (IllegalStateException e) {</span>
<span class="nc" id="L1644">            logger.log(Level.WARNING, &quot;Combat FAIL&quot;, e);</span>
<span class="nc" id="L1645">            return attackerPlayer.clientError(e.getMessage());</span>
        }
<span class="fc" id="L1647">        getGame().sendToOthers(attackerPlayer, cs);</span>
<span class="fc" id="L1648">        return cs;</span>
    }


    /**
     * Continue playing after winning.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that plays on.
     */
    public void continuePlaying(ServerPlayer serverPlayer) {
<span class="nc" id="L1658">        final ServerGame game = getGame();</span>
<span class="nc bnc" id="L1659" title="All 2 branches missed.">        if (!getFreeColServer().getSinglePlayer()) {</span>
<span class="nc" id="L1660">            logger.warning(&quot;Can not continue playing in multiplayer!&quot;);</span>
<span class="nc bnc" id="L1661" title="All 2 branches missed.">        } else if (serverPlayer != game.checkForWinner()) {</span>
<span class="nc" id="L1662">            logger.warning(&quot;Can not continue playing, as &quot;</span>
<span class="nc" id="L1663">                           + serverPlayer.getName()</span>
<span class="nc" id="L1664">                           + &quot; has not won the game!&quot;);</span>
<span class="nc" id="L1665">        } else {</span>
<span class="nc" id="L1666">            final Specification spec = game.getSpecification();</span>
<span class="nc" id="L1667">            spec.getBooleanOption(GameOptions.VICTORY_DEFEAT_REF)</span>
<span class="nc" id="L1668">                .setValue(Boolean.FALSE);</span>
<span class="nc" id="L1669">            spec.getBooleanOption(GameOptions.VICTORY_DEFEAT_EUROPEANS)</span>
<span class="nc" id="L1670">                .setValue(Boolean.FALSE);</span>
<span class="nc" id="L1671">            spec.getBooleanOption(GameOptions.VICTORY_DEFEAT_HUMANS)</span>
<span class="nc" id="L1672">                .setValue(Boolean.FALSE);</span>
<span class="nc" id="L1673">            logger.info(&quot;Disabled victory conditions, as &quot;</span>
<span class="nc" id="L1674">                        + serverPlayer.getName()</span>
<span class="nc" id="L1675">                        + &quot; has won, but is continuing to play.&quot;);</span>
        }
<span class="nc" id="L1677">    }</span>


    /**
     * Declare independence.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is declaring.
     * @param nationName The new name for the independent nation.
     * @param countryName The new name for its residents.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; containing the response.
     */
    public ChangeSet declareIndependence(final ServerPlayer serverPlayer,
                                         String nationName, String countryName) {
<span class="nc" id="L1690">        final Game game = getGame();</span>
<span class="nc" id="L1691">        final Specification spec = game.getSpecification();</span>
<span class="nc" id="L1692">        ChangeSet cs = new ChangeSet();</span>

        // Cross the Rubicon
<span class="nc" id="L1695">        StringTemplate oldNation = serverPlayer.getNationLabel();</span>
<span class="nc" id="L1696">        serverPlayer.setIndependentNationName(nationName);</span>
<span class="nc" id="L1697">        serverPlayer.setNewLandName(countryName);</span>
<span class="nc" id="L1698">        serverPlayer.changePlayerType(PlayerType.REBEL);</span>

        // Do not add history event to cs as we are going to update the
        // entire player.  Likewise clear model messages.
<span class="nc" id="L1702">        Turn turn = game.getTurn();</span>
<span class="nc" id="L1703">        HistoryEvent h = new HistoryEvent(turn,</span>
<span class="nc" id="L1704">            HistoryEvent.HistoryEventType.DECLARE_INDEPENDENCE, serverPlayer);</span>
<span class="nc" id="L1705">        final int independenceTurn = spec.getInteger(GameOptions.INDEPENDENCE_TURN);</span>
<span class="nc" id="L1706">        h.setScore(Math.max(0, independenceTurn - turn.getNumber()));</span>
<span class="nc" id="L1707">        cs.addGlobalHistory(game, h);</span>
<span class="nc" id="L1708">        serverPlayer.clearModelMessages();</span>
<span class="nc" id="L1709">        cs.addMessage(See.only(serverPlayer),</span>
<span class="nc" id="L1710">            new ModelMessage(MessageType.FOREIGN_DIPLOMACY,</span>
<span class="nc" id="L1711">                             &quot;declareIndependence.resolution&quot;, serverPlayer));</span>

        // Dispose of units in or heading to Europe.
<span class="nc" id="L1714">        Europe europe = serverPlayer.getEurope();</span>
<span class="nc" id="L1715">        StringTemplate seized = StringTemplate.label(&quot;, &quot;);</span>
<span class="nc" id="L1716">        boolean lost = false;</span>
<span class="nc bnc" id="L1717" title="All 2 branches missed.">        for (Unit u : europe.getUnitList()) {</span>
<span class="nc" id="L1718">            seized.addStringTemplate(u.getLabel());</span>
<span class="nc" id="L1719">            cs.addRemoves(See.only(serverPlayer), null, u.getDisposeList());</span>
<span class="nc" id="L1720">            u.dispose();</span>
<span class="nc" id="L1721">            lost = true;</span>
        }
<span class="nc bnc" id="L1723" title="All 2 branches missed.">        for (Unit u : serverPlayer.getHighSeas().getUnitList()) {</span>
<span class="nc bnc" id="L1724" title="All 2 branches missed.">            if (u.getDestination() == europe) {</span>
<span class="nc" id="L1725">                seized.addStringTemplate(u.getLabel());</span>
<span class="nc" id="L1726">                cs.addRemoves(See.only(serverPlayer), null, u.getDisposeList());</span>
<span class="nc" id="L1727">                u.dispose();</span>
<span class="nc" id="L1728">                lost = true;</span>
            }
        }
<span class="nc bnc" id="L1731" title="All 2 branches missed.">        if (lost) {</span>
<span class="nc" id="L1732">            cs.addMessage(See.only(serverPlayer),</span>
<span class="nc" id="L1733">                new ModelMessage(MessageType.UNIT_LOST,</span>
<span class="nc" id="L1734">                                 &quot;declareIndependence.unitsSeized&quot;,</span>
<span class="nc" id="L1735">                                 serverPlayer)</span>
<span class="nc" id="L1736">                    .addStringTemplate(&quot;%units%&quot;, seized));</span>
        }
<span class="nc" id="L1738">        serverPlayer.csLoseLocation(europe, cs);</span>

        // Create the REF.
<span class="nc" id="L1741">        ServerPlayer refPlayer = createREFPlayer(serverPlayer);</span>
<span class="nc" id="L1742">        cs.addPlayer(refPlayer);</span>
        // Update the intervention force
<span class="nc" id="L1744">        final Monarch monarch = serverPlayer.getMonarch();</span>
<span class="nc" id="L1745">        monarch.updateInterventionForce();</span>
<span class="nc" id="L1746">        String otherKey = Nation.getRandomNonPlayerNationNameKey(game, random);</span>
<span class="nc" id="L1747">        cs.addMessage(See.only(serverPlayer),</span>
<span class="nc" id="L1748">            new ModelMessage(MessageType.FOREIGN_DIPLOMACY,</span>
<span class="nc" id="L1749">                             &quot;declareIndependence.interventionForce&quot;,</span>
<span class="nc" id="L1750">                             serverPlayer)</span>
<span class="nc" id="L1751">                .add(&quot;%nation%&quot;, otherKey)</span>
<span class="nc" id="L1752">                .addAmount(&quot;%number%&quot;,</span>
<span class="nc" id="L1753">                    spec.getInteger(GameOptions.INTERVENTION_BELLS)));</span>
<span class="nc" id="L1754">        serverPlayer.csChangeStance(Stance.WAR, refPlayer, true, cs);</span>

        // Generalized continental army muster.
        // Do not use UnitType.getTargetType.
<span class="nc" id="L1758">        java.util.Map&lt;UnitType, UnitType&gt; upgrades = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L1759" title="All 2 branches missed.">        for (UnitType unitType : spec.getUnitTypeList()) {</span>
<span class="nc" id="L1760">            UnitType upgrade = unitType.getTargetType(ChangeType.INDEPENDENCE,</span>
<span class="nc" id="L1761">                                                      serverPlayer);</span>
<span class="nc bnc" id="L1762" title="All 2 branches missed.">            if (upgrade != null) upgrades.put(unitType, upgrade);</span>
        }
<span class="nc" id="L1764">        java.util.Map&lt;UnitType, List&lt;Unit&gt;&gt; unitMap = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L1765" title="All 2 branches missed.">        for (Colony colony : serverPlayer.getColonies()) {</span>
<span class="nc" id="L1766">            List&lt;Unit&gt; allUnits = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1767">            allUnits.addAll(colony.getTile().getUnitList());</span>
<span class="nc" id="L1768">            allUnits.addAll(colony.getUnitList());</span>
<span class="nc" id="L1769">            int limit = (allUnits.size() + 2) * (colony.getSoL() - 50) / 100;</span>
<span class="nc bnc" id="L1770" title="All 2 branches missed.">            if (limit &lt;= 0) continue;</span>

<span class="nc" id="L1772">            unitMap.clear();</span>
<span class="nc bnc" id="L1773" title="All 2 branches missed.">            for (Unit unit : allUnits) {</span>
<span class="nc bnc" id="L1774" title="All 2 branches missed.">                if (upgrades.containsKey(unit.getType())) {</span>
<span class="nc" id="L1775">                    List&lt;Unit&gt; unitList = unitMap.get(unit.getType());</span>
<span class="nc bnc" id="L1776" title="All 2 branches missed.">                    if (unitList == null) {</span>
<span class="nc" id="L1777">                        unitList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1778">                        unitMap.put(unit.getType(), unitList);</span>
                    }
<span class="nc" id="L1780">                    unitList.add(unit);</span>
                }
            }
<span class="nc bnc" id="L1783" title="All 2 branches missed.">            for (Entry&lt;UnitType, List&lt;Unit&gt;&gt; entry : unitMap.entrySet()) {</span>
<span class="nc" id="L1784">                int n = 0;</span>
<span class="nc" id="L1785">                UnitType type = entry.getKey();</span>
<span class="nc" id="L1786">                List&lt;Unit&gt; units = entry.getValue();</span>
<span class="nc bnc" id="L1787" title="All 4 branches missed.">                while (!units.isEmpty() &amp;&amp; n &lt; limit) {</span>
<span class="nc" id="L1788">                    Unit unit = units.remove(0);</span>
<span class="nc" id="L1789">                    unit.changeType(upgrades.get(type));//-vis</span>
<span class="nc" id="L1790">                    cs.add(See.only(serverPlayer), unit);</span>
<span class="nc" id="L1791">                    n++;</span>
                }
<span class="nc" id="L1793">                cs.addMessage(See.only(serverPlayer),</span>
<span class="nc" id="L1794">                    new ModelMessage(MessageType.UNIT_IMPROVED,</span>
<span class="nc" id="L1795">                                     &quot;declareIndependence.continentalArmyMuster&quot;,</span>
<span class="nc" id="L1796">                                     serverPlayer, colony)</span>
<span class="nc" id="L1797">                        .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="nc" id="L1798">                        .addAmount(&quot;%number%&quot;, n)</span>
<span class="nc" id="L1799">                        .addNamed(&quot;%oldUnit%&quot;, type)</span>
<span class="nc" id="L1800">                        .addNamed(&quot;%unit%&quot;, upgrades.get(type)));</span>
<span class="nc" id="L1801">                limit -= n;</span>
            }
        }

        // The most hostile contacted non-warring natives declare war
        // on you and peace with the REF, least hostile contacted
        // natives declare peace on you and war on the REF.  If they
        // are the same nation, go to the next most hostile nation
        // that may already be at war.
<span class="nc" id="L1810">        final Comparator&lt;Player&gt; comp = Comparator.comparingInt(p -&gt;</span>
<span class="nc" id="L1811">            p.getTension(serverPlayer).getValue());</span>
<span class="nc" id="L1812">        List&lt;Player&gt; natives</span>
<span class="nc" id="L1813">            = toSortedList(game.getLiveNativePlayers(null).stream()</span>
<span class="nc" id="L1814">                .filter(p -&gt; p.hasContacted(serverPlayer)),</span>
<span class="nc" id="L1815">                comp);</span>
<span class="nc bnc" id="L1816" title="All 2 branches missed.">        if (!natives.isEmpty()) {</span>
<span class="nc" id="L1817">            ServerPlayer good = (ServerPlayer)natives.get(0);</span>
<span class="nc" id="L1818">            logger.info(&quot;Native ally following independence: &quot; + good);</span>
<span class="nc" id="L1819">            cs.addMessage(See.only(serverPlayer),</span>
<span class="nc" id="L1820">                new ModelMessage(MessageType.FOREIGN_DIPLOMACY,</span>
<span class="nc" id="L1821">                                 &quot;declareIndependence.nativeSupport&quot;, good)</span>
<span class="nc" id="L1822">                    .addStringTemplate(&quot;%nation%&quot;, good.getNationLabel())</span>
<span class="nc" id="L1823">                    .add(&quot;%ruler%&quot;, serverPlayer.getRulerNameKey()));</span>
            int delta;
<span class="nc bnc" id="L1825" title="All 3 branches missed.">            switch (good.getStance(serverPlayer)) {</span>
            case ALLIANCE: case PEACE: default:
<span class="nc" id="L1827">                delta = 0;</span>
<span class="nc" id="L1828">                break;</span>
            case CEASE_FIRE:
<span class="nc" id="L1830">                delta = Tension.Level.HAPPY.getLimit()</span>
<span class="nc" id="L1831">                    - good.getTension(serverPlayer).getValue();</span>
<span class="nc" id="L1832">                break;</span>
            case WAR:
<span class="nc" id="L1834">                delta = Tension.Level.CONTENT.getLimit()</span>
<span class="nc" id="L1835">                    - good.getTension(serverPlayer).getValue();</span>
                break;
            }
<span class="nc" id="L1838">            good.csModifyTension(serverPlayer, delta, cs);</span>
<span class="nc" id="L1839">            Player.makeContact(good, refPlayer);</span>
<span class="nc" id="L1840">            good.csModifyTension(refPlayer,</span>
<span class="nc" id="L1841">                Tension.Level.HATEFUL.getLimit(), cs);</span>

<span class="nc" id="L1843">            reverse(natives);</span>
<span class="nc" id="L1844">            ServerPlayer bad = null;</span>
<span class="nc bnc" id="L1845" title="All 2 branches missed.">            for (Player p : natives) {</span>
<span class="nc bnc" id="L1846" title="All 2 branches missed.">                if (p == good</span>
<span class="nc bnc" id="L1847" title="All 2 branches missed.">                    || p.getStance(serverPlayer) == Stance.ALLIANCE) break;</span>
<span class="nc" id="L1848">                bad = (ServerPlayer)p;</span>
<span class="nc bnc" id="L1849" title="All 2 branches missed.">                if (!p.atWarWith(serverPlayer)) break;</span>
            }
<span class="nc" id="L1851">            logger.info(&quot;Native enemy following independence: &quot; + bad);</span>
<span class="nc bnc" id="L1852" title="All 2 branches missed.">            if (bad != null) {</span>
<span class="nc bnc" id="L1853" title="All 2 branches missed.">                switch (bad.getStance(serverPlayer)) {</span>
                case PEACE: case CEASE_FIRE:
<span class="nc" id="L1855">                    delta = Tension.Level.HATEFUL.getLimit()</span>
<span class="nc" id="L1856">                        - bad.getTension(serverPlayer).getValue();</span>
<span class="nc" id="L1857">                    break;</span>
                case WAR: default:
<span class="nc" id="L1859">                    delta = 0;</span>
                    break;
                }
<span class="nc" id="L1862">                cs.addMessage(See.only(serverPlayer),</span>
<span class="nc" id="L1863">                    new ModelMessage(MessageType.FOREIGN_DIPLOMACY,</span>
<span class="nc" id="L1864">                                     &quot;declareIndependence.nativeHostile&quot;, bad)</span>
<span class="nc" id="L1865">                        .addStringTemplate(&quot;%nation%&quot;, bad.getNationLabel()));</span>
<span class="nc bnc" id="L1866" title="All 2 branches missed.">                if (delta != 0) bad.csModifyTension(serverPlayer, delta, cs);</span>
<span class="nc" id="L1867">                Player.makeContact(bad, refPlayer);</span>
<span class="nc" id="L1868">                bad.csModifyTension(refPlayer,</span>
<span class="nc" id="L1869">                    -bad.getTension(refPlayer).getValue(), cs);</span>
            }
        }

        // Make the mercenary force offer
<span class="nc" id="L1874">        serverPlayer.csMercenaries(monarch.getMercenaryForce().getUnits(),</span>
<span class="nc" id="L1875">            Monarch.MonarchAction.HESSIAN_MERCENARIES, random, cs);</span>
        
        // Pity to have to update such a heavy object as the player,
        // but we do this, at most, once per player.  Other players
        // only need a partial player update and the stance change.
        // Put the stance change after the name change so that the
        // other players see the new nation name declaring war.  The
        // REF is hardwired to declare war on rebels so there is no
        // need to adjust its stance or tension.
<span class="nc" id="L1884">        cs.addPartial(See.all().except(serverPlayer), serverPlayer,</span>
<span class="nc" id="L1885">                      &quot;playerType&quot;, &quot;independentNationName&quot;, &quot;newLandName&quot;);</span>
<span class="nc" id="L1886">        cs.addMessage(See.all().except(serverPlayer),</span>
<span class="nc" id="L1887">            new ModelMessage(MessageType.FOREIGN_DIPLOMACY,</span>
<span class="nc" id="L1888">                             &quot;declareIndependence.announce&quot;,</span>
<span class="nc" id="L1889">                             serverPlayer)</span>
<span class="nc" id="L1890">                .addStringTemplate(&quot;%oldNation%&quot;, oldNation)</span>
<span class="nc" id="L1891">                .addStringTemplate(&quot;%newNation%&quot;, serverPlayer.getNationLabel())</span>
<span class="nc" id="L1892">                .add(&quot;%ruler%&quot;, serverPlayer.getRulerNameKey()));</span>
<span class="nc" id="L1893">        cs.add(See.only(serverPlayer), serverPlayer);</span>
<span class="nc" id="L1894">        serverPlayer.invalidateCanSeeTiles();//+vis(serverPlayer)</span>

        // Now that everything is ready, we can dispose of Europe.
<span class="nc" id="L1897">        cs.addRemove(See.only(serverPlayer), null, europe);//-vis: not on map</span>
<span class="nc" id="L1898">        europe.dispose();</span>
        // Do not clean up the Monarch, it contains the intervention force

<span class="nc" id="L1901">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L1902">        return cs;</span>
    }


    /**
     * Decline to investigate strange mounds.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
     * @param tile The &lt;code&gt;Tile&lt;/code&gt; where the mounds are.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet declineMounds(ServerPlayer serverPlayer, Tile tile) {
<span class="nc" id="L1914">        tile.cacheUnseen();//+til</span>
<span class="nc" id="L1915">        tile.removeLostCityRumour();//-til</span>

        // Others might see rumour disappear
<span class="nc" id="L1918">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L1919">        cs.add(See.perhaps(), tile);</span>
<span class="nc" id="L1920">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L1921">        return cs;</span>
    }


    /**
     * Delete a trade route.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; to delete a trade
     *     route for.
     * @param tradeRoute The &lt;code&gt;TradeRoute&lt;/code&gt; to delete.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet deleteTradeRoute(ServerPlayer serverPlayer,
                                      TradeRoute tradeRoute) {
<span class="nc" id="L1935">        List&lt;Unit&gt; dropped = serverPlayer.removeTradeRoute(tradeRoute);</span>

        // Trade route change is entirely internal
<span class="nc" id="L1938">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L1939">        cs.add(See.only(serverPlayer), serverPlayer); // FIXME: big update</span>
<span class="nc bnc" id="L1940" title="All 2 branches missed.">        if (!dropped.isEmpty()) cs.add(See.only(serverPlayer), dropped);</span>
<span class="nc" id="L1941">        return cs;</span>
    }


    /**
     * Deliver gift to settlement.
     * Note that this includes both European and native gifts.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is delivering.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is delivering.
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; to deliver to.
     * @param goods The &lt;code&gt;Goods&lt;/code&gt; to deliver.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet deliverGiftToSettlement(ServerPlayer serverPlayer,
                                             Unit unit, Settlement settlement,
                                             Goods goods) {
<span class="nc" id="L1958">        TradeSession session</span>
<span class="nc" id="L1959">            = TransactionSession.lookup(TradeSession.class, unit, settlement);</span>
<span class="nc bnc" id="L1960" title="All 2 branches missed.">        if (session == null) {</span>
<span class="nc" id="L1961">            return serverPlayer.clientError(&quot;Trying to deliver gift without opening a session&quot;);</span>
        }
<span class="nc bnc" id="L1963" title="All 2 branches missed.">        if (!session.getGift()) {</span>
<span class="nc" id="L1964">            return serverPlayer.clientError(&quot;Trying to deliver gift in a session where gift giving is not allowed: &quot; + unit + &quot; &quot; + settlement + &quot; &quot; + session);</span>
        }

<span class="nc" id="L1967">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L1968">        Tile tile = settlement.getTile();</span>
<span class="nc" id="L1969">        moveGoods(unit, goods.getType(), goods.getAmount(), settlement);</span>
<span class="nc" id="L1970">        cs.add(See.perhaps(), unit);</span>
<span class="nc bnc" id="L1971" title="All 2 branches missed.">        if (settlement instanceof ServerIndianSettlement) {</span>
<span class="nc" id="L1972">            ServerIndianSettlement sis = (ServerIndianSettlement)settlement;</span>
<span class="nc" id="L1973">            csVisit(serverPlayer, sis, 0, cs);</span>
<span class="nc" id="L1974">            sis.csModifyAlarm(serverPlayer, -sis.getPriceToBuy(goods) / 50,</span>
<span class="nc" id="L1975">                              true, cs);</span>
<span class="nc" id="L1976">            sis.updateWantedGoods();</span>
<span class="nc" id="L1977">            tile.updateIndianSettlement(serverPlayer);</span>
<span class="nc" id="L1978">            cs.add(See.only(serverPlayer), tile);</span>
        }
<span class="nc" id="L1980">        session.setGift();</span>

        // Inform the receiver of the gift.
<span class="nc" id="L1983">        ModelMessage m = new ModelMessage(MessageType.GIFT_GOODS,</span>
<span class="nc" id="L1984">                                          &quot;deliverGift.goods&quot;,</span>
<span class="nc" id="L1985">                                          settlement, goods.getType())</span>
<span class="nc" id="L1986">            .addStringTemplate(&quot;%player%&quot;, serverPlayer.getNationLabel())</span>
<span class="nc" id="L1987">            .addNamed(&quot;%type%&quot;, goods)</span>
<span class="nc" id="L1988">            .addAmount(&quot;%amount%&quot;, goods.getAmount())</span>
<span class="nc" id="L1989">            .addName(&quot;%settlement%&quot;, settlement.getName());</span>
<span class="nc" id="L1990">        cs.addMessage(See.only(serverPlayer), m);</span>
<span class="nc" id="L1991">        ServerPlayer receiver = (ServerPlayer) settlement.getOwner();</span>
<span class="nc bnc" id="L1992" title="All 4 branches missed.">        if (receiver.isConnected() &amp;&amp; settlement instanceof Colony) {</span>
<span class="nc" id="L1993">            cs.add(See.only(receiver), unit);</span>
<span class="nc" id="L1994">            cs.add(See.only(receiver), settlement);</span>
<span class="nc" id="L1995">            cs.addMessage(See.only(receiver), m);</span>
        }
<span class="nc" id="L1997">        logger.info(&quot;Gift delivered by unit: &quot; + unit.getId()</span>
<span class="nc" id="L1998">                    + &quot; to settlement: &quot; + settlement.getName());</span>

        // Others can see unit capacity, receiver gets it own items.
<span class="nc" id="L2001">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L2002">        return cs;</span>
    }


    /**
     * Demand a tribute from a native settlement.
     *
     * FIXME: Move TURNS_PER_TRIBUTE magic number to the spec.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; demanding the tribute.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is demanding the tribute.
     * @param settlement The &lt;code&gt;ServerIndianSettlement&lt;/code&gt; demanded of.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet demandTribute(ServerPlayer serverPlayer, Unit unit,
                                   ServerIndianSettlement settlement) {
<span class="nc" id="L2018">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L2019">        final int TURNS_PER_TRIBUTE = 5;</span>

<span class="nc" id="L2021">        csVisit(serverPlayer, settlement, 0, cs);</span>

<span class="nc" id="L2023">        Player indianPlayer = settlement.getOwner();</span>
<span class="nc" id="L2024">        int gold = 0;</span>
<span class="nc" id="L2025">        int year = getGame().getTurn().getNumber();</span>
<span class="nc" id="L2026">        RandomRange gifts = settlement.getType().getGifts(unit);</span>
<span class="nc bnc" id="L2027" title="All 2 branches missed.">        if (settlement.getLastTribute() + TURNS_PER_TRIBUTE &lt; year</span>
<span class="nc bnc" id="L2028" title="All 2 branches missed.">            &amp;&amp; gifts != null) {</span>
<span class="nc bnc" id="L2029" title="All 3 branches missed.">            switch (indianPlayer.getTension(serverPlayer).getLevel()) {</span>
            case HAPPY: case CONTENT:
<span class="nc" id="L2031">                gold = Math.min(gifts.getAmount(&quot;Tribute&quot;, random, true) / 10,</span>
<span class="nc" id="L2032">                                100);</span>
<span class="nc" id="L2033">                break;</span>
            case DISPLEASED:
<span class="nc" id="L2035">                gold = Math.min(gifts.getAmount(&quot;Tribute&quot;, random, true) / 20,</span>
<span class="nc" id="L2036">                                100);</span>
<span class="nc" id="L2037">                break;</span>
            case ANGRY: case HATEFUL:
            default:
<span class="nc" id="L2040">                gold = 0; // No tribute for you.</span>
                break;
            }
        }

        // Increase tension whether we paid or not.  Apply tension
        // directly to the settlement and let propagation work.
<span class="nc" id="L2047">        settlement.csModifyAlarm(serverPlayer, Tension.TENSION_ADD_NORMAL,</span>
<span class="nc" id="L2048">                                 true, cs);</span>
<span class="nc" id="L2049">        settlement.setLastTribute(year);</span>
        ModelMessage m;
<span class="nc bnc" id="L2051" title="All 2 branches missed.">        if (gold &gt; 0) {</span>
<span class="nc" id="L2052">            indianPlayer.modifyGold(-gold);</span>
<span class="nc" id="L2053">            serverPlayer.modifyGold(gold);</span>
<span class="nc" id="L2054">            cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;, &quot;score&quot;);</span>
<span class="nc" id="L2055">            m = new ModelMessage(MessageType.FOREIGN_DIPLOMACY,</span>
<span class="nc" id="L2056">                                 &quot;scoutSettlement.tributeAgree&quot;,</span>
<span class="nc" id="L2057">                                 unit, settlement)</span>
<span class="nc" id="L2058">                .addAmount(&quot;%amount%&quot;, gold);</span>
<span class="nc" id="L2059">        } else {</span>
<span class="nc" id="L2060">            m = new ModelMessage(MessageType.FOREIGN_DIPLOMACY,</span>
<span class="nc" id="L2061">                                 &quot;scoutSettlement.tributeDisagree&quot;,</span>
<span class="nc" id="L2062">                                 unit, settlement);</span>
        }
<span class="nc" id="L2064">        cs.addMessage(See.only(serverPlayer), m);</span>
<span class="nc" id="L2065">        Tile tile = settlement.getTile();</span>
<span class="nc" id="L2066">        tile.updateIndianSettlement(serverPlayer);</span>
<span class="nc" id="L2067">        cs.add(See.only(serverPlayer), tile);</span>
<span class="nc" id="L2068">        unit.setMovesLeft(0);</span>
<span class="nc" id="L2069">        cs.addPartial(See.only(serverPlayer), unit, &quot;movesLeft&quot;);</span>

        // Do not update others, this is all private.
<span class="nc" id="L2072">        return cs;</span>
    }


    /**
     * Denounce an existing mission.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is denouncing.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; denouncing.
     * @param settlement The &lt;code&gt;ServerIndianSettlement&lt;/code&gt;
     *     containing the mission to denounce.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet denounceMission(ServerPlayer serverPlayer, Unit unit,
                                     ServerIndianSettlement settlement) {
<span class="nc" id="L2087">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L2088">        csVisit(serverPlayer, settlement, 0, cs);</span>

        // Determine result
<span class="nc" id="L2091">        Unit missionary = settlement.getMissionary();</span>
<span class="nc bnc" id="L2092" title="All 2 branches missed.">        if (missionary == null) {</span>
<span class="nc" id="L2093">            return serverPlayer.clientError(&quot;Denouncing null missionary&quot;);</span>
        }
<span class="nc" id="L2095">        ServerPlayer enemy = (ServerPlayer) missionary.getOwner();</span>
<span class="nc" id="L2096">        double denounce = randomDouble(logger, &quot;Denounce base&quot;, random)</span>
<span class="nc" id="L2097">            * enemy.getImmigration() / (serverPlayer.getImmigration() + 1);</span>
<span class="nc bnc" id="L2098" title="All 2 branches missed.">        if (missionary.hasAbility(Ability.EXPERT_MISSIONARY)) {</span>
<span class="nc" id="L2099">            denounce += 0.2;</span>
        }
<span class="nc bnc" id="L2101" title="All 2 branches missed.">        if (unit.hasAbility(Ability.EXPERT_MISSIONARY)) {</span>
<span class="nc" id="L2102">            denounce -= 0.2;</span>
        }

<span class="nc bnc" id="L2105" title="All 2 branches missed.">        if (denounce &lt; 0.5) { // Success, remove old mission and establish ours</span>
<span class="nc" id="L2106">            return establishMission(serverPlayer, unit, settlement);</span>
        }

        // Denounce failed
<span class="nc" id="L2110">        Player owner = settlement.getOwner();</span>
<span class="nc" id="L2111">        cs.add(See.only(serverPlayer), settlement);</span>
<span class="nc" id="L2112">        cs.addMessage(See.only(serverPlayer),</span>
<span class="nc" id="L2113">            new ModelMessage(MessageType.FOREIGN_DIPLOMACY,</span>
<span class="nc" id="L2114">                             &quot;indianSettlement.mission.noDenounce&quot;,</span>
<span class="nc" id="L2115">                             serverPlayer, unit)</span>
<span class="nc" id="L2116">                .addStringTemplate(&quot;%nation%&quot;, owner.getNationLabel()));</span>
<span class="nc" id="L2117">        cs.addMessage(See.only(enemy),</span>
<span class="nc" id="L2118">            new ModelMessage(MessageType.FOREIGN_DIPLOMACY,</span>
<span class="nc" id="L2119">                             &quot;indianSettlement.mission.enemyDenounce&quot;,</span>
<span class="nc" id="L2120">                             enemy, settlement)</span>
<span class="nc" id="L2121">                .addStringTemplate(&quot;%enemy%&quot;, serverPlayer.getNationLabel())</span>
<span class="nc" id="L2122">                .addStringTemplate(&quot;%settlement%&quot;,</span>
<span class="nc" id="L2123">                    settlement.getLocationLabelFor(enemy))</span>
<span class="nc" id="L2124">                .addStringTemplate(&quot;%nation%&quot;, owner.getNationLabel()));</span>
<span class="nc" id="L2125">        cs.add(See.perhaps().always(serverPlayer),</span>
<span class="nc" id="L2126">               (FreeColGameObject)unit.getLocation());</span>
<span class="nc" id="L2127">        cs.addRemove(See.perhaps().always(serverPlayer),</span>
<span class="nc" id="L2128">                     unit.getLocation(), unit);//-vis(serverPlayer)</span>
<span class="nc" id="L2129">        unit.dispose();</span>
<span class="nc" id="L2130">        serverPlayer.invalidateCanSeeTiles();//+vis(serverPlayer)</span>

        // Others can see missionary disappear
<span class="nc" id="L2133">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L2134">        return cs;</span>
    }


    /**
     * Diplomacy.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is trading.
     * @param ourUnit The &lt;code&gt;Unit&lt;/code&gt; that is trading.
     * @param otherColony The &lt;code&gt;Colony&lt;/code&gt; to trade with.
     * @param agreement The &lt;code&gt;DiplomaticTrade&lt;/code&gt; to consider.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet diplomacy(ServerPlayer serverPlayer, Unit ourUnit,
                               Colony otherColony, DiplomaticTrade agreement) {
<span class="nc" id="L2149">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L2150">        TradeStatus status = agreement.getStatus();</span>
<span class="nc" id="L2151">        DiplomacySession session</span>
<span class="nc" id="L2152">            = TransactionSession.lookup(DiplomacySession.class,</span>
<span class="nc" id="L2153">                                        ourUnit, otherColony);</span>
<span class="nc bnc" id="L2154" title="All 2 branches missed.">        if (session == null) {</span>
<span class="nc bnc" id="L2155" title="All 2 branches missed.">            if (status != TradeStatus.PROPOSE_TRADE) {</span>
<span class="nc" id="L2156">                return serverPlayer.clientError(&quot;Mission uc-diplomacy session for &quot;</span>
<span class="nc" id="L2157">                    + ourUnit.getId() + &quot;/&quot; + otherColony.getId()</span>
<span class="nc" id="L2158">                    + &quot; with &quot; + agreement);</span>
            }
<span class="nc" id="L2160">            session = new DiplomacySession(ourUnit, otherColony);</span>
        }
<span class="nc" id="L2162">        ServerPlayer otherPlayer = (ServerPlayer)otherColony.getOwner();</span>
<span class="nc" id="L2163">        if (csDiplomacySession(serverPlayer, otherPlayer, agreement, session,</span>
<span class="nc bnc" id="L2164" title="All 2 branches missed.">                new DiplomacyMessage(otherColony, ourUnit, agreement), cs)) {</span>
<span class="nc" id="L2165">            cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
<span class="nc" id="L2166">                new DiplomacyMessage(ourUnit, otherColony, </span>
<span class="nc" id="L2167">                                     session.getAgreement()));</span>
        }
<span class="nc" id="L2169">        return cs;</span>
    }

    /**
     * Diplomacy.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is trading.
     * @param ourColony Our &lt;code&gt;Colony&lt;/code&gt;.
     * @param otherUnit The other &lt;code&gt;Unit&lt;/code&gt; that is trading.
     * @param agreement The &lt;code&gt;DiplomaticTrade&lt;/code&gt; to consider.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet diplomacy(ServerPlayer serverPlayer, Colony ourColony,
                               Unit otherUnit, DiplomaticTrade agreement) {
<span class="nc" id="L2183">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L2184">        DiplomacySession session</span>
<span class="nc" id="L2185">            = TransactionSession.lookup(DiplomacySession.class,</span>
<span class="nc" id="L2186">                                        otherUnit, ourColony);</span>
<span class="nc bnc" id="L2187" title="All 2 branches missed.">        if (session == null) {</span>
<span class="nc" id="L2188">            return serverPlayer.clientError(&quot;Mission cu-diplomacy session for &quot;</span>
<span class="nc" id="L2189">                + otherUnit.getId() + &quot;/&quot; + ourColony.getId()</span>
<span class="nc" id="L2190">                + &quot; with &quot; + agreement);</span>
        }
<span class="nc" id="L2192">        ServerPlayer otherPlayer = (ServerPlayer)otherUnit.getOwner();</span>
<span class="nc" id="L2193">        if (csDiplomacySession(serverPlayer, otherPlayer, agreement, session,</span>
<span class="nc bnc" id="L2194" title="All 2 branches missed.">                new DiplomacyMessage(otherUnit, ourColony, agreement), cs)) {</span>
<span class="nc" id="L2195">            cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
<span class="nc" id="L2196">                new DiplomacyMessage(ourColony, otherUnit,</span>
<span class="nc" id="L2197">                                     session.getAgreement()));</span>
        }
<span class="nc" id="L2199">        return cs;</span>
    }


    /**
     * Disband a unit.
     *
     * @param serverPlayer The owner of the unit.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to disband.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet disbandUnit(ServerPlayer serverPlayer, Unit unit) {
<span class="nc" id="L2211">        ChangeSet cs = new ChangeSet();</span>

        // Dispose of the unit.
<span class="nc" id="L2214">        cs.add(See.perhaps().always(serverPlayer),</span>
<span class="nc" id="L2215">               (FreeColGameObject)unit.getLocation());</span>
<span class="nc" id="L2216">        cs.addRemove(See.perhaps().always(serverPlayer),</span>
<span class="nc" id="L2217">                     unit.getLocation(), unit);//-vis(serverPlayer)</span>
<span class="nc" id="L2218">        unit.dispose();</span>
<span class="nc" id="L2219">        serverPlayer.invalidateCanSeeTiles();//+vis(serverPlayer)</span>

        // Others can see the unit removal and the space it leaves.
<span class="nc" id="L2222">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L2223">        return cs;</span>
    }


    /**
     * Disembark unit from a carrier.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; whose unit is
     *                     embarking.
     * @param serverUnit The &lt;code&gt;ServerUnit&lt;/code&gt; that is disembarking.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet disembarkUnit(ServerPlayer serverPlayer,
                                   ServerUnit serverUnit) {
<span class="nc bnc" id="L2237" title="All 2 branches missed.">        if (serverUnit.isNaval()) {</span>
<span class="nc" id="L2238">            return serverPlayer.clientError(&quot;Naval unit &quot; + serverUnit.getId()</span>
<span class="nc" id="L2239">                + &quot; can not disembark.&quot;);</span>
        }
<span class="nc" id="L2241">        Unit carrier = serverUnit.getCarrier();</span>
<span class="nc bnc" id="L2242" title="All 2 branches missed.">        if (carrier == null) {</span>
<span class="nc" id="L2243">            return serverPlayer.clientError(&quot;Unit &quot; + serverUnit.getId()</span>
<span class="nc" id="L2244">                + &quot; is not embarked.&quot;);</span>
        }

<span class="nc" id="L2247">        ChangeSet cs = new ChangeSet();</span>

<span class="nc" id="L2249">        Location newLocation = carrier.getLocation();</span>
<span class="nc bnc" id="L2250" title="All 2 branches missed.">        List&lt;Tile&gt; newTiles = (newLocation.getTile() == null) ? null</span>
<span class="nc" id="L2251">            : serverUnit.collectNewTiles(newLocation.getTile());</span>
<span class="nc" id="L2252">        serverUnit.setLocation(newLocation);//-vis(serverPlayer)</span>
<span class="nc" id="L2253">        serverPlayer.invalidateCanSeeTiles();//+vis(serverPlayer)</span>
<span class="nc" id="L2254">        serverUnit.setMovesLeft(0); // In Col1 disembark consumes whole move.</span>
<span class="nc" id="L2255">        cs.add(See.perhaps(), (FreeColGameObject)newLocation);</span>
<span class="nc bnc" id="L2256" title="All 2 branches missed.">        if (newTiles != null) {</span>
<span class="nc" id="L2257">            serverPlayer.csSeeNewTiles(newTiles, cs);</span>
        }

        // Others can (potentially) see the location.
<span class="nc" id="L2261">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L2262">        return cs;</span>
    }


    /**
     * Embark a unit onto a carrier.
     * Checking that the locations are appropriate is not done here.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; embarking.
     * @param serverUnit The &lt;code&gt;ServerUnit&lt;/code&gt; that is embarking.
     * @param carrier The &lt;code&gt;Unit&lt;/code&gt; to embark onto.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet embarkUnit(ServerPlayer serverPlayer,
                                ServerUnit serverUnit, Unit carrier) {
<span class="fc bfc" id="L2277" title="All 2 branches covered.">        if (serverUnit.isNaval()) {</span>
<span class="fc" id="L2278">            return serverPlayer.clientError(&quot;Naval unit &quot; + serverUnit.getId()</span>
<span class="fc" id="L2279">                + &quot; can not embark.&quot;);</span>
        }
<span class="fc" id="L2281">        UnitLocation.NoAddReason reason = carrier.getNoAddReason(serverUnit);</span>
<span class="fc bfc" id="L2282" title="All 2 branches covered.">        if (reason != UnitLocation.NoAddReason.NONE) {</span>
<span class="fc" id="L2283">            return serverPlayer.clientError(&quot;Carrier: &quot; + carrier.getId()</span>
<span class="fc" id="L2284">                + &quot; can not carry &quot; + serverUnit.getId() + &quot;: &quot; + reason);</span>
        }

<span class="fc" id="L2287">        ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L2288">        serverUnit.csEmbark(carrier, cs);</span>

        // Others might see the unit disappear, or the carrier capacity.
<span class="fc" id="L2291">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="fc" id="L2292">        return cs;</span>
    }


    /**
     * A unit migrates from Europe.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; whose unit it will be.
     * @param slot The slot within &lt;code&gt;Europe&lt;/code&gt; to select the unit from.
     * @param type The type of migration occurring.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet emigrate(ServerPlayer serverPlayer, int slot,
                              MigrationType type) {
<span class="nc" id="L2306">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L2307">        serverPlayer.csEmigrate(slot, type, random, cs);</span>

        // Do not update others, emigration is private.
<span class="nc" id="L2310">        return cs;</span>
    }


    /**
     * Ends the turn of the given player.
     *
     * Note: sends messages to other players.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; to end the turn of.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating the end of turn changes.
     */
    public ChangeSet endTurn(ServerPlayer serverPlayer) {
<span class="nc" id="L2323">        final FreeColServer freeColServer = getFreeColServer();</span>
<span class="nc" id="L2324">        final ServerGame game = getGame();</span>
<span class="nc" id="L2325">        final ServerPlayer winner = (ServerPlayer)game.checkForWinner();</span>

<span class="nc" id="L2327">        ServerPlayer current = (ServerPlayer)game.getCurrentPlayer();</span>
<span class="nc bnc" id="L2328" title="All 2 branches missed.">        if (serverPlayer != current) {</span>
<span class="nc" id="L2329">            throw new IllegalArgumentException(&quot;It is not &quot;</span>
<span class="nc" id="L2330">                + serverPlayer.getName() + &quot;'s turn, it is &quot;</span>
<span class="nc bnc" id="L2331" title="All 2 branches missed.">                + ((current == null) ? &quot;noone&quot; : current.getName()) + &quot;'s!&quot;);</span>
        }

        for (;;) {
<span class="nc" id="L2335">            logger.finest(&quot;Ending turn for &quot; + current.getName());</span>
<span class="nc" id="L2336">            current.clearModelMessages();</span>

            // Check for new turn
<span class="nc" id="L2339">            ChangeSet cs = new ChangeSet();</span>
<span class="nc bnc" id="L2340" title="All 2 branches missed.">            if (game.isNextPlayerInNewTurn()) {</span>
<span class="nc" id="L2341">                ChangeSet next = new ChangeSet();</span>
<span class="nc" id="L2342">                game.csNextTurn(next);</span>
<span class="nc" id="L2343">                game.sendToAll(next);</span>

<span class="nc" id="L2345">                LogBuilder lb = new LogBuilder(512);</span>
<span class="nc" id="L2346">                lb.add(&quot;New turn &quot;, game.getTurn(), &quot; for &quot;);</span>
<span class="nc" id="L2347">                game.csNewTurn(random, lb, cs);</span>
<span class="nc" id="L2348">                lb.shrink(&quot;, &quot;);</span>
<span class="nc" id="L2349">                lb.log(logger, Level.FINEST);</span>
<span class="nc bnc" id="L2350" title="All 2 branches missed.">                if (debugOnlyAITurns &gt; 0) {</span>
<span class="nc bnc" id="L2351" title="All 2 branches missed.">                    if (--debugOnlyAITurns &lt;= 0) {</span>
                        // If this was a debug run, complete it.  This will
                        // signal the client to save and quit at the next
                        // suitable opportunity.
<span class="nc" id="L2355">                        FreeColDebugger.signalEndDebugRun();</span>
                    }
                }
            }

<span class="nc bnc" id="L2360" title="All 2 branches missed.">            if ((current = (ServerPlayer)game.getNextPlayer()) == null) {</span>
                // &quot;can not happen&quot;
<span class="nc" id="L2362">                return serverPlayer.clientError(&quot;Can not get next player&quot;);</span>
            }

            // Remove dead players and retry
<span class="nc bnc" id="L2366" title="All 3 branches missed.">            switch (current.checkForDeath()) {</span>
            case ServerPlayer.IS_DEAD:
<span class="nc" id="L2368">                current.csWithdraw(cs);</span>
<span class="nc" id="L2369">                logger.info(&quot;For &quot; + serverPlayer.getSuffix()</span>
<span class="nc" id="L2370">                    + &quot;, &quot; + current.getNation() + &quot; is dead.&quot;);</span>
<span class="nc" id="L2371">                game.sendToAll(cs, current);</span>
<span class="nc" id="L2372">                continue;</span>
            case ServerPlayer.IS_ALIVE:
<span class="nc bnc" id="L2374" title="All 4 branches missed.">                if (current.isREF() &amp;&amp; current.checkForREFDefeat()) {</span>
<span class="nc bnc" id="L2375" title="All 2 branches missed.">                    for (Player p : current.getRebels()) {</span>
<span class="nc" id="L2376">                        csGiveIndependence(current, (ServerPlayer)p, cs);</span>
                    }
<span class="nc" id="L2378">                    current.csWithdraw(cs);</span>
<span class="nc" id="L2379">                    logger.info(current.getNation() + &quot; is defeated.&quot;);</span>
<span class="nc" id="L2380">                    game.sendToAll(cs, current);</span>
<span class="nc" id="L2381">                    continue;</span>
                }
                break;
            default: // Need to autorecruit a unit to keep alive.
<span class="nc" id="L2385">                current.csEmigrate(0, MigrationType.SURVIVAL, random, cs);</span>
                break;
            }
            // Are there humans left?
            // FIXME: see if this can be relaxed so we can run large
            // AI-only simulations.
<span class="nc" id="L2391">            boolean onlyAI = all(game.getConnectedPlayers(), Player::isAI);</span>
<span class="nc bnc" id="L2392" title="All 2 branches missed.">            if (onlyAI) {</span>
<span class="nc" id="L2393">                logger.info(&quot;No human player left.&quot;);</span>
<span class="nc bnc" id="L2394" title="All 2 branches missed.">                if (debugOnlyAITurns &gt; 0) { // Complete debug runs</span>
<span class="nc" id="L2395">                    FreeColDebugger.signalEndDebugRun();</span>
                }
<span class="nc" id="L2397">                game.setCurrentPlayer(null);</span>

<span class="nc" id="L2399">                cs.addTrivial(See.all(), &quot;gameEnded&quot;,</span>
<span class="nc" id="L2400">                              ChangePriority.CHANGE_NORMAL);</span>
<span class="nc" id="L2401">                game.sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L2402">                return cs;</span>
            }

            // Has the player won?
            // Do not end single player games where an AI has won,
            // that would stop revenge mode.
<span class="nc bnc" id="L2408" title="All 2 branches missed.">            if (winner == current</span>
<span class="nc bnc" id="L2409" title="All 4 branches missed.">                &amp;&amp; !(freeColServer.getSinglePlayer() &amp;&amp; winner.isAI())) {</span>
<span class="nc bnc" id="L2410" title="All 2 branches missed.">                boolean highScore = !winner.isAI()</span>
<span class="nc bnc" id="L2411" title="All 2 branches missed.">                    &amp;&amp; HighScore.newHighScore(winner);</span>
<span class="nc" id="L2412">                cs.addTrivial(See.all(), &quot;gameEnded&quot;,</span>
<span class="nc" id="L2413">                              ChangePriority.CHANGE_NORMAL,</span>
<span class="nc" id="L2414">                              &quot;highScore&quot;, String.valueOf(highScore),</span>
<span class="nc" id="L2415">                              &quot;winner&quot;, winner.getId());</span>
            }

            // Do &quot;new turn&quot;-like actions that need to wait until right
            // before the player is about to move.
<span class="nc" id="L2420">            game.setCurrentPlayer(current);</span>
<span class="nc bnc" id="L2421" title="All 4 branches missed.">            if (current.isREF() &amp;&amp; current.getEntryLocation() == null) {</span>
                // Initialize this newly created REF
                // If the teleportREF option is enabled, teleport it in.
<span class="nc" id="L2424">                REFAIPlayer refAIPlayer = (REFAIPlayer)freeColServer</span>
<span class="nc" id="L2425">                    .getAIPlayer(current);</span>
<span class="nc" id="L2426">                boolean teleport = game.getSpecification()</span>
<span class="nc" id="L2427">                    .getBoolean(GameOptions.TELEPORT_REF);</span>
<span class="nc bnc" id="L2428" title="All 2 branches missed.">                if (refAIPlayer.initialize(teleport)) {</span>
<span class="nc" id="L2429">                    csLaunchREF(current, teleport, cs);</span>
<span class="nc" id="L2430">                } else {</span>
<span class="nc" id="L2431">                    logger.severe(&quot;REF failed to initialize.&quot;);</span>
                }
            }
<span class="nc" id="L2434">            current.csStartTurn(random, cs);</span>

<span class="nc" id="L2436">            cs.addTrivial(See.all(), &quot;setCurrentPlayer&quot;,</span>
<span class="nc" id="L2437">                          ChangePriority.CHANGE_LATE,</span>
<span class="nc" id="L2438">                          &quot;player&quot;, current.getId());</span>
<span class="nc bnc" id="L2439" title="All 2 branches missed.">            if (current.getPlayerType() == PlayerType.COLONIAL) {</span>
<span class="nc" id="L2440">                Monarch monarch = current.getMonarch();</span>
<span class="nc" id="L2441">                MonarchAction action = null;</span>
<span class="nc bnc" id="L2442" title="All 2 branches missed.">                if (debugMonarchAction != null</span>
<span class="nc bnc" id="L2443" title="All 2 branches missed.">                    &amp;&amp; current == debugMonarchPlayer) {</span>
<span class="nc" id="L2444">                    action = debugMonarchAction;</span>
<span class="nc" id="L2445">                    debugMonarchAction = null;</span>
<span class="nc" id="L2446">                    debugMonarchPlayer = null;</span>
<span class="nc" id="L2447">                    logger.finest(&quot;Debug monarch action: &quot; + action);</span>
<span class="nc" id="L2448">                } else {</span>
<span class="nc" id="L2449">                    action = RandomChoice.getWeightedRandom(logger,</span>
<span class="nc" id="L2450">                            &quot;Choose monarch action&quot;,</span>
<span class="nc" id="L2451">                        monarch.getActionChoices(), random);</span>
                }
<span class="nc bnc" id="L2453" title="All 2 branches missed.">                if (action != null) {</span>
<span class="nc bnc" id="L2454" title="All 2 branches missed.">                    if (monarch.actionIsValid(action)) {</span>
<span class="nc" id="L2455">                        logger.finest(&quot;Monarch action: &quot; + action);</span>
<span class="nc" id="L2456">                        csMonarchAction(current, action, cs);</span>
<span class="nc" id="L2457">                    } else {</span>
<span class="nc" id="L2458">                        logger.finest(&quot;Skipping invalid monarch action: &quot;</span>
<span class="nc" id="L2459">                            + action);</span>
                    }
                }
            }

            // Prepare to update, with current player last so that it
            // does not immediately start moving and cause further
            // changes which conflict with these updates.
<span class="nc" id="L2467">            List&lt;ServerPlayer&gt; players = game.getConnectedPlayers(current);</span>
<span class="nc" id="L2468">            players.add(current);</span>

            // If this is a debug run, update everyone and continue.
<span class="nc bnc" id="L2471" title="All 4 branches missed.">            boolean debugSkip = !current.isAI()</span>
<span class="nc bnc" id="L2472" title="All 2 branches missed.">                &amp;&amp; freeColServer.getSinglePlayer()</span>
<span class="nc" id="L2473">                &amp;&amp; debugOnlyAITurns &gt; 0;</span>
<span class="nc bnc" id="L2474" title="All 2 branches missed.">            if (debugSkip) {</span>
<span class="nc" id="L2475">                game.sendToList(players, cs);</span>
<span class="nc" id="L2476">                continue;</span>
            }

            // Flush accumulated changes, returning to serverPlayer.
<span class="nc" id="L2480">            players.remove(serverPlayer);</span>
<span class="nc" id="L2481">            game.sendToList(players, cs);</span>
<span class="nc" id="L2482">            return cs;</span>
        }
    }


    /**
     * Enters revenge mode against those evil AIs.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; entering revenge mode.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet enterRevengeMode(ServerPlayer serverPlayer) {
<span class="nc bnc" id="L2494" title="All 2 branches missed.">        if (!getFreeColServer().getSinglePlayer()) {</span>
<span class="nc" id="L2495">            return serverPlayer.clientError(&quot;Can not enter revenge mode,&quot;</span>
                + &quot; as this is not a single player game.&quot;);
        }
<span class="nc" id="L2498">        Game game = getGame();</span>
<span class="nc" id="L2499">        List&lt;UnitType&gt; undeads = game.getSpecification()</span>
<span class="nc" id="L2500">            .getUnitTypesWithAbility(Ability.UNDEAD);</span>
<span class="nc" id="L2501">        List&lt;UnitType&gt; navalUnits = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L2502">        List&lt;UnitType&gt; landUnits = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L2503" title="All 2 branches missed.">        for (UnitType undead : undeads) {</span>
<span class="nc bnc" id="L2504" title="All 2 branches missed.">            if (undead.hasAbility(Ability.NAVAL_UNIT)) {</span>
<span class="nc" id="L2505">                navalUnits.add(undead);</span>
<span class="nc bnc" id="L2506" title="All 2 branches missed.">            } else if (undead.hasAbility(Ability.MULTIPLE_ATTACKS)) {</span>
<span class="nc" id="L2507">                landUnits.add(undead);</span>
            }
        }
<span class="nc bnc" id="L2510" title="All 4 branches missed.">        if (navalUnits.isEmpty() || landUnits.isEmpty()) {</span>
<span class="nc" id="L2511">            return serverPlayer.clientError(&quot;Can not enter revenge mode,&quot;</span>
                + &quot; because we can not find the undead units.&quot;);
        }

<span class="nc" id="L2515">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L2516">        UnitType navalType = getRandomMember(logger, &quot;Choose undead navy&quot;,</span>
<span class="nc" id="L2517">                                             navalUnits, random);</span>
<span class="nc" id="L2518">        Tile start = ((Tile)serverPlayer.getEntryLocation())</span>
<span class="nc" id="L2519">            .getSafeTile(serverPlayer, random);</span>
<span class="nc" id="L2520">        Unit theFlyingDutchman</span>
<span class="nc" id="L2521">            = new ServerUnit(game, start, serverPlayer,</span>
<span class="nc" id="L2522">                             navalType);//-vis(serverPlayer)</span>
<span class="nc" id="L2523">        UnitType landType = getRandomMember(logger, &quot;Choose undead army&quot;,</span>
<span class="nc" id="L2524">                                            landUnits, random);</span>
<span class="nc" id="L2525">        new ServerUnit(game, theFlyingDutchman, serverPlayer, landType);//-vis</span>
<span class="nc" id="L2526">        serverPlayer.setDead(false);</span>
<span class="nc" id="L2527">        serverPlayer.changePlayerType(PlayerType.UNDEAD);</span>
<span class="nc" id="L2528">        serverPlayer.invalidateCanSeeTiles();//+vis(serverPlayer)</span>

        // No one likes the undead.
<span class="nc bnc" id="L2531" title="All 2 branches missed.">        for (Player p : game.getLivePlayers(serverPlayer)) {</span>
<span class="nc bnc" id="L2532" title="All 2 branches missed.">            if (serverPlayer.hasContacted(p)) {</span>
<span class="nc" id="L2533">                serverPlayer.csChangeStance(Stance.WAR, (ServerPlayer)p,</span>
<span class="nc" id="L2534">                                            true, cs);</span>
            }
        }

        // Revenge begins
<span class="nc" id="L2539">        game.setCurrentPlayer(serverPlayer);</span>
<span class="nc" id="L2540">        cs.addTrivial(See.all(), &quot;setCurrentPlayer&quot;,</span>
<span class="nc" id="L2541">                      ChangePriority.CHANGE_LATE,</span>
<span class="nc" id="L2542">                      &quot;player&quot;, serverPlayer.getId());</span>

        // Others can tell something has happened to the player,
        // and possibly see the units.
<span class="nc" id="L2546">        cs.add(See.all(), serverPlayer);</span>
<span class="nc" id="L2547">        cs.add(See.perhaps(), start);</span>
<span class="nc" id="L2548">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L2549">        return cs;</span>
    }


    /**
     * Equip a unit for a specific role.
     * Currently the unit is either in Europe or in a settlement.
     * Might one day allow the unit to be on a tile co-located with
     * an equipment-bearing wagon.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to equip.
     * @param role The &lt;code&gt;Role&lt;/code&gt; to equip for.
     * @param roleCount The role count.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet equipForRole(ServerPlayer serverPlayer, Unit unit,
                                  Role role, int roleCount) {
<span class="fc" id="L2567">        ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L2568">        boolean ret = false;</span>
<span class="pc bpc" id="L2569" title="1 of 2 branches missed.">        if (unit.isInEurope()) {</span>
<span class="nc" id="L2570">            ServerEurope serverEurope = (ServerEurope)serverPlayer.getEurope();</span>
<span class="nc" id="L2571">            ret = serverEurope.csEquipForRole(unit, role, roleCount,</span>
<span class="nc" id="L2572">                                              random, cs);</span>
<span class="pc bpc" id="L2573" title="1 of 2 branches missed.">        } else if (unit.getColony() != null) {</span>
<span class="nc" id="L2574">            ServerColony serverColony = (ServerColony)unit.getColony();</span>
<span class="nc" id="L2575">            ret = serverColony.csEquipForRole(unit, role, roleCount,</span>
<span class="nc" id="L2576">                                              random, cs);</span>
<span class="pc bpc" id="L2577" title="1 of 2 branches missed.">        } else if (unit.getIndianSettlement() != null) {</span>
<span class="fc" id="L2578">            ServerIndianSettlement sis = (ServerIndianSettlement)unit.getIndianSettlement();</span>
<span class="fc" id="L2579">            ret = sis.csEquipForRole(unit, role, roleCount, random, cs);</span>
<span class="fc" id="L2580">        } else {</span>
<span class="nc" id="L2581">            return serverPlayer.clientError(&quot;Unsuitable equip location for: &quot;</span>
<span class="nc" id="L2582">                + unit.getId());</span>
        }
<span class="pc bpc" id="L2584" title="1 of 2 branches missed.">        if (!ret) return null;</span>

<span class="pc bpc" id="L2586" title="1 of 2 branches missed.">        if (unit.getInitialMovesLeft() != unit.getMovesLeft()) {</span>
<span class="fc" id="L2587">            unit.setMovesLeft(0);</span>
        }
<span class="fc" id="L2589">        Unit carrier = unit.getCarrier();</span>
<span class="pc bpc" id="L2590" title="1 of 2 branches missed.">        if (carrier != null</span>
<span class="nc bnc" id="L2591" title="All 2 branches missed.">            &amp;&amp; carrier.getInitialMovesLeft() != carrier.getMovesLeft()</span>
<span class="nc bnc" id="L2592" title="All 2 branches missed.">            &amp;&amp; carrier.getMovesLeft() != 0) {</span>
<span class="nc" id="L2593">            carrier.setMovesLeft(0);</span>
        }
<span class="fc" id="L2595">        return cs;</span>
    }


    /**
     * Establish a new mission.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is establishing.
     * @param unit The missionary &lt;code&gt;Unit&lt;/code&gt;.
     * @param settlement The &lt;code&gt;ServerIndianSettlement&lt;/code&gt; to
     *     establish at.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet establishMission(ServerPlayer serverPlayer, Unit unit,
                                      ServerIndianSettlement settlement) {
<span class="fc" id="L2610">        ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L2611">        csVisit(serverPlayer, settlement, 0, cs);</span>

        // Result depends on tension wrt this settlement.
        // Establish if at least not angry.
<span class="fc" id="L2615">        final Tension tension = settlement.getAlarm(serverPlayer);</span>
<span class="pc bpc" id="L2616" title="1 of 3 branches missed.">        switch (tension.getLevel()) {</span>
        case HATEFUL: case ANGRY:
<span class="fc" id="L2618">            cs.add(See.perhaps().always(serverPlayer),</span>
<span class="fc" id="L2619">                   (FreeColGameObject)unit.getLocation());</span>
<span class="fc" id="L2620">            cs.addRemove(See.perhaps().always(serverPlayer),</span>
<span class="fc" id="L2621">                         unit.getLocation(), unit);//-vis(serverPlayer)</span>
<span class="fc" id="L2622">            unit.dispose();</span>
<span class="fc" id="L2623">            serverPlayer.invalidateCanSeeTiles();//+vis(serverPlayer)</span>
<span class="fc" id="L2624">            break;</span>

        case HAPPY: case CONTENT: case DISPLEASED:
<span class="pc bpc" id="L2627" title="1 of 2 branches missed.">            if (settlement.hasMissionary()) {</span>
<span class="nc" id="L2628">                settlement.csKillMissionary(false, cs);</span>
            }
            // Always show the tile the unit was on
<span class="fc" id="L2631">            cs.add(See.perhaps().always(serverPlayer), unit.getTile());</span>
            
<span class="fc" id="L2633">            settlement.csChangeMissionary(unit, cs);//+vis(serverPlayer)</span>
            break;
        }

        // Add the descriptive message.
<span class="fc" id="L2638">        final StringTemplate nation = settlement.getOwner().getNationLabel();</span>
<span class="fc" id="L2639">        cs.addMessage(See.only(serverPlayer),</span>
<span class="fc" id="L2640">            new ModelMessage(MessageType.FOREIGN_DIPLOMACY,</span>
<span class="fc" id="L2641">                             &quot;indianSettlement.mission.&quot; + tension.getKey(),</span>
<span class="fc" id="L2642">                             serverPlayer, unit)</span>
<span class="fc" id="L2643">                .addStringTemplate(&quot;%nation%&quot;, nation));</span>

        // Others can see missionary disappear and settlement acquire
        // mission.
<span class="fc" id="L2647">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="fc" id="L2648">        return cs;</span>
    }


    /**
     * Handle first contact between European players.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; making contact.
     * @param ourUnit Our &lt;code&gt;Unit&lt;/code&gt;.
     * @param otherUnit The other &lt;code&gt;unit&lt;/code&gt;.
     * @param agreement The &lt;code&gt;DiplomaticTrade&lt;/code&gt; to consider.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet europeanFirstContact(ServerPlayer serverPlayer,
                                          Unit ourUnit, Unit otherUnit,
                                          DiplomaticTrade agreement) {
<span class="nc" id="L2664">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L2665">        DiplomacySession session</span>
<span class="nc" id="L2666">            = TransactionSession.lookup(DiplomacySession.class, </span>
<span class="nc" id="L2667">                                        ourUnit, otherUnit);</span>
<span class="nc bnc" id="L2668" title="All 2 branches missed.">        if (session == null) {</span>
<span class="nc" id="L2669">            session = TransactionSession.lookup(DiplomacySession.class,</span>
<span class="nc" id="L2670">                                                otherUnit, ourUnit);</span>
        }
<span class="nc bnc" id="L2672" title="All 2 branches missed.">        if (session == null) {</span>
<span class="nc bnc" id="L2673" title="All 2 branches missed.">            if (agreement.getStatus() != TradeStatus.PROPOSE_TRADE) {</span>
<span class="nc" id="L2674">                return serverPlayer.clientError(&quot;Missing uu1-diplomacy session for &quot;</span>
<span class="nc" id="L2675">                    + ourUnit.getId() + &quot;,&quot; + otherUnit.getId()</span>
<span class="nc" id="L2676">                    + &quot; with &quot; + agreement);</span>
            }
<span class="nc" id="L2678">            session = new DiplomacySession(ourUnit, otherUnit);</span>
<span class="nc" id="L2679">            ourUnit.setMovesLeft(0);</span>
<span class="nc" id="L2680">            cs.addPartial(See.only(serverPlayer), ourUnit, &quot;movesLeft&quot;);</span>
        }
<span class="nc" id="L2682">        ServerPlayer otherPlayer = (ServerPlayer)otherUnit.getOwner();</span>
<span class="nc" id="L2683">        if (csDiplomacySession(serverPlayer, otherPlayer,</span>
<span class="nc" id="L2684">                agreement, session,</span>
<span class="nc bnc" id="L2685" title="All 2 branches missed.">                new DiplomacyMessage(otherUnit, ourUnit, agreement), cs)) {</span>
<span class="nc" id="L2686">            cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
<span class="nc" id="L2687">                new DiplomacyMessage(ourUnit, otherUnit, </span>
<span class="nc" id="L2688">                                     session.getAgreement()));</span>
        }
<span class="nc" id="L2690">        return cs;</span>
    }

    /**
     * Handle first contact between European players.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; making contact.
     * @param ourUnit Our &lt;code&gt;Unit&lt;/code&gt;.
     * @param otherColony The other &lt;code&gt;Colony&lt;/code&gt;.
     * @param agreement The &lt;code&gt;DiplomaticTrade&lt;/code&gt; to consider.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet europeanFirstContact(ServerPlayer serverPlayer,
                                          Unit ourUnit, Colony otherColony,
                                          DiplomaticTrade agreement) {
<span class="nc" id="L2705">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L2706">        DiplomacySession session</span>
<span class="nc" id="L2707">            = TransactionSession.lookup(DiplomacySession.class,</span>
<span class="nc" id="L2708">                                        ourUnit, otherColony);</span>
<span class="nc bnc" id="L2709" title="All 2 branches missed.">        if (session == null) {</span>
<span class="nc bnc" id="L2710" title="All 2 branches missed.">            if (agreement.getStatus() != TradeStatus.PROPOSE_TRADE) {</span>
<span class="nc" id="L2711">                return serverPlayer.clientError(&quot;Missing uc1-diplomacy session for &quot;</span>
<span class="nc" id="L2712">                    + ourUnit.getId() + &quot;,&quot; + otherColony.getId()</span>
<span class="nc" id="L2713">                    + &quot; with &quot; + agreement);</span>
            }
<span class="nc" id="L2715">            session = new DiplomacySession(ourUnit, otherColony);</span>
<span class="nc" id="L2716">            ourUnit.setMovesLeft(0);</span>
<span class="nc" id="L2717">            cs.addPartial(See.only(serverPlayer), ourUnit, &quot;movesLeft&quot;);</span>
        }
<span class="nc" id="L2719">        ServerPlayer otherPlayer = (ServerPlayer)otherColony.getOwner();</span>
<span class="nc" id="L2720">        if (csDiplomacySession(serverPlayer, otherPlayer,</span>
<span class="nc" id="L2721">                agreement, session,</span>
<span class="nc bnc" id="L2722" title="All 2 branches missed.">                new DiplomacyMessage(otherColony, ourUnit, agreement), cs)) {</span>
<span class="nc" id="L2723">            cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
<span class="nc" id="L2724">                new DiplomacyMessage(ourUnit, otherColony, </span>
<span class="nc" id="L2725">                                     session.getAgreement()));</span>
        }
<span class="nc" id="L2727">        return cs;</span>
    }

    /**
     * Handle first contact between European players.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; making contact.
     * @param ourColony Our &lt;code&gt;Colony&lt;/code&gt;.
     * @param otherUnit The other &lt;code&gt;Unit&lt;/code&gt;.
     * @param agreement The &lt;code&gt;DiplomaticTrade&lt;/code&gt; to consider.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet europeanFirstContact(ServerPlayer serverPlayer,
                                          Colony ourColony, Unit otherUnit,
                                          DiplomaticTrade agreement) {
<span class="nc" id="L2742">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L2743">        DiplomacySession session</span>
<span class="nc" id="L2744">            = TransactionSession.lookup(DiplomacySession.class,</span>
<span class="nc" id="L2745">                                        otherUnit, ourColony);</span>
<span class="nc bnc" id="L2746" title="All 2 branches missed.">        if (session == null) {</span>
<span class="nc" id="L2747">            return serverPlayer.clientError(&quot;Missing cu1-diplomacy session for &quot;</span>
<span class="nc" id="L2748">                + ourColony.getId() + &quot;,&quot; + otherUnit.getId()</span>
<span class="nc" id="L2749">                + &quot; with &quot; + agreement);</span>
        }
<span class="nc" id="L2751">        ServerPlayer otherPlayer = (ServerPlayer)otherUnit.getOwner();</span>
<span class="nc" id="L2752">        if (csDiplomacySession(serverPlayer, otherPlayer,</span>
<span class="nc" id="L2753">                agreement, session,</span>
<span class="nc bnc" id="L2754" title="All 2 branches missed.">                new DiplomacyMessage(otherUnit, ourColony, agreement), cs)) {</span>
<span class="nc" id="L2755">            cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
<span class="nc" id="L2756">                new DiplomacyMessage(ourColony, otherUnit,</span>
<span class="nc" id="L2757">                                     session.getAgreement()));</span>
        }
<span class="nc" id="L2759">        return cs;</span>
    }


    /**
     * Get the goods for sale in a settlement.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is enquiring.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is trading.
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; that is trading.
     * @return A &lt;code&gt;GoodsForSaleMessage&lt;/code&gt; encapsulating this action,
     *     or an error message on failure.
     */
    public DOMMessage getGoodsForSale(ServerPlayer serverPlayer,
        Unit unit, Settlement settlement) {
<span class="nc" id="L2774">        List&lt;Goods&gt; sellGoods = null;</span>

<span class="nc bnc" id="L2776" title="All 2 branches missed.">        if (settlement instanceof IndianSettlement) {</span>
<span class="nc" id="L2777">            IndianSettlement indianSettlement = (IndianSettlement) settlement;</span>
<span class="nc" id="L2778">            AIPlayer aiPlayer = getFreeColServer()</span>
<span class="nc" id="L2779">                .getAIPlayer(indianSettlement.getOwner());</span>
<span class="nc" id="L2780">            sellGoods = indianSettlement.getSellGoods(3, unit);</span>
<span class="nc bnc" id="L2781" title="All 2 branches missed.">            for (Goods goods : sellGoods) {</span>
<span class="nc" id="L2782">                aiPlayer.registerSellGoods(goods);</span>
            }
<span class="nc" id="L2784">        } else { // Colony might be supported one day?</span>
<span class="nc" id="L2785">            return new ErrorMessage(&quot;Bogus settlement&quot;);</span>
        }
<span class="nc" id="L2787">        return new GoodsForSaleMessage(unit, settlement, sellGoods);</span>
    }


    /**
     * Gets the list of high scores.
     *
     * @return A list of &lt;code&gt;HighScore&lt;/code&gt;.
     */
    public List&lt;HighScore&gt; getHighScores() {
<span class="nc" id="L2797">        return HighScore.loadHighScores();</span>
    }


    /**
     * Gets a settlement transaction session, either existing or
     * newly opened.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is trading.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is trading.
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; that is trading.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet getTransaction(ServerPlayer serverPlayer, Unit unit,
                                    Settlement settlement) {
<span class="nc" id="L2812">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L2813">        TradeSession session = TransactionSession.lookup(TradeSession.class,</span>
<span class="nc" id="L2814">            unit, settlement);</span>
<span class="nc bnc" id="L2815" title="All 2 branches missed.">        if (session == null) {</span>
<span class="nc bnc" id="L2816" title="All 2 branches missed.">            if (unit.getMovesLeft() &lt;= 0) {</span>
<span class="nc" id="L2817">                return serverPlayer.clientError(&quot;Unit &quot; + unit.getId()</span>
<span class="nc" id="L2818">                    + &quot; has no moves left.&quot;);</span>
            }
<span class="nc" id="L2820">            session = new TradeSession(unit, settlement);</span>
            // Sets unit moves to zero to avoid cheating.  If no
            // action is taken, the moves will be restored when
            // closing the session
<span class="nc" id="L2824">            unit.setMovesLeft(0);</span>
<span class="nc" id="L2825">            cs.addPartial(See.only(serverPlayer), unit, &quot;movesLeft&quot;);</span>
        }

        // Add just the attributes the client needs.
<span class="nc" id="L2829">        cs.addAttribute(See.only(serverPlayer), &quot;canBuy&quot;,</span>
<span class="nc" id="L2830">            Boolean.toString(session.getBuy()));</span>
<span class="nc" id="L2831">        cs.addAttribute(See.only(serverPlayer), &quot;canSell&quot;,</span>
<span class="nc" id="L2832">            Boolean.toString(session.getSell()));</span>
<span class="nc" id="L2833">        cs.addAttribute(See.only(serverPlayer), &quot;canGift&quot;,</span>
<span class="nc" id="L2834">            Boolean.toString(session.getGift()));</span>

        // Others can not see transactions.
<span class="nc" id="L2837">        return cs;</span>
    }


    /**
     * Incite a settlement against an enemy.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is inciting.
     * @param unit The missionary &lt;code&gt;Unit&lt;/code&gt; inciting.
     * @param settlement The &lt;code&gt;IndianSettlement&lt;/code&gt; to incite.
     * @param enemy The &lt;code&gt;ServerPlayer&lt;/code&gt; to be incited against.
     * @param gold The amount of gold in the bribe.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet incite(ServerPlayer serverPlayer, Unit unit,
                            IndianSettlement settlement,
                            ServerPlayer enemy, int gold) {
<span class="nc" id="L2854">        ChangeSet cs = new ChangeSet();</span>

<span class="nc" id="L2856">        Tile tile = settlement.getTile();</span>
<span class="nc" id="L2857">        csVisit(serverPlayer, settlement, 0, cs);</span>
<span class="nc" id="L2858">        tile.updateIndianSettlement(serverPlayer);</span>
<span class="nc" id="L2859">        cs.add(See.only(serverPlayer), tile);</span>

        // How much gold will be needed?
<span class="nc" id="L2862">        ServerPlayer enemyPlayer = enemy;</span>
<span class="nc" id="L2863">        ServerPlayer nativePlayer = (ServerPlayer)settlement.getOwner();</span>
<span class="nc" id="L2864">        int payingValue = nativePlayer.getTension(serverPlayer).getValue();</span>
<span class="nc" id="L2865">        int targetValue = nativePlayer.getTension(enemyPlayer).getValue();</span>
<span class="nc bnc" id="L2866" title="All 2 branches missed.">        int goldToPay = (payingValue &gt; targetValue) ? 10000 : 5000;</span>
<span class="nc" id="L2867">        goldToPay += 20 * (payingValue - targetValue);</span>
<span class="nc" id="L2868">        goldToPay = Math.max(goldToPay, 650);</span>

        // Try to incite?
<span class="nc bnc" id="L2871" title="All 2 branches missed.">        if (gold &lt; 0) { // Initial inquiry</span>
<span class="nc" id="L2872">            cs.add(See.only(serverPlayer), ChangePriority.CHANGE_NORMAL,</span>
<span class="nc" id="L2873">                new InciteMessage(unit, settlement, enemy, goldToPay));</span>
<span class="nc bnc" id="L2874" title="All 4 branches missed.">        } else if (gold &lt; goldToPay || !serverPlayer.checkGold(gold)) {</span>
<span class="nc" id="L2875">            cs.addMessage(See.only(serverPlayer),</span>
<span class="nc" id="L2876">                new ModelMessage(MessageType.FOREIGN_DIPLOMACY,</span>
<span class="nc" id="L2877">                                 &quot;missionarySettlement.inciteGoldFail&quot;,</span>
<span class="nc" id="L2878">                                 serverPlayer, settlement)</span>
<span class="nc" id="L2879">                    .addStringTemplate(&quot;%player%&quot;,</span>
<span class="nc" id="L2880">                        enemyPlayer.getNationLabel())</span>
<span class="nc" id="L2881">                    .addAmount(&quot;%amount%&quot;, goldToPay));</span>
<span class="nc" id="L2882">            cs.addAttribute(See.only(serverPlayer), &quot;gold&quot;, &quot;0&quot;);</span>
<span class="nc" id="L2883">            unit.setMovesLeft(0);</span>
<span class="nc" id="L2884">            cs.addPartial(See.only(serverPlayer), unit, &quot;movesLeft&quot;);</span>
<span class="nc" id="L2885">        } else {</span>
            // Success.  Raise the tension for the native player with respect
            // to the European player.  Let resulting stance changes happen
            // naturally in the AI player turn/s.
<span class="nc" id="L2889">            nativePlayer.csModifyTension(enemyPlayer,</span>
<span class="nc" id="L2890">                Tension.WAR_MODIFIER, cs);//+til</span>
<span class="nc" id="L2891">            enemyPlayer.csModifyTension(serverPlayer,</span>
<span class="nc" id="L2892">                Tension.TENSION_ADD_WAR_INCITER, cs);//+til</span>
<span class="nc" id="L2893">            cs.addAttribute(See.only(serverPlayer),</span>
<span class="nc" id="L2894">                            &quot;gold&quot;, Integer.toString(gold));</span>
<span class="nc" id="L2895">            serverPlayer.modifyGold(-gold);</span>
<span class="nc" id="L2896">            nativePlayer.modifyGold(gold);</span>
<span class="nc" id="L2897">            cs.addMessage(See.only(serverPlayer),</span>
<span class="nc" id="L2898">                new ModelMessage(MessageType.FOREIGN_DIPLOMACY,</span>
<span class="nc" id="L2899">                                 &quot;missionarySettlement.inciteSuccess&quot;,</span>
<span class="nc" id="L2900">                                 nativePlayer)</span>
<span class="nc" id="L2901">                .addStringTemplate(&quot;%native%&quot;, nativePlayer.getNationLabel())</span>
<span class="nc" id="L2902">                    .addStringTemplate(&quot;%enemy%&quot;, enemy.getNationLabel()));</span>
<span class="nc" id="L2903">            cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;);</span>
<span class="nc" id="L2904">            unit.setMovesLeft(0);</span>
<span class="nc" id="L2905">            cs.addPartial(See.only(serverPlayer), unit, &quot;movesLeft&quot;);</span>
        }

        // Others might include enemy.
<span class="nc" id="L2909">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L2910">        return cs;</span>
    }


    /**
     * Indians making demands of a colony.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is demanding.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; making the demands.
     * @param colony The &lt;code&gt;Colony&lt;/code&gt; that is demanded of.
     * @param type The &lt;code&gt;GoodsType&lt;/code&gt; being demanded, null
     *     implies gold.
     * @param amount The amount of goods/gold being demanded.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet indianDemand(final ServerPlayer serverPlayer, Unit unit,
                                  Colony colony, GoodsType type, int amount) {
<span class="nc" id="L2927">        final Game game = getGame();</span>
<span class="nc" id="L2928">        final Specification spec = game.getSpecification();</span>
<span class="nc" id="L2929">        ServerPlayer victim = (ServerPlayer) colony.getOwner();</span>
<span class="nc" id="L2930">        int difficulty = spec.getInteger(GameOptions.NATIVE_DEMANDS);</span>
<span class="nc" id="L2931">        ChangeSet cs = new ChangeSet();</span>

<span class="nc" id="L2933">        DOMMessage reply = askTimeout(victim,</span>
<span class="nc" id="L2934">            new IndianDemandMessage(unit, colony, type, amount));</span>
<span class="nc bnc" id="L2935" title="All 2 branches missed.">        boolean result = (reply instanceof IndianDemandMessage)</span>
<span class="nc" id="L2936">            ? ((IndianDemandMessage)reply).getResult()</span>
<span class="nc" id="L2937">            : false;</span>
<span class="nc" id="L2938">        logger.info(serverPlayer.getName() + &quot; unit &quot; + unit</span>
<span class="nc bnc" id="L2939" title="All 2 branches missed.">            + &quot; demands &quot; + amount + &quot; &quot; + ((type == null) ? &quot;gold&quot; : type)</span>
<span class="nc" id="L2940">            + &quot; from &quot; + colony.getName() + &quot; accepted: &quot; + result);</span>

<span class="nc" id="L2942">        IndianDemandMessage message = new IndianDemandMessage(unit, colony,</span>
<span class="nc" id="L2943">                                                              type, amount);</span>
<span class="nc" id="L2944">        message.setResult(result);</span>
<span class="nc" id="L2945">        cs.add(See.only(serverPlayer), ChangePriority.CHANGE_NORMAL, message);</span>
<span class="nc bnc" id="L2946" title="All 2 branches missed.">        if (result) {</span>
<span class="nc bnc" id="L2947" title="All 2 branches missed.">            if (type == null) {</span>
<span class="nc" id="L2948">                victim.modifyGold(-amount);</span>
<span class="nc" id="L2949">                serverPlayer.modifyGold(amount);</span>
<span class="nc" id="L2950">                cs.addPartial(See.only(victim), victim, &quot;gold&quot;);</span>
                //cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;);
<span class="nc" id="L2952">            } else {</span>
<span class="nc" id="L2953">                GoodsContainer colonyContainer = colony.getGoodsContainer();</span>
<span class="nc" id="L2954">                colonyContainer.saveState();</span>
<span class="nc" id="L2955">                GoodsContainer unitContainer = unit.getGoodsContainer();</span>
<span class="nc" id="L2956">                unitContainer.saveState();</span>
<span class="nc" id="L2957">                moveGoods(colony, type, amount, unit);</span>
<span class="nc" id="L2958">                cs.add(See.only(victim), colonyContainer);</span>
                //cs.add(See.only(serverPlayer), unitContainer);
            }
<span class="nc" id="L2961">            int tension = -(5 - difficulty) * 50;</span>
<span class="nc" id="L2962">            ServerIndianSettlement is = (ServerIndianSettlement)</span>
<span class="nc" id="L2963">                unit.getHomeIndianSettlement();</span>
<span class="nc bnc" id="L2964" title="All 2 branches missed.">            if (is == null) {</span>
<span class="nc" id="L2965">                serverPlayer.csModifyTension(victim, tension, cs);</span>
<span class="nc" id="L2966">            } else {</span>
<span class="nc" id="L2967">                is.csModifyAlarm(victim, tension, true, cs);</span>
            }
        }

<span class="nc" id="L2971">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L2972">        return cs;</span>
    }


    /**
     * Join a colony.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is joining.
     * @param colony The &lt;code&gt;Colony&lt;/code&gt; to join.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet joinColony(ServerPlayer serverPlayer, Unit unit,
                                Colony colony) {
<span class="nc" id="L2986">        final Specification spec = getGame().getSpecification();</span>
<span class="nc" id="L2987">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L2988">        Set&lt;Tile&gt; ownedTiles = colony.getOwnedTiles();</span>
<span class="nc" id="L2989">        Tile tile = colony.getTile();</span>

        // Join.
<span class="nc" id="L2992">        tile.cacheUnseen();//+til</span>
<span class="nc" id="L2993">        unit.setLocation(colony);//-vis: safe/colony,-til</span>
<span class="nc" id="L2994">        unit.setMovesLeft(0);</span>
<span class="nc" id="L2995">        colony.equipForRole(unit, spec.getDefaultRole(), 0);</span>

        // Update with colony tile, and tiles now owned.
<span class="nc" id="L2998">        cs.add(See.only(serverPlayer), tile);</span>
<span class="nc bnc" id="L2999" title="All 2 branches missed.">        for (Tile t : tile.getSurroundingTiles(colony.getRadius())) {</span>
<span class="nc bnc" id="L3000" title="All 4 branches missed.">            if (t.getOwningSettlement() == colony &amp;&amp; !ownedTiles.contains(t)) {</span>
<span class="nc" id="L3001">                cs.add(See.perhaps(), t);</span>
            }
        }

        // Others might see a tile ownership change.
<span class="nc" id="L3006">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L3007">        return cs;</span>
    }


    /**
     * Learn a skill at an IndianSettlement.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is learning.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is learning.
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; to learn from.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet learnFromIndianSettlement(ServerPlayer serverPlayer,
                                               Unit unit,
                                               IndianSettlement settlement) {
        // Sanity checks.
<span class="nc" id="L3023">        UnitType skill = settlement.getLearnableSkill();</span>
<span class="nc bnc" id="L3024" title="All 2 branches missed.">        if (skill == null) {</span>
<span class="nc" id="L3025">            return serverPlayer.clientError(&quot;No skill to learn at &quot;</span>
<span class="nc" id="L3026">                + settlement.getName());</span>
        }
<span class="nc bnc" id="L3028" title="All 2 branches missed.">        if (!unit.getType().canBeUpgraded(skill, ChangeType.NATIVES)) {</span>
<span class="nc" id="L3029">            return serverPlayer.clientError(&quot;Unit &quot; + unit</span>
<span class="nc" id="L3030">                + &quot; can not learn skill &quot; + skill</span>
<span class="nc" id="L3031">                + &quot; at &quot; + settlement.getName());</span>
        }

        // Try to learn
<span class="nc" id="L3035">        final Specification spec = getGame().getSpecification();</span>
<span class="nc" id="L3036">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L3037">        unit.setMovesLeft(0);</span>
<span class="nc" id="L3038">        csVisit(serverPlayer, settlement, 0, cs);</span>
<span class="nc bnc" id="L3039" title="All 3 branches missed.">        switch (settlement.getAlarm(serverPlayer).getLevel()) {</span>
        case HATEFUL: // Killed, might be visible to other players.
<span class="nc" id="L3041">            cs.add(See.perhaps().always(serverPlayer),</span>
<span class="nc" id="L3042">                   (FreeColGameObject)unit.getLocation());</span>
<span class="nc" id="L3043">            cs.addRemove(See.perhaps().always(serverPlayer),</span>
<span class="nc" id="L3044">                         unit.getLocation(), unit);//-vis(serverPlayer)</span>
<span class="nc" id="L3045">            unit.dispose();</span>
<span class="nc" id="L3046">            serverPlayer.invalidateCanSeeTiles();//+vis(serverPlayer)</span>
<span class="nc" id="L3047">            break;</span>
        case ANGRY: // Learn nothing, not even a pet update
<span class="nc" id="L3049">            cs.addPartial(See.only(serverPlayer), unit, &quot;movesLeft&quot;);</span>
<span class="nc" id="L3050">            break;</span>
        default:
            // Teach the unit, and expend the skill if necessary.
            // Do a full information update as the unit is in the settlement.
<span class="nc" id="L3054">            unit.changeType(skill);//-vis(serverPlayer)</span>
<span class="nc" id="L3055">            serverPlayer.invalidateCanSeeTiles();//+vis(serverPlayer)</span>
<span class="nc" id="L3056">            cs.add(See.perhaps(), unit);</span>
<span class="nc bnc" id="L3057" title="All 2 branches missed.">            if (!settlement.isCapital()</span>
<span class="nc bnc" id="L3058" title="All 2 branches missed.">                &amp;&amp; !(settlement.hasMissionary(serverPlayer)</span>
<span class="nc bnc" id="L3059" title="All 2 branches missed.">                    &amp;&amp; spec.getBoolean(GameOptions.ENHANCED_MISSIONARIES))) {</span>
<span class="nc" id="L3060">                settlement.setLearnableSkill(null);</span>
            }
            break;
        }
<span class="nc" id="L3064">        Tile tile = settlement.getTile();</span>
<span class="nc" id="L3065">        tile.updateIndianSettlement(serverPlayer);</span>
<span class="nc" id="L3066">        cs.add(See.only(serverPlayer), tile);</span>

        // Others always see the unit, it may have died or been taught.
<span class="nc" id="L3069">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L3070">        return cs;</span>
    }


    /**
     * Load goods.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is loading.
     * @param loc The &lt;code&gt;Location&lt;/code&gt; where the goods are.
     * @param goodsType The &lt;code&gt;GoodsType&lt;/code&gt; to load.
     * @param amount The amount of goods to load.
     * @param carrier The &lt;code&gt;Unit&lt;/code&gt; to load.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet loadGoods(ServerPlayer serverPlayer, Location loc,
                               GoodsType goodsType, int amount, Unit carrier) {
<span class="fc bfc" id="L3086" title="All 2 branches covered.">        if (loc instanceof Europe) {</span>
<span class="fc bfc" id="L3087" title="All 2 branches covered.">            if (carrier.isInEurope()) {</span>
<span class="fc" id="L3088">                return buyGoods(serverPlayer, goodsType, amount, carrier);</span>
            } else {
<span class="fc" id="L3090">                return serverPlayer.clientError(&quot;Carrier not in Europe: &quot; + loc);</span>
            }
        }
        // All loading locations other than Europe are GoodsLocations
<span class="pc bpc" id="L3094" title="1 of 2 branches missed.">        if (!(loc instanceof GoodsLocation)) {</span>
<span class="nc" id="L3095">            return serverPlayer.clientError(&quot;Not a goods location: &quot; + loc);</span>
        }
<span class="fc" id="L3097">        GoodsLocation gl = (GoodsLocation)loc;</span>
<span class="fc bfc" id="L3098" title="All 2 branches covered.">        if (!carrier.isAtLocation(loc)) {</span>
<span class="fc" id="L3099">            return serverPlayer.clientError(&quot;Carrier not at location: &quot; + loc);</span>
        }
<span class="fc bfc" id="L3101" title="All 2 branches covered.">        if (carrier.getLoadableAmount(goodsType) &lt; amount) {</span>
<span class="fc" id="L3102">            return serverPlayer.clientError(&quot;Too much goods&quot;);</span>
        }
<span class="pc bpc" id="L3104" title="1 of 2 branches missed.">        if (gl.getGoodsCount(goodsType) &lt; amount) {</span>
<span class="nc" id="L3105">            return serverPlayer.clientError(&quot;Not enough goods (&quot;</span>
<span class="nc" id="L3106">                + gl.getGoodsCount(goodsType) + &quot; &lt; &quot; + amount</span>
<span class="nc" id="L3107">                + &quot; &quot; + goodsType.getSuffix() + &quot;) at &quot; + gl);</span>
        }

<span class="fc" id="L3110">        ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L3111">        moveGoods(gl, goodsType, amount, carrier);</span>
<span class="fc" id="L3112">        logger.finest(Messages.message(loc.getLocationLabel())</span>
<span class="fc" id="L3113">            + &quot; loaded &quot; + amount + &quot; &quot; + goodsType.getSuffix()</span>
<span class="fc" id="L3114">            + &quot; onto &quot; + carrier);</span>
<span class="fc" id="L3115">        cs.add(See.only(serverPlayer), gl.getGoodsContainer());</span>
<span class="fc" id="L3116">        cs.add(See.only(serverPlayer), carrier.getGoodsContainer());</span>
<span class="pc bpc" id="L3117" title="1 of 2 branches missed.">        if (carrier.getInitialMovesLeft() != carrier.getMovesLeft()) {</span>
<span class="nc" id="L3118">            carrier.setMovesLeft(0);</span>
<span class="nc" id="L3119">            cs.addPartial(See.only(serverPlayer), carrier, &quot;movesLeft&quot;);</span>
        }

        // Invisible in settlement
<span class="fc" id="L3123">        return cs;</span>
    }


    /**
     * Loot cargo.
     *
     * Note loser is passed by identifier, as by the time we get here
     * the unit may have been sunk.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the winner.
     * @param winner The &lt;code&gt;Unit&lt;/code&gt; that looting.
     * @param loserId The object identifier of the &lt;code&gt;Unit&lt;/code&gt;
     *     that is looted.
     * @param loot The &lt;code&gt;Goods&lt;/code&gt; to loot.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet lootCargo(ServerPlayer serverPlayer, Unit winner,
                               String loserId, List&lt;Goods&gt; loot) {
<span class="nc" id="L3142">        LootSession session = TransactionSession.lookup(LootSession.class,</span>
<span class="nc" id="L3143">            winner.getId(), loserId);</span>
<span class="nc bnc" id="L3144" title="All 2 branches missed.">        if (session == null) {</span>
<span class="nc" id="L3145">            return serverPlayer.clientError(&quot;Bogus looting!&quot;);</span>
        }
<span class="nc bnc" id="L3147" title="All 2 branches missed.">        if (!winner.hasSpaceLeft()) {</span>
<span class="nc" id="L3148">            return serverPlayer.clientError(&quot;No space to loot to: &quot;</span>
<span class="nc" id="L3149">                + winner.getId());</span>
        }

<span class="nc" id="L3152">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L3153">        List&lt;Goods&gt; available = session.getCapture();</span>
<span class="nc bnc" id="L3154" title="All 2 branches missed.">        if (loot == null) { // Initial inquiry</span>
<span class="nc" id="L3155">            cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
<span class="nc" id="L3156">                   new LootCargoMessage(winner, loserId, available));</span>
<span class="nc" id="L3157">        } else {</span>
<span class="nc bnc" id="L3158" title="All 2 branches missed.">            for (Goods g : loot) {</span>
<span class="nc bnc" id="L3159" title="All 2 branches missed.">                if (!available.contains(g)) {</span>
<span class="nc" id="L3160">                    return serverPlayer.clientError(&quot;Invalid loot: &quot; + g);</span>
                }
<span class="nc" id="L3162">                available.remove(g);</span>
<span class="nc bnc" id="L3163" title="All 2 branches missed.">                if (!winner.canAdd(g)) {</span>
<span class="nc" id="L3164">                    return serverPlayer.clientError(&quot;Loot failed: &quot; + g);</span>
                }
<span class="nc" id="L3166">                winner.add(g);</span>
            }

            // Others can see cargo capacity change.
<span class="nc" id="L3170">            session.complete(cs);</span>
<span class="nc" id="L3171">            cs.add(See.perhaps(), winner);</span>
<span class="nc" id="L3172">            getGame().sendToOthers(serverPlayer, cs);</span>
        }
<span class="nc" id="L3174">        return cs;</span>
    }


    /**
     * Respond to a monarch action.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is to respond.
     * @param action The &lt;code&gt;MonarchAction&lt;/code&gt; to respond to.
     * @param result The player response.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; containing the response.
     */
    public ChangeSet monarchAction(ServerPlayer serverPlayer,
                                   MonarchAction action, boolean result) {
<span class="nc" id="L3188">        MonarchSession session = TransactionSession.lookup(MonarchSession.class,</span>
<span class="nc" id="L3189">            serverPlayer.getId(), &quot;&quot;);</span>
<span class="nc bnc" id="L3190" title="All 2 branches missed.">        if (session == null) {</span>
<span class="nc" id="L3191">            return serverPlayer.clientError(&quot;Bogus monarch action: &quot; + action);</span>
<span class="nc bnc" id="L3192" title="All 2 branches missed.">        } else if (action != session.getAction()) {</span>
<span class="nc" id="L3193">            return serverPlayer.clientError(&quot;Session action mismatch, &quot;</span>
<span class="nc" id="L3194">                + session.getAction() + &quot; expected: &quot; + action);</span>
        }

<span class="nc" id="L3197">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L3198">        session.complete(result, cs);</span>
<span class="nc" id="L3199">        return cs;</span>
    }


    /**
     * Move a unit.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is moving.
     * @param unit The &lt;code&gt;ServerUnit&lt;/code&gt; to move.
     * @param newTile The &lt;code&gt;Tile&lt;/code&gt; to move to.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet move(ServerPlayer serverPlayer, ServerUnit unit,
                          Tile newTile) {
<span class="fc" id="L3213">        ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L3214">        unit.csMove(newTile, random, cs);</span>
<span class="fc" id="L3215">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="fc" id="L3216">        return cs;</span>
    }


    /**
     * Move a unit across the high seas.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to move.
     * @param destination The &lt;code&gt;Location&lt;/code&gt; to move to.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet moveTo(ServerPlayer serverPlayer, Unit unit,
                            Location destination) {
<span class="fc" id="L3230">        ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L3231">        HighSeas highSeas = serverPlayer.getHighSeas();</span>
<span class="fc" id="L3232">        Location current = unit.getDestination();</span>
<span class="fc" id="L3233">        boolean others = false; // Notify others?</span>
<span class="fc" id="L3234">        boolean invalid = false; // Not a highSeas move?</span>

<span class="pc bpc" id="L3236" title="1 of 2 branches missed.">        if (!unit.getType().canMoveToHighSeas()) {</span>
<span class="nc" id="L3237">            invalid = true;</span>
<span class="pc bfc" id="L3238" title="All 2 branches covered.">        } else if (destination instanceof Europe) {</span>
<span class="pc bpc" id="L3239" title="1 of 2 branches missed.">            if (!highSeas.getDestinations().contains(destination)) {</span>
<span class="nc" id="L3240">                return serverPlayer.clientError(&quot;HighSeas does not connect to: &quot;</span>
<span class="nc" id="L3241">                    + destination.getId());</span>
<span class="pc bpc" id="L3242" title="1 of 2 branches missed.">            } else if (unit.getLocation() == highSeas) {</span>
<span class="nc bnc" id="L3243" title="All 2 branches missed.">                if (!(current instanceof Europe)) {</span>
                    // Changed direction
<span class="nc" id="L3245">                    unit.setWorkLeft(unit.getSailTurns()</span>
<span class="nc" id="L3246">                        - unit.getWorkLeft() + 1);</span>
                }
<span class="nc" id="L3248">                unit.setDestination(destination);</span>
<span class="nc" id="L3249">                cs.add(See.only(serverPlayer), unit, highSeas);</span>
<span class="pc bpc" id="L3250" title="1 of 2 branches missed.">            } else if (unit.hasTile()) {</span>
<span class="fc" id="L3251">                Tile tile = unit.getTile();</span>
<span class="fc" id="L3252">                unit.setEntryLocation(tile);</span>
<span class="fc" id="L3253">                unit.setWorkLeft(unit.getSailTurns());</span>
<span class="fc" id="L3254">                unit.setDestination(destination);</span>
<span class="fc" id="L3255">                unit.setMovesLeft(0);</span>
<span class="fc" id="L3256">                unit.setLocation(highSeas);//-vis(serverPlayer)</span>
<span class="fc" id="L3257">                serverPlayer.invalidateCanSeeTiles();//+vis(serverPlayer)</span>
<span class="fc" id="L3258">                cs.addDisappear(serverPlayer, tile, unit);</span>
<span class="fc" id="L3259">                cs.add(See.only(serverPlayer), tile, highSeas);</span>
<span class="fc" id="L3260">                others = true;</span>
<span class="fc" id="L3261">            } else {</span>
<span class="nc" id="L3262">                invalid = true;</span>
            }
<span class="pc bpc" id="L3264" title="1 of 2 branches missed.">        } else if (destination instanceof Map) {</span>
<span class="pc bpc" id="L3265" title="1 of 2 branches missed.">            if (!highSeas.getDestinations().contains(destination)) {</span>
<span class="nc" id="L3266">                return serverPlayer.clientError(&quot;HighSeas does not connect to: &quot;</span>
<span class="nc" id="L3267">                    + destination.getId());</span>
<span class="pc bpc" id="L3268" title="1 of 2 branches missed.">            } else if (unit.getLocation() == highSeas) {</span>
<span class="nc bnc" id="L3269" title="All 4 branches missed.">                if (current != destination &amp;&amp; (current == null</span>
<span class="nc bnc" id="L3270" title="All 2 branches missed.">                        || current.getTile() == null</span>
<span class="nc bnc" id="L3271" title="All 2 branches missed.">                        || current.getTile().getMap() != destination)) {</span>
                    // Changed direction
<span class="nc" id="L3273">                    unit.setWorkLeft(unit.getSailTurns()</span>
<span class="nc" id="L3274">                        - unit.getWorkLeft() + 1);</span>
                }
<span class="nc" id="L3276">                unit.setDestination(destination);</span>
<span class="nc" id="L3277">                cs.add(See.only(serverPlayer), highSeas);</span>
<span class="pc bpc" id="L3278" title="1 of 2 branches missed.">            } else if (unit.getLocation() instanceof Europe) {</span>
<span class="fc" id="L3279">                Europe europe = (Europe) unit.getLocation();</span>
<span class="fc" id="L3280">                unit.setWorkLeft(unit.getSailTurns());</span>
<span class="fc" id="L3281">                unit.setDestination(destination);</span>
<span class="fc" id="L3282">                unit.setMovesLeft(0);</span>
<span class="fc" id="L3283">                unit.setLocation(highSeas);//-vis: safe!map</span>
<span class="fc" id="L3284">                cs.add(See.only(serverPlayer), europe, highSeas);</span>
<span class="fc" id="L3285">            } else {</span>
<span class="nc" id="L3286">                invalid = true;</span>
            }
<span class="nc bnc" id="L3288" title="All 2 branches missed.">        } else if (destination instanceof Settlement) {</span>
<span class="nc" id="L3289">            Tile tile = destination.getTile();</span>
<span class="nc bnc" id="L3290" title="All 2 branches missed.">            if (!highSeas.getDestinations().contains(tile.getMap())) {</span>
<span class="nc" id="L3291">                return serverPlayer.clientError(&quot;HighSeas does not connect to: &quot;</span>
<span class="nc" id="L3292">                    + destination.getId());</span>
<span class="nc bnc" id="L3293" title="All 2 branches missed.">            } else if (unit.getLocation() == highSeas) {</span>
                // Direction is somewhat moot, so just reset.
<span class="nc" id="L3295">                unit.setWorkLeft(unit.getSailTurns());</span>
<span class="nc" id="L3296">                unit.setDestination(destination);</span>
<span class="nc" id="L3297">                cs.add(See.only(serverPlayer), highSeas);</span>
<span class="nc bnc" id="L3298" title="All 2 branches missed.">            } else if (unit.getLocation() instanceof Europe) {</span>
<span class="nc" id="L3299">                Europe europe = (Europe) unit.getLocation();</span>
<span class="nc" id="L3300">                unit.setWorkLeft(unit.getSailTurns());</span>
<span class="nc" id="L3301">                unit.setDestination(destination);</span>
<span class="nc" id="L3302">                unit.setMovesLeft(0);</span>
<span class="nc" id="L3303">                unit.setLocation(highSeas);//-vis: safe!map</span>
<span class="nc" id="L3304">                cs.add(See.only(serverPlayer), europe, highSeas);</span>
<span class="nc" id="L3305">            } else {</span>
<span class="nc" id="L3306">                invalid = true;</span>
            }
<span class="nc" id="L3308">        } else {</span>
<span class="nc" id="L3309">            return serverPlayer.clientError(&quot;Bogus moveTo destination: &quot;</span>
<span class="nc" id="L3310">                + destination.getId());</span>
        }
<span class="pc bpc" id="L3312" title="1 of 2 branches missed.">        if (invalid) {</span>
<span class="nc" id="L3313">            return serverPlayer.clientError(&quot;Invalid moveTo: unit=&quot; + unit.getId()</span>
<span class="nc" id="L3314">                + &quot; from=&quot; + unit.getLocation().getId()</span>
<span class="nc" id="L3315">                + &quot; to=&quot; + destination.getId());</span>
        }

<span class="fc bfc" id="L3318" title="All 2 branches covered.">        if (others) getGame().sendToOthers(serverPlayer, cs);</span>
<span class="fc" id="L3319">        return cs;</span>
    }


    /**
     * Handle first contact between European and native player.
     *
     * Note that we check for a diplomacy session, but do only bother
     * in the case of tile!=null as that is the only possibility for
     * some benefit.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; making contact.
     * @param other The native &lt;code&gt;ServerPlayer&lt;/code&gt; to contact.
     * @param tile A &lt;code&gt;Tile&lt;/code&gt; on offer at first landing.
     * @param result Whether the initial peace treaty was accepted.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet nativeFirstContact(ServerPlayer serverPlayer,
                                        ServerPlayer other, Tile tile,
                                        boolean result) {
<span class="fc" id="L3339">        ChangeSet cs = new ChangeSet();</span>
<span class="pc bpc" id="L3340" title="1 of 2 branches missed.">        if (result) {</span>
<span class="pc bpc" id="L3341" title="1 of 2 branches missed.">            if (tile != null) {</span>
<span class="nc" id="L3342">                Unit u = tile.getFirstUnit();</span>
<span class="nc" id="L3343">                Settlement s = tile.getOwningSettlement();</span>
<span class="nc" id="L3344">                DiplomacySession session</span>
<span class="nc" id="L3345">                    = TransactionSession.lookup(DiplomacySession.class, u, s);</span>
<span class="nc bnc" id="L3346" title="All 2 branches missed.">                if (session == null) {</span>
<span class="nc" id="L3347">                    return serverPlayer.clientError(&quot;No diplomacy in effect for: &quot;</span>
<span class="nc" id="L3348">                        + tile.getId());</span>
                }
<span class="nc" id="L3350">                tile.cacheUnseen();//+til</span>
<span class="nc" id="L3351">                tile.changeOwnership(serverPlayer, null);//-til</span>
<span class="nc" id="L3352">                cs.add(See.perhaps(), tile);</span>
            }
<span class="nc" id="L3354">        } else {</span>
            // Consider not accepting the treaty to be an insult and
            // ban missions.
<span class="nc" id="L3357">            other.csModifyTension(serverPlayer,</span>
<span class="nc" id="L3358">                Tension.TENSION_ADD_MAJOR, cs);//+til</span>
<span class="nc" id="L3359">            other.addMissionBan(serverPlayer);</span>
        }

<span class="fc" id="L3362">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="fc" id="L3363">        return cs;</span>
    }


    /**
     * Get a new trade route for a player.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; to get a trade
     *    route for.
     * @return The new &lt;code&gt;TradeRoute&lt;/code&gt;.
     */
    public TradeRoute newTradeRoute(ServerPlayer serverPlayer) {
<span class="nc" id="L3375">        TradeRoute route = new TradeRoute(getGame(), </span>
<span class="nc" id="L3376">            serverPlayer.getNameForTradeRoute(), serverPlayer);</span>
<span class="nc" id="L3377">        serverPlayer.addTradeRoute(route);</span>
<span class="nc" id="L3378">        return route;</span>
    }


    /**
     * Pay arrears.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
     * @param type The &lt;code&gt;GoodsType&lt;/code&gt; to pay the arrears for.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet payArrears(ServerPlayer serverPlayer, GoodsType type) {
<span class="nc" id="L3390">        int arrears = serverPlayer.getArrears(type);</span>
<span class="nc bnc" id="L3391" title="All 2 branches missed.">        if (arrears &lt;= 0) {</span>
<span class="nc" id="L3392">            return serverPlayer.clientError(&quot;No arrears for pay for: &quot;</span>
<span class="nc" id="L3393">                + type.getId());</span>
<span class="nc bnc" id="L3394" title="All 2 branches missed.">        } else if (!serverPlayer.checkGold(arrears)) {</span>
<span class="nc" id="L3395">            return serverPlayer.clientError(&quot;Not enough gold to pay arrears for: &quot;</span>
<span class="nc" id="L3396">                + type.getId());</span>
        }

<span class="nc" id="L3399">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L3400">        Market market = serverPlayer.getMarket();</span>
<span class="nc" id="L3401">        serverPlayer.modifyGold(-arrears);</span>
<span class="nc" id="L3402">        market.setArrears(type, 0);</span>
<span class="nc" id="L3403">        cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;);</span>
<span class="nc" id="L3404">        cs.add(See.only(serverPlayer), market.getMarketData(type));</span>
        // Arrears payment is private.
<span class="nc" id="L3406">        return cs;</span>
    }


    /**
     * Pay for a building.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the
     *     colony.
     * @param colony The &lt;code&gt;Colony&lt;/code&gt; that is building.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet payForBuilding(ServerPlayer serverPlayer, Colony colony) {
<span class="nc" id="L3419">        if (!getGame().getSpecification()</span>
<span class="nc bnc" id="L3420" title="All 2 branches missed.">            .getBoolean(GameOptions.PAY_FOR_BUILDING)) {</span>
<span class="nc" id="L3421">            return serverPlayer.clientError(&quot;Pay for building is disabled&quot;);</span>
        }

<span class="nc" id="L3424">        BuildableType build = colony.getCurrentlyBuilding();</span>
<span class="nc bnc" id="L3425" title="All 2 branches missed.">        if (build == null) {</span>
<span class="nc" id="L3426">            return serverPlayer.clientError(&quot;Colony &quot; + colony.getId()</span>
<span class="nc" id="L3427">                + &quot; is not building anything!&quot;);</span>
        }
<span class="nc" id="L3429">        List&lt;AbstractGoods&gt; required = colony.getRequiredGoods(build);</span>
<span class="nc" id="L3430">        int price = colony.priceGoodsForBuilding(required);</span>
<span class="nc bnc" id="L3431" title="All 2 branches missed.">        if (!serverPlayer.checkGold(price)) {</span>
<span class="nc" id="L3432">            return serverPlayer.clientError(&quot;Insufficient funds to pay for build.&quot;);</span>
        }

        // Save the correct final gold for the player, as we are going to
        // use buy() below, but it deducts the normal uninflated price for
        // the goods being bought.  We restore this correct amount later.
<span class="nc" id="L3438">        int savedGold = serverPlayer.modifyGold(-price);</span>
<span class="nc" id="L3439">        serverPlayer.modifyGold(price);</span>

<span class="nc" id="L3441">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L3442">        GoodsContainer container = colony.getGoodsContainer();</span>
<span class="nc" id="L3443">        container.saveState();</span>
<span class="nc bnc" id="L3444" title="All 2 branches missed.">        for (AbstractGoods ag : required) {</span>
<span class="nc" id="L3445">            GoodsType type = ag.getType();</span>
<span class="nc" id="L3446">            int amount = ag.getAmount();</span>
<span class="nc bnc" id="L3447" title="All 2 branches missed.">            if (type.isStorable()) {</span>
                // FIXME: should also check canTrade(type, Access.?)
<span class="nc bnc" id="L3449" title="All 2 branches missed.">                if ((amount = serverPlayer.buy(container, type, amount)) &lt; 0) {</span>
<span class="nc" id="L3450">                    return serverPlayer.clientError(&quot;Can not buy &quot; + amount</span>
<span class="nc" id="L3451">                        + &quot; &quot; + type + &quot; for &quot; + build);</span>
                }
<span class="nc" id="L3453">                serverPlayer.propagateToEuropeanMarkets(type, -amount, random);</span>
<span class="nc" id="L3454">                serverPlayer.csFlushMarket(type, cs);</span>
<span class="nc" id="L3455">            } else {</span>
<span class="nc" id="L3456">                container.addGoods(type, amount);</span>
            }
        }
<span class="nc" id="L3459">        colony.invalidateCache();</span>

        // Nothing to see for others, colony internal.
<span class="nc" id="L3462">        serverPlayer.setGold(savedGold);</span>
<span class="nc" id="L3463">        cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;);</span>
<span class="nc" id="L3464">        cs.add(See.only(serverPlayer), container);</span>
<span class="nc" id="L3465">        return cs;</span>
    }


    /**
     * Put outside colony.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to be put out.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet putOutsideColony(ServerPlayer serverPlayer, Unit unit) {
<span class="nc" id="L3477">        Tile tile = unit.getTile();</span>
<span class="nc" id="L3478">        Colony colony = unit.getColony();</span>
<span class="nc bnc" id="L3479" title="All 2 branches missed.">        if (unit.isInColony()) tile.cacheUnseen();//+til</span>
<span class="nc" id="L3480">        unit.setLocation(tile);//-vis: safe/colony,-til if in colony</span>

        // Full tile update for the player, the rest get their limited
        // view of the colony so that population changes.
<span class="nc" id="L3484">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L3485">        cs.add(See.only(serverPlayer), tile);</span>
<span class="nc" id="L3486">        cs.add(See.perhaps().except(serverPlayer), colony);</span>
<span class="nc" id="L3487">        return cs;</span>
    }


    /**
     * Rearrange a colony.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is querying.
     * @param colony The &lt;code&gt;Colony&lt;/code&gt; to rearrange.
     * @param unitChanges A list of &lt;code&gt;UnitChange&lt;/code&gt;s to apply.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet rearrangeColony(ServerPlayer serverPlayer, Colony colony,
                                     List&lt;UnitChange&gt; unitChanges) {
<span class="fc" id="L3501">        final Role defaultRole = getGame().getSpecification().getDefaultRole();</span>
<span class="fc" id="L3502">        Tile tile = colony.getTile();</span>
<span class="fc" id="L3503">        tile.cacheUnseen();//+til</span>

        // Move everyone out of the way and stockpile their equipment.
<span class="fc bfc" id="L3506" title="All 2 branches covered.">        for (UnitChange uc : unitChanges) {</span>
<span class="fc" id="L3507">            uc.unit.setLocation(tile);//-til</span>
<span class="pc bpc" id="L3508" title="1 of 2 branches missed.">            if (!uc.unit.hasDefaultRole()) {</span>
<span class="nc" id="L3509">                colony.equipForRole(uc.unit, defaultRole, 0);</span>
            }
        }

<span class="fc" id="L3513">        List&lt;UnitChange&gt; todo = new ArrayList&lt;&gt;(unitChanges);</span>
<span class="fc bfc" id="L3514" title="All 2 branches covered.">        while (!todo.isEmpty()) {</span>
<span class="fc" id="L3515">            UnitChange uc = todo.remove(0);</span>
<span class="pc bpc" id="L3516" title="1 of 2 branches missed.">            if (uc.loc == tile) continue;</span>
<span class="fc" id="L3517">            WorkLocation wl = (WorkLocation)uc.loc;</span>
            // Adding to wl can fail, and in the worst case there
            // might be a circular dependency.  If the move can
            // succeed, do it, but if not, retry.
<span class="pc bpc" id="L3521" title="3 of 4 branches missed.">            switch (wl.getNoAddReason(uc.unit)) {</span>
            case NONE:
<span class="fc" id="L3523">                uc.unit.setLocation(wl);</span>
                // Fall through
            case ALREADY_PRESENT:
<span class="fc bfc" id="L3526" title="All 2 branches covered.">                if (uc.unit.getWorkType() != uc.work) {</span>
<span class="fc" id="L3527">                    uc.unit.changeWorkType(uc.work);</span>
                }
<span class="fc" id="L3529">                break;</span>
            case CAPACITY_EXCEEDED:
<span class="nc" id="L3531">                todo.add(todo.size(), uc);</span>
<span class="nc" id="L3532">                break;</span>
            default:
<span class="nc" id="L3534">                logger.warning(&quot;Bad move for &quot; + uc.unit + &quot; to &quot; + wl);</span>
                break;
            }
        }

        // Collect roles that cause a change, ordered by simplest change
<span class="pc bpc" id="L3540" title="1 of 2 branches missed.">        for (UnitChange uc : transformAndSort(unitChanges,</span>
<span class="pc bpc" id="L3541" title="3 of 4 branches missed.">                uc -&gt; uc.role != uc.unit.getRole() &amp;&amp; uc.role != defaultRole,</span>
<span class="fc" id="L3542">                Comparator.&lt;UnitChange&gt;reverseOrder(), Collectors.toList())) {</span>
<span class="nc bnc" id="L3543" title="All 2 branches missed.">            if (!colony.equipForRole(uc.unit, uc.role, uc.roleCount)) {</span>
<span class="nc" id="L3544">                return serverPlayer.clientError(&quot;Failed to equip &quot;</span>
<span class="nc" id="L3545">                    + uc.unit.getId() + &quot; for role &quot; + uc.role</span>
<span class="nc" id="L3546">                    + &quot; at &quot; + colony);</span>
            }
        }
        
        // Just update the whole tile, including for other players
        // which might see colony population change.
<span class="fc" id="L3552">        return new ChangeSet().add(See.perhaps(), tile);</span>
    }


    /**
     * Rename an object.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is naming.
     * @param object The &lt;code&gt;Nameable&lt;/code&gt; to rename.
     * @param newName The new name.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet renameObject(ServerPlayer serverPlayer, Nameable object,
                                  String newName) {
<span class="nc" id="L3566">        ChangeSet cs = new ChangeSet();</span>

<span class="nc bnc" id="L3568" title="All 2 branches missed.">        if (object instanceof Settlement) {</span>
<span class="nc" id="L3569">            ((Settlement)object).getTile().cacheUnseen();//+til</span>
        }
<span class="nc" id="L3571">        object.setName(newName);//-til?</span>
<span class="nc" id="L3572">        FreeColGameObject fcgo = (FreeColGameObject)object;</span>
<span class="nc" id="L3573">        cs.addPartial(See.all(), fcgo, &quot;name&quot;);</span>

        // Others may be able to see the name change.
<span class="nc" id="L3576">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L3577">        return cs;</span>
    }


    /**
     * Handle a player retiring.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is retiring.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; containing the response.
     */
    public ChangeSet retire(ServerPlayer serverPlayer) {
<span class="nc" id="L3588">        boolean highScore = HighScore.newHighScore(serverPlayer);</span>
<span class="nc" id="L3589">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L3590">        serverPlayer.csWithdraw(cs); // Clean up the player.</span>
<span class="nc" id="L3591">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L3592">        cs.addAttribute(See.only(serverPlayer),</span>
<span class="nc" id="L3593">                        &quot;highScore&quot;, Boolean.toString(highScore));</span>
<span class="nc" id="L3594">        return cs;</span>
    }


    /**
     * Scout a native settlement, that is, the contacting action
     * that generates the greeting dialog.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is scouting.
     * @param unit The scout &lt;code&gt;Unit&lt;/code&gt;.
     * @param settlement The &lt;code&gt;IndianSettlement&lt;/code&gt; to scout.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet scoutIndianSettlement(ServerPlayer serverPlayer,
                                           Unit unit,
                                           IndianSettlement settlement) {
<span class="nc" id="L3610">        final Player owner = settlement.getOwner();</span>
<span class="nc" id="L3611">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L3612">        Tile tile = settlement.getTile();</span>

<span class="nc" id="L3614">        csVisit(serverPlayer, settlement, -1, cs);</span>
<span class="nc" id="L3615">        tile.updateIndianSettlement(serverPlayer);</span>
<span class="nc" id="L3616">        cs.add(See.only(serverPlayer), tile);</span>
<span class="nc" id="L3617">        cs.add(See.only(serverPlayer), ChangeSet.ChangePriority.CHANGE_LATE,</span>
<span class="nc" id="L3618">            new NationSummaryMessage(owner)</span>
<span class="nc" id="L3619">                .setNationSummary(new NationSummary(owner, serverPlayer)));</span>

        // This is private.
<span class="nc" id="L3622">        return cs;</span>
    }


    /**
     * Speak to the chief at a native settlement.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is scouting.
     * @param unit The scout &lt;code&gt;Unit&lt;/code&gt;.
     * @param settlement The &lt;code&gt;IndianSettlement&lt;/code&gt; to scout.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet scoutSpeakToChief(ServerPlayer serverPlayer,
                                       Unit unit, IndianSettlement settlement) {
<span class="nc" id="L3636">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L3637">        Tile tile = settlement.getTile();</span>
<span class="nc" id="L3638">        boolean tileDirty = settlement.setVisited(serverPlayer);</span>
        String result;

        // Hateful natives kill the scout right away.
<span class="nc" id="L3642">        Tension tension = settlement.getAlarm(serverPlayer);</span>
<span class="nc bnc" id="L3643" title="All 2 branches missed.">        if (tension.getLevel() == Tension.Level.HATEFUL) {</span>
<span class="nc" id="L3644">            cs.add(See.perhaps().always(serverPlayer),</span>
<span class="nc" id="L3645">                   (FreeColGameObject)unit.getLocation());</span>
<span class="nc" id="L3646">            cs.addRemove(See.perhaps().always(serverPlayer),</span>
<span class="nc" id="L3647">                         unit.getLocation(), unit);//-vis(serverPlayer)</span>
<span class="nc" id="L3648">            unit.dispose();</span>
<span class="nc" id="L3649">            serverPlayer.invalidateCanSeeTiles();//+vis(serverPlayer)</span>
<span class="nc" id="L3650">            result = &quot;die&quot;;</span>
<span class="nc" id="L3651">        } else {</span>
            // Otherwise player gets to visit, and learn about the settlement.
<span class="nc" id="L3653">            List&lt;UnitType&gt; scoutTypes = getGame().getSpecification()</span>
<span class="nc" id="L3654">                .getUnitTypesWithAbility(Ability.EXPERT_SCOUT);</span>
<span class="nc bnc" id="L3655" title="All 2 branches missed.">            UnitType scoutSkill = (scoutTypes.isEmpty()) ? null</span>
<span class="nc" id="L3656">                : scoutTypes.get(0);</span>
<span class="nc" id="L3657">            int radius = unit.getLineOfSight();</span>
<span class="nc" id="L3658">            UnitType skill = settlement.getLearnableSkill();</span>
<span class="nc" id="L3659">            int rnd = randomInt(logger, &quot;scouting&quot;, random, 10);</span>
<span class="nc bnc" id="L3660" title="All 2 branches missed.">            if (settlement.hasAnyScouted()) {</span>
                // Do nothing if already spoken to.
<span class="nc" id="L3662">                result = &quot;nothing&quot;;</span>
<span class="nc bnc" id="L3663" title="All 4 branches missed.">            } else if (scoutSkill != null &amp;&amp; unit.getType() != scoutSkill</span>
<span class="nc bnc" id="L3664" title="All 4 branches missed.">                &amp;&amp; ((skill != null &amp;&amp; skill.hasAbility(Ability.EXPERT_SCOUT))</span>
<span class="nc bnc" id="L3665" title="All 2 branches missed.">                    || rnd == 0)) {</span>
                // If the scout can be taught to be an expert it will be.
<span class="nc" id="L3667">                unit.changeType(scoutSkill);//-vis(serverPlayer)</span>
<span class="nc" id="L3668">                serverPlayer.invalidateCanSeeTiles();//+vis(serverPlayer)</span>
<span class="nc" id="L3669">                result = &quot;expert&quot;;</span>
<span class="nc" id="L3670">            } else {</span>
                // Choose tales 1/3 of the time, or if there are no beads.
<span class="nc" id="L3672">                RandomRange gifts = settlement.getType().getGifts(unit);</span>
<span class="nc bnc" id="L3673" title="All 2 branches missed.">                int gold = (gifts == null) ? 0</span>
<span class="nc" id="L3674">                    : gifts.getAmount(&quot;Base beads amount&quot;, random, true);</span>
<span class="nc bnc" id="L3675" title="All 4 branches missed.">                if (gold &lt;= 0 || rnd &lt;= 3) {</span>
<span class="nc" id="L3676">                    radius = Math.max(radius, IndianSettlement.TALES_RADIUS);</span>
<span class="nc" id="L3677">                    result = &quot;tales&quot;;</span>
<span class="nc" id="L3678">                } else {</span>
<span class="nc bnc" id="L3679" title="All 2 branches missed.">                    if (unit.hasAbility(Ability.EXPERT_SCOUT)) {</span>
<span class="nc" id="L3680">                        gold = (gold * 11) / 10; // FIXME: magic number</span>
                    }
<span class="nc" id="L3682">                    serverPlayer.modifyGold(gold);</span>
<span class="nc" id="L3683">                    settlement.getOwner().modifyGold(-gold);</span>
<span class="nc" id="L3684">                    result = Integer.toString(gold);</span>
<span class="nc" id="L3685">                    cs.addPartial(See.only(serverPlayer), serverPlayer,</span>
<span class="nc" id="L3686">                                  &quot;gold&quot;, &quot;score&quot;);</span>
                }
            }

            // Have now spoken to the chief.
<span class="nc" id="L3691">            csVisit(serverPlayer, settlement, 1, cs);</span>
<span class="nc" id="L3692">            tileDirty = true;</span>

            // Update settlement tile with new information, and any
            // newly visible tiles, possibly with enhanced radius.
<span class="nc" id="L3696">            Set&lt;Tile&gt; tiles = transform(tile.getSurroundingTiles(1, radius),</span>
<span class="nc bnc" id="L3697" title="All 6 branches missed.">                t -&gt; !serverPlayer.canSee(t) &amp;&amp; (t.isLand() || t.isShore()),</span>
<span class="nc" id="L3698">                Collectors.toSet());</span>
<span class="nc" id="L3699">            cs.add(See.only(serverPlayer), serverPlayer.exploreTiles(tiles));</span>

            // If the unit was promoted, update it completely, otherwise just
            // update moves and possibly gold+score.
<span class="nc" id="L3703">            unit.setMovesLeft(0);</span>
<span class="nc bnc" id="L3704" title="All 2 branches missed.">            if (&quot;expert&quot;.equals(result)) {</span>
<span class="nc" id="L3705">                cs.add(See.perhaps(), unit);</span>
<span class="nc" id="L3706">            } else {</span>
<span class="nc" id="L3707">                cs.addPartial(See.only(serverPlayer), unit, &quot;movesLeft&quot;);</span>
            }
        }
<span class="nc bnc" id="L3710" title="All 2 branches missed.">        if (tileDirty) {</span>
<span class="nc" id="L3711">            tile.updateIndianSettlement(serverPlayer);</span>
<span class="nc" id="L3712">            cs.add(See.only(serverPlayer), tile);</span>
        }

        // Always add result.
<span class="nc" id="L3716">        cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
<span class="nc" id="L3717">            new ScoutSpeakToChiefMessage(unit, settlement, result));</span>

        // Other players may be able to see unit disappearing, or
        // learning.
<span class="nc" id="L3721">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L3722">        return cs;</span>
    }


    /**
     * Sell goods in Europe.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is selling.
     * @param type The &lt;code&gt;GoodsType&lt;/code&gt; to sell.
     * @param amount The amount of goods to sell.
     * @param carrier The &lt;code&gt;Unit&lt;/code&gt; carrying the goods.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet sellGoods(ServerPlayer serverPlayer, GoodsType type,
                               int amount, Unit carrier) {
<span class="fc" id="L3737">        ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L3738">        GoodsContainer container = carrier.getGoodsContainer();</span>
<span class="fc" id="L3739">        container.saveState();</span>
<span class="fc bfc" id="L3740" title="All 2 branches covered.">        if (serverPlayer.canTrade(type, Access.EUROPE)) {</span>
<span class="fc" id="L3741">            int gold = serverPlayer.getGold();</span>
<span class="fc" id="L3742">            int sellAmount = serverPlayer.sell(container, type, amount);</span>
<span class="pc bpc" id="L3743" title="1 of 2 branches missed.">            if (sellAmount &lt; 0) {</span>
<span class="nc" id="L3744">                return serverPlayer.clientError(&quot;Player &quot; + serverPlayer.getName()</span>
<span class="nc" id="L3745">                    + &quot; tried to sell &quot; + amount + &quot; &quot; + type.getSuffix());</span>
            }
<span class="fc" id="L3747">            serverPlayer.propagateToEuropeanMarkets(type, sellAmount, random);</span>
<span class="fc" id="L3748">            serverPlayer.csFlushMarket(type, cs);</span>
<span class="fc" id="L3749">            cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;);</span>
<span class="fc" id="L3750">            logger.finest(carrier + &quot; sold &quot; + amount + &quot;(&quot; + sellAmount + &quot;)&quot;</span>
<span class="fc" id="L3751">                + &quot; &quot; + type.getSuffix()</span>
<span class="fc" id="L3752">                + &quot; in Europe for &quot; + (serverPlayer.getGold() - gold));</span>
<span class="fc" id="L3753">        } else {</span>
            // Dumping goods in Europe
<span class="fc" id="L3755">            moveGoods(carrier, type, amount, null);</span>
<span class="fc" id="L3756">            logger.finest(carrier + &quot; dumped &quot; + amount</span>
<span class="fc" id="L3757">                + &quot; &quot; + type.getSuffix() + &quot; in Europe&quot;);</span>
        }
<span class="fc" id="L3759">        carrier.setMovesLeft(0);</span>
<span class="fc" id="L3760">        cs.add(See.only(serverPlayer), carrier);</span>
        // Action occurs in Europe, nothing is visible to other players.
<span class="fc" id="L3762">        return cs;</span>
    }


    /**
     * Price some goods for sale to a settlement.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is buying.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is trading.
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; that is trading.
     * @param goods The &lt;code&gt;Goods&lt;/code&gt; to sell.
     * @param price The sellers proposed price for the goods.
     * @return A &lt;code&gt;SellPropositionMessage&lt;/code&gt; encapsulating this action
     *     or an error message on failure.
     */
    public DOMMessage sellProposition(ServerPlayer serverPlayer,
        Unit unit, Settlement settlement, Goods goods, int price) {
<span class="nc" id="L3779">        TradeSession session</span>
<span class="nc" id="L3780">            = TradeSession.lookup(TradeSession.class, unit, settlement);</span>
<span class="nc bnc" id="L3781" title="All 2 branches missed.">        if (session == null) {</span>
<span class="nc" id="L3782">            return new ErrorMessage(&quot;Proposing to sell without opening a transaction session&quot;);</span>
        }
<span class="nc bnc" id="L3784" title="All 2 branches missed.">        if (!session.getSell()) {</span>
<span class="nc" id="L3785">            return new ErrorMessage(&quot;Proposing to sell in a session where selling is not allowed.&quot;);</span>
        }
<span class="nc" id="L3787">        ChangeSet cs = new ChangeSet();</span>
<span class="nc bnc" id="L3788" title="All 2 branches missed.">        if (settlement instanceof IndianSettlement) {</span>
<span class="nc" id="L3789">            csVisit(serverPlayer, (IndianSettlement)settlement, 0, cs);</span>
        }

        // AI considers the proposition, return with a gold value
<span class="nc" id="L3793">        AIPlayer ai = getFreeColServer().getAIPlayer(settlement.getOwner());</span>
<span class="nc" id="L3794">        int gold = ai.sellProposition(unit, settlement, goods, price);</span>

        // Others can not see proposals.
<span class="nc" id="L3797">        return new SellPropositionMessage(unit, settlement, goods, gold);</span>
    }


    /**
     * Sell to a settlement.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is selling.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; carrying the goods.
     * @param settlement The &lt;code&gt;ServerIndianSettlement&lt;/code&gt; to sell to.
     * @param goods The &lt;code&gt;Goods&lt;/code&gt; to sell.
     * @param amount How much gold to expect.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet sellToSettlement(ServerPlayer serverPlayer, Unit unit,
                                      ServerIndianSettlement settlement,
                                      Goods goods, int amount) {
<span class="nc" id="L3814">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L3815">        csVisit(serverPlayer, settlement, 0, cs);</span>

<span class="nc" id="L3817">        TradeSession session</span>
<span class="nc" id="L3818">            = TransactionSession.lookup(TradeSession.class, unit, settlement);</span>
<span class="nc bnc" id="L3819" title="All 2 branches missed.">        if (session == null) {</span>
<span class="nc" id="L3820">            return serverPlayer.clientError(&quot;Trying to sell without opening a transaction session&quot;);</span>
        }
<span class="nc bnc" id="L3822" title="All 2 branches missed.">        if (!session.getSell()) {</span>
<span class="nc" id="L3823">            return serverPlayer.clientError(&quot;Trying to sell in a session where selling is not allowed.&quot;);</span>
        }

        // Check that the gold is the agreed amount
<span class="nc" id="L3827">        AIPlayer ai = getFreeColServer().getAIPlayer(settlement.getOwner());</span>
<span class="nc" id="L3828">        int returnGold = ai.sellProposition(unit, settlement, goods, amount);</span>
<span class="nc bnc" id="L3829" title="All 2 branches missed.">        if (returnGold != amount) {</span>
<span class="nc" id="L3830">            return serverPlayer.clientError(&quot;This was not the price we agreed upon! Cheater?&quot;);</span>
        }

        // Valid, make the trade.
<span class="nc" id="L3834">        moveGoods(unit, goods.getType(), goods.getAmount(), settlement);</span>
<span class="nc" id="L3835">        cs.add(See.perhaps(), unit);</span>

<span class="nc" id="L3837">        Player settlementPlayer = settlement.getOwner();</span>
<span class="nc" id="L3838">        settlementPlayer.modifyGold(-amount);</span>
<span class="nc" id="L3839">        serverPlayer.modifyGold(amount);</span>
<span class="nc" id="L3840">        settlement.csModifyAlarm(serverPlayer, -amount / 500, true, cs);</span>
<span class="nc" id="L3841">        Tile tile = settlement.getTile();</span>
<span class="nc" id="L3842">        settlement.updateWantedGoods();</span>
<span class="nc" id="L3843">        tile.updateIndianSettlement(serverPlayer);</span>
<span class="nc" id="L3844">        cs.add(See.only(serverPlayer), tile);</span>
<span class="nc" id="L3845">        cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;);</span>
<span class="nc" id="L3846">        session.setSell();</span>
<span class="nc" id="L3847">        cs.addSale(serverPlayer, settlement, goods.getType(),</span>
<span class="nc" id="L3848">                Math.round((float) amount / goods.getAmount()));</span>
<span class="nc" id="L3849">        logger.finest(serverPlayer.getName() + &quot; &quot; + unit + &quot; sells &quot; + goods</span>
<span class="nc" id="L3850">                      + &quot; at &quot; + settlement.getName() + &quot; for &quot; + amount);</span>

        // Others can see the unit capacity.
<span class="nc" id="L3853">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L3854">        return cs;</span>
    }


    /**
     * Set build queue.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the colony.
     * @param colony The &lt;code&gt;Colony&lt;/code&gt; to set the queue of.
     * @param queue The new build queue.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet setBuildQueue(ServerPlayer serverPlayer, Colony colony,
                                   List&lt;BuildableType&gt; queue) {
<span class="fc" id="L3868">        BuildableType current = colony.getCurrentlyBuilding();</span>
<span class="fc" id="L3869">        colony.setBuildQueue(queue);</span>
<span class="fc" id="L3870">        if (getGame().getSpecification()</span>
<span class="pc bpc" id="L3871" title="1 of 2 branches missed.">            .getBoolean(GameOptions.CLEAR_HAMMERS_ON_CONSTRUCTION_SWITCH)</span>
<span class="nc bnc" id="L3872" title="All 2 branches missed.">            &amp;&amp; current != colony.getCurrentlyBuilding()) {</span>
<span class="nc bnc" id="L3873" title="All 2 branches missed.">            for (AbstractGoods ag : current.getRequiredGoods()) {</span>
<span class="nc bnc" id="L3874" title="All 2 branches missed.">                if (!ag.getType().isStorable()) {</span>
<span class="nc" id="L3875">                    colony.removeGoods(ag.getType());</span>
                }
            }
        }
<span class="fc" id="L3879">        colony.invalidateCache();</span>

        // Only visible to player.
<span class="fc" id="L3882">        ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L3883">        cs.add(See.only(serverPlayer), colony);</span>
<span class="fc" id="L3884">        return cs;</span>
    }


    /**
     * Set a unit stop.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to set the destination for.
     * @param index The stop index.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet setCurrentStop(ServerPlayer serverPlayer, Unit unit,
                                    int index) {
<span class="nc" id="L3898">        TradeRoute tr = unit.getTradeRoute();</span>
<span class="nc bnc" id="L3899" title="All 2 branches missed.">        if (tr == null) {</span>
<span class="nc" id="L3900">            return serverPlayer.clientError(&quot;Unit has no trade route to set stop for.&quot;);</span>
<span class="nc bnc" id="L3901" title="All 4 branches missed.">        } else if (index &lt; 0 || index &gt;= tr.getStops().size()) {</span>
<span class="nc" id="L3902">            return serverPlayer.clientError(&quot;Stop index out of range [0..&quot;</span>
<span class="nc" id="L3903">                + tr.getStops().size() + &quot;]: &quot; + index);</span>
        }

<span class="nc" id="L3906">        unit.setCurrentStop(index);</span>

        // Others can not see a stop change.
<span class="nc" id="L3909">        return new ChangeSet().add(See.only(serverPlayer), unit);</span>
    }


    /**
     * Set a unit destination.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to set the destination for.
     * @param destination The &lt;code&gt;Location&lt;/code&gt; to set as destination.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet setDestination(ServerPlayer serverPlayer, Unit unit,
                                    Location destination) {
<span class="nc bnc" id="L3923" title="All 2 branches missed.">        if (unit.getTradeRoute() != null) {</span>
            // Override destination to bring the unit to port.
<span class="nc bnc" id="L3925" title="All 4 branches missed.">            if (destination == null &amp;&amp; unit.isAtSea()) {</span>
<span class="nc" id="L3926">                destination = unit.getStop().getLocation();</span>
            }
<span class="nc" id="L3928">            unit.setTradeRoute(null);</span>
        }
<span class="nc" id="L3930">        unit.setDestination(destination);</span>

        // Others can not see a destination change.
<span class="nc" id="L3933">        return new ChangeSet().add(See.only(serverPlayer), unit);</span>
    }


    /**
     * Set goods levels.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the colony.
     * @param colony The &lt;code&gt;Colony&lt;/code&gt; to set the goods levels in.
     * @param exportData The new &lt;code&gt;ExportData&lt;/code&gt;.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet setGoodsLevels(ServerPlayer serverPlayer, Colony colony,
                                    ExportData exportData) {
<span class="nc" id="L3947">        colony.setExportData(exportData);</span>
<span class="nc" id="L3948">        return new ChangeSet().add(See.only(serverPlayer), colony);</span>
    }


    /**
     * Set land name.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; who landed.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that has come ashore.
     * @param name The new land name.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet setNewLandName(ServerPlayer serverPlayer, Unit unit,
                                    String name) {
<span class="nc" id="L3962">        ChangeSet cs = new ChangeSet();</span>

        // Special case of a welcome from an adjacent native unit,
        // offering the land the landing unit is on if a peace treaty
        // is accepted.
<span class="nc" id="L3967">        serverPlayer.setNewLandName(name);</span>

        // Update the name and note the history.
<span class="nc" id="L3970">        cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;newLandName&quot;);</span>
<span class="nc" id="L3971">        Turn turn = serverPlayer.getGame().getTurn();</span>
<span class="nc" id="L3972">        HistoryEvent h = new HistoryEvent(turn,</span>
<span class="nc" id="L3973">            HistoryEvent.HistoryEventType.DISCOVER_NEW_WORLD, serverPlayer)</span>
<span class="nc" id="L3974">                .addName(&quot;%name%&quot;, name);</span>
<span class="nc" id="L3975">        cs.addHistory(serverPlayer, h);</span>
<span class="nc" id="L3976">        return cs;</span>
    }


    /**
     * Set region name.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; discovering.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is discovering.
     * @param region The &lt;code&gt;Region&lt;/code&gt; to discover.
     * @param name The new region name.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet setNewRegionName(ServerPlayer serverPlayer, Unit unit,
                                      Region region, String name) {
<span class="nc" id="L3991">        final Game game = getGame();</span>
<span class="nc" id="L3992">        ServerRegion serverRegion = (ServerRegion)region;</span>
        // Discoverer is set when unit moves in.
<span class="nc bnc" id="L3994" title="All 2 branches missed.">        if (!Utils.equals(region.getDiscoverer(), unit.getId())) {</span>
<span class="nc" id="L3995">            return serverPlayer.clientError(&quot;Discoverer mismatch, &quot;</span>
<span class="nc" id="L3996">                + region.getDiscoverer() + &quot; expected, &quot;</span>
<span class="nc" id="L3997">                + unit.getId() + &quot; provided.&quot;);</span>
        }
<span class="nc" id="L3999">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L4000">        serverRegion.csDiscover(serverPlayer, game.getTurn(), name, cs);</span>

        // Others do find out about region name changes.
<span class="nc" id="L4003">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L4004">        return cs;</span>
    }


    /**
     * Spy on a settlement.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is spying.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is spying.
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; to spy on.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet spySettlement(ServerPlayer serverPlayer, Unit unit,
                                   Settlement settlement) {
<span class="nc" id="L4018">        ChangeSet cs = new ChangeSet();</span>

<span class="nc" id="L4020">        cs.addSpy(See.only(serverPlayer), unit, settlement);</span>
<span class="nc" id="L4021">        unit.setMovesLeft(0);</span>
<span class="nc" id="L4022">        cs.addPartial(See.only(serverPlayer), unit, &quot;movesLeft&quot;);</span>
<span class="nc" id="L4023">        return cs;</span>
    }


    /**
     * Train a unit in Europe.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is demanding.
     * @param type The &lt;code&gt;UnitType&lt;/code&gt; to train.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet trainUnitInEurope(ServerPlayer serverPlayer,
                                       UnitType type) {

<span class="nc" id="L4037">        Europe europe = serverPlayer.getEurope();</span>
<span class="nc bnc" id="L4038" title="All 2 branches missed.">        if (europe == null) {</span>
<span class="nc" id="L4039">            return serverPlayer.clientError(&quot;No Europe to train in.&quot;);</span>
        }
<span class="nc" id="L4041">        int price = europe.getUnitPrice(type);</span>
<span class="nc bnc" id="L4042" title="All 2 branches missed.">        if (price &lt;= 0) {</span>
<span class="nc" id="L4043">            return serverPlayer.clientError(&quot;Bogus price: &quot; + price);</span>
<span class="nc bnc" id="L4044" title="All 2 branches missed.">        } else if (!serverPlayer.checkGold(price)) {</span>
<span class="nc" id="L4045">            return serverPlayer.clientError(&quot;Not enough gold (&quot;</span>
<span class="nc" id="L4046">                + serverPlayer.getGold() + &quot; &lt; &quot; + price</span>
<span class="nc" id="L4047">                + &quot;) to train &quot; + type);</span>
        }

<span class="nc" id="L4050">        final Game game = getGame();</span>
<span class="nc" id="L4051">        final Specification spec = game.getSpecification();</span>
<span class="nc bnc" id="L4052" title="All 2 branches missed.">        Role role = (spec.getBoolean(GameOptions.EQUIP_EUROPEAN_RECRUITS))</span>
<span class="nc" id="L4053">            ? type.getDefaultRole()</span>
<span class="nc" id="L4054">            : spec.getDefaultRole();</span>
<span class="nc" id="L4055">        Unit unit = new ServerUnit(game, europe, serverPlayer, type,</span>
<span class="nc" id="L4056">                                   role);//-vis: safe, Europe</span>
<span class="nc" id="L4057">        unit.setName(serverPlayer.getNameForUnit(type, random));</span>
<span class="nc" id="L4058">        serverPlayer.modifyGold(-price);</span>
<span class="nc" id="L4059">        ((ServerEurope)europe).increasePrice(type, price);</span>

        // Only visible in Europe
<span class="nc" id="L4062">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L4063">        cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;);</span>
<span class="nc" id="L4064">        cs.add(See.only(serverPlayer), europe);</span>
<span class="nc" id="L4065">        return cs;</span>
    }


    /**
     * Unload goods.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is unloading.
     * @param goodsType The &lt;code&gt;GoodsType&lt;/code&gt; to unload.
     * @param amount The amount of goods to unload.
     * @param carrier The &lt;code&gt;Unit&lt;/code&gt; to unload.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet unloadGoods(ServerPlayer serverPlayer, GoodsType goodsType,
                                 int amount, Unit carrier) {
<span class="fc bfc" id="L4080" title="All 2 branches covered.">        if (carrier.getGoodsCount(goodsType) &lt; amount) {</span>
<span class="fc" id="L4081">            return serverPlayer.clientError(&quot;Too few goods&quot;);</span>
        }
<span class="fc bfc" id="L4083" title="All 2 branches covered.">        if (carrier.isInEurope()) {</span>
<span class="fc" id="L4084">            return sellGoods(serverPlayer, goodsType, amount, carrier);</span>
        }

<span class="fc" id="L4087">        ChangeSet cs = new ChangeSet();</span>
<span class="fc bfc" id="L4088" title="All 2 branches covered.">        if (carrier.getSettlement() != null) {</span>
<span class="fc" id="L4089">            Settlement settlement = carrier.getSettlement();</span>
<span class="fc" id="L4090">            moveGoods(carrier, goodsType, amount, settlement);</span>
<span class="fc" id="L4091">            logger.finest(carrier</span>
<span class="fc" id="L4092">                + &quot; unloaded &quot; + amount + &quot; &quot; + goodsType.getSuffix()</span>
<span class="fc" id="L4093">                + &quot; to &quot; + settlement.getName());</span>
<span class="fc" id="L4094">            cs.add(See.only(serverPlayer), settlement.getGoodsContainer());</span>
<span class="fc" id="L4095">            cs.add(See.only(serverPlayer), carrier.getGoodsContainer());</span>
<span class="pc bpc" id="L4096" title="1 of 2 branches missed.">            if (carrier.getInitialMovesLeft() != carrier.getMovesLeft()) {</span>
<span class="nc" id="L4097">                carrier.setMovesLeft(0);</span>
<span class="nc" id="L4098">                cs.addPartial(See.only(serverPlayer), carrier, &quot;movesLeft&quot;);</span>
            }
<span class="nc" id="L4100">        } else { // Dump of goods onto a tile</span>
<span class="fc" id="L4101">            moveGoods(carrier, goodsType, amount, null);</span>
<span class="fc" id="L4102">            logger.finest(carrier + &quot; dumped &quot; + amount</span>
<span class="fc" id="L4103">                + &quot; &quot; + goodsType.getSuffix() + &quot; to &quot; + carrier.getLocation());</span>
<span class="fc" id="L4104">            cs.add(See.perhaps(), (FreeColGameObject)carrier.getLocation());</span>
            // Others might see a capacity change.
<span class="fc" id="L4106">            getGame().sendToOthers(serverPlayer, cs);</span>
        }
<span class="fc" id="L4108">        return cs;</span>
    }


    /**
     * Update a trade route for a player.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; to set trade
     *     routes for.
     * @param tradeRoute An uninterned &lt;code&gt;TradeRoute&lt;/code&gt; to update.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet updateTradeRoute(ServerPlayer serverPlayer,
                                      TradeRoute tradeRoute) {
<span class="nc" id="L4122">        final Game game = getGame();</span>
        String name;
        StringTemplate fail;
        TradeRoute tr;
<span class="nc bnc" id="L4126" title="All 4 branches missed.">        if (tradeRoute == null || tradeRoute.getId() == null</span>
<span class="nc bnc" id="L4127" title="All 2 branches missed.">            || (name = tradeRoute.getName()) == null) {</span>
<span class="nc" id="L4128">            return serverPlayer.clientError(&quot;Bogus route&quot;);</span>
<span class="nc bnc" id="L4129" title="All 2 branches missed.">        } else if ((fail = tradeRoute.verify()) != null) {</span>
<span class="nc" id="L4130">            return serverPlayer.clientError(Messages.message(fail));</span>
<span class="nc bnc" id="L4131" title="All 2 branches missed.">        } else if ((tr = game.getFreeColGameObject(tradeRoute.getId(),</span>
<span class="nc" id="L4132">                    TradeRoute.class)) == null) {</span>
<span class="nc" id="L4133">            return serverPlayer.clientError(&quot;Not an existing trade route: &quot;</span>
<span class="nc" id="L4134">                + tradeRoute.getId());</span>
        }
<span class="nc" id="L4136">        tr.updateFrom(tradeRoute);</span>

        // Have to update the whole player alas.
<span class="nc" id="L4139">        return new ChangeSet().add(See.only(serverPlayer), serverPlayer);</span>
    }


    /**
     * Change work location.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to change the work location of.
     * @param workLocation The &lt;code&gt;WorkLocation&lt;/code&gt; to change to.
     * @return A &lt;code&gt;ChangeSet&lt;/code&gt; encapsulating this action.
     */
    public ChangeSet work(ServerPlayer serverPlayer, Unit unit,
                          WorkLocation workLocation) {
<span class="fc" id="L4153">        final Specification spec = getGame().getSpecification();</span>
<span class="fc" id="L4154">        final Colony colony = workLocation.getColony();</span>
<span class="fc" id="L4155">        colony.getGoodsContainer().saveState();</span>

<span class="fc" id="L4157">        ChangeSet cs = new ChangeSet();</span>
<span class="pc bpc" id="L4158" title="1 of 2 branches missed.">        if (workLocation instanceof ColonyTile) {</span>
<span class="fc" id="L4159">            Tile tile = ((ColonyTile) workLocation).getWorkTile();</span>
<span class="pc bpc" id="L4160" title="1 of 2 branches missed.">            if (tile.getOwningSettlement() != colony) {</span>
                // Claim known free land (because canAdd() succeeded).
<span class="nc" id="L4162">                serverPlayer.csClaimLand(tile, colony, 0, cs);</span>
            }
        }

<span class="fc" id="L4166">        colony.equipForRole(unit, spec.getDefaultRole(), 0);</span>

        // Check for upgrade.
<span class="fc" id="L4169">        UnitType newType = unit.getTypeChange(ChangeType.ENTER_COLONY,</span>
<span class="fc" id="L4170">                                              unit.getOwner());</span>
<span class="pc bpc" id="L4171" title="1 of 2 branches missed.">        if (newType != null) unit.changeType(newType);//-vis: safe in colony</span>

        // Change the location.
        // We could avoid updating the whole tile if we knew that this
        // was definitely a move between locations and no student/teacher
        // interaction occurred.
<span class="pc bpc" id="L4177" title="1 of 2 branches missed.">        if (!unit.isInColony()) unit.getColony().getTile().cacheUnseen();//+til</span>
<span class="fc" id="L4178">        unit.setLocation(workLocation);//-vis: safe/colony,-til if not in colony</span>
<span class="fc" id="L4179">        cs.add(See.perhaps(), colony.getTile());</span>
        // Others can see colony change size
<span class="fc" id="L4181">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="fc" id="L4182">        return cs;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span>src (May 7, 2016 6:04:12 PM)</div></body></html>