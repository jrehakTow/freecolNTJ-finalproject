<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>QuickActionMenu.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">src (May 7, 2016 6:04:12 PM)</a> &gt; <a href="../../index.html" class="el_group">FreeCol</a> &gt; <a href="../index.html" class="el_bundle">src</a> &gt; <a href="index.source.html" class="el_package">net.sf.freecol.client.gui.panel</a> &gt; <span class="el_source">QuickActionMenu.java</span></div><h1>QuickActionMenu.java</h1><pre class="source lang-java linenums">/**
 *  Copyright (C) 2002-2016   The FreeCol Team
 *
 *  This file is part of FreeCol.
 *
 *  FreeCol is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  FreeCol is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with FreeCol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package net.sf.freecol.client.gui.panel;

import java.awt.Font;
import java.awt.event.ActionEvent;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.logging.Logger;
import java.util.stream.Collectors;

import javax.swing.Icon;
import javax.swing.ImageIcon;
import javax.swing.JComponent;
import javax.swing.JLabel;
import javax.swing.JMenu;
import javax.swing.JMenuItem;
import javax.swing.JPanel;
import javax.swing.JPopupMenu;

import net.miginfocom.swing.MigLayout;

import net.sf.freecol.client.FreeColClient;
import net.sf.freecol.client.control.InGameController;
import net.sf.freecol.client.gui.ImageLibrary;
import net.sf.freecol.client.gui.SwingGUI;
import net.sf.freecol.client.gui.panel.ColonyPanel.TilesPanel.ASingleTilePanel;
import net.sf.freecol.client.gui.panel.UnitLabel.UnitAction;
import net.sf.freecol.common.debug.FreeColDebugger;
import net.sf.freecol.common.i18n.Messages;
import net.sf.freecol.common.model.Ability;
import net.sf.freecol.common.model.AbstractGoods;
import net.sf.freecol.common.model.Building;
import net.sf.freecol.common.model.Colony;
import net.sf.freecol.common.model.Europe;
import net.sf.freecol.common.model.GameOptions;
import net.sf.freecol.common.model.Goods;
import net.sf.freecol.common.model.GoodsContainer;
import net.sf.freecol.common.model.GoodsType;
import net.sf.freecol.common.model.Location;
import net.sf.freecol.common.model.Player;
import net.sf.freecol.common.model.Specification;
import net.sf.freecol.common.model.StringTemplate;
import net.sf.freecol.common.model.Tile;
import net.sf.freecol.common.model.Role;
import net.sf.freecol.common.model.Unit;
import net.sf.freecol.common.model.Unit.UnitState;
import net.sf.freecol.common.model.UnitLocation;
import net.sf.freecol.common.model.UnitType;
import net.sf.freecol.common.model.UnitTypeChange.ChangeType;
import net.sf.freecol.common.model.WorkLocation;
import static net.sf.freecol.common.util.CollectionUtils.*;


/**
 * Handles the generation of popup menu's generated by DragListener
 * objects attached to units within the Colony and Europe panels.
 * @author Brian
 */
public final class QuickActionMenu extends JPopupMenu {

<span class="nc" id="L83">    private static final Logger logger = Logger.getLogger(QuickActionMenu.class.getName());</span>

    private final FreeColClient freeColClient;

    private final SwingGUI gui;

    private final FreeColPanel parentPanel;


    /**
     * Creates a standard empty menu
     *
     * @param freeColClient The enclosing &lt;code&gt;FreeColClient&lt;/code&gt;.
     * @param freeColPanel The parent &lt;code&gt;FreeColPanel&lt;/code&gt;.
     */
<span class="nc" id="L98">    public QuickActionMenu(FreeColClient freeColClient,</span>
                           FreeColPanel freeColPanel) {
<span class="nc" id="L100">        this.freeColClient = freeColClient;</span>
<span class="nc" id="L101">        this.gui = (SwingGUI)freeColClient.getGUI();</span>
<span class="nc" id="L102">        this.parentPanel = freeColPanel;</span>
<span class="nc" id="L103">    }</span>


    /**
     * Add specific menu items for a given component.
     *
     * @param comp The specific &lt;code&gt;JComponent&lt;/code&gt;.
     * @return This &lt;code&gt;QuickActionMenu&lt;/code&gt;.
     */
    public QuickActionMenu addMenuItems(JComponent comp) {
<span class="nc bnc" id="L113" title="All 2 branches missed.">        if (comp instanceof UnitLabel) {</span>
<span class="nc" id="L114">            createUnitMenu((UnitLabel)comp);</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">        } else if (comp instanceof GoodsLabel) {</span>
<span class="nc" id="L116">            createGoodsMenu((GoodsLabel)comp);</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">        } else if (comp instanceof MarketLabel) {</span>
<span class="nc" id="L118">            createMarketMenu((MarketLabel)comp);</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">        } else if (comp instanceof ASingleTilePanel) {</span>
<span class="nc" id="L120">            createTileMenu((ASingleTilePanel)comp);</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">        } else if (comp.getParent() instanceof ASingleTilePanel) {</span>
            // Also check the parent to show the popup in the
            // center of the colony panel tile.
<span class="nc" id="L124">            createTileMenu((ASingleTilePanel)comp.getParent());</span>
        }
<span class="nc" id="L126">        return this;</span>
    }

    /**
     * Prompt for an amount of goods to use.
     *
     * The amount is returned through the parameter amount.
     *
     * @param ag The &lt;code&gt;AbstractGoods&lt;/code&gt; to query.
     */
    private void promptForGoods(AbstractGoods ag) {
<span class="nc" id="L137">        int ret = gui.showSelectAmountDialog(ag.getType(),</span>
<span class="nc" id="L138">                                             GoodsContainer.CARGO_SIZE,</span>
<span class="nc" id="L139">                                             ag.getAmount(), true);</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">        if (ret &gt; 0) ag.setAmount(ret);</span>
<span class="nc" id="L141">    }</span>

    /**
     * Creates a popup menu for a Unit.
     *
     * @param unitLabel The &lt;code&gt;UnitLabel&lt;/code&gt; to create items for.
     */
    private void createUnitMenu(final UnitLabel unitLabel) {
<span class="nc" id="L149">        final Unit unit = unitLabel.getUnit();</span>

<span class="nc" id="L151">        this.setLabel(&quot;Unit&quot;);</span>
<span class="nc" id="L152">        ImageIcon unitIcon = new ImageIcon(gui.getImageLibrary()</span>
<span class="nc" id="L153">            .getSmallUnitImage(unit));</span>
<span class="nc" id="L154">        JMenuItem name = new JMenuItem(unit.getDescription(Unit.UnitLabelType.NATIONAL)</span>
<span class="nc" id="L155">            + &quot; (&quot; + Messages.message(&quot;colopedia&quot;) + &quot;)&quot;, unitIcon);</span>
<span class="nc" id="L156">        name.setActionCommand(UnitAction.COLOPEDIA.toString());</span>
<span class="nc" id="L157">        name.addActionListener(unitLabel);</span>
<span class="nc" id="L158">        this.add(name);</span>
<span class="nc" id="L159">        this.addSeparator();</span>

<span class="nc bnc" id="L161" title="All 2 branches missed.">        if (addCarrierItems(unitLabel)) this.addSeparator();</span>

<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (unit.isInEurope()) {</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">            if (addCommandItems(unitLabel)) this.addSeparator();</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">            if (addBoardItems(unitLabel, unit.getOwner().getEurope())) {</span>
<span class="nc" id="L166">                this.addSeparator();</span>
            }
<span class="nc bnc" id="L168" title="All 2 branches missed.">        } else if (unit.hasTile()) {</span>
<span class="nc" id="L169">            Colony colony = unit.getLocation().getTile().getColony();</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">            if (colony != null) {</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">                if (addTileItem(unitLabel)) this.addSeparator();</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">                if (addWorkItems(unitLabel)) this.addSeparator();</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">                if (addEducationItems(unitLabel)) this.addSeparator();</span>
<span class="nc bnc" id="L174" title="All 4 branches missed.">                if (unit.isInColony() &amp;&amp; colony.canReducePopulation()) {</span>
<span class="nc" id="L175">                    JMenuItem menuItem = Utility.localizedMenuItem(&quot;quickActionMenu.leaveTown&quot;);</span>
<span class="nc" id="L176">                    menuItem.setActionCommand(UnitAction.LEAVE_TOWN.toString());</span>
<span class="nc" id="L177">                    menuItem.addActionListener(unitLabel);</span>
<span class="nc" id="L178">                    this.add(menuItem);</span>
<span class="nc" id="L179">                    addBoardItems(unitLabel, colony.getTile());</span>
<span class="nc" id="L180">                    this.addSeparator();</span>
<span class="nc" id="L181">                } else {</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">                    if (addCommandItems(unitLabel)) this.addSeparator();</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">                    if (addBoardItems(unitLabel, colony.getTile())) {</span>
<span class="nc" id="L184">                        this.addSeparator();</span>
                    }
                }
<span class="nc" id="L187">            } else {</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">                if (addCommandItems(unitLabel)) this.addSeparator();</span>
            }
        }

<span class="nc bnc" id="L192" title="All 2 branches missed.">        if (unit.hasAbility(Ability.CAN_BE_EQUIPPED)) {</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">            if (addRoleItems(unitLabel)) this.addSeparator();</span>
        }
<span class="nc" id="L195">    }</span>

    private boolean addBoardItems(final UnitLabel unitLabel, Location loc) {
<span class="nc" id="L198">        final InGameController igc = freeColClient.getInGameController();</span>
<span class="nc" id="L199">        final Unit tempUnit = unitLabel.getUnit();</span>

<span class="nc bnc" id="L201" title="All 2 branches missed.">        if (tempUnit.isCarrier()) return false;</span>
<span class="nc" id="L202">        boolean added = false;</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">        for (final Unit unit : loc.getUnitList()) {</span>
<span class="nc bnc" id="L204" title="All 4 branches missed.">            if (unit.isCarrier() &amp;&amp; unit.canCarryUnits()</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">                &amp;&amp; unit.canAdd(tempUnit)</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">                &amp;&amp; tempUnit.getLocation() != unit) {</span>
<span class="nc" id="L207">                StringTemplate template = StringTemplate.template(&quot;quickActionMenu.board&quot;)</span>
<span class="nc" id="L208">                    .addStringTemplate(&quot;%unit%&quot;,</span>
<span class="nc" id="L209">                        unit.getLabel(Unit.UnitLabelType.NATIONAL));</span>
<span class="nc" id="L210">                JMenuItem menuItem = Utility.localizedMenuItem(template);</span>
<span class="nc" id="L211">                menuItem.addActionListener((ActionEvent ae) -&gt; {</span>
<span class="nc" id="L212">                        igc.boardShip(tempUnit, unit);</span>
<span class="nc" id="L213">                    });</span>
<span class="nc" id="L214">                this.add(menuItem);</span>
<span class="nc" id="L215">                added = true;</span>
            }
        }
<span class="nc" id="L218">        return added;</span>
    }

    private boolean addLoadItems(final Goods goods, Location loc) {
<span class="nc" id="L222">        final InGameController igc = freeColClient.getInGameController();</span>

<span class="nc" id="L224">        boolean added = false;</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">        for (final Unit unit : loc.getUnitList()) {</span>
<span class="nc bnc" id="L226" title="All 4 branches missed.">            if (unit.isCarrier() &amp;&amp; unit.canCarryGoods()</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">                &amp;&amp; unit.canAdd(goods)) {</span>
<span class="nc" id="L228">                StringTemplate template = StringTemplate.template(&quot;quickActionMenu.loadOnTo&quot;)</span>
<span class="nc" id="L229">                    .addStringTemplate(&quot;%unit%&quot;,</span>
<span class="nc" id="L230">                        unit.getLabel(Unit.UnitLabelType.NATIONAL));</span>
<span class="nc" id="L231">                JMenuItem menuItem = Utility.localizedMenuItem(template);</span>
<span class="nc" id="L232">                menuItem.addActionListener((ActionEvent ae) -&gt; {</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">                        if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) != 0) {</span>
<span class="nc" id="L234">                            promptForGoods(goods);</span>
                        }
<span class="nc" id="L236">                        igc.loadCargo(goods, unit);</span>
<span class="nc" id="L237">                    });</span>
<span class="nc" id="L238">                this.add(menuItem);</span>
<span class="nc" id="L239">                added = true;</span>
            }
        }
<span class="nc" id="L242">        return added;</span>
    }

    private boolean addCarrierItems(final UnitLabel unitLabel) {
<span class="nc" id="L246">        final Unit unit = unitLabel.getUnit();</span>
<span class="nc bnc" id="L247" title="All 4 branches missed.">        if (!unit.isCarrier() || !unit.hasCargo()) return false;</span>

<span class="nc" id="L249">        JMenuItem cargo = Utility.localizedMenuItem(&quot;cargoOnCarrier&quot;);</span>
<span class="nc" id="L250">        this.add(cargo);</span>

<span class="nc bnc" id="L252" title="All 2 branches missed.">        for (Unit passenger : unit.getUnitList()) {</span>
<span class="nc" id="L253">            JMenuItem menuItem = new JMenuItem(&quot;    &quot;</span>
<span class="nc" id="L254">                + passenger.getDescription(Unit.UnitLabelType.NATIONAL));</span>
<span class="nc" id="L255">            menuItem.setFont(menuItem.getFont().deriveFont(Font.ITALIC));</span>
<span class="nc" id="L256">            this.add(menuItem);</span>
        }
<span class="nc bnc" id="L258" title="All 2 branches missed.">        for (Goods goods : unit.getGoodsList()) {</span>
<span class="nc" id="L259">            JMenuItem menuItem = new JMenuItem(&quot;    &quot;</span>
<span class="nc" id="L260">                + Messages.message(goods.getLabel(true)));</span>
<span class="nc" id="L261">            menuItem.setFont(menuItem.getFont().deriveFont(Font.ITALIC));</span>
<span class="nc" id="L262">            this.add(menuItem);</span>
        }
<span class="nc" id="L264">        return true;</span>
    }

    private List&lt;JMenuItem&gt; descendingList(final Map&lt;JMenuItem, Integer&gt; map) {
<span class="nc" id="L268">        final Comparator&lt;JMenuItem&gt; comp</span>
<span class="nc" id="L269">            = Comparator.comparingInt((JMenuItem k) -&gt; map.get(k))</span>
<span class="nc" id="L270">                .reversed()</span>
<span class="nc" id="L271">                .thenComparing(JMenuItem::getText);</span>
<span class="nc" id="L272">        return toSortedList(map.keySet(), comp);</span>
    }

    private JMenuItem makeProductionItem(GoodsType type, WorkLocation wl,
                                         int amount, UnitLabel unitLabel,
                                         boolean claim) {
<span class="nc" id="L278">        StringTemplate t = StringTemplate.template(type.getId() + &quot;.workAs&quot;)</span>
<span class="nc" id="L279">            .addAmount(&quot;%amount%&quot;, amount);</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">        if (claim) {</span>
<span class="nc" id="L281">            t.addStringTemplate(&quot;%claim%&quot;, wl.getClaimTemplate());</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">        } else if (FreeColDebugger.isInDebugMode(FreeColDebugger.DebugMode.MENUS)) {</span>
<span class="nc" id="L283">            t.addStringTemplate(&quot;%claim%&quot;, wl.getLocationLabel());</span>
<span class="nc" id="L284">        } else {</span>
<span class="nc" id="L285">            t.addName(&quot;%claim%&quot;, &quot;&quot;);</span>
        }
<span class="nc" id="L287">        JMenuItem menuItem = Utility.localizedMenuItem(t,</span>
<span class="nc" id="L288">            new ImageIcon(gui.getImageLibrary().getSmallIconImage(type)));</span>
<span class="nc" id="L289">        menuItem.setActionCommand(UnitLabel.getWorkLabel(wl)</span>
<span class="nc" id="L290">            + &quot;/&quot; + wl.getId() + &quot;/&quot; + type.getId()</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">            + &quot;/&quot; + ((claim) ? &quot;!&quot; : &quot;&quot;));</span>
<span class="nc" id="L292">        menuItem.addActionListener(unitLabel);</span>
<span class="nc" id="L293">        return menuItem;</span>
    }

    private boolean addWorkItems(final UnitLabel unitLabel) {
<span class="nc" id="L297">        final Unit unit = unitLabel.getUnit();</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">        if (unit.isCarrier()) return false;</span>

<span class="nc" id="L300">        final UnitType unitType = unit.getType();</span>
<span class="nc" id="L301">        final GoodsType expertGoods = unitType.getExpertProduction();</span>
<span class="nc" id="L302">        final Colony colony = unit.getLocation().getColony();</span>
<span class="nc" id="L303">        final Specification spec = freeColClient.getGame().getSpecification();</span>
<span class="nc" id="L304">        final WorkLocation current = unit.getWorkLocation();</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">        final int bonusChange = (current != null) ? 0</span>
<span class="nc" id="L306">            : colony.governmentChange(colony.getUnitCount() + 1);</span>
<span class="nc" id="L307">        final int bonus = colony.getProductionBonus();</span>

<span class="nc" id="L309">        Map&lt;JMenuItem, Integer&gt; items = new HashMap&lt;&gt;();</span>
<span class="nc" id="L310">        Map&lt;JMenuItem, Integer&gt; extras = new HashMap&lt;&gt;();</span>
<span class="nc" id="L311">        JMenuItem expertOwned = null;</span>
<span class="nc" id="L312">        JMenuItem expertUnowned = null;</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">        for (GoodsType type : spec.getGoodsTypeList()) {</span>
<span class="nc" id="L314">            int bestOwnedProd = bonus + bonusChange,</span>
<span class="nc" id="L315">                bestUnownedProd = bonus + bonusChange;</span>
<span class="nc" id="L316">            WorkLocation bestOwned = null, bestUnowned = null;</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">            for (WorkLocation wl : colony.getAllWorkLocations()) {</span>
<span class="nc" id="L318">                int prod = 0;</span>
<span class="nc bnc" id="L319" title="All 4 branches missed.">                switch (wl.getNoAddReason(unit)) {</span>
                case NONE:
<span class="nc" id="L321">                    prod = wl.getPotentialProduction(type, unitType);</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">                    if (bestOwnedProd &lt; prod) {</span>
<span class="nc" id="L323">                        bestOwnedProd = prod;</span>
<span class="nc" id="L324">                        bestOwned = wl;</span>
                    }
<span class="nc" id="L326">                    break;</span>
                case ALREADY_PRESENT:
<span class="nc" id="L328">                    prod = wl.getPotentialProduction(type, unitType);</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">                    if (bestOwnedProd &lt; prod) {</span>
<span class="nc" id="L330">                        bestOwnedProd = prod;</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">                        bestOwned = (unit.getWorkType() == type) ? null : wl;</span>
                    }
<span class="nc" id="L333">                    break;</span>
                case CLAIM_REQUIRED:
<span class="nc" id="L335">                    prod = wl.getPotentialProduction(type, unitType);</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">                    if (bestUnownedProd &lt; prod) {</span>
<span class="nc" id="L337">                        bestUnownedProd = prod;</span>
<span class="nc" id="L338">                        bestUnowned = wl;</span>
                    }
<span class="nc" id="L340">                    break;</span>
                default:
                    break;
                }
            }
<span class="nc bnc" id="L345" title="All 4 branches missed.">            if (bestOwned != null &amp;&amp; bestOwnedProd &gt; 0) {</span>
<span class="nc" id="L346">                JMenuItem ji = makeProductionItem(type, bestOwned,</span>
<span class="nc" id="L347">                    bestOwnedProd, unitLabel, false);</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">                if (type == expertGoods) {</span>
<span class="nc" id="L349">                    expertOwned = ji;</span>
<span class="nc" id="L350">                } else {</span>
<span class="nc" id="L351">                    items.put(ji, bestOwnedProd);</span>
                }
            }
<span class="nc bnc" id="L354" title="All 4 branches missed.">            if (bestUnowned != null &amp;&amp; bestUnownedProd &gt; bestOwnedProd</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">                &amp;&amp; bestUnownedProd &gt; 0) {</span>
<span class="nc" id="L356">                JMenuItem ji = makeProductionItem(type, bestUnowned,</span>
<span class="nc" id="L357">                    bestUnownedProd, unitLabel, true);</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">                if (type == expertGoods) {</span>
<span class="nc" id="L359">                    expertUnowned = ji;</span>
<span class="nc" id="L360">                } else {</span>
<span class="nc" id="L361">                    extras.put(ji, bestUnownedProd);</span>
                }
            }
        }

<span class="nc" id="L366">        JMenu container = Utility.localizedMenu(&quot;quickActionMenu.changeWork&quot;);</span>
<span class="nc" id="L367">        List&lt;JMenuItem&gt; owned = descendingList(items);</span>
<span class="nc bnc" id="L368" title="All 2 branches missed.">        if (expertOwned != null) owned.add(0, expertOwned);</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">        for (JMenuItem j : owned) container.add(j);</span>
<span class="nc" id="L370">        List&lt;JMenuItem&gt; unowned = descendingList(extras);</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">        if (expertUnowned != null) unowned.add(0, expertUnowned);</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">        if (!unowned.isEmpty()) {</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">            if (!owned.isEmpty()) container.addSeparator();</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">            for (JMenuItem j : unowned) container.add(j);</span>
        }
<span class="nc bnc" id="L376" title="All 2 branches missed.">        if (container.getItemCount() &gt; 0) this.add(container);</span>

<span class="nc bnc" id="L378" title="All 4 branches missed.">        if (current != null &amp;&amp; unit.getWorkType() != null) {</span>
<span class="nc" id="L379">            JMenuItem ji = Utility.localizedMenuItem(&quot;showProductionModifiers&quot;);</span>
<span class="nc" id="L380">            ji.addActionListener((ActionEvent ae) -&gt; {</span>
<span class="nc" id="L381">                    gui.showWorkProductionPanel(unit);</span>
<span class="nc" id="L382">                });</span>
<span class="nc" id="L383">            this.add(ji);</span>
        }
<span class="nc bnc" id="L385" title="All 6 branches missed.">        return !(owned.isEmpty() &amp;&amp; unowned.isEmpty() &amp;&amp; current == null);</span>
    }

    private boolean addEducationItems(final UnitLabel unitLabel) {
<span class="nc" id="L389">        boolean separatorNeeded = false;</span>
<span class="nc" id="L390">        Unit unit = unitLabel.getUnit();</span>

<span class="nc" id="L392">        ImageLibrary lib = gui.getImageLibrary();</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">        if (unit.getSpecification().getBoolean(GameOptions.ALLOW_STUDENT_SELECTION)) {</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">            for (Unit teacher : unit.getColony().getTeachers()) {</span>
<span class="nc bnc" id="L395" title="All 4 branches missed.">                if (unit.canBeStudent(teacher) &amp;&amp; unit.isInColony()) {</span>
<span class="nc" id="L396">                    JMenuItem menuItem = null;</span>
<span class="nc" id="L397">                    ImageIcon teacherIcon = new ImageIcon(lib.getSmallerUnitImage(teacher));</span>
<span class="nc bnc" id="L398" title="All 2 branches missed.">                    if (teacher.getStudent() != unit) {</span>
<span class="nc" id="L399">                        menuItem = Utility.localizedMenuItem(&quot;quickActionMenu.assignToTeacher&quot;,</span>
<span class="nc" id="L400">                                                         teacherIcon);</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">                        if (teacher.getStudent() != null) {</span>
<span class="nc" id="L402">                            menuItem.setText(menuItem.getText()</span>
<span class="nc" id="L403">                                + &quot; (&quot; + teacher.getTurnsOfTraining()</span>
<span class="nc" id="L404">                                + &quot;/&quot; + teacher.getNeededTurnsOfTraining()</span>
<span class="nc" id="L405">                                + &quot;)&quot;);</span>
                        }
<span class="nc" id="L407">                        menuItem.setActionCommand(UnitAction.ASSIGN + &quot;/&quot; + teacher.getId());</span>
<span class="nc" id="L408">                        menuItem.addActionListener(unitLabel);</span>
<span class="nc" id="L409">                    } else {</span>
<span class="nc" id="L410">                        menuItem = Utility.localizedMenuItem(StringTemplate</span>
<span class="nc" id="L411">                            .template(&quot;quickActionMenu.apprentice&quot;)</span>
<span class="nc" id="L412">                            .addName(&quot;%unit%&quot;,</span>
<span class="nc" id="L413">                                Messages.getName(teacher.getType())),</span>
<span class="nc" id="L414">                            teacherIcon);</span>
<span class="nc" id="L415">                        menuItem.setText(menuItem.getText()</span>
<span class="nc" id="L416">                            + &quot;: &quot; + teacher.getTurnsOfTraining()</span>
<span class="nc" id="L417">                            + &quot;/&quot; + teacher.getNeededTurnsOfTraining());</span>
<span class="nc" id="L418">                        menuItem.setEnabled(false);</span>
                    }
<span class="nc" id="L420">                    this.add(menuItem);</span>
<span class="nc" id="L421">                    separatorNeeded = true;</span>
                }
            }
        }
<span class="nc bnc" id="L425" title="All 2 branches missed.">        if (unit.getStudent() != null) {</span>
<span class="nc" id="L426">            Unit student = unit.getStudent();</span>
<span class="nc" id="L427">            JMenuItem menuItem = Utility.localizedMenuItem(StringTemplate</span>
<span class="nc" id="L428">                .template(&quot;quickActionMenu.teaching&quot;)</span>
<span class="nc" id="L429">                .addName(&quot;%unit%&quot;, Messages.getName(student.getType())));</span>
<span class="nc" id="L430">            menuItem.setText(menuItem.getText() </span>
<span class="nc" id="L431">                + &quot;: &quot; + unit.getTurnsOfTraining()</span>
<span class="nc" id="L432">                + &quot;/&quot; + unit.getNeededTurnsOfTraining());</span>
<span class="nc" id="L433">            menuItem.setEnabled(false);</span>
<span class="nc" id="L434">            this.add(menuItem);</span>
<span class="nc" id="L435">            separatorNeeded = true;</span>
        }
<span class="nc" id="L437">        int experience = unit.getExperience();</span>
<span class="nc" id="L438">        GoodsType goods = unit.getExperienceType();</span>
<span class="nc bnc" id="L439" title="All 4 branches missed.">        if (experience &gt; 0 &amp;&amp; goods != null) {</span>
<span class="nc" id="L440">            UnitType expertType = freeColClient.getGame()</span>
<span class="nc" id="L441">                .getSpecification().getExpertForProducing(goods);</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">            if (unit.getType().canBeUpgraded(expertType, ChangeType.EXPERIENCE)) {</span>
<span class="nc" id="L443">                int maxExperience = unit.getType().getMaximumExperience();</span>
<span class="nc" id="L444">                double probability = unit.getType().getUnitTypeChange(expertType)</span>
<span class="nc" id="L445">                    .getProbability(ChangeType.EXPERIENCE) * experience / (double) maxExperience;</span>
<span class="nc" id="L446">                String jobName = Messages.message(goods.getWorkingAsKey());</span>
<span class="nc" id="L447">                JPanel experiencePanel = new MigPanel();</span>
<span class="nc" id="L448">                experiencePanel.setLayout(new MigLayout(&quot;wrap 3&quot;));</span>
<span class="nc" id="L449">                experiencePanel.add(new JLabel(new ImageIcon(</span>
<span class="nc" id="L450">                        lib.getSmallerUnitImage(expertType))),</span>
<span class="nc" id="L451">                    &quot;spany 2&quot;);</span>
<span class="nc" id="L452">                experiencePanel.add(Utility.localizedLabel(StringTemplate</span>
<span class="nc" id="L453">                        .template(&quot;quickActionMenu.experience&quot;)</span>
<span class="nc" id="L454">                        .addName(&quot;%job%&quot;, jobName)));</span>
<span class="nc" id="L455">                experiencePanel.add(Utility.localizedLabel(StringTemplate</span>
<span class="nc" id="L456">                        .label(&quot;/&quot;)</span>
<span class="nc" id="L457">                        .addName(String.valueOf(experience))</span>
<span class="nc" id="L458">                        .addName(String.valueOf(maxExperience))),</span>
<span class="nc" id="L459">                    &quot;align right&quot;);</span>
<span class="nc" id="L460">                experiencePanel.add(Utility.localizedLabel(&quot;quickActionMenu.upgrade&quot;));</span>
<span class="nc" id="L461">                experiencePanel.add(new JLabel(ModifierFormat.format(probability) + &quot;%&quot;),</span>
<span class="nc" id="L462">                                    &quot;align right&quot;);</span>
<span class="nc" id="L463">                this.add(experiencePanel);</span>
<span class="nc" id="L464">                separatorNeeded = true;</span>
            }
        }
<span class="nc" id="L467">        return separatorNeeded;</span>
    }

    private boolean addCommandItems(final UnitLabel unitLabel) {
<span class="nc" id="L471">        final Unit tempUnit = unitLabel.getUnit();</span>
<span class="nc" id="L472">        final boolean isUnitAtSea = tempUnit.isAtSea();</span>

<span class="nc" id="L474">        JMenuItem menuItem = Utility.localizedMenuItem(&quot;activateUnit&quot;);</span>
<span class="nc" id="L475">        menuItem.addActionListener((ActionEvent ae) -&gt; {</span>
<span class="nc bnc" id="L476" title="All 2 branches missed.">                if (tempUnit.getState() != Unit.UnitState.ACTIVE) {</span>
<span class="nc" id="L477">                    freeColClient.getInGameController()</span>
<span class="nc" id="L478">                        .changeState(tempUnit, Unit.UnitState.ACTIVE);</span>
                }
<span class="nc" id="L480">                gui.setActiveUnit(tempUnit);</span>
<span class="nc" id="L481">            });</span>
<span class="nc bnc" id="L482" title="All 2 branches missed.">        menuItem.setEnabled(!isUnitAtSea);</span>
<span class="nc" id="L483">        this.add(menuItem);</span>

<span class="nc bnc" id="L485" title="All 2 branches missed.">        if (!(tempUnit.getLocation() instanceof Europe)) {</span>
<span class="nc" id="L486">            menuItem = Utility.localizedMenuItem(&quot;fortify&quot;);</span>
<span class="nc" id="L487">            menuItem.setActionCommand(UnitAction.FORTIFY.toString());</span>
<span class="nc" id="L488">            menuItem.addActionListener(unitLabel);</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">            menuItem.setEnabled((tempUnit.getMovesLeft() &gt; 0)</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">                &amp;&amp; !(tempUnit.getState() == Unit.UnitState.FORTIFIED</span>
<span class="nc bnc" id="L491" title="All 2 branches missed.">                    || tempUnit.getState() == Unit.UnitState.FORTIFYING));</span>
<span class="nc" id="L492">            this.add(menuItem);</span>
        }

<span class="nc" id="L495">        UnitState unitState = tempUnit.getState();</span>
<span class="nc" id="L496">        menuItem = Utility.localizedMenuItem(&quot;sentry&quot;);</span>
<span class="nc" id="L497">        menuItem.setActionCommand(UnitAction.SENTRY.toString());</span>
<span class="nc" id="L498">        menuItem.addActionListener(unitLabel);</span>
<span class="nc bnc" id="L499" title="All 2 branches missed.">        menuItem.setEnabled(unitState != Unit.UnitState.SENTRY</span>
<span class="nc bnc" id="L500" title="All 2 branches missed.">            &amp;&amp; !isUnitAtSea);</span>
<span class="nc" id="L501">        this.add(menuItem);</span>

<span class="nc bnc" id="L503" title="All 2 branches missed.">        boolean hasTradeRoute = tempUnit.getTradeRoute() != null;</span>
<span class="nc" id="L504">        menuItem = Utility.localizedMenuItem(&quot;clearOrders&quot;);</span>
<span class="nc" id="L505">        menuItem.setActionCommand(UnitAction.CLEAR_ORDERS.toString());</span>
<span class="nc" id="L506">        menuItem.addActionListener(unitLabel);</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">        menuItem.setEnabled((unitState != Unit.UnitState.ACTIVE</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">                || hasTradeRoute)</span>
<span class="nc bnc" id="L509" title="All 2 branches missed.">            &amp;&amp; !isUnitAtSea);</span>
<span class="nc" id="L510">        this.add(menuItem);</span>

<span class="nc bnc" id="L512" title="All 2 branches missed.">        if (tempUnit.isCarrier()) {</span>
<span class="nc" id="L513">            menuItem = Utility.localizedMenuItem(&quot;assignTradeRoute&quot;);</span>
<span class="nc" id="L514">            menuItem.setActionCommand(UnitAction.ASSIGN_TRADE_ROUTE.toString());</span>
<span class="nc" id="L515">            menuItem.addActionListener(unitLabel);</span>
<span class="nc bnc" id="L516" title="All 2 branches missed.">            menuItem.setEnabled(!hasTradeRoute);</span>
<span class="nc" id="L517">            this.add(menuItem);</span>
        }

<span class="nc bnc" id="L520" title="All 4 branches missed.">        if (tempUnit.canCarryTreasure() &amp;&amp; tempUnit.canCashInTreasureTrain()) {</span>
<span class="nc" id="L521">            menuItem = Utility.localizedMenuItem(&quot;cashInTreasureTrain&quot;);</span>
<span class="nc" id="L522">            menuItem.addActionListener((ActionEvent ae) -&gt; {</span>
<span class="nc" id="L523">                    freeColClient.getInGameController()</span>
<span class="nc" id="L524">                        .checkCashInTreasureTrain(tempUnit);</span>
<span class="nc" id="L525">                });</span>
<span class="nc" id="L526">            menuItem.setEnabled(true);</span>
<span class="nc" id="L527">            this.add(menuItem);</span>
        }

<span class="nc bnc" id="L530" title="All 2 branches missed.">        if (tempUnit.getLocation() instanceof Unit) {</span>
<span class="nc" id="L531">            menuItem = Utility.localizedMenuItem(&quot;leaveShip&quot;);</span>
<span class="nc" id="L532">            menuItem.setActionCommand(UnitAction.LEAVE_SHIP.toString());</span>
<span class="nc" id="L533">            menuItem.addActionListener(unitLabel);</span>
<span class="nc" id="L534">            menuItem.setEnabled(true);</span>
<span class="nc" id="L535">            this.add(menuItem);</span>
        }

<span class="nc bnc" id="L538" title="All 2 branches missed.">        if (tempUnit.isCarrier()) {</span>
<span class="nc" id="L539">            menuItem = Utility.localizedMenuItem(&quot;unload&quot;);</span>
<span class="nc" id="L540">            menuItem.setActionCommand(UnitAction.UNLOAD.toString());</span>
<span class="nc" id="L541">            menuItem.addActionListener(unitLabel);</span>
<span class="nc bnc" id="L542" title="All 4 branches missed.">            menuItem.setEnabled(tempUnit.hasCargo() &amp;&amp; !isUnitAtSea);</span>
<span class="nc" id="L543">            this.add(menuItem);</span>
        }

<span class="nc" id="L546">        return true;</span>
    }

    /**
     * Nasty hack to get menu item to change roles.
     *
     * Hacky because we are continuing to express this in terms of equipment
     * changes despite the point of the role cutover was to get rid of
     * equipment types.  However, its time to release, and we should avoid
     * string changes.  Get rid of this post 0.11.0-release.
     *
     * @param unitLabel The &lt;code&gt;UnitLabel&lt;/code&gt; to create items for.
     * @param from The starting &lt;code&gt;Role&lt;/code&gt;.
     * @param fromCount The starting role count.
     * @param to The new &lt;code&gt;Role&lt;/code&gt;.
     * @param toCount The new role count.
     * @param price An optional price to charge for the change.
     * @return A suitable menu item.
     */
    private JMenuItem createRoleItem(final UnitLabel unitLabel,
                                     final Role from, final int fromCount, 
                                     final Role to, final int toCount,
                                     final int price) {
        // Get the text
<span class="nc" id="L570">        String key = &quot;model.role.change.&quot; + to.getSuffix();</span>
<span class="nc bnc" id="L571" title="All 2 branches missed.">        if (!Messages.containsKey(key)) {</span>
            // Fall back to the full &quot;from&quot;.&quot;to&quot; key
<span class="nc" id="L573">            key = &quot;model.role.change.&quot; + from.getSuffix()</span>
<span class="nc" id="L574">                + &quot;.&quot; + to.getSuffix();</span>
        }
<span class="nc" id="L576">        String text = Messages.message(key);</span>
<span class="nc bnc" id="L577" title="All 2 branches missed.">        if (price &gt; 0) {</span>
<span class="nc" id="L578">            text += &quot; (&quot;</span>
<span class="nc" id="L579">                + Messages.message(StringTemplate.template(&quot;goldAmount&quot;)</span>
<span class="nc" id="L580">                    .addAmount(&quot;%amount%&quot;, price))</span>
<span class="nc" id="L581">                + &quot;)&quot;;</span>
        }

        // Get an icon
<span class="nc" id="L585">        AbstractGoods change = null;</span>
<span class="nc" id="L586">        List&lt;AbstractGoods&gt; need = Role.getGoodsDifference(from, fromCount,</span>
<span class="nc" id="L587">                                                           to, toCount);</span>
<span class="nc bnc" id="L588" title="All 3 branches missed.">        switch (need.size()) {</span>
        case 0:
<span class="nc" id="L590">            break;</span>
        case 1:
<span class="nc" id="L592">            change = need.get(0);</span>
<span class="nc" id="L593">            break;</span>
        default:
<span class="nc bnc" id="L595" title="All 2 branches missed.">            change = find(need, ag -&gt; ag.getAmount() &gt; 0);</span>
            break;
        }
<span class="nc bnc" id="L598" title="All 2 branches missed.">        Icon icon = (change == null) ? null : new ImageIcon(</span>
<span class="nc" id="L599">            gui.getImageLibrary().getSmallIconImage(change.getType()));</span>

<span class="nc" id="L601">        JMenuItem item = new JMenuItem(text, icon);</span>
<span class="nc" id="L602">        final InGameController igc = freeColClient.getInGameController();</span>
<span class="nc" id="L603">        item.addActionListener((ActionEvent ae) -&gt; {</span>
<span class="nc" id="L604">                igc.equipUnitForRole(unitLabel.getUnit(), to, toCount);</span>
<span class="nc" id="L605">                unitLabel.updateIcon();</span>
                // FIXME: fix the PCL handling so this can go away
<span class="nc bnc" id="L607" title="All 2 branches missed.">                if (parentPanel instanceof ColonyPanel) {</span>
<span class="nc" id="L608">                    ((ColonyPanel)parentPanel).update();</span>
                }
<span class="nc" id="L610">            });</span>
<span class="nc" id="L611">        return item;</span>
    }

    /**
     * Add menu items for role manipulation for a unit.
     *
     * Note &quot;clear speciality&quot; is here too to keep it well separated from
     * other items.
     *
     * @param unitLabel The &lt;code&gt;UnitLabel&lt;/code&gt; specifying the unit.
     * @return True if menu items were added and a separator is now needed.
     */
    private boolean addRoleItems(final UnitLabel unitLabel) {
<span class="nc" id="L624">        final Unit unit = unitLabel.getUnit();</span>
<span class="nc" id="L625">        final Role role = unit.getRole();</span>
<span class="nc" id="L626">        final int roleCount = unit.getRoleCount();</span>
<span class="nc" id="L627">        boolean separatorNeeded = false;</span>

<span class="nc bnc" id="L629" title="All 2 branches missed.">        UnitLocation uloc = (unit.isInEurope()) ? unit.getOwner().getEurope()</span>
<span class="nc" id="L630">            : unit.getSettlement();</span>
<span class="nc bnc" id="L631" title="All 2 branches missed.">        if (uloc == null) return false;</span>
<span class="nc bnc" id="L632" title="All 2 branches missed.">        for (Role r : unit.getAvailableRoles(null)) {</span>
<span class="nc bnc" id="L633" title="All 2 branches missed.">            if (r == role) continue;</span>
            JMenuItem newItem;
<span class="nc bnc" id="L635" title="All 2 branches missed.">            if (r.isDefaultRole()) { // Always valid</span>
<span class="nc" id="L636">                newItem = createRoleItem(unitLabel, role, roleCount, r, 0, 0);</span>
<span class="nc" id="L637">            } else {</span>
<span class="nc" id="L638">                newItem = null;</span>
<span class="nc bnc" id="L639" title="All 2 branches missed.">                for (int count = r.getMaximumCount(); count &gt; 0; count--) {</span>
<span class="nc" id="L640">                    List&lt;AbstractGoods&gt; req = unit.getGoodsDifference(r, count);</span>
<span class="nc" id="L641">                    int price = uloc.priceGoods(req);</span>
<span class="nc bnc" id="L642" title="All 2 branches missed.">                    if (price &lt; 0) continue;</span>
<span class="nc bnc" id="L643" title="All 2 branches missed.">                    if (unit.getOwner().checkGold(price)) {</span>
<span class="nc" id="L644">                        newItem = createRoleItem(unitLabel, role, roleCount,</span>
<span class="nc" id="L645">                                                 r, count, price);</span>
<span class="nc" id="L646">                        break;</span>
                    }
                }
            }
<span class="nc bnc" id="L650" title="All 2 branches missed.">            if (newItem != null) {</span>
<span class="nc" id="L651">                this.add(newItem);</span>
<span class="nc" id="L652">                separatorNeeded = true;</span>
            }
        }

<span class="nc" id="L656">        UnitType newUnitType = unit.getType()</span>
<span class="nc" id="L657">            .getTargetType(ChangeType.CLEAR_SKILL, unit.getOwner());</span>
<span class="nc bnc" id="L658" title="All 2 branches missed.">        if (newUnitType != null) {</span>
<span class="nc bnc" id="L659" title="All 2 branches missed.">            if (separatorNeeded) this.addSeparator();</span>
<span class="nc" id="L660">            JMenuItem menuItem = Utility.localizedMenuItem(&quot;quickActionMenu.clearSpeciality&quot;,</span>
<span class="nc" id="L661">                new ImageIcon(</span>
<span class="nc" id="L662">                    gui.getImageLibrary().getTinyUnitImage(newUnitType)));</span>
<span class="nc" id="L663">            menuItem.setActionCommand(UnitAction.CLEAR_SPECIALITY.toString());</span>
<span class="nc" id="L664">            menuItem.addActionListener(unitLabel);</span>
<span class="nc" id="L665">            this.add(menuItem);</span>
<span class="nc bnc" id="L666" title="All 2 branches missed.">            if (unit.getLocation() instanceof Building</span>
<span class="nc bnc" id="L667" title="All 2 branches missed.">                &amp;&amp; !((Building)unit.getLocation()).canAddType(newUnitType)) {</span>
<span class="nc" id="L668">                menuItem.setEnabled(false);</span>
            }
<span class="nc" id="L670">            separatorNeeded = true;</span>
        }
<span class="nc" id="L672">        return separatorNeeded;</span>
    }


    /**
     * Creates a menu for some goods.
     *
     * @param goodsLabel The &lt;code&gt;GoodsLabel&lt;/code&gt; to create items for.
     */
    private void createGoodsMenu(final GoodsLabel goodsLabel) {
<span class="nc" id="L682">        final InGameController igc = freeColClient.getInGameController();</span>
<span class="nc" id="L683">        final Player player = freeColClient.getMyPlayer();</span>
<span class="nc" id="L684">        final Goods goods = goodsLabel.getGoods();</span>

<span class="nc" id="L686">        this.setLabel(Messages.message(&quot;cargo&quot;));</span>
<span class="nc" id="L687">        JMenuItem name = new JMenuItem(</span>
<span class="nc" id="L688">            Messages.getName(goods) + &quot; (&quot; + Messages.message(&quot;colopedia&quot;) + &quot;)&quot;,</span>
<span class="nc" id="L689">            new ImageIcon(</span>
<span class="nc" id="L690">                gui.getImageLibrary().getSmallIconImage(goods.getType())));</span>
<span class="nc" id="L691">        name.addActionListener((ActionEvent ae) -&gt; {</span>
<span class="nc" id="L692">                gui.showColopediaPanel(goods.getType().getId());</span>
<span class="nc" id="L693">            });</span>
<span class="nc" id="L694">        this.add(name);</span>

<span class="nc bnc" id="L696" title="All 2 branches missed.">        int amount = (player.getMarket() == null) ? 0</span>
<span class="nc" id="L697">            : player.getMarket().getSalePrice(goods.getType(), </span>
<span class="nc" id="L698">                                              goods.getAmount());</span>
<span class="nc bnc" id="L699" title="All 2 branches missed.">        if (amount &gt; 0) amount -= amount * player.getTax() / 100;</span>
<span class="nc bnc" id="L700" title="All 2 branches missed.">        if (amount &gt; 0) {</span>
<span class="nc" id="L701">            JMenuItem price = Utility.localizedMenuItem(StringTemplate</span>
<span class="nc" id="L702">                .template(&quot;quickActionMenu.profit&quot;)</span>
<span class="nc" id="L703">                .addAmount(&quot;%amount%&quot;, amount));</span>
<span class="nc" id="L704">            this.add(price);</span>
        }
        
<span class="nc bnc" id="L707" title="All 2 branches missed.">        if (goods.getLocation() instanceof Colony) {</span>
<span class="nc" id="L708">            Colony colony = (Colony)goods.getLocation();</span>
<span class="nc" id="L709">            addLoadItems(goods, colony.getTile());</span>

<span class="nc bnc" id="L711" title="All 2 branches missed.">        } else if (goods.getLocation() instanceof Europe) {</span>
<span class="nc" id="L712">            Europe europe = (Europe)goods.getLocation();</span>
<span class="nc" id="L713">            addLoadItems(goods, europe);</span>
<span class="nc bnc" id="L714" title="All 2 branches missed.">            if (!player.canTrade(goods.getType())) {</span>
<span class="nc" id="L715">                addPayArrears(goods.getType());</span>
            }

<span class="nc bnc" id="L718" title="All 2 branches missed.">        } else if (goods.getLocation() instanceof Unit) {</span>
<span class="nc" id="L719">            Unit carrier = (Unit)goods.getLocation();</span>

<span class="nc bnc" id="L721" title="All 2 branches missed.">            if (carrier.getLocation().getColony() != null</span>
<span class="nc bnc" id="L722" title="All 2 branches missed.">                || (carrier.isInEurope()</span>
<span class="nc bnc" id="L723" title="All 2 branches missed.">                    &amp;&amp; player.canTrade(goods.getType()))) {</span>
<span class="nc" id="L724">                JMenuItem unload = Utility.localizedMenuItem(&quot;unload&quot;);</span>
<span class="nc" id="L725">                unload.addActionListener((ActionEvent ae) -&gt; {</span>
<span class="nc bnc" id="L726" title="All 2 branches missed.">                        if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) != 0) {</span>
<span class="nc" id="L727">                            promptForGoods(goods);</span>
                        }
<span class="nc" id="L729">                        igc.unloadCargo(goods, false);</span>
<span class="nc" id="L730">                    });</span>
<span class="nc" id="L731">                this.add(unload);</span>
<span class="nc" id="L732">            } else {</span>
<span class="nc bnc" id="L733" title="All 2 branches missed.">                if (carrier.isInEurope()</span>
<span class="nc bnc" id="L734" title="All 2 branches missed.">                    &amp;&amp; !player.canTrade(goods.getType())) {</span>
<span class="nc" id="L735">                    addPayArrears(goods.getType());</span>
                }

<span class="nc" id="L738">                JMenuItem dump = Utility.localizedMenuItem(&quot;dumpCargo&quot;);</span>
<span class="nc" id="L739">                dump.addActionListener((ActionEvent ae) -&gt; {</span>
<span class="nc bnc" id="L740" title="All 2 branches missed.">                        if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) != 0) {</span>
<span class="nc" id="L741">                            promptForGoods(goods);</span>
                        }
<span class="nc" id="L743">                        igc.unloadCargo(goods, true);</span>
                        // FIXME: fix pcls so this hackery can go away
<span class="nc bnc" id="L745" title="All 2 branches missed.">                        if (parentPanel instanceof CargoPanel) {</span>
<span class="nc" id="L746">                            ((CargoPanel) parentPanel).initialize();</span>
                        }
<span class="nc" id="L748">                        parentPanel.revalidate();</span>
<span class="nc" id="L749">                    });</span>
<span class="nc" id="L750">                this.add(dump);</span>
            }
        }
<span class="nc" id="L753">    }</span>

    /**
     * Add an item to pay arrears on the given goods type.
     *
     * @param goodsType The &lt;code&gt;GoodsType&lt;/code&gt; to pay arrears on.
     */
    private void addPayArrears(final GoodsType goodsType) {
<span class="nc" id="L761">        final InGameController igc = freeColClient.getInGameController();</span>

<span class="nc" id="L763">        JMenuItem menuItem = Utility.localizedMenuItem(&quot;payArrears&quot;);</span>
<span class="nc" id="L764">        menuItem.addActionListener((ActionEvent ae) -&gt; {</span>
<span class="nc" id="L765">                igc.payArrears(goodsType);</span>
                // FIXME: fix pcls so this hackery can go away
<span class="nc bnc" id="L767" title="All 2 branches missed.">                if (parentPanel instanceof CargoPanel) {</span>
<span class="nc" id="L768">                    CargoPanel cargoPanel = (CargoPanel) parentPanel;</span>
<span class="nc" id="L769">                    cargoPanel.initialize();</span>
                }
<span class="nc" id="L771">                parentPanel.revalidate();</span>
<span class="nc" id="L772">            });</span>
<span class="nc" id="L773">        this.add(menuItem);</span>
<span class="nc" id="L774">    }</span>


    /**
     * Creates menu items for some goods in a market.
     *
     * @param marketLabel The &lt;code&gt;MarketLabel&lt;/code&gt; to create entries for.
     */
    private void createMarketMenu(MarketLabel marketLabel) {
<span class="nc" id="L783">        final AbstractGoods ag = marketLabel.getAbstractGoods();</span>
<span class="nc" id="L784">        final Player player = freeColClient.getMyPlayer();</span>

<span class="nc" id="L786">        this.setLabel(Messages.message(&quot;cargo&quot;));</span>
<span class="nc" id="L787">        JMenuItem name = new JMenuItem(</span>
<span class="nc" id="L788">            Messages.getName(ag) + &quot; (&quot; + Messages.message(&quot;colopedia&quot;) + &quot;)&quot;,</span>
<span class="nc" id="L789">            new ImageIcon(</span>
<span class="nc" id="L790">                gui.getImageLibrary().getSmallIconImage(ag.getType())));</span>
<span class="nc" id="L791">        name.addActionListener((ActionEvent ae) -&gt; {</span>
<span class="nc" id="L792">                gui.showColopediaPanel(ag.getType().getId());</span>
<span class="nc" id="L793">            });</span>
<span class="nc" id="L794">        this.add(name);</span>

<span class="nc" id="L796">        final Europe europe = this.freeColClient.getMyPlayer().getEurope();</span>
<span class="nc" id="L797">        addMarketItems(ag, europe);</span>

<span class="nc bnc" id="L799" title="All 2 branches missed.">        if (!player.canTrade(ag.getType())) {</span>
<span class="nc" id="L800">            addPayArrears(ag.getType());</span>
        }
<span class="nc" id="L802">    }</span>

    private boolean addMarketItems(final AbstractGoods ag, Europe europe) {
<span class="nc" id="L805">        final InGameController igc = freeColClient.getInGameController();</span>
<span class="nc" id="L806">        final Goods goods = new Goods(europe.getGame(), null,</span>
<span class="nc" id="L807">                                      ag.getType(), ag.getAmount());</span>
<span class="nc" id="L808">        boolean added = false;</span>
<span class="nc bnc" id="L809" title="All 2 branches missed.">        for (final Unit unit : europe.getUnitList()) {</span>
<span class="nc bnc" id="L810" title="All 4 branches missed.">            if (unit.isCarrier() &amp;&amp; unit.canCarryGoods()</span>
<span class="nc bnc" id="L811" title="All 2 branches missed.">                &amp;&amp; unit.canAdd(goods)) {</span>
<span class="nc" id="L812">                StringTemplate template = StringTemplate.template(&quot;loadOnTo&quot;)</span>
<span class="nc" id="L813">                    .addStringTemplate(&quot;%unit%&quot;,</span>
<span class="nc" id="L814">                        unit.getLabel(Unit.UnitLabelType.NATIONAL));</span>
<span class="nc" id="L815">                JMenuItem menuItem = Utility.localizedMenuItem(template);</span>
<span class="nc" id="L816">                menuItem.addActionListener((ActionEvent ae) -&gt; {</span>
<span class="nc bnc" id="L817" title="All 2 branches missed.">                        if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) != 0) {</span>
<span class="nc" id="L818">                            promptForGoods(ag);</span>
                        }
<span class="nc" id="L820">                        igc.buyGoods(ag.getType(), ag.getAmount(), unit);</span>
<span class="nc" id="L821">                    });</span>
<span class="nc" id="L822">                this.add(menuItem);</span>
<span class="nc" id="L823">                added = true;</span>
            }
        }
<span class="nc" id="L826">        return added;</span>
    }


    /**
     * Creates a menu for a tile.
     * 
     * @param singleTilePanel The &lt;code&gt;ASingleTilePanel&lt;/code&gt; to create with.
     */
    private void createTileMenu(final ASingleTilePanel singleTilePanel) {
<span class="nc bnc" id="L836" title="All 2 branches missed.">        if (singleTilePanel.getColonyTile() != null</span>
<span class="nc bnc" id="L837" title="All 2 branches missed.">            &amp;&amp; singleTilePanel.getColonyTile().getColony() != null) {</span>
<span class="nc" id="L838">            addTileItem(singleTilePanel.getColonyTile().getWorkTile());</span>
        }
<span class="nc" id="L840">    }</span>

    /**
     * Add a menu item for the tile a unit is working.
     *
     * @param unitLabel The &lt;code&gt;UnitLabel&lt;/code&gt; specifying the unit.
     * @return True if an item was added.
     */
    private boolean addTileItem(final UnitLabel unitLabel) {
<span class="nc" id="L849">        final Unit unit = unitLabel.getUnit();</span>
<span class="nc bnc" id="L850" title="All 2 branches missed.">        if (unit.getWorkTile() != null) {</span>
<span class="nc" id="L851">            final Tile tile = unit.getWorkTile().getWorkTile();</span>
<span class="nc" id="L852">            addTileItem(tile);</span>
<span class="nc" id="L853">            return true;</span>
        }
<span class="nc" id="L855">        return false;</span>
    }

    /**
     * Add a menu item to show the tile panel for a tile.
     *
     * @param tile The &lt;code&gt;Tile&lt;/code&gt; to use.
     */
    private void addTileItem(final Tile tile) {
<span class="nc bnc" id="L864" title="All 2 branches missed.">        if (tile != null) {</span>
<span class="nc" id="L865">            JMenuItem menuItem = new JMenuItem(Messages.getName(tile));</span>
<span class="nc" id="L866">            menuItem.addActionListener((ActionEvent ae) -&gt; {</span>
<span class="nc" id="L867">                    gui.showTilePanel(tile);</span>
<span class="nc" id="L868">            });</span>
<span class="nc" id="L869">            this.add(menuItem);</span>
        }
<span class="nc" id="L871">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span>src (May 7, 2016 6:04:12 PM)</div></body></html>