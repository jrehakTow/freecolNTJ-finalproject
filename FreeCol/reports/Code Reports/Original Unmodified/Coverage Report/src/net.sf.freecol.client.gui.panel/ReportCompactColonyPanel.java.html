<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>ReportCompactColonyPanel.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">src (May 7, 2016 6:04:12 PM)</a> &gt; <a href="../../index.html" class="el_group">FreeCol</a> &gt; <a href="../index.html" class="el_bundle">src</a> &gt; <a href="index.source.html" class="el_package">net.sf.freecol.client.gui.panel</a> &gt; <span class="el_source">ReportCompactColonyPanel.java</span></div><h1>ReportCompactColonyPanel.java</h1><pre class="source lang-java linenums"><span class="nc" id="L1">/**</span>
 *  Copyright (C) 2002-2016   The FreeCol Team
 *
 *  This file is part of FreeCol.
 *
 *  FreeCol is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  FreeCol is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with FreeCol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package net.sf.freecol.client.gui.panel;

import java.awt.Color;
import java.awt.Font;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.Iterator;
import java.util.Map;
import java.util.Map.Entry;
import java.util.HashMap;
import java.util.List;
import java.util.function.BinaryOperator;
import java.util.stream.Collectors;

import javax.swing.ImageIcon;
import javax.swing.JButton;
import javax.swing.JComponent;
import javax.swing.JLabel;
import javax.swing.JPanel;
import javax.swing.JSeparator;
import javax.swing.SwingConstants;

import net.miginfocom.swing.MigLayout;

import net.sf.freecol.client.ClientOptions;
import net.sf.freecol.client.FreeColClient;
import net.sf.freecol.client.gui.ImageLibrary;
import net.sf.freecol.common.i18n.Messages;
import net.sf.freecol.common.model.Ability;
import net.sf.freecol.common.model.AbstractGoods;
import net.sf.freecol.common.model.BuildableType;
import net.sf.freecol.common.model.Building;
import net.sf.freecol.common.model.Colony;
import net.sf.freecol.common.model.Colony.TileImprovementSuggestion;
import net.sf.freecol.common.model.ColonyTile;
import net.sf.freecol.common.model.ExportData;
import net.sf.freecol.common.model.FreeColObject;
import net.sf.freecol.common.model.Game;
import net.sf.freecol.common.model.Goods;
import net.sf.freecol.common.model.GoodsContainer;
import net.sf.freecol.common.model.GoodsType;
import net.sf.freecol.common.model.Location;
import net.sf.freecol.common.model.Market;
import net.sf.freecol.common.model.Occupation;
import net.sf.freecol.common.model.Player;
import net.sf.freecol.common.model.ProductionInfo;
import net.sf.freecol.common.model.Region;
import net.sf.freecol.common.model.Settlement;
import net.sf.freecol.common.model.Specification;
import net.sf.freecol.common.model.StringTemplate;
import net.sf.freecol.common.model.Tile;
import net.sf.freecol.common.model.TileImprovementType;
import net.sf.freecol.common.model.Unit;
import net.sf.freecol.common.model.UnitType;
import net.sf.freecol.common.model.WorkLocation;
import net.sf.freecol.common.model.WorkLocation.Suggestion;
import net.sf.freecol.common.resources.ResourceManager;
import static net.sf.freecol.common.util.CollectionUtils.*;
import static net.sf.freecol.common.util.StringUtils.*;


/**
 * This panel displays the compact colony report.
 */
public final class ReportCompactColonyPanel extends ReportPanel
    implements ActionListener {

    /** Container class for all the information about a colony. */
    private static class ColonySummary {

        /** Types of production for a given goods type. */
<span class="nc" id="L94">        public static enum ProductionStatus {</span>
<span class="nc" id="L95">            FAIL,        // Negative production and below low alarm level</span>
<span class="nc" id="L96">            BAD,         // Negative production</span>
<span class="nc" id="L97">            NONE,        // No production at all</span>
<span class="nc" id="L98">            ZERO,        // Production == consumption</span>
<span class="nc" id="L99">            GOOD,        // Positive production</span>
<span class="nc" id="L100">            EXPORT,      // Positive production and exporting</span>
<span class="nc" id="L101">            EXCESS,      // Positive production and above high alarm level</span>
<span class="nc" id="L102">            OVERFLOW,    // Positive production and above capacity</span>
<span class="nc" id="L103">            PRODUCTION,  // Positive production but could produce more</span>
<span class="nc" id="L104">            CONSUMPTION, // Positive production but could consume more</span>
        };

<span class="nc" id="L107">        public static BinaryOperator&lt;GoodsProduction&gt; goodsProductionAccumulator</span>
<span class="nc" id="L108">            = (g1, g2) -&gt; {</span>
<span class="nc" id="L109">                g1.amount += g2.amount;</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">                g1.status = (g1.status == ProductionStatus.NONE</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">                        &amp;&amp; g2.status == ProductionStatus.NONE)</span>
<span class="nc" id="L112">                    ? ProductionStatus.NONE</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">                    : (g1.amount &lt; 0) ? ProductionStatus.BAD</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">                    : (g1.amount &gt; 0) ? ProductionStatus.GOOD</span>
<span class="nc" id="L115">                    : ProductionStatus.ZERO;</span>
<span class="nc" id="L116">                g1.extra = 0;</span>
<span class="nc" id="L117">                return g1;</span>
<span class="nc" id="L118">            };</span>

        /** Container class for goods production. */
        public static class GoodsProduction {

            public int amount;
            public ProductionStatus status;
            public int extra;

<span class="nc" id="L127">            public GoodsProduction(int amount, ProductionStatus status,</span>
                                   int extra) {
<span class="nc" id="L129">                this.amount = amount;</span>
<span class="nc" id="L130">                this.status = status;</span>
<span class="nc" id="L131">                this.extra = extra;</span>
<span class="nc" id="L132">            }</span>
        };


        /** The colony being summarized. */
        public final Colony colony;

        /** Possible tile improvements. */
<span class="nc" id="L140">        public final List&lt;TileImprovementSuggestion&gt; tileSuggestions</span>
<span class="nc" id="L141">            = new ArrayList&lt;&gt;();</span>

        /** Famine warning required? */
        public final boolean famine;

        /**
         * Turns to new colonist if positive, no colonist if zero,
         * -turns-1 to starvation if negative.
         */
        public final int newColonist;

        /** Current production bonus. */
        public final int bonus;
        
        /** Preferred size change. */
        public final int sizeChange;

        /** Goods production. */
<span class="nc" id="L159">        public final Map&lt;GoodsType, GoodsProduction&gt; production</span>
<span class="nc" id="L160">            = new HashMap&lt;&gt;();</span>

        /** Teacher units mapped to turns to complete. */
<span class="nc" id="L163">        public final Map&lt;Unit, Integer&gt; teachers = new HashMap&lt;&gt;();</span>
        /** Units present that are not working. */
<span class="nc" id="L165">        public final List&lt;Unit&gt; notWorking = new ArrayList&lt;&gt;();</span>
        /** Units present that might be working. */
<span class="nc" id="L167">        public final List&lt;UnitType&gt; couldWork = new ArrayList&lt;&gt;();</span>
        /** Suggested better unit use. */
<span class="nc" id="L169">        public final Map&lt;UnitType, Suggestion&gt; improve = new HashMap&lt;&gt;();</span>
        /** Suggested new unit use. */
<span class="nc" id="L171">        public final Map&lt;UnitType, Suggestion&gt; want = new HashMap&lt;&gt;();</span>
        
        /** Currently building. */
        public final BuildableType build;
        public final int completeTurns;
        public final AbstractGoods needed;


        /**
         * Create the colony summary.
         *
         * @param colony The &lt;code&gt;Colony&lt;/code&gt; to summarize.
         * @param goodsTypes A list of &lt;code&gt;GoodsType&lt;/code&gt;s to include
         *     in the summary.
         */
<span class="nc" id="L186">        public ColonySummary(Colony colony, List&lt;GoodsType&gt; goodsTypes) {</span>
<span class="nc" id="L187">            this.colony = colony;</span>

<span class="nc" id="L189">            final Specification spec = colony.getSpecification();</span>
<span class="nc" id="L190">            final Player owner = colony.getOwner();</span>
<span class="nc" id="L191">            final GoodsType foodType = spec.getPrimaryFoodType();</span>

<span class="nc" id="L193">            this.tileSuggestions.clear();</span>
<span class="nc" id="L194">            this.tileSuggestions.addAll(colony.getTileImprovementSuggestions());</span>

<span class="nc" id="L196">            int starve = colony.getStarvationTurns();</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">            if (starve &lt; 0) {</span>
<span class="nc" id="L198">                this.famine = false;</span>
<span class="nc" id="L199">                this.newColonist = colony.getNewColonistTurns();</span>
<span class="nc" id="L200">            } else {</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">                this.famine = starve &lt;= Colony.FAMINE_TURNS;</span>
<span class="nc" id="L202">                this.newColonist = -starve - 1;</span>
            }

<span class="nc" id="L205">            this.bonus = colony.getProductionBonus();</span>
            
<span class="nc" id="L207">            this.sizeChange = colony.getPreferredSizeChange();</span>

<span class="nc bnc" id="L209" title="All 2 branches missed.">            for (GoodsType gt : goodsTypes) produce(gt);</span>
                
<span class="nc" id="L211">            this.notWorking.addAll(colony.getTile().getUnitList().stream()</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">                .filter(u -&gt; u.getState() != Unit.UnitState.FORTIFIED</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">                    &amp;&amp; u.getState() != Unit.UnitState.SENTRY)</span>
<span class="nc" id="L214">                .collect(Collectors.toList()));</span>

            // Collect the types of the units at work in the colony
            // (colony tiles and buildings) that are suboptimal (and
            // are not just temporarily there because they are being
            // taught), the types for sites that really need a new
            // unit, the teachers, and the units that are not working.
            //
            // FIXME: this needs to be merged with the requirements
            // checking code, but that in turn should be opened up
            // so the AI can use it...
<span class="nc bnc" id="L225" title="All 2 branches missed.">            for (WorkLocation wl : colony.getAvailableWorkLocations()) {</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">                if (!wl.canBeWorked()) continue;</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">                if (wl.canTeach()) {</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">                    for (Unit u : wl.getUnitList()) {</span>
<span class="nc" id="L229">                        teachers.put(u, u.getNeededTurnsOfTraining()</span>
<span class="nc" id="L230">                            - u.getTurnsOfTraining());</span>
                    }
<span class="nc" id="L232">                    continue;</span>
                }

                // Check if the units are working.
<span class="nc bnc" id="L236" title="All 2 branches missed.">                for (Unit u : wl.getUnitList()) {</span>
<span class="nc bnc" id="L237" title="All 4 branches missed.">                    if (u.getTeacher() == null &amp;&amp; u.getWorkType() == null) {</span>
<span class="nc" id="L238">                        this.notWorking.add(u);</span>
                    }
                }

                // Add work location suggestions.
<span class="nc bnc" id="L243" title="All 2 branches missed.">                for (Entry&lt;Unit, Suggestion&gt; e</span>
<span class="nc" id="L244">                         : wl.getSuggestions().entrySet()) {</span>
<span class="nc" id="L245">                    Unit u = e.getKey();</span>
<span class="nc" id="L246">                    Suggestion s = e.getValue();</span>
<span class="nc" id="L247">                    UnitType expert = spec.getExpertForProducing(s.goodsType);</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">                    if (u == null) {</span>
<span class="nc" id="L249">                        addSuggestion(this.want, expert, s);</span>
<span class="nc" id="L250">                    } else {</span>
<span class="nc" id="L251">                        addSuggestion(this.improve, expert, s);</span>
                    }
                }
            }
            
            // Make a list of unit types that are not working at their
            // speciality, including the units just standing around.
<span class="nc" id="L258">            this.couldWork.addAll(transform(this.notWorking,</span>
<span class="nc" id="L259">                    u -&gt; {</span>
<span class="nc" id="L260">                        WorkLocation wl = u.getWorkLocation();</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">                        return wl != null</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">                            &amp;&amp; (wl.getWorkFor(u) == null</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">                                || wl.getWorkFor(u) != u.getWorkType());</span>
                    },
<span class="nc" id="L265">                    Unit::getType, Collectors.toList()));</span>

<span class="nc" id="L267">            this.build = colony.getCurrentlyBuilding();</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">            if (this.build == null) {</span>
<span class="nc" id="L269">                this.completeTurns = -1;</span>
<span class="nc" id="L270">                this.needed = null;</span>
<span class="nc" id="L271">            } else {</span>
<span class="nc" id="L272">                AbstractGoods needed = new AbstractGoods();</span>
<span class="nc" id="L273">                this.completeTurns = colony.getTurnsToComplete(build, needed);</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">                this.needed = (this.completeTurns &lt; 0) ? needed : null;</span>
            }
<span class="nc" id="L276">        }</span>

        /**
         * Set the production map values for the given goods type.
         *
         * @param goodsType The &lt;code&gt;GoodsType&lt;/code&gt; to use.
         */
        private void produce(GoodsType goodsType) {
<span class="nc" id="L284">            final ExportData exportData = colony.getExportData(goodsType);</span>
<span class="nc" id="L285">            final int adjustment = colony.getWarehouseCapacity()</span>
<span class="nc" id="L286">                / GoodsContainer.CARGO_SIZE;</span>
<span class="nc" id="L287">            final int low = exportData.getLowLevel() * adjustment;</span>
<span class="nc" id="L288">            final int high = exportData.getHighLevel() * adjustment;</span>
<span class="nc" id="L289">            final int amount = colony.getGoodsCount(goodsType);</span>
<span class="nc" id="L290">            int p = colony.getAdjustedNetProductionOf(goodsType);</span>

            ProductionStatus status;
            AbstractGoods deficit;
<span class="nc" id="L294">            int extra = 0;</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">            if (p &lt; 0) {</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">                status = (amount &lt; low) ? ProductionStatus.FAIL</span>
<span class="nc" id="L297">                    : ProductionStatus.BAD;</span>
<span class="nc" id="L298">                extra = -amount / p + 1;</span>
<span class="nc bnc" id="L299" title="All 4 branches missed.">            } else if (p == 0 &amp;&amp; !colony.isProducing(goodsType)) {</span>
<span class="nc" id="L300">                status = ProductionStatus.NONE;</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">            } else if (p == 0) {</span>
<span class="nc" id="L302">                status = ProductionStatus.ZERO;</span>
<span class="nc" id="L303">                extra = 0;</span>
<span class="nc" id="L304">                deficit = null;</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">                for (WorkLocation wl : colony.getWorkLocationsForProducing(goodsType)) {</span>
<span class="nc" id="L306">                    ProductionInfo pi = colony.getProductionInfo(wl);</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">                    if (pi == null) continue;</span>
<span class="nc" id="L308">                    deficit = AbstractGoods.findByType(goodsType,</span>
<span class="nc" id="L309">                        pi.getConsumptionDeficit());</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">                    if (deficit != null) {</span>
<span class="nc" id="L311">                        status = ProductionStatus.CONSUMPTION;</span>
<span class="nc" id="L312">                        extra = deficit.getAmount();</span>
<span class="nc" id="L313">                        break;</span>
                    }
                }
<span class="nc bnc" id="L316" title="All 2 branches missed.">            } else if (exportData.getExported()) {</span>
<span class="nc" id="L317">                status = ProductionStatus.EXPORT;</span>
<span class="nc" id="L318">                extra = exportData.getExportLevel();</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">            } else if (goodsType.limitIgnored()) {</span>
<span class="nc" id="L320">                status = ProductionStatus.GOOD;</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">            } else if (amount + p &gt; colony.getWarehouseCapacity()) {</span>
<span class="nc" id="L322">                status = ProductionStatus.OVERFLOW;</span>
<span class="nc" id="L323">                extra = amount + p - colony.getWarehouseCapacity();</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">            } else if (amount &gt;= high) {</span>
<span class="nc" id="L325">                status = ProductionStatus.EXCESS;</span>
<span class="nc" id="L326">                extra = (colony.getWarehouseCapacity() - amount) / p;</span>
<span class="nc" id="L327">            } else {</span>
<span class="nc" id="L328">                status = ProductionStatus.GOOD;</span>
<span class="nc" id="L329">                extra = 0;</span>
<span class="nc" id="L330">                deficit = null;</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">                for (WorkLocation wl : colony.getWorkLocationsForProducing(goodsType)) {</span>
<span class="nc" id="L332">                    ProductionInfo pi = colony.getProductionInfo(wl);</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">                    if (pi == null) continue;</span>
<span class="nc" id="L334">                    deficit = AbstractGoods.findByType(goodsType,</span>
<span class="nc" id="L335">                        pi.getProductionDeficit());</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">                    if (deficit != null) {</span>
<span class="nc" id="L337">                        status = ProductionStatus.PRODUCTION;</span>
<span class="nc" id="L338">                        extra = deficit.getAmount();</span>
<span class="nc" id="L339">                        break;</span>
                    }
                }
            }
<span class="nc" id="L343">            this.production.put(goodsType,</span>
<span class="nc" id="L344">                new GoodsProduction(p, status, extra));</span>
<span class="nc" id="L345">        }</span>

        private void addSuggestion(Map&lt;UnitType, Suggestion&gt; suggestions,
            UnitType expert, Suggestion suggestion) {
<span class="nc bnc" id="L349" title="All 4 branches missed.">            if (suggestion == null || expert == null) return;</span>
<span class="nc" id="L350">            Suggestion now = suggestions.get(expert);</span>
<span class="nc bnc" id="L351" title="All 4 branches missed.">            if (now == null || now.amount &lt; suggestion.amount) {</span>
<span class="nc" id="L352">                suggestions.put(expert, suggestion);</span>
            }
<span class="nc" id="L354">        }</span>
    };

    private static final String BUILDQUEUE = &quot;buildQueue.&quot;;
    private static final String cAlarmKey = &quot;color.report.colony.alarm&quot;;
    private static final String cWarnKey = &quot;color.report.colony.warning&quot;;
    private static final String cPlainKey = &quot;color.report.colony.plain&quot;;
    private static final String cExportKey = &quot;color.report.colony.export&quot;;
    private static final String cGoodKey = &quot;color.report.colony.good&quot;;
<span class="nc" id="L363">    private static Color cAlarm = null;</span>
    private static Color cWarn;
    private static Color cPlain;
    private static Color cExport;
<span class="nc" id="L367">    private static Color cGood;</span>

    private final Specification spec;
    private final ImageLibrary lib;
<span class="nc" id="L371">    private final List&lt;List&lt;Colony&gt;&gt; colonies = new ArrayList&lt;&gt;();</span>
    private final Market market;
<span class="nc" id="L373">    private final List&lt;GoodsType&gt; goodsTypes = new ArrayList&lt;&gt;();</span>


    /**
     * Creates a compact colony report.
     *
     * @param freeColClient The &lt;code&gt;FreeColClient&lt;/code&gt; for the game.
     */
    public ReportCompactColonyPanel(FreeColClient freeColClient) {
<span class="nc" id="L382">        super(freeColClient, &quot;reportColonyAction&quot;);</span>

<span class="nc" id="L384">        final Player player = getMyPlayer();</span>
<span class="nc" id="L385">        final Comparator&lt;List&lt;Colony&gt;&gt; firstColonyComparator</span>
<span class="nc" id="L386">            = Comparator.comparing(l -&gt; l.get(0), freeColClient</span>
<span class="nc" id="L387">                .getClientOptions().getColonyComparator());</span>

<span class="nc" id="L389">        this.spec = getSpecification();</span>
<span class="nc" id="L390">        this.lib = getImageLibrary();</span>
        
        // Sort the colonies by continent.
<span class="nc" id="L393">        final Map&lt;Integer, List&lt;Colony&gt;&gt; continents = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">        for (Colony c : freeColClient.getMySortedColonies()) {</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">            if (c.getUnitCount() &gt; 0) {</span>
                // Do not include colonies that have been abandoned
                // but are still on the colonies list.
<span class="nc" id="L398">                appendToMapList(continents, c.getTile().getContiguity(), c);</span>
            }
        }
<span class="nc bnc" id="L401" title="All 2 branches missed.">        for (Entry&lt;Integer, List&lt;Colony&gt;&gt; e </span>
<span class="nc" id="L402">                 : mapEntriesByValue(continents, firstColonyComparator)) {</span>
<span class="nc" id="L403">            this.colonies.add(e.getValue());</span>
        }

<span class="nc" id="L406">        this.market = player.getMarket();</span>

<span class="nc" id="L408">        this.goodsTypes.addAll(spec.getGoodsTypeList());</span>
<span class="nc" id="L409">        Iterator&lt;GoodsType&gt; gti = goodsTypes.iterator();</span>
<span class="nc bnc" id="L410" title="All 2 branches missed.">        while (gti.hasNext()) {</span>
<span class="nc" id="L411">            GoodsType gt = gti.next();</span>
<span class="nc bnc" id="L412" title="All 4 branches missed.">            if (!gt.isStorable() || gt.isTradeGoods()) gti.remove();</span>
        }
<span class="nc" id="L414">        Collections.sort(this.goodsTypes, GoodsType.goodsTypeComparator);</span>

<span class="nc" id="L416">        loadResources();</span>

<span class="nc" id="L418">        update();</span>
<span class="nc" id="L419">    }</span>

    private synchronized void loadResources() {
<span class="nc bnc" id="L422" title="All 2 branches missed.">        if (cAlarm != null) return;</span>

<span class="nc bnc" id="L424" title="All 2 branches missed.">        cAlarm = (ResourceManager.hasColorResource(cAlarmKey))</span>
<span class="nc" id="L425">            ? ResourceManager.getColor(cAlarmKey)</span>
<span class="nc" id="L426">            : Color.RED;</span>
<span class="nc bnc" id="L427" title="All 2 branches missed.">        cWarn = (ResourceManager.hasColorResource(cWarnKey))</span>
<span class="nc" id="L428">            ? ResourceManager.getColor(cWarnKey)</span>
<span class="nc" id="L429">            : Color.MAGENTA;</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">        cPlain = (ResourceManager.hasColorResource(cPlainKey))</span>
<span class="nc" id="L431">            ? ResourceManager.getColor(cPlainKey)</span>
<span class="nc" id="L432">            : Color.DARK_GRAY;</span>
<span class="nc bnc" id="L433" title="All 2 branches missed.">        cExport = (ResourceManager.hasColorResource(cExportKey))</span>
<span class="nc" id="L434">            ? ResourceManager.getColor(cExportKey)</span>
<span class="nc" id="L435">            : Color.GREEN;</span>
<span class="nc bnc" id="L436" title="All 2 branches missed.">        cGood = (ResourceManager.hasColorResource(cGoodKey))</span>
<span class="nc" id="L437">            ? ResourceManager.getColor(cGoodKey)</span>
<span class="nc" id="L438">            : Color.BLUE;</span>
<span class="nc" id="L439">    }</span>


    private static StringTemplate stpl(String messageId) {
<span class="nc bnc" id="L443" title="All 2 branches missed.">        return (Messages.containsKey(messageId))</span>
<span class="nc" id="L444">            ? StringTemplate.template(messageId)</span>
<span class="nc" id="L445">            : null;</span>
    }

    private static StringTemplate stpld(String messageId) {
<span class="nc" id="L449">        messageId = Messages.descriptionKey(messageId);</span>
<span class="nc" id="L450">        return stpl(messageId);</span>
    }

    private JLabel newLabel(String h, ImageIcon i, Color c) {
<span class="nc" id="L454">        JLabel l = new JLabel(h, i, SwingConstants.CENTER);</span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">        l.setForeground((c == null) ? Color.BLACK : c);</span>
<span class="nc" id="L456">        return l;</span>
    }

    private JLabel newLabel(String h, ImageIcon i, Color c, StringTemplate t) {
<span class="nc bnc" id="L460" title="All 4 branches missed.">        if (h != null &amp;&amp; Messages.containsKey(h)) h = Messages.message(h);</span>
<span class="nc" id="L461">        JLabel l = newLabel(h, i, c);</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">        if (t != null) Utility.localizeToolTip(l, t);</span>
<span class="nc" id="L463">        return l;</span>
    }

    private JButton newButton(String action, String h, ImageIcon i,
                              Color c, StringTemplate t) {
<span class="nc bnc" id="L468" title="All 4 branches missed.">        if (h != null &amp;&amp; Messages.containsKey(h)) h = Messages.message(h);</span>
<span class="nc" id="L469">        JButton b = Utility.getLinkButton(h, i, action);</span>
<span class="nc bnc" id="L470" title="All 2 branches missed.">        b.setForeground((c == null) ? Color.BLACK : c);</span>
<span class="nc bnc" id="L471" title="All 2 branches missed.">        if (t != null) Utility.localizeToolTip(b, t);</span>
<span class="nc" id="L472">        b.addActionListener(this);</span>
<span class="nc" id="L473">        return b;</span>
    }

    private void addTogether(List&lt;? extends JComponent&gt; components) {
<span class="nc bnc" id="L477" title="All 2 branches missed.">        if (components.isEmpty()) {</span>
<span class="nc" id="L478">            reportPanel.add(new JLabel());</span>
<span class="nc" id="L479">            return;</span>
        }
<span class="nc bnc" id="L481" title="All 2 branches missed.">        String layout = (components.size() &gt; 1) ? &quot;split &quot; + components.size()</span>
<span class="nc" id="L482">            : null;</span>
<span class="nc bnc" id="L483" title="All 2 branches missed.">        for (JComponent jc : components) {</span>
<span class="nc" id="L484">            reportPanel.add(jc, layout);</span>
<span class="nc" id="L485">            layout = null;</span>
        }
<span class="nc" id="L487">    }</span>

    /**
     * Update a single colony.
     *
     * @param s The &lt;code&gt;ColonySummary&lt;/code&gt; to update from.
     */
    private void updateColony(ColonySummary s) {
<span class="nc" id="L495">        final String cac = s.colony.getId();</span>
<span class="nc" id="L496">        final UnitType defaultUnitType</span>
<span class="nc" id="L497">            = spec.getDefaultUnitType(s.colony.getOwner());</span>
<span class="nc" id="L498">        List&lt;JComponent&gt; buttons = new ArrayList&lt;&gt;();</span>
        JButton b;
        Color c;
        StringTemplate t;
        Building building;

        // Field: A button for the colony.
        // Colour: bonus in {-2,2} =&gt; {alarm, warn, plain, export, good}
        // Font: Bold if famine is threatening.
<span class="nc bnc" id="L507" title="All 2 branches missed.">        c = (s.bonus &lt;= -2) ? cAlarm</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">            : (s.bonus == -1) ? cWarn</span>
<span class="nc bnc" id="L509" title="All 2 branches missed.">            : (s.bonus == 0) ? cPlain</span>
<span class="nc bnc" id="L510" title="All 2 branches missed.">            : (s.bonus == 1) ? cExport</span>
<span class="nc" id="L511">            : cGood;</span>
<span class="nc" id="L512">        String annotations = &quot;&quot;, key;</span>
<span class="nc" id="L513">        t = StringTemplate.label(&quot;,&quot;);</span>
<span class="nc bnc" id="L514" title="All 2 branches missed.">        if ((building = s.colony.getStockade()) == null) {</span>
<span class="nc" id="L515">            key = &quot;annotation.unfortified&quot;;</span>
<span class="nc" id="L516">            t.add(Messages.message(&quot;report.colony.annotation.unfortified&quot;));</span>
<span class="nc" id="L517">        } else {</span>
<span class="nc" id="L518">            key = &quot;annotation.&quot; + building.getType().getSuffix();</span>
<span class="nc" id="L519">            t.add(Messages.message(building.getLabel()));</span>
        }
<span class="nc bnc" id="L521" title="All 2 branches missed.">        if (ResourceManager.hasResource(key))</span>
<span class="nc" id="L522">            annotations += ResourceManager.getString(key);</span>
<span class="nc bnc" id="L523" title="All 2 branches missed.">        if (!s.colony.getTile().isCoastland()) {</span>
<span class="nc" id="L524">            key = &quot;annotation.inland&quot;;</span>
<span class="nc" id="L525">            t.add(Messages.message(&quot;report.colony.annotation.inland&quot;));</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">        } else if ((building = s.colony.getWorkLocationWithAbility(Ability.PRODUCE_IN_WATER, Building.class)) == null) {</span>
<span class="nc" id="L527">            key = &quot;annotation.coastal&quot;;</span>
<span class="nc" id="L528">            t.add(Messages.message(&quot;report.colony.annotation.coastal&quot;));</span>
<span class="nc" id="L529">        } else {</span>
<span class="nc" id="L530">            key = &quot;annotation.&quot; + building.getType().getSuffix();</span>
<span class="nc" id="L531">            t.add(Messages.message(building.getLabel()));</span>
        }
<span class="nc bnc" id="L533" title="All 2 branches missed.">        if (ResourceManager.hasResource(key))</span>
<span class="nc" id="L534">            annotations += ResourceManager.getString(key);</span>
        /* Omit for now, too much detail.
        for (GoodsType gt : spec.getLibertyGoodsTypeList()) {
            if ((building = s.colony.getWorkLocationWithModifier(gt.getId(), Building.class)) != null) {
                key = &quot;annotation.&quot; + building.getType().getSuffix();
                t.add(Messages.message(building.getLabel()));
                if (ResourceManager.hasResource(key))
                    annotations += ResourceManager.getString(key);
            }
        }*/
        /* Omit for now, too much detail.
        for (GoodsType gt : spec.getImmigrationGoodsTypeList()) {
            if ((building = s.colony.getWorkLocationWithModifier(gt.getId(), Building.class)) != null) {
                key = &quot;annotation.&quot; + building.getType().getSuffix();
                t.add(Messages.message(building.getLabel()));
                if (ResourceManager.hasResource(key))
                    annotations += ResourceManager.getString(key);
            }
        }*/
        /* Font update needed
        if ((building = s.colony.getWorkLocationWithAbility(Ability.TEACH, Building.class)) != null) {
            key = &quot;annotation.&quot; + building.getType().getSuffix();
            t.add(Messages.message(building.getLabel()));
            if (ResourceManager.hasResource(key)) annotations += ResourceManager.getString(key);
        }*/
<span class="nc bnc" id="L559" title="All 2 branches missed.">        if ((building = s.colony.getWorkLocationWithAbility(Ability.EXPORT, Building.class)) != null) {</span>
<span class="nc" id="L560">            annotations += &quot;*&quot;;</span>
<span class="nc" id="L561">            t.add(Messages.message(building.getLabel()));</span>
        }
<span class="nc" id="L563">        b = newButton(cac, s.colony.getName() + annotations, null, c,</span>
<span class="nc" id="L564">            StringTemplate.label(&quot;: &quot;).add(s.colony.getName())</span>
<span class="nc" id="L565">                .add(Messages.message(t)));</span>
<span class="nc bnc" id="L566" title="All 2 branches missed.">        if (s.famine) b.setFont(b.getFont().deriveFont(Font.BOLD));</span>
<span class="nc" id="L567">        reportPanel.add(b, &quot;newline&quot;);</span>

        // Field: The number of colonists that can be added to a
        // colony without damaging the production bonus, unless
        // the colony is inefficient in which case add the number
        // of colonists to remove to fix the inefficiency.
        // Colour: Blue if efficient/Red if inefficient.
<span class="nc bnc" id="L574" title="All 2 branches missed.">        if (s.sizeChange &lt; 0) {</span>
<span class="nc" id="L575">            c = cAlarm;</span>
<span class="nc" id="L576">            t = stpld(&quot;report.colony.shrinking&quot;)</span>
<span class="nc" id="L577">                    .addName(&quot;%colony%&quot;, s.colony.getName())</span>
<span class="nc" id="L578">                    .addAmount(&quot;%amount%&quot;, -s.sizeChange);</span>
<span class="nc" id="L579">            b = newButton(cac, Integer.toString(-s.sizeChange), null, c, t);</span>
<span class="nc bnc" id="L580" title="All 2 branches missed.">        } else if (s.sizeChange &gt; 0) {</span>
<span class="nc" id="L581">            c = cGood;</span>
<span class="nc" id="L582">            t = stpld(&quot;report.colony.growing&quot;)</span>
<span class="nc" id="L583">                    .addName(&quot;%colony%&quot;, s.colony.getName())</span>
<span class="nc" id="L584">                    .addAmount(&quot;%amount%&quot;, s.sizeChange);</span>
<span class="nc" id="L585">            b = newButton(cac, Integer.toString(s.sizeChange), null, c, t);</span>
<span class="nc" id="L586">        } else {</span>
<span class="nc" id="L587">            b = null;</span>
        }
<span class="nc bnc" id="L589" title="All 2 branches missed.">        reportPanel.add((b == null) ? new JLabel() : b);</span>

        // Field: The number of potential colony tiles that need
        // exploring.
        // Colour: Always cAlarm
<span class="nc" id="L594">        int n = count(s.tileSuggestions,</span>
<span class="nc" id="L595">                      TileImprovementSuggestion::isExploration);</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">        if (n &gt; 0) {</span>
<span class="nc" id="L597">            t = stpld(&quot;report.colony.exploring&quot;)</span>
<span class="nc" id="L598">                    .addName(&quot;%colony%&quot;, s.colony.getName())</span>
<span class="nc" id="L599">                    .addAmount(&quot;%amount%&quot;, n);</span>
<span class="nc" id="L600">            b = newButton(cac, Integer.toString(n), null, cAlarm, t);</span>
<span class="nc" id="L601">        } else {</span>
<span class="nc" id="L602">            b = null;</span>
        }
<span class="nc bnc" id="L604" title="All 2 branches missed.">        reportPanel.add((b == null) ? new JLabel() : b);</span>

        // Fields: The number of existing colony tiles that would
        // benefit from improvements.
        // Colour: Always cAlarm
        // Font: Bold if one of the tiles is the colony center.
<span class="nc bnc" id="L610" title="All 2 branches missed.">        for (TileImprovementType ti : spec.getTileImprovementTypeList()) {</span>
<span class="nc bnc" id="L611" title="All 2 branches missed.">            if (ti.isNatural()) continue;</span>
<span class="nc" id="L612">            n = 0;</span>
<span class="nc" id="L613">            boolean center = false; </span>
<span class="nc bnc" id="L614" title="All 2 branches missed.">            for (TileImprovementSuggestion tis : s.tileSuggestions) {</span>
<span class="nc bnc" id="L615" title="All 2 branches missed.">                if (tis.tileImprovementType == ti) {</span>
<span class="nc" id="L616">                    n++;</span>
<span class="nc bnc" id="L617" title="All 2 branches missed.">                    if (tis.tile == s.colony.getTile()) center = true;</span>
                }
            }
<span class="nc bnc" id="L620" title="All 2 branches missed.">            if (n &gt; 0) {</span>
<span class="nc" id="L621">                c = cAlarm;</span>
<span class="nc bnc" id="L622" title="All 2 branches missed.">                if (n == 1) {</span>
<span class="nc" id="L623">                    TileImprovementSuggestion tis = s.tileSuggestions.get(0);</span>
<span class="nc bnc" id="L624" title="All 2 branches missed.">                    for (Unit u : tis.tile.getUnitList()) {</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">                        if (u.getState() == Unit.UnitState.IMPROVING</span>
<span class="nc bnc" id="L626" title="All 2 branches missed.">                            &amp;&amp; u.getWorkImprovement() != null</span>
<span class="nc bnc" id="L627" title="All 2 branches missed.">                            &amp;&amp; u.getWorkImprovement().getType()</span>
<span class="nc" id="L628">                                == tis.tileImprovementType) {</span>
<span class="nc" id="L629">                            c = cWarn; // Work is underway</span>
<span class="nc" id="L630">                            break;</span>
                        }
                    }
<span class="nc" id="L633">                    t = stpld(&quot;report.colony.tile.&quot; + ti.getSuffix()</span>
<span class="nc" id="L634">                              + &quot;.specific&quot;)</span>
<span class="nc" id="L635">                        .addName(&quot;%colony%&quot;, s.colony.getName())</span>
<span class="nc" id="L636">                        .addStringTemplate(&quot;%location%&quot;,</span>
<span class="nc" id="L637">                            tis.tile.getColonyTileLocationLabel(s.colony));</span>
<span class="nc" id="L638">                } else {</span>
<span class="nc" id="L639">                    t = stpld(&quot;report.colony.tile.&quot; + ti.getSuffix())</span>
<span class="nc" id="L640">                        .addName(&quot;%colony%&quot;, s.colony.getName())</span>
<span class="nc" id="L641">                        .addAmount(&quot;%amount%&quot;, n);</span>
                }
<span class="nc" id="L643">                b = newButton(cac, Integer.toString(n), null, c, t);</span>
<span class="nc bnc" id="L644" title="All 2 branches missed.">                if (center) b.setFont(b.getFont().deriveFont(Font.BOLD));</span>
<span class="nc" id="L645">            } else {</span>
<span class="nc" id="L646">                b = null;</span>
            }
<span class="nc bnc" id="L648" title="All 2 branches missed.">            reportPanel.add((b == null) ? new JLabel() : b);</span>
        }

        // Fields: The net production of each storable+non-trade-goods
        // goods type.
        // Colour: cAlarm if too low, cWarn if negative, empty if no
        // production, cPlain if production balanced at zero,
        // otherwise must be positive, wherein cExport
        // if exported, cAlarm if too high, else cGood.
<span class="nc bnc" id="L657" title="All 2 branches missed.">        for (GoodsType gt : this.goodsTypes) {</span>
<span class="nc" id="L658">            final ColonySummary.GoodsProduction gp = s.production.get(gt);</span>
<span class="nc bnc" id="L659" title="All 11 branches missed.">            switch (gp.status) {</span>
            case FAIL:
<span class="nc" id="L661">                c = cAlarm;</span>
<span class="nc" id="L662">                t = stpld(&quot;report.colony.production.low&quot;)</span>
<span class="nc" id="L663">                        .addName(&quot;%colony%&quot;, s.colony.getName())</span>
<span class="nc" id="L664">                        .addNamed(&quot;%goods%&quot;, gt)</span>
<span class="nc" id="L665">                        .addAmount(&quot;%amount%&quot;, -gp.amount)</span>
<span class="nc" id="L666">                        .addAmount(&quot;%turns%&quot;, gp.extra);</span>
<span class="nc" id="L667">                break;</span>
            case BAD:
<span class="nc" id="L669">                c = cWarn;</span>
<span class="nc" id="L670">                t = stpld(&quot;report.colony.production&quot;)</span>
<span class="nc" id="L671">                        .addName(&quot;%colony%&quot;, s.colony.getName())</span>
<span class="nc" id="L672">                        .addNamed(&quot;%goods%&quot;, gt)</span>
<span class="nc" id="L673">                        .addAmount(&quot;%amount%&quot;, gp.amount);</span>
<span class="nc" id="L674">                break;</span>
            case NONE:
<span class="nc" id="L676">                c = null;</span>
<span class="nc" id="L677">                t = null;</span>
<span class="nc" id="L678">                break;</span>
            case ZERO:
<span class="nc" id="L680">                c = cPlain;</span>
<span class="nc" id="L681">                t = stpld(&quot;report.colony.production&quot;)</span>
<span class="nc" id="L682">                        .addName(&quot;%colony%&quot;, s.colony.getName())</span>
<span class="nc" id="L683">                        .addNamed(&quot;%goods%&quot;, gt)</span>
<span class="nc" id="L684">                        .addAmount(&quot;%amount%&quot;, gp.amount);</span>
<span class="nc" id="L685">                break;</span>
            case GOOD:
<span class="nc" id="L687">                c = cGood;</span>
<span class="nc" id="L688">                t = stpld(&quot;report.colony.production&quot;)</span>
<span class="nc" id="L689">                        .addName(&quot;%colony%&quot;, s.colony.getName())</span>
<span class="nc" id="L690">                        .addNamed(&quot;%goods%&quot;, gt)</span>
<span class="nc" id="L691">                        .addAmount(&quot;%amount%&quot;, gp.amount);</span>
<span class="nc" id="L692">                break;</span>
            case EXPORT:
<span class="nc" id="L694">                c = cExport;</span>
<span class="nc" id="L695">                t = stpld(&quot;report.colony.production.export&quot;)</span>
<span class="nc" id="L696">                        .addName(&quot;%colony%&quot;, s.colony.getName())</span>
<span class="nc" id="L697">                        .addNamed(&quot;%goods%&quot;, gt)</span>
<span class="nc" id="L698">                        .addAmount(&quot;%amount%&quot;, gp.amount)</span>
<span class="nc" id="L699">                        .addAmount(&quot;%export%&quot;, gp.extra);</span>
<span class="nc" id="L700">                break;</span>
            case EXCESS:
<span class="nc" id="L702">                c = cWarn;</span>
<span class="nc" id="L703">                t = stpld(&quot;report.colony.production.high&quot;)</span>
<span class="nc" id="L704">                        .addName(&quot;%colony%&quot;, s.colony.getName())</span>
<span class="nc" id="L705">                        .addNamed(&quot;%goods%&quot;, gt)</span>
<span class="nc" id="L706">                        .addAmount(&quot;%amount%&quot;, gp.amount)</span>
<span class="nc" id="L707">                        .addAmount(&quot;%turns%&quot;, gp.extra);</span>
<span class="nc" id="L708">                break;</span>
            case OVERFLOW:
<span class="nc" id="L710">                c = cAlarm;</span>
<span class="nc" id="L711">                t = stpld(&quot;report.colony.production.waste&quot;)</span>
<span class="nc" id="L712">                        .addName(&quot;%colony%&quot;, s.colony.getName())</span>
<span class="nc" id="L713">                        .addNamed(&quot;%goods%&quot;, gt)</span>
<span class="nc" id="L714">                        .addAmount(&quot;%amount%&quot;, gp.amount)</span>
<span class="nc" id="L715">                        .addAmount(&quot;%waste%&quot;, gp.extra);</span>
<span class="nc" id="L716">                break;</span>
            case PRODUCTION:
<span class="nc" id="L718">                c = cWarn;</span>
<span class="nc" id="L719">                t = stpld(&quot;report.colony.production.maxProduction&quot;)</span>
<span class="nc" id="L720">                        .addName(&quot;%colony%&quot;, s.colony.getName())</span>
<span class="nc" id="L721">                        .addNamed(&quot;%goods%&quot;, gt)</span>
<span class="nc" id="L722">                        .addAmount(&quot;%amount%&quot;, gp.amount)</span>
<span class="nc" id="L723">                        .addAmount(&quot;%more%&quot;, gp.extra);</span>
<span class="nc" id="L724">                break;</span>
            case CONSUMPTION:
<span class="nc" id="L726">                c = cWarn;</span>
<span class="nc" id="L727">                t = stpld(&quot;report.colony.production.maxConsumption&quot;)</span>
<span class="nc" id="L728">                        .addName(&quot;%colony%&quot;, s.colony.getName())</span>
<span class="nc" id="L729">                        .addNamed(&quot;%goods%&quot;, gt)</span>
<span class="nc" id="L730">                        .addAmount(&quot;%amount%&quot;, gp.amount)</span>
<span class="nc" id="L731">                        .addAmount(&quot;%more%&quot;, gp.extra);</span>
<span class="nc" id="L732">                break;</span>
            default:
<span class="nc" id="L734">                throw new IllegalStateException(&quot;Bogus status: &quot; + gp.status);</span>
            }
<span class="nc bnc" id="L736" title="All 2 branches missed.">            reportPanel.add((c == null) ? new JLabel()</span>
<span class="nc" id="L737">                : newButton(cac, Integer.toString(gp.amount), null, c, t));</span>
        }

        // Field: New colonist arrival or famine warning.
        // Colour: cGood if arriving eventually, blank if not enough food
        // to grow, cWarn if negative, cAlarm if famine soon.
<span class="nc bnc" id="L743" title="All 2 branches missed.">        if (s.newColonist &gt; 0) {</span>
<span class="nc" id="L744">            t = stpld(&quot;report.colony.arriving&quot;)</span>
<span class="nc" id="L745">                    .addName(&quot;%colony%&quot;, s.colony.getName())</span>
<span class="nc" id="L746">                    .addNamed(&quot;%unit%&quot;, defaultUnitType)</span>
<span class="nc" id="L747">                    .addAmount(&quot;%turns%&quot;, s.newColonist);</span>
<span class="nc" id="L748">            b = newButton(cac, Integer.toString(s.newColonist), null,</span>
<span class="nc" id="L749">                          cGood, t);</span>
<span class="nc bnc" id="L750" title="All 2 branches missed.">        } else if (s.newColonist &lt; 0) {</span>
<span class="nc bnc" id="L751" title="All 2 branches missed.">            c = (s.famine) ? cAlarm : cWarn;</span>
<span class="nc" id="L752">            t = stpld(&quot;report.colony.starving&quot;)</span>
<span class="nc" id="L753">                    .addName(&quot;%colony%&quot;, s.colony.getName())</span>
<span class="nc" id="L754">                    .addAmount(&quot;%turns%&quot;, -s.newColonist);</span>
<span class="nc" id="L755">            b = newButton(cac, Integer.toString(-s.newColonist), null,</span>
<span class="nc" id="L756">                          c, t);</span>
<span class="nc bnc" id="L757" title="All 2 branches missed.">            if (s.famine) b.setFont(b.getFont().deriveFont(Font.BOLD));</span>
<span class="nc" id="L758">        } else {</span>
<span class="nc" id="L759">            b = null;</span>
        }
<span class="nc bnc" id="L761" title="All 2 branches missed.">        reportPanel.add((b == null) ? new JLabel() : b);</span>

        // Field: What is currently being built (clickable if on the
        // buildqueue) and the turns until it completes, including
        // units being taught, or blank if nothing queued.
        // Colour: cWarn if no construction is occurring, cGood with
        // turns if completing, cAlarm with turns if will block, turns
        // indicates when blocking occurs.
        // Font: Bold if blocked right now.
<span class="nc" id="L770">        final String qac = BUILDQUEUE + cac;</span>
<span class="nc bnc" id="L771" title="All 2 branches missed.">        if (s.build != null) {</span>
<span class="nc" id="L772">            int turns = s.completeTurns;</span>
<span class="nc" id="L773">            String bname = Messages.getName(s.build);</span>
<span class="nc bnc" id="L774" title="All 2 branches missed.">            if (turns == FreeColObject.UNDEFINED) {</span>
<span class="nc" id="L775">                t = stpld(&quot;report.colony.making.noconstruction&quot;)</span>
<span class="nc" id="L776">                        .addName(&quot;%colony%&quot;, s.colony.getName());</span>
<span class="nc" id="L777">                b = newButton(qac, bname, null, cWarn, t);</span>
<span class="nc bnc" id="L778" title="All 2 branches missed.">            } else if (turns &gt;= 0) {</span>
<span class="nc" id="L779">                t = stpld(&quot;report.colony.making.constructing&quot;)</span>
<span class="nc" id="L780">                        .addName(&quot;%colony%&quot;, s.colony.getName())</span>
<span class="nc" id="L781">                        .addNamed(&quot;%buildable%&quot;, s.build)</span>
<span class="nc" id="L782">                        .addAmount(&quot;%turns%&quot;, turns);</span>
<span class="nc" id="L783">                b = newButton(qac, bname + &quot; &quot; + Integer.toString(turns), null,</span>
<span class="nc" id="L784">                              cGood, t);</span>
<span class="nc bnc" id="L785" title="All 2 branches missed.">            } else if (turns &lt; 0) {</span>
<span class="nc" id="L786">                turns = -(turns + 1);</span>
<span class="nc" id="L787">                t = stpld(&quot;report.colony.making.blocking&quot;)</span>
<span class="nc" id="L788">                        .addName(&quot;%colony%&quot;, s.colony.getName())</span>
<span class="nc" id="L789">                        .addAmount(&quot;%amount%&quot;, s.needed.getAmount())</span>
<span class="nc" id="L790">                        .addNamed(&quot;%goods%&quot;, s.needed.getType())</span>
<span class="nc" id="L791">                        .addNamed(&quot;%buildable%&quot;, s.build)</span>
<span class="nc" id="L792">                        .addAmount(&quot;%turns%&quot;, turns);</span>
<span class="nc" id="L793">                b = newButton(qac, bname + &quot; &quot; + Integer.toString(turns),</span>
<span class="nc" id="L794">                              null, cAlarm, t);</span>
<span class="nc bnc" id="L795" title="All 2 branches missed.">                if (turns == 0) b.setFont(b.getFont().deriveFont(Font.BOLD));</span>
            }
<span class="nc" id="L797">            buttons.add(b);</span>
        }

        // Field: What is being trained, including shadow units for vacant
        // places.
        // Colour: cAlarm if completion is blocked, otherwise cPlain.
<span class="nc" id="L803">        int empty = 0;</span>
<span class="nc" id="L804">        Building school = s.colony.getWorkLocationWithAbility(Ability.TEACH,</span>
<span class="nc" id="L805">                                                              Building.class);</span>
<span class="nc bnc" id="L806" title="All 2 branches missed.">        if (school != null) empty = school.getType().getWorkPlaces();</span>
<span class="nc bnc" id="L807" title="All 2 branches missed.">        for (Entry&lt;Unit, Integer&gt; e</span>
<span class="nc" id="L808">                 : mapEntriesByValue(s.teachers, descendingIntegerComparator)) {</span>
<span class="nc" id="L809">            Unit u = e.getKey();</span>
<span class="nc" id="L810">            ImageIcon ii</span>
<span class="nc" id="L811">                = new ImageIcon(this.lib.getTinyUnitImage(u.getType(), false));</span>
<span class="nc bnc" id="L812" title="All 2 branches missed.">            if (e.getValue() &lt;= 0) {</span>
<span class="nc" id="L813">                t = stpld(&quot;report.colony.making.noteach&quot;)</span>
<span class="nc" id="L814">                        .addName(&quot;%colony%&quot;, s.colony.getName())</span>
<span class="nc" id="L815">                        .addStringTemplate(&quot;%teacher%&quot;,</span>
<span class="nc" id="L816">                            u.getLabel(Unit.UnitLabelType.NATIONAL));</span>
<span class="nc" id="L817">                b = newButton(cac, Integer.toString(0), ii, cAlarm, t);</span>
<span class="nc" id="L818">            } else {</span>
<span class="nc" id="L819">                t = stpld(&quot;report.colony.making.educating&quot;)</span>
<span class="nc" id="L820">                        .addName(&quot;%colony%&quot;, s.colony.getName())</span>
<span class="nc" id="L821">                        .addStringTemplate(&quot;%teacher%&quot;,</span>
<span class="nc" id="L822">                            u.getLabel(Unit.UnitLabelType.NATIONAL))</span>
<span class="nc" id="L823">                        .addAmount(&quot;%turns%&quot;, e.getValue());</span>
<span class="nc" id="L824">                b = newButton(cac, Integer.toString(e.getValue()), ii,</span>
<span class="nc" id="L825">                              cPlain, t);</span>
            }
<span class="nc" id="L827">            buttons.add(b);</span>
<span class="nc" id="L828">            empty--;</span>
        }

<span class="nc bnc" id="L831" title="All 2 branches missed.">        if (empty &gt; 0) {</span>
<span class="nc" id="L832">            final ImageIcon emptyIcon</span>
<span class="nc" id="L833">                = new ImageIcon(this.lib.getTinyUnitImage(defaultUnitType, true));</span>
<span class="nc" id="L834">            t = stpld(&quot;report.colony.making.educationVacancy&quot;)</span>
<span class="nc" id="L835">                    .addName(&quot;%colony%&quot;, s.colony.getName())</span>
<span class="nc" id="L836">                    .addAmount(&quot;%number%&quot;, empty);</span>
<span class="nc bnc" id="L837" title="All 2 branches missed.">            for (; empty &gt; 0; empty--) {</span>
<span class="nc" id="L838">                buttons.add(newButton(cac, &quot;&quot;, emptyIcon, cPlain, t));</span>
            }
        }
<span class="nc" id="L841">        addTogether(buttons);</span>

        // Field: The units that could be upgraded, followed by the units
        // that could be added.
<span class="nc bnc" id="L845" title="All 4 branches missed.">        if (s.improve.isEmpty() &amp;&amp; s.want.isEmpty()) {</span>
<span class="nc" id="L846">            reportPanel.add(new JLabel());</span>
<span class="nc" id="L847">        } else {</span>
<span class="nc" id="L848">            buttons.clear();</span>
<span class="nc" id="L849">            buttons.addAll(unitButtons(s.improve, s.couldWork, s.colony));</span>
<span class="nc" id="L850">            buttons.add(new JLabel(&quot;/&quot;));</span>
            // Prefer to suggest an improvement over and addition.
<span class="nc bnc" id="L852" title="All 2 branches missed.">            for (UnitType ut : s.improve.keySet()) s.want.remove(ut);</span>
<span class="nc" id="L853">            buttons.addAll(unitButtons(s.want, s.couldWork, s.colony));</span>
<span class="nc" id="L854">            addTogether(buttons);</span>
        }

        // TODO: notWorking?
<span class="nc" id="L858">    }</span>
    
    private List&lt;JButton&gt; unitButtons(final Map&lt;UnitType, Suggestion&gt; suggestions,
                                      List&lt;UnitType&gt; have, Colony colony) {
<span class="nc" id="L862">        final String cac = colony.getId();</span>
<span class="nc" id="L863">        List&lt;JButton&gt; result = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L864">        List&lt;UnitType&gt; types = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L865">        types.addAll(suggestions.keySet());</span>
<span class="nc" id="L866">        final Comparator&lt;UnitType&gt; buttonComparator</span>
<span class="nc" id="L867">            = Comparator.comparing(ut -&gt; suggestions.get(ut),</span>
<span class="nc" id="L868">                                   Suggestion.descendingAmountComparator);</span>
<span class="nc" id="L869">        Collections.sort(types, buttonComparator);</span>
<span class="nc bnc" id="L870" title="All 2 branches missed.">        for (UnitType type : types) {</span>
<span class="nc" id="L871">            boolean present = have.contains(type);</span>
<span class="nc" id="L872">            Suggestion suggestion = suggestions.get(type);</span>
<span class="nc" id="L873">            String label = Integer.toString(suggestion.amount);</span>
<span class="nc" id="L874">            ImageIcon icon</span>
<span class="nc" id="L875">                = new ImageIcon(this.lib.getTinyUnitImage(type, false));</span>
<span class="nc bnc" id="L876" title="All 2 branches missed.">            StringTemplate tip = (suggestion.oldType == null)</span>
<span class="nc" id="L877">                ? stpld(&quot;report.colony.wanting&quot;)</span>
<span class="nc" id="L878">                    .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="nc" id="L879">                    .addNamed(&quot;%unit%&quot;, type)</span>
<span class="nc" id="L880">                    .addStringTemplate(&quot;%location%&quot;,</span>
<span class="nc" id="L881">                        suggestion.workLocation.getLabel())</span>
<span class="nc" id="L882">                    .addNamed(&quot;%goods%&quot;, suggestion.goodsType)</span>
<span class="nc" id="L883">                    .addAmount(&quot;%amount%&quot;, suggestion.amount)</span>
<span class="nc" id="L884">                : stpld(&quot;report.colony.improving&quot;)</span>
<span class="nc" id="L885">                    .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="nc" id="L886">                    .addNamed(&quot;%oldUnit%&quot;, suggestion.oldType)</span>
<span class="nc" id="L887">                    .addNamed(&quot;%unit%&quot;, type)</span>
<span class="nc" id="L888">                    .addStringTemplate(&quot;%location%&quot;,</span>
<span class="nc" id="L889">                        suggestion.workLocation.getLabel())</span>
<span class="nc" id="L890">                    .addNamed(&quot;%goods%&quot;, suggestion.goodsType)</span>
<span class="nc" id="L891">                    .addAmount(&quot;%amount%&quot;, suggestion.amount);</span>
<span class="nc" id="L892">            JButton b = newButton(cac, label, icon,</span>
<span class="nc bnc" id="L893" title="All 2 branches missed.">                                  (present) ? cGood : cPlain, tip);</span>
<span class="nc bnc" id="L894" title="All 2 branches missed.">            if (present) b.setFont(b.getFont().deriveFont(Font.BOLD));</span>
<span class="nc" id="L895">            result.add(b);</span>
        }
<span class="nc" id="L897">        return result;</span>
    }

    /**
     * Update several colonies.
     *
     * @param summaries A list of &lt;code&gt;ColonySummary&lt;/code&gt;s to update from.
     */
    private void updateCombinedColonies(List&lt;ColonySummary&gt; summaries) {
        JLabel l;
        Color c;
        StringTemplate t;

<span class="nc" id="L910">        reportPanel.add(new JSeparator(JSeparator.HORIZONTAL),</span>
<span class="nc" id="L911">                        &quot;newline, span, growx&quot;);</span>

        // Accumulate all the summaries
<span class="nc" id="L914">        Map&lt;Region, Integer&gt; rRegionMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L915">        List&lt;TileImprovementSuggestion&gt; rTileSuggestions = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L916">        int rFamine = 0, rBonus = 0, rSizeChange = 0,</span>
<span class="nc" id="L917">            teacherLen = 0, improveLen = 0;</span>
<span class="nc" id="L918">        double rNewColonist = 0.0;</span>
<span class="nc" id="L919">        Map&lt;GoodsType, ColonySummary.GoodsProduction&gt; rProduction</span>
<span class="nc" id="L920">            = new HashMap&lt;&gt;();</span>
<span class="nc" id="L921">        Map&lt;UnitType, Integer&gt; rTeachers = new HashMap&lt;&gt;();</span>
<span class="nc" id="L922">        List&lt;Unit&gt; rNotWorking = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L923">        List&lt;UnitType&gt; rCouldWork = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L924">        Map&lt;UnitType, Integer&gt; rImprove = new HashMap&lt;&gt;();</span>
<span class="nc" id="L925">        Map&lt;GoodsType, Double&gt; rNeeded = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L926" title="All 2 branches missed.">        for (ColonySummary s : summaries) {</span>
<span class="nc" id="L927">            accumulateToMap(rRegionMap, s.colony.getTile().getRegion(), 1,</span>
<span class="nc" id="L928">                            integerAccumulator);</span>
<span class="nc" id="L929">            rTileSuggestions.addAll(s.tileSuggestions);</span>
<span class="nc bnc" id="L930" title="All 2 branches missed.">            if (s.famine) rFamine++;</span>
<span class="nc bnc" id="L931" title="All 2 branches missed.">            if (s.newColonist &gt; 0) rNewColonist += s.newColonist;</span>
<span class="nc" id="L932">            rBonus += s.bonus;</span>
<span class="nc" id="L933">            rSizeChange += s.sizeChange;</span>
<span class="nc" id="L934">            accumulateMap(rProduction, s.production,</span>
<span class="nc" id="L935">                          ColonySummary.goodsProductionAccumulator);</span>
<span class="nc" id="L936">            teacherLen = Math.max(teacherLen, s.teachers.size());</span>
<span class="nc bnc" id="L937" title="All 2 branches missed.">            for (Unit u : s.teachers.keySet()) {</span>
<span class="nc" id="L938">                accumulateToMap(rTeachers, u.getType(), 1, integerAccumulator);</span>
            }
<span class="nc" id="L940">            rNotWorking.addAll(s.notWorking);</span>
<span class="nc" id="L941">            rCouldWork.addAll(s.couldWork);</span>
<span class="nc" id="L942">            improveLen = Math.max(improveLen, s.improve.size() + s.want.size());</span>
<span class="nc bnc" id="L943" title="All 2 branches missed.">            for (UnitType ut : s.improve.keySet()) {</span>
<span class="nc" id="L944">                accumulateToMap(rImprove, ut, 1, integerAccumulator);</span>
            }
<span class="nc bnc" id="L946" title="All 2 branches missed.">            for (UnitType ut : s.want.keySet()) {</span>
<span class="nc" id="L947">                accumulateToMap(rImprove, ut, 1, integerAccumulator);</span>
            }
<span class="nc bnc" id="L949" title="All 4 branches missed.">            if (s.needed != null &amp;&amp; s.needed.getType().isStorable()) {</span>
<span class="nc" id="L950">                accumulateToMap(rNeeded, s.needed.getType(),</span>
<span class="nc" id="L951">                    (double)s.needed.getAmount() / s.completeTurns,</span>
<span class="nc" id="L952">                    doubleAccumulator);</span>
            }
        }
<span class="nc" id="L955">        rNewColonist = Math.round(rNewColonist / summaries.size());</span>

        // Field: A label for the most settled region in the list.
        // Colour: Plain
<span class="nc" id="L959">        t = mapEntriesByValue(rRegionMap, descendingIntegerComparator)</span>
<span class="nc" id="L960">            .get(0).getKey().getLabel();</span>
<span class="nc" id="L961">        reportPanel.add(newLabel(Messages.message(t), null, cPlain,</span>
<span class="nc" id="L962">                                 stpld(&quot;report.colony.name.summary&quot;)),</span>
<span class="nc" id="L963">                        &quot;newline&quot;);</span>

        // Field: The total of the size change field.
        // Colour: cGood if efficient/cAlarm if inefficient.
<span class="nc" id="L967">        reportPanel.add(newLabel(Integer.toString(rSizeChange), null,</span>
<span class="nc bnc" id="L968" title="All 2 branches missed.">                                 (rSizeChange &lt; 0) ? cAlarm : cGood,</span>
<span class="nc" id="L969">                                 stpld(&quot;report.colony.growing.summary&quot;)));</span>

        // Field: The number of potential colony tiles that need
        // exploring.
        // Colour: cAlarm
<span class="nc" id="L974">        List&lt;Tile&gt; tiles = transformDistinct(rTileSuggestions,</span>
<span class="nc" id="L975">            (TileImprovementSuggestion ts) -&gt; ts.isExploration(),</span>
<span class="nc" id="L976">            (TileImprovementSuggestion ts) -&gt; ts.tile, Collectors.toList());</span>
<span class="nc bnc" id="L977" title="All 2 branches missed.">        reportPanel.add((tiles.isEmpty()) ? new JLabel()</span>
<span class="nc" id="L978">            : newLabel(Integer.toString(tiles.size()), null, cAlarm,</span>
<span class="nc" id="L979">                       stpld(&quot;report.colony.exploring.summary&quot;)));</span>

        // Fields: The number of existing colony tiles that would
        // benefit from improvements.
        // Colour: cAlarm
<span class="nc bnc" id="L984" title="All 2 branches missed.">        for (TileImprovementType ti : spec.getTileImprovementTypeList()) {</span>
<span class="nc bnc" id="L985" title="All 2 branches missed.">            if (ti.isNatural()) continue;</span>
<span class="nc" id="L986">            tiles.clear();</span>
<span class="nc" id="L987">            tiles.addAll(transformDistinct(rTileSuggestions,</span>
<span class="nc bnc" id="L988" title="All 2 branches missed.">                    (TileImprovementSuggestion ts) -&gt; ts.tileImprovementType == ti,</span>
<span class="nc" id="L989">                    (TileImprovementSuggestion ts) -&gt; ts.tile,</span>
<span class="nc" id="L990">                    Collectors.toList()));</span>
<span class="nc bnc" id="L991" title="All 2 branches missed.">            reportPanel.add((tiles.isEmpty()) ? new JLabel()</span>
<span class="nc" id="L992">                : newLabel(Integer.toString(tiles.size()), null, cAlarm,</span>
<span class="nc" id="L993">                           stpld(&quot;report.colony.tile.&quot; + ti.getSuffix()</span>
<span class="nc" id="L994">                               + &quot;.summary&quot;)));</span>
        }

        // Fields: The net production of each storable+non-trade-goods
        // goods type.
        // Colour: cWarn if negative, empty if no production,
        // cPlain if production balanced at zero, otherwise cGood.
<span class="nc bnc" id="L1001" title="All 2 branches missed.">        for (GoodsType gt : this.goodsTypes) {</span>
<span class="nc" id="L1002">            final ColonySummary.GoodsProduction gp = rProduction.get(gt);</span>
<span class="nc bnc" id="L1003" title="All 5 branches missed.">            switch (gp.status) {</span>
            case BAD:
<span class="nc" id="L1005">                c = cWarn;</span>
<span class="nc" id="L1006">                break;</span>
            case NONE:
<span class="nc" id="L1008">                c = null;</span>
<span class="nc" id="L1009">                break;</span>
            case ZERO:
<span class="nc" id="L1011">                c = cPlain;</span>
<span class="nc" id="L1012">                break;</span>
            case GOOD:
<span class="nc" id="L1014">                c = cGood;</span>
<span class="nc" id="L1015">                break;</span>
            default:
<span class="nc" id="L1017">                throw new IllegalStateException(&quot;Bogus status: &quot; + gp.status);</span>
            }
<span class="nc bnc" id="L1019" title="All 2 branches missed.">            reportPanel.add((c == null) ? new JLabel()</span>
<span class="nc" id="L1020">                : newLabel(Integer.toString(gp.amount), null, c,</span>
<span class="nc" id="L1021">                    stpld(&quot;report.colony.production.summary&quot;)</span>
<span class="nc" id="L1022">                        .addNamed(&quot;%goods%&quot;, gt)));</span>
        }

        // Field: New colonist arrival or famine warning.
        // Colour: cWarn if negative, else cGood
<span class="nc" id="L1027">        reportPanel.add(newLabel(Integer.toString((int)rNewColonist), null,</span>
<span class="nc bnc" id="L1028" title="All 2 branches missed.">                                 (rNewColonist &lt; 0) ? cWarn : cGood,</span>
<span class="nc" id="L1029">                                 stpld(&quot;report.colony.arriving.summary&quot;)));</span>

        // Field: The required goods rates.
        // Colour: cPlain
<span class="nc" id="L1033">        List&lt;JLabel&gt; labels = toList(map(mapEntriesByValue(rNeeded, descendingDoubleComparator),</span>
<span class="nc" id="L1034">                e -&gt; newLabel(String.format(&quot;%4.1f %s&quot;, e.getValue(),</span>
<span class="nc" id="L1035">                                            Messages.getName(e.getKey())),</span>
<span class="nc" id="L1036">                    null, cPlain,</span>
<span class="nc" id="L1037">                    stpld(&quot;report.colony.making.summary&quot;)</span>
<span class="nc" id="L1038">                        .addNamed(&quot;%goods%&quot;, e.getKey()))));</span>

        // Field: What is being trained (attached to previous)
        // Colour: cPlain.
<span class="nc" id="L1042">        teacherLen = Math.max(3, teacherLen); // Always some room here</span>
<span class="nc" id="L1043">        labels.addAll(unitTypeLabels(rTeachers, teacherLen,</span>
<span class="nc" id="L1044">                stpld(&quot;report.colony.making.educating.summary&quot;)));</span>
<span class="nc" id="L1045">        addTogether(labels);</span>

        // Field: The units that could be upgraded, followed by the units
        // that could be added.
<span class="nc" id="L1049">        addTogether(unitTypeLabels(rImprove, improveLen,</span>
<span class="nc" id="L1050">                stpld(&quot;report.colony.improving.summary&quot;)));</span>
<span class="nc" id="L1051">    }</span>

    private List&lt;JLabel&gt; unitTypeLabels(Map&lt;UnitType, Integer&gt; unitTypeMap,
                                        int maxSize, StringTemplate t) {
<span class="nc" id="L1055">        List&lt;JLabel&gt; result = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1056">        int n = 0;</span>
<span class="nc bnc" id="L1057" title="All 2 branches missed.">        for (Entry&lt;UnitType, Integer&gt; e</span>
<span class="nc" id="L1058">                 : mapEntriesByValue(unitTypeMap, descendingIntegerComparator)) {</span>
<span class="nc" id="L1059">            ImageIcon icon</span>
<span class="nc" id="L1060">                = new ImageIcon(this.lib.getTinyUnitImage(e.getKey(), false));</span>
<span class="nc" id="L1061">            result.add(newLabel(Integer.toString(e.getValue()), icon,</span>
<span class="nc" id="L1062">                                cPlain, t));</span>
<span class="nc bnc" id="L1063" title="All 2 branches missed.">            if (++n &gt;= maxSize) break;</span>
        }
        
<span class="nc" id="L1066">        return result;</span>
    }                
        
    /**
     * Display the header area for the concise panel.
     *
     * @param market A &lt;code&gt;Market&lt;/code&gt; to check goods arrears
     *     status with.
     */
    private void conciseHeaders(Market market) {
<span class="nc" id="L1076">        reportPanel.add(new JSeparator(JSeparator.HORIZONTAL),</span>
<span class="nc" id="L1077">                        &quot;newline, span, growx&quot;);</span>

<span class="nc" id="L1079">        reportPanel.add(newLabel(&quot;report.colony.name.header&quot;, null, null,</span>
<span class="nc" id="L1080">                                 stpld(&quot;report.colony.name&quot;)),</span>
<span class="nc" id="L1081">                        &quot;newline&quot;);</span>

<span class="nc" id="L1083">        reportPanel.add(newLabel(&quot;report.colony.grow.header&quot;, null, null,</span>
<span class="nc" id="L1084">                                 stpld(&quot;report.colony.grow&quot;)));</span>
<span class="nc" id="L1085">        reportPanel.add(newLabel(&quot;report.colony.explore.header&quot;, null, null,</span>
<span class="nc" id="L1086">                                 stpld(&quot;report.colony.explore&quot;)));</span>
<span class="nc bnc" id="L1087" title="All 2 branches missed.">        for (TileImprovementType ti : this.spec.getTileImprovementTypeList()) {</span>
<span class="nc bnc" id="L1088" title="All 2 branches missed.">            if (ti.isNatural()) continue;</span>
<span class="nc" id="L1089">            String key = &quot;report.colony.tile.&quot; + ti.getSuffix() + &quot;.header&quot;;</span>
<span class="nc" id="L1090">            reportPanel.add(newLabel(key, null, null, stpld(key)));</span>
        }
<span class="nc bnc" id="L1092" title="All 2 branches missed.">        for (GoodsType gt : this.goodsTypes) {</span>
<span class="nc" id="L1093">            ImageIcon icon = new ImageIcon(this.lib.getSmallIconImage(gt));</span>
<span class="nc" id="L1094">            JLabel l = newLabel(null, icon, null,</span>
<span class="nc" id="L1095">                                stpl(&quot;report.colony.production.header&quot;)</span>
<span class="nc" id="L1096">                                    .addNamed(&quot;%goods%&quot;, gt));</span>
<span class="nc bnc" id="L1097" title="All 4 branches missed.">            l.setEnabled(market == null || market.getArrears(gt) &lt;= 0);</span>
<span class="nc" id="L1098">            reportPanel.add(l);</span>
        }

<span class="nc" id="L1101">        final UnitType type = spec.getDefaultUnitType(market.getOwner());</span>
<span class="nc" id="L1102">        ImageIcon colonistIcon</span>
<span class="nc" id="L1103">            = new ImageIcon(this.lib.getTinyUnitImage(type, false));</span>
<span class="nc" id="L1104">        reportPanel.add(newLabel(null, colonistIcon, null,</span>
<span class="nc" id="L1105">                                 stpld(&quot;report.colony.birth&quot;)));</span>
<span class="nc" id="L1106">        reportPanel.add(newLabel(&quot;report.colony.making.header&quot;, null, null,</span>
<span class="nc" id="L1107">                                 stpld(&quot;report.colony.making&quot;)));</span>
<span class="nc" id="L1108">        reportPanel.add(newLabel(&quot;report.colony.improve.header&quot;, null, null,</span>
<span class="nc" id="L1109">                                 stpld(&quot;report.colony.improve&quot;)));</span>

<span class="nc" id="L1111">        reportPanel.add(new JSeparator(JSeparator.HORIZONTAL),</span>
<span class="nc" id="L1112">                        &quot;newline, span, growx&quot;);</span>
<span class="nc" id="L1113">    }</span>

    /**
     * Update the panel.
     */
    private void update() {
<span class="nc" id="L1119">        reportPanel.removeAll();</span>

        // Define the layout, with a column for each goods type.
<span class="nc" id="L1122">        String cols = &quot;[l][c][c][c]&quot;;</span>
<span class="nc bnc" id="L1123" title="All 2 branches missed.">        for (int i = 0; i &lt; this.goodsTypes.size(); i++) cols += &quot;[c]&quot;;</span>
<span class="nc" id="L1124">        cols += &quot;[c][c][l][l][l]&quot;;</span>
<span class="nc" id="L1125">        reportPanel.setLayout(new MigLayout(&quot;fillx, insets 0, gap 0 0&quot;,</span>
<span class="nc" id="L1126">                                            cols, &quot;&quot;));</span>

<span class="nc" id="L1128">        conciseHeaders(this.market);</span>
<span class="nc" id="L1129">        List&lt;ColonySummary&gt; summaries = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1130" title="All 2 branches missed.">        for (List&lt;Colony&gt; cs : this.colonies) {</span>
<span class="nc" id="L1131">            summaries.clear();</span>
<span class="nc bnc" id="L1132" title="All 2 branches missed.">            for (Colony c : cs) {</span>
<span class="nc" id="L1133">                ColonySummary s = new ColonySummary(c, this.goodsTypes);</span>
<span class="nc" id="L1134">                summaries.add(s);</span>
<span class="nc" id="L1135">                updateColony(s);</span>
            }
<span class="nc bnc" id="L1137" title="All 2 branches missed.">            if (cs.size() &gt; 1) {</span>
<span class="nc" id="L1138">                updateCombinedColonies(summaries);</span>
            }
<span class="nc" id="L1140">            conciseHeaders(this.market);</span>
        }
<span class="nc" id="L1142">    }</span>


    // Interface ActionListener

    /**
     * {@inheritDoc}
     */
    @Override
    public void actionPerformed(ActionEvent ae) {
<span class="nc" id="L1152">        final Game game = getGame();</span>
<span class="nc" id="L1153">        String command = ae.getActionCommand();</span>
<span class="nc bnc" id="L1154" title="All 2 branches missed.">        if (command.startsWith(BUILDQUEUE)) {</span>
<span class="nc" id="L1155">            command = command.substring(BUILDQUEUE.length());</span>
<span class="nc" id="L1156">            Colony colony = game.getFreeColGameObject(command, Colony.class);</span>
<span class="nc bnc" id="L1157" title="All 2 branches missed.">            if (colony != null) {</span>
<span class="nc" id="L1158">                getGUI().showBuildQueuePanel(colony, () -&gt; { update(); });</span>
<span class="nc" id="L1159">                return;</span>
            }
        } else {
<span class="nc" id="L1162">            Colony colony = game.getFreeColGameObject(command, Colony.class);</span>
<span class="nc bnc" id="L1163" title="All 2 branches missed.">            if (colony != null) {</span>
<span class="nc" id="L1164">                getGUI().showColonyPanel2(colony, null)</span>
<span class="nc" id="L1165">                    .addClosingCallback(() -&gt; { update(); });</span>
<span class="nc" id="L1166">                return;</span>
            }
        }
<span class="nc" id="L1169">        super.actionPerformed(ae);</span>
<span class="nc" id="L1170">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span>src (May 7, 2016 6:04:12 PM)</div></body></html>