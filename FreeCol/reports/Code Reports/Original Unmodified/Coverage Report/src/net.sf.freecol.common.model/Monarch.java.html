<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>Monarch.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">src (May 7, 2016 6:04:12 PM)</a> &gt; <a href="../../index.html" class="el_group">FreeCol</a> &gt; <a href="../index.html" class="el_bundle">src</a> &gt; <a href="index.source.html" class="el_package">net.sf.freecol.common.model</a> &gt; <span class="el_source">Monarch.java</span></div><h1>Monarch.java</h1><pre class="source lang-java linenums"><span class="pc" id="L1">/**</span>
 *  Copyright (C) 2002-2016   The FreeCol Team
 *
 *  This file is part of FreeCol.
 *
 *  FreeCol is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  FreeCol is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with FreeCol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package net.sf.freecol.common.model;

import java.util.ArrayList;
import java.util.Collections;
import java.util.Iterator;
import java.util.List;
import java.util.Random;
import java.util.stream.Collectors;
import java.util.logging.Logger;

import javax.xml.stream.XMLStreamConstants;
import javax.xml.stream.XMLStreamException;

import net.sf.freecol.common.io.FreeColXMLReader;
import net.sf.freecol.common.io.FreeColXMLWriter;
import net.sf.freecol.common.model.Force;
import net.sf.freecol.common.model.Player.PlayerType;
import net.sf.freecol.common.option.UnitListOption;
import net.sf.freecol.common.util.RandomChoice;
import static net.sf.freecol.common.util.CollectionUtils.*;
import static net.sf.freecol.common.util.RandomUtils.*;
import static net.sf.freecol.common.util.StringUtils.*;


/**
 * This class implements the player's monarch, whose functions prior
 * to the revolution include raising taxes, declaring war on other
 * European countries, and occasionally providing military support.
 */
public final class Monarch extends FreeColGameObject implements Named {

<span class="fc" id="L51">    private static final Logger logger = Logger.getLogger(Monarch.class.getName());</span>

    /** The minimum price for a monarch offer of mercenaries. */
    public static final int MONARCH_MINIMUM_PRICE = 200;

    /** The minimum price for a Hessian offer of mercenaries. */
    public static final int HESSIAN_MINIMUM_PRICE = 5000;

    /**
     * The minimum tax rate (given in percentage) from where it
     * can be lowered.
     */
    public static final int MINIMUM_TAX_RATE = 20;

    /** The player of this monarch. */
    private Player player;

    /** Whether a frigate has been provided. */
<span class="fc" id="L69">    private boolean supportSea = false;</span>

    /** Whether displeasure has been incurred. */
<span class="fc" id="L72">    private boolean displeasure = false;</span>

    /** Constants describing monarch actions. */
<span class="fc" id="L75">    public static enum MonarchAction {</span>
<span class="fc" id="L76">        NO_ACTION,</span>
<span class="fc" id="L77">        RAISE_TAX_ACT,</span>
<span class="fc" id="L78">        RAISE_TAX_WAR,</span>
<span class="fc" id="L79">        FORCE_TAX,</span>
<span class="fc" id="L80">        LOWER_TAX_WAR,</span>
<span class="fc" id="L81">        LOWER_TAX_OTHER,</span>
<span class="fc" id="L82">        WAIVE_TAX,</span>
<span class="fc" id="L83">        ADD_TO_REF,</span>
<span class="fc" id="L84">        DECLARE_PEACE,</span>
<span class="fc" id="L85">        DECLARE_WAR,</span>
<span class="fc" id="L86">        SUPPORT_LAND,</span>
<span class="fc" id="L87">        SUPPORT_SEA,</span>
<span class="fc" id="L88">        MONARCH_MERCENARIES, </span>
<span class="fc" id="L89">        HESSIAN_MERCENARIES,</span>
<span class="fc" id="L90">        DISPLEASURE;</span>

        /**
         * Get a key for this action.
         *
         * @return A message key.
         */
        private String getKey() {
<span class="fc" id="L98">            return &quot;monarch.action.&quot; + getEnumKey(this);</span>
        }

        public String getTextKey() {
<span class="fc" id="L102">            return &quot;model.&quot; + getKey() + &quot;.text&quot;;</span>
        }
        
        public String getYesKey() {
<span class="nc" id="L106">            return &quot;model.&quot; + getKey() + &quot;.yes&quot;;</span>
        }

        public String getNoKey() {
<span class="nc" id="L110">            return &quot;model.&quot; + getKey() + &quot;.no&quot;;</span>
        }

        public String getHeaderKey() {
<span class="nc" id="L114">            return &quot;model.&quot; + getKey() + &quot;.header&quot;;</span>
        }
    }

    /**
     * The Royal Expeditionary Force, which the Monarch will send to
     * crush the player's rebellion.
     */
    private Force expeditionaryForce;

    /**
     * The Foreign Intervention Force, which some random country will
     * send to support the player's rebellion.
     */
    private Force interventionForce;

    
    // Caches.  Do not serialize.
    /** The naval unit types suitable for support actions. */
<span class="fc" id="L133">    private List&lt;UnitType&gt; navalTypes = null;</span>
    /** The bombard unit types suitable for support actions. */
<span class="fc" id="L135">    private List&lt;UnitType&gt; bombardTypes = null;</span>
    /** The land unit types suitable for support actions. */
<span class="fc" id="L137">    private List&lt;UnitType&gt; landTypes = null;</span>
    /** The roles identifiers suitable for land units with support actions. */
<span class="fc" id="L139">    private Role mountedRole = null, armedRole = null,</span>
        refMountedRole, refArmedRole;
    /** The land unit types suitable for mercenary support. */
<span class="fc" id="L142">    private List&lt;UnitType&gt; mercenaryTypes = null;</span>
    /** The naval unit types suitable for the REF. */
<span class="fc" id="L144">    private List&lt;UnitType&gt; navalREFUnitTypes = null;</span>
    /** The land unit types suitable for the REF. */
<span class="fc" id="L146">    private List&lt;UnitType&gt; landREFUnitTypes = null;</span>


    /**
     * Constructor.
     *
     * @param game The enclosing &lt;code&gt;Game&lt;/code&gt;.
     * @param player The &lt;code&gt;Player&lt;/code&gt; to create the
     *     &lt;code&gt;Monarch&lt;/code&gt; for.
     */
    public Monarch(Game game, Player player) {
<span class="fc" id="L157">        super(game);</span>

<span class="pc bpc" id="L159" title="1 of 2 branches missed.">        if (player == null) {</span>
<span class="nc" id="L160">            throw new IllegalStateException(&quot;player == null&quot;);</span>
        }
<span class="fc" id="L162">        this.player = player;</span>

        // The Forces rely on the spec, but in the client we have to
        // create a player(with monarch) before the spec arrives from
        // the server, so the Forces *must* be instantiated lazily.
<span class="fc" id="L167">    }</span>

    /**
     * Initiates a new &lt;code&gt;Monarch&lt;/code&gt; with the given identifier.
     * The object should later be initialized by calling
     * {@link #readFromXML(FreeColXMLReader)}.
     *
     * @param game The enclosing &lt;code&gt;Game&lt;/code&gt;.
     * @param id The object identifier.
     */
    public Monarch(Game game, String id) {
<span class="fc" id="L178">        super(game, id);</span>

        // The Forces rely on the spec, but in the client we have to
        // create a player(with monarch) before the spec arrives from
        // the server, so the Forces *must* be instantiated lazily.
<span class="fc" id="L183">    }</span>


    /**
     * Get the force describing the REF.
     *
     * @return The REF &lt;code&gt;Force&lt;/code&gt;.
     */
    public Force getExpeditionaryForce() {
<span class="fc bfc" id="L192" title="All 2 branches covered.">        if (expeditionaryForce == null) {</span>
<span class="fc" id="L193">            final Specification spec = getSpecification();</span>
<span class="fc" id="L194">            UnitListOption option = (UnitListOption)spec.getOption(GameOptions.REF_FORCE);</span>
<span class="fc" id="L195">            expeditionaryForce = new Force(spec, option.getOptionValues(), null);</span>
        }
<span class="fc" id="L197">        return expeditionaryForce;</span>
    }

    /**
     * Get the force describing the Intervention Force.
     *
     * @return The intervention &lt;code&gt;Force&lt;/code&gt;.
     */
    public Force getInterventionForce() {
<span class="fc bfc" id="L206" title="All 2 branches covered.">        if (interventionForce == null) {</span>
<span class="fc" id="L207">            final Specification spec = getSpecification();</span>
<span class="fc" id="L208">            UnitListOption option = (UnitListOption)spec.getOption(GameOptions.INTERVENTION_FORCE);</span>
<span class="fc" id="L209">            interventionForce = new Force(spec, option.getOptionValues(), null);</span>
        }
<span class="fc" id="L211">        return interventionForce;</span>
    }

    /**
     * Gets the force describing the Mercenary Force.
     *
     * This is never updated, and directly derived from the spec.
     *
     * @return The mercenary &lt;code&gt;Force&lt;/code&gt;.
     */
    public Force getMercenaryForce() {
<span class="nc" id="L222">        final Specification spec = getSpecification();</span>
<span class="nc" id="L223">        UnitListOption option = (UnitListOption)spec.getOption(GameOptions.MERCENARY_FORCE);</span>
<span class="nc" id="L224">        return new Force(spec, option.getOptionValues(), null);</span>
    }

    /**
     * Get the war support force.
     *
     * This is never updated, and directly derived from the spec.
     *
     * @return The war support &lt;code&gt;Force&lt;/code&gt;.
     */
    public Force getWarSupportForce() {
<span class="nc" id="L235">        final Specification spec = getSpecification();</span>
<span class="nc" id="L236">        UnitListOption option = (UnitListOption)spec.getOption(GameOptions.WAR_SUPPORT_FORCE);</span>
<span class="nc" id="L237">        return new Force(spec, option.getOptionValues(), null);</span>
    }

    /**
     * Gets the sea support status.
     *
     * @return Gets the sea support status.
     */
    public boolean getSupportSea() {
<span class="nc" id="L246">        return supportSea;</span>
    }

    /**
     * Sets the sea support status.
     *
     * @param supportSea The new sea support status.
     */
    public void setSupportSea(boolean supportSea) {
<span class="nc" id="L255">        this.supportSea = supportSea;</span>
<span class="nc" id="L256">    }</span>

    /**
     * Gets the displeasure status.
     *
     * @return Gets the displeasure status.
     */
    public boolean getDispleasure() {
<span class="nc" id="L264">        return displeasure;</span>
    }

    /**
     * Sets the displeasure status.
     *
     * @param displeasure The new displeasure status.
     */
    public void setDispleasure(boolean displeasure) {
<span class="nc" id="L273">        this.displeasure = displeasure;</span>
<span class="nc" id="L274">    }</span>


    /**
     * Gets the maximum tax rate in this game.
     *
     * @return The maximum tax rate in the game.
     */
    private int taxMaximum() {
<span class="fc" id="L283">        return getSpecification().getInteger(GameOptions.MAXIMUM_TAX);</span>
    }

    /**
     * Cache the unit types and roles for support and mercenary offers.
     */
    private void initializeCaches() {
<span class="fc bfc" id="L290" title="All 2 branches covered.">        if (navalTypes != null) return;</span>
<span class="fc" id="L291">        final Specification spec = getSpecification();</span>
<span class="fc" id="L292">        navalTypes = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L293">        bombardTypes = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L294">        landTypes = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L295">        mercenaryTypes = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L296">        navalREFUnitTypes = spec.getREFUnitTypes(true);</span>
<span class="fc" id="L297">        landREFUnitTypes = spec.getREFUnitTypes(false);</span>

<span class="fc bfc" id="L299" title="All 2 branches covered.">        for (UnitType unitType : spec.getUnitTypeList()) {</span>
<span class="fc bfc" id="L300" title="All 2 branches covered.">            if (unitType.hasAbility(Ability.SUPPORT_UNIT)) {</span>
<span class="fc bfc" id="L301" title="All 2 branches covered.">                if (unitType.hasAbility(Ability.NAVAL_UNIT)) {</span>
<span class="fc" id="L302">                    navalTypes.add(unitType);</span>
<span class="fc bfc" id="L303" title="All 2 branches covered.">                } else if (unitType.hasAbility(Ability.BOMBARD)) {</span>
<span class="fc" id="L304">                    bombardTypes.add(unitType);</span>
<span class="pc bpc" id="L305" title="1 of 2 branches missed.">                } else if (unitType.hasAbility(Ability.CAN_BE_EQUIPPED)) {</span>
<span class="fc" id="L306">                    landTypes.add(unitType);</span>
                }
            }
<span class="fc bfc" id="L309" title="All 2 branches covered.">            if (unitType.hasAbility(Ability.MERCENARY_UNIT)) {</span>
<span class="fc" id="L310">                mercenaryTypes.add(unitType);</span>
            }
        }
<span class="fc bfc" id="L313" title="All 2 branches covered.">        for (Role r : spec.getMilitaryRoles()) {</span>
<span class="fc" id="L314">            boolean ok = r.isAvailableTo(player, landTypes.get(0));</span>
<span class="fc" id="L315">            boolean armed = r.hasAbility(Ability.ARMED);</span>
<span class="fc" id="L316">            boolean mounted = r.hasAbility(Ability.MOUNTED);</span>
<span class="fc" id="L317">            boolean ref = r.requiresAbility(Ability.REF_UNIT);</span>
<span class="fc bfc" id="L318" title="All 4 branches covered.">            if (armed &amp;&amp; mounted) {</span>
<span class="pc bpc" id="L319" title="1 of 6 branches missed.">                if (ok &amp;&amp; !ref &amp;&amp; mountedRole == null) {</span>
<span class="fc" id="L320">                    mountedRole = r;</span>
<span class="pc bpc" id="L321" title="1 of 6 branches missed.">                } else if (!ok &amp;&amp; ref &amp;&amp; refMountedRole == null) {</span>
<span class="fc" id="L322">                    refMountedRole = r;</span>
                }
<span class="pc bpc" id="L324" title="1 of 4 branches missed.">            } else if (armed &amp;&amp; !mounted) {</span>
<span class="pc bpc" id="L325" title="2 of 6 branches missed.">                if (ok &amp;&amp; !ref &amp;&amp; armedRole == null) {</span>
<span class="fc" id="L326">                    armedRole = r;</span>
<span class="pc bpc" id="L327" title="2 of 6 branches missed.">                } else if (!ok &amp;&amp; ref &amp;&amp; refArmedRole == null) {</span>
<span class="fc" id="L328">                    refArmedRole = r;</span>
                }
            }
        }
        
<span class="fc" id="L333">    }</span>

    /**
     * Collects a list of potential enemies for this player.
     *
     * @return A list of potential enemy &lt;code&gt;Player&lt;/code&gt;s.
     */
    public List&lt;Player&gt; collectPotentialEnemies() {
        // Benjamin Franklin puts an end to the monarch's interference
<span class="pc bpc" id="L342" title="1 of 2 branches missed.">        return (player.hasAbility(Ability.IGNORE_EUROPEAN_WARS))</span>
<span class="nc" id="L343">            ? Collections.&lt;Player&gt;emptyList()</span>
<span class="fc" id="L344">            : transform(getGame().getLiveEuropeanPlayers(player),</span>
<span class="fc" id="L345">                p -&gt; p.isPotentialEnemy(player), Collectors.toList());</span>
    }

    /**
     * Collects a list of potential friends for this player.
     *
     * Do not apply Franklin, he stops wars, not peace.
     *
     * @return A list of potential friendly &lt;code&gt;Player&lt;/code&gt;s.
     */
    public List&lt;Player&gt; collectPotentialFriends() {
<span class="fc" id="L356">        return transform(getGame().getLiveEuropeanPlayers(player),</span>
<span class="fc" id="L357">            p -&gt; p.isPotentialFriend(player), Collectors.toList());</span>
    }

    /**
     * Checks if a specified action is valid at present.
     *
     * @param action The &lt;code&gt;MonarchAction&lt;/code&gt; to check.
     * @return True if the action is valid.
     */
    public boolean actionIsValid(MonarchAction action) {
<span class="fc" id="L367">        initializeCaches();</span>

<span class="pc bpc" id="L369" title="5 of 13 branches missed.">        switch (action) {</span>
        case NO_ACTION:
<span class="fc" id="L371">            return true;</span>
        case RAISE_TAX_ACT: case RAISE_TAX_WAR:
<span class="fc bfc" id="L373" title="All 2 branches covered.">            return player.getTax() &lt; taxMaximum();</span>
        case FORCE_TAX:
<span class="nc" id="L375">            return false;</span>
        case LOWER_TAX_WAR: case LOWER_TAX_OTHER:
<span class="fc bfc" id="L377" title="All 2 branches covered.">            return player.getTax() &gt; MINIMUM_TAX_RATE + 10;</span>
        case WAIVE_TAX:
<span class="nc" id="L379">            return true;</span>
        case ADD_TO_REF:
<span class="pc bpc" id="L381" title="2 of 4 branches missed.">            return !(navalREFUnitTypes.isEmpty() || landREFUnitTypes.isEmpty());</span>
        case DECLARE_PEACE:
<span class="pc bpc" id="L383" title="1 of 2 branches missed.">            return !collectPotentialFriends().isEmpty();</span>
        case DECLARE_WAR:
<span class="pc bpc" id="L385" title="1 of 2 branches missed.">            return !collectPotentialEnemies().isEmpty();</span>
        case SUPPORT_SEA:
<span class="pc bpc" id="L387" title="3 of 4 branches missed.">            return player.getAttackedByPrivateers() &amp;&amp; !getSupportSea()</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">                &amp;&amp; !getDispleasure();</span>
        case SUPPORT_LAND: case MONARCH_MERCENARIES:
<span class="nc bnc" id="L390" title="All 4 branches missed.">            return player.isAtWar() &amp;&amp; !getDispleasure()</span>
<span class="nc bnc" id="L391" title="All 2 branches missed.">                &amp;&amp; player.hasSettlements();</span>
        case HESSIAN_MERCENARIES:
<span class="pc bpc" id="L393" title="1 of 2 branches missed.">            return player.checkGold(HESSIAN_MINIMUM_PRICE)</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">                &amp;&amp; player.hasSettlements();</span>
        case DISPLEASURE:
<span class="nc" id="L396">            return false;</span>
        default:
<span class="nc" id="L398">            throw new IllegalArgumentException(&quot;Bogus monarch action: &quot;</span>
<span class="nc" id="L399">                                               + action);</span>
        }
    }

    /**
     * Builds a weighted list of monarch actions.
     *
     * @return A weighted list of monarch actions.
     */
    public List&lt;RandomChoice&lt;MonarchAction&gt;&gt; getActionChoices() {
<span class="fc" id="L409">        final Specification spec = getSpecification();</span>
<span class="fc" id="L410">        List&lt;RandomChoice&lt;MonarchAction&gt;&gt; choices = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L411">        int dx = 1 + spec.getInteger(GameOptions.MONARCH_MEDDLING);</span>
<span class="fc" id="L412">        int turn = getGame().getTurn().getNumber();</span>
<span class="fc" id="L413">        int grace = (6 - dx) * 10; // 10-50</span>

        // Nothing happens during the first few turns, if there are no
        // colonies, or after the revolution begins.
<span class="fc bfc" id="L417" title="All 2 branches covered.">        if (turn &lt; grace</span>
<span class="pc bpc" id="L418" title="1 of 2 branches missed.">            || !player.hasSettlements()</span>
<span class="fc bfc" id="L419" title="All 2 branches covered.">            || player.getPlayerType() != PlayerType.COLONIAL) {</span>
<span class="fc" id="L420">            return choices;</span>
        }

        // The more time has passed, the less likely the monarch will
        // do nothing.
<span class="fc" id="L425">        addIfValid(choices, MonarchAction.NO_ACTION, Math.max(200 - turn, 100));</span>
<span class="fc" id="L426">        addIfValid(choices, MonarchAction.RAISE_TAX_ACT, 5 + dx);</span>
<span class="fc" id="L427">        addIfValid(choices, MonarchAction.RAISE_TAX_WAR, 5 + dx);</span>
<span class="fc" id="L428">        addIfValid(choices, MonarchAction.LOWER_TAX_WAR, 5 - dx);</span>
<span class="fc" id="L429">        addIfValid(choices, MonarchAction.LOWER_TAX_OTHER, 5 - dx);</span>
<span class="fc" id="L430">        addIfValid(choices, MonarchAction.ADD_TO_REF, 10 + dx);</span>
<span class="fc" id="L431">        addIfValid(choices, MonarchAction.DECLARE_PEACE, 6 - dx);</span>
<span class="fc" id="L432">        addIfValid(choices, MonarchAction.DECLARE_WAR, 5 + dx);</span>
<span class="pc bpc" id="L433" title="1 of 2 branches missed.">        if (player.checkGold(MONARCH_MINIMUM_PRICE)) {</span>
<span class="nc" id="L434">            addIfValid(choices, MonarchAction.MONARCH_MERCENARIES, 6-dx);</span>
<span class="pc bpc" id="L435" title="1 of 2 branches missed.">        } else if (dx &lt; 3) {</span>
<span class="nc" id="L436">            addIfValid(choices, MonarchAction.SUPPORT_LAND, 3 - dx);</span>
        }
<span class="fc" id="L438">        addIfValid(choices, MonarchAction.SUPPORT_SEA, 6 - dx);</span>
<span class="fc" id="L439">        addIfValid(choices, MonarchAction.HESSIAN_MERCENARIES, 6-dx);</span>

<span class="fc" id="L441">        return choices;</span>
    }

    /**
     * Convenience hack to check if an action is valid, and if so add
     * it to a choice list with a given weight.
     *
     * @param choices The list of choices.
     * @param action The &lt;code&gt;MonarchAction&lt;/code&gt; to check.
     * @param weight The weight to add the action with if valid.
     */
    private void addIfValid(List&lt;RandomChoice&lt;MonarchAction&gt;&gt; choices,
                            MonarchAction action, int weight) {
<span class="fc bfc" id="L454" title="All 2 branches covered.">        if (actionIsValid(action)) {</span>
<span class="fc" id="L455">            choices.add(new RandomChoice&lt;&gt;(action, weight));</span>
        }
<span class="fc" id="L457">    }</span>

    /**
     * Calculates a tax raise.
     *
     * @param random The &lt;code&gt;Random&lt;/code&gt; number source to use.
     * @return The new tax rate.
     */
    public int raiseTax(Random random) {
<span class="nc" id="L466">        final Specification spec = getSpecification();</span>
<span class="nc" id="L467">        int taxAdjustment = spec.getInteger(GameOptions.TAX_ADJUSTMENT);</span>
<span class="nc" id="L468">        int turn = getGame().getTurn().getNumber();</span>
<span class="nc" id="L469">        int oldTax = player.getTax();</span>
<span class="nc" id="L470">        int adjust = Math.max(1, (6 - taxAdjustment) * 10); // 20-60</span>
<span class="nc" id="L471">        adjust = 1 + randomInt(logger, &quot;Tax rise&quot;, random, 5 + turn/adjust);</span>
<span class="nc" id="L472">        return Math.min(oldTax + adjust, taxMaximum());</span>
    }

    /**
     * Calculates a tax reduction.
     *
     * @param random The &lt;code&gt;Random&lt;/code&gt; number source to use.
     * @return The new tax rate.
     */
    public int lowerTax(Random random) {
<span class="nc" id="L482">        final Specification spec = getSpecification();</span>
<span class="nc" id="L483">        int taxAdjustment = spec.getInteger(GameOptions.TAX_ADJUSTMENT);</span>
<span class="nc" id="L484">        int oldTax = player.getTax();</span>
<span class="nc" id="L485">        int adjust = Math.max(1, 10 - taxAdjustment); // 5-10</span>
<span class="nc" id="L486">        adjust = 1 + randomInt(logger, &quot;Tax reduction&quot;, random, adjust);</span>
<span class="nc" id="L487">        return Math.max(oldTax - adjust, Monarch.MINIMUM_TAX_RATE);</span>
    }

    // @compat 0.10.5
    /**
     * Get a unit type for the REF navy.  Bugfix workaround.
     *
     * @return A naval REF unit type.
     */
    public UnitType getNavalREFUnitType() {
<span class="fc" id="L497">        initializeCaches();</span>
<span class="fc" id="L498">        return navalREFUnitTypes.get(0);</span>
    }
    // end @compat 0.10.5

    /**
     * Gets units to be added to the Royal Expeditionary Force.
     *
     * @param random The &lt;code&gt;Random&lt;/code&gt; number source to use.
     * @return An addition to the Royal Expeditionary Force.
     */
    public AbstractUnit chooseForREF(Random random) {
<span class="nc" id="L509">        initializeCaches();</span>

<span class="nc" id="L511">        final Specification spec = getSpecification();</span>
        // Preserve some extra naval capacity so that not all the REF
        // navy is completely loaded
        // FIXME: magic number 2.5 * Manowar-capacity = 15
<span class="nc" id="L515">        Force ref = getExpeditionaryForce();</span>
<span class="nc bnc" id="L516" title="All 2 branches missed.">        boolean needNaval = ref.getCapacity()</span>
<span class="nc" id="L517">            &lt; ref.getSpaceRequired() + 15;</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">        List&lt;UnitType&gt; types = (needNaval) ? navalREFUnitTypes</span>
<span class="nc" id="L519">            : landREFUnitTypes;</span>
<span class="nc bnc" id="L520" title="All 2 branches missed.">        if (types.isEmpty()) return null;</span>
<span class="nc" id="L521">        UnitType unitType = getRandomMember(logger, &quot;Choose REF unit&quot;,</span>
<span class="nc" id="L522">                                            types, random);</span>
<span class="nc bnc" id="L523" title="All 2 branches missed.">        Role role = (needNaval</span>
<span class="nc bnc" id="L524" title="All 2 branches missed.">            || !unitType.hasAbility(Ability.CAN_BE_EQUIPPED))</span>
<span class="nc" id="L525">            ? spec.getDefaultRole()</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">            : (randomInt(logger, &quot;Choose land role&quot;, random, 3) == 0)</span>
<span class="nc" id="L527">            ? refMountedRole</span>
<span class="nc" id="L528">            : refArmedRole;</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">        int number = (needNaval) ? 1</span>
<span class="nc" id="L530">            : randomInt(logger, &quot;Choose land#&quot;, random, 3) + 1;</span>
<span class="nc" id="L531">        AbstractUnit result = new AbstractUnit(unitType, role.getId(), number);</span>
<span class="nc" id="L532">        logger.info(&quot;Add to &quot; + player.getDebugName()</span>
<span class="nc" id="L533">            + &quot; REF: capacity=&quot; + ref.getCapacity()</span>
<span class="nc" id="L534">            + &quot; spaceRequired=&quot; + ref.getSpaceRequired()</span>
<span class="nc" id="L535">            + &quot; =&gt; &quot; + result);</span>
<span class="nc" id="L536">        return result;</span>
    }

    /**
     * Update the intervention force, adding land units depending on
     * turns passed, and naval units sufficient to transport all land
     * units.
     */
    public void updateInterventionForce() {
<span class="nc" id="L545">        Specification spec = getSpecification();</span>
<span class="nc" id="L546">        int interventionTurns = spec.getInteger(GameOptions.INTERVENTION_TURNS);</span>
<span class="nc bnc" id="L547" title="All 2 branches missed.">        if (interventionTurns &gt; 0) {</span>
<span class="nc" id="L548">            Force ivf = getInterventionForce();</span>
<span class="nc" id="L549">            int updates = getGame().getTurn().getNumber() / interventionTurns;</span>
<span class="nc bnc" id="L550" title="All 2 branches missed.">            for (AbstractUnit unit : ivf.getLandUnits()) {</span>
                // add units depending on current turn
<span class="nc" id="L552">                int value = unit.getNumber() + updates;</span>
<span class="nc" id="L553">                unit.setNumber(value);</span>
            }
<span class="nc" id="L555">            ivf.updateSpaceAndCapacity();</span>
<span class="nc bnc" id="L556" title="All 2 branches missed.">            while (ivf.getCapacity() &lt; ivf.getSpaceRequired()) {</span>
<span class="nc" id="L557">                boolean progress = false;</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">                for (AbstractUnit ship : ivf.getNavalUnits()) {</span>
                    // add ships until all units can be transported at once
<span class="nc bnc" id="L560" title="All 2 branches missed.">                    if (ship.getType(spec).canCarryUnits()</span>
<span class="nc bnc" id="L561" title="All 2 branches missed.">                        &amp;&amp; ship.getType(spec).getSpace() &gt; 0) {</span>
<span class="nc" id="L562">                        int value = ship.getNumber() + 1;</span>
<span class="nc" id="L563">                        ship.setNumber(value);</span>
<span class="nc" id="L564">                        progress = true;</span>
                    }
                }
<span class="nc bnc" id="L567" title="All 2 branches missed.">                if (!progress) break;</span>
<span class="nc" id="L568">                ivf.updateSpaceAndCapacity();</span>
            }
        }
<span class="nc" id="L571">    }</span>

    /**
     * Gets a additions to the colonial forces.
     *
     * @param random The &lt;code&gt;Random&lt;/code&gt; number source to use.
     * @param naval If the addition should be a naval unit.
     * @return An addition to the colonial forces.
     */
    public List&lt;AbstractUnit&gt; getSupport(Random random, boolean naval) {
<span class="nc" id="L581">        initializeCaches();</span>

<span class="nc" id="L583">        final Specification spec = getSpecification();</span>
<span class="nc" id="L584">        List&lt;AbstractUnit&gt; support = new ArrayList&lt;&gt;();</span>
        
<span class="nc bnc" id="L586" title="All 2 branches missed.">        if (naval) {</span>
<span class="nc" id="L587">            support.add(new AbstractUnit(getRandomMember(logger,</span>
<span class="nc" id="L588">                        &quot;Choose naval support&quot;, navalTypes, random),</span>
<span class="nc" id="L589">                        Specification.DEFAULT_ROLE_ID, 1));</span>
<span class="nc" id="L590">            setSupportSea(true);</span>
<span class="nc" id="L591">            return support;</span>
        }

        /**
         * FIXME: we should use a total strength value, and randomly
         * add individual units until that limit has been
         * reached. E.g. given a value of 10, we might select two
         * units with strength 5, or three units with strength 3 (plus
         * one with strength 1, if there is one).
         */
<span class="nc" id="L601">        int difficulty = spec.getInteger(GameOptions.MONARCH_SUPPORT);</span>
<span class="nc bnc" id="L602" title="All 6 branches missed.">        switch (difficulty) {</span>
        case 4:
<span class="nc" id="L604">            support.add(new AbstractUnit(getRandomMember(logger,</span>
<span class="nc" id="L605">                        &quot;Choose bombard&quot;, bombardTypes, random),</span>
<span class="nc" id="L606">                        Specification.DEFAULT_ROLE_ID, 1));</span>
<span class="nc" id="L607">            support.add(new AbstractUnit(getRandomMember(logger,</span>
<span class="nc" id="L608">                        &quot;Choose mounted&quot;, landTypes, random),</span>
<span class="nc" id="L609">                        mountedRole.getId(), 2));</span>
<span class="nc" id="L610">            break;</span>
        case 3:
<span class="nc" id="L612">            support.add(new AbstractUnit(getRandomMember(logger,</span>
<span class="nc" id="L613">                        &quot;Choose mounted&quot;, landTypes, random),</span>
<span class="nc" id="L614">                        mountedRole.getId(), 2));</span>
<span class="nc" id="L615">            support.add(new AbstractUnit(getRandomMember(logger,</span>
<span class="nc" id="L616">                        &quot;Choose soldier&quot;, landTypes, random),</span>
<span class="nc" id="L617">                        armedRole.getId(), 1));</span>
<span class="nc" id="L618">            break;</span>
        case 2:
<span class="nc" id="L620">            support.add(new AbstractUnit(getRandomMember(logger,</span>
<span class="nc" id="L621">                        &quot;Choose mounted&quot;, landTypes, random),</span>
<span class="nc" id="L622">                        mountedRole.getId(), 2));</span>
<span class="nc" id="L623">            break;</span>
        case 1:
<span class="nc" id="L625">            support.add(new AbstractUnit(getRandomMember(logger,</span>
<span class="nc" id="L626">                        &quot;Choose mounted&quot;, landTypes, random),</span>
<span class="nc" id="L627">                        mountedRole.getId(), 1));</span>
<span class="nc" id="L628">            support.add(new AbstractUnit(getRandomMember(logger,</span>
<span class="nc" id="L629">                        &quot;Choose soldier&quot;, landTypes, random),</span>
<span class="nc" id="L630">                        armedRole.getId(), 1));</span>
<span class="nc" id="L631">            break;</span>
        case 0:
<span class="nc" id="L633">            support.add(new AbstractUnit(getRandomMember(logger,</span>
<span class="nc" id="L634">                        &quot;Choose soldier&quot;, landTypes, random),</span>
<span class="nc" id="L635">                        armedRole.getId(), 1));</span>
<span class="nc" id="L636">            break;</span>
        default:
            break;
        }
<span class="nc" id="L640">        return support;</span>
    }

    /**
     * Check if the monarch provides support for a war.
     *
     * @param enemy The enemy &lt;code&gt;Player&lt;/code&gt;.
     * @param random A pseudo-random number source.
     * @return A list of &lt;code&gt;AbstractUnit&lt;/code&gt;s provided as support.
     */
    public List&lt;AbstractUnit&gt; getWarSupport(Player enemy, Random random) {
<span class="nc" id="L651">        final Specification spec = getSpecification();</span>
<span class="nc" id="L652">        final double baseStrength = player.calculateStrength(false);</span>
<span class="nc" id="L653">        final double enemyStrength = enemy.calculateStrength(false);</span>
<span class="nc" id="L654">        final double strengthRatio</span>
<span class="nc" id="L655">            = Player.strengthRatio(baseStrength, enemyStrength);</span>
<span class="nc" id="L656">        List&lt;AbstractUnit&gt; result = new ArrayList&lt;AbstractUnit&gt;();</span>
        // We do not really know what Col1 did to decide whether to
        // provide war support, so we have made something up.
        //
        // Strength ratios are in [0, 1].  Support is granted in negative
        // proportion to the base strength ratio, such that we always
        // support if the enemy is stronger (ratio &lt; 0.5), and never
        // support if the player is more than 50% stronger (ratio &gt;
        // 0.6).  However if war support force sufficiently large with
        // respect to the current player and enemy forces it will be
        // reduced.
        // The principle at work is that the Crown is cautious/stingy.
<span class="nc" id="L668">        final double NOSUPPORT = 0.6;</span>
<span class="nc" id="L669">        double p = 10.0 * (NOSUPPORT - strengthRatio);</span>
<span class="nc bnc" id="L670" title="All 2 branches missed.">        if (p &gt;= 1.0 // Avoid calling randomDouble if unnecessary</span>
<span class="nc bnc" id="L671" title="All 4 branches missed.">            || (p &gt; 0.0 &amp;&amp; p &gt; randomDouble(logger, &quot;War support?&quot;, random))) {</span>
<span class="nc" id="L672">            Force wsf = getWarSupportForce();</span>
<span class="nc" id="L673">            result.addAll(wsf.getUnits());</span>
            double supportStrength, fullRatio, strength, ratio;
<span class="nc" id="L675">            supportStrength = wsf.calculateStrength(false);</span>
<span class="nc" id="L676">            fullRatio = Player.strengthRatio(baseStrength + supportStrength,</span>
<span class="nc" id="L677">                                             enemyStrength);</span>
<span class="nc bnc" id="L678" title="All 2 branches missed.">            if (fullRatio &lt; NOSUPPORT) { // Full support, some randomization</span>
<span class="nc bnc" id="L679" title="All 2 branches missed.">                for (AbstractUnit au : result) {</span>
<span class="nc" id="L680">                    int amount = au.getNumber();</span>
<span class="nc" id="L681">                    amount += randomInt(logger, &quot;Vary war force &quot; + au.getId(),</span>
<span class="nc" id="L682">                                        random, 3) - 1;</span>
<span class="nc" id="L683">                    au.setNumber(amount);</span>
                }
<span class="nc bnc" id="L685" title="All 2 branches missed.">            } else if (enemyStrength &lt;= 0.0) { // Enemy is defenceless: 1 unit</span>
<span class="nc bnc" id="L686" title="All 2 branches missed.">                while (result.size() &gt; 1) result.remove(0);</span>
<span class="nc" id="L687">                result.get(0).setNumber(1);</span>
<span class="nc" id="L688">            } else { // Reduce force until below NOSUPPORT or single unit/s</span>
<span class="nc bnc" id="L689" title="All 2 branches missed.">                outer: for (AbstractUnit au : result) {</span>
<span class="nc bnc" id="L690" title="All 2 branches missed.">                    for (int n = au.getNumber() - 1; n &gt;= 1; n--) {</span>
<span class="nc" id="L691">                        au.setNumber(n);</span>
<span class="nc" id="L692">                        strength = AbstractUnit.calculateStrength(spec, result);</span>
<span class="nc" id="L693">                        ratio = Player.strengthRatio(baseStrength + strength,</span>
<span class="nc" id="L694">                                                     enemyStrength);</span>
<span class="nc bnc" id="L695" title="All 2 branches missed.">                        if (ratio &lt; NOSUPPORT) break outer;</span>
                    }
                }
            }
<span class="nc" id="L699">            strength = AbstractUnit.calculateStrength(spec, result);</span>
<span class="nc" id="L700">            ratio = Player.strengthRatio(baseStrength+strength, enemyStrength);</span>
<span class="nc" id="L701">            logger.finest(&quot;War support:&quot;</span>
<span class="nc" id="L702">                + &quot; initially=&quot; + supportStrength + &quot;/&quot; + fullRatio</span>
<span class="nc" id="L703">                + &quot; finally=&quot; + strength + &quot;/&quot; + ratio);</span>
        }
<span class="nc" id="L705">        return result;</span>
    }
        
    /**
     * Gets some units available as mercenaries.
     *
     * @param random The &lt;code&gt;Random&lt;/code&gt; number source to use.
     * @return A troop of mercenaries.
     */
    public List&lt;AbstractUnit&gt; getMercenaries(Random random) {
<span class="nc" id="L715">        initializeCaches();</span>

<span class="nc" id="L717">        final Specification spec = getSpecification();</span>
<span class="nc" id="L718">        final Role defaultRole = spec.getDefaultRole();</span>
<span class="nc" id="L719">        final int mercPrice = spec.getInteger(GameOptions.MERCENARY_PRICE);</span>
<span class="nc" id="L720">        List&lt;Role&gt; landRoles = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L721">        landRoles.add(armedRole);</span>
<span class="nc" id="L722">        landRoles.add(mountedRole);</span>

        // FIXME: magic numbers for 2-4 mercs
<span class="nc" id="L725">        List&lt;AbstractUnit&gt; mercs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L726">        int count = randomInt(logger, &quot;Mercenary count&quot;, random, 2) + 2;</span>
<span class="nc" id="L727">        int price = 0;</span>
<span class="nc" id="L728">        UnitType unitType = null;</span>
<span class="nc" id="L729">        List&lt;UnitType&gt; unitTypes = new ArrayList&lt;&gt;(mercenaryTypes);</span>
<span class="nc bnc" id="L730" title="All 4 branches missed.">        while (!unitTypes.isEmpty() &amp;&amp; count &gt; 0) {</span>
<span class="nc" id="L731">            unitType = getRandomMember(logger, &quot;Merc unit&quot;,</span>
<span class="nc" id="L732">                                       unitTypes, random);</span>
<span class="nc" id="L733">            unitTypes.remove(unitType);</span>
<span class="nc bnc" id="L734" title="All 2 branches missed.">            Role role = (unitType.hasAbility(Ability.CAN_BE_EQUIPPED))</span>
<span class="nc" id="L735">                ? getRandomMember(logger, &quot;Merc role&quot;,</span>
<span class="nc" id="L736">                                  landRoles, random)</span>
<span class="nc" id="L737">                : defaultRole;</span>
<span class="nc" id="L738">            int n = randomInt(logger, &quot;Merc count &quot; + unitType,</span>
<span class="nc" id="L739">                              random, Math.min(count, 2)) + 1;</span>
<span class="nc" id="L740">            AbstractUnit au = new AbstractUnit(unitType, role.getId(), n);</span>
<span class="nc" id="L741">            for (;;) {</span>
<span class="nc" id="L742">                int newPrice = player.getPrice(au) * mercPrice / 100;</span>
<span class="nc bnc" id="L743" title="All 2 branches missed.">                if (player.checkGold(price + newPrice)) {</span>
<span class="nc" id="L744">                    mercs.add(au);</span>
<span class="nc" id="L745">                    price += newPrice;</span>
<span class="nc" id="L746">                    count -= n;</span>
<span class="nc" id="L747">                    break;</span>
                }
<span class="nc bnc" id="L749" title="All 2 branches missed.">                if (--n &lt;= 0) break;</span>
<span class="nc" id="L750">                au.setNumber(n);</span>
            }
<span class="nc bnc" id="L752" title="All 2 branches missed.">            if (count &lt;= 0) break;</span>
        }

        /* Always return something, even if it is not affordable */
<span class="nc bnc" id="L756" title="All 4 branches missed.">        if (mercs.isEmpty() &amp;&amp; unitType != null) {</span>
<span class="nc bnc" id="L757" title="All 2 branches missed.">            Role r = (unitType.hasAbility(Ability.CAN_BE_EQUIPPED))</span>
<span class="nc" id="L758">                ? armedRole : defaultRole;</span>
<span class="nc" id="L759">            mercs.add(new AbstractUnit(unitType, r.getId(), 1));</span>
        }
<span class="nc" id="L761">        return mercs;</span>
    }


    // Interface Named

    /**
     * {@inheritDoc}
     */
    @Override
    public String getNameKey() {
<span class="nc" id="L772">        return this.player.getNation().getRulerNameKey();</span>
    }


    // Override FreeColGameObject

    /**
     * {@inheritDoc}
     */
    @Override
    public int checkIntegrity(boolean fix) {
<span class="fc" id="L783">        int result = super.checkIntegrity(fix);</span>
        // @compat 0.10.x
        // Detects/fixes bogus expeditionary force roles
<span class="fc" id="L786">        List&lt;AbstractUnit&gt; todo = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L787">        Force ref = getExpeditionaryForce();</span>
<span class="fc" id="L788">        Iterator&lt;AbstractUnit&gt; it = ref.getLandUnits()</span>
<span class="fc" id="L789">            .iterator();</span>
<span class="fc bfc" id="L790" title="All 2 branches covered.">        while (it.hasNext()) {</span>
<span class="fc" id="L791">            AbstractUnit au = it.next();</span>
<span class="pc bpc" id="L792" title="1 of 2 branches missed.">            if (&quot;model.role.soldier&quot;.equals(au.getRoleId())) {</span>
<span class="nc bnc" id="L793" title="All 2 branches missed.">                if (fix) {</span>
<span class="nc" id="L794">                    au.setRoleId(&quot;model.role.infantry&quot;);</span>
<span class="nc" id="L795">                    result = 0;</span>
<span class="nc" id="L796">                    it.remove();</span>
<span class="nc" id="L797">                    todo.add(au);</span>
<span class="nc" id="L798">                } else {</span>
<span class="nc" id="L799">                    return -1;</span>
                }
            }
<span class="pc bpc" id="L802" title="1 of 2 branches missed.">            if (&quot;model.role.dragoon&quot;.equals(au.getRoleId())) {</span>
<span class="nc bnc" id="L803" title="All 2 branches missed.">                if (fix) {</span>
<span class="nc" id="L804">                    au.setRoleId(&quot;model.role.cavalry&quot;);</span>
<span class="nc" id="L805">                    result = 0;</span>
<span class="nc" id="L806">                    it.remove();</span>
<span class="nc" id="L807">                    todo.add(au);</span>
<span class="nc" id="L808">                } else {</span>
<span class="nc" id="L809">                    return -1;</span>
                }
            }
        }
<span class="pc bpc" id="L813" title="1 of 2 branches missed.">        for (AbstractUnit au : todo) ref.add(au);</span>
        // end @compat 0.10.x
<span class="fc" id="L815">        return result;</span>
    }


    // Serialization

    private static final String DISPLEASURE_TAG = &quot;displeasure&quot;;
    private static final String EXPEDITIONARY_FORCE_TAG = &quot;expeditionaryForce&quot;;
    private static final String INTERVENTION_FORCE_TAG = &quot;interventionForce&quot;;
    private static final String PLAYER_TAG = &quot;player&quot;;
    private static final String SUPPORT_SEA_TAG = &quot;supportSea&quot;;
    // @compat 0.11.1
    private static final String NAME_TAG = &quot;name&quot;;
    // end @compat 0.11.1
    // @compat 0.11.5
<span class="fc" id="L830">    private static final String MERCENARY_FORCE_TAG = &quot;mercenaryForce&quot;;</span>
    // end @compat 0.11.5


    /**
     * {@inheritDoc}
     */
    @Override
    protected void writeAttributes(FreeColXMLWriter xw) throws XMLStreamException {
<span class="fc" id="L839">        super.writeAttributes(xw);</span>

<span class="fc" id="L841">        xw.writeAttribute(PLAYER_TAG, this.player);</span>

<span class="pc bpc" id="L843" title="1 of 2 branches missed.">        if (xw.validFor(this.player)) {</span>

<span class="fc" id="L845">            xw.writeAttribute(SUPPORT_SEA_TAG, supportSea);</span>

<span class="fc" id="L847">            xw.writeAttribute(DISPLEASURE_TAG, displeasure);</span>
        }
<span class="fc" id="L849">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    protected void writeChildren(FreeColXMLWriter xw) throws XMLStreamException {
<span class="fc" id="L856">        super.writeChildren(xw);</span>

<span class="pc bpc" id="L858" title="1 of 2 branches missed.">        if (xw.validFor(this.player)) {</span>

<span class="fc" id="L860">            getExpeditionaryForce().toXML(xw, EXPEDITIONARY_FORCE_TAG);</span>

<span class="fc" id="L862">            getInterventionForce().toXML(xw, INTERVENTION_FORCE_TAG);</span>
        }
<span class="fc" id="L864">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    protected void readAttributes(FreeColXMLReader xr) throws XMLStreamException {
<span class="fc" id="L871">        super.readAttributes(xr);</span>

<span class="fc" id="L873">        player = xr.findFreeColGameObject(getGame(), PLAYER_TAG,</span>
<span class="fc" id="L874">                                          Player.class, (Player)null, true);</span>

<span class="fc" id="L876">        supportSea = xr.getAttribute(SUPPORT_SEA_TAG, false);</span>

<span class="fc" id="L878">        displeasure = xr.getAttribute(DISPLEASURE_TAG, false);</span>
<span class="fc" id="L879">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    protected void readChildren(FreeColXMLReader xr) throws XMLStreamException {
<span class="fc" id="L886">        final Specification spec = getSpecification();</span>
        // Provide dummy forces to read into.
<span class="pc bpc" id="L888" title="1 of 2 branches missed.">        if (expeditionaryForce == null) expeditionaryForce = new Force(spec);</span>
<span class="pc bpc" id="L889" title="1 of 2 branches missed.">        if (interventionForce == null) interventionForce = new Force(spec);</span>

<span class="fc" id="L891">        super.readChildren(xr);</span>
<span class="fc" id="L892">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    protected void readChild(FreeColXMLReader xr) throws XMLStreamException {
<span class="fc" id="L899">        final String tag = xr.getLocalName();</span>

<span class="fc bfc" id="L901" title="All 2 branches covered.">        if (EXPEDITIONARY_FORCE_TAG.equals(tag)) {</span>
<span class="fc" id="L902">            expeditionaryForce.readFromXML(xr);</span>
            // @compat 0.11.3
<span class="fc" id="L904">            expeditionaryForce.fixOldREFRoles();</span>
            // end @compat 0.11.3

<span class="pc bpc" id="L907" title="1 of 2 branches missed.">        } else if (INTERVENTION_FORCE_TAG.equals(tag)) {</span>
<span class="fc" id="L908">            interventionForce.readFromXML(xr);</span>

        // @compat 0.10.5
<span class="pc bnc" id="L911" title="All 2 branches missed.">        } else if (Force.LAND_UNITS_TAG.equals(tag)) {</span>
<span class="nc" id="L912">            expeditionaryForce.getLandUnits().clear();</span>
<span class="nc bnc" id="L913" title="All 2 branches missed.">            while (xr.nextTag() != XMLStreamConstants.END_ELEMENT) {</span>
<span class="nc" id="L914">                AbstractUnit newUnit = new AbstractUnit(xr);</span>
<span class="nc" id="L915">                expeditionaryForce.getLandUnits().add(newUnit);</span>
            }
        // end @compat

        // @compat 0.11.5
        // Mercenary force is never updated, and lives in the spec now, so
        // just read and discard it.
<span class="nc bnc" id="L922" title="All 2 branches missed.">        } else if (MERCENARY_FORCE_TAG.equals(tag)) {</span>
<span class="nc" id="L923">            new Force(getSpecification()).readFromXML(xr);</span>
        // end @compat 0.11.5
            
        // @compat 0.10.5
<span class="nc bnc" id="L927" title="All 2 branches missed.">        } else if (Force.NAVAL_UNITS_TAG.equals(tag)) {</span>
<span class="nc" id="L928">            expeditionaryForce.getNavalUnits().clear();</span>
<span class="nc bnc" id="L929" title="All 2 branches missed.">            while (xr.nextTag() != XMLStreamConstants.END_ELEMENT) {</span>
<span class="nc" id="L930">                AbstractUnit newUnit = new AbstractUnit(xr);</span>
<span class="nc" id="L931">                expeditionaryForce.getNavalUnits().add(newUnit);</span>
            }
        // end @compat

<span class="nc" id="L935">        } else {</span>
<span class="nc" id="L936">            super.readChild(xr);</span>
        }
<span class="fc" id="L938">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
<span class="fc" id="L944">    public String getXMLTagName() { return getTagName(); }</span>

    /**
     * Gets the tag name of the root element representing this object.
     *
     * @return &quot;monarch&quot;.
     */
    public static String getTagName() {
<span class="fc" id="L952">        return &quot;monarch&quot;;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span>src (May 7, 2016 6:04:12 PM)</div></body></html>