<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>SimpleMapGenerator.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">src (May 7, 2016 6:04:12 PM)</a> &gt; <a href="../../index.html" class="el_group">FreeCol</a> &gt; <a href="../index.html" class="el_bundle">src</a> &gt; <a href="index.source.html" class="el_package">net.sf.freecol.server.generator</a> &gt; <span class="el_source">SimpleMapGenerator.java</span></div><h1>SimpleMapGenerator.java</h1><pre class="source lang-java linenums">/**
 *  Copyright (C) 2002-2016   The FreeCol Team
 *
 *  This file is part of FreeCol.
 *
 *  FreeCol is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  FreeCol is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with FreeCol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package net.sf.freecol.server.generator;

import java.io.File;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;
import java.util.List;
import java.util.Map.Entry;
import java.util.Random;
import java.util.logging.Logger;

import net.sf.freecol.common.debug.FreeColDebugger;
import net.sf.freecol.common.i18n.Messages;
import net.sf.freecol.common.model.Ability;
import net.sf.freecol.common.model.AbstractUnit;
import net.sf.freecol.common.model.Building;
import net.sf.freecol.common.model.BuildingType;
import net.sf.freecol.common.model.Colony;
import net.sf.freecol.common.model.ColonyTile;
import net.sf.freecol.common.model.EuropeanNationType;
import net.sf.freecol.common.model.FreeColObject;
import net.sf.freecol.common.model.Game;
import net.sf.freecol.common.model.GameOptions;
import net.sf.freecol.common.model.Goods;
import net.sf.freecol.common.model.GoodsType;
import net.sf.freecol.common.model.IndianNationType;
import net.sf.freecol.common.model.IndianSettlement;
import net.sf.freecol.common.model.LandMap;
import net.sf.freecol.common.model.LostCityRumour;
import net.sf.freecol.common.model.Map;
import net.sf.freecol.common.model.Direction;
import net.sf.freecol.common.model.Map.Position;
import net.sf.freecol.common.model.Nation;
import net.sf.freecol.common.model.NationType;
import net.sf.freecol.common.model.Player;
import net.sf.freecol.common.model.Role;
import net.sf.freecol.common.model.Settlement;
import net.sf.freecol.common.model.Specification;
import net.sf.freecol.common.model.Tile;
import net.sf.freecol.common.model.TileImprovement;
import net.sf.freecol.common.model.TileImprovementType;
import net.sf.freecol.common.model.TileType;
import net.sf.freecol.common.model.Unit;
import net.sf.freecol.common.model.UnitType;
import net.sf.freecol.common.option.IntegerOption;
import net.sf.freecol.common.option.FileOption;
import net.sf.freecol.common.option.MapGeneratorOptions;
import net.sf.freecol.common.option.OptionGroup;
import net.sf.freecol.common.util.LogBuilder;
import net.sf.freecol.common.util.RandomChoice;
import static net.sf.freecol.common.util.CollectionUtils.*;
import static net.sf.freecol.common.util.RandomUtils.*;
import net.sf.freecol.server.FreeColServer;
import net.sf.freecol.server.model.ServerBuilding;
import net.sf.freecol.server.model.ServerColony;
import net.sf.freecol.server.model.ServerIndianSettlement;
import net.sf.freecol.server.model.ServerPlayer;
import net.sf.freecol.server.model.ServerRegion;
import net.sf.freecol.server.model.ServerUnit;


/**
 * Creates random maps and sets the starting locations for the players.
 *
 * No visibility implications here as this all happens pre-game,
 * so no +/-vis annotations are needed.
 */
public class SimpleMapGenerator implements MapGenerator {

<span class="fc" id="L90">    private static final Logger logger = Logger.getLogger(SimpleMapGenerator.class.getName());</span>

    /**
     * To avoid starting positions too close to the poles, this
     * percentage indicating how much of the half map close to the
     * pole cannot be spawned on.
     */
<span class="fc" id="L97">    private static final float MIN_DISTANCE_FROM_POLE = 0.30f;</span>

   
    private static class Territory {
        public ServerRegion region;
        public Tile tile;
        public final Player player;
        public int numberOfSettlements;

<span class="nc" id="L106">        public Territory(Player player, Tile tile) {</span>
<span class="nc" id="L107">            this.player = player;</span>
<span class="nc" id="L108">            this.tile = tile;</span>
<span class="nc" id="L109">        }</span>

<span class="fc" id="L111">        public Territory(Player player, ServerRegion region) {</span>
<span class="fc" id="L112">            this.player = player;</span>
<span class="fc" id="L113">            this.region = region;</span>
<span class="fc" id="L114">        }</span>

        public Tile getCenterTile(Map map) {
<span class="fc bfc" id="L117" title="All 2 branches covered.">            if (tile != null) return tile;</span>
<span class="fc" id="L118">            int[] xy = region.getCenter();</span>
<span class="fc" id="L119">            return map.getTile(xy[0], xy[1]);</span>
        }

        /**
         * {@inheritDoc}
         */
        @Override
        public String toString() {
<span class="nc" id="L127">            return player + &quot; territory at &quot; + region;</span>
        }
    }

    /** The game to generate for. */
    private final Game game;

    /** The random number source. */
    private final Random random;

    /** The cached map generator options. */
    private OptionGroup mapOptions;

    /** The cached specification to use. */
    private Specification spec;

    /** The game to selectively import from. */
    private Game importGame;


    /**
     * Creates a &lt;code&gt;MapGenerator&lt;/code&gt;
     *
     * @param game The &lt;code&gt;Game&lt;/code&gt; to generate for.
     * @param random The &lt;code&gt;Random&lt;/code&gt; number source to use.
     * @see #createMap
     */
<span class="fc" id="L154">    public SimpleMapGenerator(Game game, Random random) {</span>
<span class="fc" id="L155">        this.game = game;</span>
<span class="fc" id="L156">        this.random = random;</span>
<span class="fc" id="L157">    }</span>


    /**
     * Update the cached variables.
     *
     * @param checkImport Check for an import file or not.
     */
    private void recache(boolean checkImport) {
<span class="fc" id="L166">        this.mapOptions = game.getMapGeneratorOptions();</span>
<span class="fc" id="L167">        this.spec = game.getSpecification();</span>
<span class="pc bpc" id="L168" title="1 of 2 branches missed.">        File importFile = (checkImport) ? ((FileOption)this.mapOptions</span>
<span class="fc" id="L169">            .getOption(MapGeneratorOptions.IMPORT_FILE)).getValue()</span>
<span class="nc" id="L170">            : null;</span>
<span class="fc bfc" id="L171" title="All 2 branches covered.">        this.importGame = (importFile == null) ? null</span>
<span class="fc" id="L172">            : FreeColServer.readGame(importFile, this.spec, null);</span>
<span class="fc" id="L173">    }</span>

    /**
     * Gets the approximate number of land tiles.
     *
     * @return The approximate number of land tiles
     */
    private int getApproximateLandCount() {
<span class="fc" id="L181">        return mapOptions.getInteger(MapGeneratorOptions.MAP_WIDTH)</span>
<span class="fc" id="L182">            * mapOptions.getInteger(MapGeneratorOptions.MAP_HEIGHT)</span>
<span class="fc" id="L183">            * mapOptions.getInteger(MapGeneratorOptions.LAND_MASS) / 100;</span>
    }

    /**
     * Make lost city rumours on the given map.
     *
     * The number of rumours depends on the map size.
     *
     * @param map The &lt;code&gt;Map&lt;/code&gt; to use.
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     */
    private void makeLostCityRumours(Map map, LogBuilder lb) {
<span class="fc" id="L195">        final boolean importRumours</span>
<span class="fc" id="L196">            = mapOptions.getBoolean(MapGeneratorOptions.IMPORT_RUMOURS);</span>
<span class="pc bpc" id="L197" title="1 of 4 branches missed.">        if (importGame != null &amp;&amp; importRumours) {</span>
<span class="nc" id="L198">            int nLCRs = 0;</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">            for (Tile importTile : importGame.getMap().getAllTiles()) {</span>
<span class="nc" id="L200">                LostCityRumour rumour = importTile.getLostCityRumour();</span>
                // no rumor
<span class="nc bnc" id="L202" title="All 2 branches missed.">                if (rumour == null) continue;</span>
<span class="nc" id="L203">                int x = importTile.getX();</span>
<span class="nc" id="L204">                int y = importTile.getY();</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">                if (map.isValid(x, y)) {</span>
<span class="nc" id="L206">                    final Tile t = map.getTile(x, y);</span>
<span class="nc" id="L207">                    rumour.setLocation(t);</span>
<span class="nc" id="L208">                    t.addLostCityRumour(rumour);</span>
<span class="nc" id="L209">                    nLCRs++;</span>
                }
            }
<span class="nc bnc" id="L212" title="All 2 branches missed.">            if (nLCRs &gt; 0) {</span>
<span class="nc" id="L213">                lb.add(&quot;Imported &quot;, nLCRs, &quot; lost city rumours.\n&quot;);</span>
<span class="nc" id="L214">                return;</span>
            }
            // Otherwise fall through and create them
        }

<span class="fc" id="L219">        final int rumourNumber</span>
<span class="fc" id="L220">            = mapOptions.getInteger(MapGeneratorOptions.RUMOUR_NUMBER);</span>
<span class="fc" id="L221">        int number = getApproximateLandCount() / rumourNumber;</span>
<span class="fc" id="L222">        int counter = 0;</span>

        // FIXME: Remove temporary fix:
<span class="fc bfc" id="L225" title="All 2 branches covered.">        if (importGame != null) {</span>
<span class="fc" id="L226">            number = map.getWidth() * map.getHeight() * 25 / (100 * 35);</span>
        }

<span class="fc bfc" id="L229" title="All 2 branches covered.">        for (int i = 0; i &lt; number; i++) {</span>
<span class="pc bpc" id="L230" title="1 of 2 branches missed.">            for (int tries = 0; tries &lt; 100; tries++) {</span>
<span class="fc" id="L231">                Tile t = map.getRandomLandTile(random);</span>
<span class="fc bfc" id="L232" title="All 2 branches covered.">                if (t.isPolar()) continue; // No polar lost cities</span>
<span class="pc bpc" id="L233" title="1 of 4 branches missed.">                if (t.isLand() &amp;&amp; !t.hasLostCityRumour()</span>
<span class="pc bpc" id="L234" title="1 of 4 branches missed.">                    &amp;&amp; !t.hasSettlement() &amp;&amp; t.getUnitCount() == 0) {</span>
<span class="fc" id="L235">                    LostCityRumour r = new LostCityRumour(t.getGame(), t);</span>
<span class="fc bfc" id="L236" title="All 2 branches covered.">                    if (r.chooseType(null, random)</span>
<span class="fc" id="L237">                        == LostCityRumour.RumourType.MOUNDS</span>
<span class="fc bfc" id="L238" title="All 2 branches covered.">                        &amp;&amp; t.getOwningSettlement() != null) {</span>
<span class="fc" id="L239">                        r.setType(LostCityRumour.RumourType.MOUNDS);</span>
                    }
<span class="fc" id="L241">                    t.addLostCityRumour(r);</span>
<span class="fc" id="L242">                    counter++;</span>
<span class="fc" id="L243">                    break;</span>
                }
            }
        }
<span class="fc" id="L247">        lb.add(&quot;Created &quot;, counter,</span>
<span class="fc" id="L248">            &quot; lost city rumours of maximum &quot;, number, &quot;.\n&quot;);</span>
<span class="fc" id="L249">    }</span>

    private boolean importIndianSettlements(Map map, LogBuilder lb) {
<span class="nc" id="L252">        int nSettlements = 0;</span>
        
<span class="nc bnc" id="L254" title="All 2 branches missed.">        for (Player player : importGame.getLiveNativePlayers(null)) {</span>
<span class="nc" id="L255">            Player indian = game.getPlayerByNationId(player.getNationId());</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">            if (indian == null) {</span>
<span class="nc" id="L257">                Nation nation = spec.getNation(player.getNationId());</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">                if (nation == null) {</span>
<span class="nc" id="L259">                    lb.add(&quot;Native nation &quot;, player.getNationId(),</span>
<span class="nc" id="L260">                        &quot; not found in spec.\n&quot;);</span>
<span class="nc" id="L261">                    continue;</span>
                }
<span class="nc" id="L263">                indian = new ServerPlayer(game, false, nation, null, null);</span>
<span class="nc" id="L264">                lb.add(&quot;Imported new native nation &quot;, player.getNationId(),</span>
<span class="nc" id="L265">                    &quot;: &quot;, indian.getId(), &quot;\n&quot;);</span>
<span class="nc" id="L266">                game.addPlayer(indian);</span>
<span class="nc" id="L267">            } else {</span>
<span class="nc" id="L268">                lb.add(&quot;Found native nation &quot;, player.getNationId(),</span>
<span class="nc" id="L269">                    &quot; for import: &quot;, indian.getId(), &quot;\n&quot;);</span>
            }
        }
<span class="nc bnc" id="L272" title="All 2 branches missed.">        for (Tile tile : importGame.getMap().getAllTiles()) {</span>
<span class="nc" id="L273">            IndianSettlement is = tile.getIndianSettlement();</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">            if (is == null) continue;</span>
<span class="nc" id="L275">            Player indian = game.getPlayerByNationId(is.getOwner().getNationId());</span>
<span class="nc" id="L276">            ServerIndianSettlement settlement</span>
<span class="nc" id="L277">                = new ServerIndianSettlement(game, indian, is.getName(),</span>
<span class="nc" id="L278">                    map.getTile(tile.getX(), tile.getY()), is.isCapital(),</span>
<span class="nc" id="L279">                    is.getLearnableSkill(), null);</span>
<span class="nc" id="L280">            settlement.placeSettlement(false);</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">            for (Tile t : is.getOwnedTiles()) {</span>
<span class="nc" id="L282">                map.getTile(t.getX(), t.getY())</span>
<span class="nc" id="L283">                    .changeOwnership(indian, settlement);</span>
            }
                
<span class="nc" id="L286">            List&lt;Unit&gt; units = is.getUnitList();</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">            if (units.isEmpty()) {</span>
<span class="nc" id="L288">                settlement.addUnits(random);</span>
<span class="nc" id="L289">            } else {</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">                for (Unit unit : units) {</span>
<span class="nc" id="L291">                    UnitType t = spec.getUnitType(unit.getType().getId());</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">                    if (t != null) {</span>
<span class="nc" id="L293">                        Unit u = new ServerUnit(game, settlement, indian, t);</span>
<span class="nc" id="L294">                        settlement.add(u);</span>
<span class="nc" id="L295">                        settlement.addOwnedUnit(u);</span>
                    }
                }
            }
            
<span class="nc" id="L300">            List&lt;Goods&gt; goods = is.getCompactGoods();</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">            if (goods.isEmpty()) {</span>
<span class="nc" id="L302">                settlement.addRandomGoods(random);</span>
<span class="nc" id="L303">            } else {</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">                for (Goods g : goods) {</span>
<span class="nc" id="L305">                    GoodsType t = spec.getGoodsType(g.getType().getId());</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">                    if (t != null) {</span>
<span class="nc" id="L307">                        settlement.addGoods(t, g.getAmount());</span>
                    }
                }
            }
<span class="nc" id="L311">            settlement.setWantedGoods(is.getWantedGoods());</span>
<span class="nc" id="L312">            indian.addSettlement(settlement);</span>
<span class="nc" id="L313">            nSettlements++;</span>
        }

<span class="nc bnc" id="L316" title="All 2 branches missed.">        if (nSettlements &gt; 0) {</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">            for (Tile t : importGame.getMap().getAllTiles()) {</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">                if (t.getOwner() == null) continue;</span>
<span class="nc" id="L319">                Player owner = game.getPlayerByNationId(t.getOwner()</span>
<span class="nc" id="L320">                    .getNationId());</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">                if (owner == null) continue;</span>
<span class="nc" id="L322">                Tile tile = map.getTile(t.getX(), t.getY());</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">                if (tile == null) continue;</span>
<span class="nc" id="L324">                tile.setOwner(owner);</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">                if (tile.getOwningSettlement() != null) {</span>
<span class="nc" id="L326">                    String name = tile.getOwningSettlement().getName();</span>
<span class="nc" id="L327">                    Settlement is = game.getSettlementByName(name);</span>
<span class="nc" id="L328">                    tile.setOwningSettlement(is);</span>
                }
            }
        }
<span class="nc" id="L332">        lb.add(&quot;Imported &quot;, nSettlements, &quot; native settlements.\n&quot;);</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">        return nSettlements &gt; 0;</span>
    }

    /**
     * Make the native settlements, at least a capital for every
     * nation and random numbers of other settlements.
     *
     * @param map The &lt;code&gt;Map&lt;/code&gt; to place the indian settlements on.
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     */
    private void makeNativeSettlements(final Map map, LogBuilder lb) {
<span class="fc" id="L344">        final boolean importSettlements</span>
<span class="fc" id="L345">            = mapOptions.getBoolean(MapGeneratorOptions.IMPORT_SETTLEMENTS);</span>
<span class="pc bpc" id="L346" title="3 of 4 branches missed.">        if (importSettlements &amp;&amp; importGame != null) {</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">            if (importIndianSettlements(map, lb)) return;</span>
            // Fall through and create them
        }
        
<span class="fc" id="L351">        final Game game = map.getGame();</span>
<span class="fc" id="L352">        float shares = 0f;</span>
<span class="fc" id="L353">        List&lt;IndianSettlement&gt; settlements = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L354">        List&lt;Player&gt; indians = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L355">        HashMap&lt;String, Territory&gt; territoryMap = new HashMap&lt;&gt;();</span>

<span class="fc bfc" id="L357" title="All 2 branches covered.">        for (Player player : game.getLiveNativePlayers(null)) {</span>
<span class="pc bpc" id="L358" title="1 of 4 branches missed.">            switch (player.getNationType().getNumberOfSettlements()) {</span>
            case HIGH:
<span class="fc" id="L360">                shares += 4;</span>
<span class="fc" id="L361">                break;</span>
            case AVERAGE:
<span class="fc" id="L363">                shares += 3;</span>
<span class="fc" id="L364">                break;</span>
            case LOW:
<span class="fc" id="L366">                shares += 2;</span>
                break;
            }
<span class="fc" id="L369">            indians.add(player);</span>
<span class="fc" id="L370">            List&lt;String&gt; regionKeys</span>
<span class="fc" id="L371">                = ((IndianNationType)player.getNationType()).getRegionNames();</span>
<span class="fc" id="L372">            Territory territory = null;</span>
<span class="pc bpc" id="L373" title="2 of 4 branches missed.">            if (regionKeys == null || regionKeys.isEmpty()) {</span>
<span class="nc" id="L374">                territory = new Territory(player, map.getRandomLandTile(random));</span>
<span class="nc" id="L375">                territoryMap.put(player.getId(), territory);</span>
<span class="nc" id="L376">            } else {</span>
<span class="pc bpc" id="L377" title="1 of 2 branches missed.">                for (String key : regionKeys) {</span>
<span class="pc bpc" id="L378" title="1 of 2 branches missed.">                    if (territoryMap.get(key) == null) {</span>
<span class="fc" id="L379">                        ServerRegion region = (ServerRegion)map.getRegionByKey(key);</span>
<span class="pc bpc" id="L380" title="1 of 2 branches missed.">                        if (region == null) {</span>
<span class="nc" id="L381">                            territory = new Territory(player, map.getRandomLandTile(random));</span>
<span class="nc" id="L382">                        } else {</span>
<span class="fc" id="L383">                            territory = new Territory(player, region);</span>
                        }
<span class="fc" id="L385">                        territoryMap.put(key, territory);</span>
<span class="fc" id="L386">                        lb.add(&quot;Allocated region &quot;, key,</span>
<span class="fc" id="L387">                            &quot; for &quot;, player, &quot;.\n&quot;);</span>
<span class="fc" id="L388">                        break;</span>
                    }
                }
<span class="pc bpc" id="L391" title="1 of 2 branches missed.">                if (territory == null) {</span>
<span class="nc" id="L392">                    lb.add(&quot;Failed to allocate preferred region &quot;,</span>
<span class="nc" id="L393">                        regionKeys.get(0), &quot; for &quot;, player.getNation(), &quot;\n&quot;);</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">                    outer: for (String key : regionKeys) {</span>
<span class="nc" id="L395">                        Territory otherTerritory = territoryMap.get(key);</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">                        for (String otherKey : ((IndianNationType) otherTerritory.player.getNationType())</span>
<span class="nc" id="L397">                                 .getRegionNames()) {</span>
<span class="nc bnc" id="L398" title="All 2 branches missed.">                            if (territoryMap.get(otherKey) == null) {</span>
<span class="nc" id="L399">                                ServerRegion foundRegion = otherTerritory.region;</span>
<span class="nc" id="L400">                                otherTerritory.region = (ServerRegion)map.getRegionByKey(otherKey);</span>
<span class="nc" id="L401">                                territoryMap.put(otherKey, otherTerritory);</span>
<span class="nc" id="L402">                                territory = new Territory(player, foundRegion);</span>
<span class="nc" id="L403">                                territoryMap.put(key, territory);</span>
<span class="nc" id="L404">                                break outer;</span>
                            }
                        }
                    }
<span class="nc bnc" id="L408" title="All 2 branches missed.">                    if (territory == null) {</span>
<span class="nc" id="L409">                        lb.add(&quot;Unable to find free region for &quot;,</span>
<span class="nc" id="L410">                            player.getName(), &quot;\n&quot;);</span>
<span class="nc" id="L411">                        territory = new Territory(player, map.getRandomLandTile(random));</span>
<span class="nc" id="L412">                        territoryMap.put(player.getId(), territory);</span>
                    }
                }
            }
        }
<span class="fc bfc" id="L417" title="All 2 branches covered.">        if (indians.isEmpty()) return;</span>

        // Examine all the non-polar settleable tiles in a random
        // order picking out as many as possible suitable tiles for
        // native settlements such that can be guaranteed at least one
        // layer of surrounding tiles to own.
<span class="fc" id="L423">        List&lt;Tile&gt; allTiles = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L424" title="All 2 branches covered.">        for (Tile t : map.getAllTiles()) allTiles.add(t);</span>
<span class="fc" id="L425">        randomShuffle(logger, &quot;All tile shuffle&quot;, allTiles, random);</span>
<span class="fc" id="L426">        final int minDistance</span>
<span class="fc" id="L427">            = spec.getRangeOption(GameOptions.SETTLEMENT_NUMBER).getValue();</span>
<span class="fc" id="L428">        List&lt;Tile&gt; settlementTiles = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L429" title="All 2 branches covered.">        for (Tile tile : allTiles) {</span>
<span class="fc bfc" id="L430" title="All 2 branches covered.">            if (!tile.isPolar()</span>
<span class="fc bfc" id="L431" title="All 2 branches covered.">                &amp;&amp; suitableForNativeSettlement(tile)</span>
<span class="fc bfc" id="L432" title="All 4 branches covered.">                &amp;&amp; none(settlementTiles, t -&gt; t.getDistanceTo(tile) &lt; minDistance))</span>
<span class="fc" id="L433">                settlementTiles.add(tile);</span>
        }
<span class="fc" id="L435">        randomShuffle(logger, &quot;Settlement tiles&quot;, settlementTiles, random);</span>

        // Check number of settlements.
<span class="fc" id="L438">        int settlementsToPlace = settlementTiles.size();</span>
<span class="fc" id="L439">        float share = settlementsToPlace / shares;</span>
<span class="pc bpc" id="L440" title="1 of 2 branches missed.">        if (settlementTiles.size() &lt; indians.size()) {</span>
            // FIXME: something drastic to boost the settlement number
<span class="nc" id="L442">            lb.add(&quot;There are only &quot;, settlementTiles.size(),</span>
<span class="nc" id="L443">                &quot; settlement sites.\n&quot;,</span>
<span class="nc" id="L444">                &quot; This is smaller than &quot;, indians.size(),</span>
<span class="nc" id="L445">                &quot; the number of tribes.\n&quot;);</span>
        }

        // Find the capitals
<span class="fc" id="L449">        List&lt;Territory&gt; territories</span>
<span class="fc" id="L450">            = new ArrayList&lt;&gt;(territoryMap.values());</span>
<span class="fc" id="L451">        int settlementsPlaced = 0;</span>
<span class="fc bfc" id="L452" title="All 2 branches covered.">        for (Territory territory : territories) {</span>
<span class="pc bpc" id="L453" title="1 of 4 branches missed.">            switch (territory.player.getNationType().getNumberOfSettlements()) {</span>
            case HIGH:
<span class="fc" id="L455">                territory.numberOfSettlements = Math.round(4 * share);</span>
<span class="fc" id="L456">                break;</span>
            case AVERAGE:
<span class="fc" id="L458">                territory.numberOfSettlements = Math.round(3 * share);</span>
<span class="fc" id="L459">                break;</span>
            case LOW:
<span class="fc" id="L461">                territory.numberOfSettlements = Math.round(2 * share);</span>
                break;
<span class="fc" id="L463">            }</span>
<span class="fc" id="L464">            int radius = territory.player.getNationType().getCapitalType()</span>
<span class="fc" id="L465">                .getClaimableRadius();</span>
<span class="fc" id="L466">            IndianSettlement is = placeCapital(map, territory, radius,</span>
<span class="fc" id="L467">                new ArrayList&lt;&gt;(settlementTiles), lb);</span>
<span class="pc bpc" id="L468" title="1 of 2 branches missed.">            if (is != null) {</span>
<span class="fc" id="L469">                settlements.add(is);</span>
<span class="fc" id="L470">                settlementsPlaced++;</span>
<span class="fc" id="L471">                settlementTiles.remove(is.getTile());</span>
            }
        }

        // Sort tiles from the edges of the map inward
<span class="fc" id="L476">        Collections.sort(settlementTiles, Tile.edgeDistanceComparator);</span>

        // Now place other settlements
<span class="pc bpc" id="L479" title="1 of 4 branches missed.">        while (!settlementTiles.isEmpty() &amp;&amp; !territories.isEmpty()) {</span>
<span class="fc" id="L480">            Tile tile = settlementTiles.remove(0);</span>
<span class="pc bpc" id="L481" title="1 of 2 branches missed.">            if (tile.getOwner() != null) continue; // No close overlap</span>

<span class="fc" id="L483">            Territory territory = getClosestTerritory(map, tile, territories);</span>
<span class="fc" id="L484">            int radius = territory.player.getNationType().getSettlementType(false)</span>
<span class="fc" id="L485">                .getClaimableRadius();</span>
            // Insist that the settlement can not be linear
<span class="fc" id="L487">            if (territory.player.getClaimableTiles(tile, radius).size()</span>
<span class="pc bpc" id="L488" title="1 of 2 branches missed.">                &gt; 2 * radius + 1) {</span>
<span class="pc bpc" id="L489" title="1 of 2 branches missed.">                String name = (territory.region == null) ? &quot;default region&quot;</span>
<span class="fc" id="L490">                    : territory.region.toString();</span>
<span class="fc" id="L491">                lb.add(&quot;Placing a &quot;, territory.player,</span>
<span class="fc" id="L492">                    &quot; camp in region: &quot;, name,</span>
<span class="fc" id="L493">                    &quot; at tile: &quot;, tile, &quot;\n&quot;);</span>
<span class="fc" id="L494">                settlements.add(placeIndianSettlement(territory.player,</span>
<span class="fc" id="L495">                                                      false, tile, map, lb));</span>
<span class="fc" id="L496">                settlementsPlaced++;</span>
<span class="fc" id="L497">                territory.numberOfSettlements--;</span>
<span class="fc bfc" id="L498" title="All 2 branches covered.">                if (territory.numberOfSettlements &lt;= 0) {</span>
<span class="fc" id="L499">                    territories.remove(territory);</span>
                }

            }
        }

        // Grow some more tiles.
        // FIXME: move the magic numbers below to the spec
        // Also collect the skills provided
<span class="fc" id="L508">        HashMap&lt;UnitType, List&lt;IndianSettlement&gt;&gt; skills = new HashMap&lt;&gt;();</span>
<span class="fc" id="L509">        randomShuffle(logger, &quot;Settlements&quot;, settlements, random);</span>
<span class="fc bfc" id="L510" title="All 2 branches covered.">        for (IndianSettlement is : settlements) {</span>
<span class="fc" id="L511">            List&lt;Tile&gt; tiles = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L512" title="All 2 branches covered.">            for (Tile tile : is.getOwnedTiles()) {</span>
<span class="fc bfc" id="L513" title="All 2 branches covered.">                for (Tile t : tile.getSurroundingTiles(1)) {</span>
<span class="fc bfc" id="L514" title="All 2 branches covered.">                    if (t.getOwningSettlement() == null) {</span>
<span class="fc" id="L515">                        tiles.add(tile);</span>
<span class="fc" id="L516">                        break;</span>
                    }
                }
            }
<span class="fc" id="L520">            randomShuffle(logger, &quot;Settlement tiles&quot;, tiles, random);</span>
<span class="fc" id="L521">            int minGrow = is.getType().getMinimumGrowth();</span>
<span class="fc" id="L522">            int maxGrow = is.getType().getMaximumGrowth();</span>
<span class="pc bpc" id="L523" title="1 of 2 branches missed.">            if (maxGrow &gt; minGrow) {</span>
<span class="fc bfc" id="L524" title="All 2 branches covered.">                for (int i = randomInt(logger, &quot;Gdiff&quot;, random,</span>
<span class="fc" id="L525">                                       maxGrow - minGrow) + minGrow;</span>
<span class="fc" id="L526">                     i &gt; 0; i--) {</span>
<span class="fc" id="L527">                    Tile tile = findFreeNeighbouringTile(is, tiles);</span>
<span class="fc bfc" id="L528" title="All 2 branches covered.">                    if (tile == null) break;</span>
<span class="fc" id="L529">                    tile.changeOwnership(is.getOwner(), is);</span>
<span class="fc" id="L530">                    tiles.add(tile);</span>
                }
            }

            // Collect settlements by skill
<span class="fc" id="L535">            UnitType skill = is.getLearnableSkill();</span>
<span class="fc" id="L536">            List&lt;IndianSettlement&gt; isList = skills.get(skill);</span>
<span class="fc bfc" id="L537" title="All 2 branches covered.">            if (isList == null) {</span>
<span class="fc" id="L538">                isList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L539">                isList.add(is);</span>
<span class="fc" id="L540">                skills.put(skill, isList);</span>
<span class="fc" id="L541">            } else {</span>
<span class="fc" id="L542">                isList.add(is);</span>
            }
        }

        // Require that there be experts for all the new world goods types.
        // Collect the list of needed experts
<span class="fc" id="L548">        List&lt;UnitType&gt; expertsNeeded = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L549" title="All 2 branches covered.">        for (GoodsType goodsType : spec.getNewWorldGoodsTypeList()) {</span>
<span class="fc" id="L550">            UnitType expert = spec.getExpertForProducing(goodsType);</span>
<span class="fc bfc" id="L551" title="All 2 branches covered.">            if (!skills.containsKey(expert)) expertsNeeded.add(expert);</span>
        }
        // Extract just the settlement lists.
<span class="fc" id="L554">        List&lt;List&lt;IndianSettlement&gt;&gt; isList = new ArrayList&lt;&gt;(skills.values());</span>
        // For each missing skill...
<span class="fc bfc" id="L556" title="All 2 branches covered.">        while (!expertsNeeded.isEmpty()) {</span>
<span class="fc" id="L557">            UnitType neededSkill = expertsNeeded.remove(0);</span>
<span class="fc" id="L558">            Collections.sort(isList, descendingListLengthComparator);</span>
<span class="fc" id="L559">            List&lt;IndianSettlement&gt; extras = isList.remove(0);</span>
<span class="fc" id="L560">            UnitType extraSkill = extras.get(0).getLearnableSkill();</span>
<span class="fc" id="L561">            List&lt;RandomChoice&lt;IndianSettlement&gt;&gt; choices = new ArrayList&lt;&gt;();</span>
            // ...look at the settlements with the most common skill
            // with a bit of favoritism to capitals as the needed skill
            // is so rare,...
<span class="fc bfc" id="L565" title="All 2 branches covered.">            for (IndianSettlement is : extras) {</span>
<span class="fc" id="L566">                IndianNationType nation</span>
<span class="fc" id="L567">                    = (IndianNationType) is.getOwner().getNationType();</span>
<span class="fc bfc" id="L568" title="All 2 branches covered.">                int cm = (is.isCapital()) ? 2 : 1;</span>
<span class="fc" id="L569">                RandomChoice&lt;IndianSettlement&gt; rc = null;</span>
<span class="fc bfc" id="L570" title="All 2 branches covered.">                for (RandomChoice&lt;UnitType&gt; c : nation.generateSkillsForTile(is.getTile())) {</span>
<span class="fc bfc" id="L571" title="All 2 branches covered.">                    if (c.getObject() == neededSkill) {</span>
<span class="fc" id="L572">                        rc = new RandomChoice&lt;&gt;(is, c.getProbability() * cm);</span>
<span class="fc" id="L573">                        break;</span>
                    }
                }
<span class="fc bfc" id="L576" title="All 2 branches covered.">                choices.add((rc != null) ? rc</span>
<span class="fc" id="L577">                            : new RandomChoice&lt;&gt;(is, 1));</span>
            }
<span class="pc bpc" id="L579" title="1 of 2 branches missed.">            if (!choices.isEmpty()) {</span>
                // ...and pick one that could do the missing job.
<span class="fc" id="L581">                IndianSettlement chose = RandomChoice</span>
<span class="fc" id="L582">                    .getWeightedRandom(logger, &quot;expert&quot;, choices, random);</span>
<span class="fc" id="L583">                lb.add(&quot;At &quot;, chose.getName(),</span>
<span class="fc" id="L584">                    &quot; replaced &quot;, extraSkill,</span>
<span class="fc" id="L585">                    &quot; (one of &quot;, extras.size(), &quot;)&quot;,</span>
<span class="fc" id="L586">                    &quot; by missing &quot;, neededSkill, &quot;\n&quot;);</span>
<span class="fc" id="L587">                chose.setLearnableSkill(neededSkill);</span>
<span class="fc" id="L588">                extras.remove(chose);</span>
<span class="fc" id="L589">                isList.add(0, extras); // Try to stay well sorted</span>
<span class="fc" id="L590">                List&lt;IndianSettlement&gt; neededList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L591">                neededList.add(chose);</span>
<span class="fc" id="L592">                isList.add(neededList);</span>
<span class="fc" id="L593">            } else { // `can not happen'</span>
<span class="nc" id="L594">                lb.add(&quot;Game is missing skill: &quot;, neededSkill, &quot;\n&quot;);</span>
            }
        }
<span class="fc" id="L597">        lb.add(&quot;Settlement skills:&quot;);</span>
<span class="fc bfc" id="L598" title="All 2 branches covered.">        for (List&lt;IndianSettlement&gt; iss : isList) {</span>
<span class="pc bpc" id="L599" title="1 of 2 branches missed.">            if (iss.isEmpty()) {</span>
<span class="nc" id="L600">                lb.add(&quot;  0 x &lt;none&gt;&quot;);</span>
<span class="nc" id="L601">            } else {</span>
<span class="fc" id="L602">                lb.add(&quot;  &quot;, iss.size(),</span>
<span class="fc" id="L603">                    &quot; x &quot;, iss.get(0).getLearnableSkill().getSuffix());</span>
            }
        }
<span class="fc" id="L606">        lb.add(&quot;\nCreated &quot;, settlementsPlaced,</span>
<span class="fc" id="L607">            &quot; Indian settlements of maximum &quot;, settlementsToPlace, &quot;.\n&quot;);</span>
<span class="fc" id="L608">    }</span>

    /**
     * Is a tile suitable for a native settlement?
     * Require the tile be settleable, and at least half its neighbours
     * also be settleable.
     *
     * FIXME: degrade the second test to usability, but wait until the
     * natives-use-water situation is sorted.
     *
     * @param tile The &lt;code&gt;Tile&lt;/code&gt; to examine.
     * @return True if this tile is suitable.
     */
    private boolean suitableForNativeSettlement(Tile tile) {
<span class="fc bfc" id="L622" title="All 2 branches covered.">        if (!tile.getType().canSettle()) return false;</span>
<span class="fc" id="L623">        int good = 0, n = 0;</span>
<span class="fc bfc" id="L624" title="All 2 branches covered.">        for (Tile t : tile.getSurroundingTiles(1)) {</span>
<span class="fc bfc" id="L625" title="All 2 branches covered.">            if (t.getType().canSettle()) good++;</span>
<span class="fc" id="L626">            n++;</span>
        }
<span class="fc bfc" id="L628" title="All 2 branches covered.">        return good &gt;= n / 2;</span>
    }

    private Tile findFreeNeighbouringTile(IndianSettlement is,
                                          List&lt;Tile&gt; tiles) {
<span class="fc bfc" id="L633" title="All 2 branches covered.">        for (Tile tile : tiles) {</span>
<span class="fc bfc" id="L634" title="All 2 branches covered.">            for (Direction d : Direction.getRandomDirections(&quot;freeTile&quot;,</span>
<span class="fc" id="L635">                    logger, random)) {</span>
<span class="fc" id="L636">                Tile t = tile.getNeighbourOrNull(d);</span>
<span class="pc bpc" id="L637" title="1 of 2 branches missed.">                if ((t != null)</span>
<span class="fc bfc" id="L638" title="All 2 branches covered.">                    &amp;&amp; (t.getOwningSettlement() == null)</span>
<span class="fc bfc" id="L639" title="All 2 branches covered.">                    &amp;&amp; (is.getOwner().canClaimForSettlement(t))) return t;</span>
            }
        }
<span class="fc" id="L642">        return null;</span>
    }

    private Territory getClosestTerritory(Map map, Tile tile,
                                          List&lt;Territory&gt; territories) {
<span class="fc" id="L647">        Territory result = null;</span>
<span class="fc" id="L648">        int minimumDistance = Integer.MAX_VALUE;</span>
<span class="fc bfc" id="L649" title="All 2 branches covered.">        for (Territory territory : territories) {</span>
<span class="fc" id="L650">            int distance = map.getDistance(tile, territory.getCenterTile(map));</span>
<span class="fc bfc" id="L651" title="All 2 branches covered.">            if (distance &lt; minimumDistance) {</span>
<span class="fc" id="L652">                minimumDistance = distance;</span>
<span class="fc" id="L653">                result = territory;</span>
            }
        }
<span class="fc" id="L656">        return result;</span>
    }

    /**
     * Place a native capital in a territory.
     *
     * @param map The &lt;code&gt;Map&lt;/code&gt; to place the settlement in.
     * @param territory The &lt;code&gt;Territory&lt;/code&gt; within the map.
     * @param radius The settlement radius.
     * @param tiles A list of &lt;code&gt;Tile&lt;/code&gt;s to select from.
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     * @return The &lt;code&gt;IndianSettlement&lt;/code&gt; placed, or null if
     *     none placed.
     */
    private IndianSettlement placeCapital(final Map map, Territory territory,
                                          int radius, List&lt;Tile&gt; tiles,
                                          LogBuilder lb) {
<span class="fc" id="L673">        final Tile center = territory.getCenterTile(map);</span>
<span class="fc" id="L674">        Collections.sort(tiles, Comparator.comparingInt(t -&gt;</span>
<span class="fc" id="L675">                t.getDistanceTo(center)));</span>
<span class="pc bpc" id="L676" title="1 of 2 branches missed.">        for (Tile t : tiles) {</span>
            // Choose this tile if it is free and half the expected tile
            // claim can succeed (preventing capitals on small islands).
<span class="fc" id="L679">            if (territory.player.getClaimableTiles(t, radius).size()</span>
<span class="fc bfc" id="L680" title="All 2 branches covered.">                &gt;= (2 * radius + 1) * (2 * radius + 1) / 2) {</span>
<span class="pc bpc" id="L681" title="1 of 2 branches missed.">                String name = (territory.region == null) ? &quot;default region&quot;</span>
<span class="fc" id="L682">                    : territory.region.toString();</span>
<span class="fc" id="L683">                lb.add(&quot;Placing the &quot;, territory.player,</span>
<span class="fc" id="L684">                    &quot; capital in region: &quot;, name, &quot; at tile: &quot;, t, &quot;\n&quot;);</span>
<span class="fc" id="L685">                IndianSettlement is = placeIndianSettlement(territory.player,</span>
<span class="fc" id="L686">                    true, t, map, lb);</span>
<span class="fc" id="L687">                territory.numberOfSettlements--;</span>
<span class="fc" id="L688">                territory.tile = t;</span>
<span class="fc" id="L689">                return is;</span>
            }
        }
<span class="nc" id="L692">        return null;</span>
    }

    /**
     * Builds a &lt;code&gt;IndianSettlement&lt;/code&gt; at the given position.
     *
     * @param player The player owning the new settlement.
     * @param capital &lt;code&gt;true&lt;/code&gt; if the settlement should be a
     *      {@link IndianSettlement#isCapital() capital}.
     * @param tile The &lt;code&gt;Tile&lt;/code&gt; to place the settlement.
     * @param map The map that should get a new settlement.
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     * @return The &lt;code&gt;IndianSettlement&lt;/code&gt; just being placed
     *      on the map.
     */
    private IndianSettlement placeIndianSettlement(Player player,
        boolean capital, Tile tile, Map map, LogBuilder lb) {
<span class="fc bfc" id="L709" title="All 2 branches covered.">        String name = (capital) ? player.getCapitalName(random)</span>
<span class="fc" id="L710">            : player.getSettlementName(random);</span>
<span class="fc" id="L711">        UnitType skill</span>
<span class="fc" id="L712">            = generateSkillForLocation(map, tile, player.getNationType());</span>
<span class="fc" id="L713">        ServerIndianSettlement settlement</span>
<span class="fc" id="L714">            = new ServerIndianSettlement(map.getGame(), player, name, tile,</span>
<span class="fc" id="L715">                                         capital, skill, null);</span>
<span class="fc" id="L716">        player.addSettlement(settlement);</span>
<span class="fc" id="L717">        lb.add(&quot;Generated skill for &quot;, settlement.getName(),</span>
<span class="fc" id="L718">            &quot;: &quot;, settlement.getLearnableSkill().getSuffix(), &quot;\n&quot;);</span>

<span class="fc" id="L720">        settlement.placeSettlement(true);</span>
<span class="fc" id="L721">        settlement.addRandomGoods(random);</span>
<span class="fc" id="L722">        settlement.addUnits(random);</span>

<span class="fc" id="L724">        return settlement;</span>
    }

    /**
     * Generates a skill that could be taught from a settlement on the
     * given tile.
     *
     * @param map The &lt;code&gt;Map&lt;/code&gt;.
     * @param tile The &lt;code&gt;Tile&lt;/code&gt; where the settlement will be located.
     * @param nationType The &lt;code&gt;NationType&lt;/code&gt; to generate a skill for.
     * @return A skill that can be taught to Europeans.
     */
    private UnitType generateSkillForLocation(Map map, Tile tile,
                                              NationType nationType) {
<span class="fc" id="L738">        List&lt;RandomChoice&lt;UnitType&gt;&gt; skills</span>
<span class="fc" id="L739">            = ((IndianNationType)nationType).getSkills();</span>
<span class="fc" id="L740">        java.util.Map&lt;GoodsType, Integer&gt; scale</span>
<span class="fc" id="L741">            = toMap(skills,</span>
<span class="fc" id="L742">                    rc -&gt; rc.getObject().getExpertProduction(),</span>
<span class="fc" id="L743">                    rc -&gt; 1);</span>

<span class="fc bfc" id="L745" title="All 2 branches covered.">        for (Tile t: tile.getSurroundingTiles(1)) {</span>
<span class="fc bfc" id="L746" title="All 2 branches covered.">            for (Entry&lt;GoodsType, Integer&gt; entry : scale.entrySet()) {</span>
<span class="fc" id="L747">                GoodsType goodsType = entry.getKey();</span>
<span class="fc" id="L748">                scale.put(goodsType, entry.getValue()</span>
<span class="fc" id="L749">                          + t.getPotentialProduction(goodsType, null));</span>
            }
        }

<span class="fc" id="L753">        UnitType skill = RandomChoice.getWeightedRandom(null, null,</span>
<span class="fc" id="L754">            toList(map(skills, rc -&gt; {</span>
<span class="fc" id="L755">                        UnitType unitType = rc.getObject();</span>
<span class="fc" id="L756">                        return new RandomChoice&lt;&gt;(unitType, rc.getProbability()</span>
<span class="fc" id="L757">                            * scale.get(unitType.getExpertProduction()));</span>
                    })),
<span class="fc" id="L759">            random);</span>
<span class="fc" id="L760">        final Specification spec = map.getSpecification();</span>
<span class="pc bpc" id="L761" title="1 of 2 branches missed.">        return (skill != null) ? skill</span>
<span class="nc" id="L762">            : getRandomMember(logger, &quot;Scout&quot;,</span>
<span class="nc" id="L763">                spec.getUnitTypesWithAbility(Ability.EXPERT_SCOUT), random);</span>
    }

    /**
     * Create two ships, one with a colonist, for each player, and
     * select suitable starting positions.
     *
     * @param map The &lt;code&gt;Map&lt;/code&gt; to place the european units on.
     * @param players The players to create &lt;code&gt;Settlement&lt;/code&gt;s
     *      and starting locations for. That is; both indian and
     *      european players.
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     */
    private void createEuropeanUnits(Map map, List&lt;Player&gt; players,
                                     LogBuilder lb) {
<span class="fc" id="L778">        final int width = map.getWidth();</span>
<span class="fc" id="L779">        final int height = map.getHeight();</span>
<span class="fc" id="L780">        final int poleDistance = (int)(MIN_DISTANCE_FROM_POLE*height/2);</span>

<span class="fc" id="L782">        List&lt;Player&gt; europeanPlayers = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L783" title="All 2 branches covered.">        for (Player player : players) {</span>
<span class="fc bfc" id="L784" title="All 2 branches covered.">            if (player.isREF()) {</span>
                // eastern edge of the map
<span class="fc" id="L786">                int x = width - 2;</span>
                // random latitude, not too close to the pole
<span class="fc" id="L788">                int y = randomInt(logger, &quot;Pole&quot;, random,</span>
<span class="fc" id="L789">                                  height - 2*poleDistance) + poleDistance;</span>
<span class="fc" id="L790">                player.setEntryLocation(map.getTile(x, y));</span>
<span class="fc" id="L791">                continue;</span>
            }
<span class="pc bpc" id="L793" title="1 of 2 branches missed.">            if (player.isEuropean()) europeanPlayers.add(player);</span>
        }

<span class="fc" id="L796">        List&lt;Position&gt; positions = generateStartingPositions(map, europeanPlayers);</span>
<span class="fc" id="L797">        List&lt;Tile&gt; startingTiles = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L798">        List&lt;Unit&gt; carriers = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L799">        List&lt;Unit&gt; passengers = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L801" title="All 2 branches covered.">        for (int index = 0; index &lt; europeanPlayers.size(); index++) {</span>
<span class="fc" id="L802">            Player player = europeanPlayers.get(index);</span>
<span class="fc" id="L803">            Position position = positions.get(index);</span>
<span class="fc" id="L804">            lb.add(&quot;Generating units for player &quot;, player, &quot;.\n&quot;);</span>

<span class="fc" id="L806">            carriers.clear();</span>
<span class="fc" id="L807">            passengers.clear();</span>
<span class="fc" id="L808">            List&lt;AbstractUnit&gt; unitList = ((EuropeanNationType) player.getNationType())</span>
<span class="fc" id="L809">                .getStartingUnits();</span>
<span class="fc bfc" id="L810" title="All 2 branches covered.">            for (AbstractUnit startingUnit : unitList) {</span>
<span class="fc" id="L811">                UnitType type = startingUnit.getType(spec);</span>
<span class="fc" id="L812">                Role role = startingUnit.getRole(spec);</span>
<span class="fc" id="L813">                Unit newUnit = new ServerUnit(game, null, player, type, role);</span>
<span class="fc" id="L814">                newUnit.setName(player.getNameForUnit(type, random));</span>
<span class="fc bfc" id="L815" title="All 2 branches covered.">                if (newUnit.isNaval()) {</span>
<span class="pc bpc" id="L816" title="1 of 2 branches missed.">                    if (newUnit.canCarryUnits()) {</span>
<span class="fc" id="L817">                        newUnit.setState(Unit.UnitState.ACTIVE);</span>
<span class="fc" id="L818">                        carriers.add(newUnit);</span>
                    }
<span class="fc" id="L820">                } else {</span>
<span class="fc" id="L821">                    newUnit.setState(Unit.UnitState.SENTRY);</span>
<span class="fc" id="L822">                    passengers.add(newUnit);</span>
                }

            }

<span class="fc" id="L827">            boolean startAtSea = true;</span>
<span class="pc bpc" id="L828" title="1 of 2 branches missed.">            if (carriers.isEmpty()) {</span>
<span class="nc" id="L829">                lb.add(&quot;No carriers defined for player &quot;, player, &quot;.\n&quot;);</span>
<span class="nc" id="L830">                startAtSea = false;</span>
            }

<span class="fc" id="L833">            Tile startTile = null;</span>
<span class="fc" id="L834">            int x = position.getX();</span>
<span class="fc" id="L835">            int y = position.getY();</span>
<span class="pc bpc" id="L836" title="1 of 2 branches missed.">            for (int i = 0; i &lt; 2 * map.getHeight(); i++) {</span>
<span class="fc bfc" id="L837" title="All 2 branches covered.">                int offset = (i % 2 == 0) ? i / 2 : -(1 + i / 2);</span>
<span class="fc" id="L838">                int row = y + offset;</span>
<span class="pc bpc" id="L839" title="2 of 4 branches missed.">                if (row &lt; 0 || row &gt;= map.getHeight()) continue;</span>
<span class="fc" id="L840">                startTile = findTileFor(map, row, x, startAtSea, lb);</span>
<span class="fc bfc" id="L841" title="All 2 branches covered.">                if (startTile != null) {</span>
<span class="pc bpc" id="L842" title="1 of 2 branches missed.">                    if (startingTiles.contains(startTile)) {</span>
<span class="nc" id="L843">                        startTile = null;</span>
<span class="nc" id="L844">                    } else {</span>
<span class="fc" id="L845">                        startingTiles.add(startTile);</span>
<span class="fc" id="L846">                        break;</span>
                    }
                }
            }
<span class="pc bpc" id="L850" title="1 of 2 branches missed.">            if (startTile == null) {</span>
<span class="nc" id="L851">                LogBuilder lb2 = new LogBuilder(64);</span>
<span class="nc" id="L852">                lb2.add(&quot;Failed to find start tile &quot;,</span>
<span class="nc bnc" id="L853" title="All 2 branches missed.">                    ((startAtSea) ? &quot;at sea&quot; : &quot;on land&quot;),</span>
<span class="nc" id="L854">                    &quot; for player &quot;, player,</span>
<span class="nc" id="L855">                    &quot; from (&quot;, x, &quot;,&quot;, y, &quot;) avoiding:&quot;);</span>
<span class="nc bnc" id="L856" title="All 2 branches missed.">                for (Tile t : startingTiles) lb2.add(&quot; &quot;, t);</span>
<span class="nc" id="L857">                lb2.add(&quot; with map: &quot;);</span>
<span class="nc bnc" id="L858" title="All 2 branches missed.">                for (int xx = 0; xx &lt; map.getWidth(); xx++) {</span>
<span class="nc" id="L859">                    lb2.add(&quot; &quot;, map.getTile(xx, y));</span>
                }
<span class="nc" id="L861">                throw new RuntimeException(lb2.toString());</span>
            }

<span class="fc" id="L864">            player.setEntryLocation(startTile);</span>

<span class="pc bpc" id="L866" title="1 of 2 branches missed.">            if (startAtSea) {</span>
<span class="fc bfc" id="L867" title="All 2 branches covered.">                for (Unit carrier : carriers) {</span>
<span class="fc" id="L868">                    carrier.setLocation(startTile);</span>
<span class="fc" id="L869">                    ((ServerPlayer)player).exploreForUnit(carrier);</span>
                }
<span class="fc bfc" id="L871" title="All 2 branches covered.">                passengers: for (Unit unit : passengers) {</span>
<span class="pc bpc" id="L872" title="1 of 2 branches missed.">                    for (Unit carrier : carriers) {</span>
<span class="pc bpc" id="L873" title="1 of 2 branches missed.">                        if (carrier.canAdd(unit)) {</span>
<span class="fc" id="L874">                            unit.setLocation(carrier);</span>
<span class="fc" id="L875">                            continue passengers;</span>
                        }
                    }
                    // no space left on carriers
<span class="nc" id="L879">                    unit.setLocation(player.getEurope());</span>
                }
<span class="fc" id="L881">            } else {</span>
<span class="nc bnc" id="L882" title="All 2 branches missed.">                for (Unit unit : passengers) {</span>
<span class="nc" id="L883">                    unit.setLocation(startTile);</span>
<span class="nc" id="L884">                    ((ServerPlayer)player).exploreForUnit(unit);</span>
                }
            }

<span class="pc bpc" id="L888" title="1 of 2 branches missed.">            if (FreeColDebugger.isInDebugMode(FreeColDebugger.DebugMode.INIT)) {</span>
<span class="nc" id="L889">                createDebugUnits(map, player, startTile, lb);</span>
<span class="nc" id="L890">                IntegerOption op = spec.getIntegerOption(GameOptions.STARTING_MONEY);</span>
<span class="nc bnc" id="L891" title="All 2 branches missed.">                if (op != null) op.setValue(10000);</span>
            }
        }
<span class="fc" id="L894">    }</span>

    private Tile findTileFor(Map map, int row, int start, boolean startAtSea,
                             LogBuilder lb) {
<span class="fc" id="L898">        Tile tile = null;</span>
<span class="fc" id="L899">        Tile seas = null;</span>
<span class="pc bpc" id="L900" title="1 of 2 branches missed.">        int offset = (start == 0) ? 1 : -1;</span>
<span class="pc bpc" id="L901" title="1 of 4 branches missed.">        for (int x = start; 0 &lt;= x &amp;&amp; x &lt; map.getWidth(); x += offset) {</span>
<span class="fc" id="L902">            tile = map.getTile(x, row);</span>
<span class="fc bfc" id="L903" title="All 2 branches covered.">            if (tile.isDirectlyHighSeasConnected()) {</span>
<span class="fc" id="L904">                seas = tile;</span>
<span class="fc bfc" id="L905" title="All 2 branches covered.">            } else if (tile.isLand()) {</span>
<span class="pc bpc" id="L906" title="1 of 2 branches missed.">                return (startAtSea) ? seas : tile;</span>
            } 
        }
<span class="fc" id="L909">        lb.add(&quot;No land in row &quot;, row, &quot;.\n&quot;);</span>
<span class="fc" id="L910">        return null;</span>
    }

    private void createDebugUnits(Map map, Player player, Tile startTile,
                                  LogBuilder lb) {
        // In debug mode give each player a few more units and a colony.
<span class="nc" id="L916">        UnitType unitType = spec.getUnitType(&quot;model.unit.galleon&quot;);</span>
<span class="nc" id="L917">        Unit unit4 = new ServerUnit(game, startTile, player, unitType);</span>
<span class="nc" id="L918">        unitType = spec.getUnitType(&quot;model.unit.privateer&quot;);</span>
<span class="nc" id="L919">        Unit privateer = new ServerUnit(game, startTile, player, unitType);</span>
<span class="nc" id="L920">        ((ServerPlayer)player).exploreForUnit(privateer);</span>
<span class="nc" id="L921">        unitType = spec.getUnitType(&quot;model.unit.freeColonist&quot;);</span>
<span class="nc" id="L922">        Unit unit5 = new ServerUnit(game, unit4, player, unitType);</span>
<span class="nc" id="L923">        unitType = spec.getUnitType(&quot;model.unit.veteranSoldier&quot;);</span>
<span class="nc" id="L924">        Unit unit6 = new ServerUnit(game, unit4, player, unitType);</span>
<span class="nc" id="L925">        unitType = spec.getUnitType(&quot;model.unit.jesuitMissionary&quot;);</span>
<span class="nc" id="L926">        Unit unit7 = new ServerUnit(game, unit4, player, unitType);</span>

<span class="nc" id="L928">        Tile colonyTile = null;</span>
<span class="nc bnc" id="L929" title="All 2 branches missed.">        for (Tile tempTile : map.getCircleTiles(startTile, true, </span>
<span class="nc" id="L930">                                                FreeColObject.INFINITY)) {</span>
<span class="nc bnc" id="L931" title="All 2 branches missed.">            if (tempTile.isPolar()) continue; // No initial polar colonies</span>
<span class="nc bnc" id="L932" title="All 2 branches missed.">            if (player.canClaimToFoundSettlement(tempTile)) {</span>
<span class="nc" id="L933">                colonyTile = tempTile;</span>
<span class="nc" id="L934">                break;</span>
            }
        }

<span class="nc bnc" id="L938" title="All 2 branches missed.">        if (colonyTile == null) {</span>
<span class="nc" id="L939">            lb.add(&quot;Could not find a debug colony site.\n&quot;);</span>
<span class="nc" id="L940">            return;</span>
        }
<span class="nc bnc" id="L942" title="All 2 branches missed.">        colonyTile.setType(find(spec.getTileTypeList(), t -&gt; !t.isWater()));</span>
<span class="nc" id="L943">        unitType = spec.getUnitType(&quot;model.unit.expertFarmer&quot;);</span>
<span class="nc" id="L944">        Unit buildColonyUnit = new ServerUnit(game, colonyTile,</span>
<span class="nc" id="L945">                                              player, unitType);</span>
<span class="nc" id="L946">        String colonyName = Messages.message(player.getNationLabel())</span>
<span class="nc" id="L947">            + &quot; &quot; + Messages.message(&quot;Colony&quot;);</span>
<span class="nc" id="L948">        Colony colony = new ServerColony(game, player, colonyName, colonyTile);</span>
<span class="nc" id="L949">        player.addSettlement(colony);</span>
<span class="nc" id="L950">        colony.placeSettlement(true);</span>
<span class="nc bnc" id="L951" title="All 2 branches missed.">        for (Tile tile : colonyTile.getSurroundingTiles(1)) {</span>
<span class="nc bnc" id="L952" title="All 2 branches missed.">            if (!tile.hasSettlement()</span>
<span class="nc bnc" id="L953" title="All 2 branches missed.">                &amp;&amp; (tile.getOwner() == null</span>
<span class="nc bnc" id="L954" title="All 2 branches missed.">                    || !tile.getOwner().isEuropean())) {</span>
<span class="nc" id="L955">                tile.changeOwnership(player, colony);</span>
<span class="nc bnc" id="L956" title="All 2 branches missed.">                if (tile.hasLostCityRumour()) {</span>
<span class="nc" id="L957">                    tile.removeLostCityRumour();</span>
                }
            }
        }
<span class="nc" id="L961">        buildColonyUnit.setLocation(colony);</span>
<span class="nc bnc" id="L962" title="All 2 branches missed.">        if (buildColonyUnit.getLocation() instanceof ColonyTile) {</span>
<span class="nc" id="L963">            Tile ct = ((ColonyTile) buildColonyUnit.getLocation()).getWorkTile();</span>
<span class="nc bnc" id="L964" title="All 2 branches missed.">            for (TileType t : spec.getTileTypeList()) {</span>
<span class="nc bnc" id="L965" title="All 2 branches missed.">                if (!t.isWater()) {</span>
<span class="nc" id="L966">                    ct.setType(t);</span>
<span class="nc" id="L967">                    TileImprovementType plowType = map.getSpecification()</span>
<span class="nc" id="L968">                        .getTileImprovementType(&quot;model.improvement.plow&quot;);</span>
<span class="nc" id="L969">                    TileImprovement plow = new TileImprovement(game, ct, plowType);</span>
<span class="nc" id="L970">                    plow.setTurnsToComplete(0);</span>
<span class="nc" id="L971">                    ct.add(plow);</span>
<span class="nc" id="L972">                    break;</span>
                }
            }
        }
<span class="nc" id="L976">        BuildingType schoolType = spec.getBuildingType(&quot;model.building.schoolhouse&quot;);</span>
<span class="nc" id="L977">        Building schoolhouse = new ServerBuilding(game, colony, schoolType);</span>
<span class="nc" id="L978">        colony.addBuilding(schoolhouse);</span>

<span class="nc" id="L980">        unitType = spec.getUnitType(&quot;model.unit.elderStatesman&quot;);</span>
<span class="nc" id="L981">        Unit statesman = new ServerUnit(game, colonyTile, player, unitType);</span>
<span class="nc" id="L982">        statesman.setLocation(colony.getWorkLocationFor(statesman,</span>
<span class="nc" id="L983">                statesman.getType().getExpertProduction()));</span>

<span class="nc" id="L985">        unitType = spec.getUnitType(&quot;model.unit.expertLumberJack&quot;);</span>
<span class="nc" id="L986">        Unit lumberjack = new ServerUnit(game, colony, player, unitType);</span>
<span class="nc bnc" id="L987" title="All 2 branches missed.">        if (lumberjack.getLocation() instanceof ColonyTile) {</span>
<span class="nc" id="L988">            Tile lt = ((ColonyTile) lumberjack.getLocation()).getWorkTile();</span>
<span class="nc bnc" id="L989" title="All 2 branches missed.">            for (TileType t : spec.getTileTypeList()) {</span>
<span class="nc bnc" id="L990" title="All 2 branches missed.">                if (t.isForested()) {</span>
<span class="nc" id="L991">                    lt.setType(t);</span>
<span class="nc" id="L992">                    break;</span>
                }
            }
<span class="nc" id="L995">            lumberjack.changeWorkType(lumberjack.getType()</span>
<span class="nc" id="L996">                .getExpertProduction());</span>
        }

<span class="nc" id="L999">        unitType = spec.getUnitType(&quot;model.unit.masterCarpenter&quot;);</span>
<span class="nc" id="L1000">        Unit carpenter = new ServerUnit(game, colony, player, unitType);</span>

<span class="nc" id="L1002">        unitType = spec.getUnitType(&quot;model.unit.seasonedScout&quot;);</span>
<span class="nc" id="L1003">        Unit scout = new ServerUnit(game, colonyTile, player, unitType);</span>
<span class="nc" id="L1004">        ((ServerPlayer)player).exploreForUnit(scout);</span>

<span class="nc" id="L1006">        unitType = spec.getUnitType(&quot;model.unit.veteranSoldier&quot;);</span>
<span class="nc" id="L1007">        Unit unit8 = new ServerUnit(game, colonyTile, player, unitType);</span>
<span class="nc" id="L1008">        Unit unit9 = new ServerUnit(game, colonyTile, player, unitType);</span>
<span class="nc" id="L1009">        unitType = spec.getUnitType(&quot;model.unit.artillery&quot;);</span>
<span class="nc" id="L1010">        Unit unit10 = new ServerUnit(game, colonyTile, player, unitType);</span>
<span class="nc" id="L1011">        Unit unit11 = new ServerUnit(game, colonyTile, player, unitType);</span>
<span class="nc" id="L1012">        Unit unit12 = new ServerUnit(game, colonyTile, player, unitType);</span>
<span class="nc" id="L1013">        unitType = spec.getUnitType(&quot;model.unit.treasureTrain&quot;);</span>
<span class="nc" id="L1014">        Unit unit13 = new ServerUnit(game, colonyTile, player, unitType);</span>
<span class="nc" id="L1015">        unit13.setTreasureAmount(10000);</span>
<span class="nc" id="L1016">        unitType = spec.getUnitType(&quot;model.unit.wagonTrain&quot;);</span>
<span class="nc" id="L1017">        Unit unit14 = new ServerUnit(game, colonyTile, player, unitType);</span>
<span class="nc" id="L1018">        GoodsType cigarsType = spec.getGoodsType(&quot;model.goods.cigars&quot;);</span>
<span class="nc" id="L1019">        Goods cigards = new Goods(game, unit14, cigarsType, 5);</span>
<span class="nc" id="L1020">        unit14.add(cigards);</span>
<span class="nc" id="L1021">        unitType = spec.getUnitType(&quot;model.unit.jesuitMissionary&quot;);</span>
<span class="nc" id="L1022">        Unit unit15 = new ServerUnit(game, colonyTile, player, unitType);</span>
<span class="nc" id="L1023">        Unit unit16 = new ServerUnit(game, colonyTile, player, unitType);</span>

<span class="nc" id="L1025">        ((ServerPlayer)player).exploreForSettlement(colony);</span>
<span class="nc" id="L1026">    }</span>

    private List&lt;Position&gt; generateStartingPositions(Map map,
                                                     List&lt;Player&gt; players) {
<span class="fc" id="L1030">        int number = players.size();</span>
<span class="fc" id="L1031">        List&lt;Position&gt; positions = new ArrayList&lt;&gt;(number);</span>
<span class="fc bfc" id="L1032" title="All 2 branches covered.">        if (number &gt; 0) {</span>
<span class="fc" id="L1033">            int west = 0;</span>
<span class="fc" id="L1034">            int east = map.getWidth() - 1;</span>
<span class="pc bpc" id="L1035" title="3 of 4 branches missed.">            switch (spec.getInteger(GameOptions.STARTING_POSITIONS)) {</span>
            case GameOptions.STARTING_POSITIONS_CLASSIC:
<span class="fc" id="L1037">                int distance = map.getHeight() / number;</span>
<span class="fc" id="L1038">                int row = distance/2;</span>
<span class="fc bfc" id="L1039" title="All 2 branches covered.">                for (int index = 0; index &lt; number; index++) {</span>
<span class="fc" id="L1040">                    positions.add(new Position(east, row));</span>
<span class="fc" id="L1041">                    row += distance;</span>
                }
<span class="fc" id="L1043">                randomShuffle(logger, &quot;Classic starting positions&quot;,</span>
<span class="fc" id="L1044">                              positions, random);</span>
<span class="fc" id="L1045">                break;</span>
            case GameOptions.STARTING_POSITIONS_RANDOM:
<span class="nc" id="L1047">                distance = 2 * map.getHeight() / number;</span>
<span class="nc" id="L1048">                row = distance/2;</span>
<span class="nc bnc" id="L1049" title="All 2 branches missed.">                for (int index = 0; index &lt; number; index++) {</span>
<span class="nc bnc" id="L1050" title="All 2 branches missed.">                    if (index % 2 == 0) {</span>
<span class="nc" id="L1051">                        positions.add(new Position(east, row));</span>
<span class="nc" id="L1052">                    } else {</span>
<span class="nc" id="L1053">                        positions.add(new Position(west, row));</span>
<span class="nc" id="L1054">                        row += distance;</span>
                    }
                }
<span class="nc" id="L1057">                randomShuffle(logger, &quot;Random starting positions&quot;,</span>
<span class="nc" id="L1058">                              positions, random);</span>
<span class="nc" id="L1059">                break;</span>
            case GameOptions.STARTING_POSITIONS_HISTORICAL:
<span class="nc bnc" id="L1061" title="All 2 branches missed.">                for (Player player : players) {</span>
<span class="nc" id="L1062">                    Nation nation = player.getNation();</span>
<span class="nc bnc" id="L1063" title="All 2 branches missed.">                    positions.add(new Position(nation.startsOnEastCoast() ? east : west,</span>
<span class="nc" id="L1064">                                               map.getRow(nation.getPreferredLatitude())));</span>
                }
                break;
            }
        }
<span class="fc" id="L1069">        return positions;</span>
    }


    // Implement MapGenerator

    /**
     * {@inheritDoc}
     */
    @Override
    public Map createEmptyMap(int width, int height, LogBuilder lb) {
<span class="nc" id="L1080">        recache(false); // Reload the options and specification</span>

<span class="nc" id="L1082">        return new TerrainGenerator(game, null, random)</span>
<span class="nc" id="L1083">            .createMap(new LandMap(width, height), lb);</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public Map createMap(LogBuilder lb) {
<span class="fc" id="L1091">        recache(true); // Reload the options and specification</span>

        // Create land map.
<span class="fc bfc" id="L1094" title="All 2 branches covered.">        LandMap landMap = (importGame != null) ? new LandMap(importGame)</span>
<span class="fc" id="L1095">            : new LandMap(mapOptions, random);</span>

        // Create terrain.
<span class="fc" id="L1098">        Map map = new TerrainGenerator(game, importGame, random)</span>
<span class="fc" id="L1099">            .createMap(landMap, lb);</span>

        // Decorate the map.
<span class="fc" id="L1102">        makeNativeSettlements(map, lb);</span>
<span class="fc" id="L1103">        makeLostCityRumours(map, lb);</span>
<span class="fc" id="L1104">        createEuropeanUnits(map, game.getLiveEuropeanPlayers(null), lb);</span>
<span class="fc" id="L1105">        return map;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span>src (May 7, 2016 6:04:12 PM)</div></body></html>