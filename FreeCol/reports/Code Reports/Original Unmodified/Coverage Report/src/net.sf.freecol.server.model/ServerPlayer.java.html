<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>ServerPlayer.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">src (May 7, 2016 6:04:12 PM)</a> &gt; <a href="../../index.html" class="el_group">FreeCol</a> &gt; <a href="../index.html" class="el_bundle">src</a> &gt; <a href="index.source.html" class="el_package">net.sf.freecol.server.model</a> &gt; <span class="el_source">ServerPlayer.java</span></div><h1>ServerPlayer.java</h1><pre class="source lang-java linenums">/**
 *  Copyright (C) 2002-2016   The FreeCol Team
 *
 *  This file is part of FreeCol.
 *
 *  FreeCol is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  FreeCol is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with FreeCol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package net.sf.freecol.server.model;

import java.io.IOException;
import java.net.Socket;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.EnumMap;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map.Entry;
import java.util.Random;
import java.util.Set;
import java.util.logging.Level;
import java.util.logging.Logger;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import net.sf.freecol.common.FreeColException;
import net.sf.freecol.common.debug.FreeColDebugger;
import net.sf.freecol.common.i18n.Messages;
import net.sf.freecol.common.i18n.NameCache;
import net.sf.freecol.common.model.Ability;
import net.sf.freecol.common.model.AbstractGoods;
import net.sf.freecol.common.model.AbstractUnit;
import net.sf.freecol.common.model.Building;
import net.sf.freecol.common.model.BuildingType;
import net.sf.freecol.common.model.Colony;
import net.sf.freecol.common.model.ColonyTile;
import net.sf.freecol.common.model.CombatModel;
import net.sf.freecol.common.model.CombatModel.CombatResult;
import net.sf.freecol.common.model.DiplomaticTrade;
import net.sf.freecol.common.model.Disaster;
import net.sf.freecol.common.model.Effect;
import net.sf.freecol.common.model.Europe;
import net.sf.freecol.common.model.Europe.MigrationType;
import net.sf.freecol.common.model.Event;
import net.sf.freecol.common.model.Force;
import net.sf.freecol.common.model.FoundingFather;
import net.sf.freecol.common.model.FoundingFather.FoundingFatherType;
import net.sf.freecol.common.model.FreeColGameObject;
import net.sf.freecol.common.model.Game;
import net.sf.freecol.common.model.GameOptions;
import net.sf.freecol.common.model.Goods;
import net.sf.freecol.common.model.GoodsContainer;
import net.sf.freecol.common.model.GoodsType;
import net.sf.freecol.common.model.HistoryEvent;
import net.sf.freecol.common.model.IndianSettlement;
import net.sf.freecol.common.model.Location;
import net.sf.freecol.common.model.Map;
import net.sf.freecol.common.model.Market;
import net.sf.freecol.common.model.ModelMessage;
import net.sf.freecol.common.model.ModelMessage.MessageType;
import net.sf.freecol.common.model.Modifier;
import net.sf.freecol.common.model.Monarch;
import net.sf.freecol.common.model.Nation;
import net.sf.freecol.common.model.Player;
import net.sf.freecol.common.model.Role;
import net.sf.freecol.common.model.Settlement;
import net.sf.freecol.common.model.Specification;
import net.sf.freecol.common.model.Stance;
import net.sf.freecol.common.model.StanceTradeItem;
import net.sf.freecol.common.model.StringTemplate;
import net.sf.freecol.common.model.Tension;
import net.sf.freecol.common.model.Tile;
import net.sf.freecol.common.model.TradeRoute;
import net.sf.freecol.common.model.TradeRouteStop;
import net.sf.freecol.common.model.Turn;
import net.sf.freecol.common.model.Unit;
import net.sf.freecol.common.model.UnitType;
import net.sf.freecol.common.model.UnitTypeChange.ChangeType;
import net.sf.freecol.common.model.WorkLocation;
import net.sf.freecol.common.model.pathfinding.GoalDeciders;
import net.sf.freecol.common.networking.ChooseFoundingFatherMessage;
import net.sf.freecol.common.networking.Connection;
import net.sf.freecol.common.networking.DiplomacyMessage;
import net.sf.freecol.common.networking.DOMMessage;
import net.sf.freecol.common.networking.ErrorMessage;
import net.sf.freecol.common.networking.FirstContactMessage;
import net.sf.freecol.common.networking.LootCargoMessage;
import net.sf.freecol.common.networking.MonarchActionMessage;
import net.sf.freecol.common.util.LogBuilder;
import net.sf.freecol.common.util.RandomChoice;
import static net.sf.freecol.common.util.CollectionUtils.*;
import static net.sf.freecol.common.util.RandomUtils.*;
import net.sf.freecol.server.control.ChangeSet;
import net.sf.freecol.server.control.ChangeSet.ChangePriority;
import net.sf.freecol.server.control.ChangeSet.See;

import org.w3c.dom.Element;


/**
 * A &lt;code&gt;Player&lt;/code&gt; with additional (server specific) information.
 *
 * That is: pointers to this player's
 * {@link Connection} and {@link Socket}
 */
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">public class ServerPlayer extends Player implements ServerModelObject {</span>

<span class="fc" id="L122">    private static final Logger logger = Logger.getLogger(ServerPlayer.class.getName());</span>

    // FIXME: move to options or spec?
    public static final int ALARM_RADIUS = 2;
    public static final int ALARM_TILE_IN_USE = 2;

    // checkForDeath results
    public static final int IS_DEAD = -1;
    public static final int IS_ALIVE = 0;
    public static final int AUTORECRUIT = 1;

    // Penalty for destroying a settlement (Col1)
    public static final int SCORE_SETTLEMENT_DESTROYED = -5;

    // Penalty for destroying a nation (FreeCol extension)
    public static final int SCORE_NATION_DESTROYED = -50;

    // Gold converts to score at 1 pt per 1000 gp (Col1)
    public static final double SCORE_GOLD = 0.001;

    // Score bonus for each founding father (Col1)
    public static final int SCORE_FOUNDING_FATHER = 5;

    // Percentage bonuses for being the 1st,2nd and 3rd player to
    // achieve independence. (Col1)
    public static final int SCORE_INDEPENDENCE_BONUS_FIRST = 100;
    public static final int SCORE_INDEPENDENCE_BONUS_SECOND = 50;
<span class="fc" id="L149">    public static final int SCORE_INDEPENDENCE_BONUS_THIRD = 25;</span>

    // Do not serialize anything below.

    /** The network socket to the player's client. */
    private Socket socket;

    /** The connection for this player. */
    private Connection connection;

    /** An overriding switch indicating connection. */
<span class="fc" id="L160">    private boolean connected = false;</span>

    /** Remaining emigrants to select due to a fountain of youth */
<span class="fc" id="L163">    private int remainingEmigrants = 0;</span>

    /** Players with respect to which stance has changed. */
<span class="fc" id="L166">    private final List&lt;ServerPlayer&gt; stanceDirty = new ArrayList&lt;&gt;();</span>

    /** Accumulate extra trades here. */
<span class="fc" id="L169">    private final List&lt;AbstractGoods&gt; extraTrades = new ArrayList&lt;&gt;();</span>


    /**
     * Trivial constructor required for all ServerModelObjects.
     *
     * @param game The &lt;code&gt;Game&lt;/code&gt; this object belongs to.
     * @param id The object identifier.
     */
    public ServerPlayer(Game game, String id) {
<span class="fc" id="L179">        super(game, id);</span>
<span class="fc" id="L180">    }</span>

    /**
     * Creates a new ServerPlayer.
     *
     * @param game The &lt;code&gt;Game&lt;/code&gt; this object belongs to.
     * @param admin Whether the player is the game administrator or not.
     * @param nation The nation of the &lt;code&gt;Player&lt;/code&gt;.
     * @param socket The socket to the player's client.
     * @param connection The &lt;code&gt;Connection&lt;/code&gt; for the socket.
     */
    public ServerPlayer(Game game, boolean admin, Nation nation,
                        Socket socket, Connection connection) {
<span class="fc" id="L193">        super(game);</span>

<span class="pc bpc" id="L195" title="1 of 2 branches missed.">        if (nation == null) throw new IllegalArgumentException(&quot;Null nation&quot;);</span>
<span class="fc" id="L196">        final Specification spec = getSpecification();</span>

<span class="fc" id="L198">        this.name = nation.getRulerName();</span>
<span class="fc" id="L199">        this.admin = admin;</span>
<span class="fc" id="L200">        this.nationId = nation.getId();</span>
<span class="fc" id="L201">        this.immigration = 0;</span>
<span class="fc bfc" id="L202" title="All 2 branches covered.">        if (nation.isUnknownEnemy()) { // virtual &quot;enemy privateer&quot; player</span>
<span class="fc" id="L203">            this.nationType = null;</span>
<span class="fc" id="L204">            this.playerType = PlayerType.COLONIAL;</span>
<span class="fc" id="L205">            this.europe = null;</span>
<span class="fc" id="L206">            this.monarch = null;</span>
<span class="fc" id="L207">            this.gold = 0;</span>
<span class="fc" id="L208">            this.setAI(true);</span>
<span class="pc bpc" id="L209" title="1 of 2 branches missed.">        } else if (nation.getType() != null) {</span>
<span class="fc" id="L210">            this.nationType = nation.getType();</span>
            try {
<span class="fc" id="L212">                addFeatures(nationType);</span>
<span class="pc" id="L213">            } catch (Throwable error) {</span>
<span class="nc" id="L214">                error.printStackTrace();</span>
            }
<span class="fc bfc" id="L216" title="All 2 branches covered.">            if (nationType.isEuropean()) {</span>
                /*
                 * Setting the amount of gold to
                 * &quot;getGameOptions().getInteger(GameOptions.STARTING_MONEY)&quot;
                 *
                 * just before starting the game. See
                 * &quot;net.sf.freecol.server.control.PreGameController&quot;.
                 */
<span class="fc bfc" id="L224" title="All 2 branches covered.">                this.playerType = (nationType.isREF()) ? PlayerType.ROYAL</span>
<span class="fc" id="L225">                    : PlayerType.COLONIAL;</span>
<span class="fc" id="L226">                this.europe = new ServerEurope(game, this);</span>
<span class="fc" id="L227">                initializeHighSeas();</span>
<span class="fc bfc" id="L228" title="All 2 branches covered.">                if (this.playerType == PlayerType.COLONIAL) {</span>
<span class="fc" id="L229">                    this.monarch = new Monarch(game, this);</span>
                    // In BR#2615 misiulo reports that Col1 players start
                    // with 2 crosses.  This is surprising, but you could
                    // argue that some level of religious unrest might
                    // contribute to the fact there is an expedition to
                    // the new world underway.
<span class="fc" id="L235">                    this.immigration = spec.getInteger(GameOptions.PLAYER_IMMIGRATION_BONUS);</span>
                }
<span class="fc" id="L237">                this.gold = 0;</span>
<span class="fc" id="L238">            } else { // indians</span>
<span class="fc" id="L239">                this.playerType = PlayerType.NATIVE;</span>
<span class="fc" id="L240">                this.gold = Player.GOLD_NOT_ACCOUNTED;</span>
            }
<span class="fc" id="L242">        } else {</span>
<span class="nc" id="L243">            throw new IllegalArgumentException(&quot;Bogus nation: &quot; + nation);</span>
        }
<span class="fc" id="L245">        this.market = new Market(getGame(), this);</span>
<span class="fc" id="L246">        this.liberty = 0;</span>
<span class="fc" id="L247">        this.currentFather = null;</span>

<span class="fc" id="L249">        this.socket = socket;</span>
<span class="fc" id="L250">        this.setConnection(connection);</span>
<span class="fc" id="L251">    }</span>


    /**
     * Is this player is currently connected to the server?
     *
     * @return True if this player is currently connected to the server.
     */
    public boolean isConnected() {
<span class="fc" id="L260">        return this.connected;</span>
    }

    /**
     * Sets the &quot;connected&quot;-status of this player.
     *
     * This allows an override of the default check of whether
     * this.connection is null, and is used to allow a reconnection
     * after a player logs out.
     *
     * @param connected True if this player should be considered as
     *     connected to the server.
     */
    public void setConnected(boolean connected) {
<span class="fc" id="L274">        this.connected = connected;</span>
<span class="fc" id="L275">    }</span>

    /**
     * Gets the socket of this player.
     * @return The &lt;code&gt;Socket&lt;/code&gt;.
     */
    public Socket getSocket() {
<span class="nc" id="L282">        return this.socket;</span>
    }

    /**
     * Gets the connection of this player.
     *
     * @return The &lt;code&gt;Connection&lt;/code&gt;.
     */
    public Connection getConnection() {
<span class="fc" id="L291">        return this.connection;</span>
    }

    /**
     * Sets the connection of this player.
     *
     * @param connection The &lt;code&gt;Connection&lt;/code&gt;.
     */
    public void setConnection(Connection connection) {
<span class="fc" id="L300">        this.connection = connection;</span>
<span class="fc bfc" id="L301" title="All 2 branches covered.">        this.connected = this.connection != null;</span>
<span class="fc" id="L302">    }</span>

    /**
     * Send a change set to this player.
     *
     * @param cs The &lt;code&gt;ChangeSet&lt;/code&gt; to send.
     */
    public void send(ChangeSet cs) {
<span class="fc" id="L310">        askElement(cs.build(this));</span>
<span class="fc" id="L311">    }</span>

    /**
     * Send a message to the player, and return the resulting message.
     *
     * @param game The &lt;code&gt;Game&lt;/code&gt; to build the return message in.
     * @param request The &lt;code&gt;DOMMessage&lt;/code&gt; to send.
     * @return The resulting &lt;code&gt;DOMMessage&lt;/code&gt;.
     */
    public DOMMessage ask(Game game, DOMMessage request) {
<span class="nc bnc" id="L321" title="All 2 branches missed.">        return (isConnected()) ? this.connection.ask(game, request) : null;</span>
    }
    
    /**
     * Send an element to this player.
     * Do not use (sole use in send() above). This will go away.
     *
     * @param request An &lt;code&gt;Element&lt;/code&gt; containing the update.
     */
    private void askElement(Element request) {
<span class="pc bpc" id="L331" title="1 of 2 branches missed.">        if (!isConnected()) return;</span>

<span class="fc bfc" id="L333" title="All 2 branches covered.">        while (request != null) {</span>
            Element reply;
            try {
<span class="fc" id="L336">                reply = this.connection.ask(request);</span>
<span class="fc bfc" id="L337" title="All 2 branches covered.">                if (reply == null) break;</span>
<span class="nc" id="L338">            } catch (IOException e) {</span>
<span class="nc" id="L339">                logger.log(Level.WARNING, &quot;Could not send \&quot;&quot;</span>
<span class="nc" id="L340">                    + request.getTagName() + &quot;\&quot;-message.&quot;, e);</span>
<span class="nc" id="L341">                break;</span>
            }

            try {
<span class="fc" id="L345">                request = this.connection.handle(reply);</span>
<span class="pc" id="L346">            } catch (FreeColException fce) {</span>
<span class="nc" id="L347">                logger.log(Level.WARNING, &quot;Exception processing reply \&quot;&quot;</span>
<span class="nc" id="L348">                    + reply.getTagName() + &quot;\&quot;-message.&quot;, fce);</span>
<span class="nc" id="L349">                break;</span>
            }
        }
<span class="fc" id="L352">    }</span>

    /**
     * Convenience function to create a client error message, log it,
     * and wrap it into a change set.
     *
     * @param message The non-i18n message.
     * @return A new &lt;code&gt;ChangeSet&lt;/code&gt;.
     */
    public ChangeSet clientError(String message) {
<span class="fc" id="L362">        logger.warning(message);</span>
<span class="pc bpc" id="L363" title="1 of 2 branches missed.">        if (FreeColDebugger.isInDebugMode(FreeColDebugger.DebugMode.COMMS)) {</span>
<span class="nc" id="L364">            Thread.dumpStack();</span>
        }
<span class="fc" id="L366">        ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L367">        cs.add(See.only(this), ChangeSet.ChangePriority.CHANGE_NORMAL,</span>
<span class="fc" id="L368">               new ErrorMessage(message));</span>
<span class="fc" id="L369">        return cs;</span>
    }

    /**
     * Update the current father.
     *
     * @param ff The &lt;code&gt;FoundingFather&lt;/code&gt; to recruit.
     */
    public void updateCurrentFather(FoundingFather ff) {
<span class="nc" id="L378">        setCurrentFather(ff);</span>
<span class="nc" id="L379">        clearOfferedFathers();</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">        if (ff != null) {</span>
<span class="nc" id="L381">            logger.finest(getId() + &quot; is recruiting &quot; + ff.getId()</span>
<span class="nc" id="L382">                + &quot; in &quot; + getGame().getTurn());</span>
        }
<span class="nc" id="L384">    }</span>

    /**
     * Accumulate extra trades.
     *
     * @param ag The &lt;code&gt;AbstractGoods&lt;/code&gt; describing the sale.
     */
    public void addExtraTrade(AbstractGoods ag) {
<span class="fc" id="L392">        extraTrades.add(ag);</span>
<span class="fc" id="L393">    }</span>

    /**
     * Flush the extra trades.
     *
     * @param random A pseudo-random number source.
     */
    public void flushExtraTrades(Random random) {
<span class="fc bfc" id="L401" title="All 2 branches covered.">        while (!extraTrades.isEmpty()) {</span>
<span class="fc" id="L402">            AbstractGoods ag = extraTrades.remove(0);</span>
<span class="fc" id="L403">            propagateToEuropeanMarkets(ag.getType(), ag.getAmount(), random);</span>
        }
<span class="fc" id="L405">    }</span>

    /**
     * Performs initial randomizations for this player.
     *
     * @param random A pseudo-random number source.
     */
    public void randomizeGame(Random random) {
<span class="pc bpc" id="L413" title="2 of 6 branches missed.">        if (!isEuropean() || isREF() || isUnknownEnemy()) return;</span>
<span class="fc" id="L414">        final Specification spec = getGame().getSpecification();</span>

        // Set initial immigration target
<span class="fc" id="L417">        int i0 = spec.getInteger(GameOptions.INITIAL_IMMIGRATION);</span>
<span class="fc" id="L418">        immigrationRequired = (int)applyModifiers((float)i0, null,</span>
<span class="fc" id="L419">            Modifier.RELIGIOUS_UNREST_BONUS);</span>

        // Add initial gold
<span class="fc" id="L422">        modifyGold(spec.getInteger(GameOptions.STARTING_MONEY));</span>

        // Choose starting immigrants
<span class="fc" id="L425">        ((ServerEurope)getEurope()).initializeMigration(random);</span>

        // Randomize the initial market prices
<span class="fc" id="L428">        Market market = getMarket();</span>
<span class="fc" id="L429">        StringBuilder sb = new StringBuilder();</span>
<span class="fc" id="L430">        boolean changed = false;</span>
<span class="fc bfc" id="L431" title="All 2 branches covered.">        for (GoodsType type : spec.getGoodsTypeList()) {</span>
<span class="fc" id="L432">            String prefix = &quot;model.option.&quot;</span>
<span class="fc" id="L433">                + type.getSuffix(&quot;model.goods.&quot;);</span>
            // these options are not available for all goods types
<span class="fc bfc" id="L435" title="All 2 branches covered.">            if (spec.hasOption(prefix + &quot;.minimumPrice&quot;)</span>
<span class="pc bpc" id="L436" title="1 of 2 branches missed.">                &amp;&amp; spec.hasOption(prefix + &quot;.maximumPrice&quot;)) {</span>
<span class="fc" id="L437">                int min = spec.getInteger(prefix + &quot;.minimumPrice&quot;);</span>
<span class="fc" id="L438">                int max = spec.getInteger(prefix + &quot;.maximumPrice&quot;);</span>
<span class="pc bpc" id="L439" title="1 of 2 branches missed.">                if (max &lt; min) { // User error</span>
<span class="nc" id="L440">                    int bad = min;</span>
<span class="nc" id="L441">                    min = max;</span>
<span class="nc" id="L442">                    max = bad;</span>
<span class="pc bfc" id="L443" title="All 2 branches covered.">                } else if (max == min) continue;</span>
<span class="fc" id="L444">                int add = randomInt(null, null, random, max - min);</span>
<span class="fc bfc" id="L445" title="All 2 branches covered.">                if (add &gt; 0) {</span>
<span class="fc" id="L446">                    market.setInitialPrice(type, min + add);</span>
<span class="fc" id="L447">                    market.update(type);</span>
<span class="fc" id="L448">                    market.flushPriceChange(type);</span>
<span class="fc" id="L449">                    sb.append(&quot;, &quot;).append(type.getId())</span>
<span class="fc" id="L450">                        .append(&quot; -&gt; &quot;).append(min + add);</span>
<span class="fc" id="L451">                    changed = true;</span>
                }
            }
        }
<span class="pc bpc" id="L455" title="1 of 2 branches missed.">        if (changed) {</span>
<span class="fc" id="L456">            logger.finest(&quot;randomizeGame(&quot; + getId() + &quot;) initial prices: &quot;</span>
<span class="fc" id="L457">                + sb.toString().substring(2));</span>
        }
<span class="fc" id="L459">    }</span>

    /**
     * Checks if this player has died.
     *
     * @return Negative if the player is dead, zero if they are ok,
     *      positive non-zero if the server should auto-recruit
     *      colonist units to keep this player alive.
     */
    public int checkForDeath() {
<span class="pc bpc" id="L469" title="1 of 2 branches missed.">        if (isUnknownEnemy()) return IS_ALIVE;</span>
<span class="fc" id="L470">        final Specification spec = getGame().getSpecification();</span>
        /*
         * Die if: (isNative &amp;&amp; (no colonies or units))
         *      || ((rebel or independent) &amp;&amp; !(has coastal colony))
         *      || (isREF &amp;&amp; !(rebel nation left) &amp;&amp; (all units in Europe))
         *      || ((no units in New World)
         *         &amp;&amp; ((year &gt; 1600) || (cannot get a unit from Europe)))
         */
<span class="pc bpc" id="L478" title="4 of 6 branches missed.">        switch (getPlayerType()) {</span>
        case NATIVE: // All natives units are viable
<span class="pc bpc" id="L480" title="1 of 2 branches missed.">            return (getUnits().isEmpty()) ? IS_DEAD : IS_ALIVE;</span>

        case COLONIAL: // Handle the hard case below
<span class="fc" id="L483">            break;</span>

        case REBEL: case INDEPENDENT:
            // Post-declaration European player needs a coastal colony
            // and can not hope for resupply from Europe.
<span class="nc bnc" id="L488" title="All 2 branches missed.">            return (getNumberOfPorts() &gt; 0) ? IS_ALIVE : IS_DEAD;</span>

        case ROYAL:
<span class="nc bnc" id="L491" title="All 2 branches missed.">            return (getRebels().isEmpty()) ? IS_DEAD : IS_ALIVE;</span>

        case UNDEAD:
<span class="nc bnc" id="L494" title="All 2 branches missed.">            return (getUnits().isEmpty()) ? IS_DEAD : IS_ALIVE;</span>

        default:
<span class="nc" id="L497">            throw new IllegalStateException(&quot;Bogus player type&quot;);</span>
        }

        // Quick check for a colony.  Do not log, this is the common case.
<span class="pc bpc" id="L501" title="1 of 2 branches missed.">        if (!getColonies().isEmpty()) return IS_ALIVE;</span>

        // Do not kill the observing player during a debug run.
<span class="pc bpc" id="L504" title="3 of 4 branches missed.">        if (!isAI() &amp;&amp; FreeColDebugger.getDebugRunTurns() &gt;= 0) return IS_ALIVE;</span>

        // Do not kill the unknown enemy!
<span class="pc bpc" id="L507" title="1 of 2 branches missed.">        if (isUnknownEnemy()) return IS_ALIVE;</span>

        // Traverse player units, look for valid carriers, colonists,
        // carriers with units, carriers with goods.
<span class="fc" id="L511">        boolean hasCarrier = false, hasColonist = false, hasEmbarked = false,</span>
<span class="fc" id="L512">            hasGoods = false;</span>
<span class="fc bfc" id="L513" title="All 2 branches covered.">        for (Unit unit : getUnits()) {</span>
<span class="fc bfc" id="L514" title="All 2 branches covered.">            if (unit.isCarrier()) {</span>
<span class="pc bpc" id="L515" title="1 of 2 branches missed.">                if (unit.hasGoodsCargo()) hasGoods = true;</span>
<span class="fc" id="L516">                hasCarrier = true;</span>
<span class="fc" id="L517">                continue;</span>
            }

            // Must be able to found new colony or capture units
<span class="pc bpc" id="L521" title="3 of 4 branches missed.">            if (!unit.isColonist() &amp;&amp; !unit.isOffensiveUnit()) continue;</span>
<span class="fc" id="L522">            hasColonist = true;</span>

            // Verify if unit is in new world, or on a carrier in new world
            Unit carrier;
<span class="fc bfc" id="L526" title="All 2 branches covered.">            if ((carrier = unit.getCarrier()) != null) {</span>
<span class="pc bpc" id="L527" title="1 of 2 branches missed.">                if (carrier.hasTile()) {</span>
<span class="nc" id="L528">                    logger.info(getName() + &quot; alive, unit &quot; + unit.getId()</span>
<span class="nc" id="L529">                        + &quot; (embarked) on map.&quot;);</span>
<span class="nc" id="L530">                    return IS_ALIVE;</span>
                }
<span class="fc" id="L532">                hasEmbarked = true;</span>
            }
<span class="pc bpc" id="L534" title="1 of 4 branches missed.">            if (unit.hasTile() &amp;&amp; !unit.isInMission()) {</span>
<span class="fc" id="L535">                logger.info(getName() + &quot; alive, unit &quot; + unit.getId()</span>
<span class="fc" id="L536">                    + &quot; on map.&quot;);</span>
<span class="fc" id="L537">                return IS_ALIVE;</span>
            }
        }
        // The player does not have any valid units or settlements on the map.

<span class="fc" id="L542">        int mandatory = spec.getInteger(GameOptions.MANDATORY_COLONY_YEAR);</span>
<span class="fc bfc" id="L543" title="All 2 branches covered.">        if (getGame().getTurn().getYear() &gt;= mandatory) {</span>
            // After the season cutover year there must be a presence
            // in the New World.
<span class="fc" id="L546">            logger.info(getName() + &quot; dead, no presence &gt;= &quot; + mandatory);</span>
<span class="fc" id="L547">            return IS_DEAD;</span>
        }

        // No problems, unit available on carrier but off map, or goods
        // available to be sold.
<span class="fc bfc" id="L552" title="All 2 branches covered.">        if (hasEmbarked) {</span>
<span class="fc" id="L553">            logger.info(getName() + &quot; alive, has embarked unit.&quot;);</span>
<span class="fc" id="L554">            return IS_ALIVE;</span>
<span class="pc bpc" id="L555" title="1 of 2 branches missed.">        } else if (hasGoods) {</span>
<span class="nc" id="L556">            logger.info(getName() + &quot; alive, has cargo.&quot;);</span>
<span class="nc" id="L557">            return IS_ALIVE;</span>
        }

        // It is necessary to still have a carrier.
<span class="fc" id="L561">        final Europe europe = getEurope();</span>
<span class="fc" id="L562">        int goldNeeded = 0;</span>
<span class="fc bfc" id="L563" title="All 2 branches covered.">        if (!hasCarrier) {</span>
<span class="fc" id="L564">            int price = Integer.MAX_VALUE;</span>
<span class="pc bpc" id="L565" title="1 of 2 branches missed.">            if (europe != null) {</span>
<span class="fc bfc" id="L566" title="All 2 branches covered.">                for (UnitType type</span>
<span class="fc" id="L567">                         : spec.getUnitTypesWithAbility(Ability.NAVAL_UNIT)) {</span>
<span class="fc" id="L568">                    int p = europe.getUnitPrice(type);</span>
<span class="fc bfc" id="L569" title="All 4 branches covered.">                    if (p != UNDEFINED &amp;&amp; p &lt; price) price = p;</span>
                }
            }
<span class="pc bpc" id="L572" title="1 of 4 branches missed.">            if (price == Integer.MAX_VALUE || !checkGold(price)) {</span>
<span class="fc" id="L573">                logger.info(getName() + &quot; dead, can not buy carrier.&quot;);</span>
<span class="fc" id="L574">                return IS_DEAD;</span>
            }
<span class="fc" id="L576">            goldNeeded += price;</span>
        }

        // A colonist is required.
<span class="fc bfc" id="L580" title="All 2 branches covered.">        if (hasColonist) {</span>
<span class="fc" id="L581">            logger.info(getName() + &quot; alive, has waiting colonist.&quot;);</span>
<span class="fc" id="L582">            return IS_ALIVE;</span>
<span class="pc bpc" id="L583" title="1 of 2 branches missed.">        } else if (europe == null) {</span>
<span class="nc" id="L584">            logger.info(getName() + &quot; dead, can not recruit.&quot;);</span>
<span class="nc" id="L585">            return IS_DEAD;</span>
        }
<span class="fc" id="L587">        UnitType unitType = null;</span>
<span class="fc" id="L588">        int price = europe.getRecruitPrice();</span>
<span class="fc bfc" id="L589" title="All 2 branches covered.">        for (UnitType type : spec.getUnitTypesWithAbility(Ability.FOUND_COLONY)) {</span>
<span class="fc" id="L590">            int p = europe.getUnitPrice(type);</span>
<span class="pc bpc" id="L591" title="1 of 4 branches missed.">            if (p != UNDEFINED &amp;&amp; p &lt; price) price = p;</span>
        }
<span class="fc" id="L593">        goldNeeded += price;</span>
<span class="fc bfc" id="L594" title="All 2 branches covered.">        if (checkGold(goldNeeded)) {</span>
<span class="fc" id="L595">            logger.info(getName() + &quot; alive, can buy colonist.&quot;);</span>
<span class="fc" id="L596">            return IS_ALIVE;</span>
        }

        // Col1 auto-recruits a unit in Europe if you run out before
        // the cutover year.
<span class="fc" id="L601">        logger.info(getName() + &quot; survives by autorecruit.&quot;);</span>
<span class="fc" id="L602">        return AUTORECRUIT;</span>
    }

    /**
     * Check if a REF player has been defeated and should surrender.
     *
     * @return True if this REF player has been defeated.
     */
    public boolean checkForREFDefeat() {
<span class="nc bnc" id="L611" title="All 2 branches missed.">        if (!isREF()) {</span>
<span class="nc" id="L612">            throw new IllegalStateException(&quot;Checking for REF player defeat when player not REF.&quot;);</span>
        }

        // No one to fight?  Either the rebels are dead, or the REF
        // was already defeated and the rebels are independent.
        // Either way, it does not need to surrender.
<span class="nc bnc" id="L618" title="All 2 branches missed.">        if (getRebels().isEmpty()) return false;</span>

        // Not defeated if there are settlements.
<span class="nc bnc" id="L621" title="All 2 branches missed.">        if (hasSettlements()) return false;</span>

        // Not defeated if there is a non-zero navy and enough land units.
<span class="nc" id="L624">        final int landREFUnitsRequired = 7; // FIXME: magic number</span>
<span class="nc" id="L625">        final CombatModel cm = getGame().getCombatModel();</span>
<span class="nc" id="L626">        boolean naval = false;</span>
<span class="nc" id="L627">        int land = 0;</span>
<span class="nc" id="L628">        int power = 0;</span>
<span class="nc bnc" id="L629" title="All 2 branches missed.">        for (Unit u : getUnits()) {</span>
<span class="nc bnc" id="L630" title="All 2 branches missed.">            if (u.isNaval()) naval = true; else {</span>
<span class="nc bnc" id="L631" title="All 2 branches missed.">                if (u.hasAbility(Ability.REF_UNIT)) {</span>
<span class="nc" id="L632">                    land++;</span>
<span class="nc" id="L633">                    power += cm.getOffencePower(u, null);</span>
                }
            }
        }
<span class="nc bnc" id="L637" title="All 4 branches missed.">        if (naval &amp;&amp; land &gt;= landREFUnitsRequired) return false;</span>

        // Still not defeated as long as military strength is greater
        // than the rebels.
<span class="nc" id="L641">        Stream&lt;Unit&gt; us = getRebels().stream()</span>
<span class="nc" id="L642">            .flatMap(rebel -&gt; rebel.getUnits().stream());</span>
<span class="nc bnc" id="L643" title="All 2 branches missed.">        int rebelPower = (int)sumDouble(us, u -&gt; !u.isNaval(),</span>
<span class="nc" id="L644">                                        u -&gt; cm.getOffencePower(u, null));</span>
<span class="nc bnc" id="L645" title="All 2 branches missed.">        if (power &gt; rebelPower) return false;</span>

        // REF is defeated
<span class="nc" id="L648">        return true;</span>
    }

    /**
     * Kill off a player and clear out its remains.
     *
     * +vis: Albeit killing the player makes visibility changes moot.
     * +til: Fixes the appearance changes too.
     *
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csKill(ChangeSet cs) {
<span class="nc" id="L660">        setDead(true);</span>
<span class="nc" id="L661">        cs.addPartial(See.all(), this, &quot;dead&quot;);</span>
<span class="nc" id="L662">        cs.addDead(this);</span>

        // Clean up missions and remove tension/alarm/stance.
<span class="nc bnc" id="L665" title="All 2 branches missed.">        for (Player other : getGame().getLivePlayers(this)) {</span>
<span class="nc bnc" id="L666" title="All 4 branches missed.">            if (isEuropean() &amp;&amp; other.isIndian()) {</span>
<span class="nc bnc" id="L667" title="All 2 branches missed.">                for (IndianSettlement s : other.getIndianSettlements()) {</span>
<span class="nc bnc" id="L668" title="All 2 branches missed.">                    if (s.hasMissionary(this)) {</span>
<span class="nc" id="L669">                        ((ServerIndianSettlement)s).csKillMissionary(null, cs);</span>
                    }
<span class="nc" id="L671">                    s.getTile().cacheUnseen();//+til</span>
<span class="nc" id="L672">                    ((ServerIndianSettlement)s).removeAlarm(this);//-til</span>
                }
<span class="nc" id="L674">                other.removeTension(this);</span>
            }
<span class="nc" id="L676">            other.setStance(this, null);</span>
        }

        // Remove settlements.  Update formerly owned tiles.
<span class="nc" id="L680">        List&lt;Settlement&gt; settlements = getSettlements();</span>
<span class="nc bnc" id="L681" title="All 2 branches missed.">        while (!settlements.isEmpty()) {</span>
<span class="nc" id="L682">            csDisposeSettlement(settlements.remove(0), cs);</span>
        }

        // Clean up remaining tile ownerships
<span class="nc bnc" id="L686" title="All 2 branches missed.">        for (Tile tile : getGame().getMap().getAllTiles()) {</span>
<span class="nc bnc" id="L687" title="All 2 branches missed.">            if (tile.getOwner() == this) {</span>
<span class="nc" id="L688">                tile.cacheUnseen();//+til</span>
<span class="nc" id="L689">                tile.changeOwnership(null, null);//-til</span>
<span class="nc" id="L690">                cs.add(See.perhaps().always(this), tile);</span>
            }
        }

        // Remove units
<span class="nc" id="L695">        List&lt;Unit&gt; units = getUnits();</span>
<span class="nc bnc" id="L696" title="All 2 branches missed.">        while (!units.isEmpty()) {</span>
<span class="nc" id="L697">            Unit u = units.remove(0);</span>
<span class="nc bnc" id="L698" title="All 2 branches missed.">            if (u.hasTile()) cs.add(See.perhaps(), u.getTile());</span>
<span class="nc" id="L699">            cs.addRemove(See.perhaps().always(this),</span>
<span class="nc" id="L700">                         u.getLocation(), u);//-vis(this)</span>
<span class="nc" id="L701">            u.dispose();</span>
        }

        // Remove European stuff
<span class="nc bnc" id="L705" title="All 2 branches missed.">        if (market != null) {</span>
<span class="nc" id="L706">            market.dispose();</span>
<span class="nc" id="L707">            market = null;</span>
        }
<span class="nc bnc" id="L709" title="All 2 branches missed.">        if (monarch != null) {</span>
<span class="nc" id="L710">            monarch.dispose();</span>
<span class="nc" id="L711">            monarch = null;</span>
        }
<span class="nc bnc" id="L713" title="All 2 branches missed.">        if (europe != null) {</span>
<span class="nc" id="L714">            europe.dispose();</span>
<span class="nc" id="L715">            europe = null;</span>
        }
<span class="nc" id="L717">        currentFather = null;</span>
<span class="nc bnc" id="L718" title="All 2 branches missed.">        if (foundingFathers != null) foundingFathers.clear();</span>
<span class="nc bnc" id="L719" title="All 2 branches missed.">        if (offeredFathers != null) offeredFathers.clear();</span>
        // FIXME: stance and tension?
<span class="nc bnc" id="L721" title="All 2 branches missed.">        if (tradeRoutes != null) tradeRoutes.clear();</span>
        // Retaining model messages for now
        // Retaining history for now
<span class="nc bnc" id="L724" title="All 2 branches missed.">        if (lastSales != null) lastSales = null;</span>
<span class="nc" id="L725">        featureContainer.clear();</span>

<span class="nc" id="L727">        invalidateCanSeeTiles();//+vis(this)</span>
<span class="nc" id="L728">    }</span>

    /**
     * Withdraw a player from the new world.
     *
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csWithdraw(ChangeSet cs) {
<span class="nc bnc" id="L736" title="All 4 branches missed.">        String key = (isEuropean() &amp;&amp; getPlayerType() == PlayerType.COLONIAL)</span>
<span class="nc" id="L737">            ? &quot;model.player.dead.european&quot;</span>
<span class="nc" id="L738">            : &quot;model.player.dead.native&quot;;</span>
<span class="nc" id="L739">        cs.addMessage(See.all(),</span>
<span class="nc" id="L740">            new ModelMessage(MessageType.FOREIGN_DIPLOMACY, key, this)</span>
<span class="nc" id="L741">                .addStringTemplate(&quot;%nation%&quot;, getNationLabel()));</span>
<span class="nc" id="L742">        Game game = getGame();</span>
<span class="nc" id="L743">        cs.addGlobalHistory(game,</span>
<span class="nc" id="L744">            new HistoryEvent(game.getTurn(),</span>
<span class="nc" id="L745">                             HistoryEvent.HistoryEventType.NATION_DESTROYED, null)</span>
<span class="nc" id="L746">                .addStringTemplate(&quot;%nation%&quot;, getNationLabel()));</span>
<span class="nc" id="L747">        csKill(cs);</span>
<span class="nc" id="L748">    }</span>


    public int getRemainingEmigrants() {
<span class="nc" id="L752">        return remainingEmigrants;</span>
    }

    public void setRemainingEmigrants(int emigrants) {
<span class="nc" id="L756">        remainingEmigrants = emigrants;</span>
<span class="nc" id="L757">    }</span>

    /**
     * Checks whether the current founding father has been recruited.
     *
     * @return The new founding father, or null if none available or ready.
     */
    public FoundingFather checkFoundingFather() {
<span class="nc" id="L765">        FoundingFather father = null;</span>
<span class="nc bnc" id="L766" title="All 2 branches missed.">        if (currentFather != null) {</span>
<span class="nc" id="L767">            int extraLiberty = getRemainingFoundingFatherCost();</span>
<span class="nc bnc" id="L768" title="All 2 branches missed.">            if (extraLiberty &lt;= 0) {</span>
<span class="nc" id="L769">                boolean overflow = getSpecification()</span>
<span class="nc" id="L770">                    .getBoolean(GameOptions.SAVE_PRODUCTION_OVERFLOW);</span>
<span class="nc bnc" id="L771" title="All 2 branches missed.">                setLiberty((overflow) ? -extraLiberty : 0);</span>
<span class="nc" id="L772">                father = currentFather;</span>
<span class="nc" id="L773">                currentFather = null;</span>
            }
        }
<span class="nc" id="L776">        return father;</span>
    }

    /**
     * Checks whether to start recruiting a founding father.
     *
     * @return True if a new father should be chosen.
     */
    public boolean canRecruitFoundingFather() {
<span class="nc" id="L785">        Specification spec = getGame().getSpecification();</span>
<span class="nc bnc" id="L786" title="All 3 branches missed.">        switch (getPlayerType()) {</span>
        case COLONIAL:
<span class="nc" id="L788">            break;</span>
        case REBEL: case INDEPENDENT:
<span class="nc bnc" id="L790" title="All 2 branches missed.">            if (!spec.getBoolean(GameOptions.CONTINUE_FOUNDING_FATHER_RECRUITMENT)) return false;</span>
            break;
        default:
<span class="nc" id="L793">            return false;</span>
        }
<span class="nc bnc" id="L795" title="All 6 branches missed.">        return canHaveFoundingFathers() &amp;&amp; currentFather == null</span>
<span class="nc bnc" id="L796" title="All 2 branches missed.">            &amp;&amp; hasSettlements()</span>
<span class="nc" id="L797">            &amp;&amp; getFatherCount() &lt; spec.getFoundingFathers().size();</span>
    }

    /**
     * Build a list of random FoundingFathers, one per type.
     * Do not include any the player has or are not available.
     *
     * @param random A pseudo-random number source.
     * @return A list of FoundingFathers.
     */
    public List&lt;FoundingFather&gt; getRandomFoundingFathers(Random random) {
        // Build weighted random choice for each father type
<span class="nc" id="L809">        final Game game = getGame();</span>
<span class="nc" id="L810">        final Specification spec = game.getSpecification();</span>
<span class="nc" id="L811">        final int age = game.getAge();</span>
<span class="nc" id="L812">        EnumMap&lt;FoundingFatherType, List&lt;RandomChoice&lt;FoundingFather&gt;&gt;&gt; choices</span>
<span class="nc" id="L813">            = new EnumMap&lt;&gt;(FoundingFatherType.class);</span>
<span class="nc bnc" id="L814" title="All 2 branches missed.">        for (FoundingFather father : spec.getFoundingFathers()) {</span>
<span class="nc bnc" id="L815" title="All 4 branches missed.">            if (!hasFather(father) &amp;&amp; father.isAvailableTo(this)) {</span>
<span class="nc" id="L816">                FoundingFatherType type = father.getType();</span>
<span class="nc" id="L817">                List&lt;RandomChoice&lt;FoundingFather&gt;&gt; rc = choices.get(type);</span>
<span class="nc bnc" id="L818" title="All 2 branches missed.">                if (rc == null) rc = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L819">                int weight = father.getWeight(age);</span>
<span class="nc" id="L820">                rc.add(new RandomChoice&lt;&gt;(father, weight));</span>
<span class="nc" id="L821">                choices.put(father.getType(), rc);</span>
            }
        }

        // Select one from each father type
<span class="nc" id="L826">        List&lt;FoundingFather&gt; randomFathers = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L827">        LogBuilder lb = new LogBuilder(64);</span>
<span class="nc" id="L828">        lb.add(&quot;Random fathers for &quot;, getDebugName());</span>
<span class="nc bnc" id="L829" title="All 2 branches missed.">        for (FoundingFatherType type : FoundingFatherType.values()) {</span>
<span class="nc" id="L830">            List&lt;RandomChoice&lt;FoundingFather&gt;&gt; rc = choices.get(type);</span>
<span class="nc bnc" id="L831" title="All 2 branches missed.">            if (rc != null) {</span>
<span class="nc" id="L832">                FoundingFather f = RandomChoice.getWeightedRandom(logger,</span>
<span class="nc" id="L833">                    &quot;Choose founding father&quot;, rc, random);</span>
<span class="nc bnc" id="L834" title="All 2 branches missed.">                if (f != null) {</span>
<span class="nc" id="L835">                    randomFathers.add(f);</span>
<span class="nc" id="L836">                    lb.add(&quot;:&quot;, f.getSuffix());</span>
                }
            }
        }
<span class="nc" id="L840">        lb.log(logger, Level.INFO);</span>
<span class="nc" id="L841">        return randomFathers;</span>
    }

    /**
     * Add a HistoryEvent to this player.
     *
     * @param event The &lt;code&gt;HistoryEvent&lt;/code&gt; to add.
     */
    @Override
    public void addHistory(HistoryEvent event) {
<span class="fc" id="L851">        history.add(event);</span>
<span class="fc" id="L852">    }</span>

    /**
     * Update the current score for this player.
     *
     * Known incompatibility with the Col1 manual:
     * ``In addition, you get one point per liberty bell produced
     *   after foreign intervention''
     * However you are already getting a point per liberty bell
     * produced, so this implies you get no further liberty after
     * declaring independence!?, but it can then start again if the
     * foreign intervention happens (penalizing players who quickly
     * thrash the REF:-S).  Whatever this really means, it is
     * incompatible with our extensions to allow playing on (and
     * defeating other Europeans), so for now at least just leave the
     * simple liberty==score rule in place.
     *
     * @return True if the player score changed.
     */
    public boolean updateScore() {
<span class="nc" id="L872">        int oldScore = this.score;</span>
<span class="nc" id="L873">        this.score = sum(getUnits(), u -&gt; u.getType().getScoreValue())</span>
<span class="nc" id="L874">            + sum(getColonies(), Colony::getLiberty)</span>
<span class="nc" id="L875">            + SCORE_FOUNDING_FATHER * getFathers().size();</span>
<span class="nc" id="L876">        int gold = getGold();</span>
<span class="nc bnc" id="L877" title="All 2 branches missed.">        if (gold != GOLD_NOT_ACCOUNTED) {</span>
<span class="nc" id="L878">            this.score += (int)Math.floor(SCORE_GOLD * gold);</span>
        }
        
<span class="nc" id="L881">        int bonus = 0;</span>
<span class="nc bnc" id="L882" title="All 2 branches missed.">        for (HistoryEvent h : getHistory()) {</span>
<span class="nc bnc" id="L883" title="All 2 branches missed.">            if (getId().equals(h.getPlayerId())) {</span>
<span class="nc bnc" id="L884" title="All 2 branches missed.">                switch (h.getEventType()) {</span>
                case INDEPENDENCE:
<span class="nc bnc" id="L886" title="All 4 branches missed.">                    switch (h.getScore()) {</span>
<span class="nc" id="L887">                    case 0: bonus = SCORE_INDEPENDENCE_BONUS_FIRST; break;</span>
<span class="nc" id="L888">                    case 1: bonus = SCORE_INDEPENDENCE_BONUS_SECOND; break;</span>
<span class="nc" id="L889">                    case 2: bonus = SCORE_INDEPENDENCE_BONUS_THIRD; break;</span>
<span class="nc" id="L890">                    default: bonus = 0; break;</span>
                    }
<span class="nc" id="L892">                    break;</span>
                default:
<span class="nc" id="L894">                    this.score += h.getScore();</span>
                    break;
                }
            }
        }
<span class="nc" id="L899">        this.score += (this.score * bonus) / 100;</span>

<span class="nc bnc" id="L901" title="All 2 branches missed.">        return this.score != oldScore;</span>
    }

    /**
     * Checks if this &lt;code&gt;Player&lt;/code&gt; has explored the given
     * &lt;code&gt;Tile&lt;/code&gt;.
     *
     * @param tile The &lt;code&gt;Tile&lt;/code&gt;.
     * @return &lt;i&gt;true&lt;/i&gt; if the &lt;code&gt;Tile&lt;/code&gt; has been explored and
     *         &lt;i&gt;false&lt;/i&gt; otherwise.
     */
    @Override
    public boolean hasExplored(Tile tile) {
<span class="fc" id="L914">        return tile.isExploredBy(this);</span>
    }

    /**
     * Sets the given tile to be explored by this player and updates
     * the player's information about the tile.
     *
     * +til: Exploring the tile also updates the pet.
     *
     * @param tile The &lt;code&gt;Tile&lt;/code&gt; to explore.
     * @return True if the tile is newly explored by this action.
     */
    public boolean exploreTile(Tile tile) {
<span class="fc bfc" id="L927" title="All 2 branches covered.">        boolean ret = !hasExplored(tile);</span>
<span class="fc bfc" id="L928" title="All 2 branches covered.">        if (ret) tile.setExplored(this, true);</span>
<span class="fc" id="L929">        return ret;</span>
    }

    /**
     * Sets the tiles within the given &lt;code&gt;Unit&lt;/code&gt;'s line of
     * sight to be explored by this player.
     *
     * @param tiles A list of &lt;code&gt;Tile&lt;/code&gt;s.
     * @return A list of newly explored &lt;code&gt;Tile&lt;/code&gt;s.
     * @see #hasExplored
     */
    public Set&lt;Tile&gt; exploreTiles(Collection&lt;? extends Tile&gt; tiles) {
<span class="fc" id="L941">        Set&lt;Tile&gt; result = new HashSet&lt;&gt;();</span>
<span class="fc bfc" id="L942" title="All 2 branches covered.">        for (Tile t : tiles) {</span>
<span class="fc bfc" id="L943" title="All 2 branches covered.">            if (exploreTile(t)) result.add(t);</span>
        }
<span class="fc" id="L945">        return result;</span>
    }

    /**
     * Sets the tiles visible to a given settlement to be explored by
     * this player and updates the player's information about the
     * tiles.  Note that the player does not necessarily own the settlement
     * (e.g. missionary at native settlement).
     *
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; that is exploring.
     * @return A list of newly explored &lt;code&gt;Tile&lt;/code&gt;s.
     */
    public Set&lt;Tile&gt; exploreForSettlement(Settlement settlement) {
<span class="fc" id="L958">        Set&lt;Tile&gt; tiles = new HashSet&lt;&gt;(settlement.getOwnedTiles());</span>
<span class="fc" id="L959">        tiles.addAll(settlement.getTile().getSurroundingTiles(1,</span>
<span class="fc" id="L960">                     settlement.getLineOfSight()));</span>
<span class="fc" id="L961">        return exploreTiles(tiles);</span>
    }

    /**
     * Sets the tiles within the given &lt;code&gt;Unit&lt;/code&gt;'s line of
     * sight to be explored by this player.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt;.
     * @return A list of newly explored &lt;code&gt;Tile&lt;/code&gt;s.
     * @see #hasExplored
     */
    public Set&lt;Tile&gt; exploreForUnit(Unit unit) {
<span class="pc bpc" id="L973" title="3 of 6 branches missed.">        return (getGame() == null || getGame().getMap() == null || unit == null</span>
<span class="fc bfc" id="L974" title="All 2 branches covered.">            || !(unit.getLocation() instanceof Tile)) </span>
<span class="fc" id="L975">            ? Collections.&lt;Tile&gt;emptySet()</span>
<span class="fc" id="L976">            : exploreTiles(unit.getTile().getSurroundingTiles(0,</span>
<span class="fc" id="L977">                    unit.getLineOfSight()));</span>
    }

    /**
     * Makes the entire map visible or invisible.
     *
     * @param reveal If true, reveal the map, if false, hide it.
     * @return A list of tiles whose visibility changed.
     */
    public Set&lt;Tile&gt; exploreMap(boolean reveal) {
<span class="fc" id="L987">        Set&lt;Tile&gt; result = new HashSet&lt;&gt;();</span>
<span class="fc bfc" id="L988" title="All 2 branches covered.">        for (Tile tile : getGame().getMap().getAllTiles()) {</span>
<span class="pc bpc" id="L989" title="1 of 2 branches missed.">            if (hasExplored(tile) != reveal) {</span>
<span class="fc" id="L990">                tile.setExplored(this, reveal);//-vis(this)</span>
<span class="fc" id="L991">                result.add(tile);</span>
            }
        }
<span class="fc" id="L994">        invalidateCanSeeTiles();//+vis(this)</span>
<span class="pc bpc" id="L995" title="1 of 2 branches missed.">        if (!reveal) {</span>
<span class="nc bnc" id="L996" title="All 2 branches missed.">            for (Settlement s : getSettlements()) exploreForSettlement(s);</span>
<span class="nc bnc" id="L997" title="All 2 branches missed.">            for (Unit u : getUnits()) exploreForUnit(u);</span>
        }
<span class="fc" id="L999">        return result;</span>
    }

    /**
     * Try to reassign the ownership of a collection of tiles.
     *
     * Do it in two passes so the first successful claim does not give
     * a large advantage.
     *
     * @param tiles The collection of &lt;code&gt;Tile&lt;/code&gt;s to reassign.
     * @param prefer An optional &lt;code&gt;Player&lt;/code&gt; to prefer to reassign to.
     * @param avoid An optional &lt;code&gt;Settlement&lt;/code&gt; to consider last
     *     when making claims.
     */
    private static void reassignTiles(Collection&lt;Tile&gt; tiles,
                                      Player prefer,
                                      Settlement avoid) {
<span class="fc" id="L1016">        HashMap&lt;Settlement, Integer&gt; votes = new HashMap&lt;&gt;();</span>
<span class="fc" id="L1017">        HashMap&lt;Tile, Settlement&gt; claims = new HashMap&lt;&gt;();</span>
        Settlement claimant;
<span class="fc bfc" id="L1019" title="All 2 branches covered.">        for (Tile tile : tiles) {</span>
<span class="pc bpc" id="L1020" title="1 of 2 branches missed.">            if (tile.isOccupied()) continue;</span>
<span class="fc" id="L1021">            votes.clear();</span>
<span class="fc bfc" id="L1022" title="All 2 branches covered.">            for (Tile t : tile.getSurroundingTiles(1)) {</span>
<span class="fc" id="L1023">                claimant = t.getOwningSettlement();</span>
<span class="fc bfc" id="L1024" title="All 2 branches covered.">                if (claimant != null</span>
                    // BR#3375773 found a case where tiles were
                    // still owned by a settlement that had been
                    // previously destroyed.  These should be gone, but...
<span class="pc bpc" id="L1028" title="1 of 2 branches missed.">                    &amp;&amp; !claimant.isDisposed()</span>
<span class="pc bpc" id="L1029" title="1 of 2 branches missed.">                    &amp;&amp; claimant.getOwner() != null</span>
<span class="fc bfc" id="L1030" title="All 2 branches covered.">                    &amp;&amp; claimant.getOwner().canOwnTile(tile)</span>
<span class="pc bpc" id="L1031" title="1 of 2 branches missed.">                    &amp;&amp; (claimant.getOwner().isIndian()</span>
<span class="fc" id="L1032">                        || claimant.getTile().getDistanceTo(tile)</span>
<span class="pc bpc" id="L1033" title="1 of 2 branches missed.">                        &lt;= claimant.getRadius())) {</span>
                    // Weight claimant settlements:
                    //   settlements owned by the same player
                    //     &gt; settlements owned by same type of player
                    //     &gt; other settlements
<span class="pc bpc" id="L1038" title="1 of 2 branches missed.">                    int value = (prefer == null) ? 1</span>
<span class="pc bpc" id="L1039" title="1 of 2 branches missed.">                        : (claimant.getOwner() == prefer) ? 3</span>
<span class="nc" id="L1040">                        : (claimant.getOwner().isEuropean()</span>
<span class="nc bnc" id="L1041" title="All 2 branches missed.">                            == prefer.isEuropean()) ? 2</span>
<span class="nc" id="L1042">                        : 1;</span>
<span class="pc bpc" id="L1043" title="1 of 2 branches missed.">                    if (votes.get(claimant) != null) {</span>
<span class="nc" id="L1044">                        value += votes.get(claimant);</span>
                    }
<span class="fc" id="L1046">                    votes.put(claimant, value);</span>
                }
            }
<span class="fc" id="L1049">            boolean lastResort = false;</span>
<span class="fc" id="L1050">            int bestValue = 0;</span>
<span class="fc" id="L1051">            claimant = null;</span>
<span class="fc bfc" id="L1052" title="All 2 branches covered.">            for (Entry&lt;Settlement, Integer&gt; entry : votes.entrySet()) {</span>
<span class="pc bpc" id="L1053" title="1 of 2 branches missed.">                if (avoid == entry.getKey()) {</span>
<span class="fc" id="L1054">                    lastResort = true;</span>
<span class="fc" id="L1055">                    continue;</span>
                }
<span class="nc" id="L1057">                int value = entry.getValue();</span>
<span class="nc bnc" id="L1058" title="All 2 branches missed.">                if (bestValue &lt; value) {</span>
<span class="nc" id="L1059">                    bestValue = value;</span>
<span class="nc" id="L1060">                    claimant = entry.getKey();</span>
                }
            }
<span class="pc bpc" id="L1063" title="1 of 4 branches missed.">            if (claimant == null &amp;&amp; lastResort) claimant = avoid;</span>
<span class="fc" id="L1064">            claims.put(tile, claimant);</span>
        }
<span class="fc bfc" id="L1066" title="All 2 branches covered.">        for (Entry&lt;Tile, Settlement&gt; e : claims.entrySet()) {</span>
<span class="fc" id="L1067">            Tile t = e.getKey();</span>
<span class="fc bfc" id="L1068" title="All 2 branches covered.">            if ((claimant = e.getValue()) == null) {</span>
<span class="fc" id="L1069">                t.changeOwnership(null, null);//-til</span>
<span class="fc" id="L1070">            } else {</span>
<span class="fc" id="L1071">                ServerPlayer newOwner = (ServerPlayer)claimant.getOwner();</span>
<span class="fc" id="L1072">                t.changeOwnership(newOwner, claimant);//-til</span>
            }
        }
<span class="fc" id="L1075">    }</span>

    /**
     * Create units from a list of abstract units.  Only used by
     * Europeans at present.
     *
     * -vis: Visibility issues depending on location.
     * -til: Tile appearance issue if created in a colony (not ATM)
     *
     * @param abstractUnits The list of &lt;code&gt;AbstractUnit&lt;/code&gt;s to
     *     create.
     * @param location The &lt;code&gt;Location&lt;/code&gt; where the units will
     *     be created.
     * @return A list of units created.
     */
    public List&lt;Unit&gt; createUnits(List&lt;AbstractUnit&gt; abstractUnits,
                                  Location location) {
<span class="pc bpc" id="L1092" title="1 of 2 branches missed.">        if (location == null) return Collections.&lt;Unit&gt;emptyList();</span>
<span class="fc" id="L1093">        List&lt;Unit&gt; units = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L1095">        final Game game = getGame();</span>
<span class="fc" id="L1096">        final Specification spec = game.getSpecification();</span>
<span class="fc bfc" id="L1097" title="All 2 branches covered.">        for (AbstractUnit au : abstractUnits) {</span>
<span class="fc" id="L1098">            UnitType type = au.getType(spec);</span>
<span class="fc" id="L1099">            Role role = au.getRole(spec);</span>
            // @compat 0.10.x
            // The REF always had an exemption from the availability
            // rules.  We are transitioning to it being subject to the
            // normal rules, which requires REF nations to have the
            // INDEPENDENT_NATION ability (or they do not get
            // man-o-war).  We are also handling the role transition.
            //
            // Drop the isREF() branch when the compatibility code
            // goes away.
<span class="fc bfc" id="L1109" title="All 2 branches covered.">            if (isREF()) {</span>
<span class="pc bpc" id="L1110" title="1 of 2 branches missed.">                if (!role.isAvailableTo(this, type)) {</span>
<span class="nc bnc" id="L1111" title="All 9 branches missed.">                    if (null != role.getId()) switch (role.getId()) {</span>
                        case &quot;model.role.soldier&quot;:
<span class="nc" id="L1113">                            role = spec.getRole(&quot;model.role.infantry&quot;);</span>
<span class="nc" id="L1114">                            break;</span>
                        case &quot;model.role.dragoon&quot;:
<span class="nc" id="L1116">                            role = spec.getRole(&quot;model.role.cavalry&quot;);</span>
                            break;
                    }
                }
<span class="nc" id="L1120">            } else {</span>
<span class="pc bpc" id="L1121" title="1 of 2 branches missed.">                if (!type.isAvailableTo(this)) {</span>
<span class="nc" id="L1122">                    logger.warning(&quot;Ignoring abstract unit &quot; + au</span>
<span class="nc" id="L1123">                        + &quot; unavailable to: &quot; + getId());</span>
<span class="nc" id="L1124">                    continue;</span>
                }
<span class="pc bpc" id="L1126" title="1 of 2 branches missed.">                if (!role.isAvailableTo(this, type)) {</span>
<span class="nc" id="L1127">                    logger.warning(&quot;Ignoring abstract unit &quot; + au</span>
<span class="nc" id="L1128">                        + &quot; with role &quot; + role</span>
<span class="nc" id="L1129">                        + &quot; unavailable to: &quot; + getId());</span>
<span class="nc" id="L1130">                    continue;</span>
                }
            }
            // end @compat 0.10.x
<span class="fc bfc" id="L1134" title="All 2 branches covered.">            for (int i = 0; i &lt; au.getNumber(); i++) {</span>
<span class="fc" id="L1135">                ServerUnit su = new ServerUnit(game, location, this, type,</span>
<span class="fc" id="L1136">                                               role);//-vis(this)</span>
<span class="fc" id="L1137">                units.add(su);</span>
            }
        }
<span class="fc" id="L1140">        return units;</span>
    }

    /**
     * Embark the land units.  For all land units, find a naval unit
     * to carry it.  Fill greedily, so as if there is excess naval
     * capacity then the naval units at the end of the list will tend
     * to be empty or very lightly filled, allowing them to defend the
     * whole fleet at full strength.  Returns a list of units that
     * could not be placed on ships.
     *
     * -vis: Has visibility implications depending on the initial
     * location of the loaded units.  Usually ATM this is Europe which
     * is safe, but beware.
     * -til: Safe while in Europe though.
     *
     * @param landUnits A list of land units to put on ships.
     * @param navalUnits A list of ships to put land units on.
     * @param random A pseudo-random number source.
     * @return a list of units left over
     */
    public List&lt;Unit&gt; loadShips(List&lt;Unit&gt; landUnits,
                                List&lt;Unit&gt; navalUnits,
                                Random random) {
<span class="fc" id="L1164">        List&lt;Unit&gt; leftOver = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L1165">        randomShuffle(logger, &quot;Naval load&quot;, navalUnits, random);</span>
<span class="fc" id="L1166">        randomShuffle(logger, &quot;Land load&quot;, landUnits, random);</span>
<span class="fc" id="L1167">        LogBuilder lb = new LogBuilder(256);</span>
<span class="fc" id="L1168">        lb.mark();</span>
<span class="fc bfc" id="L1169" title="All 2 branches covered.">        landUnit: for (Unit unit : landUnits) {</span>
<span class="pc bpc" id="L1170" title="1 of 2 branches missed.">            for (Unit carrier : navalUnits) {</span>
<span class="fc bfc" id="L1171" title="All 2 branches covered.">                if (carrier.canAdd(unit)) {</span>
<span class="fc" id="L1172">                    unit.setLocation(carrier);//-vis(owner)</span>
<span class="fc" id="L1173">                    lb.add(unit, &quot; -&gt; &quot;, carrier, &quot;, &quot;);</span>
<span class="fc" id="L1174">                    continue landUnit;</span>
                }
            }
<span class="nc" id="L1177">            leftOver.add(unit);</span>
        }
<span class="pc bpc" id="L1179" title="1 of 2 branches missed.">        if (lb.grew(&quot;Load ships: &quot;)) {</span>
<span class="fc" id="L1180">            lb.shrink(&quot;, &quot;);</span>
<span class="fc" id="L1181">            lb.log(logger, Level.FINEST);</span>
        }        
<span class="fc" id="L1183">        return leftOver;</span>
    }

    /**
     * Simpler frontend to loadShips.
     *
     * @param units The &lt;code&gt;Unit&lt;/code&gt;s to load.
     * @return The left over units.
     */
    public List&lt;Unit&gt; loadShips(List&lt;Unit&gt; units) {
<span class="nc" id="L1193">        List&lt;Unit&gt; landUnits = new ArrayList&lt;Unit&gt;();</span>
<span class="nc" id="L1194">        List&lt;Unit&gt; navalUnits = new ArrayList&lt;Unit&gt;();</span>
<span class="nc bnc" id="L1195" title="All 2 branches missed.">        for (Unit u : units) {</span>
<span class="nc bnc" id="L1196" title="All 2 branches missed.">            if (u.isNaval()) navalUnits.add(u); else landUnits.add(u);</span>
        }
<span class="nc" id="L1198">        return loadShips(landUnits, navalUnits, null);</span>
    }

    /**
     * Calculates the price of a group of mercenaries for this player.
     *
     * @param mercenaries A list of mercenaries to price.
     * @return The price.
     */
    public int priceMercenaries(List&lt;AbstractUnit&gt; mercenaries) {
<span class="nc" id="L1208">        int mercPrice = sum(mercenaries, au -&gt; getPrice(au));</span>
<span class="nc bnc" id="L1209" title="All 2 branches missed.">        if (!checkGold(mercPrice)) mercPrice = getGold();</span>
<span class="nc" id="L1210">        return mercPrice;</span>
    }

    /**
     * Flush any market price changes.
     *
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     * @return True if the market has changed.
     */
    public boolean csFlushMarket(ChangeSet cs) {
<span class="fc" id="L1220">        Market market = getMarket();</span>
<span class="pc bpc" id="L1221" title="1 of 2 branches missed.">        if (market == null) return false;</span>
<span class="fc" id="L1222">        boolean ret = false;</span>
<span class="fc" id="L1223">        StringBuilder sb = new StringBuilder(32);</span>
<span class="fc" id="L1224">        sb.append(&quot;Flush market for &quot;).append(getId()).append(&quot;:&quot;);</span>
<span class="fc bfc" id="L1225" title="All 2 branches covered.">        for (GoodsType type : getSpecification().getGoodsTypeList()) {</span>
<span class="fc bfc" id="L1226" title="All 2 branches covered.">            if (csFlushMarket(type, cs)) {</span>
<span class="fc" id="L1227">                sb.append(&quot; &quot;).append(type.getId());</span>
<span class="fc" id="L1228">                ret = true;</span>
            }
        }
<span class="fc bfc" id="L1231" title="All 2 branches covered.">        if (ret) logger.finest(sb.toString());</span>
<span class="fc" id="L1232">        return ret;</span>
    }

    /**
     * Flush any market price changes for a specified goods type.
     *
     * @param type The &lt;code&gt;GoodsType&lt;/code&gt; to check.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     * @return True if the market price had changed.
     */
    public boolean csFlushMarket(GoodsType type, ChangeSet cs) {
<span class="fc" id="L1243">        final Market market = getMarket();</span>
<span class="fc" id="L1244">        boolean ret = market.hasPriceChanged(type);</span>
<span class="fc bfc" id="L1245" title="All 2 branches covered.">        if (ret) {</span>
            // This type of goods has changed price, so we will update
            // the market and send a message as well.
<span class="fc" id="L1248">            cs.addMessage(See.only(this),</span>
<span class="fc" id="L1249">                          market.makePriceChangeMessage(type));</span>
<span class="fc" id="L1250">            market.flushPriceChange(type);</span>
<span class="fc" id="L1251">            cs.add(See.only(this), market.getMarketData(type));</span>
        }
<span class="fc" id="L1253">        return ret;</span>
    }

    /**
     * Buy goods in Europe.
     *
     * @param container The &lt;code&gt;GoodsContainer&lt;/code&gt; to carry the goods.
     * @param type The &lt;code&gt;GoodsType&lt;/code&gt; to buy.
     * @param amount The amount of goods to buy.
     * @return The amount actually removed from the market, or
     *     negative on failure.
     */
    public int buy(GoodsContainer container, GoodsType type, int amount) {
<span class="fc" id="L1266">        final Market market = getMarket();</span>
<span class="fc" id="L1267">        final int price = market.getBidPrice(type, amount);</span>
<span class="fc bfc" id="L1268" title="All 2 branches covered.">        if (!checkGold(price)) return -1;</span>

<span class="fc" id="L1270">        modifyGold(-price);</span>
<span class="fc" id="L1271">        market.modifySales(type, -amount);</span>
<span class="pc bpc" id="L1272" title="1 of 2 branches missed.">        if (container != null) container.addGoods(type, amount);</span>
<span class="fc" id="L1273">        market.modifyIncomeBeforeTaxes(type, -price);</span>
<span class="fc" id="L1274">        market.modifyIncomeAfterTaxes(type, -price);</span>
<span class="fc" id="L1275">        int marketAmount = (int)applyModifiers((float)amount,</span>
<span class="fc" id="L1276">            getGame().getTurn(), Modifier.TRADE_BONUS, type);</span>
<span class="fc" id="L1277">        market.addGoodsToMarket(type, -marketAmount);</span>
<span class="fc" id="L1278">        return marketAmount;</span>
    }

    /**
     * Sell goods in Europe.
     *
     * @param container An optional &lt;code&gt;GoodsContainer&lt;/code&gt;
     *     carrying the goods.
     * @param type The &lt;code&gt;GoodsType&lt;/code&gt; to sell.
     * @param amount The amount of goods to sell.
     * @return The amount actually added to the market, or negative on failure.
     */
    public int sell(GoodsContainer container, GoodsType type, int amount) {
<span class="fc" id="L1291">        final Market market = getMarket();</span>
<span class="fc" id="L1292">        final int tax = getTax();</span>
<span class="fc" id="L1293">        final int incomeBeforeTaxes = market.getSalePrice(type, amount);</span>
<span class="fc" id="L1294">        final int incomeAfterTaxes = ((100 - tax) * incomeBeforeTaxes) / 100;</span>
        
<span class="fc" id="L1296">        modifyGold(incomeAfterTaxes);</span>
<span class="fc" id="L1297">        market.modifySales(type, amount);</span>
<span class="fc bfc" id="L1298" title="All 2 branches covered.">        if (container != null) container.addGoods(type, -amount);</span>
<span class="fc" id="L1299">        market.modifyIncomeBeforeTaxes(type, incomeBeforeTaxes);</span>
<span class="fc" id="L1300">        market.modifyIncomeAfterTaxes(type, incomeAfterTaxes);</span>
<span class="fc" id="L1301">        int marketAmount = (int)applyModifiers((float)amount,</span>
<span class="fc" id="L1302">            getGame().getTurn(), Modifier.TRADE_BONUS, type);</span>
<span class="fc" id="L1303">        market.addGoodsToMarket(type, marketAmount);</span>
<span class="fc" id="L1304">        return marketAmount;</span>
    }

    /**
     * Adds a player to the list of players for whom the stance has changed.
     *
     * @param other The &lt;code&gt;ServerPlayer&lt;/code&gt; to add.
     */
    public void addStanceChange(ServerPlayer other) {
<span class="fc bfc" id="L1313" title="All 2 branches covered.">        if (!stanceDirty.contains(other)) stanceDirty.add(other);</span>
<span class="fc" id="L1314">    }</span>

    /**
     * Modifies stance.
     *
     * @param stance The new &lt;code&gt;Stance&lt;/code&gt;.
     * @param otherPlayer The &lt;code&gt;Player&lt;/code&gt; wrt which the stance changes.
     * @param symmetric If true, change the otherPlayer stance as well.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     * @return True if there was a change in stance at all.
     */
    public boolean csChangeStance(Stance stance, ServerPlayer otherPlayer,
                                  boolean symmetric, ChangeSet cs) {
<span class="fc" id="L1327">        ServerPlayer other = otherPlayer;</span>
<span class="fc" id="L1328">        boolean change = false;</span>
<span class="fc" id="L1329">        Stance old = getStance(otherPlayer);</span>

<span class="fc bfc" id="L1331" title="All 2 branches covered.">        if (old != stance) {</span>
<span class="fc" id="L1332">            int modifier = old.getTensionModifier(stance);</span>
<span class="fc" id="L1333">            setStance(otherPlayer, stance);</span>
<span class="fc bfc" id="L1334" title="All 2 branches covered.">            if (modifier != 0) {</span>
<span class="fc" id="L1335">                csModifyTension(otherPlayer, modifier, cs);//+til</span>
            }
<span class="fc" id="L1337">            cs.addHistory(this, new HistoryEvent(getGame().getTurn(),</span>
<span class="fc" id="L1338">                    HistoryEvent.getEventTypeFromStance(stance), otherPlayer)</span>
<span class="fc" id="L1339">                .addStringTemplate(&quot;%nation%&quot;, otherPlayer.getNationLabel()));</span>
<span class="fc" id="L1340">            logger.info(&quot;Stance modification &quot; + getName()</span>
<span class="fc" id="L1341">                + &quot; &quot; + old + &quot; -&gt; &quot; + stance + &quot; wrt &quot; + otherPlayer.getName());</span>
<span class="fc" id="L1342">            this.addStanceChange(other);</span>
<span class="fc bfc" id="L1343" title="All 2 branches covered.">            if (old != Stance.UNCONTACTED) {</span>
<span class="fc" id="L1344">                cs.addMessage(See.only(other),</span>
<span class="fc" id="L1345">                    new ModelMessage(MessageType.FOREIGN_DIPLOMACY,</span>
<span class="fc" id="L1346">                                     stance.getStanceChangeKey(), this)</span>
<span class="fc" id="L1347">                        .addStringTemplate(&quot;%nation%&quot;, getNationLabel()));</span>
            }
<span class="fc" id="L1349">            cs.addStance(See.only(this), this, stance, otherPlayer);</span>
<span class="fc" id="L1350">            cs.addStance(See.only(other), this, stance, otherPlayer);</span>
<span class="fc" id="L1351">            change = true;</span>
        }
<span class="fc bfc" id="L1353" title="All 4 branches covered.">        if (symmetric &amp;&amp; (old = otherPlayer.getStance(this)) != stance) {</span>
<span class="fc" id="L1354">            int modifier = old.getTensionModifier(stance);</span>
<span class="fc" id="L1355">            otherPlayer.setStance(this, stance);</span>
<span class="fc bfc" id="L1356" title="All 2 branches covered.">            if (modifier != 0) {</span>
<span class="fc" id="L1357">                other.csModifyTension(this, modifier, cs);//+til</span>
            }
<span class="fc" id="L1359">            cs.addHistory(otherPlayer, new HistoryEvent(getGame().getTurn(),</span>
<span class="fc" id="L1360">                    HistoryEvent.getEventTypeFromStance(stance), this)</span>
<span class="fc" id="L1361">                .addStringTemplate(&quot;%nation%&quot;, this.getNationLabel()));</span>
<span class="fc" id="L1362">            logger.info(&quot;Stance modification &quot; + otherPlayer.getName()</span>
<span class="fc" id="L1363">                + &quot; &quot; + old + &quot; -&gt; &quot; + stance</span>
<span class="fc" id="L1364">                + &quot; wrt &quot; + getName() + &quot; (symmetric)&quot;);</span>
<span class="fc" id="L1365">            other.addStanceChange(this);</span>
<span class="fc bfc" id="L1366" title="All 2 branches covered.">            if (old != Stance.UNCONTACTED) {</span>
<span class="fc" id="L1367">                cs.addMessage(See.only(this),</span>
<span class="fc" id="L1368">                    new ModelMessage(MessageType.FOREIGN_DIPLOMACY,</span>
<span class="fc" id="L1369">                                     stance.getStanceChangeKey(), otherPlayer)</span>
<span class="fc" id="L1370">                        .addStringTemplate(&quot;%nation%&quot;,</span>
<span class="fc" id="L1371">                            otherPlayer.getNationLabel()));</span>
            }
<span class="fc" id="L1373">            cs.addStance(See.only(this), otherPlayer, stance, this);</span>
<span class="fc" id="L1374">            cs.addStance(See.only(other), otherPlayer, stance, this);</span>
<span class="fc" id="L1375">            change = true;</span>
        }

<span class="fc" id="L1378">        return change;</span>
    }

    /**
     * Modifies the hostility against the given player.
     *
     * +til: Handles tile modifications.
     *
     * @param player The &lt;code&gt;Player&lt;/code&gt;.
     * @param add The amount to add to the current tension level.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csModifyTension(Player player, int add, ChangeSet cs) {
<span class="fc" id="L1391">        csModifyTension(player, add, null, cs);</span>
<span class="fc" id="L1392">    }</span>

    /**
     * Modifies the hostility against the given player.
     *
     * +til: Handles tile modifications.
     *
     * @param player The &lt;code&gt;Player&lt;/code&gt;.
     * @param add The amount to add to the current tension level.
     * @param origin A &lt;code&gt;Settlement&lt;/code&gt; where the alarming event
     *     occurred.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csModifyTension(Player player, int add, Settlement origin,
                                ChangeSet cs) {
<span class="fc" id="L1407">        Tension.Level oldLevel = getTension(player).getLevel();</span>
<span class="fc" id="L1408">        getTension(player).modify(add);</span>
<span class="fc bfc" id="L1409" title="All 2 branches covered.">        if (oldLevel != getTension(player).getLevel()) {</span>
<span class="fc" id="L1410">            cs.add(See.only((ServerPlayer)player), this);</span>
        }

        // Propagate tension change as settlement alarm to all
        // settlements except the one that originated it (if any).
<span class="fc bfc" id="L1415" title="All 2 branches covered.">        if (isIndian()) {</span>
<span class="fc bfc" id="L1416" title="All 2 branches covered.">            for (IndianSettlement is : getIndianSettlements()) {</span>
<span class="fc bfc" id="L1417" title="All 4 branches covered.">                if (is == origin || !is.hasContacted(player)) continue;</span>
<span class="fc" id="L1418">                ((ServerIndianSettlement)is).csModifyAlarm(player, add,</span>
<span class="fc" id="L1419">                                                           false, cs);//+til</span>
            }
        }
<span class="fc" id="L1422">    }</span>

    /**
     * New turn for this player.
     *
     * @param random A &lt;code&gt;Random&lt;/code&gt; number source.
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    @Override
    public void csNewTurn(Random random, LogBuilder lb, ChangeSet cs) {
<span class="fc" id="L1433">        lb.add(&quot;PLAYER &quot;, getName(), &quot;: &quot;);</span>
<span class="fc" id="L1434">        final Game game = getGame();</span>

        // Settlements
<span class="fc" id="L1437">        List&lt;Settlement&gt; settlements = new ArrayList&lt;&gt;(getSettlements());</span>
<span class="fc" id="L1438">        int newSoL = 0, newImmigration = getImmigration();</span>
<span class="fc bfc" id="L1439" title="All 2 branches covered.">        for (Settlement settlement : settlements) {</span>
<span class="fc" id="L1440">            ((ServerModelObject)settlement).csNewTurn(random, lb, cs);</span>
<span class="fc" id="L1441">            newSoL += settlement.getSoL();</span>
        }
<span class="fc" id="L1443">        newImmigration = getImmigration() - newImmigration;</span>

<span class="fc" id="L1445">        int numberOfColonies = settlements.size();</span>
<span class="fc bfc" id="L1446" title="All 2 branches covered.">        if (numberOfColonies &gt; 0) {</span>
<span class="fc" id="L1447">            newSoL = newSoL / numberOfColonies;</span>
<span class="fc bfc" id="L1448" title="All 2 branches covered.">            if (oldSoL / 10 != newSoL / 10) {</span>
<span class="pc bpc" id="L1449" title="1 of 2 branches missed.">                String key = (newSoL &gt; oldSoL)</span>
<span class="fc" id="L1450">                    ? &quot;model.player.soLIncrease&quot;</span>
<span class="nc" id="L1451">                    : &quot;model.player.soLDecrease&quot;;</span>
<span class="fc" id="L1452">                cs.addMessage(See.only(this),</span>
<span class="fc" id="L1453">                    new ModelMessage(MessageType.SONS_OF_LIBERTY, key, this)</span>
<span class="fc" id="L1454">                        .addAmount(&quot;%oldSoL%&quot;, oldSoL)</span>
<span class="fc" id="L1455">                        .addAmount(&quot;%newSoL%&quot;, newSoL));</span>
            }
<span class="fc" id="L1457">            oldSoL = newSoL; // Remember SoL for check changes at next turn.</span>
        }

        // Europe.
<span class="fc bfc" id="L1461" title="All 2 branches covered.">        if (europe != null) {</span>
<span class="fc" id="L1462">            ((ServerModelObject) europe).csNewTurn(random, lb, cs);</span>
<span class="fc" id="L1463">            modifyImmigration(europe.getImmigration(newImmigration));</span>
        }
        // Units.
<span class="fc bfc" id="L1466" title="All 2 branches covered.">        for (Unit unit : new ArrayList&lt;&gt;(getUnits())) {</span>
            try {
<span class="fc" id="L1468">                ((ServerModelObject) unit).csNewTurn(random, lb, cs);</span>
<span class="pc" id="L1469">            } catch (ClassCastException e) {</span>
<span class="nc" id="L1470">                logger.log(Level.SEVERE, &quot;Not a ServerUnit: &quot; + unit.getId(), e);</span>
            }
        }

<span class="fc bfc" id="L1474" title="All 2 branches covered.">        if (isEuropean()) { // Update liberty and immigration</span>
            // Auto-emigrate if selection not allowed.
<span class="pc bpc" id="L1476" title="1 of 2 branches missed.">            if (hasAbility(Ability.SELECT_RECRUIT)) {</span>
<span class="nc" id="L1477">                cs.addPartial(See.only(this), this, &quot;immigration&quot;);</span>
<span class="nc" id="L1478">            } else {</span>
<span class="fc bfc" id="L1479" title="All 2 branches covered.">                while (checkEmigrate()) {</span>
<span class="fc" id="L1480">                    csEmigrate(MigrationType.getUnspecificSlot(),</span>
<span class="fc" id="L1481">                               MigrationType.NORMAL, random, cs);</span>
                }
            }
<span class="fc" id="L1484">            cs.addPartial(See.only(this), this, &quot;liberty&quot;);</span>

<span class="pc bpc" id="L1486" title="1 of 2 branches missed.">            if (getSpecification().getBoolean(GameOptions.ENABLE_UPKEEP)) {</span>
<span class="nc" id="L1487">                csPayUpkeep(random, cs);</span>
            }

<span class="fc" id="L1490">            int probability = getSpecification().getInteger(GameOptions.NATURAL_DISASTERS);</span>
<span class="pc bpc" id="L1491" title="1 of 2 branches missed.">            if (probability &gt; 0) {</span>
<span class="nc" id="L1492">                csNaturalDisasters(random, cs, probability);</span>
            }

<span class="pc bpc" id="L1495" title="1 of 2 branches missed.">            if (isRebel() &amp;&amp; interventionBells</span>
<span class="nc bnc" id="L1496" title="All 2 branches missed.">                &gt;= getSpecification().getInteger(GameOptions.INTERVENTION_BELLS)) {</span>
<span class="nc" id="L1497">                interventionBells = Integer.MIN_VALUE;</span>
                
                // Enter near a port.
<span class="nc" id="L1500">                List&lt;Colony&gt; ports = getPorts();</span>
<span class="nc" id="L1501">                Colony port = getRandomMember(logger, &quot;Intervention port&quot;,</span>
<span class="nc" id="L1502">                                              ports, random);</span>
<span class="nc" id="L1503">                Tile portTile = port.getTile();</span>
<span class="nc" id="L1504">                Tile entry = game.getMap().searchCircle(portTile,</span>
<span class="nc" id="L1505">                    GoalDeciders.getSimpleHighSeasGoalDecider(),</span>
<span class="nc" id="L1506">                    portTile.getHighSeasCount()+1).getSafeTile(this, random);</span>
                
                // Create the force.
                // @compat 0.10.5
                // We used to nullify the monarch when declaring independence.
                // There are saved games out there where this happened
                // (see BR#2435).  Defend against NPE.
<span class="nc" id="L1513">                Force ivf = null;</span>
<span class="nc bnc" id="L1514" title="All 2 branches missed.">                if (getMonarch() != null</span>
                // end @compat 0.10.5
<span class="nc bnc" id="L1516" title="All 2 branches missed.">                    &amp;&amp; (ivf = getMonarch().getInterventionForce()) != null) {</span>
<span class="nc" id="L1517">                    List&lt;Unit&gt; landUnits = createUnits(ivf.getLandUnits(),</span>
<span class="nc" id="L1518">                                                       entry);//-vis(this)</span>
<span class="nc" id="L1519">                    List&lt;Unit&gt; navalUnits = createUnits(ivf.getNavalUnits(),</span>
<span class="nc" id="L1520">                                                        entry);//-vis(this)</span>
<span class="nc" id="L1521">                    List&lt;Unit&gt; leftOver = loadShips(landUnits, navalUnits,</span>
<span class="nc" id="L1522">                                                    random);//-vis(this)</span>
<span class="nc bnc" id="L1523" title="All 2 branches missed.">                    for (Unit unit : leftOver) {</span>
                        // no use for left over units
<span class="nc" id="L1525">                        logger.warning(&quot;Disposing of left over unit &quot; + unit);</span>
<span class="nc" id="L1526">                        unit.setLocationNoUpdate(null);//-vis: safe, off map</span>
<span class="nc" id="L1527">                        unit.dispose();//-vis: safe, never sighted</span>
                    }
<span class="nc" id="L1529">                    Set&lt;Tile&gt; tiles = exploreForUnit(navalUnits.get(0));</span>
<span class="nc bnc" id="L1530" title="All 2 branches missed.">                    if (!tiles.contains(entry)) tiles.add(entry);</span>
<span class="nc" id="L1531">                    invalidateCanSeeTiles();//+vis(this)</span>
<span class="nc" id="L1532">                    cs.add(See.perhaps(), tiles);</span>
<span class="nc" id="L1533">                    cs.addMessage(See.only(this),</span>
<span class="nc" id="L1534">                        new ModelMessage(MessageType.DEFAULT,</span>
<span class="nc" id="L1535">                                         &quot;model.player.interventionForceArrives&quot;,</span>
<span class="nc" id="L1536">                                         this));</span>
<span class="nc" id="L1537">                    logger.info(&quot;Intervention force (&quot;</span>
<span class="nc" id="L1538">                        + navalUnits.size() + &quot; naval, &quot;</span>
<span class="nc" id="L1539">                        + landUnits.size() + &quot; land, &quot;</span>
<span class="nc" id="L1540">                        + leftOver.size() + &quot; left over) arrives at &quot; + entry</span>
<span class="nc" id="L1541">                        + &quot;(for &quot; + port.getName() + &quot;)&quot;);</span>
                }
            }
        }

        // Update stances
<span class="pc bfc" id="L1547" title="All 2 branches covered.">        while (!stanceDirty.isEmpty()) {</span>
<span class="fc" id="L1548">            ServerPlayer s = stanceDirty.remove(0);</span>
<span class="fc" id="L1549">            Stance sta = getStance(s);</span>
<span class="pc bpc" id="L1550" title="1 of 2 branches missed.">            boolean war = sta == Stance.WAR;</span>
<span class="pc bpc" id="L1551" title="1 of 2 branches missed.">            if (sta == Stance.UNCONTACTED) continue;</span>
<span class="fc bfc" id="L1552" title="All 2 branches covered.">            for (Player p : game.getLiveEuropeanPlayers(this)) {</span>
<span class="fc" id="L1553">                ServerPlayer sp = (ServerPlayer) p;</span>
<span class="pc bpc" id="L1554" title="1 of 4 branches missed.">                if (p == s || !p.hasContacted(this)</span>
<span class="nc bnc" id="L1555" title="All 2 branches missed.">                    || !p.hasContacted(s)) continue;</span>
<span class="nc bnc" id="L1556" title="All 2 branches missed.">                if (p.hasAbility(Ability.BETTER_FOREIGN_AFFAIRS_REPORT)</span>
<span class="nc bnc" id="L1557" title="All 2 branches missed.">                    || war) {</span>
<span class="nc" id="L1558">                    cs.addStance(See.only(sp), this, sta, s);</span>
<span class="nc" id="L1559">                    cs.addMessage(See.only(sp),</span>
<span class="nc" id="L1560">                        new ModelMessage(MessageType.FOREIGN_DIPLOMACY,</span>
<span class="nc" id="L1561">                                         sta.getOtherStanceChangeKey(), this)</span>
<span class="nc" id="L1562">                            .addStringTemplate(&quot;%attacker%&quot;, getNationLabel())</span>
<span class="nc" id="L1563">                            .addStringTemplate(&quot;%defender%&quot;, s.getNationLabel()));</span>
                }
            }
        }
<span class="fc" id="L1567">    }</span>

    public void csPayUpkeep(Random random, ChangeSet cs) {
<span class="nc" id="L1570">        final Specification spec = getSpecification();</span>
<span class="nc" id="L1571">        final Disaster bankruptcy = spec.getDisaster(Disaster.BANKRUPTCY);</span>

<span class="nc" id="L1573">        boolean changed = false;</span>
<span class="nc" id="L1574">        int upkeep = sum(getSettlements(), Settlement::getUpkeep);</span>
<span class="nc bnc" id="L1575" title="All 2 branches missed.">        if (checkGold(upkeep)) {</span>
<span class="nc" id="L1576">            modifyGold(-upkeep);</span>
<span class="nc bnc" id="L1577" title="All 2 branches missed.">            if (getBankrupt()) {</span>
<span class="nc" id="L1578">                setBankrupt(false);</span>
<span class="nc" id="L1579">                changed = true;</span>
                // the only effects of a disaster that can be reversed
                // are the modifiers
<span class="nc bnc" id="L1582" title="All 2 branches missed.">                for (RandomChoice&lt;Effect&gt; effect: bankruptcy.getEffects()) {</span>
<span class="nc bnc" id="L1583" title="All 2 branches missed.">                    for (Modifier modifier : effect.getObject().getModifiers()) {</span>
<span class="nc" id="L1584">                        cs.addFeatureChange(this, this, modifier, false);</span>
                    }
                }
<span class="nc" id="L1587">                cs.addMessage(See.only(this),</span>
<span class="nc" id="L1588">                    new ModelMessage(MessageType.GOVERNMENT_EFFICIENCY,</span>
<span class="nc" id="L1589">                                     &quot;model.player.disaster.bankruptcy.stop&quot;,</span>
<span class="nc" id="L1590">                                     this));</span>
            }
<span class="nc" id="L1592">        } else {</span>
<span class="nc" id="L1593">            modifyGold(-getGold());</span>
<span class="nc bnc" id="L1594" title="All 2 branches missed.">            if (!getBankrupt()) {</span>
<span class="nc" id="L1595">                setBankrupt(true);</span>
<span class="nc" id="L1596">                changed = true;</span>
<span class="nc" id="L1597">                csApplyDisaster(random, null, bankruptcy, cs);</span>
<span class="nc" id="L1598">                cs.addMessage(See.only(this),</span>
<span class="nc" id="L1599">                    new ModelMessage(MessageType.GOVERNMENT_EFFICIENCY,</span>
<span class="nc" id="L1600">                                     &quot;model.player.disaster.bankruptcy.start&quot;,</span>
<span class="nc" id="L1601">                                     this));</span>
            }
        }
<span class="nc bnc" id="L1604" title="All 2 branches missed.">        if (upkeep &gt; 0) cs.addPartial(See.only(this), this, &quot;gold&quot;);</span>
<span class="nc bnc" id="L1605" title="All 2 branches missed.">        if (changed) cs.addPartial(See.only(this), this, &quot;bankrupt&quot;);</span>
<span class="nc" id="L1606">    }</span>

    public void csNaturalDisasters(Random random, ChangeSet cs,
                                   int probability) {
<span class="nc bnc" id="L1610" title="All 2 branches missed.">        if (randomInt(logger, &quot;Natural disaster&quot;, random, 100) &lt; probability) {</span>
<span class="nc" id="L1611">            int size = getSettlements().size();</span>
<span class="nc bnc" id="L1612" title="All 2 branches missed.">            if (size &lt; 1) return;</span>
            // randomly select a colony to start with, then generate
            // an appropriate disaster if possible, else continue with
            // the next colony
<span class="nc" id="L1616">            int start = randomInt(logger, &quot;select colony&quot;, random, size);</span>
<span class="nc bnc" id="L1617" title="All 2 branches missed.">            for (int index = 0; index &lt; size; index++) {</span>
<span class="nc" id="L1618">                Colony colony = getColonies().get((start + index) % size);</span>
<span class="nc" id="L1619">                List&lt;RandomChoice&lt;Disaster&gt;&gt; disasters = colony.getDisasters();</span>
<span class="nc bnc" id="L1620" title="All 2 branches missed.">                if (!disasters.isEmpty()) {</span>
<span class="nc" id="L1621">                    Disaster disaster = RandomChoice</span>
<span class="nc" id="L1622">                        .getWeightedRandom(logger, &quot;select disaster&quot;, disasters,</span>
<span class="nc" id="L1623">                                           random);</span>
<span class="nc" id="L1624">                    List&lt;ModelMessage&gt; messages = csApplyDisaster(random,</span>
<span class="nc" id="L1625">                        colony, disaster, cs);</span>
<span class="nc bnc" id="L1626" title="All 2 branches missed.">                    if (!messages.isEmpty()) {</span>
<span class="nc" id="L1627">                        cs.addMessage(See.only(this),</span>
<span class="nc" id="L1628">                            new ModelMessage(MessageType.DEFAULT,</span>
<span class="nc" id="L1629">                                             &quot;model.player.disaster.strikes&quot;,</span>
<span class="nc" id="L1630">                                             colony)</span>
<span class="nc" id="L1631">                                .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="nc" id="L1632">                                .addName(&quot;%disaster%&quot;, disaster));</span>
<span class="nc bnc" id="L1633" title="All 2 branches missed.">                        for (ModelMessage message : messages) {</span>
<span class="nc" id="L1634">                            cs.addMessage(See.only(this), message);</span>
                        }
<span class="nc" id="L1636">                        return;</span>
                    }
                }
            }
        }
<span class="nc" id="L1641">    }</span>

    /**
     * Apply the effects of the given &lt;code&gt;Disaster&lt;/code&gt; to the
     * given &lt;code&gt;Colony&lt;/code&gt;, or the &lt;code&gt;Player&lt;/code&gt; if the
     * &lt;code&gt;Colony&lt;/code&gt; is &lt;code&gt;null&lt;/code&gt;, and return a list of
     * appropriate &lt;code&gt;ModelMessage&lt;/code&gt;s. Note that a disaster
     * might have no effect on a particular colony. In that case, the
     * returned list is empty.
     *
     * @param random A &lt;code&gt;Random&lt;/code&gt; number source.
     * @param colony A &lt;code&gt;Colony&lt;/code&gt;, or &lt;code&gt;null&lt;/code&gt;.
     * @param disaster A &lt;code&gt;Disaster&lt;/code&gt; value.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     * @return A list of &lt;code&gt;ModelMessage&lt;/code&gt;s, possibly empty.
     */
    public List&lt;ModelMessage&gt; csApplyDisaster(Random random, Colony colony,
                                              Disaster disaster, ChangeSet cs) {
<span class="nc" id="L1659">        StringBuilder sb = new StringBuilder(64);</span>
<span class="nc" id="L1660">        sb.append(&quot;Applying &quot;).append(disaster.getNumberOfEffects())</span>
<span class="nc" id="L1661">            .append(&quot; effect/s of disaster &quot;)</span>
<span class="nc" id="L1662">            .append(Messages.getName(disaster));</span>
<span class="nc bnc" id="L1663" title="All 2 branches missed.">        if (colony != null) sb.append(&quot; to &quot;).append(colony.getName());</span>
<span class="nc" id="L1664">        sb.append(&quot;:&quot;);</span>
<span class="nc" id="L1665">        List&lt;Effect&gt; effects = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1666" title="All 4 branches missed.">        switch (disaster.getNumberOfEffects()) {</span>
        case ONE:
<span class="nc" id="L1668">            effects.add(RandomChoice.getWeightedRandom(logger,</span>
<span class="nc" id="L1669">                    &quot;Get effect of disaster&quot;, disaster.getEffects(), random));</span>
<span class="nc" id="L1670">            sb.append(&quot; &quot;).append(Messages.getName(effects.get(0)));</span>
<span class="nc" id="L1671">            break;</span>
        case SEVERAL:
<span class="nc bnc" id="L1673" title="All 2 branches missed.">            for (RandomChoice&lt;Effect&gt; effect : disaster.getEffects()) {</span>
<span class="nc" id="L1674">                if (randomInt(logger, &quot;Get effects of disaster&quot;, random, 100)</span>
<span class="nc bnc" id="L1675" title="All 2 branches missed.">                    &lt; effect.getProbability()) {</span>
<span class="nc" id="L1676">                    effects.add(effect.getObject());</span>
<span class="nc" id="L1677">                    sb.append(&quot; &quot;).append(Messages.getName(effect.getObject()));</span>
                }
            }
<span class="nc" id="L1680">            break;</span>
        case ALL:
<span class="nc bnc" id="L1682" title="All 2 branches missed.">            for (RandomChoice&lt;Effect&gt; effect : disaster.getEffects()) {</span>
<span class="nc" id="L1683">                effects.add(effect.getObject());</span>
<span class="nc" id="L1684">                sb.append(&quot; &quot;).append(Messages.getName(effect.getObject()));</span>
            }
        }
<span class="nc bnc" id="L1687" title="All 2 branches missed.">        if (effects.isEmpty()) sb.append(&quot; All avoided&quot;);</span>
<span class="nc" id="L1688">        logger.fine(sb.toString());</span>

<span class="nc" id="L1690">        boolean colonyDirty = false;</span>
<span class="nc" id="L1691">        List&lt;ModelMessage&gt; messages = new ArrayList&lt;&gt;();</span>
        ModelMessage mm;
<span class="nc bnc" id="L1693" title="All 2 branches missed.">outer:  for (Effect effect : effects) {</span>
<span class="nc" id="L1694">            mm = null;</span>
<span class="nc bnc" id="L1695" title="All 2 branches missed.">            if (colony == null) {</span>
<span class="nc bnc" id="L1696" title="All 2 branches missed.">                for (Modifier modifier : effect.getModifiers()) {</span>
<span class="nc bnc" id="L1697" title="All 2 branches missed.">                    if (modifier.getDuration() &gt; 0) {</span>
<span class="nc" id="L1698">                        Modifier timedModifier = Modifier</span>
<span class="nc" id="L1699">                            .makeTimedModifier(modifier.getId(), modifier, getGame().getTurn());</span>
<span class="nc" id="L1700">                        modifier.setModifierIndex(Modifier.DISASTER_PRODUCTION_INDEX);</span>
<span class="nc" id="L1701">                        cs.addFeatureChange(this, this, timedModifier, true);</span>
<span class="nc" id="L1702">                    } else {</span>
<span class="nc" id="L1703">                        cs.addFeatureChange(this, this, modifier, true);</span>
                    }
                }
<span class="nc" id="L1706">            } else {</span>
<span class="nc bnc" id="L1707" title="All 2 branches missed.">                if (null != effect.getId()) {</span>
<span class="nc bnc" id="L1708" title="All 16 branches missed.">                    switch (effect.getId()) {</span>
                    case Effect.LOSS_OF_MONEY:
<span class="nc" id="L1710">                        int plunder = Math.max(1, colony.getPlunder(null, random) / 5);</span>
<span class="nc" id="L1711">                        modifyGold(-plunder);</span>
<span class="nc" id="L1712">                        cs.addPartial(See.only(this), this, &quot;gold&quot;);</span>
<span class="nc" id="L1713">                        mm = new ModelMessage(MessageType.DEFAULT,</span>
<span class="nc" id="L1714">                                              effect.getId(), this)</span>
<span class="nc" id="L1715">                            .addAmount(&quot;%amount%&quot;, plunder);</span>
<span class="nc" id="L1716">                        break;</span>
                    case Effect.LOSS_OF_BUILDING:
<span class="nc" id="L1718">                        Building building = getBuildingForEffect(colony, effect, random);</span>
<span class="nc bnc" id="L1719" title="All 2 branches missed.">                        if (building != null) {</span>
                            // Add message before damaging building
<span class="nc" id="L1721">                            mm = new ModelMessage(MessageType.DEFAULT,</span>
<span class="nc" id="L1722">                                                  effect.getId(), colony)</span>
<span class="nc" id="L1723">                                .addNamed(&quot;%building%&quot;, building.getType());</span>
<span class="nc" id="L1724">                            csDamageBuilding(building, cs);</span>
<span class="nc" id="L1725">                            colonyDirty = true;</span>
                        }
<span class="nc" id="L1727">                        break;</span>
                    case Effect.LOSS_OF_GOODS:
<span class="nc" id="L1729">                        Goods goods = getRandomMember(logger, &quot;select goods&quot;,</span>
<span class="nc" id="L1730">                            colony.getLootableGoodsList(),</span>
<span class="nc" id="L1731">                            random);</span>
<span class="nc bnc" id="L1732" title="All 2 branches missed.">                        if (goods != null) {</span>
<span class="nc" id="L1733">                            goods.setAmount(Math.min(goods.getAmount() / 2, 50));</span>
<span class="nc" id="L1734">                            colony.removeGoods(goods);</span>
<span class="nc" id="L1735">                            mm = new ModelMessage(MessageType.DEFAULT,</span>
<span class="nc" id="L1736">                                                  effect.getId(), colony)</span>
<span class="nc" id="L1737">                                .addStringTemplate(&quot;%goods%&quot;, goods.getLabel(true));</span>
<span class="nc" id="L1738">                            colonyDirty = true;</span>
                        }
<span class="nc" id="L1740">                        break;</span>
                    case Effect.LOSS_OF_UNIT:
                        {
<span class="nc" id="L1743">                            Unit unit = getUnitForEffect(colony, effect, random);</span>
<span class="nc bnc" id="L1744" title="All 2 branches missed.">                            if (unit != null) {</span>
<span class="nc bnc" id="L1745" title="All 2 branches missed.">                                if (colony.getUnitCount() == 1) {</span>
<span class="nc" id="L1746">                                    messages.clear();</span>
<span class="nc" id="L1747">                                    mm = new ModelMessage(MessageType.DEFAULT,</span>
<span class="nc" id="L1748">                                        &quot;model.player.disaster.effect.colonyDestroyed&quot;,</span>
<span class="nc" id="L1749">                                        this)</span>
<span class="nc" id="L1750">                                        .addName(&quot;%colony%&quot;, colony.getName());</span>
<span class="nc" id="L1751">                                    messages.add(mm);</span>
<span class="nc" id="L1752">                                    csDisposeSettlement(colony, cs);</span>
<span class="nc" id="L1753">                                    colonyDirty = false;</span>
<span class="nc" id="L1754">                                    break outer; // No point proceeding</span>
                                }
<span class="nc" id="L1756">                                mm = new ModelMessage(MessageType.DEFAULT,</span>
<span class="nc" id="L1757">                                                      effect.getId(), colony)</span>
<span class="nc" id="L1758">                                    .addStringTemplate(&quot;%unit%&quot;,</span>
<span class="nc" id="L1759">                                        unit.getLabel());</span>
<span class="nc" id="L1760">                                cs.addRemove(See.only(this), null, unit);</span>
<span class="nc" id="L1761">                                unit.dispose();//-vis: Safe, entirely within colony</span>
<span class="nc" id="L1762">                                colonyDirty = true;</span>
                            }
<span class="nc" id="L1764">                            break;</span>
                        }
                    case Effect.DAMAGED_UNIT:
                        {
<span class="nc" id="L1768">                            Unit unit = getUnitForEffect(colony, effect, random);</span>
<span class="nc bnc" id="L1769" title="All 4 branches missed.">                            if (unit != null &amp;&amp; unit.isNaval()) {</span>
<span class="nc" id="L1770">                                Location repairLocation = unit.getRepairLocation();</span>
<span class="nc bnc" id="L1771" title="All 2 branches missed.">                                if (repairLocation == null) {</span>
<span class="nc" id="L1772">                                    mm = new ModelMessage(MessageType.DEFAULT,</span>
<span class="nc" id="L1773">                                                          effect.getId(),</span>
<span class="nc" id="L1774">                                                          colony)</span>
<span class="nc" id="L1775">                                        .addStringTemplate(&quot;%unit%&quot;,</span>
<span class="nc" id="L1776">                                            unit.getLabel());</span>
<span class="nc" id="L1777">                                    csSinkShip(unit, null, cs);</span>
<span class="nc" id="L1778">                                } else {</span>
<span class="nc" id="L1779">                                    mm = new ModelMessage(MessageType.DEFAULT,</span>
<span class="nc" id="L1780">                                                          effect.getId(),</span>
<span class="nc" id="L1781">                                                          colony)</span>
<span class="nc" id="L1782">                                        .addStringTemplate(&quot;%unit%&quot;,</span>
<span class="nc" id="L1783">                                            unit.getLabel());</span>
<span class="nc" id="L1784">                                    csDamageShip(unit, repairLocation, cs);</span>
                                }
<span class="nc" id="L1786">                                colonyDirty = true;</span>
                            }
<span class="nc" id="L1788">                            break;</span>
                        }
                    default:
<span class="nc" id="L1791">                        mm = new ModelMessage(MessageType.DEFAULT,</span>
<span class="nc" id="L1792">                                              effect.getId(), colony);</span>
<span class="nc bnc" id="L1793" title="All 2 branches missed.">                        for (Modifier modifier : effect.getModifiers()) {</span>
<span class="nc bnc" id="L1794" title="All 2 branches missed.">                            if (modifier.getDuration() &gt; 0) {</span>
<span class="nc" id="L1795">                                Modifier timedModifier = Modifier</span>
<span class="nc" id="L1796">                                    .makeTimedModifier(modifier.getId(), modifier, getGame().getTurn());</span>
<span class="nc" id="L1797">                                timedModifier.setModifierIndex(Modifier.DISASTER_PRODUCTION_INDEX);</span>
<span class="nc" id="L1798">                                cs.addFeatureChange(this, colony, timedModifier, true);</span>
<span class="nc" id="L1799">                            } else {</span>
<span class="nc" id="L1800">                                cs.addFeatureChange(this, colony, modifier, true);</span>
                            }
<span class="nc" id="L1802">                            colonyDirty = true;</span>
                        }
                        break;
                    }
                }
            }
<span class="nc bnc" id="L1808" title="All 2 branches missed.">            if (mm != null) messages.add(mm);</span>
        }
<span class="nc bnc" id="L1810" title="All 2 branches missed.">        if (colonyDirty) cs.add(See.perhaps(), colony);</span>
<span class="nc" id="L1811">        return messages;</span>
    }

    public Building getBuildingForEffect(Colony colony, Effect effect, Random random) {
<span class="nc" id="L1815">        List&lt;Building&gt; buildings = colony.getBurnableBuildings();</span>
<span class="nc bnc" id="L1816" title="All 2 branches missed.">        return (buildings.isEmpty()) ? null</span>
<span class="nc" id="L1817">            : getRandomMember(logger, &quot;Select building for effect&quot;,</span>
<span class="nc" id="L1818">                              buildings, random);</span>
    }

    public Unit getUnitForEffect(Colony colony, Effect effect, Random random) {
<span class="nc" id="L1822">        List&lt;Unit&gt; units</span>
<span class="nc" id="L1823">            = transform(Stream.concat(colony.getUnitList().stream(),</span>
<span class="nc" id="L1824">                                      colony.getTile().getUnitList().stream()),</span>
<span class="nc" id="L1825">                u -&gt; effect.appliesTo(u.getType()), Collectors.toList());</span>
<span class="nc bnc" id="L1826" title="All 2 branches missed.">        return (units.isEmpty()) ? null</span>
<span class="nc" id="L1827">            : getRandomMember(logger, &quot;Select unit for effect&quot;, units, random);</span>
    }

    /**
     * Propagate an European market trade to the other European markets.
     *
     * @param type The type of goods that was traded.
     * @param amount The amount of goods that was traded.
     * @param random A pseudo-random number source.
     */
    public void propagateToEuropeanMarkets(GoodsType type, int amount,
                                           Random random) {
<span class="pc bpc" id="L1839" title="1 of 2 branches missed.">        if (!type.isStorable()) return;</span>

        // Propagate 5-30% of the original change.
<span class="fc" id="L1842">        final int lowerBound = 5; // FIXME: to spec</span>
<span class="fc" id="L1843">        final int upperBound = 30;// FIXME: to spec</span>
<span class="fc" id="L1844">        amount *= randomInt(logger, &quot;Propagate goods&quot;, random,</span>
<span class="fc" id="L1845">                            upperBound - lowerBound + 1) + lowerBound;</span>
<span class="fc" id="L1846">        amount /= 100;</span>
<span class="fc bfc" id="L1847" title="All 2 branches covered.">        if (amount == 0) return;</span>

        // Do not need to update the clients here, these changes happen
        // while it is not their turn.
<span class="fc bfc" id="L1851" title="All 2 branches covered.">        for (Player p : getGame().getLiveEuropeanPlayers(this)) {</span>
<span class="fc" id="L1852">            Market market = p.getMarket();</span>
<span class="pc bpc" id="L1853" title="1 of 2 branches missed.">            if (market != null) market.addGoodsToMarket(type, amount);</span>
        }
<span class="fc" id="L1855">    }</span>

    /**
     * Add or remove a standard yearly amount of storable goods, and a
     * random extra amount of a random type.  Then push out all the
     * accumulated trades.
     *
     * @param random A pseudo-random number source.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csYearlyGoodsAdjust(Random random, ChangeSet cs) {
<span class="fc" id="L1866">        final Game game = getGame();</span>
<span class="fc" id="L1867">        final List&lt;GoodsType&gt; goodsTypes = game.getSpecification()</span>
<span class="fc" id="L1868">            .getStorableGoodsTypeList();</span>
<span class="fc" id="L1869">        final Market market = getMarket();</span>

        // Pick a random type of storable goods to add/remove an extra
        // amount of.
        GoodsType extraType;
<span class="fc" id="L1874">        while (!(extraType = getRandomMember(logger, &quot;Choose goods type&quot;,</span>
<span class="pc bpc" id="L1875" title="1 of 2 branches missed.">                                             goodsTypes, random)).isStorable());</span>

        // Remove standard amount, and the extra amount.
<span class="fc bfc" id="L1878" title="All 2 branches covered.">        for (GoodsType type : goodsTypes) {</span>
<span class="fc bfc" id="L1879" title="All 2 branches covered.">            if (market.hasBeenTraded(type)) {</span>
<span class="fc bfc" id="L1880" title="All 2 branches covered.">                boolean add = market.getAmountInMarket(type)</span>
<span class="fc" id="L1881">                    &lt; type.getInitialAmount();</span>
<span class="fc" id="L1882">                int amount = game.getTurn().getNumber() / 10;</span>
<span class="fc bfc" id="L1883" title="All 2 branches covered.">                if (type == extraType) amount = 2 * amount + 1;</span>
<span class="pc bpc" id="L1884" title="1 of 2 branches missed.">                if (amount &lt;= 0) continue;</span>
<span class="fc" id="L1885">                amount = randomInt(logger, &quot;Market adjust &quot; + type,</span>
<span class="fc" id="L1886">                                   random, amount);</span>
<span class="fc bfc" id="L1887" title="All 2 branches covered.">                if (!add) amount = -amount;</span>
<span class="fc" id="L1888">                market.addGoodsToMarket(type, amount);</span>
<span class="fc" id="L1889">                logger.finest(getName() + &quot; adjust of &quot; + amount</span>
<span class="fc" id="L1890">                              + &quot; &quot; + type</span>
<span class="fc" id="L1891">                              + &quot;, total: &quot; + market.getAmountInMarket(type)</span>
<span class="fc" id="L1892">                              + &quot;, initial: &quot; + type.getInitialAmount());</span>
<span class="fc" id="L1893">                addExtraTrade(new AbstractGoods(type, amount));</span>
            }
        }

<span class="fc" id="L1897">        flushExtraTrades(random);</span>
<span class="fc" id="L1898">        csFlushMarket(cs);</span>
<span class="fc" id="L1899">    }</span>

    /**
     * Starts a new turn for a player.
     *
     * @param random A pseudo-random number source.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csStartTurn(Random random, ChangeSet cs) {
<span class="nc" id="L1908">        Game game = getGame();</span>
<span class="nc bnc" id="L1909" title="All 2 branches missed.">        if (isEuropean()) {</span>
<span class="nc" id="L1910">            csBombardEnemyShips(random, cs);</span>

<span class="nc" id="L1912">            csYearlyGoodsAdjust(random, cs);</span>

<span class="nc" id="L1914">            FoundingFather father = checkFoundingFather();</span>
<span class="nc bnc" id="L1915" title="All 2 branches missed.">            if (father != null) {</span>
<span class="nc" id="L1916">                csAddFoundingFather(father, random, cs);</span>
<span class="nc" id="L1917">                clearOfferedFathers();</span>
            }

<span class="nc" id="L1920">            List&lt;FoundingFather&gt; ffs = getOfferedFathers();</span>
<span class="nc bnc" id="L1921" title="All 4 branches missed.">            if (canRecruitFoundingFather() &amp;&amp; ffs.isEmpty()) {</span>
<span class="nc" id="L1922">                ffs = getRandomFoundingFathers(random);</span>
<span class="nc" id="L1923">                setOfferedFathers(ffs);</span>
            }
<span class="nc bnc" id="L1925" title="All 2 branches missed.">            if (!ffs.isEmpty()) {</span>
<span class="nc" id="L1926">                cs.add(See.only(this), ChangePriority.CHANGE_EARLY,</span>
<span class="nc" id="L1927">                    new ChooseFoundingFatherMessage(ffs, null));</span>
            }

<span class="nc bnc" id="L1930" title="All 2 branches missed.">            if (updateScore()) {</span>
<span class="nc" id="L1931">                cs.addPartial(See.only(this), this, &quot;score&quot;);</span>
            }

<span class="nc bnc" id="L1934" title="All 2 branches missed.">        } else if (isIndian()) {</span>
            // We do not have to worry about Player level stance
            // changes driving Stance, as that is delegated to the AI.
            //
            // However we want to notify of individual settlements
            // that change tension level, but there are complex
            // interactions between settlement and player tensions.
            // The simple way to do it is just to save all old tension
            // levels and check if they have changed after applying
            // all the changes.
<span class="nc" id="L1944">            List&lt;IndianSettlement&gt; allSettlements = getIndianSettlements();</span>
            java.util.Map&lt;IndianSettlement,
<span class="nc" id="L1946">                java.util.Map&lt;Player, Tension.Level&gt;&gt; oldLevels = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L1947" title="All 2 branches missed.">            for (IndianSettlement settlement : allSettlements) {</span>
<span class="nc" id="L1948">                java.util.Map&lt;Player, Tension.Level&gt; oldLevel = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1949">                oldLevels.put(settlement, oldLevel);</span>
<span class="nc bnc" id="L1950" title="All 2 branches missed.">                for (Player enemy : game.getLiveEuropeanPlayers(this)) {</span>
<span class="nc" id="L1951">                    Tension alarm = settlement.getAlarm(enemy);</span>
<span class="nc" id="L1952">                    oldLevel.put(enemy,</span>
<span class="nc bnc" id="L1953" title="All 2 branches missed.">                        (alarm == null) ? null : alarm.getLevel());</span>
                }
            }

            // Do the settlement alarms first.
<span class="nc bnc" id="L1958" title="All 2 branches missed.">            for (IndianSettlement settlement : allSettlements) {</span>
<span class="nc" id="L1959">                java.util.Map&lt;Player, Integer&gt; extra = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L1960" title="All 2 branches missed.">                for (Player enemy : game.getLiveEuropeanPlayers(this)) {</span>
<span class="nc" id="L1961">                    extra.put(enemy, 0);</span>
                }

                // Look at the uses of tiles surrounding the settlement.
<span class="nc" id="L1965">                int alarmRadius = settlement.getRadius() + ALARM_RADIUS;</span>
<span class="nc bnc" id="L1966" title="All 2 branches missed.">                for (Tile tile: settlement.getTile()</span>
<span class="nc" id="L1967">                         .getSurroundingTiles(alarmRadius)) {</span>
<span class="nc" id="L1968">                    Colony colony = tile.getColony();</span>
<span class="nc bnc" id="L1969" title="All 2 branches missed.">                    if (tile.getFirstUnit() != null) { // Military units</span>
<span class="nc" id="L1970">                        Player enemy =  tile.getFirstUnit().getOwner();</span>
<span class="nc bnc" id="L1971" title="All 2 branches missed.">                        if (enemy.isEuropean()) {</span>
<span class="nc" id="L1972">                            Integer alarm = extra.get(enemy);</span>
<span class="nc bnc" id="L1973" title="All 2 branches missed.">                            if (alarm == null) continue;</span>
<span class="nc" id="L1974">                            alarm += (int)sumDouble(tile.getUnitList(),</span>
<span class="nc bnc" id="L1975" title="All 4 branches missed.">                                u -&gt; u.isOffensiveUnit() &amp;&amp; !u.isNaval(),</span>
<span class="nc" id="L1976">                                u -&gt; u.getType().getOffence());</span>
<span class="nc" id="L1977">                            extra.put(enemy, alarm);</span>
                        }
<span class="nc bnc" id="L1979" title="All 2 branches missed.">                    } else if (colony != null) { // Colonies</span>
<span class="nc" id="L1980">                        Player enemy = colony.getOwner();</span>
<span class="nc" id="L1981">                        extra.put(enemy, extra.get(enemy)</span>
<span class="nc" id="L1982">                                  + ALARM_TILE_IN_USE</span>
<span class="nc" id="L1983">                                  + colony.getUnitCount());</span>
<span class="nc bnc" id="L1984" title="All 2 branches missed.">                    } else if (tile.getOwningSettlement() != null) { // Control</span>
<span class="nc" id="L1985">                        Player enemy = tile.getOwningSettlement().getOwner();</span>
<span class="nc bnc" id="L1986" title="All 4 branches missed.">                        if (enemy != null &amp;&amp; enemy.isEuropean()) {</span>
<span class="nc" id="L1987">                            extra.put(enemy, extra.get(enemy)</span>
<span class="nc" id="L1988">                                      + ALARM_TILE_IN_USE);</span>
                        }
                    }
                }
                // Missionary helps reducing alarm a bit
<span class="nc bnc" id="L1993" title="All 2 branches missed.">                if (settlement.hasMissionary()) {</span>
<span class="nc" id="L1994">                    Unit missionary = settlement.getMissionary();</span>
<span class="nc" id="L1995">                    int missionAlarm = getGame().getSpecification()</span>
<span class="nc" id="L1996">                        .getInteger(GameOptions.MISSION_INFLUENCE);</span>
<span class="nc bnc" id="L1997" title="All 2 branches missed.">                    if (missionary.hasAbility(Ability.EXPERT_MISSIONARY)) {</span>
<span class="nc" id="L1998">                        missionAlarm *= 2;</span>
                    }
<span class="nc" id="L2000">                    Player enemy = missionary.getOwner();</span>
<span class="nc" id="L2001">                    extra.put(enemy,</span>
<span class="nc" id="L2002">                              extra.get(enemy) + missionAlarm);</span>
                }
                // Apply modifiers, and commit the total change.
<span class="nc bnc" id="L2005" title="All 2 branches missed.">                for (Entry&lt;Player, Integer&gt; entry : extra.entrySet()) {</span>
<span class="nc" id="L2006">                    Player player = entry.getKey();</span>
<span class="nc" id="L2007">                    int change = entry.getValue();</span>
<span class="nc bnc" id="L2008" title="All 2 branches missed.">                    if (change != 0) {</span>
<span class="nc" id="L2009">                        change = (int)player.applyModifiers((float)change,</span>
<span class="nc" id="L2010">                            game.getTurn(), Modifier.NATIVE_ALARM_MODIFIER);</span>
<span class="nc" id="L2011">                        ServerIndianSettlement sis</span>
<span class="nc" id="L2012">                            = (ServerIndianSettlement)settlement;</span>
<span class="nc" id="L2013">                        sis.csModifyAlarm(player, change,</span>
<span class="nc" id="L2014">                                          true, cs);//+til</span>
                    }
                }
            }

            // Calm down a bit at the whole-tribe level.
<span class="nc bnc" id="L2020" title="All 2 branches missed.">            for (Player enemy : game.getLiveEuropeanPlayers(this)) {</span>
<span class="nc bnc" id="L2021" title="All 2 branches missed.">                if (getTension(enemy).getValue() &gt; 0) {</span>
<span class="nc" id="L2022">                    int change = -getTension(enemy).getValue()/100 - 4;</span>
<span class="nc" id="L2023">                    csModifyTension(enemy, change, cs);//+til</span>
                }
            }

            // Now collect the settlements that changed.
            // Update those that changed, and add messages for selected
            // worsening relation transitions.
<span class="nc bnc" id="L2030" title="All 2 branches missed.">            for (IndianSettlement settlement : allSettlements) {</span>
<span class="nc" id="L2031">                java.util.Map&lt;Player, Tension.Level&gt; oldLevel</span>
<span class="nc" id="L2032">                    = oldLevels.get(settlement);</span>
<span class="nc bnc" id="L2033" title="All 2 branches missed.">                for (Entry&lt;Player, Tension.Level&gt; entry : oldLevel.entrySet()) {</span>
<span class="nc" id="L2034">                    Player enemy = entry.getKey();</span>
<span class="nc" id="L2035">                    Tension newTension = settlement.getAlarm(enemy);</span>
<span class="nc bnc" id="L2036" title="All 2 branches missed.">                    Tension.Level newLevel = (newTension == null) ? null</span>
<span class="nc" id="L2037">                        : newTension.getLevel();</span>
<span class="nc bnc" id="L2038" title="All 2 branches missed.">                    if (entry.getValue() == null</span>
<span class="nc bnc" id="L2039" title="All 2 branches missed.">                        || entry.getValue() == newLevel</span>
<span class="nc bnc" id="L2040" title="All 2 branches missed.">                        || !settlement.hasContacted(enemy)</span>
<span class="nc bnc" id="L2041" title="All 2 branches missed.">                        || !enemy.hasExplored(settlement.getTile()))</span>
<span class="nc" id="L2042">                        continue;</span>
<span class="nc" id="L2043">                    cs.add(See.only(null).perhaps((ServerPlayer)enemy),</span>
<span class="nc" id="L2044">                           settlement);</span>
                    // No messages about improving tension
<span class="nc bnc" id="L2046" title="All 2 branches missed.">                    if (newLevel == null</span>
<span class="nc bnc" id="L2047" title="All 2 branches missed.">                        || (entry.getValue() != null </span>
<span class="nc" id="L2048">                            &amp;&amp; entry.getValue().getLimit()</span>
<span class="nc bnc" id="L2049" title="All 2 branches missed.">                            &gt; newLevel.getLimit())) continue;</span>
<span class="nc" id="L2050">                    String key = &quot;model.player.alarmIncrease.&quot;</span>
<span class="nc" id="L2051">                        + settlement.getAlarm(enemy).getKey();</span>
<span class="nc bnc" id="L2052" title="All 2 branches missed.">                    if (!Messages.containsKey(key)) continue;</span>
<span class="nc" id="L2053">                    cs.addMessage(See.only((ServerPlayer)enemy),</span>
<span class="nc" id="L2054">                        new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,</span>
<span class="nc" id="L2055">                                         key, settlement)</span>
<span class="nc" id="L2056">                            .addStringTemplate(&quot;%nation%&quot;, getNationLabel())</span>
<span class="nc" id="L2057">                            .addStringTemplate(&quot;%enemy%&quot;, enemy.getNationLabel())</span>
<span class="nc" id="L2058">                            .addName(&quot;%settlement%&quot;, settlement.getName()));</span>
                }
            }

<span class="nc bnc" id="L2062" title="All 2 branches missed.">            for (IndianSettlement settlement : allSettlements) {</span>
<span class="nc" id="L2063">                ((ServerIndianSettlement)settlement).csStartTurn(random, cs);</span>
            }
        }
<span class="nc" id="L2066">    }</span>

    /**
     * All player colonies bombard all available targets.
     *
     * @param random A random number source.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csBombardEnemyShips(Random random, ChangeSet cs) {
<span class="nc bnc" id="L2075" title="All 2 branches missed.">        for (Colony colony : getColonies()) {</span>
<span class="nc bnc" id="L2076" title="All 2 branches missed.">            if (colony.canBombardEnemyShip()) {</span>
<span class="nc bnc" id="L2077" title="All 2 branches missed.">                for (Tile tile : colony.getTile().getSurroundingTiles(1)) {</span>
<span class="nc bnc" id="L2078" title="All 4 branches missed.">                    if (!tile.isLand() &amp;&amp; tile.getFirstUnit() != null</span>
<span class="nc bnc" id="L2079" title="All 2 branches missed.">                        &amp;&amp; tile.getFirstUnit().getOwner() != this) {</span>
<span class="nc bnc" id="L2080" title="All 2 branches missed.">                        for (Unit unit : tile.getUnitList()) {</span>
<span class="nc bnc" id="L2081" title="All 2 branches missed.">                            if (atWarWith(unit.getOwner())</span>
<span class="nc bnc" id="L2082" title="All 2 branches missed.">                                || unit.hasAbility(Ability.PIRACY)) {</span>
<span class="nc" id="L2083">                                csCombat(colony, unit, null, random, cs);</span>
                            }
                        }
                    }
                }
            }
        }
<span class="nc" id="L2090">    }</span>

    /**
     * Adds a founding father to a players continental congress.
     *
     * @param father The &lt;code&gt;FoundingFather&lt;/code&gt; to add.
     * @param random A pseudo-random number source.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csAddFoundingFather(FoundingFather father, Random random,
                                    ChangeSet cs) {
<span class="fc" id="L2101">        final Game game = getGame();</span>
<span class="fc" id="L2102">        final Specification spec = game.getSpecification();</span>
<span class="fc" id="L2103">        final ServerEurope europe = (ServerEurope)getEurope();</span>
<span class="fc" id="L2104">        final Turn turn = game.getTurn();</span>
<span class="fc" id="L2105">        boolean europeDirty = false, visibilityChange = false;</span>

<span class="fc" id="L2107">        addFather(father);</span>
<span class="fc" id="L2108">        addHistory(new HistoryEvent(turn,</span>
<span class="fc" id="L2109">                HistoryEvent.HistoryEventType.FOUNDING_FATHER, this)</span>
<span class="fc" id="L2110">                    .addNamed(&quot;%father%&quot;, father));</span>
        // FIXME: We do not want to have to update the whole player
        // just to get the FF into the client, but for now if there
        // are modifiers that is the only way to do it.
<span class="fc" id="L2114">        cs.add(See.only(this), this);</span>
<span class="fc" id="L2115">        cs.addMessage(See.only(this),</span>
<span class="fc" id="L2116">            new ModelMessage(ModelMessage.MessageType.SONS_OF_LIBERTY,</span>
<span class="fc" id="L2117">                             &quot;model.player.foundingFatherJoinedCongress&quot;,</span>
<span class="fc" id="L2118">                             this)</span>
<span class="fc" id="L2119">                      .addNamed(&quot;%foundingFather%&quot;, father)</span>
<span class="fc" id="L2120">                      .add(&quot;%description%&quot;, father.getDescriptionKey()));</span>

<span class="fc" id="L2122">        List&lt;AbstractUnit&gt; units = father.getUnits();</span>
<span class="pc bpc" id="L2123" title="2 of 6 branches missed.">        if (units != null &amp;&amp; !units.isEmpty() &amp;&amp; europe != null) {</span>
<span class="fc" id="L2124">            createUnits(father.getUnits(), europe);//-vis: safe, Europe</span>
<span class="fc" id="L2125">            europeDirty = true;</span>
        }

<span class="fc" id="L2128">        java.util.Map&lt;UnitType, UnitType&gt; upgrades = father.getUpgrades();</span>
<span class="pc bpc" id="L2129" title="1 of 2 branches missed.">        if (upgrades != null) {</span>
<span class="fc bfc" id="L2130" title="All 2 branches covered.">            for (Unit u : getUnits()) {</span>
<span class="fc" id="L2131">                UnitType newType = upgrades.get(u.getType());</span>
<span class="fc bfc" id="L2132" title="All 2 branches covered.">                if (newType != null) {</span>
<span class="fc" id="L2133">                    u.changeType(newType);//-vis(this)</span>
<span class="fc" id="L2134">                    visibilityChange = true;</span>
<span class="fc" id="L2135">                    cs.add(See.perhaps(), u);</span>
                }
            }
        }

        // Some modifiers are special
<span class="fc bfc" id="L2141" title="All 2 branches covered.">        for (Modifier m : father.getModifiers()) {</span>
<span class="pc bpc" id="L2142" title="1 of 2 branches missed.">            if (Modifier.LINE_OF_SIGHT_BONUS.equals(m.getId())) {</span>
                // Check for tiles that are now visible.  They need to be
                // explored, and always updated so that units are visible.
                // *Requires that canSee[] has **not** been updated yet!*
<span class="nc" id="L2146">                Set&lt;Tile&gt; tiles = new HashSet&lt;&gt;();</span>
                int los;
<span class="nc bnc" id="L2148" title="All 4 branches missed.">                for (Colony c : (hasAbility(Ability.SEE_ALL_COLONIES))</span>
<span class="nc" id="L2149">                         ? getGame().getAllColonies(null)</span>
<span class="nc" id="L2150">                         : getColonies()) {</span>
<span class="nc" id="L2151">                    los = c.getLineOfSight();</span>
<span class="nc bnc" id="L2152" title="All 2 branches missed.">                    for (Tile t : c.getTile().getSurroundingTiles(1, los)) {</span>
<span class="nc bnc" id="L2153" title="All 2 branches missed.">                        if (!canSee(t)) tiles.add(t);</span>
                    }
                }
<span class="nc bnc" id="L2156" title="All 2 branches missed.">                for (Unit u : getUnits()) {</span>
<span class="nc bnc" id="L2157" title="All 2 branches missed.">                    if (!u.hasTile()) continue;</span>
<span class="nc" id="L2158">                    los = u.getLineOfSight();</span>
<span class="nc bnc" id="L2159" title="All 2 branches missed.">                    for (Tile t : u.getTile().getSurroundingTiles(1, los)) {</span>
<span class="nc bnc" id="L2160" title="All 2 branches missed.">                        if (!canSee(t)) tiles.add(t);</span>
                    }
                }
<span class="nc" id="L2163">                exploreTiles(tiles); // Explore the new tiles</span>
<span class="nc" id="L2164">                cs.add(See.only(this), tiles);</span>
<span class="nc" id="L2165">                visibilityChange = true;</span>
<span class="pc bpc" id="L2166" title="1 of 2 branches missed.">            } else if (Modifier.SOL.equals(m.getId())) {</span>
<span class="nc bnc" id="L2167" title="All 2 branches missed.">                for (Colony c : getColonies()) {</span>
<span class="nc" id="L2168">                    c.addLiberty(0); // Kick the SoL and production bonus</span>
<span class="nc" id="L2169">                    c.invalidateCache();</span>
                }
            }
        }

        // Some events are special
<span class="fc bfc" id="L2175" title="All 2 branches covered.">        for (Event event : father.getEvents()) {</span>
<span class="fc" id="L2176">            String eventId = event.getId();</span>
<span class="fc bfc" id="L2177" title="All 2 branches covered.">            if (&quot;model.event.resetBannedMissions&quot;.equals(eventId)) {</span>
<span class="fc bfc" id="L2178" title="All 2 branches covered.">                for (Player p : game.getLiveNativePlayers(null)) {</span>
<span class="pc bpc" id="L2179" title="1 of 2 branches missed.">                    if (p.missionsBanned(this)) {</span>
<span class="nc" id="L2180">                        p.removeMissionBan(this);</span>
<span class="nc" id="L2181">                        cs.add(See.only(this), p);</span>
                    }
                }

<span class="fc bfc" id="L2185" title="All 2 branches covered.">            } else if (&quot;model.event.resetNativeAlarm&quot;.equals(eventId)) {</span>
<span class="fc bfc" id="L2186" title="All 2 branches covered.">                for (Player p : game.getLiveNativePlayers(null)) {</span>
<span class="fc bfc" id="L2187" title="All 2 branches covered.">                    if (!p.hasContacted(this)) continue;</span>
<span class="fc" id="L2188">                    p.setTension(this, new Tension(Tension.TENSION_MIN));</span>
<span class="fc bfc" id="L2189" title="All 2 branches covered.">                    for (IndianSettlement is : p.getIndianSettlements()) {</span>
<span class="pc bpc" id="L2190" title="1 of 2 branches missed.">                        if (is.hasContacted(this)) {</span>
<span class="fc" id="L2191">                            is.getTile().cacheUnseen();//+til</span>
<span class="fc" id="L2192">                            is.setAlarm(this,</span>
<span class="fc" id="L2193">                                new Tension(Tension.TENSION_MIN));//-til</span>
<span class="fc" id="L2194">                            cs.add(See.only(this), is);</span>
                        }
                    }
<span class="fc" id="L2197">                    csChangeStance(Stance.PEACE, (ServerPlayer)p, true, cs);</span>
                }

<span class="pc bpc" id="L2200" title="1 of 2 branches missed.">            } else if (&quot;model.event.boycottsLifted&quot;.equals(eventId)) {</span>
<span class="nc" id="L2201">                Market market = getMarket();</span>
<span class="nc bnc" id="L2202" title="All 2 branches missed.">                for (GoodsType goodsType : spec.getGoodsTypeList()) {</span>
<span class="nc bnc" id="L2203" title="All 2 branches missed.">                    if (market.getArrears(goodsType) &gt; 0) {</span>
<span class="nc" id="L2204">                        market.setArrears(goodsType, 0);</span>
<span class="nc" id="L2205">                        cs.add(See.only(this), market.getMarketData(goodsType));</span>
                    }
                }

<span class="pc bpc" id="L2209" title="1 of 2 branches missed.">            } else if (&quot;model.event.freeBuilding&quot;.equals(eventId)) {</span>
<span class="fc" id="L2210">                BuildingType type = spec.getBuildingType(event.getValue());</span>
<span class="fc bfc" id="L2211" title="All 2 branches covered.">                for (Colony colony : getColonies()) {</span>
<span class="fc" id="L2212">                    ((ServerColony)colony).csFreeBuilding(type, cs);</span>
                }

<span class="pc bnc" id="L2215" title="All 2 branches missed.">            } else if (&quot;model.event.seeAllColonies&quot;.equals(eventId)) {</span>
<span class="nc" id="L2216">                visibilityChange = true;//-vis(this), can now see other colonies</span>
<span class="nc bnc" id="L2217" title="All 2 branches missed.">                for (Tile t : game.getMap().getAllTiles()) {</span>
<span class="nc" id="L2218">                    Colony colony = t.getColony();</span>
<span class="nc bnc" id="L2219" title="All 2 branches missed.">                    if (colony == null) continue;</span>
<span class="nc" id="L2220">                    Set&lt;Tile&gt; tiles = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L2221" title="All 2 branches missed.">                    if (exploreTile(t)) {</span>
<span class="nc bnc" id="L2222" title="All 2 branches missed.">                        if (!hasAbility(Ability.SEE_ALL_COLONIES)) {</span>
                            // FreeCol ruleset adds this ability
                            // allowing full visibility of colony,
                            // whereas Col1 showed colonies as size 1.
<span class="nc" id="L2226">                            Tile c = t.copy(game, Tile.class);</span>
<span class="nc" id="L2227">                            c.getColony().setDisplayUnitCount(1);</span>
<span class="nc" id="L2228">                            t.setCachedTile(this, c);</span>
                        }
<span class="nc" id="L2230">                        tiles.add(t);</span>
                    }
                    // Revealed tiles in 11x11 block in Col1
<span class="nc" id="L2233">                    final int fullRadius = (int)father</span>
<span class="nc" id="L2234">                        .applyModifiers((float)colony.getLineOfSight(),</span>
<span class="nc" id="L2235">                                        turn, Modifier.EXPOSED_TILES_RADIUS);</span>
<span class="nc" id="L2236">                    tiles.addAll(exploreTiles(t.getSurroundingTiles(1,</span>
<span class="nc" id="L2237">                                fullRadius)));</span>
<span class="nc" id="L2238">                    cs.add(See.only(this), tiles);</span>
                }

<span class="nc bnc" id="L2241" title="All 2 branches missed.">            } else if (&quot;model.event.newRecruits&quot;.equals(eventId)</span>
<span class="nc bnc" id="L2242" title="All 2 branches missed.">                       &amp;&amp; europe != null) {</span>
<span class="nc" id="L2243">                europeDirty = europe.replaceRecruits(random);</span>

<span class="nc bnc" id="L2245" title="All 2 branches missed.">            } else if (&quot;model.event.movementChange&quot;.equals(eventId)) {</span>
<span class="nc bnc" id="L2246" title="All 2 branches missed.">                for (Unit u : getUnits()) {</span>
<span class="nc bnc" id="L2247" title="All 2 branches missed.">                    if (u.getMovesLeft() &gt; 0) {</span>
<span class="nc" id="L2248">                        u.setMovesLeft(u.getInitialMovesLeft());</span>
<span class="nc" id="L2249">                        cs.addPartial(See.only(this), u, &quot;movesLeft&quot;);</span>
                    }
                }
            }
        }

<span class="fc bfc" id="L2255" title="All 2 branches covered.">        if (europeDirty) cs.add(See.only(this), europe);</span>
<span class="fc bfc" id="L2256" title="All 2 branches covered.">        if (visibilityChange) invalidateCanSeeTiles(); //+vis(this)</span>
<span class="fc" id="L2257">    }</span>

    /**
     * Get a list of free building types this player has access to
     * through its choice of founding fathers.  Used to upgrade newly
     * captured colonies.
     *
     * @return A list of free &lt;code&gt;BuildingType&lt;/code&gt;s.
     */
    public List&lt;BuildingType&gt; getFreeBuildingTypes() {
<span class="fc" id="L2267">        final Specification spec = getGame().getSpecification();</span>
<span class="fc" id="L2268">        List&lt;BuildingType&gt; result = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L2269" title="1 of 2 branches missed.">        for (FoundingFather ff : getFathers()) {</span>
<span class="nc bnc" id="L2270" title="All 2 branches missed.">            for (Event event : ff.getEvents()) {</span>
<span class="nc" id="L2271">                String eventId = event.getId();</span>
<span class="nc bnc" id="L2272" title="All 2 branches missed.">                if (&quot;model.event.freeBuilding&quot;.equals(eventId)) {</span>
<span class="nc" id="L2273">                    result.add(spec.getBuildingType(event.getValue()));</span>
                }
            }
        }
<span class="fc" id="L2277">        return result;</span>
    }

    /**
     * Claim land.
     *
     * @param tile The &lt;code&gt;Tile&lt;/code&gt; to claim.
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; to claim for.
     * @param price The price to pay for the land, which must agree
     *     with the owner valuation, unless negative which denotes stealing.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csClaimLand(Tile tile, Settlement settlement, int price,
                            ChangeSet cs) {
<span class="fc" id="L2291">        ServerPlayer owner = (ServerPlayer)tile.getOwner();</span>
<span class="fc" id="L2292">        Settlement ownerSettlement = tile.getOwningSettlement();</span>
<span class="fc" id="L2293">        tile.cacheUnseen();//+til</span>
<span class="fc" id="L2294">        tile.changeOwnership(this, settlement);//-vis(?),-til</span>

        // Update the tile and any now-angrier owners, and the player
        // gold if a price was paid.
<span class="fc" id="L2298">        cs.add(See.perhaps(), tile);</span>
<span class="pc bpc" id="L2299" title="1 of 2 branches missed.">        if (price &gt; 0) {</span>
<span class="nc" id="L2300">            modifyGold(-price);</span>
<span class="nc" id="L2301">            owner.modifyGold(price);</span>
<span class="nc" id="L2302">            cs.addPartial(See.only(this), this, &quot;gold&quot;);</span>
<span class="pc bpc" id="L2303" title="2 of 4 branches missed.">        } else if (price &lt; 0 &amp;&amp; owner.isIndian()) {</span>
<span class="fc" id="L2304">            ServerIndianSettlement is = (ServerIndianSettlement)ownerSettlement;</span>
<span class="pc bpc" id="L2305" title="1 of 2 branches missed.">            if (is == null) {</span>
<span class="nc" id="L2306">                owner.csModifyTension(this, Tension.TENSION_ADD_LAND_TAKEN,</span>
<span class="nc" id="L2307">                                      cs);</span>
<span class="nc" id="L2308">            } else {</span>
<span class="fc" id="L2309">                is.csModifyAlarm(this, Tension.TENSION_ADD_LAND_TAKEN,</span>
<span class="fc" id="L2310">                                 true, cs);</span>
            }
        }
<span class="fc" id="L2313">        logger.finest(this.getName() + &quot; claimed &quot; + tile</span>
<span class="pc bpc" id="L2314" title="1 of 2 branches missed.">            + &quot; from &quot; + ((owner == null) ? &quot;no-one&quot; : owner.getName())</span>
<span class="pc bpc" id="L2315" title="2 of 4 branches missed.">            + &quot;, price: &quot; + ((price == 0) ? &quot;free&quot; : (price &lt; 0) ? &quot;stolen&quot;</span>
<span class="pc" id="L2316">                : price));</span>
<span class="fc" id="L2317">    }</span>


    /**
     * A unit migrates from Europe.
     *
     * @param slot The slot within &lt;code&gt;Europe&lt;/code&gt; to select the unit from.
     * @param type The type of migration occurring.
     * @param random A pseudo-random number source.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csEmigrate(int slot, MigrationType type, Random random,
                           ChangeSet cs) {
        // Create the recruit, move it to the docks.
<span class="fc" id="L2331">        ServerEurope europe = (ServerEurope)getEurope();</span>
<span class="fc" id="L2332">        UnitType recruitType = europe.extractRecruitable(slot, random);</span>
<span class="fc" id="L2333">        final Game game = getGame();</span>
<span class="fc" id="L2334">        final Specification spec = game.getSpecification();</span>
<span class="pc bpc" id="L2335" title="1 of 2 branches missed.">        Role role = (spec.getBoolean(GameOptions.EQUIP_EUROPEAN_RECRUITS))</span>
<span class="fc" id="L2336">            ? recruitType.getDefaultRole()</span>
<span class="nc" id="L2337">            : spec.getDefaultRole();</span>
<span class="fc" id="L2338">        Unit unit = new ServerUnit(game, europe, this,</span>
<span class="fc" id="L2339">                                   recruitType, role);//-vis: safe/Europe</span>

        // Handle migration type specific changes.
<span class="pc bpc" id="L2342" title="4 of 5 branches missed.">        switch (type) {</span>
        case FOUNTAIN:
<span class="nc" id="L2344">            setRemainingEmigrants(getRemainingEmigrants() - 1);</span>
<span class="nc" id="L2345">            break;</span>
        case RECRUIT:
<span class="nc" id="L2347">            modifyGold(-europe.getRecruitPrice());</span>
<span class="nc" id="L2348">            cs.addPartial(See.only(this), this, &quot;gold&quot;);</span>
<span class="nc" id="L2349">            europe.increaseRecruitmentDifficulty();</span>
            // Fall through
        case NORMAL:
<span class="fc" id="L2352">            reduceImmigration();</span>
<span class="fc" id="L2353">            updateImmigrationRequired();</span>
<span class="fc" id="L2354">            cs.addPartial(See.only(this), this,</span>
<span class="fc" id="L2355">                          &quot;immigration&quot;, &quot;immigrationRequired&quot;);</span>
<span class="pc bpc" id="L2356" title="1 of 2 branches missed.">            if (!MigrationType.specificMigrantSlot(slot)) {</span>
<span class="fc" id="L2357">                cs.addMessage(See.only(this), getEmigrationMessage(unit));</span>
            }
<span class="fc" id="L2359">            break;</span>
        case SURVIVAL:
            // Add an informative message if this was a survival recruitment,
<span class="nc" id="L2362">            cs.addMessage(See.only(this),</span>
<span class="nc" id="L2363">                new ModelMessage(ModelMessage.MessageType.UNIT_ADDED,</span>
<span class="nc" id="L2364">                                 &quot;model.player.autoRecruit&quot;,</span>
<span class="nc" id="L2365">                                 this, unit)</span>
<span class="nc" id="L2366">                    .addNamed(&quot;%europe%&quot;, europe)</span>
<span class="nc" id="L2367">                    .addStringTemplate(&quot;%unit%&quot;, unit.getLabel()));</span>
<span class="nc" id="L2368">            break;</span>
        default:
<span class="nc" id="L2370">            throw new IllegalArgumentException(&quot;Bogus migration type&quot;);</span>
        }
<span class="fc" id="L2372">        cs.add(See.only(this), europe);</span>
<span class="fc" id="L2373">    }</span>

    /**
     * Combat.
     *
     * @param attacker The &lt;code&gt;FreeColGameObject&lt;/code&gt; that is attacking.
     * @param defender The &lt;code&gt;FreeColGameObject&lt;/code&gt; that is defending.
     * @param crs A list of &lt;code&gt;CombatResult&lt;/code&gt;s defining the result.
     * @param random A pseudo-random number source.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csCombat(FreeColGameObject attacker,
                         FreeColGameObject defender,
                         List&lt;CombatResult&gt; crs,
                         Random random,
                         ChangeSet cs) throws IllegalStateException {
<span class="fc" id="L2389">        CombatModel combatModel = getGame().getCombatModel();</span>
<span class="fc" id="L2390">        boolean isAttack = combatModel.combatIsAttack(attacker, defender);</span>
<span class="fc" id="L2391">        boolean isBombard = combatModel.combatIsBombard(attacker, defender);</span>
<span class="fc" id="L2392">        Unit attackerUnit = null;</span>
<span class="fc" id="L2393">        Settlement attackerSettlement = null;</span>
<span class="fc" id="L2394">        Tile attackerTile = null;</span>
<span class="fc" id="L2395">        Unit defenderUnit = null;</span>
        //ServerPlayer attackerPlayer = null;
<span class="fc" id="L2397">        ServerPlayer defenderPlayer = null;</span>
<span class="fc" id="L2398">        Tile defenderTile = null;</span>
<span class="pc bpc" id="L2399" title="1 of 2 branches missed.">        if (isAttack) {</span>
<span class="fc" id="L2400">            attackerUnit = (Unit)attacker;</span>
            //attackerPlayer = (ServerPlayer)attackerUnit.getOwner();
<span class="fc" id="L2402">            attackerTile = attackerUnit.getTile();</span>
<span class="fc" id="L2403">            defenderUnit = (Unit)defender;</span>
<span class="fc" id="L2404">            defenderPlayer = (ServerPlayer)defenderUnit.getOwner();</span>
<span class="fc" id="L2405">            defenderTile = defenderUnit.getTile();</span>
<span class="fc" id="L2406">            boolean bombard = attackerUnit.hasAbility(Ability.BOMBARD);</span>
<span class="fc" id="L2407">            cs.addAttribute(See.only(this), &quot;sound&quot;,</span>
<span class="fc bfc" id="L2408" title="All 2 branches covered.">                (attackerUnit.isNaval()) ? &quot;sound.attack.naval&quot;</span>
<span class="fc bfc" id="L2409" title="All 2 branches covered.">                : (bombard) ? &quot;sound.attack.artillery&quot;</span>
<span class="fc bfc" id="L2410" title="All 2 branches covered.">                : (attackerUnit.isMounted()) ? &quot;sound.attack.mounted&quot;</span>
<span class="fc" id="L2411">                : &quot;sound.attack.foot&quot;);</span>
<span class="fc bfc" id="L2412" title="All 2 branches covered.">            if (attackerUnit.getOwner().isIndian()</span>
<span class="pc bpc" id="L2413" title="1 of 2 branches missed.">                &amp;&amp; defenderPlayer.isEuropean()</span>
<span class="pc bpc" id="L2414" title="1 of 2 branches missed.">                &amp;&amp; defenderUnit.getLocation().getColony() != null</span>
<span class="pc bpc" id="L2415" title="1 of 2 branches missed.">                &amp;&amp; !defenderPlayer.atWarWith(attackerUnit.getOwner())) {</span>
<span class="nc" id="L2416">                StringTemplate attackerNation</span>
<span class="nc" id="L2417">                    = attackerUnit.getApparentOwnerName();</span>
<span class="nc" id="L2418">                Colony colony = defenderUnit.getLocation().getColony();</span>
<span class="nc" id="L2419">                cs.addMessage(See.only(defenderPlayer),</span>
<span class="nc" id="L2420">                    new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="nc" id="L2421">                                     &quot;combat.raid.ours&quot;, colony)</span>
<span class="nc" id="L2422">                        .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="nc" id="L2423">                        .addStringTemplate(&quot;%nation%&quot;, attackerNation));</span>
            }
<span class="nc bnc" id="L2425" title="All 2 branches missed.">        } else if (isBombard) {</span>
<span class="nc" id="L2426">            attackerSettlement = (Settlement)attacker;</span>
            //attackerPlayer = (ServerPlayer)attackerSettlement.getOwner();
<span class="nc" id="L2428">            attackerTile = attackerSettlement.getTile();</span>
<span class="nc" id="L2429">            defenderUnit = (Unit)defender;</span>
<span class="nc" id="L2430">            defenderPlayer = (ServerPlayer)defenderUnit.getOwner();</span>
<span class="nc" id="L2431">            defenderTile = defenderUnit.getTile();</span>
<span class="nc" id="L2432">            cs.addAttribute(See.only(this), &quot;sound&quot;, &quot;sound.attack.bombard&quot;);</span>
<span class="nc" id="L2433">        } else {</span>
<span class="nc" id="L2434">            throw new IllegalStateException(&quot;Bogus combat&quot;);</span>
        }
<span class="pc bpc" id="L2436" title="3 of 4 branches missed.">        assert defenderTile != null;</span>

        // If the combat results were not specified (usually the case),
        // query the combat model.
<span class="pc bpc" id="L2440" title="1 of 2 branches missed.">        if (crs == null) {</span>
<span class="nc" id="L2441">            crs = combatModel.generateAttackResult(random, attacker, defender);</span>
        }
<span class="pc bpc" id="L2443" title="1 of 2 branches missed.">        if (crs.isEmpty()) {</span>
<span class="nc" id="L2444">            throw new IllegalStateException(&quot;empty attack result&quot;);</span>
        }
        // Extract main result, insisting it is one of the fundamental cases,
        // and add the animation.
        // Set vis so that loser always sees things.
        // FIXME: Bombard animations
        See vis; // Visibility that insists on the loser seeing the result.
<span class="fc" id="L2451">        CombatResult result = crs.remove(0);</span>
<span class="pc bpc" id="L2452" title="2 of 4 branches missed.">        switch (result) {</span>
        case NO_RESULT:
<span class="nc" id="L2454">            vis = See.perhaps();</span>
<span class="nc" id="L2455">            break; // Do not animate if there is no result.</span>
        case WIN:
<span class="fc" id="L2457">            vis = See.perhaps().always(defenderPlayer);</span>
<span class="pc bpc" id="L2458" title="1 of 2 branches missed.">            if (isAttack) {</span>
<span class="pc bpc" id="L2459" title="1 of 2 branches missed.">                if (attackerTile == null</span>
<span class="pc bpc" id="L2460" title="1 of 2 branches missed.">                    || attackerTile == defenderTile</span>
<span class="pc bpc" id="L2461" title="1 of 2 branches missed.">                    || !attackerTile.isAdjacent(defenderTile)) {</span>
<span class="nc" id="L2462">                    logger.warning(&quot;Bogus attack from &quot; + attackerTile</span>
<span class="nc" id="L2463">                        + &quot; to &quot; + defenderTile</span>
<span class="nc" id="L2464">                        + &quot;\n&quot; + FreeColDebugger.stackTraceToString());</span>
<span class="nc" id="L2465">                } else {</span>
<span class="fc" id="L2466">                    cs.addAttack(vis, attackerUnit, defenderUnit, true);</span>
                }
            }
<span class="fc" id="L2469">            break;</span>
        case LOSE:
<span class="fc" id="L2471">            vis = See.perhaps().always(this);</span>
<span class="pc bpc" id="L2472" title="1 of 2 branches missed.">            if (isAttack) {</span>
<span class="pc bpc" id="L2473" title="1 of 2 branches missed.">                if (attackerTile == null</span>
<span class="pc bpc" id="L2474" title="1 of 2 branches missed.">                    || attackerTile == defenderTile</span>
<span class="pc bpc" id="L2475" title="1 of 2 branches missed.">                    || !attackerTile.isAdjacent(defenderTile)) {</span>
<span class="nc" id="L2476">                    logger.warning(&quot;Bogus attack from &quot; + attackerTile</span>
<span class="nc" id="L2477">                        + &quot; to &quot; + defenderTile</span>
<span class="nc" id="L2478">                        + &quot;\n&quot; + FreeColDebugger.stackTraceToString());</span>
<span class="nc" id="L2479">                } else {</span>
<span class="fc" id="L2480">                    cs.addAttack(vis, attackerUnit, defenderUnit, false);</span>
                }
            }
<span class="fc" id="L2483">            break;</span>
        default:
<span class="nc" id="L2485">            throw new IllegalStateException(&quot;generateAttackResult returned: &quot;</span>
<span class="nc" id="L2486">                                            + result);</span>
        }
        // Now process the details.
<span class="fc" id="L2489">        boolean attackerTileDirty = false;</span>
<span class="fc" id="L2490">        boolean defenderTileDirty = false;</span>
<span class="fc" id="L2491">        boolean moveAttacker = false;</span>
<span class="fc" id="L2492">        boolean burnedNativeCapital = false;</span>
<span class="fc" id="L2493">        Settlement settlement = defenderTile.getSettlement();</span>
<span class="fc" id="L2494">        Colony colony = defenderTile.getColony();</span>
<span class="fc bfc" id="L2495" title="All 2 branches covered.">        IndianSettlement natives = (settlement instanceof IndianSettlement)</span>
<span class="fc" id="L2496">            ? (IndianSettlement) settlement</span>
<span class="fc" id="L2497">            : null;</span>
<span class="fc" id="L2498">        int attackerTension = 0;</span>
<span class="fc" id="L2499">        int defenderTension = 0;</span>
<span class="fc bfc" id="L2500" title="All 2 branches covered.">        for (CombatResult cr : crs) {</span>
            boolean ok;
<span class="pc bpc" id="L2502" title="11 of 25 branches missed.">            switch (cr) {</span>
            case AUTOEQUIP_UNIT:
<span class="pc bpc" id="L2504" title="2 of 4 branches missed.">                ok = isAttack &amp;&amp; settlement != null;</span>
<span class="pc bpc" id="L2505" title="1 of 2 branches missed.">                if (ok) {</span>
<span class="fc" id="L2506">                    csAutoequipUnit(defenderUnit, settlement, cs);</span>
                }
<span class="fc" id="L2508">                break;</span>
            case BURN_MISSIONS:
<span class="nc bnc" id="L2510" title="All 4 branches missed.">                ok = isAttack &amp;&amp; result == CombatResult.WIN</span>
<span class="nc bnc" id="L2511" title="All 2 branches missed.">                    &amp;&amp; natives != null</span>
<span class="nc bnc" id="L2512" title="All 4 branches missed.">                    &amp;&amp; isEuropean() &amp;&amp; defenderPlayer.isIndian();</span>
<span class="nc bnc" id="L2513" title="All 2 branches missed.">                if (ok) {</span>
<span class="nc" id="L2514">                    defenderTileDirty |= natives.hasMissionary(this);</span>
<span class="nc" id="L2515">                    csBurnMissions(attackerUnit, natives, cs);</span>
                }
<span class="nc" id="L2517">                break;</span>
            case CAPTURE_AUTOEQUIP:
<span class="nc bnc" id="L2519" title="All 4 branches missed.">                ok = isAttack &amp;&amp; result == CombatResult.WIN</span>
<span class="nc bnc" id="L2520" title="All 2 branches missed.">                    &amp;&amp; settlement != null;</span>
<span class="nc bnc" id="L2521" title="All 2 branches missed.">                if (ok) {</span>
<span class="nc" id="L2522">                    csCaptureAutoEquip(attackerUnit, defenderUnit, cs);</span>
<span class="nc" id="L2523">                    attackerTileDirty = defenderTileDirty = true;</span>
                }
<span class="nc" id="L2525">                break;</span>
            case CAPTURE_COLONY:
<span class="pc bpc" id="L2527" title="2 of 4 branches missed.">                ok = isAttack &amp;&amp; result == CombatResult.WIN</span>
<span class="pc bpc" id="L2528" title="1 of 2 branches missed.">                    &amp;&amp; colony != null</span>
<span class="pc bpc" id="L2529" title="2 of 4 branches missed.">                    &amp;&amp; isEuropean() &amp;&amp; defenderPlayer.isEuropean();</span>
<span class="pc bpc" id="L2530" title="1 of 2 branches missed.">                if (ok) {</span>
<span class="fc" id="L2531">                    csCaptureColony(attackerUnit, (ServerColony)colony,</span>
<span class="fc" id="L2532">                                    random, cs);</span>
<span class="fc" id="L2533">                    attackerTileDirty = defenderTileDirty = false;</span>
<span class="fc" id="L2534">                    moveAttacker = true;</span>
<span class="fc" id="L2535">                    defenderTension += Tension.TENSION_ADD_MAJOR;</span>
                }
<span class="fc" id="L2537">                break;</span>
            case CAPTURE_CONVERT:
<span class="pc bpc" id="L2539" title="2 of 4 branches missed.">                ok = isAttack &amp;&amp; result == CombatResult.WIN</span>
<span class="pc bpc" id="L2540" title="1 of 2 branches missed.">                    &amp;&amp; natives != null</span>
<span class="pc bpc" id="L2541" title="2 of 4 branches missed.">                    &amp;&amp; isEuropean() &amp;&amp; defenderPlayer.isIndian();</span>
<span class="pc bpc" id="L2542" title="1 of 2 branches missed.">                if (ok) {</span>
<span class="fc" id="L2543">                    csCaptureConvert(attackerUnit, natives, random, cs);</span>
<span class="fc" id="L2544">                    attackerTileDirty = true;</span>
                }
<span class="fc" id="L2546">                break;</span>
            case CAPTURE_EQUIP:
<span class="pc bpc" id="L2548" title="2 of 4 branches missed.">                ok = isAttack &amp;&amp; result != CombatResult.NO_RESULT;</span>
<span class="pc bpc" id="L2549" title="1 of 2 branches missed.">                if (ok) {</span>
<span class="pc bpc" id="L2550" title="1 of 2 branches missed.">                    if (result == CombatResult.WIN) {</span>
<span class="nc" id="L2551">                        csCaptureEquip(attackerUnit, defenderUnit, cs);</span>
<span class="nc" id="L2552">                    } else {</span>
<span class="fc" id="L2553">                        csCaptureEquip(defenderUnit, attackerUnit, cs);</span>
                    }
<span class="fc" id="L2555">                    attackerTileDirty = defenderTileDirty = true;</span>
                }
<span class="fc" id="L2557">                break;</span>
            case CAPTURE_UNIT:
<span class="pc bpc" id="L2559" title="2 of 4 branches missed.">                ok = isAttack &amp;&amp; result != CombatResult.NO_RESULT;</span>
<span class="pc bpc" id="L2560" title="1 of 2 branches missed.">                if (ok) {</span>
<span class="fc bfc" id="L2561" title="All 2 branches covered.">                    if (result == CombatResult.WIN) {</span>
<span class="fc" id="L2562">                        csCaptureUnit(attackerUnit, defenderUnit, cs);</span>
<span class="fc" id="L2563">                    } else {</span>
<span class="fc" id="L2564">                        csCaptureUnit(defenderUnit, attackerUnit, cs);</span>
                    }
<span class="fc" id="L2566">                    attackerTileDirty = true;</span>
<span class="fc" id="L2567">                    defenderTileDirty = false; // Added in csCaptureUnit</span>
                }
<span class="fc" id="L2569">                break;</span>
            case DAMAGE_COLONY_SHIPS:
<span class="nc bnc" id="L2571" title="All 4 branches missed.">                ok = isAttack &amp;&amp; result == CombatResult.WIN</span>
<span class="nc bnc" id="L2572" title="All 2 branches missed.">                    &amp;&amp; colony != null;</span>
<span class="nc bnc" id="L2573" title="All 2 branches missed.">                if (ok) {</span>
<span class="nc" id="L2574">                    csDamageColonyShips(attackerUnit, colony, cs);</span>
<span class="nc" id="L2575">                    defenderTileDirty = true;</span>
                }
<span class="nc" id="L2577">                break;</span>
            case DAMAGE_SHIP_ATTACK:
<span class="pc bpc" id="L2579" title="2 of 4 branches missed.">                ok = isAttack &amp;&amp; result != CombatResult.NO_RESULT</span>
<span class="pc bpc" id="L2580" title="1 of 2 branches missed.">                    &amp;&amp; ((result == CombatResult.WIN) ? defenderUnit</span>
<span class="pc bpc" id="L2581" title="1 of 2 branches missed.">                        : attackerUnit).isNaval();</span>
<span class="pc bpc" id="L2582" title="1 of 2 branches missed.">                if (ok) {</span>
<span class="pc bpc" id="L2583" title="1 of 2 branches missed.">                    if (result == CombatResult.WIN) {</span>
<span class="fc" id="L2584">                        csDamageShipAttack(attackerUnit, defenderUnit, cs);</span>
<span class="fc" id="L2585">                        defenderTileDirty = true;</span>
<span class="fc" id="L2586">                    } else {</span>
<span class="nc" id="L2587">                        csDamageShipAttack(defenderUnit, attackerUnit, cs);</span>
<span class="nc" id="L2588">                        attackerTileDirty = true;</span>
                    }
                }
<span class="nc" id="L2591">                break;</span>
            case DAMAGE_SHIP_BOMBARD:
<span class="nc bnc" id="L2593" title="All 4 branches missed.">                ok = isBombard &amp;&amp; result == CombatResult.WIN</span>
<span class="nc bnc" id="L2594" title="All 2 branches missed.">                    &amp;&amp; defenderUnit.isNaval();</span>
<span class="nc bnc" id="L2595" title="All 2 branches missed.">                if (ok) {</span>
<span class="nc" id="L2596">                    csDamageShipBombard(attackerSettlement, defenderUnit, cs);</span>
<span class="nc" id="L2597">                    defenderTileDirty = true;</span>
                }
<span class="nc" id="L2599">                break;</span>
            case DEMOTE_UNIT:
<span class="pc bpc" id="L2601" title="2 of 4 branches missed.">                ok = isAttack &amp;&amp; result != CombatResult.NO_RESULT;</span>
<span class="pc bpc" id="L2602" title="1 of 2 branches missed.">                if (ok) {</span>
<span class="fc bfc" id="L2603" title="All 2 branches covered.">                    if (result == CombatResult.WIN) {</span>
<span class="fc" id="L2604">                        csDemoteUnit(attackerUnit, defenderUnit, cs);</span>
<span class="fc" id="L2605">                        defenderTileDirty = true;</span>
<span class="fc" id="L2606">                    } else {</span>
<span class="fc" id="L2607">                        csDemoteUnit(defenderUnit, attackerUnit, cs);</span>
<span class="fc" id="L2608">                        attackerTileDirty = true;</span>
                    }
                }
<span class="fc" id="L2611">                break;</span>
            case DESTROY_COLONY:
<span class="pc bpc" id="L2613" title="2 of 4 branches missed.">                ok = isAttack &amp;&amp; result == CombatResult.WIN</span>
<span class="pc bpc" id="L2614" title="1 of 2 branches missed.">                    &amp;&amp; colony != null</span>
<span class="pc bpc" id="L2615" title="2 of 4 branches missed.">                    &amp;&amp; isIndian() &amp;&amp; defenderPlayer.isEuropean();</span>
<span class="pc bpc" id="L2616" title="1 of 2 branches missed.">                if (ok) {</span>
<span class="fc" id="L2617">                    csDestroyColony(attackerUnit, colony, random, cs);</span>
<span class="fc" id="L2618">                    attackerTileDirty = defenderTileDirty = true;</span>
<span class="fc" id="L2619">                    moveAttacker = true;</span>
<span class="fc" id="L2620">                    attackerTension -= Tension.TENSION_ADD_NORMAL;</span>
<span class="fc" id="L2621">                    defenderTension += Tension.TENSION_ADD_MAJOR;</span>
                }
<span class="fc" id="L2623">                break;</span>
            case DESTROY_SETTLEMENT:
<span class="nc bnc" id="L2625" title="All 4 branches missed.">                ok = isAttack &amp;&amp; result == CombatResult.WIN</span>
<span class="nc bnc" id="L2626" title="All 2 branches missed.">                    &amp;&amp; natives != null</span>
<span class="nc bnc" id="L2627" title="All 2 branches missed.">                    &amp;&amp; defenderPlayer.isIndian();</span>
<span class="nc bnc" id="L2628" title="All 2 branches missed.">                if (ok) {</span>
<span class="nc" id="L2629">                    burnedNativeCapital = settlement.isCapital();</span>
<span class="nc" id="L2630">                    csDestroySettlement(attackerUnit, natives, random, cs);</span>
<span class="nc" id="L2631">                    attackerTileDirty = defenderTileDirty = true;</span>
<span class="nc" id="L2632">                    moveAttacker = true;</span>
<span class="nc" id="L2633">                    attackerTension -= Tension.TENSION_ADD_NORMAL;</span>
<span class="nc bnc" id="L2634" title="All 2 branches missed.">                    if (!burnedNativeCapital) {</span>
<span class="nc" id="L2635">                        defenderTension += Tension.TENSION_ADD_MAJOR;</span>
                    }
                }
<span class="nc" id="L2638">                break;</span>
            case EVADE_ATTACK:
<span class="nc bnc" id="L2640" title="All 4 branches missed.">                ok = isAttack &amp;&amp; result == CombatResult.NO_RESULT</span>
<span class="nc bnc" id="L2641" title="All 2 branches missed.">                    &amp;&amp; defenderUnit.isNaval();</span>
<span class="nc bnc" id="L2642" title="All 2 branches missed.">                if (ok) {</span>
<span class="nc" id="L2643">                    csEvadeAttack(attackerUnit, defenderUnit, cs);</span>
                }
<span class="nc" id="L2645">                break;</span>
            case EVADE_BOMBARD:
<span class="nc bnc" id="L2647" title="All 4 branches missed.">                ok = isBombard &amp;&amp; result == CombatResult.NO_RESULT</span>
<span class="nc bnc" id="L2648" title="All 2 branches missed.">                    &amp;&amp; defenderUnit.isNaval();</span>
<span class="nc bnc" id="L2649" title="All 2 branches missed.">                if (ok) {</span>
<span class="nc" id="L2650">                    csEvadeBombard(attackerSettlement, defenderUnit, cs);</span>
                }
<span class="nc" id="L2652">                break;</span>
            case LOOT_SHIP:
<span class="pc bpc" id="L2654" title="2 of 4 branches missed.">                ok = isAttack &amp;&amp; result != CombatResult.NO_RESULT</span>
<span class="pc bpc" id="L2655" title="2 of 4 branches missed.">                    &amp;&amp; attackerUnit.isNaval() &amp;&amp; defenderUnit.isNaval();</span>
<span class="pc bpc" id="L2656" title="1 of 2 branches missed.">                if (ok) {</span>
<span class="pc bpc" id="L2657" title="1 of 2 branches missed.">                    if (result == CombatResult.WIN) {</span>
<span class="fc" id="L2658">                        csLootShip(attackerUnit, defenderUnit, cs);</span>
<span class="fc" id="L2659">                    } else {</span>
<span class="nc" id="L2660">                        csLootShip(defenderUnit, attackerUnit, cs);</span>
                    }
                }
<span class="nc" id="L2663">                break;</span>
            case LOSE_AUTOEQUIP:
<span class="pc bpc" id="L2665" title="2 of 4 branches missed.">                ok = isAttack &amp;&amp; result == CombatResult.WIN</span>
<span class="pc bpc" id="L2666" title="1 of 2 branches missed.">                    &amp;&amp; settlement != null;</span>
<span class="pc bpc" id="L2667" title="1 of 2 branches missed.">                if (ok) {</span>
<span class="fc" id="L2668">                    csLoseAutoEquip(attackerUnit, defenderUnit, cs);</span>
<span class="fc" id="L2669">                    defenderTileDirty = true;</span>
                }
<span class="fc" id="L2671">                break;</span>
            case LOSE_EQUIP:
<span class="pc bpc" id="L2673" title="2 of 4 branches missed.">                ok = isAttack &amp;&amp; result != CombatResult.NO_RESULT;</span>
<span class="pc bpc" id="L2674" title="1 of 2 branches missed.">                if (ok) {</span>
<span class="fc bfc" id="L2675" title="All 2 branches covered.">                    if (result == CombatResult.WIN) {</span>
<span class="fc" id="L2676">                        csLoseEquip(attackerUnit, defenderUnit, cs);</span>
<span class="fc" id="L2677">                        defenderTileDirty = true;</span>
<span class="fc" id="L2678">                    } else {</span>
<span class="fc" id="L2679">                        csLoseEquip(defenderUnit, attackerUnit, cs);</span>
<span class="fc" id="L2680">                        attackerTileDirty = true;</span>
                    }
                }
<span class="fc" id="L2683">                break;</span>
            case PILLAGE_COLONY:
<span class="pc bpc" id="L2685" title="2 of 4 branches missed.">                ok = isAttack &amp;&amp; result == CombatResult.WIN</span>
<span class="pc bpc" id="L2686" title="1 of 2 branches missed.">                    &amp;&amp; colony != null</span>
<span class="pc bpc" id="L2687" title="2 of 4 branches missed.">                    &amp;&amp; isIndian() &amp;&amp; defenderPlayer.isEuropean();</span>
<span class="pc bpc" id="L2688" title="1 of 2 branches missed.">                if (ok) {</span>
<span class="fc" id="L2689">                    csPillageColony(attackerUnit, colony, random, cs);</span>
<span class="fc" id="L2690">                    defenderTileDirty = true;</span>
<span class="fc" id="L2691">                    attackerTension -= Tension.TENSION_ADD_NORMAL;</span>
                }
<span class="fc" id="L2693">                break;</span>
            case PROMOTE_UNIT:
<span class="pc bpc" id="L2695" title="2 of 4 branches missed.">                ok = isAttack &amp;&amp; result != CombatResult.NO_RESULT;</span>
<span class="pc bpc" id="L2696" title="1 of 2 branches missed.">                if (ok) {</span>
<span class="pc bpc" id="L2697" title="1 of 2 branches missed.">                    if (result == CombatResult.WIN) {</span>
<span class="fc" id="L2698">                        csPromoteUnit(attackerUnit, cs);</span>
<span class="fc" id="L2699">                        attackerTileDirty = true;</span>
<span class="fc" id="L2700">                    } else {</span>
<span class="nc" id="L2701">                        csPromoteUnit(defenderUnit, cs);</span>
<span class="nc" id="L2702">                        defenderTileDirty = true;</span>
                    }
                }
<span class="nc" id="L2705">                break;</span>
            case SINK_COLONY_SHIPS:
<span class="nc bnc" id="L2707" title="All 4 branches missed.">                ok = isAttack &amp;&amp; result == CombatResult.WIN</span>
<span class="nc bnc" id="L2708" title="All 2 branches missed.">                    &amp;&amp; colony != null;</span>
<span class="nc bnc" id="L2709" title="All 2 branches missed.">                if (ok) {</span>
<span class="nc" id="L2710">                    csSinkColonyShips(attackerUnit, colony, cs);</span>
<span class="nc" id="L2711">                    defenderTileDirty = true;</span>
                }
<span class="nc" id="L2713">                break;</span>
            case SINK_SHIP_ATTACK:
<span class="nc bnc" id="L2715" title="All 4 branches missed.">                ok = isAttack &amp;&amp; result != CombatResult.NO_RESULT</span>
<span class="nc bnc" id="L2716" title="All 2 branches missed.">                    &amp;&amp; ((result == CombatResult.WIN) ? defenderUnit</span>
<span class="nc bnc" id="L2717" title="All 2 branches missed.">                        : attackerUnit).isNaval();</span>
<span class="nc bnc" id="L2718" title="All 2 branches missed.">                if (ok) {</span>
<span class="nc bnc" id="L2719" title="All 2 branches missed.">                    if (result == CombatResult.WIN) {</span>
<span class="nc" id="L2720">                        csSinkShipAttack(attackerUnit, defenderUnit, cs);</span>
<span class="nc" id="L2721">                        defenderTileDirty = true;</span>
<span class="nc" id="L2722">                    } else {</span>
<span class="nc" id="L2723">                        csSinkShipAttack(defenderUnit, attackerUnit, cs);</span>
<span class="nc" id="L2724">                        attackerTileDirty = true;</span>
                    }
                }
<span class="nc" id="L2727">                break;</span>
            case SINK_SHIP_BOMBARD:
<span class="nc bnc" id="L2729" title="All 4 branches missed.">                ok = isBombard &amp;&amp; result == CombatResult.WIN</span>
<span class="nc bnc" id="L2730" title="All 2 branches missed.">                    &amp;&amp; defenderUnit.isNaval();</span>
<span class="nc bnc" id="L2731" title="All 2 branches missed.">                if (ok) {</span>
<span class="nc" id="L2732">                    csSinkShipBombard(attackerSettlement, defenderUnit, cs);</span>
<span class="nc" id="L2733">                    defenderTileDirty = true;</span>
                }
<span class="nc" id="L2735">                break;</span>
            case SLAUGHTER_UNIT:
<span class="pc bpc" id="L2737" title="2 of 4 branches missed.">                ok = isAttack &amp;&amp; result != CombatResult.NO_RESULT;</span>
<span class="pc bpc" id="L2738" title="1 of 2 branches missed.">                if (ok) {</span>
<span class="fc bfc" id="L2739" title="All 2 branches covered.">                    if (result == CombatResult.WIN) {</span>
<span class="fc" id="L2740">                        csSlaughterUnit(attackerUnit, defenderUnit, cs);</span>
<span class="fc" id="L2741">                        defenderTileDirty = true;</span>
<span class="fc" id="L2742">                        attackerTension -= Tension.TENSION_ADD_NORMAL;</span>
<span class="fc" id="L2743">                        defenderTension += getSlaughterTension(defenderUnit);</span>
<span class="fc" id="L2744">                    } else {</span>
<span class="fc" id="L2745">                        csSlaughterUnit(defenderUnit, attackerUnit, cs);</span>
<span class="fc" id="L2746">                        attackerTileDirty = true;</span>
<span class="fc" id="L2747">                        attackerTension += getSlaughterTension(attackerUnit);</span>
<span class="fc" id="L2748">                        defenderTension -= Tension.TENSION_ADD_NORMAL;</span>
                    }
                }
<span class="fc" id="L2751">                break;</span>
            default:
<span class="nc" id="L2753">                ok = false;</span>
                break;
            }
<span class="pc bpc" id="L2756" title="1 of 2 branches missed.">            if (!ok) {</span>
<span class="nc" id="L2757">                throw new IllegalStateException(&quot;Attack (result=&quot; + result</span>
<span class="nc" id="L2758">                                                + &quot;) has bogus subresult: &quot;</span>
<span class="nc" id="L2759">                                                + cr);</span>
            }
        }

        // Handle stance and tension.
        // - Privateers do not provoke stance changes but can set the
        //     attackedByPrivateers flag
        // - Attacks among Europeans imply war
        // - Burning of a native capital results in surrender
        // - Other attacks involving natives do not imply war, but
        //     changes in Tension can drive Stance, however this is
        //     decided by the native AI in their turn so just adjust tension.
<span class="fc bfc" id="L2771" title="All 2 branches covered.">        if (attacker.hasAbility(Ability.PIRACY)) {</span>
<span class="pc bpc" id="L2772" title="1 of 2 branches missed.">            if (!defenderPlayer.getAttackedByPrivateers()) {</span>
<span class="fc" id="L2773">                defenderPlayer.setAttackedByPrivateers(true);</span>
<span class="fc" id="L2774">                cs.addPartial(See.only(defenderPlayer), defenderPlayer,</span>
<span class="fc" id="L2775">                              &quot;attackedByPrivateers&quot;);</span>
            }
<span class="pc bpc" id="L2777" title="1 of 2 branches missed.">        } else if (defender.hasAbility(Ability.PIRACY)) {</span>
            ; // do nothing
<span class="pc bpc" id="L2779" title="1 of 2 branches missed.">        } else if (burnedNativeCapital) {</span>
<span class="nc" id="L2780">            defenderPlayer.getTension(this).setValue(Tension.SURRENDERED);</span>
            // FIXME: just the tension
<span class="nc" id="L2782">            cs.add(See.perhaps().always(this), defenderPlayer);</span>
<span class="nc" id="L2783">            csChangeStance(Stance.PEACE, defenderPlayer, true, cs);</span>
<span class="nc bnc" id="L2784" title="All 2 branches missed.">            for (IndianSettlement is : defenderPlayer.getIndianSettlements()) {</span>
<span class="nc bnc" id="L2785" title="All 2 branches missed.">                if (is.hasContacted(this)) {</span>
<span class="nc" id="L2786">                    is.getAlarm(this).setValue(Tension.SURRENDERED);</span>
                    // Only update attacker with settlements that have
                    // been seen, as contact can occur with its members.
<span class="nc bnc" id="L2789" title="All 2 branches missed.">                    if (hasExplored(is.getTile())) {</span>
<span class="nc" id="L2790">                        cs.add(See.perhaps().always(this), is);</span>
<span class="nc" id="L2791">                    } else {</span>
<span class="nc" id="L2792">                        cs.add(See.only(defenderPlayer), is);</span>
                    }
                }
            }
<span class="pc bfc" id="L2796" title="All 4 branches covered.">        } else if (isEuropean() &amp;&amp; defenderPlayer.isEuropean()) {</span>
<span class="fc" id="L2797">            csChangeStance(Stance.WAR, defenderPlayer, true, cs);</span>
<span class="fc" id="L2798">        } else { // At least one player is non-European</span>
<span class="fc bfc" id="L2799" title="All 2 branches covered.">            if (isEuropean()) {</span>
<span class="fc" id="L2800">                csChangeStance(Stance.WAR, defenderPlayer, true, cs);</span>
<span class="pc bpc" id="L2801" title="1 of 2 branches missed.">            } else if (isIndian()) {</span>
<span class="pc bpc" id="L2802" title="1 of 2 branches missed.">                if (result == CombatResult.WIN) {</span>
<span class="fc" id="L2803">                    attackerTension -= Tension.TENSION_ADD_MINOR;</span>
<span class="pc bnc" id="L2804" title="All 2 branches missed.">                } else if (result == CombatResult.LOSE) {</span>
<span class="nc" id="L2805">                    attackerTension += Tension.TENSION_ADD_MINOR;</span>
                }
            }
<span class="fc bfc" id="L2808" title="All 2 branches covered.">            if (defenderPlayer.isEuropean()) {</span>
<span class="fc" id="L2809">                defenderPlayer.csChangeStance(Stance.WAR, this, true, cs);</span>
<span class="pc bpc" id="L2810" title="1 of 2 branches missed.">            } else if (defenderPlayer.isIndian()) {</span>
<span class="fc bfc" id="L2811" title="All 2 branches covered.">                if (result == CombatResult.WIN) {</span>
<span class="fc" id="L2812">                    defenderTension += Tension.TENSION_ADD_MINOR;</span>
<span class="pc bpc" id="L2813" title="1 of 2 branches missed.">                } else if (result == CombatResult.LOSE) {</span>
<span class="fc" id="L2814">                    defenderTension -= Tension.TENSION_ADD_MINOR;</span>
                }
            }
<span class="fc bfc" id="L2817" title="All 2 branches covered.">            if (attackerTension != 0) {</span>
<span class="fc" id="L2818">                this.csModifyTension(defenderPlayer,</span>
<span class="fc" id="L2819">                                     attackerTension, cs);//+til</span>
            }
<span class="fc bfc" id="L2821" title="All 2 branches covered.">            if (defenderTension != 0) {</span>
<span class="fc" id="L2822">                defenderPlayer.csModifyTension(this,</span>
<span class="fc" id="L2823">                                               defenderTension, cs);//+til</span>
            }
        }

        // Move the attacker if required.
<span class="fc bfc" id="L2828" title="All 2 branches covered.">        if (moveAttacker) {</span>
<span class="fc" id="L2829">            attackerUnit.setMovesLeft(attackerUnit.getInitialMovesLeft());</span>
<span class="fc" id="L2830">            ((ServerUnit) attackerUnit).csMove(defenderTile, random, cs);</span>
<span class="fc" id="L2831">            attackerUnit.setMovesLeft(0);</span>
            // Move adds in updates for the tiles, but...
<span class="fc" id="L2833">            attackerTileDirty = defenderTileDirty = false;</span>
            // ...with visibility of perhaps().
            // Thus the defender might see the change,
            // but because its settlement is gone it also might not.
            // So add in another defender-specific update.
            // The worst that can happen is a duplicate update.
<span class="fc" id="L2839">            cs.add(See.only(defenderPlayer), defenderTile);</span>
<span class="pc bpc" id="L2840" title="1 of 2 branches missed.">        } else if (isAttack) {</span>
            // The Revenger unit can attack multiple times, so spend
            // at least the eventual cost of moving to the tile.
            // Other units consume the entire move.
<span class="pc bpc" id="L2844" title="1 of 2 branches missed.">            if (attacker.hasAbility(Ability.MULTIPLE_ATTACKS)) {</span>
<span class="nc" id="L2845">                int movecost = attackerUnit.getMoveCost(defenderTile);</span>
<span class="nc" id="L2846">                attackerUnit.setMovesLeft(attackerUnit.getMovesLeft()</span>
<span class="nc" id="L2847">                                          - movecost);</span>
<span class="nc" id="L2848">            } else {</span>
<span class="fc" id="L2849">                attackerUnit.setMovesLeft(0);</span>
            }
<span class="fc bfc" id="L2851" title="All 2 branches covered.">            if (!attackerTileDirty) {</span>
<span class="fc" id="L2852">                cs.addPartial(See.only(this), attacker, &quot;movesLeft&quot;);</span>
            }
        }

        // Make sure we always update the attacker and defender tile
        // if it is not already done yet.
<span class="fc bfc" id="L2858" title="All 2 branches covered.">        if (attackerTileDirty) {</span>
<span class="pc bpc" id="L2859" title="1 of 2 branches missed.">            if (attackerSettlement != null) cs.remove(attackerSettlement);</span>
<span class="fc" id="L2860">            cs.add(vis, attackerTile);</span>
        }
<span class="fc bfc" id="L2862" title="All 2 branches covered.">        if (defenderTileDirty) {</span>
<span class="fc bfc" id="L2863" title="All 2 branches covered.">            if (settlement != null) cs.remove(settlement);</span>
<span class="fc" id="L2864">            cs.add(vis, defenderTile);</span>
        }
<span class="fc" id="L2866">    }</span>

    /**
     * Gets the amount to raise tension by when a unit is slaughtered.
     *
     * @param loser The &lt;code&gt;Unit&lt;/code&gt; that dies.
     * @return An amount to raise tension by.
     */
    private int getSlaughterTension(Unit loser) {
        // Tension rises faster when units die.
<span class="fc" id="L2876">        Settlement settlement = loser.getSettlement();</span>
<span class="pc bpc" id="L2877" title="1 of 2 branches missed.">        if (settlement != null) {</span>
<span class="nc bnc" id="L2878" title="All 2 branches missed.">            if (settlement instanceof IndianSettlement) {</span>
<span class="nc bnc" id="L2879" title="All 2 branches missed.">                return (settlement.isCapital())</span>
<span class="nc" id="L2880">                    ? Tension.TENSION_ADD_CAPITAL_ATTACKED</span>
<span class="nc" id="L2881">                    : Tension.TENSION_ADD_SETTLEMENT_ATTACKED;</span>
            } else {
<span class="nc" id="L2883">                return Tension.TENSION_ADD_NORMAL;</span>
            }
        } else { // attack in the open
<span class="pc bpc" id="L2886" title="1 of 2 branches missed.">            return (loser.getHomeIndianSettlement() != null)</span>
<span class="nc" id="L2887">                ? Tension.TENSION_ADD_UNIT_DESTROYED</span>
<span class="fc" id="L2888">                : Tension.TENSION_ADD_MINOR;</span>
        }
    }

    /**
     * Notifies of automatic arming.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is auto-equipping.
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; being defended.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csAutoequipUnit(Unit unit, Settlement settlement,
                                 ChangeSet cs) {
<span class="fc" id="L2901">        ServerPlayer player = (ServerPlayer) unit.getOwner();</span>
<span class="fc" id="L2902">        cs.addMessage(See.only(player),</span>
<span class="fc" id="L2903">            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="fc" id="L2904">                             &quot;combat.automaticDefence&quot;, unit)</span>
<span class="fc" id="L2905">                .addStringTemplate(&quot;%unit%&quot;, unit.getLabel())</span>
<span class="fc" id="L2906">                .addName(&quot;%colony%&quot;, settlement.getName()));</span>
<span class="fc" id="L2907">    }</span>

    /**
     * Burns a players missions.
     *
     * @param attacker The &lt;code&gt;Unit&lt;/code&gt; that attacked.
     * @param settlement The &lt;code&gt;IndianSettlement&lt;/code&gt; that was attacked.
     * @param cs The &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csBurnMissions(Unit attacker, IndianSettlement settlement,
                                ChangeSet cs) {
<span class="nc" id="L2918">        ServerPlayer attackerPlayer = (ServerPlayer) attacker.getOwner();</span>
<span class="nc" id="L2919">        StringTemplate attackerNation = attackerPlayer.getNationLabel();</span>
<span class="nc" id="L2920">        ServerPlayer nativePlayer = (ServerPlayer) settlement.getOwner();</span>
<span class="nc" id="L2921">        StringTemplate nativeNation = nativePlayer.getNationLabel();</span>

        // Message only for the European player
<span class="nc" id="L2924">        cs.addMessage(See.only(attackerPlayer),</span>
<span class="nc" id="L2925">            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="nc" id="L2926">                             &quot;combat.burnMissions&quot;, attacker, settlement)</span>
<span class="nc" id="L2927">                .addStringTemplate(&quot;%nation%&quot;, attackerNation)</span>
<span class="nc" id="L2928">                .addStringTemplate(&quot;%enemyNation%&quot;, nativeNation));</span>

        // Burn down the missions
<span class="nc" id="L2931">        boolean here = settlement.hasMissionary(attackerPlayer);</span>
<span class="nc bnc" id="L2932" title="All 2 branches missed.">        for (IndianSettlement s : nativePlayer.getIndianSettlements()) {</span>
<span class="nc bnc" id="L2933" title="All 2 branches missed.">            if (s.hasMissionary(attackerPlayer)) {</span>
<span class="nc" id="L2934">                ((ServerIndianSettlement)s).csKillMissionary(null, cs);</span>
            }
        }
        // Backtrack on updating this tile, avoiding duplication in csCombat
<span class="nc bnc" id="L2938" title="All 2 branches missed.">        if (here) cs.remove(settlement.getTile());</span>
<span class="nc" id="L2939">    }</span>

    /**
     * Defender auto equips but loses and attacker captures the equipment.
     *
     * @param attacker The &lt;code&gt;Unit&lt;/code&gt; that attacked.
     * @param defender The &lt;code&gt;Unit&lt;/code&gt; that defended and loses equipment.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csCaptureAutoEquip(Unit attacker, Unit defender,
                                    ChangeSet cs) {
<span class="nc" id="L2950">        Role role = defender.getAutomaticRole();</span>
<span class="nc" id="L2951">        csLoseAutoEquip(attacker, defender, cs);</span>
<span class="nc" id="L2952">        csCaptureEquipment(attacker, defender, role, cs);</span>
<span class="nc" id="L2953">    }</span>

    /**
     * Captures a colony.
     *
     * @param attacker The attacking &lt;code&gt;Unit&lt;/code&gt;.
     * @param colony The &lt;code&gt;ServerColony&lt;/code&gt; to capture.
     * @param random A pseudo-random number source.
     * @param cs The &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csCaptureColony(Unit attacker, ServerColony colony,
                                 Random random, ChangeSet cs) {
<span class="fc" id="L2965">        Game game = attacker.getGame();</span>
<span class="fc" id="L2966">        ServerPlayer attackerPlayer = (ServerPlayer) attacker.getOwner();</span>
<span class="fc" id="L2967">        StringTemplate attackerNation = attacker.getApparentOwnerName();</span>
<span class="fc" id="L2968">        ServerPlayer colonyPlayer = (ServerPlayer) colony.getOwner();</span>
<span class="fc" id="L2969">        StringTemplate colonyNation = colonyPlayer.getNationLabel();</span>
<span class="fc" id="L2970">        Tile tile = colony.getTile();</span>
<span class="fc" id="L2971">        List&lt;Unit&gt; units = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L2972">        units.addAll(colony.getUnitList());</span>
<span class="fc" id="L2973">        units.addAll(tile.getUnitList());</span>
<span class="fc" id="L2974">        int plunder = colony.getPlunder(attacker, random);</span>

        // Handle history and messages before colony handover
<span class="fc" id="L2977">        cs.addHistory(attackerPlayer,</span>
<span class="fc" id="L2978">            new HistoryEvent(game.getTurn(),</span>
<span class="fc" id="L2979">                HistoryEvent.HistoryEventType.CONQUER_COLONY, attackerPlayer)</span>
<span class="fc" id="L2980">                .addStringTemplate(&quot;%nation%&quot;, colonyNation)</span>
<span class="fc" id="L2981">                .addName(&quot;%colony%&quot;, colony.getName()));</span>
<span class="fc" id="L2982">        cs.addHistory(colonyPlayer,</span>
<span class="fc" id="L2983">            new HistoryEvent(game.getTurn(),</span>
<span class="fc" id="L2984">                HistoryEvent.HistoryEventType.COLONY_CONQUERED, attackerPlayer)</span>
<span class="fc" id="L2985">                      .addStringTemplate(&quot;%nation%&quot;, attackerNation)</span>
<span class="fc" id="L2986">                      .addName(&quot;%colony%&quot;, colony.getName()));</span>
<span class="fc" id="L2987">        cs.addMessage(See.only(attackerPlayer),</span>
<span class="fc" id="L2988">            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="fc" id="L2989">                             &quot;combat.colonyCaptured.enemy&quot;, colony)</span>
<span class="fc" id="L2990">                .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="fc" id="L2991">                .addStringTemplate(&quot;%unit%&quot;, attacker.getLabel())</span>
<span class="fc" id="L2992">                .addStringTemplate(&quot;%enemyNation%&quot;, colonyNation)</span>
<span class="fc" id="L2993">                .addAmount(&quot;%amount%&quot;, plunder));</span>
<span class="fc" id="L2994">        cs.addMessage(See.only(colonyPlayer),</span>
<span class="fc" id="L2995">            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="fc" id="L2996">                            &quot;combat.colonyCaptured.ours&quot;, tile)</span>
<span class="fc" id="L2997">                .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="fc" id="L2998">                .addStringTemplate(&quot;%enemyUnit%&quot;, attacker.getLabel())</span>
<span class="fc" id="L2999">                .addStringTemplate(&quot;%enemyNation%&quot;, attackerNation)</span>
<span class="fc" id="L3000">                .addAmount(&quot;%amount%&quot;, plunder));</span>
<span class="fc" id="L3001">        colonyPlayer.csLoseLocation(colony, cs);</span>

        // Allocate some plunder
<span class="pc bpc" id="L3004" title="1 of 2 branches missed.">        if (plunder &gt; 0) {</span>
<span class="nc" id="L3005">            attackerPlayer.modifyGold(plunder);</span>
<span class="nc" id="L3006">            colonyPlayer.modifyGold(-plunder);</span>
<span class="nc" id="L3007">            cs.addPartial(See.only(attackerPlayer), attackerPlayer, &quot;gold&quot;);</span>
<span class="nc" id="L3008">            cs.addPartial(See.only(colonyPlayer), colonyPlayer, &quot;gold&quot;);</span>
        }

        // Remove goods party modifiers as they apply to a different monarch.
<span class="fc bfc" id="L3012" title="All 2 branches covered.">        for (Modifier m : colony.getModifiers()) {</span>
<span class="pc bpc" id="L3013" title="1 of 2 branches missed.">            if (Specification.COLONY_GOODS_PARTY_SOURCE == m.getSource()) {</span>
<span class="nc" id="L3014">                colony.removeModifier(m);</span>
            }
        }

        // The colony is falling, so allow other neighbours a chance
        // to claim its tiles.  Make sure units are ejected when a tile
        // is claimed.
<span class="fc" id="L3021">        Set&lt;Tile&gt; tiles = colony.getOwnedTiles();</span>
<span class="fc" id="L3022">        tile.cacheUnseen();</span>
<span class="fc" id="L3023">        tiles.remove(tile);</span>
<span class="fc bfc" id="L3024" title="All 2 branches covered.">        for (Tile t : tiles) {</span>
<span class="fc" id="L3025">            t.cacheUnseen();</span>
<span class="fc" id="L3026">            t.changeOwnership(null, null);//-til</span>
        }
<span class="fc" id="L3028">        reassignTiles(tiles, colonyPlayer, colony);//-til</span>
<span class="fc bfc" id="L3029" title="All 2 branches covered.">        for (Tile t : tiles) {</span>
<span class="fc bfc" id="L3030" title="All 2 branches covered.">            if (t.getOwningSettlement() != colony) {</span>
<span class="fc" id="L3031">                ColonyTile ct = colony.getColonyTile(t);</span>
<span class="fc" id="L3032">                colony.ejectUnits(ct, ct.getUnitList());</span>
            }
        }

        // Hand over the colony.  Inform former owner of loss of owned
        // tiles, and process possible increase in line of sight.
        // No need to display the colony tile or the attacker tile to
        // the attacking player as the unit is yet to move
<span class="fc" id="L3040">        Set&lt;Tile&gt; explored = colony//-til</span>
<span class="fc" id="L3041">            .csChangeOwner(attackerPlayer, cs);//-vis(attackerPlayer,colonyPlayer)</span>
<span class="fc" id="L3042">        explored.addAll(tiles);</span>
<span class="pc bpc" id="L3043" title="1 of 2 branches missed.">        if (attacker.hasTile()) explored.remove(attacker.getTile());</span>
<span class="fc" id="L3044">        cs.add(See.only(attackerPlayer), explored);</span>
<span class="fc" id="L3045">        cs.add(See.perhaps().always(colonyPlayer).except(attackerPlayer),</span>
<span class="fc" id="L3046">               tiles);</span>

        // Inform the former owner of loss of units, and add sound.
<span class="fc" id="L3049">        cs.addRemoves(See.only(colonyPlayer), null, units);</span>
<span class="fc" id="L3050">        cs.addAttribute(See.only(attackerPlayer), &quot;sound&quot;,</span>
<span class="fc" id="L3051">                        &quot;sound.event.captureColony&quot;);</span>

        // Ready to reset visibility
<span class="fc" id="L3054">        attackerPlayer.invalidateCanSeeTiles();//+vis(attackerPlayer)</span>
<span class="fc" id="L3055">        colonyPlayer.invalidateCanSeeTiles();//+vis(colonyPlayer)</span>
<span class="fc" id="L3056">    }</span>

    /**
     * Extracts a convert from a native settlement.
     *
     * @param attacker The &lt;code&gt;Unit&lt;/code&gt; that is attacking.
     * @param is The &lt;code&gt;IndianSettlement&lt;/code&gt; under attack.
     * @param random A pseudo-random number source.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csCaptureConvert(Unit attacker, IndianSettlement is,
                                  Random random, ChangeSet cs) {
<span class="fc" id="L3068">        final Specification spec = getGame().getSpecification();</span>
<span class="fc" id="L3069">        ServerPlayer attackerPlayer = (ServerPlayer)attacker.getOwner();</span>
<span class="fc" id="L3070">        ServerPlayer nativePlayer = (ServerPlayer)is.getOwner();</span>
<span class="fc" id="L3071">        StringTemplate convertNation = nativePlayer.getNationLabel();</span>
<span class="fc" id="L3072">        List&lt;Unit&gt; units = is.getTile().getUnitList();</span>
<span class="pc bpc" id="L3073" title="1 of 2 branches missed.">        if (units.isEmpty()) units.addAll(is.getUnitList());</span>
<span class="fc" id="L3074">        ServerUnit convert = (ServerUnit)getRandomMember(logger,</span>
<span class="fc" id="L3075">            &quot;Choose convert&quot;, units, random);</span>
<span class="fc" id="L3076">        if (nativePlayer.csChangeOwner(convert, attackerPlayer,</span>
<span class="fc" id="L3077">                                       ChangeType.CONVERSION,</span>
<span class="fc" id="L3078">                                       attacker.getTile(),</span>
<span class="pc bpc" id="L3079" title="1 of 2 branches missed.">                                       cs)) { //-vis(attackerPlayer)</span>
<span class="fc" id="L3080">            convert.changeRole(spec.getDefaultRole(), 0);</span>
<span class="fc" id="L3081">            convert.setMovesLeft(0);</span>
<span class="fc" id="L3082">            convert.setState(Unit.UnitState.ACTIVE);</span>
<span class="fc" id="L3083">            cs.add(See.only(nativePlayer), is.getTile());</span>
<span class="fc" id="L3084">            cs.addMessage(See.only(attackerPlayer),</span>
<span class="fc" id="L3085">                new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="fc" id="L3086">                                 &quot;combat.newConvertFromAttack&quot;, convert)</span>
<span class="fc" id="L3087">                    .addStringTemplate(&quot;%unit%&quot;, attacker.getLabel())</span>
<span class="fc" id="L3088">                    .addStringTemplate(&quot;%enemyNation%&quot;, convertNation)</span>
<span class="fc" id="L3089">                    .addStringTemplate(&quot;%enemyUnit%&quot;, convert.getLabel()));</span>
<span class="fc" id="L3090">            attackerPlayer.invalidateCanSeeTiles();//+vis(attackerPlayer)</span>
        }
<span class="fc" id="L3092">    }</span>

    /**
     * Captures equipment.
     *
     * @param winner The &lt;code&gt;Unit&lt;/code&gt; that captures equipment.
     * @param loser The &lt;code&gt;Unit&lt;/code&gt; that defended and loses equipment.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csCaptureEquip(Unit winner, Unit loser, ChangeSet cs) {
<span class="fc" id="L3102">        Role role = loser.getRole();</span>
<span class="fc" id="L3103">        csLoseEquip(winner, loser, cs);</span>
<span class="fc" id="L3104">        csCaptureEquipment(winner, loser, role, cs);</span>
<span class="fc" id="L3105">    }</span>

    /**
     * Capture equipment.
     *
     * @param winner The &lt;code&gt;Unit&lt;/code&gt; that is capturing equipment.
     * @param loser The &lt;code&gt;Unit&lt;/code&gt; that is losing equipment.
     * @param role The &lt;code&gt;Role&lt;/code&gt; wrest from the loser.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csCaptureEquipment(Unit winner, Unit loser,
                                    Role role, ChangeSet cs) {
<span class="fc" id="L3117">        ServerPlayer winnerPlayer = (ServerPlayer) winner.getOwner();</span>
<span class="fc" id="L3118">        ServerPlayer loserPlayer = (ServerPlayer) loser.getOwner();</span>
<span class="fc" id="L3119">        Role newRole = winner.canCaptureEquipment(role);</span>
<span class="pc bpc" id="L3120" title="1 of 2 branches missed.">        if (newRole != null) {</span>
<span class="fc" id="L3121">            List&lt;AbstractGoods&gt; newGoods</span>
<span class="fc" id="L3122">                = winner.getGoodsDifference(newRole, 1);</span>
<span class="fc" id="L3123">            GoodsType goodsType = newGoods.get(0).getType(); // FIXME: generalize</span>
<span class="fc" id="L3124">            winner.changeRole(newRole, 1);</span>

            // Currently can not capture equipment back so this only
            // makes sense for native players, and the message is
            // native specific.
<span class="pc bpc" id="L3129" title="1 of 2 branches missed.">            if (winnerPlayer.isIndian()) {</span>
<span class="fc" id="L3130">                StringTemplate winnerNation = winner.getApparentOwnerName();</span>
<span class="fc" id="L3131">                cs.addMessage(See.only(loserPlayer),</span>
<span class="fc" id="L3132">                              new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="fc" id="L3133">                                               &quot;combat.equipmentCaptured&quot;,</span>
<span class="fc" id="L3134">                                               winnerPlayer)</span>
<span class="fc" id="L3135">                                  .addStringTemplate(&quot;%nation%&quot;, winnerNation)</span>
<span class="fc" id="L3136">                                  .addNamed(&quot;%equipment%&quot;, goodsType));</span>

                // CHEAT: Immediately transferring the captured goods
                // back to a potentially remote settlement is pretty
                // dubious.  Apparently Col1 did it.  Better would be
                // to give the capturing unit a go-home-with-plunder mission.
<span class="fc" id="L3142">                IndianSettlement settlement = winner.getHomeIndianSettlement();</span>
<span class="pc bpc" id="L3143" title="1 of 2 branches missed.">                if (settlement != null) {</span>
<span class="fc bfc" id="L3144" title="All 2 branches covered.">                    for (AbstractGoods ag : newGoods) {</span>
<span class="fc" id="L3145">                        settlement.addGoods(ag);</span>
<span class="fc" id="L3146">                        winnerPlayer.logCheat(&quot;teleported &quot; + ag</span>
<span class="fc" id="L3147">                            + &quot; back to &quot; + settlement.getName());</span>
                    }
<span class="fc" id="L3149">                    cs.add(See.only(winnerPlayer), settlement);</span>
                }
            }
        }
<span class="fc" id="L3153">    }</span>

    /**
     * Capture a unit.
     *
     * @param winner A &lt;code&gt;Unit&lt;/code&gt; that is capturing.
     * @param loser A &lt;code&gt;Unit&lt;/code&gt; to capture.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csCaptureUnit(Unit winner, Unit loser, ChangeSet cs) {
<span class="fc" id="L3163">        ServerPlayer loserPlayer = (ServerPlayer) loser.getOwner();</span>
<span class="fc" id="L3164">        StringTemplate loserNation = loserPlayer.getNationLabel();</span>
<span class="fc" id="L3165">        StringTemplate loserLocation = loser.getLocation()</span>
<span class="fc" id="L3166">            .getLocationLabelFor(loserPlayer);</span>
<span class="fc" id="L3167">        StringTemplate loserLabel = loser.getLabel();</span>
<span class="fc" id="L3168">        ServerPlayer winnerPlayer = (ServerPlayer) winner.getOwner();</span>
<span class="fc" id="L3169">        StringTemplate winnerNation = winner.getApparentOwnerName();</span>
<span class="fc" id="L3170">        StringTemplate winnerLocation = winner.getLocation()</span>
<span class="fc" id="L3171">            .getLocationLabelFor(winnerPlayer);</span>

        // Capture the unit.  There are visibility implications for
        // both players because the captured unit might be the only
        // one on its tile, and the winner might have captured a unit
        // with greater line of sight.
        String key;
<span class="fc" id="L3178">        Tile oldTile = loser.getTile();</span>
<span class="pc bpc" id="L3179" title="1 of 2 branches missed.">        ChangeType change = (winnerPlayer.isUndead()) ? ChangeType.UNDEAD</span>
<span class="fc" id="L3180">            : ChangeType.CAPTURE;</span>
<span class="fc" id="L3181">        if (loserPlayer.csChangeOwner(loser, winnerPlayer, change,</span>
<span class="pc bpc" id="L3182" title="1 of 2 branches missed.">                                      winner.getTile(), cs)) {//-vis(both)</span>
<span class="fc" id="L3183">            loser.setMovesLeft(0);</span>
<span class="fc" id="L3184">            loser.setState(Unit.UnitState.ACTIVE);</span>
<span class="fc" id="L3185">            cs.add(See.perhaps().always(loserPlayer), oldTile);</span>
            // Winner message post-capture when it owns the loser
<span class="fc" id="L3187">            key = &quot;combat.unitCaptured.enemy.&quot; + loser.getType().getSuffix();</span>
<span class="fc" id="L3188">            cs.addMessage(See.only(winnerPlayer),</span>
<span class="fc" id="L3189">                new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="fc" id="L3190">                                 key, loser)</span>
<span class="fc" id="L3191">                    .addDefaultId(&quot;combat.unitCaptured.enemy&quot;)</span>
<span class="fc" id="L3192">                    .addStringTemplate(&quot;%location%&quot;, winnerLocation)</span>
<span class="fc" id="L3193">                    .addStringTemplate(&quot;%unit%&quot;, winner.getLabel())</span>
<span class="fc" id="L3194">                    .addStringTemplate(&quot;%enemyNation%&quot;, loserNation)</span>
<span class="fc" id="L3195">                    .addStringTemplate(&quot;%enemyUnit%&quot;, loserLabel));</span>
        }
<span class="fc" id="L3197">        key = &quot;combat.unitCaptured.ours.&quot; + loser.getType().getSuffix();</span>
<span class="fc" id="L3198">        cs.addMessage(See.only(loserPlayer),</span>
<span class="fc" id="L3199">            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="fc" id="L3200">                             key, loser.getTile())</span>
<span class="fc" id="L3201">                .addDefaultId(&quot;combat.unitCaptured.ours&quot;)</span>
<span class="fc" id="L3202">                .addStringTemplate(&quot;%location%&quot;, loserLocation)</span>
<span class="fc" id="L3203">                .addStringTemplate(&quot;%unit%&quot;, loserLabel)</span>
<span class="fc" id="L3204">                .addStringTemplate(&quot;%enemyNation%&quot;, winnerNation)</span>
<span class="fc" id="L3205">                .addStringTemplate(&quot;%enemyUnit%&quot;, winner.getLabel()));</span>
<span class="fc" id="L3206">        winnerPlayer.invalidateCanSeeTiles();//+vis(winnerPlayer)</span>
<span class="fc" id="L3207">        loserPlayer.invalidateCanSeeTiles();//+vis(loserPlayer)</span>
<span class="fc" id="L3208">    }</span>

    /**
     * Damages all ships in a colony in preparation for capture.
     *
     * @param attacker The &lt;code&gt;Unit&lt;/code&gt; that is damaging.
     * @param colony The &lt;code&gt;Colony&lt;/code&gt; to damage ships in.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csDamageColonyShips(Unit attacker, Colony colony,
                                     ChangeSet cs) {
<span class="nc" id="L3219">        boolean captureRepairing = getSpecification()</span>
<span class="nc" id="L3220">            .getBoolean(GameOptions.CAPTURE_UNITS_UNDER_REPAIR);</span>
<span class="nc" id="L3221">        List&lt;Unit&gt; units = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L3222" title="All 2 branches missed.">        for (Unit u : colony.getTile().getUnitList()) {</span>
<span class="nc bnc" id="L3223" title="All 2 branches missed.">            if (u.isNaval()</span>
<span class="nc bnc" id="L3224" title="All 4 branches missed.">                &amp;&amp; !(captureRepairing &amp;&amp; u.isDamaged())) units.add(u);</span>
        }
<span class="nc bnc" id="L3226" title="All 2 branches missed.">        if (!units.isEmpty()) {</span>
<span class="nc" id="L3227">            final ServerPlayer shipPlayer = (ServerPlayer)colony.getOwner();</span>
<span class="nc" id="L3228">            final Unit ship = units.get(0);</span>
<span class="nc" id="L3229">            final Location repairLocation = ship.getRepairLocation();</span>
<span class="nc" id="L3230">            StringTemplate t = StringTemplate.label(&quot;, &quot;);</span>
<span class="nc bnc" id="L3231" title="All 2 branches missed.">            for (Unit u : units) {</span>
<span class="nc" id="L3232">                csDamageShip(u, repairLocation, cs);</span>
<span class="nc" id="L3233">                t.addStringTemplate(u.getLabel());</span>
            }
<span class="nc" id="L3235">            cs.addMessage(See.only(shipPlayer),</span>
<span class="nc" id="L3236">                new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="nc" id="L3237">                                 &quot;combat.shipsDamaged&quot;, shipPlayer)</span>
<span class="nc" id="L3238">                    .addStringTemplate(&quot;%ships%&quot;, t)</span>
<span class="nc" id="L3239">                    .addAmount(&quot;%number%&quot;, units.size())</span>
<span class="nc" id="L3240">                    .addStringTemplate(&quot;%repairLocation%&quot;,</span>
<span class="nc" id="L3241">                        repairLocation.getLocationLabelFor(shipPlayer)));</span>
        }
<span class="nc" id="L3243">    }</span>

    /**
     * Damage a ship through normal attack.
     *
     * @param attacker The attacker &lt;code&gt;Unit&lt;/code&gt;.
     * @param ship The &lt;code&gt;Unit&lt;/code&gt; which is a ship to damage.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csDamageShipAttack(Unit attacker, Unit ship, ChangeSet cs) {
<span class="fc" id="L3253">        ServerPlayer attackerPlayer = (ServerPlayer) attacker.getOwner();</span>
<span class="fc" id="L3254">        StringTemplate attackerNation = attacker.getApparentOwnerName();</span>
<span class="fc" id="L3255">        ServerPlayer shipPlayer = (ServerPlayer) ship.getOwner();</span>
<span class="fc" id="L3256">        Location shipLocation = ship.getLocation();</span>
<span class="fc" id="L3257">        Location repair = ship.getRepairLocation();</span>
<span class="fc" id="L3258">        StringTemplate repairLoc = repair.getLocationLabelFor(shipPlayer);</span>
<span class="fc" id="L3259">        StringTemplate shipNation = ship.getApparentOwnerName();</span>

<span class="fc" id="L3261">        cs.addMessage(See.only(attackerPlayer),</span>
<span class="fc" id="L3262">            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="fc" id="L3263">                             &quot;combat.shipDamaged.enemy&quot;, attacker)</span>
<span class="fc" id="L3264">                .addStringTemplate(&quot;%location%&quot;,</span>
<span class="fc" id="L3265">                    shipLocation.getLocationLabelFor(attackerPlayer))</span>
<span class="fc" id="L3266">                .addStringTemplate(&quot;%unit%&quot;, attacker.getLabel())</span>
<span class="fc" id="L3267">                .addStringTemplate(&quot;%enemyNation%&quot;, shipNation)</span>
<span class="fc" id="L3268">                .addStringTemplate(&quot;%enemyUnit%&quot;, ship.getLabel()));</span>
<span class="fc" id="L3269">        cs.addMessage(See.only(shipPlayer),</span>
<span class="fc" id="L3270">            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="fc" id="L3271">                             &quot;combat.shipDamaged.ours&quot;, ship)</span>
<span class="fc" id="L3272">                .addStringTemplate(&quot;%location%&quot;,</span>
<span class="fc" id="L3273">                    shipLocation.getLocationLabelFor(shipPlayer))</span>
<span class="fc" id="L3274">                .addStringTemplate(&quot;%unit%&quot;, ship.getLabel())</span>
<span class="fc" id="L3275">                .addStringTemplate(&quot;%enemyUnit%&quot;, attacker.getLabel())</span>
<span class="fc" id="L3276">                .addStringTemplate(&quot;%enemyNation%&quot;, attackerNation)</span>
<span class="fc" id="L3277">                .addStringTemplate(&quot;%repairLocation%&quot;, repairLoc));</span>

<span class="fc" id="L3279">        csDamageShip(ship, repair, cs);</span>
<span class="fc" id="L3280">    }</span>

    /**
     * Damage a ship through bombard.
     *
     * @param settlement The attacker &lt;code&gt;Settlement&lt;/code&gt;.
     * @param ship The &lt;code&gt;Unit&lt;/code&gt; which is a ship to damage.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csDamageShipBombard(Settlement settlement, Unit ship,
                                     ChangeSet cs) {
<span class="nc" id="L3291">        ServerPlayer attackerPlayer = (ServerPlayer)settlement.getOwner();</span>
<span class="nc" id="L3292">        ServerPlayer shipPlayer = (ServerPlayer)ship.getOwner();</span>
<span class="nc" id="L3293">        Building building = ((Colony)settlement).getStockade();</span>
<span class="nc" id="L3294">        Location repair = ship.getRepairLocation();</span>
<span class="nc" id="L3295">        StringTemplate repairLoc = repair.getLocationLabelFor(shipPlayer);</span>
<span class="nc" id="L3296">        StringTemplate shipNation = ship.getApparentOwnerName();</span>

<span class="nc" id="L3298">        cs.addMessage(See.only(attackerPlayer),</span>
<span class="nc" id="L3299">            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="nc" id="L3300">                             &quot;combat.shipDamagedByBombardment.enemy&quot;,</span>
<span class="nc" id="L3301">                             settlement)</span>
<span class="nc" id="L3302">                .addStringTemplate(&quot;%location%&quot;,</span>
<span class="nc" id="L3303">                    settlement.getLocationLabelFor(attackerPlayer))</span>
<span class="nc" id="L3304">                .addNamed(&quot;%building%&quot;, building)</span>
<span class="nc" id="L3305">                .addStringTemplate(&quot;%enemyNation%&quot;, shipNation)</span>
<span class="nc" id="L3306">                .addStringTemplate(&quot;%enemyUnit%&quot;, ship.getLabel()));</span>
<span class="nc" id="L3307">        cs.addMessage(See.only(shipPlayer),</span>
<span class="nc" id="L3308">            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="nc" id="L3309">                             &quot;combat.shipDamagedByBombardment.ours&quot;, ship)</span>
<span class="nc" id="L3310">                .addStringTemplate(&quot;%location%&quot;,</span>
<span class="nc" id="L3311">                    settlement.getLocationLabelFor(shipPlayer))</span>
<span class="nc" id="L3312">                .addStringTemplate(&quot;%unit%&quot;, ship.getLabel())</span>
<span class="nc" id="L3313">                .addNamed(&quot;%building%&quot;, building)</span>
<span class="nc" id="L3314">                .addStringTemplate(&quot;%enemyNation%&quot;,</span>
<span class="nc" id="L3315">                    attackerPlayer.getNationLabel())</span>
<span class="nc" id="L3316">                .addStringTemplate(&quot;%repairLocation%&quot;, repairLoc));</span>

<span class="nc" id="L3318">        csDamageShip(ship, repair, cs);</span>
<span class="nc" id="L3319">    }</span>

    /**
     * Damage a ship.
     *
     * @param ship The naval &lt;code&gt;Unit&lt;/code&gt; to damage.
     * @param repair The &lt;code&gt;Location&lt;/code&gt; to send it to.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csDamageShip(Unit ship, Location repair, ChangeSet cs) {
<span class="fc" id="L3329">        ServerPlayer player = (ServerPlayer) ship.getOwner();</span>

        // Lose the goods and units aboard
<span class="pc bpc" id="L3332" title="1 of 2 branches missed.">        for (Goods g : ship.getGoodsContainer().getCompactGoods()) {</span>
<span class="nc" id="L3333">            ship.remove(g);</span>
        }
<span class="fc bfc" id="L3335" title="All 2 branches covered.">        for (Unit u : ship.getUnitList()) {</span>
<span class="fc" id="L3336">            ship.remove(u);</span>
<span class="fc" id="L3337">            cs.addRemove(See.only(player), null, u);//-vis: safe, within unit</span>
<span class="fc" id="L3338">            u.dispose();</span>
        }

        // Damage the ship and send it off for repair
<span class="pc bpc" id="L3342" title="1 of 2 branches missed.">        Location shipLoc = (repair instanceof Colony) ? repair.getTile()</span>
<span class="fc" id="L3343">            : repair;</span>
<span class="fc" id="L3344">        ship.setHitPoints(1);</span>
<span class="fc" id="L3345">        ship.setDestination(null);</span>
<span class="fc" id="L3346">        ship.setLocation(shipLoc);//-vis(player)</span>
<span class="fc" id="L3347">        ship.setState(Unit.UnitState.ACTIVE);</span>
<span class="fc" id="L3348">        ship.setMovesLeft(0);</span>
<span class="fc" id="L3349">        cs.add(See.only(player), (FreeColGameObject)shipLoc);</span>
<span class="fc" id="L3350">        player.invalidateCanSeeTiles();//+vis(player)</span>
<span class="fc" id="L3351">    }</span>

    /**
     * Demotes a unit.
     *
     * @param winner The &lt;code&gt;Unit&lt;/code&gt; that won.
     * @param loser The &lt;code&gt;Unit&lt;/code&gt; that lost and should be demoted.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csDemoteUnit(Unit winner, Unit loser, ChangeSet cs) {
<span class="fc" id="L3361">        ServerPlayer loserPlayer = (ServerPlayer) loser.getOwner();</span>
<span class="fc" id="L3362">        StringTemplate loserNation = loser.getApparentOwnerName();</span>
<span class="fc" id="L3363">        StringTemplate loserLocation = loser.getLocation()</span>
<span class="fc" id="L3364">            .getLocationLabelFor(loserPlayer);</span>
<span class="fc" id="L3365">        StringTemplate loserLabel = loser.getLabel();</span>
<span class="fc" id="L3366">        ServerPlayer winnerPlayer = (ServerPlayer) winner.getOwner();</span>
<span class="fc" id="L3367">        StringTemplate winnerNation = winner.getApparentOwnerName();</span>
<span class="fc" id="L3368">        StringTemplate winnerLocation = winner.getLocation()</span>
<span class="fc" id="L3369">            .getLocationLabelFor(winnerPlayer);</span>
        String key;
        
<span class="fc" id="L3372">        UnitType type = loser.getTypeChange(ChangeType.DEMOTION, loserPlayer);</span>
<span class="pc bpc" id="L3373" title="2 of 4 branches missed.">        if (type == null || type == loser.getType()) {</span>
<span class="nc" id="L3374">            logger.warning(&quot;Demotion failed, type=&quot;</span>
<span class="nc bnc" id="L3375" title="All 2 branches missed.">                + ((type == null) ? &quot;null&quot; : &quot;same type: &quot; + type));</span>
<span class="nc" id="L3376">            return;</span>
        }
<span class="fc" id="L3378">        loser.changeType(type);//-vis(loserPlayer)</span>
<span class="fc" id="L3379">        loserPlayer.invalidateCanSeeTiles();//+vis(loserPlayer)</span>

<span class="fc" id="L3381">        key = &quot;combat.unitDemoted.enemy.&quot; + loser.getType().getSuffix();</span>
<span class="fc" id="L3382">        cs.addMessage(See.only(winnerPlayer),</span>
<span class="fc" id="L3383">            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="fc" id="L3384">                             key, winner)</span>
<span class="fc" id="L3385">                .addDefaultId(&quot;combat.unitDemoted.enemy&quot;)</span>
<span class="fc" id="L3386">                .addStringTemplate(&quot;%location%&quot;, winnerLocation)</span>
<span class="fc" id="L3387">                .addStringTemplate(&quot;%unit%&quot;, winner.getLabel())</span>
<span class="fc" id="L3388">                .addStringTemplate(&quot;%enemyNation%&quot;, loserNation)</span>
<span class="fc" id="L3389">                .addStringTemplate(&quot;%oldName%&quot;, loserLabel)</span>
<span class="fc" id="L3390">                .addStringTemplate(&quot;%enemyUnit%&quot;, loser.getLabel()));</span>
<span class="fc" id="L3391">        key = &quot;combat.unitDemoted.ours.&quot; + loser.getType().getSuffix();</span>
<span class="fc" id="L3392">        cs.addMessage(See.only(loserPlayer),</span>
<span class="fc" id="L3393">            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="fc" id="L3394">                             key, loser)</span>
<span class="fc" id="L3395">                .addDefaultId(&quot;combat.unitDemoted.ours&quot;)</span>
<span class="fc" id="L3396">                .addStringTemplate(&quot;%location%&quot;, loserLocation)</span>
<span class="fc" id="L3397">                .addStringTemplate(&quot;%oldName%&quot;, loserLabel)</span>
<span class="fc" id="L3398">                .addStringTemplate(&quot;%unit%&quot;, loser.getLabel())</span>
<span class="fc" id="L3399">                .addStringTemplate(&quot;%enemyNation%&quot;, winnerNation)</span>
<span class="fc" id="L3400">                .addStringTemplate(&quot;%enemyUnit%&quot;, winner.getLabel()));</span>
<span class="fc" id="L3401">    }</span>

    /**
     * Destroy a colony.
     *
     * @param attacker The &lt;code&gt;Unit&lt;/code&gt; that attacked.
     * @param colony The &lt;code&gt;Colony&lt;/code&gt; that was attacked.
     * @param random A pseudo-random number source.
     * @param cs The &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csDestroyColony(Unit attacker, Colony colony, Random random,
                                 ChangeSet cs) {
<span class="fc" id="L3413">        Game game = attacker.getGame();</span>
<span class="fc" id="L3414">        ServerPlayer attackerPlayer = (ServerPlayer) attacker.getOwner();</span>
<span class="fc" id="L3415">        StringTemplate attackerNation = attacker.getApparentOwnerName();</span>
<span class="fc" id="L3416">        ServerPlayer colonyPlayer = (ServerPlayer) colony.getOwner();</span>
<span class="fc" id="L3417">        StringTemplate colonyNation = colonyPlayer.getNationLabel();</span>
<span class="fc" id="L3418">        int plunder = colony.getPlunder(attacker, random);</span>

        // Handle history and messages before colony destruction.
<span class="fc" id="L3421">        cs.addHistory(colonyPlayer,</span>
<span class="fc" id="L3422">            new HistoryEvent(game.getTurn(),</span>
<span class="fc" id="L3423">                HistoryEvent.HistoryEventType.COLONY_DESTROYED, attackerPlayer)</span>
<span class="fc" id="L3424">                .addStringTemplate(&quot;%nation%&quot;, attackerNation)</span>
<span class="fc" id="L3425">                .addName(&quot;%colony%&quot;, colony.getName()));</span>
<span class="fc" id="L3426">        cs.addMessage(See.only(colonyPlayer),</span>
<span class="fc" id="L3427">            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="fc" id="L3428">                             &quot;combat.colonyBurned.ours&quot;, colony.getTile())</span>
<span class="fc" id="L3429">                .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="fc" id="L3430">                .addStringTemplate(&quot;%enemyNation%&quot;, attackerNation)</span>
<span class="fc" id="L3431">                .addStringTemplate(&quot;%enemyUnit%&quot;, attacker.getLabel())</span>
<span class="fc" id="L3432">                .addAmount(&quot;%amount%&quot;, plunder));</span>
<span class="fc" id="L3433">        cs.addMessage(See.all().except(colonyPlayer),</span>
<span class="fc" id="L3434">            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="fc" id="L3435">                             &quot;combat.colonyBurned.other&quot;, colonyPlayer)</span>
<span class="fc" id="L3436">                .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="fc" id="L3437">                .addStringTemplate(&quot;%nation%&quot;, colonyNation)</span>
<span class="fc" id="L3438">                .addStringTemplate(&quot;%attackerNation%&quot;, attackerNation));</span>
<span class="fc" id="L3439">        colonyPlayer.csLoseLocation(colony, cs);</span>

        // Allocate some plunder.
<span class="pc bpc" id="L3442" title="1 of 2 branches missed.">        if (plunder &gt; 0) {</span>
<span class="nc" id="L3443">            attackerPlayer.modifyGold(plunder);</span>
<span class="nc" id="L3444">            colonyPlayer.modifyGold(-plunder);</span>
<span class="nc" id="L3445">            cs.addPartial(See.only(attackerPlayer), attackerPlayer, &quot;gold&quot;);</span>
<span class="nc" id="L3446">            cs.addPartial(See.only(colonyPlayer), colonyPlayer, &quot;gold&quot;);</span>
        }

        // Dispose of the colony and its contents.
<span class="fc" id="L3450">        csDisposeSettlement(colony, cs);</span>
<span class="fc" id="L3451">    }</span>

    /**
     * Destroys an Indian settlement.
     *
     * @param attacker an &lt;code&gt;Unit&lt;/code&gt; value
     * @param settlement an &lt;code&gt;IndianSettlement&lt;/code&gt; value
     * @param random A pseudo-random number source.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csDestroySettlement(Unit attacker,
                                     IndianSettlement settlement,
                                     Random random, ChangeSet cs) {
<span class="nc" id="L3464">        final Game game = getGame();</span>
<span class="nc" id="L3465">        final Specification spec = game.getSpecification();</span>
<span class="nc" id="L3466">        Tile tile = settlement.getTile();</span>
<span class="nc" id="L3467">        ServerPlayer attackerPlayer = (ServerPlayer) attacker.getOwner();</span>
<span class="nc" id="L3468">        ServerPlayer nativePlayer = (ServerPlayer) settlement.getOwner();</span>
<span class="nc" id="L3469">        StringTemplate attackerNation = attackerPlayer.getNationLabel();</span>
<span class="nc" id="L3470">        StringTemplate nativeNation = nativePlayer.getNationLabel();</span>
<span class="nc" id="L3471">        String settlementName = settlement.getName();</span>
<span class="nc" id="L3472">        boolean capital = settlement.isCapital();</span>
<span class="nc" id="L3473">        int plunder = settlement.getPlunder(attacker, random);</span>

        // Remaining units lose their home.
<span class="nc bnc" id="L3476" title="All 2 branches missed.">        for (Unit u : settlement.getOwnedUnits()) {</span>
<span class="nc" id="L3477">            u.setHomeIndianSettlement(null);</span>
<span class="nc" id="L3478">            cs.add(See.only(nativePlayer), u);</span>
        }
                
        // Destroy the settlement, update settlement tiles.
<span class="nc" id="L3482">        csDisposeSettlement(settlement, cs);</span>

        // Make the treasure train if there is treasure.
<span class="nc bnc" id="L3485" title="All 2 branches missed.">        if (plunder &gt; 0) {</span>
<span class="nc" id="L3486">            List&lt;UnitType&gt; unitTypes</span>
<span class="nc" id="L3487">                = spec.getUnitTypesWithAbility(Ability.CARRY_TREASURE);</span>
<span class="nc" id="L3488">            UnitType type = getRandomMember(logger, &quot;Choose train&quot;,</span>
<span class="nc" id="L3489">                                            unitTypes, random);</span>
<span class="nc" id="L3490">            Unit train = new ServerUnit(game, tile, attackerPlayer,</span>
<span class="nc" id="L3491">                                        type);//-vis: safe, attacker on tile</span>
<span class="nc" id="L3492">            train.setTreasureAmount(plunder);</span>
        }

        // This is an atrocity.
<span class="nc" id="L3496">        int score = spec.getInteger(GameOptions.DESTROY_SETTLEMENT_SCORE);</span>
<span class="nc" id="L3497">        HistoryEvent h = new HistoryEvent(game.getTurn(),</span>
<span class="nc" id="L3498">            HistoryEvent.HistoryEventType.DESTROY_SETTLEMENT, this)</span>
<span class="nc" id="L3499">                .addStringTemplate(&quot;%nation%&quot;, nativeNation)</span>
<span class="nc" id="L3500">                .addName(&quot;%settlement%&quot;, settlementName);</span>
<span class="nc" id="L3501">        h.setScore(score);</span>
<span class="nc" id="L3502">        cs.addHistory(attackerPlayer, h);</span>

        // Finish with messages and history.
<span class="nc" id="L3505">        cs.addMessage(See.only(attackerPlayer),</span>
<span class="nc" id="L3506">            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="nc" id="L3507">                             &quot;combat.destroySettlement.enemy&quot;, attacker)</span>
<span class="nc" id="L3508">                .addName(&quot;%settlement%&quot;, settlementName)</span>
<span class="nc" id="L3509">                .addStringTemplate(&quot;%unit%&quot;, attacker.getLabel())</span>
<span class="nc" id="L3510">                .addStringTemplate(&quot;%nativeNation%&quot;, nativeNation)</span>
<span class="nc" id="L3511">                .addAmount(&quot;%amount%&quot;, plunder));</span>
<span class="nc bnc" id="L3512" title="All 2 branches missed.">        if (capital) {</span>
<span class="nc" id="L3513">            cs.addMessage(See.only(attackerPlayer),</span>
<span class="nc" id="L3514">                new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,</span>
<span class="nc" id="L3515">                                 &quot;combat.destroySettlement.enemy.capital&quot;,</span>
<span class="nc" id="L3516">                                 attacker)</span>
<span class="nc" id="L3517">                    .addStringTemplate(&quot;%nation%&quot;, nativeNation));</span>
        }
<span class="nc bnc" id="L3519" title="All 2 branches missed.">        if (nativePlayer.checkForDeath() == IS_DEAD) {</span>
<span class="nc" id="L3520">            h = new HistoryEvent(game.getTurn(),</span>
<span class="nc" id="L3521">                HistoryEvent.HistoryEventType.DESTROY_NATION, this)</span>
<span class="nc" id="L3522">                    .addStringTemplate(&quot;%nation%&quot;, attackerNation)</span>
<span class="nc" id="L3523">                    .addStringTemplate(&quot;%nativeNation%&quot;, nativeNation);</span>
<span class="nc" id="L3524">            h.setScore(SCORE_NATION_DESTROYED);</span>
<span class="nc" id="L3525">            cs.addGlobalHistory(game, h);</span>
        }
<span class="nc" id="L3527">        cs.addAttribute(See.only(attackerPlayer), &quot;sound&quot;,</span>
<span class="nc" id="L3528">            &quot;sound.event.destroySettlement&quot;);</span>
<span class="nc" id="L3529">    }</span>

    /**
     * Disposes of a settlement and reassign its tiles.
     *
     * +vis,til: Resolves the whole mess.
     *
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; under attack.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csDisposeSettlement(Settlement settlement, ChangeSet cs) {
<span class="fc" id="L3540">        logger.finest(&quot;Disposing of &quot; + settlement.getName());</span>
<span class="fc" id="L3541">        ServerPlayer owner = (ServerPlayer)settlement.getOwner();</span>
<span class="fc" id="L3542">        Set&lt;Tile&gt; owned = settlement.getOwnedTiles();</span>
<span class="fc bfc" id="L3543" title="All 2 branches covered.">        for (Tile t : owned) t.cacheUnseen();//+til</span>
<span class="fc" id="L3544">        Tile centerTile = settlement.getTile();</span>
<span class="fc" id="L3545">        ServerPlayer missionaryOwner = null;</span>
<span class="fc" id="L3546">        int radius = 0;</span>

        // Get rid of the any missionary first.
<span class="pc bpc" id="L3549" title="1 of 2 branches missed.">        if (settlement instanceof ServerIndianSettlement) {</span>
<span class="nc" id="L3550">            ServerIndianSettlement sis = (ServerIndianSettlement)settlement;</span>
<span class="nc bnc" id="L3551" title="All 2 branches missed.">            if (sis.hasMissionary()) {</span>
<span class="nc" id="L3552">                missionaryOwner = (ServerPlayer)sis.getMissionary().getOwner();</span>
<span class="nc" id="L3553">                radius = sis.getMissionaryLineOfSight();</span>
<span class="nc" id="L3554">                sis.csKillMissionary(true, cs);</span>
            }
        }
            
        // Get it off the map and off the owners list.
<span class="fc" id="L3559">        settlement.exciseSettlement();//-vis(owner),-til</span>
<span class="fc" id="L3560">        owner.removeSettlement(settlement);</span>
<span class="pc bpc" id="L3561" title="1 of 2 branches missed.">        if (owner.hasSettlement(settlement)) {</span>
<span class="nc" id="L3562">            throw new IllegalStateException(&quot;Still has settlement: &quot;</span>
<span class="nc" id="L3563">                + settlement);</span>
        }

        // Reassign the tiles owned by the settlement, if possible
<span class="fc" id="L3567">        reassignTiles(owned, owner, null);</span>

<span class="fc" id="L3569">        See vis = See.perhaps().always(owner);</span>
<span class="pc bpc" id="L3570" title="1 of 2 branches missed.">        if (missionaryOwner != null) vis.except(missionaryOwner);</span>
<span class="fc" id="L3571">        cs.add(vis, owned);</span>
<span class="fc" id="L3572">        cs.addRemove(vis, centerTile, settlement);//-vis(owner)</span>
<span class="fc" id="L3573">        settlement.dispose();</span>
<span class="fc" id="L3574">        owner.invalidateCanSeeTiles();//+vis(owner)</span>

        // Former missionary owner knows that the settlement fell.
<span class="pc bpc" id="L3577" title="1 of 2 branches missed.">        if (missionaryOwner != null) {</span>
<span class="nc" id="L3578">            List&lt;Tile&gt; surrounding = transform(centerTile.getSurroundingTiles(1, radius),</span>
<span class="nc bnc" id="L3579" title="All 2 branches missed.">                t -&gt; !owned.contains(t), Collectors.toList());</span>
<span class="nc" id="L3580">            cs.add(See.only(missionaryOwner), owned);</span>
<span class="nc" id="L3581">            cs.add(See.only(missionaryOwner), surrounding);</span>
<span class="nc" id="L3582">            cs.addRemove(See.only(missionaryOwner), centerTile, settlement);</span>
<span class="nc" id="L3583">            missionaryOwner.invalidateCanSeeTiles();//+vis(missionaryOwner)</span>
<span class="nc bnc" id="L3584" title="All 2 branches missed.">            for (Tile t : surrounding) t.cacheUnseen(missionaryOwner);</span>
        }

        // Recache, should only show now cleared tiles to former owner.
<span class="fc bfc" id="L3588" title="All 2 branches covered.">        for (Tile t : owned) t.cacheUnseen();</span>
        // Center tile is special for native settlements.  Because
        // native settlement tiles are *always* cached, the cache
        // needs to be completely cleared for players that can see the
        // settlement is gone.
<span class="pc bpc" id="L3593" title="1 of 2 branches missed.">        if (settlement instanceof IndianSettlement) centerTile.seeTile();</span>
<span class="pc bpc" id="L3594" title="1 of 2 branches missed.">        if (missionaryOwner != null) centerTile.seeTile(missionaryOwner);</span>
<span class="fc" id="L3595">    }</span>

    /**
     * Evade a normal attack.
     *
     * @param attacker The attacker &lt;code&gt;Unit&lt;/code&gt;.
     * @param defender A naval &lt;code&gt;Unit&lt;/code&gt; that evades the attacker.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csEvadeAttack(Unit attacker, Unit defender, ChangeSet cs) {
<span class="nc" id="L3605">        ServerPlayer attackerPlayer = (ServerPlayer) attacker.getOwner();</span>
<span class="nc" id="L3606">        StringTemplate attackerNation = attacker.getApparentOwnerName();</span>
<span class="nc" id="L3607">        Location attackerLocation = attacker.getLocation();</span>
<span class="nc" id="L3608">        ServerPlayer defenderPlayer = (ServerPlayer) defender.getOwner();</span>
<span class="nc" id="L3609">        StringTemplate defenderNation = defender.getApparentOwnerName();</span>
<span class="nc" id="L3610">        Location defenderLocation = defender.getLocation();</span>

<span class="nc" id="L3612">        cs.addMessage(See.only(attackerPlayer),</span>
<span class="nc" id="L3613">            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="nc" id="L3614">                             &quot;combat.shipEvaded.enemy&quot;, attacker)</span>
<span class="nc" id="L3615">                .addStringTemplate(&quot;%location%&quot;,</span>
<span class="nc" id="L3616">                    attackerLocation.getLocationLabelFor(attackerPlayer))</span>
<span class="nc" id="L3617">                .addStringTemplate(&quot;%unit%&quot;, attacker.getLabel())</span>
<span class="nc" id="L3618">                .addStringTemplate(&quot;%enemyNation%&quot;, defenderNation)</span>
<span class="nc" id="L3619">                .addStringTemplate(&quot;%enemyUnit%&quot;, defender.getLabel()));</span>
<span class="nc" id="L3620">        cs.addMessage(See.only(defenderPlayer),</span>
<span class="nc" id="L3621">            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="nc" id="L3622">                             &quot;combat.shipEvaded.ours&quot;, defender)</span>
<span class="nc" id="L3623">                .addStringTemplate(&quot;%location%&quot;,</span>
<span class="nc" id="L3624">                    defenderLocation.getLocationLabelFor(defenderPlayer))</span>
<span class="nc" id="L3625">                .addStringTemplate(&quot;%unit%&quot;, defender.getLabel())</span>
<span class="nc" id="L3626">                .addStringTemplate(&quot;%enemyNation%&quot;, attackerNation)</span>
<span class="nc" id="L3627">                .addStringTemplate(&quot;%enemyUnit%&quot;, attacker.getLabel()));</span>
<span class="nc" id="L3628">    }</span>

    /**
     * Evade a bombardment.
     *
     * @param settlement The attacker &lt;code&gt;Settlement&lt;/code&gt;.
     * @param defender A naval &lt;code&gt;Unit&lt;/code&gt; that evades the attacker.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csEvadeBombard(Settlement settlement, Unit defender,
                                ChangeSet cs) {
<span class="nc" id="L3639">        ServerPlayer attackerPlayer = (ServerPlayer) settlement.getOwner();</span>
<span class="nc" id="L3640">        ServerPlayer defenderPlayer = (ServerPlayer) defender.getOwner();</span>
<span class="nc" id="L3641">        StringTemplate defenderNation = defender.getApparentOwnerName();</span>
<span class="nc" id="L3642">        Building building = ((Colony)settlement).getStockade();</span>

<span class="nc" id="L3644">        cs.addMessage(See.only(attackerPlayer),</span>
<span class="nc" id="L3645">            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="nc" id="L3646">                             &quot;combat.shipEvadedBombardment.enemy&quot;, settlement)</span>
<span class="nc" id="L3647">                .addStringTemplate(&quot;%location%&quot;,</span>
<span class="nc" id="L3648">                    settlement.getLocationLabelFor(attackerPlayer))</span>
<span class="nc" id="L3649">                .addNamed(&quot;%building%&quot;, building)</span>
<span class="nc" id="L3650">                .addStringTemplate(&quot;%enemyNation%&quot;, defenderNation)</span>
<span class="nc" id="L3651">                .addStringTemplate(&quot;%enemyUnit%&quot;, defender.getLabel()));</span>
<span class="nc" id="L3652">        cs.addMessage(See.only(defenderPlayer),</span>
<span class="nc" id="L3653">            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="nc" id="L3654">                             &quot;combat.shipEvadedBombardment.ours&quot;, defender)</span>
<span class="nc" id="L3655">                .addStringTemplate(&quot;%location%&quot;,</span>
<span class="nc" id="L3656">                    settlement.getLocationLabelFor(defenderPlayer))</span>
<span class="nc" id="L3657">                .addStringTemplate(&quot;%unit%&quot;, defender.getLabel())</span>
<span class="nc" id="L3658">                .addNamed(&quot;%building%&quot;, building)</span>
<span class="nc" id="L3659">                .addStringTemplate(&quot;%enemyNation%&quot;,</span>
<span class="nc" id="L3660">                    attackerPlayer.getNationLabel()));</span>
<span class="nc" id="L3661">    }</span>

    /**
     * Loot a ship.
     *
     * @param winner The winning naval &lt;code&gt;Unit&lt;/code&gt;.
     * @param loser The losing naval &lt;code&gt;Unit&lt;/code&gt;
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csLootShip(Unit winner, Unit loser, ChangeSet cs) {
<span class="fc" id="L3671">        ServerPlayer winnerPlayer = (ServerPlayer) winner.getOwner();</span>
<span class="fc" id="L3672">        List&lt;Goods&gt; capture = loser.getGoodsList();</span>
<span class="pc bpc" id="L3673" title="2 of 4 branches missed.">        if (!capture.isEmpty() &amp;&amp; winner.hasSpaceLeft()) {</span>
<span class="fc bfc" id="L3674" title="All 2 branches covered.">            for (Goods g : capture) g.setLocation(null);</span>
<span class="fc" id="L3675">            new LootSession(winner, loser, capture);</span>
<span class="fc" id="L3676">            cs.add(See.only(winnerPlayer), ChangeSet.ChangePriority.CHANGE_LATE,</span>
<span class="fc" id="L3677">                new LootCargoMessage(winner, loser.getId(), capture));</span>
        }
<span class="fc" id="L3679">        loser.getGoodsContainer().removeAll();</span>
<span class="fc" id="L3680">        loser.setState(Unit.UnitState.ACTIVE);</span>
<span class="fc" id="L3681">    }</span>

    /**
     * Unit auto equips but loses equipment.
     *
     * @param attacker The &lt;code&gt;Unit&lt;/code&gt; that attacked.
     * @param defender The &lt;code&gt;Unit&lt;/code&gt; that defended and loses equipment.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csLoseAutoEquip(Unit attacker, Unit defender, ChangeSet cs) {
<span class="fc" id="L3691">        ServerPlayer defenderPlayer = (ServerPlayer) defender.getOwner();</span>
<span class="fc" id="L3692">        StringTemplate defenderNation = defenderPlayer.getNationLabel();</span>
<span class="fc" id="L3693">        Settlement settlement = defender.getSettlement();</span>
<span class="fc" id="L3694">        StringTemplate defenderLocation = defender.getLocation()</span>
<span class="fc" id="L3695">            .getLocationLabelFor(defenderPlayer);</span>
<span class="fc" id="L3696">        Role role = defender.getAutomaticRole();</span>
<span class="fc" id="L3697">        StringTemplate defenderLabel = Messages.getUnitLabel(null,</span>
<span class="fc" id="L3698">            defender.getType().getId(), 1, defenderPlayer.getNation().getId(),</span>
<span class="fc" id="L3699">            role.getId(), null);</span>
<span class="fc" id="L3700">        ServerPlayer attackerPlayer = (ServerPlayer) attacker.getOwner();</span>
<span class="fc" id="L3701">        StringTemplate attackerLocation = attacker.getLocation()</span>
<span class="fc" id="L3702">            .getLocationLabelFor(attackerPlayer);</span>
<span class="fc" id="L3703">        StringTemplate attackerNation = attacker.getApparentOwnerName();</span>

        // Autoequipment is not actually with the unit, it is stored
        // in the settlement of the unit.  Remove it from there.
<span class="fc bfc" id="L3707" title="All 2 branches covered.">        for (AbstractGoods ag : role.getRequiredGoods()) {</span>
<span class="fc" id="L3708">            settlement.removeGoods(ag);</span>
        }

        // No special message, attacker can not distinguish auto-armed
        // from actual-armed.
<span class="fc" id="L3713">        cs.addMessage(See.only(attackerPlayer),</span>
<span class="fc" id="L3714">            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="fc" id="L3715">                             &quot;combat.unitDemotedToUnarmed.enemy&quot;, attacker)</span>
<span class="fc" id="L3716">                .addStringTemplate(&quot;%location%&quot;,</span>
<span class="fc" id="L3717">                     settlement.getLocationLabelFor(attackerPlayer))</span>
<span class="fc" id="L3718">                .addStringTemplate(&quot;%unit%&quot;, attacker.getLabel())</span>
<span class="fc" id="L3719">                .addStringTemplate(&quot;%oldName%&quot;, defenderLabel)</span>
<span class="fc" id="L3720">                .addStringTemplate(&quot;%enemyNation%&quot;, defenderNation)</span>
<span class="fc" id="L3721">                .addStringTemplate(&quot;%enemyUnit%&quot;, defender.getLabel()));</span>
<span class="fc" id="L3722">        cs.addMessage(See.only(defenderPlayer),</span>
<span class="fc" id="L3723">            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="fc" id="L3724">                             &quot;combat.unitLoseAutoEquip&quot;, defender)</span>
<span class="fc" id="L3725">                .addStringTemplate(&quot;%location%&quot;,</span>
<span class="fc" id="L3726">                    settlement.getLocationLabelFor(defenderPlayer))</span>
<span class="fc" id="L3727">                .addStringTemplate(&quot;%unit%&quot;, defender.getLabel())</span>
<span class="fc" id="L3728">                .addStringTemplate(&quot;%enemyNation%&quot;, attackerNation)</span>
<span class="fc" id="L3729">                .addStringTemplate(&quot;%enemyUnit%&quot;, attacker.getLabel()));</span>
<span class="fc" id="L3730">    }</span>

    /**
     * Unit drops some equipment.
     *
     * @param winner The &lt;code&gt;Unit&lt;/code&gt; that won.
     * @param loser The &lt;code&gt;Unit&lt;/code&gt; that lost and loses equipment.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csLoseEquip(Unit winner, Unit loser, ChangeSet cs) {
<span class="fc" id="L3740">        final Specification spec = getSpecification();</span>
<span class="fc" id="L3741">        ServerPlayer loserPlayer = (ServerPlayer) loser.getOwner();</span>
<span class="fc" id="L3742">        StringTemplate loserNation = loserPlayer.getNationLabel();</span>
<span class="fc" id="L3743">        StringTemplate loserLocation = loser.getLocation()</span>
<span class="fc" id="L3744">            .getLocationLabelFor(loserPlayer);</span>
<span class="fc" id="L3745">        StringTemplate loserLabel = loser.getLabel();</span>
<span class="fc" id="L3746">        ServerPlayer winnerPlayer = (ServerPlayer) winner.getOwner();</span>
<span class="fc" id="L3747">        StringTemplate winnerNation = winner.getApparentOwnerName();</span>
<span class="fc" id="L3748">        StringTemplate winnerLocation = winner.getLocation()</span>
<span class="fc" id="L3749">            .getLocationLabelFor(winnerPlayer);</span>
<span class="fc" id="L3750">        Role role = loser.getRole();</span>
        String key;

<span class="fc" id="L3753">        Role downgrade = role.getDowngrade();</span>
<span class="fc bfc" id="L3754" title="All 2 branches covered.">        if (downgrade != null) {</span>
<span class="fc" id="L3755">            loser.changeRole(downgrade, 1);</span>
<span class="fc" id="L3756">        } else {</span>
<span class="fc" id="L3757">            loser.changeRole(spec.getDefaultRole(), 0);</span>
        }

        // Account for possible loss of mobility due to horses going away.
<span class="fc" id="L3761">        loser.setMovesLeft(Math.min(loser.getMovesLeft(),</span>
<span class="fc" id="L3762">                                    loser.getInitialMovesLeft()));</span>

<span class="fc bfc" id="L3764" title="All 2 branches covered.">        if (!loser.isArmed()) {</span>
<span class="fc" id="L3765">            cs.addMessage(See.only(winnerPlayer),</span>
<span class="fc" id="L3766">                new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="fc" id="L3767">                                 &quot;combat.unitDemotedToUnarmed.enemy&quot;, winner)</span>
<span class="fc" id="L3768">                    .addStringTemplate(&quot;%location%&quot;, winnerLocation)</span>
<span class="fc" id="L3769">                    .addStringTemplate(&quot;%unit%&quot;, winner.getLabel())</span>
<span class="fc" id="L3770">                    .addStringTemplate(&quot;%oldName%&quot;, loserLabel)</span>
<span class="fc" id="L3771">                    .addStringTemplate(&quot;%enemyNation%&quot;, loserNation)</span>
<span class="fc" id="L3772">                    .addStringTemplate(&quot;%enemyUnit%&quot;, loser.getLabel()));</span>
<span class="fc" id="L3773">            cs.addMessage(See.only(loserPlayer),</span>
<span class="fc" id="L3774">                new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="fc" id="L3775">                                 &quot;combat.unitDemotedToUnarmed.ours&quot;, loser)</span>
<span class="fc" id="L3776">                    .addStringTemplate(&quot;%location%&quot;, loserLocation)</span>
<span class="fc" id="L3777">                    .addStringTemplate(&quot;%oldName%&quot;, loserLabel)</span>
<span class="fc" id="L3778">                    .addStringTemplate(&quot;%unit%&quot;, loser.getLabel())</span>
<span class="fc" id="L3779">                    .addStringTemplate(&quot;%enemyNation%&quot;, winnerNation)</span>
<span class="fc" id="L3780">                    .addStringTemplate(&quot;%enemyUnit%&quot;, winner.getLabel()));</span>
<span class="fc" id="L3781">            loser.setState(Unit.UnitState.ACTIVE);</span>
<span class="fc" id="L3782">        } else {</span>
<span class="fc" id="L3783">            key = &quot;combat.unitDemoted.enemy.&quot; + loser.getType().getSuffix();</span>
<span class="fc" id="L3784">            cs.addMessage(See.only(winnerPlayer),</span>
<span class="fc" id="L3785">                new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="fc" id="L3786">                                 key, winner)</span>
<span class="fc" id="L3787">                    .addDefaultId(&quot;combat.unitDemoted.enemy&quot;)</span>
<span class="fc" id="L3788">                    .addStringTemplate(&quot;%location%&quot;, winnerLocation)</span>
<span class="fc" id="L3789">                    .addStringTemplate(&quot;%unit%&quot;, winner.getLabel())</span>
<span class="fc" id="L3790">                    .addStringTemplate(&quot;%oldName%&quot;, loserLabel)</span>
<span class="fc" id="L3791">                    .addStringTemplate(&quot;%enemyNation%&quot;, loserNation)</span>
<span class="fc" id="L3792">                    .addStringTemplate(&quot;%enemyUnit%&quot;, loser.getLabel()));</span>
<span class="fc" id="L3793">            key = &quot;combat.unitDemoted.ours.&quot; + loser.getType().getSuffix();</span>
<span class="fc" id="L3794">            cs.addMessage(See.only(loserPlayer),</span>
<span class="fc" id="L3795">                new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="fc" id="L3796">                                 key, loser)</span>
<span class="fc" id="L3797">                    .addDefaultId(&quot;combat.unitDemoted.ours&quot;)</span>
<span class="fc" id="L3798">                    .addStringTemplate(&quot;%location%&quot;, loserLocation)</span>
<span class="fc" id="L3799">                    .addStringTemplate(&quot;%oldName%&quot;, loserLabel)</span>
<span class="fc" id="L3800">                    .addStringTemplate(&quot;%unit%&quot;, loser.getLabel())</span>
<span class="fc" id="L3801">                    .addStringTemplate(&quot;%enemyNation%&quot;, winnerNation)</span>
<span class="fc" id="L3802">                    .addStringTemplate(&quot;%enemyUnit%&quot;, winner.getLabel()));</span>
        }
<span class="fc" id="L3804">    }</span>

    /**
     * Hook for when a player loses access to a location for whatever
     * reason.  Useful for disabling trade routes.
     *
     * @param loc The &lt;code&gt;Location&lt;/code&gt; that was lost.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csLoseLocation(Location loc, ChangeSet cs) {
<span class="pc bpc" id="L3814" title="1 of 2 branches missed.">        for (TradeRoute tr : getTradeRoutes()) {</span>
<span class="nc" id="L3815">            boolean suspend = false;</span>
<span class="nc" id="L3816">            Iterator&lt;TradeRouteStop&gt; trsi = tr.getStops().iterator();</span>
<span class="nc bnc" id="L3817" title="All 2 branches missed.">            while (trsi.hasNext()) {</span>
<span class="nc" id="L3818">                TradeRouteStop trs = trsi.next();</span>
<span class="nc bnc" id="L3819" title="All 2 branches missed.">                if (Map.isSameLocation(trs.getLocation(), loc)) {</span>
<span class="nc" id="L3820">                    suspend = true;</span>
<span class="nc" id="L3821">                    trsi.remove();</span>
                }
            }
<span class="nc bnc" id="L3824" title="All 2 branches missed.">            if (suspend) {</span>
<span class="nc bnc" id="L3825" title="All 2 branches missed.">                for (Unit u : tr.getAssignedUnits()) {</span>
<span class="nc" id="L3826">                    u.setTradeRoute(null);</span>
<span class="nc" id="L3827">                    cs.add(See.only(this), u);</span>
                }
<span class="nc" id="L3829">                cs.addMessage(See.only(this),</span>
<span class="nc" id="L3830">                    new ModelMessage(ModelMessage.MessageType.GOODS_MOVEMENT,</span>
<span class="nc" id="L3831">                                     &quot;combat.tradeRouteSuspended&quot;, this)</span>
<span class="nc" id="L3832">                        .addName(&quot;%route%&quot;, tr.getName())</span>
<span class="nc" id="L3833">                        .addStringTemplate(&quot;%stop%&quot;, loc.getLocationLabel()));</span>
<span class="nc" id="L3834">                cs.add(See.only(this), tr);</span>
            }
        }
<span class="fc" id="L3837">    }</span>

    /**
     * Damage a building or a ship or steal some goods or gold.
     *
     * @param attacker The attacking &lt;code&gt;Unit&lt;/code&gt;.
     * @param colony The &lt;code&gt;Colony&lt;/code&gt; to pillage.
     * @param random A pseudo-random number source.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csPillageColony(Unit attacker, Colony colony,
                                 Random random, ChangeSet cs) {
<span class="fc" id="L3849">        ServerPlayer attackerPlayer = (ServerPlayer) attacker.getOwner();</span>
<span class="fc" id="L3850">        StringTemplate attackerNation = attacker.getApparentOwnerName();</span>
<span class="fc" id="L3851">        ServerPlayer colonyPlayer = (ServerPlayer) colony.getOwner();</span>
<span class="fc" id="L3852">        StringTemplate colonyNation = colonyPlayer.getNationLabel();</span>

        // Collect the damagable buildings, ships, movable goods.
<span class="fc" id="L3855">        List&lt;Building&gt; buildingList = colony.getBurnableBuildings();</span>
<span class="fc" id="L3856">        List&lt;Unit&gt; shipList = colony.getTile().getNavalUnits();</span>
<span class="fc" id="L3857">        List&lt;Goods&gt; goodsList = colony.getLootableGoodsList();</span>

        // Pick one, with one extra choice for stealing gold.
<span class="fc" id="L3860">        int pillage = randomInt(logger, &quot;Pillage choice&quot;, random,</span>
<span class="fc" id="L3861">            buildingList.size() + shipList.size() + goodsList.size()</span>
<span class="fc bfc" id="L3862" title="All 2 branches covered.">            + ((colony.canBePlundered()) ? 1 : 0));</span>
<span class="fc bfc" id="L3863" title="All 2 branches covered.">        if (pillage &lt; buildingList.size()) {</span>
<span class="fc" id="L3864">            Building building = buildingList.get(pillage);</span>
<span class="fc" id="L3865">            csDamageBuilding(building, cs);</span>
<span class="fc" id="L3866">            cs.addMessage(See.only(colonyPlayer),</span>
<span class="fc" id="L3867">                new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="fc" id="L3868">                                 &quot;combat.raid.building&quot;, colony)</span>
<span class="fc" id="L3869">                    .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="fc" id="L3870">                    .addNamed(&quot;%building%&quot;, building)</span>
<span class="fc" id="L3871">                    .addStringTemplate(&quot;%enemyNation%&quot;, attackerNation)</span>
<span class="fc" id="L3872">                    .addStringTemplate(&quot;%enemyUnit%&quot;, attacker.getLabel()));</span>
<span class="fc bfc" id="L3873" title="All 2 branches covered.">        } else if (pillage &lt; buildingList.size() + shipList.size()) {</span>
<span class="fc" id="L3874">            Unit ship = shipList.get(pillage - buildingList.size());</span>
<span class="pc bpc" id="L3875" title="1 of 2 branches missed.">            if (ship.getRepairLocation() == null) {</span>
<span class="nc" id="L3876">                csSinkShipAttack(attacker, ship, cs);</span>
<span class="nc" id="L3877">            } else {</span>
<span class="fc" id="L3878">                csDamageShipAttack(attacker, ship, cs);</span>
            }
<span class="fc" id="L3880">        } else if (pillage &lt; buildingList.size() + shipList.size()</span>
<span class="fc bfc" id="L3881" title="All 2 branches covered.">                   + goodsList.size()) {</span>
<span class="fc" id="L3882">            Goods goods = goodsList.get(pillage - buildingList.size()</span>
<span class="fc" id="L3883">                - shipList.size());</span>
<span class="fc" id="L3884">            goods.setAmount(Math.min(goods.getAmount() / 2, 50));</span>
<span class="fc" id="L3885">            colony.removeGoods(goods);</span>
<span class="pc bpc" id="L3886" title="1 of 2 branches missed.">            if (attacker.canAdd(goods)) attacker.add(goods);</span>
<span class="fc" id="L3887">            cs.addMessage(See.only(colonyPlayer),</span>
<span class="fc" id="L3888">                new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="fc" id="L3889">                                 &quot;combat.raid.goods&quot;, colony, goods)</span>
<span class="fc" id="L3890">                    .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="fc" id="L3891">                    .addAmount(&quot;%amount%&quot;, goods.getAmount())</span>
<span class="fc" id="L3892">                    .addNamed(&quot;%goods%&quot;, goods.getType())</span>
<span class="fc" id="L3893">                    .addStringTemplate(&quot;%enemyNation%&quot;, attackerNation)</span>
<span class="fc" id="L3894">                    .addStringTemplate(&quot;%enemyUnit%&quot;, attacker.getLabel()));</span>

<span class="fc" id="L3896">        } else {</span>
<span class="fc" id="L3897">            int plunder = Math.max(1, colony.getPlunder(attacker, random) / 5);</span>
<span class="fc" id="L3898">            colonyPlayer.modifyGold(-plunder);</span>
<span class="fc" id="L3899">            attackerPlayer.modifyGold(plunder);</span>
<span class="fc" id="L3900">            cs.addPartial(See.only(colonyPlayer), colonyPlayer, &quot;gold&quot;);</span>
<span class="fc" id="L3901">            cs.addMessage(See.only(colonyPlayer),</span>
<span class="fc" id="L3902">                new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="fc" id="L3903">                                 &quot;combat.raid.plunder&quot;, colony)</span>
<span class="fc" id="L3904">                    .addAmount(&quot;%amount%&quot;, plunder)</span>
<span class="fc" id="L3905">                    .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="fc" id="L3906">                    .addStringTemplate(&quot;%enemyNation%&quot;, attackerNation)</span>
<span class="fc" id="L3907">                    .addStringTemplate(&quot;%enemyUnit%&quot;, attacker.getLabel()));</span>
        }
<span class="fc" id="L3909">        cs.addMessage(See.all().except(colonyPlayer),</span>
<span class="fc" id="L3910">            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="fc" id="L3911">                             &quot;combat.raid.other&quot;, colonyPlayer)</span>
<span class="fc" id="L3912">                .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="fc" id="L3913">                .addStringTemplate(&quot;%colonyNation%&quot;, colonyNation)</span>
<span class="fc" id="L3914">                .addStringTemplate(&quot;%nation%&quot;, attackerNation));</span>
<span class="fc" id="L3915">    }</span>

    /**
     * Damage a building in a colony by downgrading it if possible and
     * destroying it otherwise.
     *
     * This is called as a result of pillaging, which always updates
     * the colony tile.
     *
     * @param building The &lt;code&gt;Building&lt;/code&gt; to damage.
     * @param cs a &lt;code&gt;ChangeSet&lt;/code&gt; value
     */
    private void csDamageBuilding(Building building, ChangeSet cs) {
<span class="fc" id="L3928">        ServerColony colony = (ServerColony)building.getColony();</span>
<span class="fc" id="L3929">        Tile copied = colony.getTile().getTileToCache();</span>
<span class="fc" id="L3930">        boolean changed = false;</span>
<span class="fc" id="L3931">        BuildingType type = building.getType();</span>
<span class="pc bpc" id="L3932" title="1 of 2 branches missed.">        if (type.getUpgradesFrom() == null) {</span>
<span class="fc" id="L3933">            changed = colony.ejectUnits(building, building.getUnitList());//-til</span>
<span class="fc" id="L3934">            colony.destroyBuilding(building);//-til</span>
<span class="fc" id="L3935">            changed |= building.getType().isDefenceType();</span>
<span class="fc" id="L3936">            cs.addRemove(See.only((ServerPlayer)colony.getOwner()), colony, </span>
<span class="fc" id="L3937">                         building);//-vis: safe, buildings are ok</span>
<span class="fc" id="L3938">            building.dispose();</span>
            // Have any abilities been removed that gate other production,
            // e.g. removing docks should shut down fishing.
<span class="fc bfc" id="L3941" title="All 2 branches covered.">            for (WorkLocation wl : colony.getAllWorkLocations()) {</span>
<span class="pc bpc" id="L3942" title="1 of 4 branches missed.">                if (!wl.isEmpty() &amp;&amp; !wl.canBeWorked()) {</span>
<span class="nc" id="L3943">                    changed |= colony.ejectUnits(wl, wl.getUnitList());//-til</span>
<span class="nc" id="L3944">                    logger.info(&quot;Units ejected from workLocation &quot;</span>
<span class="nc" id="L3945">                        + wl.getId() + &quot; on loss of &quot;</span>
<span class="nc" id="L3946">                        + building.getType().getSuffix());</span>
                }
            }
<span class="pc bnc" id="L3949" title="All 2 branches missed.">        } else if (building.canBeDamaged()) {</span>
<span class="nc" id="L3950">            changed = colony.ejectUnits(building, building.downgrade());//-til</span>
<span class="nc" id="L3951">            changed |= building.getType().isDefenceType();</span>
<span class="nc" id="L3952">        } else {</span>
<span class="nc" id="L3953">            return;</span>
        }
<span class="pc bpc" id="L3955" title="1 of 2 branches missed.">        if (changed) colony.getTile().cacheUnseen(copied);//+til</span>
<span class="pc bpc" id="L3956" title="1 of 2 branches missed.">        if (isAI()) {</span>
<span class="fc" id="L3957">            colony.firePropertyChange(Colony.REARRANGE_WORKERS, true, false);</span>
        }
<span class="fc" id="L3959">    }</span>


    /**
     * Promotes a unit.
     *
     * @param winner The &lt;code&gt;Unit&lt;/code&gt; that won and should be promoted.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csPromoteUnit(Unit winner, ChangeSet cs) {
<span class="fc" id="L3969">        ServerPlayer winnerPlayer = (ServerPlayer) winner.getOwner();</span>
<span class="fc" id="L3970">        StringTemplate winnerLabel = winner.getLabel();</span>

<span class="fc" id="L3972">        UnitType type = winner.getTypeChange(ChangeType.PROMOTION,</span>
<span class="fc" id="L3973">                                             winnerPlayer);</span>
<span class="pc bpc" id="L3974" title="2 of 4 branches missed.">        if (type == null || type == winner.getType()) {</span>
<span class="nc" id="L3975">            logger.warning(&quot;Promotion failed, type=&quot;</span>
<span class="nc bnc" id="L3976" title="All 2 branches missed.">                + ((type == null) ? &quot;null&quot; : &quot;same type: &quot; + type));</span>
<span class="nc" id="L3977">            return;</span>
        }
<span class="fc" id="L3979">        winner.changeType(type);//-vis(winnerPlayer)</span>
<span class="fc" id="L3980">        winnerPlayer.invalidateCanSeeTiles();//+vis(winnerPlayer)</span>

<span class="fc" id="L3982">        cs.addMessage(See.only(winnerPlayer),</span>
<span class="fc" id="L3983">            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="fc" id="L3984">                             &quot;combat.unitPromoted&quot;, winner)</span>
<span class="fc" id="L3985">                .addStringTemplate(&quot;%oldName%&quot;, winnerLabel)</span>
<span class="fc" id="L3986">                .addStringTemplate(&quot;%unit%&quot;, winner.getLabel()));</span>
<span class="fc" id="L3987">    }</span>

    /**
     * Sinks all ships in a colony.
     *
     * @param attacker The attacker &lt;code&gt;Unit&lt;/code&gt;.
     * @param colony The &lt;code&gt;Colony&lt;/code&gt; to sink ships in.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csSinkColonyShips(Unit attacker, Colony colony, ChangeSet cs) {
<span class="nc" id="L3997">        boolean captureRepairing = getSpecification()</span>
<span class="nc" id="L3998">            .getBoolean(GameOptions.CAPTURE_UNITS_UNDER_REPAIR);</span>
<span class="nc" id="L3999">        List&lt;Unit&gt; units = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L4000" title="All 2 branches missed.">        for (Unit u : colony.getTile().getUnitList()) {</span>
<span class="nc bnc" id="L4001" title="All 6 branches missed.">            if (u.isNaval() &amp;&amp; !(captureRepairing &amp;&amp; u.isDamaged()))</span>
<span class="nc" id="L4002">                units.add(u);</span>
        }
<span class="nc bnc" id="L4004" title="All 2 branches missed.">        if (!units.isEmpty()) {</span>
<span class="nc" id="L4005">            final ServerPlayer shipPlayer = (ServerPlayer)colony.getOwner();</span>
<span class="nc" id="L4006">            final ServerPlayer attackerPlayer = (ServerPlayer)attacker.getOwner();</span>
<span class="nc" id="L4007">            final Unit ship = units.get(0);</span>
<span class="nc" id="L4008">            StringTemplate t = StringTemplate.label(&quot;, &quot;);</span>
<span class="nc bnc" id="L4009" title="All 2 branches missed.">            for (Unit u : units) {</span>
<span class="nc" id="L4010">                csSinkShip(u, attackerPlayer, cs);</span>
<span class="nc" id="L4011">                t.addStringTemplate(u.getLabel());</span>
            }
<span class="nc" id="L4013">            cs.addMessage(See.only(shipPlayer),</span>
<span class="nc" id="L4014">                new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="nc" id="L4015">                                 &quot;combat.shipsSunk&quot;, shipPlayer)</span>
<span class="nc" id="L4016">                    .addStringTemplate(&quot;%ships%&quot;, t)</span>
<span class="nc" id="L4017">                    .addAmount(&quot;%number%&quot;, units.size()));</span>
        }
<span class="nc" id="L4019">    }</span>

    /**
     * Sinks this ship as result of a normal attack.
     *
     * @param attacker The attacker &lt;code&gt;Unit&lt;/code&gt;.
     * @param ship The naval &lt;code&gt;Unit&lt;/code&gt; to sink.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csSinkShipAttack(Unit attacker, Unit ship, ChangeSet cs) {
<span class="nc" id="L4029">        ServerPlayer shipPlayer = (ServerPlayer) ship.getOwner();</span>
<span class="nc" id="L4030">        StringTemplate shipNation = ship.getApparentOwnerName();</span>
<span class="nc" id="L4031">        Location shipLocation = ship.getLocation();</span>
<span class="nc" id="L4032">        Unit attackerUnit = attacker;</span>
<span class="nc" id="L4033">        ServerPlayer attackerPlayer = (ServerPlayer) attackerUnit.getOwner();</span>
<span class="nc" id="L4034">        StringTemplate attackerNation = attackerUnit.getApparentOwnerName();</span>

<span class="nc" id="L4036">        cs.addMessage(See.only(attackerPlayer),</span>
<span class="nc" id="L4037">            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="nc" id="L4038">                             &quot;combat.shipSunk.enemy&quot;, attackerUnit)</span>
<span class="nc" id="L4039">                .addStringTemplate(&quot;%location%&quot;,</span>
<span class="nc" id="L4040">                    shipLocation.getLocationLabelFor(attackerPlayer))</span>
<span class="nc" id="L4041">                .addStringTemplate(&quot;%unit%&quot;, attackerUnit.getLabel())</span>
<span class="nc" id="L4042">                .addStringTemplate(&quot;%enemyUnit%&quot;, ship.getLabel())</span>
<span class="nc" id="L4043">                .addStringTemplate(&quot;%enemyNation%&quot;, shipNation));</span>
<span class="nc" id="L4044">        cs.addMessage(See.only(shipPlayer),</span>
<span class="nc" id="L4045">            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="nc" id="L4046">                             &quot;combat.shipSunk.ours&quot;, ship.getTile())</span>
<span class="nc" id="L4047">                .addStringTemplate(&quot;%location%&quot;,</span>
<span class="nc" id="L4048">                    shipLocation.getLocationLabelFor(shipPlayer))</span>
<span class="nc" id="L4049">                .addStringTemplate(&quot;%unit%&quot;, ship.getLabel())</span>
<span class="nc" id="L4050">                .addStringTemplate(&quot;%enemyUnit%&quot;, attackerUnit.getLabel())</span>
<span class="nc" id="L4051">                .addStringTemplate(&quot;%enemyNation%&quot;, attackerNation));</span>

<span class="nc" id="L4053">        csSinkShip(ship, attackerPlayer, cs);</span>
<span class="nc" id="L4054">    }</span>

    /**
     * Sinks this ship as result of a bombard.
     *
     * @param settlement The bombarding &lt;code&gt;Settlement&lt;/code&gt;.
     * @param ship The naval &lt;code&gt;Unit&lt;/code&gt; to sink.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csSinkShipBombard(Settlement settlement, Unit ship,
                                   ChangeSet cs) {
<span class="nc" id="L4065">        ServerPlayer attackerPlayer = (ServerPlayer) settlement.getOwner();</span>
<span class="nc" id="L4066">        ServerPlayer shipPlayer = (ServerPlayer) ship.getOwner();</span>
<span class="nc" id="L4067">        StringTemplate shipNation = ship.getApparentOwnerName();</span>
<span class="nc" id="L4068">        Building building = ((Colony)settlement).getStockade();</span>
        
<span class="nc" id="L4070">        cs.addMessage(See.only(attackerPlayer),</span>
<span class="nc" id="L4071">            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="nc" id="L4072">                             &quot;combat.shipSunkByBombardment.enemy&quot;, settlement)</span>
<span class="nc" id="L4073">                .addStringTemplate(&quot;%location%&quot;,</span>
<span class="nc" id="L4074">                    settlement.getLocationLabelFor(attackerPlayer))</span>
<span class="nc" id="L4075">                .addNamed(&quot;%building%&quot;, building)</span>
<span class="nc" id="L4076">                .addStringTemplate(&quot;%enemyUnit%&quot;, ship.getLabel())</span>
<span class="nc" id="L4077">                .addStringTemplate(&quot;%enemyNation%&quot;, shipNation));</span>
<span class="nc" id="L4078">        cs.addMessage(See.only(shipPlayer),</span>
<span class="nc" id="L4079">            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="nc" id="L4080">                             &quot;combat.shipSunkByBombardment&quot;, ship.getTile())</span>
<span class="nc" id="L4081">                .addStringTemplate(&quot;%location%&quot;,</span>
<span class="nc" id="L4082">                    settlement.getLocationLabelFor(shipPlayer))</span>
<span class="nc" id="L4083">                .addStringTemplate(&quot;%unit%&quot;, ship.getLabel())</span>
<span class="nc" id="L4084">                .addNamed(&quot;%building%&quot;, building)</span>
<span class="nc" id="L4085">                .addStringTemplate(&quot;%enemyNation%&quot;,</span>
<span class="nc" id="L4086">                    attackerPlayer.getNationLabel()));</span>

<span class="nc" id="L4088">        csSinkShip(ship, attackerPlayer, cs);</span>
<span class="nc" id="L4089">    }</span>

    /**
     * Sink the ship.
     *
     * @param ship The naval &lt;code&gt;Unit&lt;/code&gt; to sink.
     * @param attackerPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that
     * attacked, or null
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csSinkShip(Unit ship, ServerPlayer attackerPlayer,
                            ChangeSet cs) {
<span class="nc" id="L4101">        ServerPlayer shipPlayer = (ServerPlayer) ship.getOwner();</span>
<span class="nc" id="L4102">        cs.addRemove(See.perhaps().always(shipPlayer), ship.getLocation(),</span>
<span class="nc" id="L4103">                     ship);//-vis(shipPlayer)</span>
<span class="nc" id="L4104">        ship.dispose();</span>
<span class="nc" id="L4105">        shipPlayer.invalidateCanSeeTiles();//+vis(shipPlayer)</span>
<span class="nc bnc" id="L4106" title="All 2 branches missed.">        if (attackerPlayer != null) {</span>
<span class="nc" id="L4107">            cs.addAttribute(See.only(attackerPlayer), &quot;sound&quot;,</span>
<span class="nc" id="L4108">                            &quot;sound.event.shipSunk&quot;);</span>
        }
<span class="nc" id="L4110">    }</span>

    /**
     * Slaughter a unit.
     *
     * @param winner The &lt;code&gt;Unit&lt;/code&gt; that is slaughtering.
     * @param loser The &lt;code&gt;Unit&lt;/code&gt; to slaughter.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csSlaughterUnit(Unit winner, Unit loser, ChangeSet cs) {
<span class="fc" id="L4120">        ServerPlayer winnerPlayer = (ServerPlayer) winner.getOwner();</span>
<span class="fc" id="L4121">        StringTemplate winnerNation = winner.getApparentOwnerName();</span>
<span class="pc bpc" id="L4122" title="1 of 2 branches missed.">        Location winnerLoc = (winner.isInColony()) ? winner.getColony()</span>
<span class="fc" id="L4123">            : winner.getLocation();</span>
<span class="fc" id="L4124">        StringTemplate winnerLocation</span>
<span class="fc" id="L4125">            = winnerLoc.getLocationLabelFor(winnerPlayer);</span>
<span class="fc" id="L4126">        ServerPlayer loserPlayer = (ServerPlayer) loser.getOwner();</span>
<span class="fc" id="L4127">        StringTemplate loserNation = loser.getApparentOwnerName();</span>
<span class="fc bfc" id="L4128" title="All 2 branches covered.">        Location loserLoc = (loser.isInColony()) ? loser.getColony()</span>
<span class="fc" id="L4129">            : loser.getLocation();</span>
<span class="fc" id="L4130">        StringTemplate loserLocation</span>
<span class="fc" id="L4131">            = loserLoc.getLocationLabelFor(loserPlayer);</span>
        String key;

<span class="fc" id="L4134">        key = &quot;combat.unitSlaughtered.enemy.&quot; + loser.getType().getSuffix();</span>
<span class="fc" id="L4135">        cs.addMessage(See.only(winnerPlayer),</span>
<span class="fc" id="L4136">            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="fc" id="L4137">                             key, winner)</span>
<span class="fc" id="L4138">                .addDefaultId(&quot;combat.unitSlaughtered.enemy&quot;)</span>
<span class="fc" id="L4139">                .addStringTemplate(&quot;%location%&quot;, winnerLocation)</span>
<span class="fc" id="L4140">                .addStringTemplate(&quot;%unit%&quot;, winner.getLabel())</span>
<span class="fc" id="L4141">                .addStringTemplate(&quot;%enemyNation%&quot;, loserNation)</span>
<span class="fc" id="L4142">                .addStringTemplate(&quot;%enemyUnit%&quot;, loser.getLabel()));</span>
<span class="fc" id="L4143">        key = &quot;combat.unitSlaughtered.ours.&quot; + loser.getType().getSuffix();</span>
<span class="fc" id="L4144">        cs.addMessage(See.only(loserPlayer),</span>
<span class="fc" id="L4145">            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,</span>
<span class="fc" id="L4146">                             key, loser.getTile())</span>
<span class="fc" id="L4147">                .addDefaultId(&quot;combat.unitSlaughtered.ours&quot;)</span>
<span class="fc" id="L4148">                .addStringTemplate(&quot;%location%&quot;, loserLocation)</span>
<span class="fc" id="L4149">                .addStringTemplate(&quot;%unit%&quot;, loser.getLabel())</span>
<span class="fc" id="L4150">                .addStringTemplate(&quot;%enemyNation%&quot;, winnerNation)</span>
<span class="fc" id="L4151">                .addStringTemplate(&quot;%enemyUnit%&quot;, winner.getLabel()));</span>
<span class="pc bpc" id="L4152" title="1 of 4 branches missed.">        if (loserPlayer.isIndian() &amp;&amp; loserPlayer.checkForDeath() == IS_DEAD) {</span>
<span class="nc" id="L4153">            StringTemplate nativeNation = loserPlayer.getNationLabel();</span>
<span class="nc" id="L4154">            cs.addGlobalHistory(getGame(),</span>
<span class="nc" id="L4155">                new HistoryEvent(getGame().getTurn(),</span>
<span class="nc" id="L4156">                    HistoryEvent.HistoryEventType.DESTROY_NATION, winnerPlayer)</span>
<span class="nc" id="L4157">                .addStringTemplate(&quot;%nation%&quot;, winnerPlayer.getNationLabel())</span>
<span class="nc" id="L4158">                .addStringTemplate(&quot;%nativeNation%&quot;, nativeNation));</span>
        }

        // Destroy unit.  Note See.only visibility used to handle the
        // case that the unit is the last at a settlement.  If
        // See.perhaps was used there, the settlement will be gone
        // when perhaps() is processed, which would erroneously make
        // the unit visible.
<span class="fc bfc" id="L4166" title="All 2 branches covered.">        cs.addRemove((loserLoc.getSettlement() != null)</span>
<span class="fc" id="L4167">            ? See.only(loserPlayer)</span>
<span class="fc" id="L4168">            : See.perhaps().always(loserPlayer),</span>
<span class="fc" id="L4169">            loserLoc, loser);//-vis(loserPlayer)</span>
<span class="fc" id="L4170">        loser.dispose();</span>
<span class="fc" id="L4171">        loserPlayer.invalidateCanSeeTiles();//+vis(loserPlayer)</span>
<span class="fc" id="L4172">    }</span>

    /**
     * Updates the player view for each new tile on a supplied list,
     * and update a ChangeSet as well.
     *
     * @param newTiles A list of &lt;code&gt;Tile&lt;/code&gt;s to update.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csSeeNewTiles(Collection&lt;? extends Tile&gt; newTiles,
                              ChangeSet cs) {
<span class="fc" id="L4183">        exploreTiles(newTiles);</span>
<span class="fc" id="L4184">        cs.add(See.only(this), newTiles);</span>
<span class="fc" id="L4185">    }</span>

    /**
     * Make a tea party modifier for the current turn.
     *
     * Public for the test suite.
     *
     * @return A tea party &lt;code&gt;Modifier&lt;/code&gt;.
     */
    public Modifier makeTeaPartyModifier() {
<span class="fc" id="L4195">        final Specification spec = getGame().getSpecification();</span>
<span class="fc" id="L4196">        final Turn turn = getGame().getTurn();</span>
<span class="pc bpc" id="L4197" title="1 of 2 branches missed.">        for (Modifier modifier : spec.getModifiers(Modifier.COLONY_GOODS_PARTY)) {</span>
<span class="fc" id="L4198">            Modifier m = Modifier.makeTimedModifier(&quot;model.goods.bells&quot;,</span>
<span class="fc" id="L4199">                                                    modifier, turn);</span>
<span class="fc" id="L4200">            m.setModifierIndex(Modifier.PARTY_PRODUCTION_INDEX);</span>
<span class="fc" id="L4201">            return m;</span>
        }
<span class="nc" id="L4203">        return null;</span>
    }

    /**
     * Raises the players tax rate, or handles a goods party.
     *
     * @param tax The new tax rate.
     * @param goods The &lt;code&gt;Goods&lt;/code&gt; to use in a goods party.
     * @param accepted Whether the tax raise was accepted.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csRaiseTax(int tax, Goods goods, boolean accepted,
                           ChangeSet cs) {
<span class="nc" id="L4216">        GoodsType goodsType = goods.getType();</span>
<span class="nc" id="L4217">        Colony colony = (Colony) goods.getLocation();</span>
<span class="nc" id="L4218">        int amount = Math.min(goods.getAmount(), GoodsContainer.CARGO_SIZE);</span>
<span class="nc" id="L4219">        String monarchKey = getMonarchKey();</span>

<span class="nc bnc" id="L4221" title="All 2 branches missed.">        if (accepted) {</span>
<span class="nc" id="L4222">            csSetTax(tax, cs);</span>
<span class="nc" id="L4223">            logger.info(&quot;Accepted tax raise to: &quot; + tax);</span>
<span class="nc bnc" id="L4224" title="All 2 branches missed.">        } else if (colony.getGoodsCount(goodsType) &lt; amount) {</span>
            // Player has removed the goods from the colony,
            // so raise the tax anyway.
<span class="nc" id="L4227">            final int extraTax = 3; // FIXME, magic number</span>
<span class="nc" id="L4228">            csSetTax(tax + extraTax, cs);</span>
<span class="nc" id="L4229">            cs.add(See.only(this), ChangePriority.CHANGE_NORMAL,</span>
<span class="nc" id="L4230">                new MonarchActionMessage(Monarch.MonarchAction.FORCE_TAX,</span>
<span class="nc" id="L4231">                    StringTemplate.template(Monarch.MonarchAction.FORCE_TAX.getTextKey())</span>
<span class="nc" id="L4232">                    .addAmount(&quot;%amount%&quot;, tax + extraTax),</span>
<span class="nc" id="L4233">                    monarchKey));</span>
<span class="nc" id="L4234">            logger.info(&quot;Forced tax raise to: &quot; + (tax + extraTax));</span>
<span class="nc" id="L4235">        } else { // Tea party</span>
<span class="nc" id="L4236">            Specification spec = getGame().getSpecification();</span>
<span class="nc" id="L4237">            colony.getGoodsContainer().saveState();</span>
<span class="nc" id="L4238">            colony.removeGoods(goodsType, amount);</span>

<span class="nc" id="L4240">            int arrears = market.getPaidForSale(goodsType)</span>
<span class="nc" id="L4241">                * spec.getInteger(GameOptions.ARREARS_FACTOR);</span>
<span class="nc" id="L4242">            Market market = getMarket();</span>
<span class="nc" id="L4243">            market.setArrears(goodsType, arrears);</span>

<span class="nc" id="L4245">            Modifier tpm = makeTeaPartyModifier();</span>
<span class="nc" id="L4246">            cs.addFeatureChange(this, colony, tpm, true);</span>
<span class="nc" id="L4247">            cs.add(See.only(this), colony.getGoodsContainer());</span>
<span class="nc" id="L4248">            cs.add(See.only(this), market.getMarketData(goodsType));</span>
            
<span class="nc" id="L4250">            String messageId = &quot;model.player.colonyGoodsParty.&quot;</span>
<span class="nc" id="L4251">                + goodsType.getSuffix();</span>
<span class="nc bnc" id="L4252" title="All 2 branches missed.">            if (!Messages.containsKey(messageId)) {</span>
<span class="nc bnc" id="L4253" title="All 2 branches missed.">                messageId = (colony.isLandLocked())</span>
<span class="nc" id="L4254">                    ? &quot;model.player.colonyGoodsParty.landLocked&quot;</span>
<span class="nc" id="L4255">                    : &quot;model.player.colonyGoodsParty.harbour&quot;;</span>
            }
<span class="nc" id="L4257">            cs.addMessage(See.only(this),</span>
<span class="nc" id="L4258">                new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,</span>
<span class="nc" id="L4259">                                 messageId, this)</span>
<span class="nc" id="L4260">                    .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="nc" id="L4261">                    .addAmount(&quot;%amount%&quot;, amount)</span>
<span class="nc" id="L4262">                    .addNamed(&quot;%goods%&quot;, goodsType));</span>
<span class="nc" id="L4263">            cs.addAttribute(See.only(this), &quot;flush&quot;, Boolean.TRUE.toString());</span>
<span class="nc" id="L4264">            logger.info(&quot;Goods party at &quot; + colony.getName()</span>
<span class="nc" id="L4265">                + &quot; with: &quot; + goods + &quot; arrears: &quot; + arrears);</span>
<span class="nc bnc" id="L4266" title="All 2 branches missed.">            if (isAI()) { // Reset the goods wishes</span>
<span class="nc" id="L4267">                colony.firePropertyChange(Colony.REARRANGE_WORKERS,</span>
<span class="nc" id="L4268">                                          goodsType, null);</span>
            }
        }
<span class="nc" id="L4271">    }</span>

    /**
     * Handle the end of a session where the player has ignored a tax
     * increase demand.
     *
     * @param tax The new tax rate.
     * @param goods The &lt;code&gt;Goods&lt;/code&gt; to use in a goods party.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void ignoreTax(int tax, Goods goods, ChangeSet cs) {
<span class="nc" id="L4282">        csRaiseTax(tax, goods, true, cs);</span>
<span class="nc" id="L4283">        cs.addMessage(See.only(this),</span>
<span class="nc" id="L4284">            new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,</span>
<span class="nc" id="L4285">                             &quot;model.player.ignoredTax&quot;, this)</span>
<span class="nc" id="L4286">                .addAmount(&quot;%amount%&quot;, tax));</span>
<span class="nc" id="L4287">    }</span>

    /**
     * Handle the end of a session where the player has ignored an
     * offer of mercenaries.
     *
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void ignoreMercenaries(ChangeSet cs) {
<span class="nc" id="L4296">        cs.addMessage(See.only(this),</span>
<span class="nc" id="L4297">            new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,</span>
<span class="nc" id="L4298">                             &quot;model.player.ignoredMercenaries&quot;, this));</span>
<span class="nc" id="L4299">    }</span>

    /**
     * Add a mercenary offer to the player.
     *
     * @param mercenaries A list of mercenary units.
     * @param action The monarch action that caused the offer.
     * @param random A pseudo-random number source.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csMercenaries(List&lt;AbstractUnit&gt; mercenaries,
                              Monarch.MonarchAction action,
                              Random random, ChangeSet cs) {
<span class="nc bnc" id="L4312" title="All 2 branches missed.">        if (mercenaries.isEmpty()) return;</span>
<span class="nc" id="L4313">        final int n = NameCache.getMercenaryLeaderIndex(random);</span>
<span class="nc" id="L4314">        final int price = priceMercenaries(mercenaries);</span>
<span class="nc" id="L4315">        cs.add(See.only(this), ChangePriority.CHANGE_EARLY,</span>
<span class="nc" id="L4316">            new MonarchActionMessage(action, StringTemplate</span>
<span class="nc" id="L4317">                .template(action.getTextKey())</span>
<span class="nc" id="L4318">                .addName(&quot;%leader%&quot;, NameCache.getMercenaryLeaderName(n))</span>
<span class="nc" id="L4319">                .addAmount(&quot;%gold%&quot;, price)</span>
<span class="nc" id="L4320">                .addStringTemplate(&quot;%mercenaries%&quot;,</span>
<span class="nc" id="L4321">                    AbstractUnit.getListLabel(&quot;, &quot;, mercenaries)),</span>
<span class="nc" id="L4322">                &quot;image.flavor.model.mercenaries.&quot; + n));</span>
<span class="nc" id="L4323">        new MonarchSession(this, action, mercenaries, price);</span>
<span class="nc" id="L4324">    }</span>
        
    /**
     * Set the player tax rate.
     * If this requires a change to the bells bonuses, we have to update
     * the whole player (bah) because we can not yet independently update
     * the feature container.
     *
     * @param tax The new tax rate.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csSetTax(int tax, ChangeSet cs) {
<span class="nc" id="L4336">        setTax(tax);</span>
<span class="nc bnc" id="L4337" title="All 2 branches missed.">        if (recalculateBellsBonus()) {</span>
<span class="nc" id="L4338">            cs.add(See.only(this), this);</span>
<span class="nc" id="L4339">        } else {</span>
<span class="nc" id="L4340">            cs.addPartial(See.only(this), this, &quot;tax&quot;);</span>
        }
<span class="nc" id="L4342">    }</span>

    /**
     * Adds mercenaries that the player has accepted.
     *
     * @param mercs A list of mercenaries.
     * @param price The price to be charged for them.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csAddMercenaries(List&lt;AbstractUnit&gt; mercs, int price,
                                 ChangeSet cs) {
<span class="nc bnc" id="L4353" title="All 2 branches missed.">        if (checkGold(price)) {</span>
<span class="nc" id="L4354">            final Specification spec = getSpecification();</span>
<span class="nc" id="L4355">            List&lt;AbstractUnit&gt; naval = transform(mercs,</span>
<span class="nc" id="L4356">                au -&gt; au.getType(spec).isNaval(), Collectors.toList());</span>
            Tile dst;
<span class="nc bnc" id="L4358" title="All 2 branches missed.">            if (naval.isEmpty()) { // Deliver to first settlement</span>
<span class="nc" id="L4359">                dst = getColonies().get(0).getTile();</span>
<span class="nc" id="L4360">                createUnits(mercs, dst);//-vis: safe, in colony</span>
<span class="nc" id="L4361">                cs.add(See.only(this), dst);</span>
<span class="nc" id="L4362">            } else { // Let them sail in</span>
<span class="nc" id="L4363">                dst = getEntryLocation().getTile();</span>
<span class="nc" id="L4364">                loadShips(createUnits(mercs, dst));//-vis</span>
<span class="nc" id="L4365">                invalidateCanSeeTiles();//+vis(this)</span>
<span class="nc" id="L4366">                cs.add(See.perhaps(), dst);</span>
            }
<span class="nc" id="L4368">            cs.addMessage(See.only(this),</span>
<span class="nc" id="L4369">                new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,</span>
<span class="nc" id="L4370">                                 &quot;model.player.mercenariesArrived&quot;, this)</span>
<span class="nc" id="L4371">                    .addStringTemplate(&quot;%location%&quot;,</span>
<span class="nc" id="L4372">                        dst.up().getLocationLabelFor(this)));</span>
<span class="nc" id="L4373">            modifyGold(-price);</span>
<span class="nc" id="L4374">            cs.addPartial(See.only(this), this, &quot;gold&quot;);</span>
<span class="nc" id="L4375">        } else {</span>
<span class="nc" id="L4376">            getMonarch().setDispleasure(true);</span>
<span class="nc" id="L4377">            cs.add(See.only(this), ChangePriority.CHANGE_NORMAL,</span>
<span class="nc" id="L4378">                new MonarchActionMessage(Monarch.MonarchAction.DISPLEASURE,</span>
<span class="nc" id="L4379">                    StringTemplate.template(Monarch.MonarchAction.DISPLEASURE.getTextKey()),</span>
<span class="nc" id="L4380">                    getMonarchKey()));</span>
        }
<span class="nc" id="L4382">    }</span>

    /**
     * Make contact between two nations if necessary.
     *
     * @param other The other &lt;code&gt;ServerPlayer&lt;/code&gt;.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     * @return True if this was a first contact.
     */
    public boolean csContact(ServerPlayer other, ChangeSet cs) {
<span class="fc bfc" id="L4392" title="All 2 branches covered.">        if (hasContacted(other)) return false;</span>

        // Must be a first contact!
<span class="fc" id="L4395">        final Game game = getGame();</span>
<span class="fc" id="L4396">        Turn turn = game.getTurn();</span>
<span class="fc bfc" id="L4397" title="All 2 branches covered.">        if (isIndian()) {</span>
<span class="pc bpc" id="L4398" title="1 of 2 branches missed.">            if (other.isIndian()) {</span>
<span class="nc" id="L4399">                return false; // Ignore native-to-native contacts.</span>
            } else {
<span class="fc" id="L4401">                cs.addHistory(other, new HistoryEvent(turn,</span>
<span class="fc" id="L4402">                        HistoryEvent.HistoryEventType.MEET_NATION, other)</span>
<span class="fc" id="L4403">                    .addStringTemplate(&quot;%nation%&quot;, getNationLabel()));</span>
            }
<span class="fc" id="L4405">        } else { // (serverPlayer.isEuropean)</span>
<span class="fc" id="L4406">            cs.addHistory(this, new HistoryEvent(turn,</span>
<span class="fc" id="L4407">                    HistoryEvent.HistoryEventType.MEET_NATION, other)</span>
<span class="fc" id="L4408">                .addStringTemplate(&quot;%nation%&quot;, other.getNationLabel()));</span>
        }

<span class="fc" id="L4411">        logger.finest(&quot;First contact between &quot; + this.getId()</span>
<span class="fc" id="L4412">            + &quot; and &quot; + other.getId());</span>
<span class="fc" id="L4413">        return true;</span>
    }

    /**
     * Initiate first contact between this European and native player.
     *
     * @param other The native &lt;code&gt;ServerPlayer&lt;/code&gt;.
     * @param tile The &lt;code&gt;Tile&lt;/code&gt; contact is made at if this is
     *     a first landing in the new world and it is owned by the
     *     other player.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csNativeFirstContact(ServerPlayer other, Tile tile,
                                     ChangeSet cs) {
<span class="fc" id="L4427">        cs.add(See.only(this), ChangePriority.CHANGE_EARLY,</span>
<span class="fc" id="L4428">            new FirstContactMessage(this, other, tile));</span>
<span class="fc" id="L4429">        csChangeStance(Stance.PEACE, other, true, cs);</span>
<span class="fc bfc" id="L4430" title="All 2 branches covered.">        if (tile != null) {</span>
            // Establish a diplomacy session so that if the player
            // accepts the tile offer, we can verify that the offer
            // was made.
<span class="fc" id="L4434">            new DiplomacySession(tile.getFirstUnit(),</span>
<span class="fc" id="L4435">                                 tile.getOwningSettlement());</span>
        }
<span class="fc" id="L4437">    }</span>

    /**
     * Initiate first contact between this European and another
     * European player.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; making contact.
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; being contacted.
     * @param otherUnit The &lt;code&gt;Unit&lt;/code&gt; being contacted.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csEuropeanFirstContact(Unit unit, Settlement settlement,
                                       Unit otherUnit, ChangeSet cs) {
<span class="nc" id="L4450">        final Game game = getGame();</span>

        ServerPlayer other;
<span class="nc bnc" id="L4453" title="All 2 branches missed.">        if (settlement instanceof Colony) {</span>
<span class="nc" id="L4454">            other = (ServerPlayer)settlement.getOwner();</span>
<span class="nc bnc" id="L4455" title="All 2 branches missed.">        } else if (otherUnit != null) {</span>
<span class="nc" id="L4456">            other = (ServerPlayer)otherUnit.getOwner();</span>
<span class="nc" id="L4457">        } else {</span>
<span class="nc" id="L4458">            throw new IllegalArgumentException(&quot;Non-null settlement or &quot;</span>
                    + &quot;otherUnit required.&quot;);
        }
        
<span class="nc" id="L4462">        DiplomaticTrade agreement = new DiplomaticTrade(game,</span>
<span class="nc" id="L4463">            DiplomaticTrade.TradeContext.CONTACT, this, other, null, 0);</span>
<span class="nc" id="L4464">        agreement.add(new StanceTradeItem(game, this, other, Stance.PEACE));</span>
<span class="nc bnc" id="L4465" title="All 2 branches missed.">        DiplomacySession session = (settlement == null)</span>
<span class="nc" id="L4466">            ? new DiplomacySession(unit, otherUnit)</span>
<span class="nc" id="L4467">            : new DiplomacySession(unit, settlement);</span>
<span class="nc" id="L4468">        session.setAgreement(agreement);</span>
<span class="nc bnc" id="L4469" title="All 2 branches missed.">        cs.add(See.only(this), ChangePriority.CHANGE_LATE, (settlement == null)</span>
<span class="nc" id="L4470">            ? new DiplomacyMessage(unit, otherUnit, agreement)</span>
<span class="nc" id="L4471">            : new DiplomacyMessage(unit, (Colony)settlement, agreement));</span>
<span class="nc" id="L4472">    }</span>

    /**
     * Change the owner of a unit or dispose of it if the change is
     * impossible.  Move the unit to a new location if necessary.
     * Also handle disappearance of any carried units that will now be
     * invisible to the new owner.
     *
     * -vis(owner,newOwner)
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to change ownership of.
     * @param newOwner The new owning &lt;code&gt;ServerPlayer&lt;/code&gt;.
     * @param change An optional accompanying &lt;code&gt;ChangeType&lt;/code&gt;.
     * @param loc A optional new &lt;code&gt;Location&lt;/code&gt; for the unit.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     * @return True if the new owner can have this unit.
     */
    public boolean csChangeOwner(Unit unit, ServerPlayer newOwner,
                                 ChangeType change, Location loc,
                                 ChangeSet cs) {
<span class="fc bfc" id="L4492" title="All 2 branches covered.">        if (newOwner == this) return true; // No transfer needed</span>

<span class="fc" id="L4494">        final Tile oldTile = unit.getTile();</span>
<span class="fc" id="L4495">        UnitType mainType = unit.getTypeChange(change, newOwner);</span>
<span class="fc bfc" id="L4496" title="All 2 branches covered.">        if (mainType == null) mainType = unit.getType(); // No change needed.</span>
<span class="pc bpc" id="L4497" title="1 of 2 branches missed.">        if (!mainType.isAvailableTo(newOwner)) { // Can not have this unit.</span>
<span class="nc" id="L4498">            cs.addRemove(See.perhaps().always(this), oldTile, unit);</span>
<span class="nc" id="L4499">            unit.dispose();</span>
<span class="nc" id="L4500">            return false;</span>
        }

<span class="pc bpc" id="L4503" title="1 of 2 branches missed.">        for (Unit u : unit.getUnitList()) {</span>
<span class="nc" id="L4504">            UnitType type = u.getTypeChange(change, newOwner);</span>
<span class="nc bnc" id="L4505" title="All 2 branches missed.">            if (type == null) type = u.getType();</span>
<span class="nc bnc" id="L4506" title="All 2 branches missed.">            if (!type.isAvailableTo(newOwner)) {</span>
<span class="nc" id="L4507">                cs.addRemove(See.only(this), unit, u);</span>
<span class="nc" id="L4508">                u.dispose();</span>
<span class="nc" id="L4509">            } else {</span>
<span class="nc bnc" id="L4510" title="All 2 branches missed.">                if (!u.changeType(type)) {</span>
<span class="nc" id="L4511">                    throw new IllegalStateException(&quot;Type change failure: &quot;</span>
<span class="nc" id="L4512">                        + u + &quot; -&gt; &quot; + type);</span>
                }
            }
        }
<span class="pc bpc" id="L4516" title="1 of 4 branches missed.">        if (mainType != unit.getType() &amp;&amp; !unit.changeType(mainType)) {</span>
<span class="nc" id="L4517">            throw new IllegalStateException(&quot;Type change failure: &quot; + unit</span>
<span class="nc" id="L4518">                + &quot; -&gt; &quot; + mainType);</span>
        }
<span class="fc" id="L4520">        unit.changeOwner(newOwner);</span>
<span class="fc bfc" id="L4521" title="All 2 branches covered.">        if (loc != null) unit.setLocation(loc);</span>
<span class="pc bpc" id="L4522" title="1 of 2 branches missed.">        if (unit.isCarrier()) {</span>
<span class="nc" id="L4523">            cs.addRemoves(See.only(this), unit, unit.getUnitList());</span>
        }
<span class="fc" id="L4525">        cs.add(See.only(newOwner), newOwner.exploreForUnit(unit));</span>
<span class="fc" id="L4526">        return true;</span>
    }


    // Serialization

    /**
     * {@inheritDoc}
     */
    @Override
    public String toString() {
<span class="fc" id="L4537">        StringBuilder sb = new StringBuilder(64);</span>
<span class="fc" id="L4538">        sb.append(&quot;[ServerPlayer &quot;).append(getId())</span>
<span class="fc" id="L4539">            .append(&quot; &quot;).append(getName())</span>
<span class="fc" id="L4540">            .append(&quot; &quot;).append(this.connection)</span>
<span class="fc" id="L4541">            .append(&quot;]&quot;);</span>
<span class="fc" id="L4542">        return sb.toString();</span>
    }

    /**
     * Gets the tag name of the root element representing this object.
     *
     * @return &quot;serverPlayer&quot;
     */
    @Override
    public String getServerXMLElementTagName() {
<span class="fc" id="L4552">        return &quot;serverPlayer&quot;;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span>src (May 7, 2016 6:04:12 PM)</div></body></html>