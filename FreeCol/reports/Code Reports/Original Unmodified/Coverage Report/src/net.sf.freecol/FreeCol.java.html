<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>FreeCol.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">src (May 7, 2016 6:04:12 PM)</a> &gt; <a href="../../index.html" class="el_group">FreeCol</a> &gt; <a href="../index.html" class="el_bundle">src</a> &gt; <a href="index.source.html" class="el_package">net.sf.freecol</a> &gt; <span class="el_source">FreeCol.java</span></div><h1>FreeCol.java</h1><pre class="source lang-java linenums"><span class="nc" id="L1">/**</span>
 *  Copyright (C) 2002-2016   The FreeCol Team
 *
 *  This file is part of FreeCol.
 *
 *  FreeCol is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  FreeCol is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with FreeCol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package net.sf.freecol;

import java.awt.Dimension;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.InputStream;
import java.net.InetAddress;
import java.net.JarURLConnection;
import java.net.URL;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Locale;
import java.util.jar.JarFile;
import java.util.jar.Manifest;
import java.util.logging.Handler;
import java.util.logging.Level;
import java.util.logging.Logger;
import java.util.stream.Collectors;
import java.util.zip.ZipEntry;

import net.sf.freecol.client.ClientOptions;
import net.sf.freecol.client.FreeColClient;
import net.sf.freecol.common.FreeColException;
import net.sf.freecol.common.FreeColSeed;
import net.sf.freecol.common.debug.FreeColDebugger;
import net.sf.freecol.common.i18n.Messages;
import net.sf.freecol.common.io.FreeColDirectories;
import net.sf.freecol.common.io.FreeColSavegameFile;
import net.sf.freecol.common.io.FreeColTcFile;
import net.sf.freecol.common.io.Mods;
import net.sf.freecol.common.logging.DefaultHandler;
import net.sf.freecol.common.model.NationOptions.Advantages;
import net.sf.freecol.common.model.Specification;
import net.sf.freecol.common.model.StringTemplate;
import net.sf.freecol.common.option.OptionGroup;
import static net.sf.freecol.common.util.CollectionUtils.*;
import net.sf.freecol.server.FreeColServer;

import org.apache.commons.cli.CommandLine;
import org.apache.commons.cli.CommandLineParser;
import org.apache.commons.cli.HelpFormatter;
import org.apache.commons.cli.Option;
import org.apache.commons.cli.Options;
import org.apache.commons.cli.ParseException;
import org.apache.commons.cli.DefaultParser;


/**
 * This class is responsible for handling the command-line arguments
 * and starting either the stand-alone server or the client-GUI.
 *
 * @see net.sf.freecol.client.FreeColClient FreeColClient
 * @see net.sf.freecol.server.FreeColServer FreeColServer
 */
public final class FreeCol {

<span class="fc" id="L79">    private static final Logger logger = Logger.getLogger(FreeCol.class.getName());</span>

    /** The FreeCol release version number. */
    private static final String FREECOL_VERSION = &quot;0.11.6&quot;;

    /** The difficulty levels. */
<span class="fc" id="L85">    public static final String[] DIFFICULTIES = {</span>
<span class="fc" id="L86">        &quot;veryEasy&quot;, &quot;easy&quot;, &quot;medium&quot;, &quot;hard&quot;, &quot;veryHard&quot;</span>
    };

    /** The extension for FreeCol saved games. */
    public static final String  FREECOL_SAVE_EXTENSION = &quot;fsg&quot;;

    /** The Java version. */
<span class="fc" id="L93">    private static final String JAVA_VERSION</span>
<span class="fc" id="L94">        = System.getProperty(&quot;java.version&quot;);</span>

    /** The maximum available memory. */
<span class="fc" id="L97">    private static final long MEMORY_MAX = Runtime.getRuntime().maxMemory();</span>

    public static final String  CLIENT_THREAD = &quot;FreeColClient:&quot;;
    public static final String  SERVER_THREAD = &quot;FreeColServer:&quot;;
    public static final String  METASERVER_THREAD = &quot;FreeColMetaServer:&quot;;

    public static final String  META_SERVER_ADDRESS = &quot;meta.freecol.org&quot;;
    public static final int     META_SERVER_PORT = 3540;

    /** Specific revision number (currently the git tag of trunk at release) */
<span class="fc" id="L107">    private static String       freeColRevision = null;</span>

    /** The locale, either default or command-line specified. */
<span class="fc" id="L110">    private static Locale       locale = null;</span>


    // Cli defaults.
<span class="fc" id="L114">    private static final Advantages ADVANTAGES_DEFAULT = Advantages.SELECTABLE;</span>
    private static final String DIFFICULTY_DEFAULT = &quot;model.difficulty.medium&quot;;
    private static final int    EUROPEANS_DEFAULT = 4;
    private static final int    EUROPEANS_MIN = 1;
<span class="fc" id="L118">    private static final Level  LOGLEVEL_DEFAULT = Level.INFO;</span>
    private static final String JAVA_VERSION_MIN = &quot;1.8&quot;;
    private static final int    MEMORY_MIN = 128; // Mbytes
    private static final int    PORT_DEFAULT = 3541;
    private static final String SPLASH_DEFAULT = &quot;splash.jpg&quot;;
    private static final String TC_DEFAULT = &quot;freecol&quot;;
    public static final int     TIMEOUT_DEFAULT = 60; // 1 minute
    public static final int     TIMEOUT_MIN = 10; // 10s
    private static final int GUI_SCALE_MIN_PCT = 100;
    private static final int GUI_SCALE_MAX_PCT = 200;
    private static final int GUI_SCALE_STEP_PCT = 25;
    public static final float GUI_SCALE_MIN = GUI_SCALE_MIN_PCT / 100.0f;
    public static final float GUI_SCALE_MAX = GUI_SCALE_MAX_PCT / 100.0f;
    public static final float GUI_SCALE_STEP = GUI_SCALE_STEP_PCT / 100.0f;
    public static final float GUI_SCALE_DEFAULT = 1.0f;


    // Cli values.  Often set to null so the default can be applied in
    // the accessor function.
<span class="fc" id="L137">    private static boolean checkIntegrity = false,</span>
<span class="fc" id="L138">                           consoleLogging = false,</span>
                           //debugStart = false,
<span class="fc" id="L140">                           debugStart = true,</span>
<span class="fc" id="L141">                           fastStart = false,</span>
                           //headless = false,
<span class="fc" id="L143">                           headless = true,</span>
<span class="fc" id="L144">                           introVideo = true,</span>
<span class="fc" id="L145">                           javaCheck = true,</span>
<span class="fc" id="L146">                           memoryCheck = true,</span>
<span class="fc" id="L147">                           publicServer = true,</span>
<span class="fc" id="L148">                           sound = true,</span>
<span class="fc" id="L149">                           standAloneServer = false;</span>

    /** The type of advantages. */
<span class="fc" id="L152">    private static Advantages advantages = null;</span>

    /** The difficulty level id. */
<span class="fc" id="L155">    private static String difficulty = null;</span>

    /** The number of European nations to enable by default. */
<span class="fc" id="L158">    private static int europeanCount = EUROPEANS_DEFAULT;</span>

    /** A font override. */
<span class="fc" id="L161">    private static String fontName = null;</span>

    /** The levels of logging in this game. */
    private static class LogLevel {

        public final String name;
        public final Level level;
        // We need to keep a hard reference to the instantiated logger, as
        // Logger only uses weak references.
        public Logger logger;
        
<span class="fc" id="L172">        public LogLevel(String name, Level level) {</span>
<span class="fc" id="L173">            this.name = name;</span>
<span class="fc" id="L174">            this.level = level;</span>
<span class="fc" id="L175">            this.logger = null;</span>
<span class="fc" id="L176">        }</span>

        public void buildLogger() {
<span class="nc" id="L179">            this.logger = Logger.getLogger(&quot;net.sf.freecol&quot;</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">                + ((this.name.isEmpty()) ? &quot;&quot; : &quot;.&quot; + this.name));</span>
<span class="nc" id="L181">            this.logger.setLevel(this.level);</span>
<span class="nc" id="L182">        }</span>
    }
<span class="fc" id="L184">    private static final List&lt;LogLevel&gt; logLevels = new ArrayList&lt;&gt;();</span>
    static {
<span class="fc" id="L186">        logLevels.add(new LogLevel(&quot;&quot;, LOGLEVEL_DEFAULT));</span>
    }

    /** The client player name. */
<span class="fc" id="L190">    private static String name = null;</span>

    /** How to name and configure the server. */
<span class="fc" id="L193">    private static int serverPort = -1;</span>
<span class="fc" id="L194">    private static String serverName = null;</span>

    /** A stream to get the splash image from. */
    private static InputStream splashStream;

    /** The TotalConversion / ruleset in play, defaults to &quot;freecol&quot;. */
<span class="fc" id="L200">    private static String tc = null;</span>

    /** The time out (seconds) for otherwise blocking commands. */
<span class="fc" id="L203">    private static int timeout = -1;</span>

    /**
     * The size of window to create, defaults to impossible dimensions
     * to require windowed mode with best determined screen size.
     */
<span class="fc" id="L209">    private static Dimension windowSize = new Dimension(-1, -1);</span>

    /** How much gui elements get scaled. */
<span class="fc" id="L212">    private static float guiScale = GUI_SCALE_DEFAULT;</span>

   
<span class="nc" id="L215">    private FreeCol() {} // Hide constructor</span>

    /**
     * The entrypoint.
     *
     * @param args The command-line arguments.
     */
    public static void main(String[] args) {
<span class="nc" id="L223">        freeColRevision = FREECOL_VERSION;</span>
        JarURLConnection juc;
        try {
<span class="nc" id="L226">            juc = getJarURLConnection(FreeCol.class);</span>
<span class="nc" id="L227">        } catch (IOException ioe) {</span>
<span class="nc" id="L228">            juc = null;</span>
<span class="nc" id="L229">            System.err.println(&quot;Unable to open class jar: &quot;</span>
<span class="nc" id="L230">                + ioe.getMessage());</span>
        }
<span class="nc bnc" id="L232" title="All 2 branches missed.">        if (juc != null) {</span>
            try {
<span class="nc" id="L234">                String revision = readVersion(juc);</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">                if (revision != null) {</span>
<span class="nc" id="L236">                    freeColRevision += &quot; (Revision: &quot; + revision + &quot;)&quot;;</span>
                }
<span class="nc" id="L238">            } catch (Exception e) {</span>
<span class="nc" id="L239">                System.err.println(&quot;Unable to load Manifest: &quot;</span>
<span class="nc" id="L240">                    + e.getMessage());</span>
            }
            try {
<span class="nc" id="L243">                splashStream = getDefaultSplashStream(juc);</span>
<span class="nc" id="L244">            } catch (Exception e) {</span>
<span class="nc" id="L245">                System.err.println(&quot;Unable to open default splash: &quot;</span>
<span class="nc" id="L246">                    + e.getMessage());</span>
            }
        }

        // Java bug #7075600 causes BR#2554.  The workaround is to set
        // the following property.  Remove if/when they fix Java.
<span class="nc" id="L252">        System.setProperty(&quot;java.util.Arrays.useLegacyMergeSort&quot;, &quot;true&quot;);</span>

        // We can not even emit localized error messages until we find
        // the data directory, which might have been specified on the
        // command line.
<span class="nc" id="L257">        String dataDirectoryArg = findArg(&quot;--freecol-data&quot;, args);</span>
<span class="nc" id="L258">        String err = FreeColDirectories.setDataDirectory(dataDirectoryArg);</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">        if (err != null) fatal(err); // This must not fail.</span>

        // Now we have the data directory, establish the base locale.
        // Beware, the locale may change!
<span class="nc" id="L263">        String localeArg = findArg(&quot;--default-locale&quot;, args);</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">        if (localeArg == null) {</span>
<span class="nc" id="L265">            locale = Locale.getDefault();</span>
<span class="nc" id="L266">        } else {</span>
<span class="nc" id="L267">            int index = localeArg.indexOf('.'); // Strip encoding if present</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">            if (index &gt; 0) localeArg = localeArg.substring(0, index);</span>
<span class="nc" id="L269">            locale = Messages.getLocale(localeArg);</span>
        }
<span class="nc" id="L271">        Messages.loadMessageBundle(locale);</span>

        // Now that we can emit error messages, parse the other
        // command line arguments.
<span class="nc" id="L275">        handleArgs(args);</span>

        // Do the potentially fatal system checks as early as possible.
<span class="nc bnc" id="L278" title="All 4 branches missed.">        if (javaCheck &amp;&amp; JAVA_VERSION_MIN.compareTo(JAVA_VERSION) &gt; 0) {</span>
<span class="nc" id="L279">            fatal(StringTemplate.template(&quot;main.javaVersion&quot;)</span>
<span class="nc" id="L280">                .addName(&quot;%version%&quot;, JAVA_VERSION)</span>
<span class="nc" id="L281">                .addName(&quot;%minVersion%&quot;, JAVA_VERSION_MIN));</span>
        }
<span class="nc bnc" id="L283" title="All 4 branches missed.">        if (memoryCheck &amp;&amp; MEMORY_MAX &lt; MEMORY_MIN * 1000000) {</span>
<span class="nc" id="L284">            fatal(StringTemplate.template(&quot;main.memory&quot;)</span>
<span class="nc" id="L285">                .addAmount(&quot;%memory%&quot;, MEMORY_MAX)</span>
<span class="nc" id="L286">                .addAmount(&quot;%minMemory%&quot;, MEMORY_MIN));</span>
        }

        // Having parsed the command line args, we know where the user
        // directories should be, so we can set up the rest of the
        // file/directory structure.
<span class="nc" id="L292">        String userMsg = FreeColDirectories.setUserDirectories();</span>

        // Now we have the log file path, start logging.
<span class="nc" id="L295">        final Logger baseLogger = Logger.getLogger(&quot;&quot;);</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">        for (Handler handler : baseLogger.getHandlers()) {</span>
<span class="nc" id="L297">            baseLogger.removeHandler(handler);</span>
        }
<span class="nc" id="L299">        String logFile = FreeColDirectories.getLogFilePath();</span>
        try {
<span class="nc" id="L301">            baseLogger.addHandler(new DefaultHandler(consoleLogging, logFile));</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">            for (LogLevel ll : logLevels) ll.buildLogger();</span>
<span class="nc" id="L303">        } catch (FreeColException e) {</span>
<span class="nc" id="L304">            System.err.println(&quot;Logging initialization failure: &quot;</span>
<span class="nc" id="L305">                + e.getMessage());</span>
<span class="nc" id="L306">            e.printStackTrace();</span>
        }
<span class="nc" id="L308">        Thread.setDefaultUncaughtExceptionHandler((Thread thread, Throwable e) -&gt; {</span>
<span class="nc" id="L309">                baseLogger.log(Level.WARNING, &quot;Uncaught exception from thread: &quot; + thread, e);</span>
<span class="nc" id="L310">            });</span>

        // Now we can find the client options, allow the options
        // setting to override the locale, if no command line option
        // had been specified.
        // We have users whose machines default to Finnish but play
        // FreeCol in English.
        // If the user has selected automatic language selection, do
        // nothing, since we have already set up the default locale.
<span class="nc bnc" id="L319" title="All 2 branches missed.">        if (localeArg == null) {</span>
<span class="nc" id="L320">            String clientLanguage = ClientOptions.getLanguageOption();</span>
            Locale clientLocale;
<span class="nc bnc" id="L322" title="All 2 branches missed.">            if (clientLanguage != null</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">                &amp;&amp; !Messages.AUTOMATIC.equalsIgnoreCase(clientLanguage)</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">                &amp;&amp; (clientLocale = Messages.getLocale(clientLanguage)) != locale) {</span>
<span class="nc" id="L325">                locale = clientLocale;</span>
<span class="nc" id="L326">                Messages.loadMessageBundle(locale);</span>
<span class="nc" id="L327">                logger.info(&quot;Loaded messages for &quot; + locale);</span>
            }
        }

        // Now we have the user mods directory and the locale is now
        // stable, load the mods and their messages.
<span class="nc" id="L333">        Mods.loadMods();</span>
<span class="nc" id="L334">        Messages.loadModMessageBundle(locale);</span>

        // Report on where we are.
<span class="nc bnc" id="L337" title="All 2 branches missed.">        if (userMsg != null) logger.info(Messages.message(userMsg));</span>
<span class="nc" id="L338">        logger.info(getConfiguration().toString());</span>

        // Ready to specialize into client or server.
<span class="nc bnc" id="L341" title="All 2 branches missed.">        if (standAloneServer) {</span>
<span class="nc" id="L342">            startServer();</span>
<span class="nc" id="L343">        } else {</span>
<span class="nc" id="L344">            startClient(userMsg);</span>
        }
<span class="nc" id="L346">    }</span>


    /**
     * Get the JarURLConnection from a class.
     *
     * @param c The &lt;code&gt;Class&lt;/code&gt; to get the connection for.
     * @return The &lt;code&gt;JarURLConnection&lt;/code&gt;.
     * @exception IOException if the connection fails to open.
     */
    private static JarURLConnection getJarURLConnection(Class c)
        throws IOException {
<span class="nc" id="L358">        String resourceName = &quot;/&quot; + c.getName().replace('.', '/') + &quot;.class&quot;;</span>
<span class="nc" id="L359">        URL url = c.getResource(resourceName);</span>
<span class="nc" id="L360">        return (JarURLConnection)url.openConnection();</span>
    }
        
    /**
     * Extract the package version from the class.
     *
     * @param juc The &lt;code&gt;JarURLConnection&lt;/code&gt; to extract from.
     * @return A value of the package version attribute.
     * @exception IOException if the manifest is not available.
     */
    private static String readVersion(JarURLConnection juc) throws IOException {
<span class="nc" id="L371">        Manifest mf = juc.getManifest();</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">        return (mf == null) ? null</span>
<span class="nc" id="L373">            : mf.getMainAttributes().getValue(&quot;Package-Version&quot;);</span>
    }

    /**
     * Get a stream for the default splash file.
     *
     * Note: Not bothering to check for nulls as this is called in try
     * block that ignores all exceptions.
     *
     * @param juc The &lt;code&gt;JarURLConnection&lt;/code&gt; to extract from.
     * @return A suitable &lt;code&gt;InputStream&lt;/code&gt;, or null on error.
     * @exception IOException if the connection fails to open.
     */
    private static InputStream getDefaultSplashStream(JarURLConnection juc)
        throws IOException {
<span class="nc" id="L388">        JarFile jf = juc.getJarFile();</span>
<span class="nc" id="L389">        ZipEntry ze = jf.getEntry(SPLASH_DEFAULT);</span>
<span class="nc" id="L390">        return jf.getInputStream(ze);</span>
    }
            
    /**
     * Exit printing fatal error message.
     *
     * @param template A &lt;code&gt;StringTemplate&lt;/code&gt; to print.
     */
    public static void fatal(StringTemplate template) {
<span class="nc" id="L399">        fatal(Messages.message(template));</span>
<span class="nc" id="L400">    }</span>

    /**
     * Exit printing fatal error message.
     *
     * @param err The error message to print.
     */
    public static void fatal(String err) {
<span class="nc bnc" id="L408" title="All 4 branches missed.">        if (err == null || err.isEmpty()) {</span>
<span class="nc" id="L409">            err = &quot;Bogus null fatal error message&quot;;</span>
<span class="nc" id="L410">            Thread.dumpStack();</span>
        }
<span class="nc" id="L412">        System.err.println(err);</span>
<span class="nc" id="L413">        System.exit(1);</span>
<span class="nc" id="L414">    }</span>

    /**
     * Just gripe to System.err.
     *
     * @param template A &lt;code&gt;StringTemplate&lt;/code&gt; to print.
     */
    public static void gripe(StringTemplate template) {
<span class="nc" id="L422">        System.err.println(Messages.message(template));</span>
<span class="nc" id="L423">    }</span>

    /**
     * Just gripe to System.err.
     *
     * @param key A message key.
     */
    public static void gripe(String key) {
<span class="nc" id="L431">        System.err.println(Messages.message(key));</span>
<span class="nc" id="L432">    }</span>

    /**
     * Find an option before the real option handling can get started.
     * Takes care to use the *last* instance.
     *
     * @param option The option to find.
     * @param args The  command-line arguments.
     * @return The option's parameter.
     */
    private static String findArg(String option, String[] args) {
<span class="nc bnc" id="L443" title="All 2 branches missed.">        for (int i = args.length - 2; i &gt;= 0; i--) {</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">            if (option.equals(args[i])) {</span>
<span class="nc" id="L445">                return args[i+1];</span>
            }
        }
<span class="nc" id="L448">        return null;</span>
    }

    /**
     * Processes the command-line arguments and takes appropriate
     * actions for each of them.
     *
     * @param args The command-line arguments.
     */
    private static void handleArgs(String[] args) {
<span class="nc" id="L458">        Options options = new Options();</span>
<span class="nc" id="L459">        final String help = Messages.message(&quot;cli.help&quot;);</span>
<span class="nc" id="L460">        final String argDirectory = Messages.message(&quot;cli.arg.directory&quot;);</span>

        // Help options.
<span class="nc" id="L463">        options.addOption(Option.builder().longOpt(&quot;usage&quot;)</span>
<span class="nc" id="L464">                          .desc(help)</span>
<span class="nc" id="L465">                          .build());</span>
<span class="nc" id="L466">        options.addOption(Option.builder().longOpt(&quot;help&quot;)</span>
<span class="nc" id="L467">                          .desc(help)</span>
<span class="nc" id="L468">                          .build());</span>

        // Special options handled early.
<span class="nc" id="L471">        options.addOption(Option.builder().longOpt(&quot;freecol-data&quot;)</span>
<span class="nc" id="L472">                          .desc(Messages.message(&quot;cli.freecol-data&quot;))</span>
<span class="nc" id="L473">                          .argName(argDirectory)</span>
<span class="nc" id="L474">                          .hasArg()</span>
<span class="nc" id="L475">                          .build());</span>
<span class="nc" id="L476">        options.addOption(Option.builder().longOpt(&quot;default-locale&quot;)</span>
<span class="nc" id="L477">                          .desc(Messages.message(&quot;cli.default-locale&quot;))</span>
<span class="nc" id="L478">                          .argName(Messages.message(&quot;cli.arg.locale&quot;))</span>
<span class="nc" id="L479">                          .hasArg()</span>
<span class="nc" id="L480">                          .build());</span>

        // Ordinary options, handled here.
<span class="nc" id="L483">        options.addOption(Option.builder().longOpt(&quot;advantages&quot;)</span>
<span class="nc" id="L484">                          .desc(Messages.message(StringTemplate</span>
<span class="nc" id="L485">                                  .template(&quot;cli.advantages&quot;)</span>
<span class="nc" id="L486">                                  .addName(&quot;%advantages%&quot;, getValidAdvantages())))</span>
<span class="nc" id="L487">                          .argName(Messages.message(&quot;cli.arg.advantages&quot;))</span>
<span class="nc" id="L488">                          .hasArg()</span>
<span class="nc" id="L489">                          .build());</span>
<span class="nc" id="L490">        options.addOption(Option.builder().longOpt(&quot;check-savegame&quot;)</span>
<span class="nc" id="L491">                          .desc(Messages.message(&quot;cli.check-savegame&quot;))</span>
<span class="nc" id="L492">                          .argName(Messages.message(&quot;cli.arg.file&quot;))</span>
<span class="nc" id="L493">                          .hasArg()</span>
<span class="nc" id="L494">                          .build());</span>
<span class="nc" id="L495">        options.addOption(Option.builder().longOpt(&quot;clientOptions&quot;)</span>
<span class="nc" id="L496">                          .desc(Messages.message(&quot;cli.clientOptions&quot;))</span>
<span class="nc" id="L497">                          .argName(Messages.message(&quot;cli.arg.clientOptions&quot;))</span>
<span class="nc" id="L498">                          .hasArg()</span>
<span class="nc" id="L499">                          .build());</span>
<span class="nc" id="L500">        options.addOption(Option.builder().longOpt(&quot;debug&quot;)</span>
<span class="nc" id="L501">                          .desc(Messages.message(StringTemplate</span>
<span class="nc" id="L502">                                  .template(&quot;cli.debug&quot;)</span>
<span class="nc" id="L503">                                  .addName(&quot;%modes%&quot;, FreeColDebugger.getDebugModes())))</span>
<span class="nc" id="L504">                          .argName(Messages.message(&quot;cli.arg.debug&quot;))</span>
<span class="nc" id="L505">                          .hasArgs()</span>
<span class="nc" id="L506">                          .build());</span>
<span class="nc" id="L507">        options.addOption(Option.builder().longOpt(&quot;debug-run&quot;)</span>
<span class="nc" id="L508">                          .desc(Messages.message(&quot;cli.debug-run&quot;))</span>
<span class="nc" id="L509">                          .argName(Messages.message(&quot;cli.arg.debugRun&quot;))</span>
<span class="nc" id="L510">                          .hasArgs()</span>
<span class="nc" id="L511">                          .build());</span>
<span class="nc" id="L512">        options.addOption(Option.builder().longOpt(&quot;debug-start&quot;)</span>
<span class="nc" id="L513">                          .desc(Messages.message(&quot;cli.debug-start&quot;))</span>
<span class="nc" id="L514">                          .build());</span>
<span class="nc" id="L515">        options.addOption(Option.builder().longOpt(&quot;difficulty&quot;)</span>
<span class="nc" id="L516">                          .desc(Messages.message(&quot;cli.difficulty&quot;))</span>
<span class="nc" id="L517">                          .argName(Messages.message(&quot;cli.arg.difficulty&quot;))</span>
<span class="nc" id="L518">                          .hasArg()</span>
<span class="nc" id="L519">                          .build());</span>
<span class="nc" id="L520">        options.addOption(Option.builder().longOpt(&quot;europeans&quot;)</span>
<span class="nc" id="L521">                          .desc(Messages.message(&quot;cli.european-count&quot;))</span>
<span class="nc" id="L522">                          .argName(Messages.message(&quot;cli.arg.europeans&quot;))</span>
<span class="nc" id="L523">                          .hasArg()</span>
<span class="nc" id="L524">                          .build());</span>
<span class="nc" id="L525">        options.addOption(Option.builder().longOpt(&quot;fast&quot;)</span>
<span class="nc" id="L526">                          .desc(Messages.message(&quot;cli.fast&quot;))</span>
<span class="nc" id="L527">                          .build());</span>
<span class="nc" id="L528">        options.addOption(Option.builder().longOpt(&quot;font&quot;)</span>
<span class="nc" id="L529">                          .desc(Messages.message(&quot;cli.font&quot;))</span>
<span class="nc" id="L530">                          .argName(Messages.message(&quot;cli.arg.font&quot;))</span>
<span class="nc" id="L531">                          .hasArg()</span>
<span class="nc" id="L532">                          .build());</span>
<span class="nc" id="L533">        options.addOption(Option.builder().longOpt(&quot;full-screen&quot;)</span>
<span class="nc" id="L534">                          .desc(Messages.message(&quot;cli.full-screen&quot;))</span>
<span class="nc" id="L535">                          .build());</span>
<span class="nc" id="L536">        options.addOption(Option.builder().longOpt(&quot;gui-scale&quot;)</span>
<span class="nc" id="L537">                          .desc(Messages.message(StringTemplate</span>
<span class="nc" id="L538">                                  .template(&quot;cli.gui-scale&quot;)</span>
<span class="nc" id="L539">                                  .addName(&quot;%scales%&quot;, getValidGUIScales())))</span>
<span class="nc" id="L540">                          .argName(Messages.message(&quot;cli.arg.gui-scale&quot;))</span>
<span class="nc" id="L541">                          .optionalArg(true)</span>
<span class="nc" id="L542">                          .build());</span>
<span class="nc" id="L543">        options.addOption(Option.builder().longOpt(&quot;headless&quot;)</span>
<span class="nc" id="L544">                          .desc(Messages.message(&quot;cli.headless&quot;))</span>
<span class="nc" id="L545">                          .build());</span>
<span class="nc" id="L546">        options.addOption(Option.builder().longOpt(&quot;load-savegame&quot;)</span>
<span class="nc" id="L547">                          .desc(Messages.message(&quot;cli.load-savegame&quot;))</span>
<span class="nc" id="L548">                          .argName(Messages.message(&quot;cli.arg.file&quot;))</span>
<span class="nc" id="L549">                          .hasArg()</span>
<span class="nc" id="L550">                          .build());</span>
<span class="nc" id="L551">        options.addOption(Option.builder().longOpt(&quot;log-console&quot;)</span>
<span class="nc" id="L552">                          .desc(Messages.message(&quot;cli.log-console&quot;))</span>
<span class="nc" id="L553">                          .build());</span>
<span class="nc" id="L554">        options.addOption(Option.builder().longOpt(&quot;log-file&quot;)</span>
<span class="nc" id="L555">                          .desc(Messages.message(&quot;cli.log-file&quot;))</span>
<span class="nc" id="L556">                          .argName(Messages.message(&quot;cli.arg.name&quot;))</span>
<span class="nc" id="L557">                          .hasArg()</span>
<span class="nc" id="L558">                          .build());</span>
<span class="nc" id="L559">        options.addOption(Option.builder().longOpt(&quot;log-level&quot;)</span>
<span class="nc" id="L560">                          .desc(Messages.message(&quot;cli.log-level&quot;))</span>
<span class="nc" id="L561">                          .argName(Messages.message(&quot;cli.arg.loglevel&quot;))</span>
<span class="nc" id="L562">                          .hasArgs()</span>
<span class="nc" id="L563">                          .build());</span>
<span class="nc" id="L564">        options.addOption(Option.builder().longOpt(&quot;name&quot;)</span>
<span class="nc" id="L565">                          .desc(Messages.message(&quot;cli.name&quot;))</span>
<span class="nc" id="L566">                          .argName(Messages.message(&quot;cli.arg.name&quot;))</span>
<span class="nc" id="L567">                          .hasArg()</span>
<span class="nc" id="L568">                          .build());</span>
<span class="nc" id="L569">        options.addOption(Option.builder().longOpt(&quot;no-intro&quot;)</span>
<span class="nc" id="L570">                          .desc(Messages.message(&quot;cli.no-intro&quot;))</span>
<span class="nc" id="L571">                          .build());</span>
<span class="nc" id="L572">        options.addOption(Option.builder().longOpt(&quot;no-java-check&quot;)</span>
<span class="nc" id="L573">                          .desc(Messages.message(&quot;cli.no-java-check&quot;))</span>
<span class="nc" id="L574">                          .build());</span>
<span class="nc" id="L575">        options.addOption(Option.builder().longOpt(&quot;no-memory-check&quot;)</span>
<span class="nc" id="L576">                          .desc(Messages.message(&quot;cli.no-memory-check&quot;))</span>
<span class="nc" id="L577">                          .build());</span>
<span class="nc" id="L578">        options.addOption(Option.builder().longOpt(&quot;no-sound&quot;)</span>
<span class="nc" id="L579">                          .desc(Messages.message(&quot;cli.no-sound&quot;))</span>
<span class="nc" id="L580">                          .build());</span>
<span class="nc" id="L581">        options.addOption(Option.builder().longOpt(&quot;no-splash&quot;)</span>
<span class="nc" id="L582">                          .desc(Messages.message(&quot;cli.no-splash&quot;))</span>
<span class="nc" id="L583">                          .build());</span>
<span class="nc" id="L584">        options.addOption(Option.builder().longOpt(&quot;private&quot;)</span>
<span class="nc" id="L585">                          .desc(Messages.message(&quot;cli.private&quot;))</span>
<span class="nc" id="L586">                          .build());</span>
<span class="nc" id="L587">        options.addOption(Option.builder().longOpt(&quot;seed&quot;)</span>
<span class="nc" id="L588">                          .desc(Messages.message(&quot;cli.seed&quot;))</span>
<span class="nc" id="L589">                          .argName(Messages.message(&quot;cli.arg.seed&quot;))</span>
<span class="nc" id="L590">                          .hasArg()</span>
<span class="nc" id="L591">                          .build());</span>
<span class="nc" id="L592">        options.addOption(Option.builder().longOpt(&quot;server&quot;)</span>
<span class="nc" id="L593">                          .desc(Messages.message(&quot;cli.server&quot;))</span>
<span class="nc" id="L594">                          .build());</span>
<span class="nc" id="L595">        options.addOption(Option.builder().longOpt(&quot;server-name&quot;)</span>
<span class="nc" id="L596">                          .desc(Messages.message(&quot;cli.server-name&quot;))</span>
<span class="nc" id="L597">                          .argName(Messages.message(&quot;cli.arg.name&quot;))</span>
<span class="nc" id="L598">                          .hasArg()</span>
<span class="nc" id="L599">                          .build());</span>
<span class="nc" id="L600">        options.addOption(Option.builder().longOpt(&quot;server-port&quot;)</span>
<span class="nc" id="L601">                          .desc(Messages.message(&quot;cli.server-port&quot;))</span>
<span class="nc" id="L602">                          .argName(Messages.message(&quot;cli.arg.port&quot;))</span>
<span class="nc" id="L603">                          .hasArg()</span>
<span class="nc" id="L604">                          .build());</span>
<span class="nc" id="L605">        options.addOption(Option.builder().longOpt(&quot;splash&quot;)</span>
<span class="nc" id="L606">                          .desc(Messages.message(&quot;cli.splash&quot;))</span>
<span class="nc" id="L607">                          .argName(Messages.message(&quot;cli.arg.file&quot;))</span>
<span class="nc" id="L608">                          .optionalArg(true)</span>
<span class="nc" id="L609">                          .build());</span>
<span class="nc" id="L610">        options.addOption(Option.builder().longOpt(&quot;tc&quot;)</span>
<span class="nc" id="L611">                          .desc(Messages.message(&quot;cli.tc&quot;))</span>
<span class="nc" id="L612">                          .argName(Messages.message(&quot;cli.arg.name&quot;))</span>
<span class="nc" id="L613">                          .hasArg()</span>
<span class="nc" id="L614">                          .build());</span>
<span class="nc" id="L615">        options.addOption(Option.builder().longOpt(&quot;timeout&quot;)</span>
<span class="nc" id="L616">                          .desc(Messages.message(&quot;cli.timeout&quot;))</span>
<span class="nc" id="L617">                          .argName(Messages.message(&quot;cli.arg.timeout&quot;))</span>
<span class="nc" id="L618">                          .hasArg()</span>
<span class="nc" id="L619">                          .build());</span>
<span class="nc" id="L620">        options.addOption(Option.builder().longOpt(&quot;user-cache-directory&quot;)</span>
<span class="nc" id="L621">                          .desc(Messages.message(&quot;cli.user-cache-directory&quot;))</span>
<span class="nc" id="L622">                          .argName(argDirectory)</span>
<span class="nc" id="L623">                          .type(File.class)</span>
<span class="nc" id="L624">                          .hasArg()</span>
<span class="nc" id="L625">                          .build());</span>
<span class="nc" id="L626">        options.addOption(Option.builder().longOpt(&quot;user-config-directory&quot;)</span>
<span class="nc" id="L627">                          .desc(Messages.message(&quot;cli.user-config-directory&quot;))</span>
<span class="nc" id="L628">                          .argName(argDirectory)</span>
<span class="nc" id="L629">                          .type(File.class)</span>
<span class="nc" id="L630">                          .hasArg()</span>
<span class="nc" id="L631">                          .build());</span>
<span class="nc" id="L632">        options.addOption(Option.builder().longOpt(&quot;user-data-directory&quot;)</span>
<span class="nc" id="L633">                          .desc(Messages.message(&quot;cli.user-data-directory&quot;))</span>
<span class="nc" id="L634">                          .argName(argDirectory)</span>
<span class="nc" id="L635">                          .type(File.class)</span>
<span class="nc" id="L636">                          .hasArg()</span>
<span class="nc" id="L637">                          .build());</span>
<span class="nc" id="L638">        options.addOption(Option.builder().longOpt(&quot;version&quot;)</span>
<span class="nc" id="L639">                          .desc(Messages.message(&quot;cli.version&quot;))</span>
<span class="nc" id="L640">                          .build());</span>
<span class="nc" id="L641">        options.addOption(Option.builder().longOpt(&quot;windowed&quot;)</span>
<span class="nc" id="L642">                          .desc(Messages.message(&quot;cli.windowed&quot;))</span>
<span class="nc" id="L643">                          .argName(Messages.message(&quot;cli.arg.dimensions&quot;))</span>
<span class="nc" id="L644">                          .optionalArg(true)</span>
<span class="nc" id="L645">                          .build());</span>

<span class="nc" id="L647">        CommandLineParser parser = new DefaultParser();</span>
<span class="nc" id="L648">        boolean usageError = false;</span>
        try {
<span class="nc" id="L650">            CommandLine line = parser.parse(options, args);</span>
<span class="nc bnc" id="L651" title="All 4 branches missed.">            if (line.hasOption(&quot;help&quot;) || line.hasOption(&quot;usage&quot;)) {</span>
<span class="nc" id="L652">                printUsage(options, 0);</span>
            }

<span class="nc bnc" id="L655" title="All 2 branches missed.">            if (line.hasOption(&quot;default-locale&quot;)) {</span>
                ; // Do nothing, already handled in main().
            }
<span class="nc bnc" id="L658" title="All 2 branches missed.">            if (line.hasOption(&quot;freecol-data&quot;)) {</span>
                ; // Do nothing, already handled in main().
            }

<span class="nc bnc" id="L662" title="All 2 branches missed.">            if (line.hasOption(&quot;advantages&quot;)) {</span>
<span class="nc" id="L663">                String arg = line.getOptionValue(&quot;advantages&quot;);</span>
<span class="nc" id="L664">                Advantages a = selectAdvantages(arg);</span>
<span class="nc bnc" id="L665" title="All 2 branches missed.">                if (a == null) {</span>
<span class="nc" id="L666">                    fatal(StringTemplate.template(&quot;cli.error.advantages&quot;)</span>
<span class="nc" id="L667">                        .addName(&quot;%advantages%&quot;, getValidAdvantages())</span>
<span class="nc" id="L668">                        .addName(&quot;%arg%&quot;, arg));</span>
                }
            }

<span class="nc bnc" id="L672" title="All 2 branches missed.">            if (line.hasOption(&quot;check-savegame&quot;)) {</span>
<span class="nc" id="L673">                String arg = line.getOptionValue(&quot;check-savegame&quot;);</span>
<span class="nc bnc" id="L674" title="All 2 branches missed.">                if (!FreeColDirectories.setSavegameFile(arg)) {</span>
<span class="nc" id="L675">                    fatal(StringTemplate.template(&quot;cli.err.save&quot;)</span>
<span class="nc" id="L676">                        .addName(&quot;%string%&quot;, arg));</span>
                }
<span class="nc" id="L678">                checkIntegrity = true;</span>
<span class="nc" id="L679">                standAloneServer = true;</span>
            }

<span class="nc bnc" id="L682" title="All 2 branches missed.">            if (line.hasOption(&quot;clientOptions&quot;)) {</span>
<span class="nc" id="L683">                String fileName = line.getOptionValue(&quot;clientOptions&quot;);</span>
<span class="nc bnc" id="L684" title="All 2 branches missed.">                if (!FreeColDirectories.setClientOptionsFile(fileName)) {</span>
                    // Not fatal.
<span class="nc" id="L686">                    gripe(StringTemplate.template(&quot;cli.error.clientOptions&quot;)</span>
<span class="nc" id="L687">                        .addName(&quot;%string%&quot;, fileName));</span>
                }
            }

<span class="nc bnc" id="L691" title="All 2 branches missed.">            if (line.hasOption(&quot;debug&quot;)) {</span>
                // If the optional argument is supplied use limited mode.
<span class="nc" id="L693">                String arg = line.getOptionValue(&quot;debug&quot;);</span>
<span class="nc bnc" id="L694" title="All 4 branches missed.">                if (arg == null || arg.isEmpty()) {</span>
                    // Let empty argument default to menus functionality.
<span class="nc" id="L696">                    arg = FreeColDebugger.DebugMode.MENUS.toString();</span>
                }
<span class="nc bnc" id="L698" title="All 2 branches missed.">                if (!FreeColDebugger.setDebugModes(arg)) { // Not fatal.</span>
<span class="nc" id="L699">                    gripe(StringTemplate.template(&quot;cli.error.debug&quot;)</span>
<span class="nc" id="L700">                        .addName(&quot;%modes%&quot;, FreeColDebugger.getDebugModes()));</span>
                }
                // Keep doing this before checking log-level option!
<span class="nc" id="L703">                logLevels.add(new LogLevel(&quot;&quot;, Level.FINEST));</span>
            }
<span class="nc bnc" id="L705" title="All 2 branches missed.">            if (line.hasOption(&quot;debug-run&quot;)) {</span>
<span class="nc" id="L706">                FreeColDebugger.enableDebugMode(FreeColDebugger.DebugMode.MENUS);</span>
<span class="nc" id="L707">                FreeColDebugger.configureDebugRun(line.getOptionValue(&quot;debug-run&quot;));</span>
            }
<span class="nc bnc" id="L709" title="All 2 branches missed.">            if (line.hasOption(&quot;debug-start&quot;)) {</span>
<span class="nc" id="L710">                debugStart = true;</span>
<span class="nc" id="L711">                FreeColDebugger.enableDebugMode(FreeColDebugger.DebugMode.MENUS);</span>
            }

<span class="nc bnc" id="L714" title="All 2 branches missed.">            if (line.hasOption(&quot;difficulty&quot;)) {</span>
<span class="nc" id="L715">                String arg = line.getOptionValue(&quot;difficulty&quot;);</span>
<span class="nc" id="L716">                String difficulty = selectDifficulty(arg);</span>
<span class="nc bnc" id="L717" title="All 2 branches missed.">                if (difficulty == null) {</span>
<span class="nc" id="L718">                    fatal(StringTemplate.template(&quot;cli.error.difficulties&quot;)</span>
<span class="nc" id="L719">                        .addName(&quot;%difficulties%&quot;, getValidDifficulties())</span>
<span class="nc" id="L720">                        .addName(&quot;%arg%&quot;, arg));</span>
                }
            }

<span class="nc bnc" id="L724" title="All 2 branches missed.">            if (line.hasOption(&quot;europeans&quot;)) {</span>
<span class="nc" id="L725">                int e = selectEuropeanCount(line.getOptionValue(&quot;europeans&quot;));</span>
<span class="nc bnc" id="L726" title="All 2 branches missed.">                if (e &lt; 0) {</span>
<span class="nc" id="L727">                    gripe(StringTemplate.template(&quot;cli.error.europeans&quot;)</span>
<span class="nc" id="L728">                        .addAmount(&quot;%min%&quot;, EUROPEANS_MIN));</span>
                }
            }

<span class="nc bnc" id="L732" title="All 2 branches missed.">            if (line.hasOption(&quot;fast&quot;)) {</span>
<span class="nc" id="L733">                fastStart = true;</span>
<span class="nc" id="L734">                introVideo = false;</span>
            }

<span class="nc bnc" id="L737" title="All 2 branches missed.">            if (line.hasOption(&quot;font&quot;)) {</span>
<span class="nc" id="L738">                fontName = line.getOptionValue(&quot;font&quot;);</span>
            }

<span class="nc bnc" id="L741" title="All 2 branches missed.">            if (line.hasOption(&quot;full-screen&quot;)) {</span>
<span class="nc" id="L742">                windowSize = null;</span>
            }

<span class="nc bnc" id="L745" title="All 2 branches missed.">            if (line.hasOption(&quot;gui-scale&quot;)) {</span>
<span class="nc" id="L746">                String arg = line.getOptionValue(&quot;gui-scale&quot;);</span>
<span class="nc bnc" id="L747" title="All 2 branches missed.">                if(!setGUIScale(arg)) {</span>
<span class="nc" id="L748">                    gripe(StringTemplate.template(&quot;cli.error.gui-scale&quot;)</span>
<span class="nc" id="L749">                        .addName(&quot;%scales%&quot;, getValidGUIScales())</span>
<span class="nc" id="L750">                        .addName(&quot;%arg%&quot;, arg));</span>
                }
            }

<span class="nc bnc" id="L754" title="All 2 branches missed.">            if (line.hasOption(&quot;headless&quot;)) {</span>
<span class="nc" id="L755">                headless = true;</span>
            }

<span class="nc bnc" id="L758" title="All 2 branches missed.">            if (line.hasOption(&quot;load-savegame&quot;)) {</span>
<span class="nc" id="L759">                String arg = line.getOptionValue(&quot;load-savegame&quot;);</span>
<span class="nc bnc" id="L760" title="All 2 branches missed.">                if (!FreeColDirectories.setSavegameFile(arg)) {</span>
<span class="nc" id="L761">                    fatal(StringTemplate.template(&quot;cli.error.save&quot;)</span>
<span class="nc" id="L762">                        .addName(&quot;%string%&quot;, arg));</span>
                }
            }

<span class="nc bnc" id="L766" title="All 2 branches missed.">            if (line.hasOption(&quot;log-console&quot;)) {</span>
<span class="nc" id="L767">                consoleLogging = true;</span>
            }

<span class="nc bnc" id="L770" title="All 2 branches missed.">            if (line.hasOption(&quot;log-file&quot;)) {</span>
<span class="nc" id="L771">                FreeColDirectories.setLogFilePath(line.getOptionValue(&quot;log-file&quot;));</span>
            }

<span class="nc bnc" id="L774" title="All 2 branches missed.">            if (line.hasOption(&quot;log-level&quot;)) {</span>
<span class="nc bnc" id="L775" title="All 2 branches missed.">                for (String value : line.getOptionValues(&quot;log-level&quot;)) {</span>
<span class="nc" id="L776">                    String[] s = value.split(&quot;:&quot;);</span>
<span class="nc bnc" id="L777" title="All 2 branches missed.">                    logLevels.add((s.length == 1)</span>
<span class="nc" id="L778">                        ? new LogLevel(&quot;&quot;, Level.parse(s[0].toUpperCase()))</span>
<span class="nc" id="L779">                        : new LogLevel(s[0], Level.parse(s[1].toUpperCase())));</span>
                }
            }

<span class="nc bnc" id="L783" title="All 2 branches missed.">            if (line.hasOption(&quot;name&quot;)) {</span>
<span class="nc" id="L784">                setName(line.getOptionValue(&quot;name&quot;));</span>
            }

<span class="nc bnc" id="L787" title="All 2 branches missed.">            if (line.hasOption(&quot;no-intro&quot;)) {</span>
<span class="nc" id="L788">                introVideo = false;</span>
            }
<span class="nc bnc" id="L790" title="All 2 branches missed.">            if (line.hasOption(&quot;no-java-check&quot;)) {</span>
<span class="nc" id="L791">                javaCheck = false;</span>
            }
<span class="nc bnc" id="L793" title="All 2 branches missed.">            if (line.hasOption(&quot;no-memory-check&quot;)) {</span>
<span class="nc" id="L794">                memoryCheck = false;</span>
            }
<span class="nc bnc" id="L796" title="All 2 branches missed.">            if (line.hasOption(&quot;no-sound&quot;)) {</span>
<span class="nc" id="L797">                sound = false;</span>
            }
<span class="nc bnc" id="L799" title="All 2 branches missed.">            if (line.hasOption(&quot;no-splash&quot;)) {</span>
<span class="nc" id="L800">                splashStream = null;</span>
            }

<span class="nc bnc" id="L803" title="All 2 branches missed.">            if (line.hasOption(&quot;private&quot;)) {</span>
<span class="nc" id="L804">                publicServer = false;</span>
            }

<span class="nc bnc" id="L807" title="All 2 branches missed.">            if (line.hasOption(&quot;server&quot;)) {</span>
<span class="nc" id="L808">                standAloneServer = true;</span>
            }
<span class="nc bnc" id="L810" title="All 2 branches missed.">            if (line.hasOption(&quot;server-name&quot;)) {</span>
<span class="nc" id="L811">                serverName = line.getOptionValue(&quot;server-name&quot;);</span>
            }
<span class="nc bnc" id="L813" title="All 2 branches missed.">            if (line.hasOption(&quot;server-port&quot;)) {</span>
<span class="nc" id="L814">                String arg = line.getOptionValue(&quot;server-port&quot;);</span>
<span class="nc bnc" id="L815" title="All 2 branches missed.">                if (!setServerPort(arg)) {</span>
<span class="nc" id="L816">                    fatal(StringTemplate.template(&quot;cli.error.serverPort&quot;)</span>
<span class="nc" id="L817">                        .addName(&quot;%string%&quot;, arg));</span>
                }
            }

<span class="nc bnc" id="L821" title="All 2 branches missed.">            if (line.hasOption(&quot;seed&quot;)) {</span>
<span class="nc" id="L822">                FreeColSeed.setFreeColSeed(line.getOptionValue(&quot;seed&quot;));</span>
            }

<span class="nc bnc" id="L825" title="All 2 branches missed.">            if (line.hasOption(&quot;splash&quot;)) {</span>
<span class="nc" id="L826">                String splash = line.getOptionValue(&quot;splash&quot;);</span>
                try {
<span class="nc" id="L828">                    FileInputStream fis = new FileInputStream(splash);</span>
<span class="nc" id="L829">                    splashStream = fis;</span>
<span class="nc" id="L830">                } catch (FileNotFoundException fnfe) {</span>
<span class="nc" id="L831">                    gripe(StringTemplate.template(&quot;cli.error.splash&quot;)</span>
<span class="nc" id="L832">                        .addName(&quot;%name%&quot;, splash));</span>
                }
            }

<span class="nc bnc" id="L836" title="All 2 branches missed.">            if (line.hasOption(&quot;tc&quot;)) {</span>
<span class="nc" id="L837">                setTC(line.getOptionValue(&quot;tc&quot;)); // Failure is deferred.</span>
            }

<span class="nc bnc" id="L840" title="All 2 branches missed.">            if (line.hasOption(&quot;timeout&quot;)) {</span>
<span class="nc" id="L841">                String arg = line.getOptionValue(&quot;timeout&quot;);</span>
<span class="nc bnc" id="L842" title="All 2 branches missed.">                if (!setTimeout(arg)) { // Not fatal</span>
<span class="nc" id="L843">                    gripe(StringTemplate.template(&quot;cli.error.timeout&quot;)</span>
<span class="nc" id="L844">                        .addName(&quot;%string%&quot;, arg)</span>
<span class="nc" id="L845">                        .addName(&quot;%minimum%&quot;, Integer.toString(TIMEOUT_MIN)));</span>
                }
            }

<span class="nc bnc" id="L849" title="All 2 branches missed.">            if (line.hasOption(&quot;user-cache-directory&quot;)) {</span>
<span class="nc" id="L850">                String arg = line.getOptionValue(&quot;user-cache-directory&quot;);</span>
<span class="nc" id="L851">                String errMsg = FreeColDirectories.setUserCacheDirectory(arg);</span>
<span class="nc bnc" id="L852" title="All 2 branches missed.">                if (errMsg != null) { // Not fatal.</span>
<span class="nc" id="L853">                    gripe(StringTemplate.template(errMsg)</span>
<span class="nc" id="L854">                        .addName(&quot;%string%&quot;, arg));</span>
                }
            }

<span class="nc bnc" id="L858" title="All 2 branches missed.">            if (line.hasOption(&quot;user-config-directory&quot;)) {</span>
<span class="nc" id="L859">                String arg = line.getOptionValue(&quot;user-config-directory&quot;);</span>
<span class="nc" id="L860">                String errMsg = FreeColDirectories.setUserConfigDirectory(arg);</span>
<span class="nc bnc" id="L861" title="All 2 branches missed.">                if (errMsg != null) { // Not fatal.</span>
<span class="nc" id="L862">                    gripe(StringTemplate.template(errMsg)</span>
<span class="nc" id="L863">                        .addName(&quot;%string%&quot;, arg));</span>
                }
            }

<span class="nc bnc" id="L867" title="All 2 branches missed.">            if (line.hasOption(&quot;user-data-directory&quot;)) {</span>
<span class="nc" id="L868">                String arg = line.getOptionValue(&quot;user-data-directory&quot;);</span>
<span class="nc" id="L869">                String errMsg = FreeColDirectories.setUserDataDirectory(arg);</span>
<span class="nc bnc" id="L870" title="All 2 branches missed.">                if (errMsg != null) { // Fatal, unable to save.</span>
<span class="nc" id="L871">                    fatal(StringTemplate.template(errMsg)</span>
<span class="nc" id="L872">                        .addName(&quot;%string%&quot;, arg));</span>
                }
            }

<span class="nc bnc" id="L876" title="All 2 branches missed.">            if (line.hasOption(&quot;version&quot;)) {</span>
<span class="nc" id="L877">                System.out.println(&quot;FreeCol &quot; + getVersion());</span>
<span class="nc" id="L878">                System.exit(0);</span>
            }

<span class="nc bnc" id="L881" title="All 2 branches missed.">            if (line.hasOption(&quot;windowed&quot;)) {</span>
<span class="nc" id="L882">                String arg = line.getOptionValue(&quot;windowed&quot;);</span>
<span class="nc" id="L883">                setWindowSize(arg); // Does not fail</span>
            }

<span class="nc" id="L886">        } catch (ParseException e) {</span>
<span class="nc" id="L887">            System.err.println(&quot;\n&quot; + e.getMessage() + &quot;\n&quot;);</span>
<span class="nc" id="L888">            usageError = true;</span>
        }
<span class="nc bnc" id="L890" title="All 2 branches missed.">        if (usageError) printUsage(options, 1);</span>
<span class="nc" id="L891">    }</span>

    /**
     * Prints the usage message and exits.
     *
     * @param options The command line &lt;code&gt;Options&lt;/code&gt;.
     * @param status The status to exit with.
     */
    private static void printUsage(Options options, int status) {
<span class="nc" id="L900">        HelpFormatter formatter = new HelpFormatter();</span>
<span class="nc" id="L901">        formatter.printHelp(&quot;java -Xmx 256M -jar freecol.jar [OPTIONS]&quot;,</span>
<span class="nc" id="L902">                            options);</span>
<span class="nc" id="L903">        System.exit(status);</span>
<span class="nc" id="L904">    }</span>

    /**
     * Get the specification from a given TC file.
     *
     * @param tcf The &lt;code&gt;FreeColTcFile&lt;/code&gt; to load.
     * @param advantages An optional &lt;code&gt;Advantages&lt;/code&gt; setting.
     * @param difficulty An optional difficulty level.
     * @return A &lt;code&gt;Specification&lt;/code&gt;.
     */
    public static Specification loadSpecification(FreeColTcFile tcf,
                                                  Advantages advantages,
                                                  String difficulty) {
<span class="fc" id="L917">        Specification spec = null;</span>
        try {
<span class="pc bpc" id="L919" title="1 of 2 branches missed.">            if (tcf != null) spec = tcf.getSpecification();</span>
<span class="pc" id="L920">        } catch (IOException ioe) {</span>
<span class="nc" id="L921">            System.err.println(&quot;Spec read failed in &quot; + tcf.getId()</span>
<span class="nc" id="L922">                + &quot;: &quot; + ioe.getMessage() + &quot;\n&quot;);</span>
        }
<span class="pc bpc" id="L924" title="1 of 2 branches missed.">        if (spec != null) spec.prepare(advantages, difficulty);</span>
<span class="fc" id="L925">        return spec;</span>
    }

    /**
     * Get the specification from the specified TC.
     *
     * @return A &lt;code&gt;Specification&lt;/code&gt;, quits on error.
     */
    private static Specification getTCSpecification() {
<span class="nc" id="L934">        Specification spec = loadSpecification(getTCFile(), getAdvantages(),</span>
<span class="nc" id="L935">                                               getDifficulty());</span>
<span class="nc bnc" id="L936" title="All 2 branches missed.">        if (spec == null) {</span>
<span class="nc" id="L937">            fatal(StringTemplate.template(&quot;cli.error.badTC&quot;)</span>
<span class="nc" id="L938">                .addName(&quot;%tc%&quot;, getTC()));</span>
        }
<span class="nc" id="L940">        return spec;</span>
    }

    // Accessors, mutators and support for the cli variables.

    /**
     * Gets the default advantages type.
     *
     * @return Usually Advantages.SELECTABLE, but can be overridden at the
     *     command line.
     */
    public static Advantages getAdvantages() {
<span class="pc bpc" id="L952" title="1 of 2 branches missed.">        return (advantages == null) ? ADVANTAGES_DEFAULT</span>
<span class="nc" id="L953">            : advantages;</span>
    }

    /**
     * Sets the advantages type.
     *
     * Called from NewPanel when a selection is made.
     *
     * @param advantages The name of the new advantages type.
     * @return The type of advantages set, or null if none.
     */
    private static Advantages selectAdvantages(String advantages) {
<span class="nc" id="L965">        Advantages adv = find(Advantages.values(),</span>
<span class="nc" id="L966">            a -&gt; Messages.getName(a).equals(advantages), null);</span>
<span class="nc bnc" id="L967" title="All 2 branches missed.">        if (adv != null) setAdvantages(adv);</span>
<span class="nc" id="L968">        return adv;</span>
    }

    /**
     * Sets the advantages type.
     *
     * @param advantages The new &lt;code&gt;Advantages&lt;/code&gt; type.
     */
    public static void setAdvantages(Advantages advantages) {
<span class="nc" id="L977">        FreeCol.advantages = advantages;</span>
<span class="nc" id="L978">    }</span>

    /**
     * Gets a comma separated list of localized advantage type names.
     *
     * @return A list of advantage types.
     */
    private static String getValidAdvantages() {
<span class="nc" id="L986">        return Arrays.stream(Advantages.values())</span>
<span class="nc" id="L987">            .map(a -&gt; Messages.getName(a)).collect(Collectors.joining(&quot;,&quot;));</span>
    }

    /**
     * Gets the difficulty level.
     *
     * @return The name of a difficulty level.
     */
    public static String getDifficulty() {
<span class="nc bnc" id="L996" title="All 2 branches missed.">        return (difficulty == null) ? DIFFICULTY_DEFAULT : difficulty;</span>
    }

    /**
     * Selects a difficulty level.
     *
     * @param arg The supplied difficulty argument.
     * @return The name of the selected difficulty, or null if none.
     */
    public static String selectDifficulty(String arg) {
<span class="nc" id="L1006">        String difficulty = find(map(DIFFICULTIES, d -&gt; &quot;model.difficulty.&quot;+d),</span>
<span class="nc" id="L1007">            k -&gt; Messages.getName(k).equals(arg), null);</span>
<span class="nc bnc" id="L1008" title="All 2 branches missed.">        if (difficulty != null) setDifficulty(difficulty);</span>
<span class="nc" id="L1009">        return difficulty;</span>
    }

    /**
     * Sets the difficulty level.
     *
     * @param difficulty The actual &lt;code&gt;OptionGroup&lt;/code&gt;
     *     containing the difficulty level.
     */
    public static void setDifficulty(OptionGroup difficulty) {
<span class="nc" id="L1019">        setDifficulty(difficulty.getId());</span>
<span class="nc" id="L1020">    }</span>

    /**
     * Sets the difficulty level.
     *
     * @param difficulty The new difficulty.
     */
    public static void setDifficulty(String difficulty) {
<span class="nc" id="L1028">        FreeCol.difficulty = difficulty;</span>
<span class="nc" id="L1029">    }</span>

    /**
     * Gets the names of the valid difficulty levels.
     *
     * @return The valid difficulty levels, comma separated.
     */
    public static String getValidDifficulties() {
<span class="nc" id="L1037">        return Arrays.stream(DIFFICULTIES)</span>
<span class="nc" id="L1038">            .map(d -&gt; Messages.getName(&quot;model.difficulty.&quot; + d))</span>
<span class="nc" id="L1039">            .collect(Collectors.joining(&quot;,&quot;));</span>
    }

    /**
     * Get the number of European nations to enable by default.
     *
     * @return The default European nation count.
     */
    public static int getEuropeanCount() {
<span class="fc" id="L1048">        return europeanCount;</span>
    }

    /**
     * Sets the number of enabled European nations.
     *
     * @param n The number of nations to enable.
     */
    public static void setEuropeanCount(int n) {
<span class="nc" id="L1057">        europeanCount = n;</span>
<span class="nc" id="L1058">    }</span>

    /**
     * Sets the scale for GUI elements.
     * 
     * @param arg The optional command line argument to be parsed.
     * @return If the argument was correctly formatted.
     */
    public static boolean setGUIScale(String arg) {
<span class="nc" id="L1067">        boolean valid = true;</span>
<span class="nc bnc" id="L1068" title="All 2 branches missed.">        if(arg == null) {</span>
<span class="nc" id="L1069">            guiScale = GUI_SCALE_MAX;</span>
<span class="nc" id="L1070">        } else {</span>
            try {
<span class="nc" id="L1072">                int n = Integer.parseInt(arg);</span>
<span class="nc bnc" id="L1073" title="All 2 branches missed.">                if (n &lt; GUI_SCALE_MIN_PCT) {</span>
<span class="nc" id="L1074">                    valid = false;</span>
<span class="nc" id="L1075">                    n = GUI_SCALE_MIN_PCT;</span>
<span class="nc bnc" id="L1076" title="All 2 branches missed.">                } else if(n &gt; GUI_SCALE_MAX_PCT) {</span>
<span class="nc" id="L1077">                    valid = false;</span>
<span class="nc" id="L1078">                    n = GUI_SCALE_MAX_PCT;</span>
<span class="nc bnc" id="L1079" title="All 2 branches missed.">                } else if(n % GUI_SCALE_STEP_PCT != 0) {</span>
<span class="nc" id="L1080">                    valid = false;</span>
                }
<span class="nc" id="L1082">                guiScale = ((float)(n / GUI_SCALE_STEP_PCT)) * GUI_SCALE_STEP;</span>
<span class="nc" id="L1083">            } catch (NumberFormatException nfe) {</span>
<span class="nc" id="L1084">                valid = false;</span>
<span class="nc" id="L1085">                guiScale = GUI_SCALE_MAX;</span>
            }
        }
<span class="nc" id="L1088">        return valid;</span>
    }

    /**
     * Gets the valid scale factors for the GUI.
     * 
     * @return A string containing these.
     */
    public static String getValidGUIScales() {
<span class="nc" id="L1097">        String result = &quot;&quot;;</span>
<span class="nc bnc" id="L1098" title="All 2 branches missed.">        for(int i=GUI_SCALE_MIN_PCT; i&lt;GUI_SCALE_MAX_PCT; i+=GUI_SCALE_STEP_PCT)</span>
<span class="nc" id="L1099">            result += i + &quot;,&quot;;</span>
<span class="nc" id="L1100">        result += GUI_SCALE_MAX_PCT;</span>
<span class="nc" id="L1101">        return result;</span>
    }

    /**
     * Selects a European nation count.
     *
     * @param arg The supplied count argument.
     * @return A valid nation number, or negative on error.
     */
    public static int selectEuropeanCount(String arg) {
        try {
<span class="nc" id="L1112">            int n = Integer.parseInt(arg);</span>
<span class="nc bnc" id="L1113" title="All 2 branches missed.">            if (n &gt;= EUROPEANS_MIN) {</span>
<span class="nc" id="L1114">                setEuropeanCount(n);</span>
<span class="nc" id="L1115">                return n;</span>
            }
<span class="nc" id="L1117">        } catch (NumberFormatException nfe) {}</span>
<span class="nc" id="L1118">        return -1;</span>
    }

    /**
     * Gets the user name.
     *
     * @return The user name, defaults to the user.name property, then to
     *     the &quot;main.defaultPlayerName&quot; message value.
     */
    public static String getName() {
<span class="pc bpc" id="L1128" title="1 of 2 branches missed.">        return (name != null) ? name</span>
<span class="fc" id="L1129">            : System.getProperty(&quot;user.name&quot;,</span>
<span class="fc" id="L1130">                                 Messages.message(&quot;main.defaultPlayerName&quot;));</span>
    }

    /**
     * Sets the user name.
     *
     * @param name The new user name.
     */
    public static void setName(String name) {
<span class="nc" id="L1139">        FreeCol.name = name;</span>
<span class="nc" id="L1140">        logger.info(&quot;Set FreeCol.name = &quot; + name);</span>
<span class="nc" id="L1141">    }</span>

    /**
     * Get the selected locale.
     *
     * @return The &lt;code&gt;Locale&lt;/code&gt; currently in use.
     */
    public static Locale getLocale() {
<span class="nc" id="L1149">        return FreeCol.locale;</span>
    }
    
    /**
     * Gets the current revision of game.
     *
     * @return The current version and SVN Revision of the game.
     */
    public static String getRevision() {
<span class="fc" id="L1158">        return freeColRevision;</span>
    }

    /**
     * Get the default server host name.
     *
     * @return The host name.
     */
    public static String getServerHost() {
<span class="nc" id="L1167">        return InetAddress.getLoopbackAddress().getHostAddress();</span>
    }

    /**
     * Gets the server network port.
     *
     * @return The port number.
     */
    public static int getServerPort() {
<span class="pc bpc" id="L1176" title="1 of 2 branches missed.">        return (serverPort &lt; 0) ? PORT_DEFAULT : serverPort;</span>
    }

    /**
     * Sets the server port.
     *
     * @param arg The server port number.
     * @return True if the port was set.
     */
    public static boolean setServerPort(String arg) {
<span class="nc bnc" id="L1186" title="All 2 branches missed.">        if (arg == null) return false;</span>
        try {
<span class="nc" id="L1188">            serverPort = Integer.parseInt(arg);</span>
<span class="nc" id="L1189">        } catch (NumberFormatException nfe) {</span>
<span class="nc" id="L1190">            return false;</span>
        }
<span class="nc" id="L1192">        return true;</span>
    }

    /**
     * Gets the current Total-Conversion.
     *
     * @return Usually TC_DEFAULT, but can be overridden at the command line.
     */
    public static String getTC() {
<span class="pc bpc" id="L1201" title="1 of 2 branches missed.">        return (tc == null) ? TC_DEFAULT : tc;</span>
    }

    /**
     * Sets the Total-Conversion.
     *
     * Called from NewPanel when a selection is made.
     *
     * @param tc The name of the new total conversion.
     */
    public static void setTC(String tc) {
<span class="nc" id="L1212">        FreeCol.tc = tc;</span>
<span class="nc" id="L1213">    }</span>

    /**
     * Gets the FreeColTcFile for the current TC.
     *
     * @return The &lt;code&gt;FreeColTcFile&lt;/code&gt;.
     */
    public static FreeColTcFile getTCFile() {
        try {
<span class="nc" id="L1222">            return new FreeColTcFile(getTC());</span>
<span class="nc" id="L1223">        } catch (IOException ioe) {}</span>
<span class="nc" id="L1224">        return null;</span>
    }

    /**
     * Gets the timeout.
     * Use the command line specified one if any, otherwise default
     * to `infinite' in single player and the TIMEOUT_DEFAULT for
     * multiplayer.
     *
     * @param singlePlayer True if this is a single player game.
     * @return A suitable timeout value.
     */
    public static int getTimeout(boolean singlePlayer) {
<span class="nc bnc" id="L1237" title="All 2 branches missed.">        return (timeout &gt;= TIMEOUT_MIN) ? timeout</span>
<span class="nc bnc" id="L1238" title="All 2 branches missed.">            : (singlePlayer) ? Integer.MAX_VALUE</span>
<span class="nc" id="L1239">            : TIMEOUT_DEFAULT;</span>
    }

    /**
     * Sets the timeout.
     *
     * @param timeout A string containing the new timeout.
     * @return True if the timeout was set.
     */
    public static boolean setTimeout(String timeout) {
        try {
<span class="nc" id="L1250">            int result = Integer.parseInt(timeout);</span>
<span class="nc bnc" id="L1251" title="All 2 branches missed.">            if (result &gt;= TIMEOUT_MIN) {</span>
<span class="nc" id="L1252">                FreeCol.timeout = result;</span>
<span class="nc" id="L1253">                return true;</span>
            }
<span class="nc" id="L1255">        } catch (NumberFormatException nfe) {}</span>
<span class="nc" id="L1256">        return false;</span>
    }

    /**
     * Gets the current version of game.
     *
     * @return The current version of the game using the format &quot;x.y.z&quot;,
     *         where &quot;x&quot; is major, &quot;y&quot; is minor and &quot;z&quot; is revision.
     */
    public static String getVersion() {
<span class="fc" id="L1266">        return FREECOL_VERSION;</span>
    }

    /**
     * Sets the window size.
     *
     * Does not fail because any empty or invalid value is interpreted as
     * `windowed but use as much screen as possible'.
     *
     * @param arg The window size specification.
     */
    private static void setWindowSize(String arg) {
        String[] xy;
<span class="nc bnc" id="L1279" title="All 2 branches missed.">        if (arg != null</span>
<span class="nc bnc" id="L1280" title="All 2 branches missed.">            &amp;&amp; (xy = arg.split(&quot;[^0-9]&quot;)) != null</span>
<span class="nc bnc" id="L1281" title="All 2 branches missed.">            &amp;&amp; xy.length == 2) {</span>
            try {
<span class="nc" id="L1283">                windowSize = new Dimension(Integer.parseInt(xy[0]),</span>
<span class="nc" id="L1284">                                           Integer.parseInt(xy[1]));</span>
<span class="nc" id="L1285">            } catch (NumberFormatException nfe) {}</span>
        }
<span class="nc bnc" id="L1287" title="All 2 branches missed.">        if (windowSize == null) windowSize = new Dimension(-1, -1);</span>
<span class="nc" id="L1288">    }</span>


    /**
     * Utility to make a load failure message.
     *
     * @param file The &lt;code&gt;File&lt;/code&gt; that failed to load.
     * @return A &lt;code&gt;StringTemplate&lt;/code&gt; with the error message.
     */
    public static StringTemplate badLoad(File file) {
<span class="nc" id="L1298">        return StringTemplate.template(&quot;error.couldNotLoad&quot;)</span>
<span class="nc" id="L1299">            .addName(&quot;%name%&quot;, file.getPath());</span>
    }

    /**
     * Utility to make a save failure message.
     *
     * @param file The &lt;code&gt;File&lt;/code&gt; that failed to save.
     * @return A &lt;code&gt;StringTemplate&lt;/code&gt; with the error message.
     */
    public static StringTemplate badSave(File file) {
<span class="nc" id="L1309">        return StringTemplate.template(&quot;error.couldNotSave&quot;)</span>
<span class="nc" id="L1310">            .addName(&quot;%name%&quot;, file.getPath());</span>
    }

    /**
     * We get a lot of lame bug reports with insufficient configuration
     * information.  Get a buffer containing as much information as we can
     * to embed in the log file and saved games.
     *
     * @return A &lt;code&gt;StringBuilder&lt;/code&gt; full of configuration information.
     */
    public static StringBuilder getConfiguration() {
<span class="fc" id="L1321">        File autosave = FreeColDirectories.getAutosaveDirectory();</span>
<span class="fc" id="L1322">        File clientOptionsFile = FreeColDirectories.getClientOptionsFile();</span>
<span class="fc" id="L1323">        File save = FreeColDirectories.getSaveDirectory();</span>
<span class="fc" id="L1324">        File userConfig = FreeColDirectories.getUserConfigDirectory();</span>
<span class="fc" id="L1325">        File userData = FreeColDirectories.getUserDataDirectory();</span>
<span class="fc" id="L1326">        File userMods = FreeColDirectories.getUserModsDirectory();</span>
<span class="fc" id="L1327">        StringBuilder sb = new StringBuilder(256);</span>
<span class="fc" id="L1328">        sb.append(&quot;Configuration:&quot;)</span>
<span class="fc" id="L1329">            .append(&quot;\n  version     &quot;).append(getRevision())</span>
<span class="fc" id="L1330">            .append(&quot;\n  java:       &quot;).append(JAVA_VERSION)</span>
<span class="fc" id="L1331">            .append(&quot;\n  memory:     &quot;).append(MEMORY_MAX)</span>
<span class="fc" id="L1332">            .append(&quot;\n  locale:     &quot;).append(locale)</span>
<span class="fc" id="L1333">            .append(&quot;\n  data:       &quot;)</span>
<span class="fc" id="L1334">            .append(FreeColDirectories.getDataDirectory().getPath())</span>
<span class="fc" id="L1335">            .append(&quot;\n  userConfig: &quot;)</span>
<span class="pc bpc" id="L1336" title="1 of 2 branches missed.">            .append((userConfig == null) ? &quot;NONE&quot; : userConfig.getPath())</span>
<span class="fc" id="L1337">            .append(&quot;\n  userData:   &quot;)</span>
<span class="pc bpc" id="L1338" title="1 of 2 branches missed.">            .append((userData == null) ? &quot;NONE&quot; : userData.getPath())</span>
<span class="fc" id="L1339">            .append(&quot;\n  autosave:   &quot;)</span>
<span class="pc bpc" id="L1340" title="1 of 2 branches missed.">            .append((autosave == null) ? &quot;NONE&quot; : autosave.getPath())</span>
<span class="fc" id="L1341">            .append(&quot;\n  logFile:    &quot;)</span>
<span class="fc" id="L1342">            .append(FreeColDirectories.getLogFilePath())</span>
<span class="fc" id="L1343">            .append(&quot;\n  options:    &quot;)</span>
<span class="pc bpc" id="L1344" title="1 of 2 branches missed.">            .append((clientOptionsFile == null) ? &quot;NONE&quot;</span>
<span class="fc" id="L1345">                : clientOptionsFile.getPath())</span>
<span class="fc" id="L1346">            .append(&quot;\n  save:       &quot;)</span>
<span class="pc bpc" id="L1347" title="1 of 2 branches missed.">            .append((save == null) ? &quot;NONE&quot; : save.getPath())</span>
<span class="fc" id="L1348">            .append(&quot;\n  userMods:   &quot;)</span>
<span class="pc bpc" id="L1349" title="1 of 2 branches missed.">            .append((userMods == null) ? &quot;NONE&quot; : userMods.getPath())</span>
<span class="fc" id="L1350">            .append(&quot;\n  debug:      &quot;)</span>
<span class="fc" id="L1351">            .append(FreeColDebugger.getDebugModes());</span>
<span class="fc" id="L1352">        return sb;</span>
    }


    // The major final actions.

    /**
     * Start a client.
     *
     * @param userMsg An optional user message key.
     */
    private static void startClient(String userMsg) {
<span class="nc" id="L1364">        Specification spec = null;</span>
<span class="nc" id="L1365">        File savegame = FreeColDirectories.getSavegameFile();</span>
<span class="nc bnc" id="L1366" title="All 2 branches missed.">        if (debugStart) {</span>
<span class="nc" id="L1367">            spec = FreeCol.getTCSpecification();</span>
<span class="nc bnc" id="L1368" title="All 2 branches missed.">        } else if (fastStart) {</span>
<span class="nc bnc" id="L1369" title="All 2 branches missed.">            if (savegame == null) {</span>
                // continue last saved game if possible,
                // otherwise start a new one
<span class="nc" id="L1372">                savegame = FreeColDirectories.getLastSaveGameFile();</span>
<span class="nc bnc" id="L1373" title="All 2 branches missed.">                if (savegame == null) {</span>
<span class="nc" id="L1374">                    spec = FreeCol.getTCSpecification();</span>
                }
            }
            // savegame was specified on command line
        }
<span class="nc" id="L1379">        final FreeColClient freeColClient</span>
<span class="nc" id="L1380">            = new FreeColClient(splashStream, fontName, guiScale, headless);</span>
<span class="nc" id="L1381">        freeColClient.startClient(windowSize, userMsg, sound, introVideo,</span>
<span class="nc" id="L1382">                                  savegame, spec);</span>
<span class="nc" id="L1383">    }</span>

    /**
     * Start the server.
     */
    private static void startServer() {
<span class="nc" id="L1389">        logger.info(&quot;Starting stand-alone server.&quot;);</span>
        final FreeColServer freeColServer;
<span class="nc" id="L1391">        File saveGame = FreeColDirectories.getSavegameFile();</span>
<span class="nc bnc" id="L1392" title="All 2 branches missed.">        if (saveGame != null) {</span>
            try {
<span class="nc" id="L1394">                final FreeColSavegameFile fis</span>
<span class="nc" id="L1395">                    = new FreeColSavegameFile(saveGame);</span>
<span class="nc" id="L1396">                freeColServer = new FreeColServer(fis, (Specification)null,</span>
<span class="nc" id="L1397">                                                  serverPort, serverName);</span>
<span class="nc bnc" id="L1398" title="All 2 branches missed.">                if (checkIntegrity) {</span>
<span class="nc bnc" id="L1399" title="All 2 branches missed.">                    boolean integrityOK = freeColServer.getIntegrity() &gt; 0;</span>
<span class="nc bnc" id="L1400" title="All 2 branches missed.">                    gripe((integrityOK)</span>
<span class="nc" id="L1401">                        ? &quot;cli.check-savegame.success&quot;</span>
<span class="nc" id="L1402">                        : &quot;cli.check-savegame.failure&quot;);</span>
<span class="nc bnc" id="L1403" title="All 2 branches missed.">                    System.exit((integrityOK) ? 0 : 2);</span>
                }
<span class="nc" id="L1405">            } catch (Exception e) {</span>
<span class="nc bnc" id="L1406" title="All 2 branches missed.">                if (checkIntegrity) gripe(&quot;cli.check-savegame.failure&quot;);</span>
<span class="nc" id="L1407">                fatal(Messages.message(badLoad(saveGame))</span>
<span class="nc" id="L1408">                    + &quot;: &quot; + e.getMessage());</span>
<span class="nc" id="L1409">                return;</span>
            }
        } else {
<span class="nc" id="L1412">            Specification spec = FreeCol.getTCSpecification();</span>
            try {
<span class="nc" id="L1414">                freeColServer = new FreeColServer(publicServer, false, spec,</span>
<span class="nc" id="L1415">                                                  serverPort, serverName);</span>
<span class="nc" id="L1416">            } catch (Exception e) {</span>
<span class="nc" id="L1417">                fatal(Messages.message(&quot;server.initialize&quot;)</span>
<span class="nc" id="L1418">                    + &quot;: &quot; + e.getMessage());</span>
<span class="nc" id="L1419">                return;</span>
            }
<span class="nc bnc" id="L1421" title="All 4 branches missed.">            if (publicServer &amp;&amp; freeColServer != null</span>
<span class="nc bnc" id="L1422" title="All 2 branches missed.">                &amp;&amp; !freeColServer.getPublicServer()) {</span>
<span class="nc" id="L1423">                gripe(Messages.message(&quot;server.noRouteToServer&quot;));</span>
            }
        }

<span class="nc" id="L1427">        String quit = FreeCol.SERVER_THREAD + &quot;Quit Game&quot;;</span>
<span class="nc" id="L1428">        Runtime.getRuntime().addShutdownHook(new Thread(quit) {</span>
                @Override
                public void run() {
<span class="nc" id="L1431">                    freeColServer.getController().shutdown();</span>
<span class="nc" id="L1432">                }</span>
            });
<span class="nc" id="L1434">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span>src (May 7, 2016 6:04:12 PM)</div></body></html>