<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>BuildingTest.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">src (May 7, 2016 6:04:12 PM)</a> &gt; <a href="../../index.html" class="el_group">FreeCol</a> &gt; <a href="../index.html" class="el_bundle">test/src</a> &gt; <a href="index.source.html" class="el_package">net.sf.freecol.common.model</a> &gt; <span class="el_source">BuildingTest.java</span></div><h1>BuildingTest.java</h1><pre class="source lang-java linenums">/**
 *  Copyright (C) 2002-2016  The FreeCol Team
 *
 *  This file is part of FreeCol.
 *
 *  FreeCol is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  FreeCol is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with FreeCol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package net.sf.freecol.common.model;

import java.io.StringWriter;
import java.util.Iterator;
import java.util.List;
import java.util.Set;

import net.sf.freecol.common.io.FreeColXMLWriter;
import net.sf.freecol.common.model.Modifier;
import net.sf.freecol.common.model.Modifier.ModifierType;
import net.sf.freecol.common.model.UnitLocation.NoAddReason;
import net.sf.freecol.common.model.Direction;
import net.sf.freecol.common.model.Tile;
import net.sf.freecol.server.model.ServerBuilding;
import net.sf.freecol.server.model.ServerUnit;
import net.sf.freecol.util.test.FreeColTestCase;


<span class="fc" id="L38">public class BuildingTest extends FreeColTestCase {</span>

<span class="fc" id="L40">    private static final BuildingType armoryType</span>
<span class="fc" id="L41">        = spec().getBuildingType(&quot;model.building.armory&quot;);</span>
<span class="fc" id="L42">    private static final BuildingType blacksmithType</span>
<span class="fc" id="L43">        = spec().getBuildingType(&quot;model.building.blacksmithHouse&quot;);</span>
<span class="fc" id="L44">    private static final BuildingType carpenterHouseType</span>
<span class="fc" id="L45">        = spec().getBuildingType(&quot;model.building.carpenterHouse&quot;);</span>
<span class="fc" id="L46">    private static final BuildingType chapelType</span>
<span class="fc" id="L47">        = spec().getBuildingType(&quot;model.building.chapel&quot;);</span>
<span class="fc" id="L48">    private static final BuildingType countryType</span>
<span class="fc" id="L49">        = spec().getBuildingType(&quot;model.building.country&quot;);</span>
<span class="fc" id="L50">    private static final BuildingType depotType</span>
<span class="fc" id="L51">        = spec().getBuildingType(&quot;model.building.depot&quot;);</span>
<span class="fc" id="L52">    private static final BuildingType fortType</span>
<span class="fc" id="L53">        = spec().getBuildingType(&quot;model.building.fort&quot;);</span>
<span class="fc" id="L54">    private static final BuildingType fortressType</span>
<span class="fc" id="L55">        = spec().getBuildingType(&quot;model.building.fortress&quot;);</span>
<span class="fc" id="L56">    private static final BuildingType newspaperType</span>
<span class="fc" id="L57">        = spec().getBuildingType(&quot;model.building.newspaper&quot;);</span>
<span class="fc" id="L58">    private static final BuildingType printingPressType</span>
<span class="fc" id="L59">        = spec().getBuildingType(&quot;model.building.printingPress&quot;);</span>
<span class="fc" id="L60">    private static final BuildingType schoolType</span>
<span class="fc" id="L61">        = spec().getBuildingType(&quot;model.building.schoolhouse&quot;);</span>
<span class="fc" id="L62">    private static final BuildingType stockadeType</span>
<span class="fc" id="L63">        = spec().getBuildingType(&quot;model.building.stockade&quot;);</span>
<span class="fc" id="L64">    private static final BuildingType townHallType</span>
<span class="fc" id="L65">        = spec().getBuildingType(&quot;model.building.townHall&quot;);</span>
<span class="fc" id="L66">    private static final BuildingType universityType</span>
<span class="fc" id="L67">        = spec().getBuildingType(&quot;model.building.university&quot;);</span>
<span class="fc" id="L68">    private static final BuildingType warehouseType</span>
<span class="fc" id="L69">        = spec().getBuildingType(&quot;model.building.warehouse&quot;);</span>
<span class="fc" id="L70">    private static final BuildingType weaverHouseType</span>
<span class="fc" id="L71">        = spec().getBuildingType(&quot;model.building.weaverHouse&quot;);</span>

<span class="fc" id="L73">    private static final GoodsType bellsType</span>
<span class="fc" id="L74">        = spec().getGoodsType(&quot;model.goods.bells&quot;);</span>
<span class="fc" id="L75">    private static final GoodsType clothType</span>
<span class="fc" id="L76">        = spec().getGoodsType(&quot;model.goods.cloth&quot;);</span>
<span class="fc" id="L77">    private static final GoodsType cottonType</span>
<span class="fc" id="L78">        = spec().getGoodsType(&quot;model.goods.cotton&quot;);</span>
<span class="fc" id="L79">    private static final GoodsType crossesType</span>
<span class="fc" id="L80">        = spec().getGoodsType(&quot;model.goods.crosses&quot;);</span>
<span class="fc" id="L81">    private static final GoodsType foodType</span>
<span class="fc" id="L82">        = spec().getPrimaryFoodType();</span>
<span class="fc" id="L83">    private static final GoodsType grainType</span>
<span class="fc" id="L84">        = spec().getGoodsType(&quot;model.goods.grain&quot;);</span>
<span class="fc" id="L85">    private static final GoodsType hammersType</span>
<span class="fc" id="L86">        = spec().getGoodsType(&quot;model.goods.hammers&quot;);</span>
<span class="fc" id="L87">    private static final GoodsType horsesType</span>
<span class="fc" id="L88">        = spec().getGoodsType(&quot;model.goods.horses&quot;);</span>
<span class="fc" id="L89">    private static final GoodsType lumberType</span>
<span class="fc" id="L90">        = spec().getGoodsType(&quot;model.goods.lumber&quot;);</span>
<span class="fc" id="L91">    private static final GoodsType musketsType</span>
<span class="fc" id="L92">        = spec().getGoodsType(&quot;model.goods.muskets&quot;);</span>
<span class="fc" id="L93">    private static final GoodsType oreType</span>
<span class="fc" id="L94">        = spec().getGoodsType(&quot;model.goods.ore&quot;);</span>
<span class="fc" id="L95">    private static final GoodsType toolsType</span>
<span class="fc" id="L96">        = spec().getGoodsType(&quot;model.goods.tools&quot;);</span>

<span class="fc" id="L98">    private static final Role missionaryRole</span>
<span class="fc" id="L99">        = spec().getRole(&quot;model.role.missionary&quot;);</span>

<span class="fc" id="L101">    private static final TileType plainsType</span>
<span class="fc" id="L102">        = spec().getTileType(&quot;model.tile.plains&quot;);</span>

<span class="fc" id="L104">    private static final UnitType elderStatesmanType</span>
<span class="fc" id="L105">        = spec().getUnitType(&quot;model.unit.elderStatesman&quot;);</span>
<span class="fc" id="L106">    private static final UnitType expertFarmerType</span>
<span class="fc" id="L107">        = spec().getUnitType(&quot;model.unit.expertFarmer&quot;);</span>
<span class="fc" id="L108">    private static final UnitType firebrandPreacherType</span>
<span class="fc" id="L109">        = spec().getUnitType(&quot;model.unit.firebrandPreacher&quot;);</span>
<span class="fc" id="L110">    private static final UnitType freeColonistType</span>
<span class="fc" id="L111">        = spec().getUnitType(&quot;model.unit.freeColonist&quot;);</span>
<span class="fc" id="L112">    private static final UnitType indenturedServantType</span>
<span class="fc" id="L113">        = spec().getUnitType(&quot;model.unit.indenturedServant&quot;);</span>
<span class="fc" id="L114">    private static final UnitType indianConvertType</span>
<span class="fc" id="L115">        = spec().getUnitType(&quot;model.unit.indianConvert&quot;);</span>
<span class="fc" id="L116">    private static final UnitType masterCarpenterType</span>
<span class="fc" id="L117">        = spec().getUnitType(&quot;model.unit.masterCarpenter&quot;);</span>
<span class="fc" id="L118">    private static final UnitType masterDistillerType</span>
<span class="fc" id="L119">        = spec().getUnitType(&quot;model.unit.masterDistiller&quot;);</span>
<span class="fc" id="L120">    private static final UnitType pettyCriminalType</span>
<span class="fc" id="L121">        = spec().getUnitType(&quot;model.unit.pettyCriminal&quot;);</span>


    public void testCanBuildNext() {
<span class="fc" id="L125">        Game game = getGame();</span>
<span class="fc" id="L126">        game.setMap(getTestMap(true));</span>

<span class="fc" id="L128">        Colony colony = getStandardColony();</span>

        // First check with a building that can be fully built with a
        // normal colony
<span class="fc" id="L132">        Building warehouse = new ServerBuilding(getGame(), colony, depotType);</span>
<span class="fc" id="L133">        colony.addBuilding(warehouse);</span>
<span class="fc" id="L134">        assertTrue(warehouse.canBuildNext());</span>
<span class="fc" id="L135">        assertNotNull(warehouse.upgrade());</span>
<span class="fc" id="L136">        assertTrue(warehouse.canBuildNext());</span>
<span class="fc" id="L137">        assertNotNull(warehouse.upgrade());</span>
<span class="fc" id="L138">        assertFalse(warehouse.canBuildNext());</span>

<span class="fc" id="L140">        assertNull(warehouse.upgrade());</span>
<span class="fc" id="L141">        assertFalse(warehouse.canBuildNext());</span>

        // Check whether population restrictions work

        // Colony smallColony = getStandardColony(1);
        //
        // Colony largeColony = getStandardColony(6);
        // ...

        // Check whether founding fathers work

<span class="fc" id="L152">    }</span>

    public void testStockadeRequiresMinimumPopulation() {
<span class="fc" id="L155">        Game game = getGame();</span>
<span class="fc" id="L156">        game.setMap(getTestMap(true));</span>
<span class="fc" id="L157">        Colony colony = getStandardColony(2);</span>
<span class="fc" id="L158">        assertEquals(Colony.NoBuildReason.POPULATION_TOO_SMALL,</span>
<span class="fc" id="L159">                     colony.getNoBuildReason(stockadeType, null));</span>

<span class="fc" id="L161">        Unit colonist = new ServerUnit(game, colony.getTile(), colony.getOwner(), freeColonistType);</span>
<span class="fc" id="L162">        colonist.setLocation(colony);</span>

<span class="fc" id="L164">        assertEquals(Colony.NoBuildReason.NONE,</span>
<span class="fc" id="L165">                     colony.getNoBuildReason(stockadeType, null));</span>
<span class="fc" id="L166">    }</span>

    public void testFortRequiresMinimumPopulation() {
<span class="fc" id="L169">        Game game = getGame();</span>
<span class="fc" id="L170">        game.setMap(getTestMap(true));</span>
<span class="fc" id="L171">        Colony colony = getStandardColony(2);</span>
<span class="fc" id="L172">        assertEquals(Colony.NoBuildReason.POPULATION_TOO_SMALL,</span>
<span class="fc" id="L173">                     colony.getNoBuildReason(fortType, null));</span>

<span class="fc" id="L175">        Unit colonist = new ServerUnit(game, colony.getTile(), colony.getOwner(), freeColonistType);</span>
<span class="fc" id="L176">        colonist.setLocation(colony);</span>

<span class="fc" id="L178">        colony.addBuilding(new ServerBuilding(game, colony, stockadeType));</span>
<span class="fc" id="L179">        assertEquals(Colony.NoBuildReason.NONE,</span>
<span class="fc" id="L180">                     colony.getNoBuildReason(fortType, null));</span>
<span class="fc" id="L181">    }</span>

    public void testFortressRequiresMinimumPopulation() {
<span class="fc" id="L184">        Game game = getGame();</span>
<span class="fc" id="L185">        game.setMap(getTestMap(true));</span>

<span class="fc" id="L187">        Colony colony = getStandardColony(7);</span>
<span class="fc" id="L188">        colony.addBuilding(new ServerBuilding(game, colony, stockadeType));</span>
<span class="fc" id="L189">        colony.addBuilding(new ServerBuilding(game, colony, fortType));</span>
<span class="fc" id="L190">        assertEquals(Colony.NoBuildReason.POPULATION_TOO_SMALL,</span>
<span class="fc" id="L191">                     colony.getNoBuildReason(fortressType, null));</span>

<span class="fc" id="L193">        Unit colonist = new ServerUnit(game, colony.getTile(), colony.getOwner(), freeColonistType);</span>
<span class="fc" id="L194">        colonist.setLocation(colony);</span>

<span class="fc" id="L196">        assertEquals(8, colony.getUnitCount());</span>
<span class="fc" id="L197">        assertEquals(Colony.NoBuildReason.NONE,</span>
<span class="fc" id="L198">                     colony.getNoBuildReason(fortressType, null));</span>
<span class="fc" id="L199">    }</span>

    public void testInitialColony() {
<span class="fc" id="L202">        Game game = getGame();</span>
<span class="fc" id="L203">        game.setMap(getTestMap(true));</span>

<span class="fc" id="L205">        Colony colony = getStandardColony();</span>

<span class="fc" id="L207">        Building warehouse = colony.getBuilding(warehouseType);</span>

        // Is build as depot...
<span class="pc bpc" id="L210" title="1 of 2 branches missed.">        assertTrue(warehouse != null);</span>

<span class="fc" id="L212">        assertTrue(warehouse.canBuildNext());</span>

        // Check other building...

        // Check dock -&gt; only possible if not landlocked...

<span class="fc" id="L218">    }</span>

    public void testChurch() {
<span class="fc" id="L221">        Game game = getGame();</span>
<span class="fc" id="L222">        game.setMap(getTestMap(true));</span>

        // Make a colony big enough to build a cathedral, and add enough
        // liberty to zero the production bonus.
<span class="fc" id="L226">        Colony colony = getStandardColony(10);</span>
<span class="fc bfc" id="L227" title="All 2 branches covered.">        while (colony.getProductionBonus() &lt; 0) colony.modifyLiberty(100);</span>
<span class="fc" id="L228">        Unit unit0 = colony.getUnitList().get(0);</span>
<span class="fc" id="L229">        Unit unit1 = colony.getUnitList().get(1);</span>
<span class="fc" id="L230">        Unit unit2 = colony.getUnitList().get(2);</span>

<span class="fc" id="L232">        assertFalse(chapelType.hasAbility(Ability.DRESS_MISSIONARY));</span>
<span class="fc" id="L233">        assertFalse(unit0.hasAbility(Ability.DRESS_MISSIONARY));</span>
<span class="fc" id="L234">        assertFalse(unit0.roleIsAvailable(missionaryRole));</span>

<span class="fc" id="L236">        Building church = colony.getBuilding(chapelType);</span>
<span class="fc" id="L237">        assertNotNull(church);</span>
<span class="fc" id="L238">        assertFalse(colony.hasAbility(Ability.DRESS_MISSIONARY));</span>

<span class="fc" id="L240">        assertEquals(&quot;Chapel base cross production, no unit&quot;, 1,</span>
<span class="fc" id="L241">            church.getBaseProduction(null, crossesType, null));</span>
<span class="fc" id="L242">        assertEquals(&quot;Chapel potential cross production, no unit&quot;, 1,</span>
<span class="fc" id="L243">            church.getPotentialProduction(crossesType, null));</span>
<span class="fc" id="L244">        assertEquals(&quot;Chapel total cross production, no unit&quot;, 1,</span>
<span class="fc" id="L245">            church.getTotalProductionOf(crossesType));</span>

<span class="fc" id="L247">        church.upgrade();</span>
<span class="fc" id="L248">        assertTrue(&quot;model.building.church&quot;.equals(church.getType().getId()));</span>
<span class="fc" id="L249">        assertTrue(church.getType().hasAbility(Ability.DRESS_MISSIONARY));</span>
<span class="fc" id="L250">        assertTrue(colony.hasAbility(Ability.DRESS_MISSIONARY));</span>
<span class="fc" id="L251">        assertTrue(unit0.hasAbility(Ability.DRESS_MISSIONARY));</span>
<span class="fc" id="L252">        assertTrue(unit0.roleIsAvailable(missionaryRole));</span>

<span class="fc" id="L254">        assertEquals(&quot;Church base cross production, no unit&quot;, 2,</span>
<span class="fc" id="L255">            church.getBaseProduction(null, crossesType, null));</span>
<span class="fc" id="L256">        assertEquals(&quot;Church potential cross production, no unit&quot;, 2,</span>
<span class="fc" id="L257">            church.getPotentialProduction(crossesType, null));</span>
<span class="fc" id="L258">        assertEquals(&quot;Church cross production, no unit&quot;, 2,</span>
<span class="fc" id="L259">            church.getTotalProductionOf(crossesType));</span>

<span class="fc" id="L261">        church.setWorkFor(unit0);</span>

<span class="fc" id="L263">        assertEquals(&quot;Church base cross production, free colonist&quot;, 3,</span>
<span class="fc" id="L264">            church.getBaseProduction(church.getProductionType(), crossesType,</span>
<span class="fc" id="L265">                                     unit0.getType()));</span>
<span class="fc" id="L266">        assertEquals(&quot;Church potential cross production, free colonist&quot;, 3,</span>
<span class="fc" id="L267">            church.getPotentialProduction(crossesType, unit0.getType()));</span>
<span class="fc" id="L268">        assertEquals(&quot;Church total cross production, free colonist&quot;, 5,</span>
<span class="fc" id="L269">            church.getTotalProductionOf(crossesType));</span>

<span class="fc" id="L271">        church.setWorkFor(unit1);</span>

<span class="fc" id="L273">        assertEquals(&quot;Church base cross production, 2 x free colonist&quot;, 3,</span>
<span class="fc" id="L274">            church.getBaseProduction(church.getProductionType(), crossesType,</span>
<span class="fc" id="L275">                                     unit1.getType()));</span>
<span class="fc" id="L276">        assertEquals(&quot;Church potential cross production, 2 x free colonist&quot;, 3,</span>
<span class="fc" id="L277">            church.getPotentialProduction(crossesType, unit1.getType()));</span>
<span class="fc" id="L278">        assertEquals(&quot;Church total cross production, 2 x free colonist&quot;, 8,</span>
<span class="fc" id="L279">            church.getTotalProductionOf(crossesType));</span>

<span class="fc" id="L281">        church.setWorkFor(unit2);</span>

<span class="fc" id="L283">        assertEquals(&quot;Church base cross production, 3 x free colonist&quot;, 3,</span>
<span class="fc" id="L284">            church.getBaseProduction(church.getProductionType(), crossesType,</span>
<span class="fc" id="L285">                                     unit2.getType()));</span>
<span class="fc" id="L286">        assertEquals(&quot;Church potential cross production, 3 x free colonist&quot;, 3,</span>
<span class="fc" id="L287">            church.getPotentialProduction(crossesType, unit2.getType()));</span>
<span class="fc" id="L288">        assertEquals(&quot;Church total cross production, 3 x free colonist&quot;, 11,</span>
<span class="fc" id="L289">            church.getTotalProductionOf(crossesType));</span>

<span class="fc" id="L291">        Building smithy = colony.getBuilding(blacksmithType);</span>
<span class="fc" id="L292">        assertTrue(unit0.setLocation(smithy));</span>
<span class="fc" id="L293">        assertTrue(unit1.setLocation(smithy));</span>
<span class="fc" id="L294">        assertTrue(unit2.setLocation(smithy));</span>
<span class="fc" id="L295">        unit0.setType(firebrandPreacherType);</span>
<span class="fc" id="L296">        church.setWorkFor(unit0);</span>
        
<span class="fc" id="L298">        assertEquals(&quot;Church base cross production, firebrand preacher&quot;, 3,</span>
<span class="fc" id="L299">            church.getBaseProduction(church.getProductionType(), crossesType,</span>
<span class="fc" id="L300">                                     unit0.getType()));</span>
<span class="fc" id="L301">        assertEquals(&quot;Church potential cross production, firebrand preacher&quot;, 6,</span>
<span class="fc" id="L302">            church.getPotentialProduction(crossesType, unit0.getType()));</span>
<span class="fc" id="L303">        assertEquals(&quot;Church total cross production, firebrand preacher&quot;, 8,</span>
<span class="fc" id="L304">            church.getTotalProductionOf(crossesType));</span>

<span class="fc" id="L306">        unit0.setType(freeColonistType);</span>
<span class="fc" id="L307">        assertTrue(unit0.setLocation(smithy));</span>
<span class="fc" id="L308">        church.upgrade();</span>
<span class="fc" id="L309">        assertTrue(&quot;model.building.cathedral&quot;.equals(church.getType().getId()));</span>
<span class="fc" id="L310">        assertTrue(church.getType().hasAbility(Ability.DRESS_MISSIONARY));</span>
<span class="fc" id="L311">        assertTrue(colony.hasAbility(Ability.DRESS_MISSIONARY));</span>
<span class="fc" id="L312">        assertTrue(unit0.hasAbility(Ability.DRESS_MISSIONARY));</span>
<span class="fc" id="L313">        assertTrue(unit0.roleIsAvailable(missionaryRole));</span>

<span class="fc" id="L315">        assertEquals(&quot;Cathedral base cross production, no unit&quot;, 3,</span>
<span class="fc" id="L316">            church.getBaseProduction(null, crossesType, null));</span>
<span class="fc" id="L317">        assertEquals(&quot;Cathedral potential cross production, no unit&quot;, 3,</span>
<span class="fc" id="L318">            church.getPotentialProduction(crossesType, null));</span>
<span class="fc" id="L319">        assertEquals(&quot;Cathedral cross production, no colonist&quot;, 3,</span>
<span class="fc" id="L320">            church.getTotalProductionOf(crossesType));</span>

<span class="fc" id="L322">        church.setWorkFor(unit0);</span>

<span class="fc" id="L324">        assertEquals(&quot;Cathedral base cross production, free colonist&quot;, 6,</span>
<span class="fc" id="L325">            church.getBaseProduction(church.getProductionType(), crossesType,</span>
<span class="fc" id="L326">                                     unit0.getType()));</span>
<span class="fc" id="L327">        assertEquals(&quot;Cathedral potential cross production, free colonist&quot;, 6,</span>
<span class="fc" id="L328">            church.getPotentialProduction(crossesType, unit0.getType()));</span>
<span class="fc" id="L329">        assertEquals(&quot;Cathedral total cross production, free colonist&quot;, 9,</span>
<span class="fc" id="L330">            church.getTotalProductionOf(crossesType));</span>

<span class="fc" id="L332">        church.setWorkFor(unit1);</span>

<span class="fc" id="L334">        assertEquals(&quot;Cathedral base cross production, 2 x free colonist&quot;, 6,</span>
<span class="fc" id="L335">            church.getBaseProduction(church.getProductionType(), crossesType,</span>
<span class="fc" id="L336">                                     unit1.getType()));</span>
<span class="fc" id="L337">        assertEquals(&quot;Cathedral potential cross production, 2 x free colonist&quot;, 6,</span>
<span class="fc" id="L338">            church.getPotentialProduction(crossesType, unit1.getType()));</span>
<span class="fc" id="L339">        assertEquals(&quot;Cathedral total cross production, 2 x free colonist&quot;, 15,</span>
<span class="fc" id="L340">            church.getTotalProductionOf(crossesType));</span>

<span class="fc" id="L342">        church.setWorkFor(unit2);</span>

<span class="fc" id="L344">        assertEquals(&quot;Cathedral base cross production, 3 x free colonist&quot;, 6,</span>
<span class="fc" id="L345">            church.getBaseProduction(church.getProductionType(), crossesType,</span>
<span class="fc" id="L346">                                     unit2.getType()));</span>
<span class="fc" id="L347">        assertEquals(&quot;Cathedral potential cross production, 3 x free colonist&quot;, 6,</span>
<span class="fc" id="L348">            church.getPotentialProduction(crossesType, unit2.getType()));</span>
<span class="fc" id="L349">        assertEquals(&quot;Cathedral total cross production, 3 x free colonist&quot;, 21,</span>
<span class="fc" id="L350">            church.getTotalProductionOf(crossesType));</span>

<span class="fc" id="L352">        unit0.setLocation(smithy);</span>
<span class="fc" id="L353">        unit1.setLocation(smithy);</span>
<span class="fc" id="L354">        unit2.setLocation(smithy);</span>
<span class="fc" id="L355">        unit0.setType(firebrandPreacherType);</span>
<span class="fc" id="L356">        church.setWorkFor(unit0);</span>

<span class="fc" id="L358">        assertEquals(&quot;Cathedral base cross production, firebrand preacher&quot;, 6,</span>
<span class="fc" id="L359">            church.getBaseProduction(church.getProductionType(), crossesType,</span>
<span class="fc" id="L360">                                     unit0.getType()));</span>
<span class="fc" id="L361">        assertEquals(&quot;Cathedral potential cross production, firebrand preacher&quot;, 12,</span>
<span class="fc" id="L362">            church.getPotentialProduction(crossesType, unit0.getType()));</span>
<span class="fc" id="L363">        assertEquals(&quot;Cathedral total cross production, firebrand preacher&quot;, 15,</span>
<span class="fc" id="L364">            church.getTotalProductionOf(crossesType));</span>
<span class="fc" id="L365">    }</span>

    public void testCanAddToBuilding() {
<span class="fc" id="L368">        Game game = getGame();</span>
<span class="fc" id="L369">        game.setMap(getTestMap(true));</span>

<span class="fc" id="L371">        Colony colony = getStandardColony(6);</span>
<span class="fc" id="L372">        Tile tile = colony.getTile();</span>
<span class="fc" id="L373">        List&lt;Unit&gt; units = colony.getUnitList();</span>

        // Standard colony tends to place units in the town hall
<span class="fc bfc" id="L376" title="All 2 branches covered.">        for (Unit u : units) {</span>
<span class="fc bfc" id="L377" title="All 2 branches covered.">            if (u.getLocation() instanceof Building) u.setLocation(tile);</span>
        }

<span class="fc bfc" id="L380" title="All 2 branches covered.">        for (Building building : colony.getBuildings()) {</span>
            // schoolhouse is special, see testCanAddToSchool
<span class="pc bpc" id="L382" title="1 of 2 branches missed.">            if (building.canTeach()) continue;</span>

<span class="fc" id="L384">            int maxUnits = building.getUnitCapacity();</span>

<span class="fc" id="L386">            assertEquals(0, building.getUnitCount());</span>

<span class="fc bfc" id="L388" title="All 2 branches covered.">            for (int index = 0; index &lt; maxUnits; index++) {</span>
<span class="fc" id="L389">                assertTrue(&quot;unable to add unit &quot; + index</span>
<span class="fc" id="L390">                    + &quot; to building type &quot; + building.getType(),</span>
<span class="fc" id="L391">                    building.canAdd(units.get(index)));</span>
<span class="fc" id="L392">                building.add(units.get(index));</span>
            }
<span class="fc" id="L394">            assertFalse(&quot;able to add unit &quot; + maxUnits</span>
<span class="fc" id="L395">                + &quot; to building type &quot; + building.getType(),</span>
<span class="fc" id="L396">                building.canAdd(units.get(maxUnits)));</span>
<span class="fc bfc" id="L397" title="All 2 branches covered.">            for (int index = 0; index &lt; maxUnits; index++) {</span>
<span class="fc" id="L398">                building.remove(building.getUnitList().get(0));</span>
            }
        }
<span class="fc" id="L401">    }</span>


    /**
     * WARNING! This test makes implicit assumptions about the
     * schoolhouse that could be invalidated by the
     * specification.
     *
     * FIXME: make this more generic.
     */
    public void testCanAddToSchool() {
<span class="fc" id="L412">        Game game = getGame();</span>
<span class="fc" id="L413">        game.setMap(getTestMap(true));</span>

<span class="fc" id="L415">        Colony colony = getStandardColony(10);</span>

<span class="fc" id="L417">        Iterator&lt;Unit&gt; units = colony.getUnitIterator();</span>

<span class="fc" id="L419">        Unit farmer = units.next();</span>
<span class="fc" id="L420">        farmer.setType(expertFarmerType);</span>

<span class="fc" id="L422">        Unit colonist = units.next();</span>
<span class="fc" id="L423">        colonist.setType(freeColonistType);</span>

<span class="fc" id="L425">        Unit criminal = units.next();</span>
<span class="fc" id="L426">        criminal.setType(pettyCriminalType);</span>

<span class="fc" id="L428">        Unit servant = units.next();</span>
<span class="fc" id="L429">        servant.setType(indenturedServantType);</span>

<span class="fc" id="L431">        Unit indian = units.next();</span>
<span class="fc" id="L432">        indian.setType(indianConvertType);</span>

<span class="fc" id="L434">        Unit distiller = units.next();</span>
<span class="fc" id="L435">        distiller.setType(masterDistillerType);</span>

<span class="fc" id="L437">        Unit elder = units.next();</span>
<span class="fc" id="L438">        elder.setType(elderStatesmanType);</span>

<span class="fc" id="L440">        Unit carpenter = units.next();</span>
<span class="fc" id="L441">        carpenter.setType(masterCarpenterType);</span>

        // Check school
<span class="fc" id="L444">        Building school = colony.getBuilding(schoolType);</span>
<span class="pc bpc" id="L445" title="1 of 2 branches missed.">        assertTrue(school == null);</span>

        // build school
<span class="fc" id="L448">        colony.addBuilding(new ServerBuilding(getGame(), colony, schoolType));</span>
<span class="fc" id="L449">        school = colony.getBuilding(schoolType);</span>
<span class="pc bpc" id="L450" title="1 of 2 branches missed.">        assertTrue(school != null);</span>

        // these can never teach
<span class="fc" id="L453">        assertEquals(NoAddReason.MINIMUM_SKILL, school.getNoAddReason(colonist));</span>
<span class="fc" id="L454">        assertFalse(&quot;able to add free colonist to Schoolhouse&quot;,</span>
<span class="fc" id="L455">                    school.canAdd(colonist));</span>

<span class="fc" id="L457">        assertEquals(NoAddReason.MINIMUM_SKILL, school.getNoAddReason(criminal));</span>
<span class="fc" id="L458">        assertFalse(&quot;able to add petty criminal to Schoolhouse&quot;,</span>
<span class="fc" id="L459">                    school.canAdd(criminal));</span>

<span class="fc" id="L461">        assertEquals(NoAddReason.MINIMUM_SKILL, school.getNoAddReason(servant));</span>
<span class="fc" id="L462">        assertFalse(&quot;able to add indentured servant to Schoolhouse&quot;,</span>
<span class="fc" id="L463">                    school.canAdd(servant));</span>

<span class="fc" id="L465">        assertEquals(NoAddReason.MINIMUM_SKILL, school.getNoAddReason(indian));</span>
<span class="fc" id="L466">        assertFalse(&quot;able to add indian convert to Schoolhouse&quot;,</span>
<span class="fc" id="L467">                    school.canAdd(indian));</span>

<span class="fc" id="L469">        assertEquals(NoAddReason.MAXIMUM_SKILL, school.getNoAddReason(elder));</span>
<span class="fc" id="L470">        assertFalse(&quot;able to add elder statesman to Schoolhouse&quot;,</span>
<span class="fc" id="L471">                    school.canAdd(elder));</span>

<span class="fc" id="L473">        assertEquals(NoAddReason.MAXIMUM_SKILL, school.getNoAddReason(distiller));</span>
<span class="fc" id="L474">        assertFalse(&quot;able to add master distiller to Schoolhouse&quot;,</span>
<span class="fc" id="L475">                    school.canAdd(distiller));</span>

<span class="fc" id="L477">        assertTrue(&quot;unable to add master farmer to Schoolhouse&quot;,</span>
<span class="fc" id="L478">                   school.canAdd(farmer));</span>
<span class="fc" id="L479">        farmer.setLocation(school);</span>
<span class="fc" id="L480">        assertEquals(school, farmer.getLocation());</span>

<span class="fc" id="L482">        assertFalse(&quot;able to add master carpenter to Schoolhouse&quot;,</span>
<span class="fc" id="L483">                    school.canAdd(carpenter));</span>

<span class="fc" id="L485">        school.upgrade();</span>
<span class="fc" id="L486">        farmer.setLocation(colony.getTile());</span>

        // these can never teach
<span class="fc" id="L489">        assertFalse(&quot;able to add free colonist to College&quot;,</span>
<span class="fc" id="L490">                    school.canAdd(colonist));</span>
<span class="fc" id="L491">        assertFalse(&quot;able to add petty criminal to College&quot;,</span>
<span class="fc" id="L492">                    school.canAdd(criminal));</span>
<span class="fc" id="L493">        assertFalse(&quot;able to add indentured servant to College&quot;,</span>
<span class="fc" id="L494">                    school.canAdd(servant));</span>
<span class="fc" id="L495">        assertFalse(&quot;able to add indian convert to College&quot;,</span>
<span class="fc" id="L496">                    school.canAdd(indian));</span>

<span class="fc" id="L498">        assertFalse(&quot;able to add elder statesman to College&quot;,</span>
<span class="fc" id="L499">                    school.canAdd(elder));</span>
<span class="fc" id="L500">        assertTrue(&quot;unable to add master distiller to College&quot;,</span>
<span class="fc" id="L501">                   school.canAdd(distiller));</span>
<span class="fc" id="L502">        distiller.setLocation(school);</span>
<span class="fc" id="L503">        assertTrue(&quot;unable to add master farmer to College&quot;,</span>
<span class="fc" id="L504">                   school.canAdd(farmer));</span>
<span class="fc" id="L505">        farmer.setLocation(school);</span>
<span class="fc" id="L506">        assertFalse(&quot;able to add master carpenter to College&quot;,</span>
<span class="fc" id="L507">                    school.canAdd(carpenter));</span>

<span class="fc" id="L509">        school.upgrade();</span>
<span class="fc" id="L510">        assertEquals(school.getType().toString(), universityType,</span>
<span class="fc" id="L511">                     school.getType());</span>
<span class="fc" id="L512">        distiller.setLocation(colony.getTile());</span>
<span class="fc" id="L513">        farmer.setLocation(colony.getTile());</span>

        // these can never teach
<span class="fc" id="L516">        assertFalse(&quot;able to add free colonist to University&quot;,</span>
<span class="fc" id="L517">                    school.canAdd(colonist));</span>
<span class="fc" id="L518">        assertFalse(&quot;able to add petty criminal to University&quot;,</span>
<span class="fc" id="L519">                    school.canAdd(criminal));</span>
<span class="fc" id="L520">        assertFalse(&quot;able to add indentured servant to University&quot;,</span>
<span class="fc" id="L521">                    school.canAdd(servant));</span>
<span class="fc" id="L522">        assertFalse(&quot;able to add indian convert to University&quot;,</span>
<span class="fc" id="L523">                    school.canAdd(indian));</span>

<span class="fc" id="L525">        assertTrue(&quot;unable to add elder statesman to University&quot;,</span>
<span class="fc" id="L526">                   school.canAdd(elder));</span>
<span class="fc" id="L527">        elder.setLocation(school);</span>
<span class="fc" id="L528">        assertTrue(&quot;unable to add master distiller to University&quot;,</span>
<span class="fc" id="L529">                   school.canAdd(distiller));</span>
<span class="fc" id="L530">        distiller.setLocation(school);</span>
<span class="fc" id="L531">        assertTrue(&quot;unable to add master farmer to University&quot;,</span>
<span class="fc" id="L532">                   school.canAdd(farmer));</span>
<span class="fc" id="L533">        farmer.setLocation(school);</span>
<span class="fc" id="L534">        assertFalse(&quot;able to add master carpenter to University&quot;,</span>
<span class="fc" id="L535">                    school.canAdd(carpenter));</span>
<span class="fc" id="L536">    }</span>

    public void testSerialize() {
<span class="fc" id="L539">        Game game = getGame();</span>
<span class="fc" id="L540">        game.setMap(getTestMap(true));</span>

<span class="fc" id="L542">        Colony colony = getStandardColony(6);</span>
<span class="fc bfc" id="L543" title="All 2 branches covered.">        for (Building building : colony.getBuildings()) {</span>
            try {
<span class="fc" id="L545">                StringWriter sw = new StringWriter();</span>
<span class="fc" id="L546">                FreeColXMLWriter xw = new FreeColXMLWriter(sw,</span>
<span class="fc" id="L547">                    FreeColXMLWriter.WriteScope.toSave());</span>

<span class="fc" id="L549">                building.toXML(xw);</span>

<span class="fc" id="L551">                xw.close();</span>

<span class="pc" id="L553">            } catch (Exception e) {</span>
<span class="nc" id="L554">                fail(e.toString());</span>
            }
        }
<span class="fc" id="L557">    }</span>

    public void testStockade() {
<span class="fc" id="L560">        final Game game = getGame();</span>
<span class="fc" id="L561">        final Turn turn = game.getTurn();</span>
<span class="fc" id="L562">        game.setMap(getTestMap(true));</span>
        Set&lt;Modifier&gt; modifierSet;

<span class="fc" id="L565">        Colony colony = getStandardColony(2);</span>
<span class="fc" id="L566">        modifierSet = colony.getModifiers(Modifier.DEFENCE);</span>
<span class="fc" id="L567">        assertEquals(1, modifierSet.size());</span>
<span class="fc" id="L568">        Modifier modifier = modifierSet.iterator().next();</span>
<span class="fc" id="L569">        assertEquals(50f, modifier.getValue());</span>
<span class="fc" id="L570">        assertEquals(ModifierType.PERCENTAGE, modifier.getType());</span>

<span class="fc" id="L572">        modifierSet = stockadeType.getModifiers(Modifier.DEFENCE);</span>
<span class="fc" id="L573">        assertEquals(1, modifierSet.size());</span>
<span class="fc" id="L574">        modifier = modifierSet.iterator().next();</span>
<span class="fc" id="L575">        assertEquals(100f, modifier.getValue());</span>
<span class="fc" id="L576">        assertEquals(ModifierType.PERCENTAGE, modifier.getType());</span>
<span class="fc" id="L577">        assertEquals(0f, stockadeType.applyModifiers(0f, turn,</span>
<span class="fc" id="L578">                Modifier.MINIMUM_COLONY_SIZE));</span>

<span class="fc" id="L580">        modifierSet = fortType.getModifiers(Modifier.DEFENCE);</span>
<span class="fc" id="L581">        assertEquals(1, modifierSet.size());</span>
<span class="fc" id="L582">        modifier = modifierSet.iterator().next();</span>
<span class="fc" id="L583">        assertEquals(150f, modifier.getValue());</span>
<span class="fc" id="L584">        assertEquals(ModifierType.PERCENTAGE, modifier.getType());</span>
<span class="fc" id="L585">        assertEquals(0f, stockadeType.applyModifiers(0f, turn,</span>
<span class="fc" id="L586">                Modifier.MINIMUM_COLONY_SIZE));</span>

<span class="fc" id="L588">        modifierSet = fortressType.getModifiers(Modifier.DEFENCE);</span>
<span class="fc" id="L589">        assertEquals(1, modifierSet.size());</span>
<span class="fc" id="L590">        modifier = modifierSet.iterator().next();</span>
<span class="fc" id="L591">        assertEquals(200f, modifier.getValue());</span>
<span class="fc" id="L592">        assertEquals(ModifierType.PERCENTAGE, modifier.getType());</span>
<span class="fc" id="L593">        assertEquals(0f, stockadeType.applyModifiers(0f, turn,</span>
<span class="fc" id="L594">                Modifier.MINIMUM_COLONY_SIZE));</span>
<span class="fc" id="L595">    }</span>

    public void testCottonClothProduction() {
<span class="fc" id="L598">        Game game = getGame();</span>
<span class="fc" id="L599">        game.setMap(getTestMap(true));</span>

<span class="fc" id="L601">        Colony colony = getStandardColony(2);</span>
<span class="fc" id="L602">        List&lt;Unit&gt; units = colony.getUnitList();</span>
<span class="fc" id="L603">        Unit colonist = units.get(0);</span>
<span class="fc" id="L604">        Unit worker = units.get(1);</span>

<span class="fc" id="L606">        final Building weaver = colony.getBuilding(weaverHouseType);</span>

<span class="fc" id="L608">        assertTrue(colonist.getLocation() instanceof ColonyTile);</span>
<span class="fc" id="L609">        assertEquals(plainsType, ((ColonyTile)colonist.getLocation()).getWorkTile().getType());</span>
<span class="fc" id="L610">        assertTrue(worker.getLocation() instanceof ColonyTile);</span>
<span class="fc" id="L611">        assertEquals(plainsType, ((ColonyTile)worker.getLocation()).getWorkTile().getType());</span>

<span class="fc" id="L613">        assertTrue(weaver.add(worker));</span>
<span class="fc" id="L614">        assertEquals(worker, weaver.getUnitList().get(0));</span>

<span class="fc" id="L616">        colony.addGoods(cottonType, 2);</span>
<span class="fc" id="L617">        colony.invalidateCache();</span>

<span class="fc" id="L619">        assertEquals(2, colony.getTotalProductionOf(cottonType));</span>
<span class="fc" id="L620">        assertEquals(3, weaver.getTotalProductionOf(clothType));</span>
<span class="fc" id="L621">        assertEquals(3, colony.getTotalProductionOf(clothType));</span>
<span class="fc" id="L622">        assertEquals(-1, colony.getNetProductionOf(cottonType));</span>
<span class="fc" id="L623">        assertEquals(3, colony.getNetProductionOf(clothType));</span>

<span class="fc" id="L625">        colonist.changeWorkType(cottonType);</span>
<span class="fc" id="L626">        colony.invalidateCache();</span>

<span class="fc" id="L628">        assertEquals(4, colony.getTotalProductionOf(cottonType));</span>
<span class="fc" id="L629">        colony.addGoods(cottonType, 4);</span>
<span class="fc" id="L630">        assertEquals(3, colony.getTotalProductionOf(clothType));</span>
<span class="fc" id="L631">        assertEquals(1, colony.getNetProductionOf(cottonType));</span>
<span class="fc" id="L632">        assertEquals(3, colony.getNetProductionOf(clothType));</span>
<span class="fc" id="L633">    }</span>

    public void testPasture() {
<span class="fc" id="L636">        Game game = getGame();</span>
<span class="fc" id="L637">        game.setMap(getTestMap(true));</span>

<span class="fc" id="L639">        Colony colony = getStandardColony(1);</span>
<span class="fc" id="L640">        Building country = colony.getBuilding(countryType);</span>
<span class="fc" id="L641">        assertNotNull(country.getProductionType());</span>

<span class="fc" id="L643">        Unit unit = colony.getFirstUnit();</span>
<span class="fc" id="L644">        assertEquals(grainType, unit.getWorkType());</span>

        // no horses yet
<span class="fc" id="L647">        assertEquals(8, colony.getNetProductionOf(foodType));</span>
<span class="fc" id="L648">        assertEquals(0, country.getTotalProductionOf(horsesType));</span>
<span class="fc" id="L649">        assertEquals(0, colony.getNetProductionOf(horsesType));</span>
<span class="fc" id="L650">        assertEquals(0, country.getMaximumProductionOf(horsesType));</span>

<span class="fc" id="L652">        colony.addGoods(horsesType, 50);</span>
<span class="fc" id="L653">        colony.invalidateCache();</span>

<span class="fc" id="L655">        assertEquals(2, country.getTotalProductionOf(horsesType));</span>
<span class="fc" id="L656">        assertEquals(2, country.getMaximumProductionOf(horsesType));</span>
<span class="fc" id="L657">        assertEquals(2, colony.getNetProductionOf(horsesType));</span>

<span class="fc" id="L659">        colony.addGoods(horsesType, 1);</span>
<span class="fc" id="L660">        colony.invalidateCache();</span>

<span class="fc" id="L662">        assertEquals(4, country.getTotalProductionOf(horsesType));</span>
<span class="fc" id="L663">        assertEquals(4, country.getMaximumProductionOf(horsesType));</span>
<span class="fc" id="L664">        assertEquals(4, colony.getNetProductionOf(horsesType));</span>

<span class="fc" id="L666">        country.upgrade();</span>
<span class="fc" id="L667">        colony.removeGoods(horsesType);</span>
<span class="fc" id="L668">        colony.addGoods(horsesType, 25);</span>
<span class="fc" id="L669">        colony.invalidateCache();</span>

<span class="fc" id="L671">        assertEquals(25, colony.getGoodsCount(horsesType));</span>
<span class="fc" id="L672">        assertEquals(2, country.getTotalProductionOf(horsesType));</span>
<span class="fc" id="L673">        assertEquals(2, country.getMaximumProductionOf(horsesType));</span>
<span class="fc" id="L674">        assertEquals(2, colony.getNetProductionOf(horsesType));</span>

<span class="fc" id="L676">        colony.addGoods(horsesType, 1);</span>
<span class="fc" id="L677">        colony.invalidateCache();</span>

<span class="fc" id="L679">        assertEquals(26, colony.getGoodsCount(horsesType));</span>
<span class="fc" id="L680">        assertEquals(4, country.getTotalProductionOf(horsesType));</span>
<span class="fc" id="L681">        assertEquals(4, country.getMaximumProductionOf(horsesType));</span>
<span class="fc" id="L682">        assertEquals(4, colony.getNetProductionOf(horsesType));</span>

<span class="fc" id="L684">        colony.addGoods(horsesType, 24);</span>
<span class="fc" id="L685">        colony.invalidateCache();</span>

<span class="fc" id="L687">        assertEquals(50, colony.getGoodsCount(horsesType));</span>
<span class="fc" id="L688">        assertEquals(4, country.getTotalProductionOf(horsesType));</span>
<span class="fc" id="L689">        assertEquals(4, country.getMaximumProductionOf(horsesType));</span>
<span class="fc" id="L690">        assertEquals(4, colony.getNetProductionOf(horsesType));</span>

<span class="fc" id="L692">        colony.addGoods(horsesType, 1);</span>
<span class="fc" id="L693">        colony.invalidateCache();</span>

<span class="fc" id="L695">        assertEquals(51, colony.getGoodsCount(horsesType));</span>
        // no more than half the surplus production!
<span class="fc" id="L697">        assertEquals(4, country.getTotalProductionOf(horsesType));</span>
<span class="fc" id="L698">        assertEquals(6, country.getMaximumProductionOf(horsesType));</span>
<span class="fc" id="L699">        assertEquals(&quot;Horse production should equal food surplus.&quot;,</span>
<span class="fc" id="L700">                     colony.getNetProductionOf(foodType),</span>
<span class="fc" id="L701">                     colony.getNetProductionOf(horsesType));</span>
<span class="fc" id="L702">    }</span>

    public void testTownhallProduction() {
<span class="fc" id="L705">        final Game game = getGame();</span>
<span class="fc" id="L706">        game.setMap(getTestMap(true));</span>
<span class="fc" id="L707">        final Turn turn = game.getTurn();</span>

<span class="fc" id="L709">        Colony colony = getStandardColony(6);</span>
<span class="fc" id="L710">        Player owner = colony.getOwner();</span>
<span class="fc" id="L711">        Unit colonist = colony.getUnitList().get(0);</span>
<span class="fc" id="L712">        Unit statesman = colony.getUnitList().get(1);</span>
<span class="fc" id="L713">        statesman.setType(elderStatesmanType);</span>

<span class="fc" id="L715">        Tile tile = colony.getTile();</span>
<span class="fc" id="L716">        Building building = colony.getBuilding(townHallType);</span>
<span class="fc bfc" id="L717" title="All 2 branches covered.">        for (Unit u : building.getUnitList()) u.setLocation(tile);</span>

<span class="fc" id="L719">        Set&lt;Modifier&gt; modifiers = colony.getModifiers(&quot;model.goods.bells&quot;);</span>
<span class="fc" id="L720">        assertTrue(&quot;No initial modifiers&quot;, modifiers.isEmpty());</span>
<span class="fc" id="L721">        assertEquals(&quot;Initial bell production&quot;, 1,</span>
<span class="fc" id="L722">                     building.getTotalProductionOf(bellsType));</span>

<span class="fc" id="L724">        colonist.setLocation(building);</span>
        // 3 from the colonist
<span class="fc" id="L726">        assertEquals(&quot;Production(Colonist)&quot;, 3,</span>
<span class="fc" id="L727">                     building.getUnitProduction(colonist, bellsType));</span>
        // 3(colonist) + 1(unattended)
<span class="fc" id="L729">        assertEquals(&quot;Total production(Colonist)&quot;, 4,</span>
<span class="fc" id="L730">                     building.getTotalProductionOf(bellsType));</span>

        // Add Jefferson.
<span class="fc" id="L733">        FoundingFather jefferson = spec()</span>
<span class="fc" id="L734">            .getFoundingFather(&quot;model.foundingFather.thomasJefferson&quot;);</span>
<span class="fc" id="L735">        modifiers = jefferson.getModifiers(&quot;model.goods.bells&quot;);</span>
<span class="fc" id="L736">        assertEquals(&quot;Jefferson modifier size&quot;, 1, modifiers.size());</span>
<span class="fc" id="L737">        Modifier bellsModifier = modifiers.iterator().next();</span>
<span class="fc" id="L738">        owner.addFather(jefferson);</span>

        // Jefferson is a property of the player...
<span class="fc" id="L741">        assertTrue(&quot;Jefferson should be present in player&quot;,</span>
<span class="fc" id="L742">            owner.getModifiers(&quot;model.goods.bells&quot;)</span>
<span class="fc" id="L743">                .contains(bellsModifier));</span>
<span class="fc" id="L744">        assertTrue(&quot;Jefferson should be present in player in building scope&quot;,</span>
<span class="fc" id="L745">            owner.getModifiers(&quot;model.goods.bells&quot;, townHallType, turn)</span>
<span class="fc" id="L746">                .contains(bellsModifier));</span>
<span class="fc" id="L747">        assertFalse(&quot;Jefferson should not be present in player in unit scope&quot;,</span>
<span class="fc" id="L748">            owner.getModifiers(&quot;model.goods.bells&quot;, freeColonistType, turn)</span>
<span class="fc" id="L749">                .contains(bellsModifier));</span>
        // ...not the colony,
<span class="fc" id="L751">        assertFalse(&quot;Jefferson modifier should not be present in colony&quot;,</span>
<span class="fc" id="L752">            colony.getModifiers(&quot;model.goods.bells&quot;)</span>
<span class="fc" id="L753">                  .contains(bellsModifier));</span>
        // ...and the building modifiers do not have it.
<span class="fc" id="L755">        assertFalse(&quot;Jefferson modifier should not be present in building modifiers&quot;,</span>
<span class="fc" id="L756">            building.getModifiers(&quot;model.goods.bells&quot;)</span>
<span class="fc" id="L757">                    .contains(bellsModifier));</span>

        // 3(colonist)
<span class="fc" id="L760">        assertEquals(&quot;Production(Colonist/Jefferson)&quot;, 3,</span>
<span class="fc" id="L761">                     building.getUnitProduction(colonist, bellsType));</span>
        // 3(colonist) + 1 + 50%(Jefferson) = 6
<span class="fc" id="L763">        assertEquals(&quot;Total production(Colonist/Jefferson)&quot;, 6,</span>
<span class="fc" id="L764">                     building.getTotalProductionOf(bellsType));</span>

        // Add statesman
<span class="fc" id="L767">        statesman.setLocation(building);</span>
        // 3 * 2(expert) = 6
<span class="fc" id="L769">        assertEquals(&quot;Production(Statesman/Jefferson)&quot;, 6,</span>
<span class="fc" id="L770">                     building.getUnitProduction(statesman, bellsType));</span>
        // 3 + 6 + 1 + 50%(Jefferson) = 15
<span class="fc" id="L772">        assertEquals(&quot;Total production(Colonist/Statesman/Jefferson)&quot;, 15,</span>
<span class="fc" id="L773">                     building.getTotalProductionOf(bellsType));</span>

        // Improve production
<span class="fc" id="L776">        setProductionBonus(colony, 2);</span>
<span class="fc" id="L777">        colony.invalidateCache();</span>
<span class="fc" id="L778">        assertEquals(&quot;Production(Colonist/Jefferson/2)&quot;, 5,</span>
<span class="fc" id="L779">                     building.getUnitProduction(colonist, bellsType));</span>
<span class="fc" id="L780">        assertEquals(&quot;Production(Statesman/Jefferson/2)&quot;, 10,</span>
<span class="fc" id="L781">                     building.getUnitProduction(statesman, bellsType));</span>
        // 5 + 10 + 1 + 50%(Jefferson) = 24
<span class="fc" id="L783">        assertEquals(&quot;Total production(Colonist/Statesman/Jefferson/2)&quot;, 24,</span>
<span class="fc" id="L784">                     building.getTotalProductionOf(bellsType));</span>

        // Add newspaper
<span class="fc" id="L787">        Building newspaper = new ServerBuilding(getGame(), colony,</span>
<span class="fc" id="L788">                                                newspaperType);</span>
<span class="fc" id="L789">        colony.addBuilding(newspaper);</span>
<span class="fc" id="L790">        colony.invalidateCache();</span>
<span class="fc" id="L791">        assertEquals(&quot;Production(Colonist/Jefferson/2/Newspaper)&quot;, 5,</span>
<span class="fc" id="L792">                     building.getUnitProduction(colonist, bellsType));</span>
<span class="fc" id="L793">        assertEquals(&quot;Production(Statesman/Jefferson/2/Newspaper)&quot;, 10,</span>
<span class="fc" id="L794">                     building.getUnitProduction(statesman, bellsType));</span>
        // 5 + 10 + 1 + 50%(Jefferson) + 100%(Newspaper) = 48
<span class="fc" id="L796">        assertEquals(&quot;Total production(Colonist/Statesman/Jefferson/2/Newspaper)&quot;, 48,</span>
<span class="fc" id="L797">                     building.getTotalProductionOf(bellsType));</span>
<span class="fc" id="L798">    }</span>

    public void testPrintingPressBonus() {
<span class="fc" id="L801">        Game game = getGame();</span>
<span class="fc" id="L802">        game.setMap(getTestMap(true));</span>

<span class="fc" id="L804">        Colony colony = getStandardColony(6);</span>
<span class="fc" id="L805">        Unit unit = colony.getUnitList().get(0);</span>
<span class="fc" id="L806">        Building building = colony.getBuilding(townHallType);</span>
<span class="fc" id="L807">        Tile tile = colony.getTile();</span>
<span class="fc bfc" id="L808" title="All 2 branches covered.">        for (Unit u : building.getUnitList()) u.setLocation(tile);</span>

<span class="fc" id="L810">        int bellProduction = building.getTotalProductionOf(bellsType);</span>
<span class="fc" id="L811">        int expectBellProd = 1;</span>
<span class="fc" id="L812">        assertEquals(&quot;Wrong initial bell production&quot;,expectBellProd,bellProduction);</span>

<span class="fc" id="L814">        Building printingPress = new ServerBuilding(getGame(), colony, printingPressType);</span>
<span class="fc" id="L815">        colony.addBuilding(printingPress);</span>

<span class="fc" id="L817">        bellProduction = building.getTotalProductionOf(bellsType);</span>
<span class="fc" id="L818">        expectBellProd = 1;</span>
<span class="fc" id="L819">        assertEquals(&quot;Wrong bell production with printing press&quot;,expectBellProd,bellProduction);</span>

<span class="fc" id="L821">        unit.setLocation(building);</span>
<span class="fc" id="L822">        bellProduction = building.getTotalProductionOf(bellsType);</span>
<span class="fc" id="L823">        expectBellProd = 6; // 1 initial plus 3 from the colonist + 2 from printing press</span>
<span class="fc" id="L824">        assertEquals(&quot;Wrong final bell production&quot;,expectBellProd,bellProduction);</span>
<span class="fc" id="L825">    }</span>

    public void testNewspaperBonus() {
<span class="fc" id="L828">        Game game = getGame();</span>
<span class="fc" id="L829">        game.setMap(getTestMap(true));</span>

<span class="fc" id="L831">        Colony colony = getStandardColony(6);</span>
<span class="fc" id="L832">        Unit unit = colony.getUnitList().get(0);</span>
<span class="fc" id="L833">        Building building = colony.getBuilding(townHallType);</span>
<span class="fc" id="L834">        clearWorkLocation(building);</span>

<span class="fc" id="L836">        int bellProduction = building.getTotalProductionOf(bellsType);</span>
<span class="fc" id="L837">        int expectBellProd = 1;</span>
<span class="fc" id="L838">        assertEquals(&quot;Wrong initial bell production&quot;, expectBellProd,</span>
<span class="fc" id="L839">                     bellProduction);</span>

<span class="fc" id="L841">        Building newspaper = new ServerBuilding(getGame(), colony,</span>
<span class="fc" id="L842">                                                newspaperType);</span>
<span class="fc" id="L843">        colony.addBuilding(newspaper);</span>
<span class="fc" id="L844">        colony.invalidateCache();</span>

<span class="fc" id="L846">        bellProduction = building.getTotalProductionOf(bellsType);</span>
<span class="fc" id="L847">        expectBellProd = 2;</span>
<span class="fc" id="L848">        assertEquals(&quot;Wrong bell production with newspaper&quot;, expectBellProd,</span>
<span class="fc" id="L849">                     bellProduction);</span>

<span class="fc" id="L851">        unit.setLocation(building);</span>
<span class="fc" id="L852">        bellProduction = building.getTotalProductionOf(bellsType);</span>
<span class="fc" id="L853">        expectBellProd = 8; // 1 initial plus 3 from the colonist + 4 from newspaper</span>
<span class="fc" id="L854">        assertEquals(&quot;Wrong final bell production&quot;, expectBellProd,</span>
<span class="fc" id="L855">                     bellProduction);</span>
<span class="fc" id="L856">    }</span>

    public void testUnitProduction() {
<span class="fc" id="L859">        Game game = getGame();</span>
<span class="fc" id="L860">        game.setMap(getTestMap(true));</span>

<span class="fc" id="L862">        Colony colony = getStandardColony(4);</span>
<span class="fc" id="L863">        Unit unit = colony.getUnitList().get(0);</span>
<span class="fc bfc" id="L864" title="All 2 branches covered.">        for (Building building : colony.getBuildings()) {</span>
<span class="fc" id="L865">            clearWorkLocation(building);</span>
<span class="fc" id="L866">            unit.setLocation(building);</span>
<span class="fc bfc" id="L867" title="All 2 branches covered.">            for (AbstractGoods output : building.getOutputs()) {</span>
<span class="fc" id="L868">                GoodsType outputType = output.getType();</span>
<span class="fc bfc" id="L869" title="All 2 branches covered.">                for (UnitType type : spec().getUnitTypeList()) {</span>
<span class="fc bfc" id="L870" title="All 2 branches covered.">                    if (!building.getType().canAdd(type)</span>
<span class="fc bfc" id="L871" title="All 2 branches covered.">                        || !type.isAvailableTo(colony.getOwner())) continue;</span>
<span class="fc" id="L872">                    unit.changeType(type);</span>
<span class="pc bpc" id="L873" title="1 of 2 branches missed.">                    if (output != null) {</span>
<span class="fc" id="L874">                        int productivity = building.getUnitProduction(unit, outputType);</span>
<span class="fc" id="L875">                        int expected = output.getAmount();</span>
<span class="fc bfc" id="L876" title="All 2 branches covered.">                        if (type == building.getExpertUnitType()) {</span>
<span class="fc" id="L877">                            expected = 6;</span>
<span class="fc bfc" id="L878" title="All 2 branches covered.">                        } else if (type == indenturedServantType) {</span>
<span class="fc" id="L879">                            expected = 2;</span>
<span class="fc bfc" id="L880" title="All 2 branches covered.">                        } else if (type == indianConvertType) {</span>
<span class="fc" id="L881">                            expected = 1;</span>
<span class="fc bfc" id="L882" title="All 2 branches covered.">                        } else if (type == pettyCriminalType) {</span>
<span class="fc" id="L883">                            expected = 1;</span>
                        }
<span class="fc bfc" id="L885" title="All 2 branches covered.">                        if (expected != output.getAmount()) {</span>
<span class="fc" id="L886">                            assertFalse(&quot;ModifierSet should not be empty!&quot;,</span>
<span class="fc" id="L887">                                        type.getModifiers(outputType.getId()).isEmpty());</span>
                        }
<span class="fc" id="L889">                        assertEquals(&quot;Wrong productivity for &quot; + type</span>
<span class="fc" id="L890">                            + &quot; in &quot; + building, expected, productivity);</span>
                    }
                }
            }
        }
<span class="fc" id="L895">    }</span>

    public void testToolsMusketProduction() {
<span class="fc" id="L898">        Game game = getGame();</span>
<span class="fc" id="L899">        game.setMap(getTestMap(true));</span>

<span class="fc" id="L901">        Colony colony = getStandardColony(8);</span>
<span class="fc" id="L902">        Tile tile = colony.getTile();</span>
<span class="fc" id="L903">        List&lt;Unit&gt; units = colony.getUnitList();</span>
<span class="fc" id="L904">        assertEquals(8, units.size());</span>

        // Make sure there are enough goods to get started, and make
        // sure enough bells and food are being produced.
        // colony.addGoods(spec().getGoodsType(&quot;model.goods.food&quot;), 100);
<span class="fc" id="L909">        colony.addGoods(bellsType, Colony.LIBERTY_PER_REBEL * 3);</span>
<span class="fc" id="L910">        units.get(0).setLocation(tile);</span>
<span class="fc" id="L911">        units.get(1).setLocation(tile);</span>
<span class="fc" id="L912">        units.get(2).setLocation(tile);</span>
<span class="fc" id="L913">        units.get(3).setLocation(tile);</span>
<span class="fc" id="L914">        assertTrue(colony.getColonyTile(tile.getNeighbourOrNull(Direction.N))</span>
<span class="fc" id="L915">            .setWorkFor(units.get(4)));</span>
<span class="fc" id="L916">        assertTrue(colony.getColonyTile(tile.getNeighbourOrNull(Direction.E))</span>
<span class="fc" id="L917">            .setWorkFor(units.get(5)));</span>
<span class="fc" id="L918">        assertTrue(colony.getColonyTile(tile.getNeighbourOrNull(Direction.S))</span>
<span class="fc" id="L919">            .setWorkFor(units.get(6)));</span>
<span class="fc" id="L920">        assertTrue(colony.getBuilding(townHallType)</span>
<span class="fc" id="L921">            .setWorkFor(units.get(7)));</span>

<span class="fc" id="L923">        Building smithy = colony.getBuilding(blacksmithType);</span>
<span class="fc" id="L924">        assertFalse(smithy.setWorkFor(units.get(0)));</span>
<span class="fc" id="L925">        colony.addGoods(oreType, 50); // Add ore so the smithy becomes viable</span>
<span class="fc" id="L926">        assertTrue(smithy.setWorkFor(units.get(0)));</span>
<span class="fc" id="L927">        assertTrue(smithy.setWorkFor(units.get(1)));</span>

<span class="fc" id="L929">        Building armory = new ServerBuilding(game, colony, armoryType);</span>
<span class="fc" id="L930">        colony.addBuilding(armory);</span>
<span class="fc" id="L931">        colony.invalidateCache();</span>

<span class="fc" id="L933">        assertTrue(armory.setWorkFor(units.get(2)));</span>
<span class="fc" id="L934">        assertTrue(armory.setWorkFor(units.get(3)));</span>

<span class="fc" id="L936">        assertEquals(toolsType,   units.get(0).getWorkType());</span>
<span class="fc" id="L937">        assertEquals(toolsType,   units.get(1).getWorkType());</span>
<span class="fc" id="L938">        assertEquals(musketsType, units.get(2).getWorkType());</span>
<span class="fc" id="L939">        assertEquals(musketsType, units.get(3).getWorkType());</span>
<span class="fc" id="L940">        assertEquals(6, smithy.getTotalProductionOf(toolsType));</span>
<span class="fc" id="L941">        assertEquals(6, armory.getTotalProductionOf(musketsType));</span>

        // Upgrade the buildings
<span class="fc" id="L944">        smithy.upgrade();</span>
<span class="fc" id="L945">        armory.upgrade();</span>
<span class="fc" id="L946">        colony.invalidateCache();</span>

<span class="fc" id="L948">        assertEquals(toolsType,   units.get(0).getWorkType());</span>
<span class="fc" id="L949">        assertEquals(toolsType,   units.get(1).getWorkType());</span>
<span class="fc" id="L950">        assertEquals(musketsType, units.get(2).getWorkType());</span>
<span class="fc" id="L951">        assertEquals(musketsType, units.get(3).getWorkType());</span>
<span class="fc" id="L952">        assertEquals(12, smithy.getTotalProductionOf(toolsType));</span>
<span class="fc" id="L953">        assertEquals(12, armory.getTotalProductionOf(musketsType));</span>

        // Upgrade to factory level
<span class="fc" id="L956">        colony.getOwner().addFather(spec()</span>
<span class="fc" id="L957">            .getFoundingFather(&quot;model.foundingFather.adamSmith&quot;));</span>
<span class="fc" id="L958">        smithy.upgrade();</span>
<span class="fc" id="L959">        armory.upgrade();</span>
<span class="fc" id="L960">        colony.invalidateCache();</span>

<span class="fc" id="L962">        assertEquals(toolsType,   units.get(0).getWorkType());</span>
<span class="fc" id="L963">        assertEquals(toolsType,   units.get(1).getWorkType());</span>
<span class="fc" id="L964">        assertEquals(musketsType, units.get(2).getWorkType());</span>
<span class="fc" id="L965">        assertEquals(musketsType, units.get(3).getWorkType());</span>
<span class="fc" id="L966">        assertEquals(18, smithy.getTotalProductionOf(toolsType));</span>
        //assertEquals(&quot;According to bug report #3430371, the arsenal does not enjoy &quot;
        //            + &quot;the usual factory level production bonus of 50%&quot;,
        //    12, armory.getTotalProductionOf(musketsType));
        // #3430371 has been reverted until we can work out what arsenal
        // did that differed from magazine
<span class="fc" id="L972">        assertEquals(18, armory.getTotalProductionOf(musketsType));</span>
<span class="fc" id="L973">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span>src (May 7, 2016 6:04:12 PM)</div></body></html>