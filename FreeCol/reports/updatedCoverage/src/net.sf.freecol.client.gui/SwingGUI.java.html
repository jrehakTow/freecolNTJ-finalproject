<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>SwingGUI.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">net.sf.freecol.tools (2) (May 15, 2016 11:18:55 PM)</a> &gt; <a href="../../index.html" class="el_group">FreeCol</a> &gt; <a href="../index.html" class="el_bundle">src</a> &gt; <a href="index.source.html" class="el_package">net.sf.freecol.client.gui</a> &gt; <span class="el_source">SwingGUI.java</span></div><h1>SwingGUI.java</h1><pre class="source lang-java linenums">/**
 *  Copyright (C) 2002-2016   The FreeCol Team
 *
 *  This file is part of FreeCol.
 *
 *  FreeCol is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  FreeCol is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with FreeCol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package net.sf.freecol.client.gui;

import java.awt.Component;
import java.awt.Dimension;
import java.awt.DisplayMode;
import java.awt.Font;
import java.awt.Graphics2D;
import java.awt.GraphicsDevice;
import java.awt.GraphicsEnvironment;
import java.awt.HeadlessException;
import java.awt.MouseInfo;
import java.awt.Point;
import java.awt.Rectangle;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.KeyEvent;
import java.awt.event.KeyListener;
import java.awt.event.MouseEvent;
import java.awt.event.MouseListener;
import java.awt.image.BufferedImage;
import java.beans.PropertyChangeEvent;
import java.io.File;
import java.io.InputStream;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.logging.Level;

import javax.imageio.ImageIO;
import javax.swing.ImageIcon;
import javax.swing.JLabel;
import javax.swing.JWindow;
import javax.swing.Timer;
import javax.swing.filechooser.FileFilter;

import net.sf.freecol.client.ClientOptions;
import net.sf.freecol.client.FreeColClient;
import net.sf.freecol.client.gui.animation.Animations;
import net.sf.freecol.client.gui.panel.ColonyPanel;
import net.sf.freecol.client.gui.panel.ColorChooserPanel;
import net.sf.freecol.client.gui.panel.CornerMapControls;
import net.sf.freecol.client.gui.panel.FreeColDialog;
import net.sf.freecol.client.gui.panel.LabourData.UnitData;
import net.sf.freecol.client.gui.panel.MapControls;
import net.sf.freecol.client.gui.panel.Parameters;
import net.sf.freecol.client.gui.panel.TradeRoutePanel;
import net.sf.freecol.client.gui.panel.Utility;
import net.sf.freecol.client.gui.plaf.FreeColLookAndFeel;
import net.sf.freecol.client.gui.video.VideoComponent;
import net.sf.freecol.client.gui.video.VideoListener;
import net.sf.freecol.common.FreeColException;
import net.sf.freecol.common.ServerInfo;
import net.sf.freecol.common.i18n.Messages;
import net.sf.freecol.common.model.Colony;
import net.sf.freecol.common.model.DiplomaticTrade;
import net.sf.freecol.common.model.Europe;
import net.sf.freecol.common.model.FoundingFather;
import net.sf.freecol.common.model.FreeColGameObject;
import net.sf.freecol.common.model.FreeColObject;
import net.sf.freecol.common.model.Game;
import net.sf.freecol.common.model.Goods;
import net.sf.freecol.common.model.GoodsType;
import net.sf.freecol.common.model.HighScore;
import net.sf.freecol.common.model.IndianSettlement;
import net.sf.freecol.common.model.Location;
import net.sf.freecol.common.model.ModelMessage;
import net.sf.freecol.common.model.Monarch.MonarchAction;
import net.sf.freecol.common.model.Nation;
import net.sf.freecol.common.model.Player;
import net.sf.freecol.common.model.Settlement;
import net.sf.freecol.common.model.Specification;
import net.sf.freecol.common.model.StringTemplate;
import net.sf.freecol.common.model.Tile;
import net.sf.freecol.common.model.TileType;
import net.sf.freecol.common.model.TradeRoute;
import net.sf.freecol.common.model.TypeCountMap;
import net.sf.freecol.common.model.Unit;
import net.sf.freecol.common.model.UnitType;
import net.sf.freecol.common.model.WorkLocation;
import net.sf.freecol.common.option.BooleanOption;
import net.sf.freecol.common.option.LanguageOption;
import net.sf.freecol.common.option.LanguageOption.Language;
import net.sf.freecol.common.option.Option;
import net.sf.freecol.common.option.OptionGroup;
import net.sf.freecol.common.resources.ResourceManager;
import net.sf.freecol.common.resources.Video;

import static net.sf.freecol.common.util.StringUtils.lastPart;


/**
 * A wrapper providing functionality for the overall GUI using Java Swing.
 */
public class SwingGUI extends GUI {

    private final GraphicsDevice graphicsDevice;

    /**
     * This is the TileViewer instance used to paint the map tiles
     * in the ColonyPanel and other panels.  It should not be scaled
     * along with the default MapViewer.
     */
    private TileViewer tileViewer;

    /**
     * The MapViewer instance used by canvas to paint the main map.
     * This does need to be scaled.
     */
    private MapViewer mapViewer;

    /** The canvas that implements much of the functionality. */
    private Canvas canvas;

    private MapControls mapControls;

    private JWindow splash;


    /**
     * Create the GUI.
     *
     * @param freeColClient The &lt;code&gt;FreeColClient&lt;/code&gt; for the game.
     * @param scaleFactor The scale factor for the GUI.
     */
    public SwingGUI(FreeColClient freeColClient, float scaleFactor) {
<span class="nc" id="L145">        super(freeColClient, scaleFactor);</span>
        
<span class="nc" id="L147">        graphicsDevice = getGoodGraphicsDevice();</span>
<span class="nc" id="L148">        logger.info(&quot;GUI constructed using scale factor &quot; + scaleFactor);</span>
<span class="nc" id="L149">    }</span>


    // Simple accessors

    public Canvas getCanvas() {
<span class="nc" id="L155">        return canvas;</span>
    }

    public ImageLibrary getTileImageLibrary() {
<span class="nc" id="L159">        return tileViewer.getImageLibrary();</span>
    }

    @Override
    public boolean isWindowed() {
<span class="nc" id="L164">        return canvas.isWindowed();</span>
    }

    // Initialization related methods

    /** 
     * {@inheritDoc}
     */
    @Override
    public void installLookAndFeel(String fontName) throws FreeColException {
<span class="nc" id="L174">        FreeColLookAndFeel fclaf = new FreeColLookAndFeel();</span>
<span class="nc" id="L175">        FreeColLookAndFeel.install(fclaf);</span>
<span class="nc" id="L176">        Font font = FontLibrary.createMainFont(</span>
<span class="nc" id="L177">            fontName, imageLibrary.getScaleFactor());</span>
<span class="nc" id="L178">        FreeColLookAndFeel.installFont(font);</span>
<span class="nc" id="L179">        Utility.initStyleContext(font);</span>
<span class="nc" id="L180">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void quit() {
<span class="nc bnc" id="L187" title="All 2 branches missed.">        if (canvas != null) {</span>
<span class="nc" id="L188">            canvas.quit();</span>
        }
<span class="nc" id="L190">    }</span>

    /** 
     * {@inheritDoc}
     */
    @Override
    public void initializeInGame() {
<span class="nc" id="L197">        canvas.initializeInGame();</span>
<span class="nc" id="L198">        enableMapControls(getClientOptions()</span>
<span class="nc" id="L199">            .getBoolean(ClientOptions.DISPLAY_MAP_CONTROLS));</span>
<span class="nc" id="L200">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void setupMouseListeners() {
<span class="nc" id="L207">        canvas.setupMouseListeners();</span>
<span class="nc" id="L208">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void displaySplashScreen(final InputStream splashStream) {
<span class="nc" id="L215">        splash = null;</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">        if (splashStream == null) return;</span>
        try {
<span class="nc" id="L218">            BufferedImage im = ImageIO.read(splashStream);</span>
<span class="nc" id="L219">            splash = new JWindow(graphicsDevice.getDefaultConfiguration());</span>
<span class="nc" id="L220">            splash.getContentPane().add(new JLabel(new ImageIcon(im)));</span>
<span class="nc" id="L221">            splash.pack();</span>
<span class="nc" id="L222">            Point start = splash.getLocation();</span>
<span class="nc" id="L223">            DisplayMode dm = graphicsDevice.getDisplayMode();</span>
<span class="nc" id="L224">            splash.setLocation(start.x + dm.getWidth()/2 - splash.getWidth() / 2,</span>
<span class="nc" id="L225">                start.y + dm.getHeight()/2 - splash.getHeight() / 2);</span>
<span class="nc" id="L226">            splash.setVisible(true);</span>
<span class="nc" id="L227">        } catch (Exception e) {</span>
<span class="nc" id="L228">            logger.log(Level.WARNING, &quot;Splash fail&quot;, e);</span>
<span class="nc" id="L229">            splash = null;</span>
        }
<span class="nc" id="L231">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void hideSplashScreen() {
<span class="nc bnc" id="L238" title="All 2 branches missed.">        if (splash != null) {</span>
<span class="nc" id="L239">            splash.setVisible(false);</span>
<span class="nc" id="L240">            splash.dispose();</span>
<span class="nc" id="L241">            splash = null;</span>
        }
<span class="nc" id="L243">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showOpeningVideo(final String userMsg) {
<span class="nc" id="L250">        canvas.closeMenus();</span>
<span class="nc" id="L251">        final Video video = ResourceManager.getVideo(&quot;video.opening&quot;);</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">        boolean muteAudio = !getSoundController().canPlaySound();</span>
<span class="nc" id="L253">        final VideoComponent vp = new VideoComponent(video, muteAudio);</span>

<span class="nc" id="L255">        final class AbortListener implements ActionListener, KeyListener,</span>
            MouseListener, VideoListener {

<span class="nc" id="L258">            private Timer t = null;</span>

            @Override
            public void keyPressed(KeyEvent e) {
<span class="nc" id="L262">            }</span>

            @Override
            public void keyReleased(KeyEvent e1) {
<span class="nc" id="L266">                execute();</span>
<span class="nc" id="L267">            }</span>

            @Override
            public void keyTyped(KeyEvent e2) {
<span class="nc" id="L271">            }</span>

            @Override
            public void mouseClicked(MouseEvent e3) {
<span class="nc" id="L275">                execute();</span>
<span class="nc" id="L276">            }</span>

            @Override
            public void mouseEntered(MouseEvent e4) {
<span class="nc" id="L280">            }</span>

            @Override
            public void mouseExited(MouseEvent e5) {
<span class="nc" id="L284">            }</span>

            @Override
            public void mousePressed(MouseEvent e6) {
<span class="nc" id="L288">            }</span>

            @Override
            public void mouseReleased(MouseEvent e7) {
<span class="nc" id="L292">            }</span>

            @Override
            public void stopped() {
<span class="nc" id="L296">                execute();</span>
<span class="nc" id="L297">            }</span>

            @Override
            public void actionPerformed(ActionEvent ae8) {
<span class="nc" id="L301">                execute();</span>
<span class="nc" id="L302">            }</span>

            private void setTimer(Timer t1) {
<span class="nc" id="L305">                this.t = t1;</span>
<span class="nc" id="L306">            }</span>

            private void execute() {
<span class="nc" id="L309">                canvas.removeKeyListener(this);</span>
<span class="nc" id="L310">                canvas.removeMouseListener(this);</span>
<span class="nc" id="L311">                vp.removeMouseListener(this);</span>
                //vp.removeVideoListener(this);
<span class="nc" id="L313">                vp.stop();</span>
<span class="nc" id="L314">                canvas.remove(vp);</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">                if (t != null) {</span>
<span class="nc" id="L316">                    t.stop();</span>
                }
<span class="nc" id="L318">                playSound(&quot;sound.intro.general&quot;);</span>
<span class="nc" id="L319">                showMainPanel(userMsg);</span>
<span class="nc" id="L320">            }</span>
        }
<span class="nc" id="L322">        AbortListener l = new AbortListener();</span>
<span class="nc" id="L323">        vp.addMouseListener(l);</span>
        //vp.addVideoListener(l);
<span class="nc" id="L325">        canvas.showVideoComponent(vp, l, l);</span>
<span class="nc" id="L326">        vp.play();</span>
        // Cortado applet is failing to quit when finished, make sure it
        // eventually gets kicked.  Change the magic number if we
        // change the opening video length.
<span class="nc" id="L330">        Timer t2 = new Timer(80000, l);</span>
<span class="nc" id="L331">        l.setTimer(t2);</span>
<span class="nc" id="L332">        t2.setRepeats(false);</span>
<span class="nc" id="L333">        t2.start();</span>
<span class="nc" id="L334">    }</span>

    /**
     * Get a good screen device for starting FreeCol.
     *
     * @return A screen device, or null if none available
     *     (as in headless mode).
     */
    private static GraphicsDevice getGoodGraphicsDevice() {
        try {
<span class="nc" id="L344">            return MouseInfo.getPointerInfo().getDevice();</span>
<span class="nc" id="L345">        } catch (HeadlessException he) {}</span>

        try {
<span class="nc" id="L348">            final GraphicsEnvironment lge</span>
<span class="nc" id="L349">                = GraphicsEnvironment.getLocalGraphicsEnvironment();</span>
<span class="nc" id="L350">            return lge.getDefaultScreenDevice();</span>
<span class="nc" id="L351">        } catch (HeadlessException he) {}</span>

<span class="nc" id="L353">        FreeColClient.fatal(&quot;Could not find a GraphicsDevice!&quot;);</span>
<span class="nc" id="L354">        return null;</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public void startGUI(final Dimension desiredWindowSize) {
<span class="nc" id="L362">        final ClientOptions opts = getClientOptions();</span>

        // Work around a Java 2D bug that seems to be X11 specific.
        // According to:
        //   http://www.oracle.com/technetwork/java/javase/index-142560.html
        //
        //   ``The use of pixmaps typically results in better
        //     performance. However, in certain cases, the opposite is true.''
        //
        // The standard workaround is to use -Dsun.java2d.pmoffscreen=false,
        // but this is too hard for some users, so provide an option to
        // do it easily.  However respect the initial value if present.
        //
        // Remove this if Java 2D is ever fixed.  DHYB.
        //
<span class="nc" id="L377">        final String pmoffscreen = &quot;sun.java2d.pmoffscreen&quot;;</span>
<span class="nc" id="L378">        BooleanOption usePixmaps</span>
<span class="nc" id="L379">            = (BooleanOption) opts.getOption(ClientOptions.USE_PIXMAPS);</span>
<span class="nc" id="L380">        String pmoffscreenValue = System.getProperty(pmoffscreen);</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">        if (pmoffscreenValue == null) {</span>
<span class="nc" id="L382">            System.setProperty(pmoffscreen, usePixmaps.getValue().toString());</span>
<span class="nc" id="L383">            logger.info(pmoffscreen + &quot; using client option: &quot;</span>
<span class="nc" id="L384">                + usePixmaps.getValue());</span>
<span class="nc" id="L385">        } else {</span>
<span class="nc" id="L386">            usePixmaps.setValue(Boolean.valueOf(pmoffscreenValue));</span>
<span class="nc" id="L387">            logger.info(pmoffscreen + &quot; overrides client option: &quot;</span>
<span class="nc" id="L388">                + pmoffscreenValue);</span>
        }
<span class="nc" id="L390">        usePixmaps.addPropertyChangeListener((PropertyChangeEvent e) -&gt; {</span>
<span class="nc" id="L391">                String newValue = e.getNewValue().toString();</span>
<span class="nc" id="L392">                System.setProperty(pmoffscreen, newValue);</span>
<span class="nc" id="L393">                logger.info(&quot;Set &quot; + pmoffscreen + &quot; to: &quot; + newValue);</span>
<span class="nc" id="L394">            });</span>

<span class="nc" id="L396">        this.mapViewer = new MapViewer(getFreeColClient());</span>
<span class="nc" id="L397">        this.canvas = new Canvas(getFreeColClient(), graphicsDevice, this,</span>
<span class="nc" id="L398">                                 desiredWindowSize, mapViewer);</span>
<span class="nc" id="L399">        this.tileViewer = new TileViewer(getFreeColClient());</span>

        // Now that there is a canvas, prepare for language changes.
<span class="nc" id="L402">        LanguageOption o = (LanguageOption)getClientOptions()</span>
<span class="nc" id="L403">            .getOption(ClientOptions.LANGUAGE);</span>
<span class="nc" id="L404">        o.addPropertyChangeListener((PropertyChangeEvent e) -&gt; {</span>
<span class="nc" id="L405">                Language language = (Language)e.getNewValue();</span>
<span class="nc" id="L406">                logger.info(&quot;Set language to: &quot; + language);</span>
<span class="nc bnc" id="L407" title="All 2 branches missed.">                if (Messages.AUTOMATIC.equalsIgnoreCase(language.getKey())) {</span>
<span class="nc" id="L408">                    showInformationMessage(&quot;info.autodetectLanguageSelected&quot;);</span>
<span class="nc" id="L409">                } else {</span>
<span class="nc" id="L410">                    Locale l = language.getLocale();</span>
<span class="nc" id="L411">                    Messages.loadMessageBundle(l);</span>
<span class="nc" id="L412">                    Messages.loadModMessageBundle(l);</span>
<span class="nc" id="L413">                    showInformationMessage(StringTemplate</span>
<span class="nc" id="L414">                        .template(&quot;info.newLanguageSelected&quot;)</span>
<span class="nc" id="L415">                        .addName(&quot;%language%&quot;, l.getDisplayName()));</span>
                }
<span class="nc" id="L417">            });</span>

<span class="nc" id="L419">        logger.info(&quot;GUI created.&quot;);</span>
<span class="nc" id="L420">        logger.info(&quot;Starting in Move Units View Mode&quot;);</span>
<span class="nc" id="L421">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void changeWindowedMode() {
<span class="nc" id="L428">        canvas.changeWindowedMode();</span>
<span class="nc" id="L429">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void startMapEditorGUI() {
<span class="nc" id="L436">        canvas.startMapEditorGUI();</span>
<span class="nc" id="L437">    }</span>


    // Non-trivial public routines.

    /**
     * {@inheritDoc}
     */
    @Override
    public void activateGotoPath() {
<span class="nc" id="L447">        Unit unit = getActiveUnit();</span>

        // Action should be disabled if there is no active unit, but make sure
<span class="nc bnc" id="L450" title="All 2 branches missed.">        if (unit == null) return;</span>

        // Enter &quot;goto mode&quot; if not already activated; otherwise cancel it
<span class="nc bnc" id="L453" title="All 2 branches missed.">        if (canvas.isGotoStarted()) {</span>
<span class="nc" id="L454">            canvas.stopGoto();</span>
<span class="nc" id="L455">        } else {</span>
<span class="nc" id="L456">            canvas.startGoto();</span>

            // Draw the path to the current mouse position, if the
            // mouse is over the screen; see also
            // CanvasMouseMotionListener.
<span class="nc" id="L461">            Point pt = canvas.getMousePosition();</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">            if (pt != null) {</span>
<span class="nc" id="L463">                Tile tile = canvas.convertToMapTile(pt.x, pt.y);</span>
<span class="nc bnc" id="L464" title="All 4 branches missed.">                if (tile != null &amp;&amp; unit.getTile() != tile) {</span>
<span class="nc" id="L465">                    canvas.setGotoPath(unit.findPath(tile));</span>
                }
            }
        }
<span class="nc" id="L469">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void clearGotoPath() {
<span class="nc" id="L476">        Unit unit = getActiveUnit();</span>

        // Action should be disabled if there is no active unit, but make sure
<span class="nc bnc" id="L479" title="All 2 branches missed.">        if (unit == null) return;</span>
<span class="nc" id="L480">        canvas.stopGoto();</span>
<span class="nc" id="L481">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void displayChatMessage(Player player, String message,
                                   boolean privateChat) {
<span class="nc" id="L489">        canvas.displayChatMessage(new GUIMessage(</span>
<span class="nc" id="L490">            player.getName() + &quot;: &quot; + message, player.getNationColor()));</span>
<span class="nc" id="L491">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void refresh() {
<span class="nc" id="L498">        mapViewer.forceReposition();</span>
<span class="nc" id="L499">        canvas.refresh();</span>
<span class="nc" id="L500">    }</span>

    /**
     * {@inheritDoc}
     */
    public void refreshTile(Tile tile) {
<span class="nc bnc" id="L506" title="All 4 branches missed.">        if (tile.getX() &gt;= 0 &amp;&amp; tile.getY() &gt;= 0) {</span>
<span class="nc" id="L507">            canvas.repaint(mapViewer.calculateTileBounds(tile));</span>
        }
<span class="nc" id="L509">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void resetMenuBar() {
<span class="nc" id="L516">        getFreeColClient().updateActions();</span>
<span class="nc" id="L517">        canvas.resetMenuBar();</span>
<span class="nc" id="L518">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    protected void resetMapZoom() {
<span class="nc" id="L525">        super.resetMapZoom();</span>
<span class="nc" id="L526">        mapViewer.resetMapScale();</span>
<span class="nc" id="L527">        refresh();</span>
<span class="nc" id="L528">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public boolean canZoomInMap() {
<span class="nc bnc" id="L535" title="All 2 branches missed.">        return !mapViewer.isAtMaxMapScale();</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public boolean canZoomOutMap() {
<span class="nc bnc" id="L543" title="All 2 branches missed.">        return !mapViewer.isAtMinMapScale();</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public void zoomInMap() {
<span class="nc" id="L551">        super.zoomInMap();</span>
<span class="nc" id="L552">        mapViewer.increaseMapScale();</span>
<span class="nc" id="L553">        refresh();</span>
<span class="nc" id="L554">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void zoomOutMap() {
<span class="nc" id="L561">        super.zoomOutMap();</span>
<span class="nc" id="L562">        mapViewer.decreaseMapScale();</span>
<span class="nc" id="L563">        refresh();</span>
<span class="nc" id="L564">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public boolean setActiveUnit(Unit unit) {
<span class="nc" id="L571">        boolean result = mapViewer.setActiveUnit(unit);</span>
<span class="nc" id="L572">        updateMapControls();</span>
<span class="nc" id="L573">        updateMenuBar();</span>
<span class="nc bnc" id="L574" title="All 4 branches missed.">        if (unit != null &amp;&amp; !getMyPlayer().owns(unit)) {</span>
<span class="nc" id="L575">            canvas.refresh();</span>
        }
<span class="nc" id="L577">        return result;</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public void updateMenuBar() {
<span class="nc" id="L585">        getFreeColClient().updateActions();</span>
<span class="nc" id="L586">        canvas.updateMenuBar();</span>
<span class="nc" id="L587">    }</span>


    // Animation handling

    /**
     * Require the given tile to be in the onScreen()-area.
     *
     * @param tile The &lt;code&gt;Tile&lt;/code&gt; to check.
     * @return True if the focus was set.
     */
    public boolean requireFocus(Tile tile) {
        // Account for the ALWAYS_CENTER client option.
<span class="nc" id="L600">        boolean required = getClientOptions().getBoolean(ClientOptions.ALWAYS_CENTER);</span>
<span class="nc bnc" id="L601" title="All 6 branches missed.">        if ((required &amp;&amp; tile != getFocus()) || !mapViewer.onScreen(tile)) {</span>
<span class="nc" id="L602">            setFocusImmediately(tile);</span>
<span class="nc" id="L603">            return true;</span>
        }
<span class="nc" id="L605">        return false;</span>
    }
        
    /**
     * {@inheritDoc}
     */
    @Override
    public void animateUnitAttack(Unit attacker, Unit defender,
                                  Tile attackerTile, Tile defenderTile,
                                  boolean success) {
<span class="nc" id="L615">        requireFocus(attackerTile);</span>
<span class="nc" id="L616">        Animations.unitAttack(getFreeColClient(), attacker, defender,</span>
<span class="nc" id="L617">                              attackerTile, defenderTile, success);</span>
<span class="nc" id="L618">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void animateUnitMove(Unit unit, Tile srcTile, Tile dstTile) {
<span class="nc" id="L625">        requireFocus(srcTile);</span>
<span class="nc" id="L626">        Animations.unitMove(getFreeColClient(), unit, srcTile, dstTile);</span>
<span class="nc" id="L627">    }</span>


    // MapControls handling

    /**
     * {@inheritDoc}
     */
    @Override
    public void enableMapControls(boolean enable) {
        // Always instantiate in game.
<span class="nc bnc" id="L638" title="All 4 branches missed.">        if (enable &amp;&amp; mapControls == null) {</span>
<span class="nc" id="L639">            String className = getClientOptions().getString(ClientOptions.MAP_CONTROLS);</span>
            try {
<span class="nc" id="L641">                final String panelName = &quot;net.sf.freecol.client.gui.panel.&quot;</span>
<span class="nc" id="L642">                    + lastPart(className, &quot;.&quot;);</span>
<span class="nc" id="L643">                Class&lt;?&gt; controls = Class.forName(panelName);</span>
<span class="nc" id="L644">                mapControls = (MapControls)controls</span>
<span class="nc" id="L645">                    .getConstructor(FreeColClient.class)</span>
<span class="nc" id="L646">                    .newInstance(getFreeColClient());</span>
<span class="nc" id="L647">                logger.info(&quot;Instantiated &quot; + panelName);</span>
<span class="nc" id="L648">            } catch (Exception e) {</span>
<span class="nc" id="L649">                logger.log(Level.INFO, &quot;Fallback to CornerMapControls from &quot;</span>
<span class="nc" id="L650">                    + className, e);</span>
<span class="nc" id="L651">                mapControls = new CornerMapControls(getFreeColClient());</span>
            }
<span class="nc bnc" id="L653" title="All 2 branches missed.">            if (mapControls != null) {</span>
<span class="nc" id="L654">                mapControls.addToComponent(canvas);</span>
<span class="nc" id="L655">                mapControls.update();</span>
            }
<span class="nc bnc" id="L657" title="All 4 branches missed.">        } else if (!enable &amp;&amp; mapControls != null) {</span>
<span class="nc" id="L658">            mapControls.removeFromComponent(canvas);</span>
<span class="nc" id="L659">            mapControls = null;</span>
        }
<span class="nc" id="L661">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void updateMapControls() {
<span class="nc bnc" id="L668" title="All 2 branches missed.">        if (mapControls != null) mapControls.update();</span>
<span class="nc" id="L669">    }</span>

    public void updateMapControlsInCanvas() {
<span class="nc bnc" id="L672" title="All 2 branches missed.">        if (mapControls == null) return;</span>
<span class="nc" id="L673">        mapControls.removeFromComponent(canvas);</span>
<span class="nc" id="L674">        mapControls.addToComponent(canvas);</span>
<span class="nc" id="L675">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void zoomInMapControls() {
<span class="nc bnc" id="L682" title="All 2 branches missed.">        if (mapControls == null) return;</span>
<span class="nc" id="L683">        mapControls.zoomIn();</span>
<span class="nc" id="L684">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void zoomOutMapControls() {
<span class="nc bnc" id="L691" title="All 2 branches missed.">        if (mapControls == null) return;</span>
<span class="nc" id="L692">        mapControls.zoomOut();</span>
<span class="nc" id="L693">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public boolean canZoomInMapControls() {
<span class="nc bnc" id="L700" title="All 4 branches missed.">        return mapControls != null &amp;&amp; mapControls.canZoomInMapControls();</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public boolean canZoomOutMapControls() {
<span class="nc bnc" id="L708" title="All 4 branches missed.">        return mapControls != null &amp;&amp; mapControls.canZoomOutMapControls();</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public void miniMapToggleViewControls() {
<span class="nc bnc" id="L716" title="All 2 branches missed.">        if (mapControls == null) return;</span>
<span class="nc" id="L717">        mapControls.toggleView();</span>
<span class="nc" id="L718">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void miniMapToggleFogOfWarControls() {
<span class="nc bnc" id="L725" title="All 2 branches missed.">        if (mapControls == null) return;</span>
<span class="nc" id="L726">        mapControls.toggleFogOfWar();</span>
<span class="nc" id="L727">    }</span>


    // Dialogs that return values

    /**
     * {@inheritDoc}
     */
    @Override
    public boolean confirm(String textKey, String okKey, String cancelKey) {
<span class="nc" id="L737">        return canvas.showConfirmDialog(null, Messages.message(textKey),</span>
<span class="nc" id="L738">            null, okKey, cancelKey);</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public boolean confirm(Tile tile, StringTemplate template,
                           String okKey, String cancelKey) {
<span class="nc" id="L747">        return canvas.showConfirmDialog(tile,</span>
<span class="nc" id="L748">            Utility.localizedTextArea(template), null, okKey, cancelKey);</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public boolean confirm(Tile tile, StringTemplate template, Unit unit,
                           String okKey, String cancelKey) {
<span class="nc" id="L757">        return canvas.showConfirmDialog(tile,</span>
<span class="nc" id="L758">            Utility.localizedTextArea(template),</span>
<span class="nc" id="L759">            new ImageIcon(imageLibrary.getUnitImage(unit)),</span>
<span class="nc" id="L760">            okKey, cancelKey);</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public boolean confirm(Tile tile, StringTemplate template,
                           Settlement settlement,
                           String okKey, String cancelKey) {
<span class="nc" id="L770">        return canvas.showConfirmDialog(tile,</span>
<span class="nc" id="L771">            Utility.localizedTextArea(template),</span>
<span class="nc" id="L772">            new ImageIcon(imageLibrary.getSettlementImage(settlement)),</span>
<span class="nc" id="L773">            okKey, cancelKey);</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public boolean confirm(Tile tile, StringTemplate template,
                           GoodsType goodsType,
                           String okKey, String cancelKey) {
<span class="nc" id="L783">        return canvas.showConfirmDialog(tile,</span>
<span class="nc" id="L784">            Utility.localizedTextArea(template),</span>
<span class="nc" id="L785">            new ImageIcon(imageLibrary.getIconImage(goodsType)),</span>
<span class="nc" id="L786">            okKey, cancelKey);</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public List&lt;String&gt; confirmDeclaration() {
<span class="nc" id="L794">        return canvas.showConfirmDeclarationDialog();</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public &lt;T&gt; T getChoice(Tile tile, Object explain,
                           String cancelKey, List&lt;ChoiceItem&lt;T&gt;&gt; choices) {
<span class="nc" id="L803">        return canvas.showChoiceDialog(tile, explain,</span>
<span class="nc" id="L804">            null, cancelKey, choices);</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public &lt;T&gt; T getChoice(Tile tile, Object explain, Unit unit,
                           String cancelKey, List&lt;ChoiceItem&lt;T&gt;&gt; choices) {
<span class="nc" id="L813">        return canvas.showChoiceDialog(tile, explain,</span>
<span class="nc" id="L814">            new ImageIcon(imageLibrary.getUnitImage(unit)),</span>
<span class="nc" id="L815">            cancelKey, choices);</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public &lt;T&gt; T getChoice(Tile tile, Object explain, Settlement settlement,
                           String cancelKey, List&lt;ChoiceItem&lt;T&gt;&gt; choices) {
<span class="nc" id="L824">        return canvas.showChoiceDialog(tile, explain,</span>
<span class="nc" id="L825">            new ImageIcon(imageLibrary.getSettlementImage(settlement)),</span>
<span class="nc" id="L826">            cancelKey, choices);</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public &lt;T&gt; T getChoice(Tile tile, Object explain, GoodsType goodsType,
                           String cancelKey, List&lt;ChoiceItem&lt;T&gt;&gt; choices) {
<span class="nc" id="L835">        return canvas.showChoiceDialog(tile, explain,</span>
<span class="nc" id="L836">            new ImageIcon(imageLibrary.getIconImage(goodsType)),</span>
<span class="nc" id="L837">            cancelKey, choices);</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public &lt;T&gt; T getChoice(Tile tile, Object explain, Nation nation,
                           String cancelKey, List&lt;ChoiceItem&lt;T&gt;&gt; choices) {
<span class="nc" id="L846">        return canvas.showChoiceDialog(tile, explain,</span>
<span class="nc" id="L847">            new ImageIcon(imageLibrary.getMiscIconImage(nation)),</span>
<span class="nc" id="L848">            cancelKey, choices);</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public String getInput(Tile tile, StringTemplate template,
                           String defaultValue,
                           String okKey, String cancelKey) {
<span class="nc" id="L858">        return canvas.showInputDialog(tile, template, defaultValue,</span>
<span class="nc" id="L859">                                      okKey, cancelKey);</span>
    }


    // Trivial delegations to Canvas

    /**
     * {@inheritDoc}
     */
    @Override
    public void closeMainPanel() {
<span class="nc" id="L870">        canvas.closeMainPanel();</span>
<span class="nc" id="L871">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void closeMenus() {
<span class="nc" id="L878">        canvas.closeMenus();</span>
<span class="nc" id="L879">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void closeStatusPanel() {
<span class="nc" id="L886">        canvas.closeStatusPanel();</span>
<span class="nc" id="L887">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public boolean containsInGameComponents() {
<span class="nc" id="L894">        return canvas.containsInGameComponents();</span>
    }

    public void dialogRemove(FreeColDialog&lt;?&gt; fcd) {
<span class="nc" id="L898">        canvas.dialogRemove(fcd);</span>
<span class="nc" id="L899">    }</span>

    /**
     * Show the appropriate panel for an object.
     *
     * TODO: Improve OO.
     *
     * @param fco The &lt;code&gt;FreeColObject&lt;/code&gt; to display.
     */
    public void displayObject(FreeColObject fco) {
<span class="nc bnc" id="L909" title="All 2 branches missed.">        if (fco instanceof Colony) {</span>
<span class="nc" id="L910">            canvas.showColonyPanel((Colony)fco, null);</span>
<span class="nc bnc" id="L911" title="All 2 branches missed.">        } else if (fco instanceof Europe) {</span>
<span class="nc" id="L912">            canvas.showEuropePanel();</span>
<span class="nc bnc" id="L913" title="All 2 branches missed.">        } else if (fco instanceof IndianSettlement) {</span>
<span class="nc" id="L914">            canvas.showIndianSettlementPanel((IndianSettlement)fco);</span>
<span class="nc bnc" id="L915" title="All 2 branches missed.">        } else if (fco instanceof Tile) {</span>
<span class="nc" id="L916">            setFocus((Tile)fco);</span>
<span class="nc bnc" id="L917" title="All 2 branches missed.">        } else if (fco instanceof Unit) {</span>
<span class="nc" id="L918">            Location loc = ((Unit)fco).up();</span>
<span class="nc bnc" id="L919" title="All 2 branches missed.">            if (loc instanceof Colony) {</span>
<span class="nc" id="L920">                canvas.showColonyPanel((Colony)loc, (Unit)fco);</span>
<span class="nc" id="L921">            } else {</span>
<span class="nc" id="L922">                displayObject((FreeColObject)loc);</span>
            }
<span class="nc bnc" id="L924" title="All 2 branches missed.">        } else if (fco instanceof WorkLocation) {</span>
<span class="nc" id="L925">            canvas.showColonyPanel(((WorkLocation)fco).getColony(), null);</span>
        }
<span class="nc" id="L927">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public LoadingSavegameInfo getLoadingSavegameInfo() {
<span class="nc" id="L934">        return canvas.getLoadingSavegameDialog().getInfo();</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public boolean isClientOptionsDialogShowing() {
<span class="nc bnc" id="L942" title="All 4 branches missed.">        return canvas!=null &amp;&amp; canvas.isClientOptionsDialogShowing();</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public boolean isMapboardActionsEnabled() {
<span class="nc bnc" id="L950" title="All 4 branches missed.">        return canvas!=null &amp;&amp; canvas.isMapboardActionsEnabled();</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public boolean isShowingSubPanel() {
<span class="nc bnc" id="L958" title="All 4 branches missed.">        return canvas!=null &amp;&amp; canvas.isShowingSubPanel();</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public void paintImmediatelyCanvasIn(Rectangle rectangle) {
<span class="nc" id="L966">        canvas.paintImmediately(rectangle);</span>
<span class="nc" id="L967">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void paintImmediatelyCanvasInItsBounds() {
<span class="nc" id="L974">        canvas.paintImmediately(canvas.getBounds());</span>
<span class="nc" id="L975">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void refreshPlayersTable() {
<span class="nc" id="L982">        canvas.refreshPlayersTable();</span>
<span class="nc" id="L983">    }</span>

    /**
     * {@inheritDoc}
     */
    public void removeFromCanvas(Component component) {
<span class="nc" id="L989">        canvas.remove(component);</span>
<span class="nc" id="L990">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void removeInGameComponents() {
<span class="nc" id="L997">        canvas.removeInGameComponents();</span>
<span class="nc" id="L998">    }</span>

    public void removeTradeRoutePanel(TradeRoutePanel panel) {
<span class="nc" id="L1001">        canvas.removeTradeRoutePanel(panel);</span>
<span class="nc" id="L1002">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void requestFocusForSubPanel() {
<span class="nc" id="L1009">        canvas.getShowingSubPanel().requestFocus();</span>
<span class="nc" id="L1010">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public boolean requestFocusInWindow() {
<span class="nc" id="L1017">        return canvas.requestFocusInWindow();</span>
    }

    public void restoreSavedSize(Component comp, int w, int h) {
<span class="nc" id="L1021">        canvas.restoreSavedSize(comp, new Dimension(w, h));</span>
<span class="nc" id="L1022">    }</span>

    public void restoreSavedSize(Component comp, Dimension size) {
<span class="nc" id="L1025">        canvas.restoreSavedSize(comp, size);</span>
<span class="nc" id="L1026">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void returnToTitle() {
<span class="nc" id="L1033">        canvas.returnToTitle();</span>
<span class="nc" id="L1034">        playSound(&quot;sound.intro.general&quot;);</span>
<span class="nc" id="L1035">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showAboutPanel() {
<span class="nc" id="L1042">        canvas.showAboutPanel();</span>
<span class="nc" id="L1043">    }</span>

    public void showBuildQueuePanel(Colony colony) {
<span class="nc" id="L1046">        canvas.showBuildQueuePanel(colony);</span>
<span class="nc" id="L1047">    }</span>

    public void showBuildQueuePanel(Colony colony, Runnable callBack) {
<span class="nc" id="L1050">        canvas.showBuildQueuePanel(colony, callBack);</span>
<span class="nc" id="L1051">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showCaptureGoodsDialog(final Unit unit, List&lt;Goods&gt; gl,
                                       DialogHandler&lt;List&lt;Goods&gt;&gt; handler) {
<span class="nc" id="L1059">        canvas.showCaptureGoodsDialog(unit, gl, handler);</span>
<span class="nc" id="L1060">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showChatPanel() {
<span class="nc" id="L1067">        canvas.showChatPanel();</span>
<span class="nc" id="L1068">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showChooseFoundingFatherDialog(final List&lt;FoundingFather&gt; ffs,
                DialogHandler&lt;FoundingFather&gt; handler) {
<span class="nc" id="L1076">        canvas.showChooseFoundingFatherDialog(ffs, handler);</span>
<span class="nc" id="L1077">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showClientOptionsDialog() {
<span class="nc" id="L1084">        OptionGroup group = null;</span>
        try {
<span class="nc" id="L1086">            group = canvas.showClientOptionsDialog();</span>
<span class="nc" id="L1087">        } finally {</span>
<span class="nc bnc" id="L1088" title="All 4 branches missed.">            if (group != null) {</span>
<span class="nc" id="L1089">                resetMenuBar();</span>
                // Immediately redraw the minimap if that was updated.
<span class="nc" id="L1091">                updateMapControls();</span>
            }
<span class="nc" id="L1093">        }</span>
<span class="nc bnc" id="L1094" title="All 2 branches missed.">        if (!getFreeColClient().isInGame()) showMainPanel(null);</span>
<span class="nc" id="L1095">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    protected void showForeignColony(Settlement settlement) {
<span class="nc" id="L1102">        canvas.showForeignColony(settlement);</span>
<span class="nc" id="L1103">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showColonyPanel(Colony colony, Unit unit) {
<span class="nc" id="L1110">        canvas.showColonyPanel(colony, unit);</span>
<span class="nc" id="L1111">    }</span>

    public ColonyPanel showColonyPanel2(Colony colony, Unit unit) {
<span class="nc" id="L1114">        return canvas.showColonyPanel(colony, unit);</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public void showColopediaPanel(String nodeId) {
<span class="nc" id="L1122">        canvas.showColopediaPanel(nodeId);</span>
<span class="nc" id="L1123">    }</span>

    public ColorChooserPanel showColorChooserPanel(ActionListener al) {
<span class="nc" id="L1126">        return canvas.showColorChooserPanel(al);</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public void showCompactLabourReport() {
<span class="nc" id="L1134">        canvas.showCompactLabourReport();</span>
<span class="nc" id="L1135">    }</span>

    public void showCompactLabourReport(UnitData unitData) {
<span class="nc" id="L1138">        canvas.showCompactLabourReport(unitData);</span>
<span class="nc" id="L1139">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showDeclarationPanel() {
<span class="nc" id="L1146">        canvas.showDeclarationPanel();</span>
<span class="nc" id="L1147">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public OptionGroup showDifficultyDialog() {
<span class="nc" id="L1154">        final Specification spec = getSpecification();</span>
<span class="nc" id="L1155">        return canvas.showDifficultyDialog(spec,</span>
<span class="nc" id="L1156">            spec.getDifficultyOptionGroup(), false);</span>
    }

    public OptionGroup showDifficultyDialog(Specification spec,
                                            OptionGroup group) {
<span class="nc" id="L1161">        return canvas.showDifficultyDialog(spec, group, group.isEditable());</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public void showDumpCargoDialog(Unit unit,
                                    DialogHandler&lt;List&lt;Goods&gt;&gt; handler) {
<span class="nc" id="L1170">        canvas.showDumpCargoDialog(unit, handler);</span>
<span class="nc" id="L1171">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public boolean showEditOptionDialog(Option option) {
<span class="nc" id="L1178">        return canvas.showEditOptionDialog(option);</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public void showEmigrationDialog(final Player player,
                                     final boolean fountainOfYouth,
                                     DialogHandler&lt;Integer&gt; handler) {
<span class="nc" id="L1188">        canvas.showEmigrationDialog(player, fountainOfYouth, handler);</span>
<span class="nc" id="L1189">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showEndTurnDialog(final List&lt;Unit&gt; units,
                                  DialogHandler&lt;Boolean&gt; handler) {
<span class="nc" id="L1197">        canvas.showEndTurnDialog(units, handler);</span>
<span class="nc" id="L1198">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showErrorMessage(StringTemplate template) {
<span class="nc" id="L1205">        canvas.showErrorMessage(Messages.message(template));</span>
<span class="nc" id="L1206">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showErrorMessage(String messageId) {
<span class="nc" id="L1213">        canvas.showErrorMessage(messageId);</span>
<span class="nc" id="L1214">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showErrorMessage(String messageId, String message) {
<span class="nc" id="L1221">        canvas.showErrorMessage(messageId, message);</span>
<span class="nc" id="L1222">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showEuropePanel() {
<span class="nc" id="L1229">        canvas.showEuropePanel();</span>
<span class="nc" id="L1230">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showEventPanel(String header, String image, String footer) {
<span class="nc" id="L1237">        canvas.showEventPanel(header, image, footer);</span>
<span class="nc" id="L1238">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showFindSettlementPanel() {
<span class="nc" id="L1245">        canvas.showFindSettlementPanel();</span>
<span class="nc" id="L1246">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public OptionGroup showGameOptionsDialog(boolean editable, boolean custom) {
<span class="nc" id="L1253">        return canvas.showGameOptionsDialog(editable, custom);</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public void showHighScoresPanel(String messageId, List&lt;HighScore&gt; scores) {
<span class="nc" id="L1261">        canvas.showHighScoresPanel(messageId, scores);</span>
<span class="nc" id="L1262">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showIndianSettlementPanel(IndianSettlement indianSettlement) {
<span class="nc" id="L1269">        canvas.showIndianSettlementPanel(indianSettlement);</span>
<span class="nc" id="L1270">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showInformationMessage(String messageId) {
<span class="nc" id="L1277">        super.showInformationMessage(messageId);</span>
<span class="nc" id="L1278">        canvas.showInformationMessage(null, null, null,</span>
<span class="nc" id="L1279">                                      StringTemplate.key(messageId));</span>
<span class="nc" id="L1280">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showInformationMessage(StringTemplate template) {
<span class="nc" id="L1287">        super.showInformationMessage(template);</span>
<span class="nc" id="L1288">        canvas.showInformationMessage(null, null, null, template);</span>
<span class="nc" id="L1289">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showInformationMessage(Settlement displayObject,
                                       StringTemplate template) {
<span class="nc" id="L1297">        super.showInformationMessage(displayObject, template);</span>
<span class="nc" id="L1298">        ImageIcon icon = null;</span>
<span class="nc" id="L1299">        Tile tile = null;</span>
<span class="nc bnc" id="L1300" title="All 2 branches missed.">        if(displayObject != null) {</span>
<span class="nc" id="L1301">            icon = new ImageIcon(imageLibrary.getSettlementImage(displayObject));</span>
<span class="nc" id="L1302">            tile = displayObject.getTile();</span>
        }
<span class="nc" id="L1304">        canvas.showInformationMessage(displayObject, tile, icon, template);</span>
<span class="nc" id="L1305">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showInformationMessage(Unit displayObject,
                                       StringTemplate template) {
<span class="nc" id="L1313">        super.showInformationMessage(displayObject, template);</span>
<span class="nc" id="L1314">        ImageIcon icon = null;</span>
<span class="nc" id="L1315">        Tile tile = null;</span>
<span class="nc bnc" id="L1316" title="All 2 branches missed.">        if(displayObject != null) {</span>
<span class="nc" id="L1317">            icon = new ImageIcon(imageLibrary.getUnitImage(displayObject));</span>
<span class="nc" id="L1318">            tile = displayObject.getTile();</span>
        }
<span class="nc" id="L1320">        canvas.showInformationMessage(displayObject, tile, icon, template);</span>
<span class="nc" id="L1321">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showInformationMessage(Tile displayObject,
                                       StringTemplate template) {
<span class="nc" id="L1329">        super.showInformationMessage(displayObject, template);</span>
<span class="nc" id="L1330">        canvas.showInformationMessage(displayObject, displayObject, null, template);</span>
<span class="nc" id="L1331">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showInformationMessage(FreeColObject displayObject,
                                       String messageId) {
<span class="nc" id="L1339">        super.showInformationMessage(displayObject, messageId);</span>
<span class="nc" id="L1340">        canvas.showInformationMessage(displayObject, StringTemplate.key(messageId));</span>
<span class="nc" id="L1341">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showInformationMessage(FreeColObject displayObject,
                                       StringTemplate template) {
<span class="nc" id="L1349">        super.showInformationMessage(displayObject, template);</span>
<span class="nc" id="L1350">        canvas.showInformationMessage(displayObject, template);</span>
<span class="nc" id="L1351">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public File showLoadDialog(File directory) {
<span class="nc" id="L1358">        return canvas.showLoadDialog(directory, null);</span>
    }

    public File showLoadDialog(File directory, FileFilter[] fileFilters) {
<span class="nc" id="L1362">        return canvas.showLoadDialog(directory, fileFilters);</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public boolean showLoadingSavegameDialog(boolean publicServer,
                                             boolean singlePlayer) {
<span class="nc" id="L1371">        return canvas.showLoadingSavegameDialog(publicServer, singlePlayer);</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public void showLogFilePanel() {
<span class="nc" id="L1379">        canvas.showLogFilePanel();</span>
<span class="nc" id="L1380">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showMainPanel(String userMsg) {
<span class="nc" id="L1387">        canvas.showMainPanel(userMsg);</span>
<span class="nc" id="L1388">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public OptionGroup showMapGeneratorOptionsDialog(boolean editable) {
<span class="nc" id="L1395">        return canvas.showMapGeneratorOptionsDialog(editable);</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public Dimension showMapSizeDialog() {
<span class="nc" id="L1403">        return canvas.showMapSizeDialog();</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public void showModelMessages(List&lt;ModelMessage&gt; modelMessages) {
<span class="nc" id="L1411">        canvas.showModelMessages(modelMessages);</span>
<span class="nc" id="L1412">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showMonarchDialog(final MonarchAction action,
                                  StringTemplate template, String monarchKey,
                                  DialogHandler&lt;Boolean&gt; handler) {
<span class="nc" id="L1421">        canvas.showMonarchDialog(action, template, monarchKey, handler);</span>
<span class="nc" id="L1422">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showNamingDialog(StringTemplate template,
                                      final String defaultName,
                                      final Unit unit,
                                      DialogHandler&lt;String&gt; handler) {
<span class="nc" id="L1432">        canvas.showNamingDialog(template, defaultName, unit, handler);</span>
<span class="nc" id="L1433">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showFirstContactDialog(final Player player, final Player other,
                                       final Tile tile, int settlementCount,
                                       DialogHandler&lt;Boolean&gt; handler) {
<span class="nc" id="L1442">        canvas.showFirstContactDialog(player, other, tile, settlementCount,</span>
<span class="nc" id="L1443">                                      handler);</span>
<span class="nc" id="L1444">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public DiplomaticTrade showNegotiationDialog(FreeColGameObject our,
                                                     FreeColGameObject other,
                                                     DiplomaticTrade agreement,
                                                     StringTemplate comment) {
<span class="nc" id="L1454">        return canvas.showNegotiationDialog(our, other, agreement, comment);</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public void showNewPanel() {
<span class="nc" id="L1462">        canvas.showNewPanel(null);</span>
<span class="nc" id="L1463">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showNewPanel(Specification specification) {
<span class="nc" id="L1470">        canvas.showNewPanel(specification);</span>
<span class="nc" id="L1471">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showSpyColonyPanel(final Tile tile) {
<span class="nc" id="L1478">        canvas.showSpyColonyPanel(tile);</span>
<span class="nc" id="L1479">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public Parameters showParametersDialog() {
<span class="nc" id="L1486">        return canvas.showParametersDialog();</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public boolean showPreCombatDialog(Unit attacker,
                                       FreeColGameObject defender, Tile tile) {
<span class="nc" id="L1495">        return canvas.showPreCombatDialog(attacker, defender, tile);</span>
    }

    public void showPurchasePanel() {
<span class="nc" id="L1499">        canvas.showPurchasePanel();</span>
<span class="nc" id="L1500">    }</span>

    public void showRecruitPanel() {
<span class="nc" id="L1503">        canvas.showRecruitPanel();</span>
<span class="nc" id="L1504">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showReportCargoPanel() {
<span class="nc" id="L1511">        canvas.showReportCargoPanel();</span>
<span class="nc" id="L1512">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showReportColonyPanel() {
<span class="nc" id="L1519">        canvas.showReportColonyPanel();</span>
<span class="nc" id="L1520">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showReportContinentalCongressPanel() {
<span class="nc" id="L1527">        canvas.showReportContinentalCongressPanel();</span>
<span class="nc" id="L1528">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showReportEducationPanel() {
<span class="nc" id="L1535">        canvas.showReportEducationPanel();</span>
<span class="nc" id="L1536">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showReportExplorationPanel() {
<span class="nc" id="L1543">        canvas.showReportExplorationPanel();</span>
<span class="nc" id="L1544">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showReportForeignAffairPanel() {
<span class="nc" id="L1551">        canvas.showReportForeignAffairPanel();</span>
<span class="nc" id="L1552">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showReportHistoryPanel() {
<span class="nc" id="L1559">        canvas.showReportHistoryPanel();</span>
<span class="nc" id="L1560">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showReportIndianPanel() {
<span class="nc" id="L1567">        canvas.showReportIndianPanel();</span>
<span class="nc" id="L1568">    }</span>

    public void showReportLabourDetailPanel(UnitType unitType,
            Map&lt;UnitType, Map&lt;Location, Integer&gt;&gt; data,
            TypeCountMap&lt;UnitType&gt; unitCount, List&lt;Colony&gt; colonies) {
<span class="nc" id="L1573">        canvas.showReportLabourDetailPanel(unitType, data, unitCount,</span>
<span class="nc" id="L1574">                                           colonies);</span>
<span class="nc" id="L1575">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showReportLabourPanel() {
<span class="nc" id="L1582">        canvas.showReportLabourPanel();</span>
<span class="nc" id="L1583">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showReportMilitaryPanel() {
<span class="nc" id="L1590">        canvas.showReportMilitaryPanel();</span>
<span class="nc" id="L1591">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showReportNavalPanel() {
<span class="nc" id="L1598">        canvas.showReportNavalPanel();</span>
<span class="nc" id="L1599">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showReportProductionPanel() {
<span class="nc" id="L1606">        canvas.showReportProductionPanel();</span>
<span class="nc" id="L1607">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showReportReligiousPanel() {
<span class="nc" id="L1614">        canvas.showReportReligiousPanel();</span>
<span class="nc" id="L1615">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showReportRequirementsPanel() {
<span class="nc" id="L1622">        canvas.showReportRequirementsPanel();</span>
<span class="nc" id="L1623">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showReportTradePanel() {
<span class="nc" id="L1630">        canvas.showReportTradePanel();</span>
<span class="nc" id="L1631">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showReportTurnPanel(List&lt;ModelMessage&gt; messages) {
<span class="nc" id="L1638">        canvas.showReportTurnPanel(messages);</span>
<span class="nc" id="L1639">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public File showSaveDialog(File directory, String defaultName) {
<span class="nc" id="L1646">        return canvas.showSaveDialog(directory, null, defaultName);</span>
    }

    public File showSaveDialog(File directory, FileFilter[] fileFilters,
                               String defaultName) {
<span class="nc" id="L1651">        return canvas.showSaveDialog(directory, fileFilters, defaultName);</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public Dimension showScaleMapSizeDialog() {
<span class="nc" id="L1659">        return canvas.showScaleMapSizeDialog();</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public int showSelectAmountDialog(GoodsType goodsType, int available,
                                      int defaultAmount, boolean needToPay) {
<span class="nc" id="L1668">        return canvas.showSelectAmountDialog(goodsType, available,</span>
<span class="nc" id="L1669">                                             defaultAmount, needToPay);</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public int showSelectTributeAmountDialog(StringTemplate question,
                                             int maximum) {
<span class="nc" id="L1678">        return canvas.showSelectTributeAmountDialog(question, maximum);</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public Location showSelectDestinationDialog(Unit unit) {
<span class="nc" id="L1686">        return canvas.showSelectDestinationDialog(unit);</span>
    }

    public void showServerListPanel(List&lt;ServerInfo&gt; serverList) {
<span class="nc" id="L1690">        canvas.showServerListPanel(serverList);</span>
<span class="nc" id="L1691">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showStartGamePanel(Game game, Player player,
                                   boolean singlePlayerMode) {
<span class="nc" id="L1699">        canvas.showStartGamePanel(game, player, singlePlayerMode);</span>
<span class="nc" id="L1700">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showStatisticsPanel(Map&lt;String, String&gt; serverStats,
                                    Map&lt;String, String&gt; clientStats) {
<span class="nc" id="L1708">        canvas.showStatisticsPanel(serverStats, clientStats);</span>
<span class="nc" id="L1709">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showStatusPanel(String message) {
<span class="nc" id="L1716">        canvas.showStatusPanel(message);</span>
<span class="nc" id="L1717">    }</span>

    public void showTilePanel(Tile tile) {
<span class="nc" id="L1720">        canvas.showTilePanel(tile);</span>
<span class="nc" id="L1721">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showTilePopUpAtSelectedTile() {
<span class="nc" id="L1728">        Tile tile = mapViewer.getSelectedTile();</span>
<span class="nc" id="L1729">        Point point = mapViewer.calculateTilePosition(tile);</span>
<span class="nc" id="L1730">        canvas.showTilePopup(tile, point.x+mapViewer.getTileWidth(), point.y);</span>
<span class="nc" id="L1731">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showTradeRoutePanel(Unit unit) {
<span class="nc" id="L1738">        canvas.showTradeRoutePanel(unit);</span>
<span class="nc" id="L1739">    }</span>

    public void showTradeRouteInputPanel(TradeRoute newRoute,
                                         Runnable callBack) {
<span class="nc" id="L1743">        canvas.showTradeRouteInputPanel(newRoute, callBack);</span>
<span class="nc" id="L1744">    }</span>

    public void showTrainPanel() {
<span class="nc" id="L1747">        canvas.showTrainPanel();</span>
<span class="nc" id="L1748">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void showVictoryDialog(DialogHandler&lt;Boolean&gt; handler) {
<span class="nc" id="L1755">        canvas.showVictoryDialog(handler);</span>
<span class="nc" id="L1756">    }</span>

    public boolean showWarehouseDialog(Colony colony) {
<span class="nc" id="L1759">        return canvas.showWarehouseDialog(colony);</span>
    }

    public void showWorkProductionPanel(Unit unit) {
<span class="nc" id="L1763">        canvas.showWorkProductionPanel(unit);</span>
<span class="nc" id="L1764">    }</span>

    public void updateEuropeanSubpanels() {
<span class="nc" id="L1767">        canvas.updateEuropeanSubpanels();</span>
<span class="nc" id="L1768">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void updateGameOptions() {
<span class="nc" id="L1775">        canvas.updateGameOptions();</span>
<span class="nc" id="L1776">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void updateMapGeneratorOptions() {
<span class="nc" id="L1783">        canvas.updateMapGeneratorOptions();</span>
<span class="nc" id="L1784">    }</span>

    // Trivial delegations to MapViewer

    /**
     * {@inheritDoc}
     */
    @Override
    public void centerActiveUnit() {
<span class="nc" id="L1793">        mapViewer.centerActiveUnit();</span>
<span class="nc" id="L1794">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void changeViewMode(int newViewMode) {
<span class="nc" id="L1801">        mapViewer.changeViewMode(newViewMode);</span>
<span class="nc" id="L1802">    }</span>

    public Point calculateUnitLabelPositionInTile(int labelWidth,int labelHeight,
                                                  Point tileP) {
<span class="nc" id="L1806">        return mapViewer.calculateUnitLabelPositionInTile(</span>
<span class="nc" id="L1807">            labelWidth, labelHeight, tileP);</span>
    }

    public void executeWithUnitOutForAnimation(final Unit unit,
                                               final Tile sourceTile,
                                               final OutForAnimationCallback r) {
<span class="nc" id="L1813">        mapViewer.executeWithUnitOutForAnimation(unit, sourceTile, r);</span>
<span class="nc" id="L1814">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public Unit getActiveUnit() {
<span class="nc bnc" id="L1821" title="All 2 branches missed.">        return mapViewer==null ? null : mapViewer.getActiveUnit();</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public Tile getFocus() {
<span class="nc" id="L1829">        return mapViewer.getFocus();</span>
    }

    public float getMapScale() {
<span class="nc" id="L1833">        return mapViewer.getImageLibrary().getScaleFactor();</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public Tile getSelectedTile() {
<span class="nc" id="L1841">        return mapViewer.getSelectedTile();</span>
    }

    public Rectangle getTileBounds(Tile tile) {
<span class="nc" id="L1845">        return mapViewer.calculateTileBounds(tile);</span>
    }

    public Point getTilePosition(Tile tile) {
<span class="nc" id="L1849">        return mapViewer.calculateTilePosition(tile);</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public int getViewMode() {
<span class="nc" id="L1857">        return mapViewer.getViewMode();</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public void setFocus(Tile tileToFocus) {
<span class="nc" id="L1865">        mapViewer.setFocus(tileToFocus);</span>
<span class="nc" id="L1866">        canvas.refresh();</span>
<span class="nc" id="L1867">    }</span>

    public void setFocusImmediately(Tile tileToFocus) {
<span class="nc" id="L1870">        mapViewer.setFocus(tileToFocus);</span>
<span class="nc" id="L1871">        Dimension size = canvas.getSize();</span>
<span class="nc" id="L1872">        canvas.paintImmediately(0, 0, size.width, size.height);</span>
<span class="nc" id="L1873">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public boolean setSelectedTile(Tile newTileToSelect) {
<span class="nc" id="L1880">        boolean result = mapViewer.setSelectedTile(newTileToSelect);</span>
<span class="nc" id="L1881">        updateMapControls();</span>
<span class="nc" id="L1882">        updateMenuBar();</span>
<span class="nc" id="L1883">        return result;</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public void toggleViewMode() {
<span class="nc" id="L1891">        mapViewer.toggleViewMode();</span>
<span class="nc" id="L1892">    }</span>

    // Forwarding to tileViewer

    public static BufferedImage createTileImageWithOverlayAndForest(
            TileType type, Dimension size) {
<span class="nc" id="L1898">        return TileViewer.createTileImageWithOverlayAndForest(type, size);</span>
    }

    public BufferedImage createTileImageWithBeachBorderAndItems(Tile tile) {
<span class="nc" id="L1902">        return tileViewer.createTileImageWithBeachBorderAndItems(tile);</span>
    }

    public BufferedImage createTileImage(Tile tile) {
<span class="nc" id="L1906">        return tileViewer.createTileImage(tile);</span>
    }

    public BufferedImage createColonyTileImage(Tile tile, Colony colony) {
<span class="nc" id="L1910">        return tileViewer.createColonyTileImage(tile, colony);</span>
    }

    public void displayColonyTiles(Graphics2D g, Tile[][] tiles, Colony colony) {
<span class="nc" id="L1914">        tileViewer.displayColonyTiles(g, tiles, colony);</span>
<span class="nc" id="L1915">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span>net.sf.freecol.tools (2) (May 15, 2016 11:18:55 PM)</div></body></html>