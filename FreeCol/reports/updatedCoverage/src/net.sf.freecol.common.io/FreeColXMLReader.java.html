<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>FreeColXMLReader.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">net.sf.freecol.tools (2) (May 15, 2016 11:18:55 PM)</a> &gt; <a href="../../index.html" class="el_group">FreeCol</a> &gt; <a href="../index.html" class="el_bundle">src</a> &gt; <a href="index.source.html" class="el_package">net.sf.freecol.common.io</a> &gt; <span class="el_source">FreeColXMLReader.java</span></div><h1>FreeColXMLReader.java</h1><pre class="source lang-java linenums"><span class="nc" id="L1">/**</span>
 *  Copyright (C) 2002-2016   The FreeCol Team
 *
 *  This file is part of FreeCol.
 *
 *  FreeCol is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  FreeCol is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with FreeCol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package net.sf.freecol.common.io;

import java.io.BufferedInputStream;
import java.io.Closeable;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.Reader;
import java.lang.reflect.Constructor;
import java.lang.reflect.InvocationTargetException;
import java.util.ArrayList;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.logging.Level;
import java.util.logging.Logger;

import javax.xml.stream.events.XMLEvent;
import javax.xml.stream.XMLInputFactory;
import javax.xml.stream.XMLStreamConstants;
import javax.xml.stream.XMLStreamException;
import javax.xml.stream.util.StreamReaderDelegate;

import net.sf.freecol.common.model.FreeColObject;
import net.sf.freecol.common.model.FreeColGameObject;
import net.sf.freecol.common.model.FreeColSpecObjectType;
import net.sf.freecol.common.model.Game;
import net.sf.freecol.common.model.Location;
import net.sf.freecol.common.model.Role;
import net.sf.freecol.common.model.Specification;
import net.sf.freecol.server.ai.AIObject;
import net.sf.freecol.server.ai.AIMain;


/**
 * A wrapper for &lt;code&gt;XMLStreamReader&lt;/code&gt; and potentially an
 * underlying stream.  Adds on many useful utilities for reading
 * XML and FreeCol values.
 */
public class FreeColXMLReader extends StreamReaderDelegate
    implements Closeable {

<span class="fc" id="L65">    private static final Logger logger = Logger.getLogger(FreeColXMLReader.class.getName());</span>

<span class="fc" id="L67">    public static enum ReadScope {</span>
<span class="fc" id="L68">        SERVER,     // Loading the game in the server</span>
<span class="fc" id="L69">        NORMAL,     // Normal interning read</span>
<span class="fc" id="L70">        NOINTERN,   // Do not intern any object that are read</span>
    }

    /** The stream to read from. */
<span class="pc" id="L74">    private InputStream inputStream = null;</span>

    /** The read scope to apply. */
    private ReadScope readScope;

    /** A cache of uninterned objects. */
<span class="pc" id="L80">    private Map&lt;String, FreeColObject&gt; uninterned = null;</span>


    /**
     * Creates a new &lt;code&gt;FreeColXMLReader&lt;/code&gt;.
     *
     * @param bis The &lt;code&gt;BufferedInputStream&lt;/code&gt; to create
     *     an &lt;code&gt;FreeColXMLReader&lt;/code&gt; for.
     * @exception IOException if thrown while creating the
     *     &lt;code&gt;XMLStreamReader&lt;/code&gt;.
     */
    public FreeColXMLReader(BufferedInputStream bis) throws IOException {
<span class="fc" id="L92">        super();</span>

        try {
<span class="fc" id="L95">            XMLInputFactory xif = XMLInputFactory.newInstance();</span>
<span class="fc" id="L96">            setParent(xif.createXMLStreamReader(bis, &quot;UTF-8&quot;));</span>
<span class="pc" id="L97">        } catch (XMLStreamException e) {</span>
<span class="nc" id="L98">            throw new IOException(e);</span>
        }
<span class="fc" id="L100">        this.inputStream = bis;</span>
<span class="fc" id="L101">        this.readScope = ReadScope.NORMAL;</span>
<span class="fc" id="L102">    }</span>

    /**
     * Creates a new &lt;code&gt;FreeColXMLReader&lt;/code&gt;.
     *
     * @param inputStream The &lt;code&gt;InputStream&lt;/code&gt; to create
     *     an &lt;code&gt;FreeColXMLReader&lt;/code&gt; for.
     * @exception IOException if thrown while creating the
     *     &lt;code&gt;XMLStreamReader&lt;/code&gt;.
     */
    public FreeColXMLReader(InputStream inputStream) throws IOException {
<span class="fc" id="L113">        this(new BufferedInputStream(inputStream));</span>
<span class="fc" id="L114">    }</span>

    /**
     * Creates a new &lt;code&gt;FreeColXMLReader&lt;/code&gt;.
     *
     * @param file The &lt;code&gt;File&lt;/code&gt; to create
     *     an &lt;code&gt;FreeColXMLReader&lt;/code&gt; for.
     * @exception IOException if thrown while creating the
     *     &lt;code&gt;XMLStreamReader&lt;/code&gt;.
     */
    public FreeColXMLReader(File file) throws IOException {
<span class="nc" id="L125">        this(new FileInputStream(file));</span>
<span class="nc" id="L126">    }</span>
    
    
    /**
     * Creates a new &lt;code&gt;FreeColXMLReader&lt;/code&gt;.
     *
     * @param reader A &lt;code&gt;Reader&lt;/code&gt; to create
     *     an &lt;code&gt;FreeColXMLReader&lt;/code&gt; for.
     * @exception IOException if thrown while creating the
     *     &lt;code&gt;FreeColXMLReader&lt;/code&gt;.
     */
    public FreeColXMLReader(Reader reader) throws IOException {
<span class="nc" id="L138">        super();</span>

        try {
<span class="nc" id="L141">            XMLInputFactory xif = XMLInputFactory.newInstance();</span>
<span class="nc" id="L142">            setParent(xif.createXMLStreamReader(reader));</span>
<span class="nc" id="L143">        } catch (XMLStreamException e) {</span>
<span class="nc" id="L144">            throw new IOException(e);</span>
        }
<span class="nc" id="L146">        this.inputStream = null;</span>
<span class="nc" id="L147">        this.readScope = ReadScope.NORMAL;</span>
<span class="nc" id="L148">    }</span>


    /**
     * Should reads from this stream intern their objects into the
     * enclosing game?
     *
     * @return True if this is an interning stream.
     */
    public boolean shouldIntern() {
<span class="nc bnc" id="L158" title="All 2 branches missed.">        return this.readScope != ReadScope.NOINTERN;</span>
    }

    /**
     * Get the read scope.
     *
     * @return The &lt;code&gt;ReadScope&lt;/code&gt;.
     */
    public ReadScope getReadScope() {
<span class="nc" id="L167">        return this.readScope;</span>
    }

    /**
     * Set the read scope.
     *
     * @param readScope The new &lt;code&gt;ReadScope&lt;/code&gt;.
     * @return This reader.
     */
    public FreeColXMLReader setReadScope(ReadScope readScope) {
<span class="nc" id="L177">        this.readScope = readScope;</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">        this.uninterned = (shouldIntern()) ? null</span>
<span class="nc" id="L179">            : new HashMap&lt;String, FreeColObject&gt;();</span>
<span class="nc" id="L180">        return this;</span>
    }

    /**
     * Look up an identifier in an enclosing game.  If not interning
     * prefer an non-interned result.
     *
     * @param game The &lt;code&gt;Game&lt;/code&gt; to consult.
     * @param id The object identifier.
     * @return The &lt;code&gt;FreeColObject&lt;/code&gt; found, or null if none.
     */
    private FreeColObject lookup(Game game, String id) {
<span class="nc bnc" id="L192" title="All 2 branches missed.">        FreeColObject fco = (shouldIntern()) ? null : uninterned.get(id);</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">        return (fco != null) ? fco</span>
<span class="nc" id="L194">            : game.getFreeColGameObject(id);</span>
    }

    /**
     * Closes both the &lt;code&gt;XMLStreamReader&lt;/code&gt; and
     * the underlying stream if any.
     *
     * Implements interface Closeable.
     */
    @Override
    public void close() {
        try {
<span class="fc" id="L206">            super.close();</span>
<span class="pc" id="L207">        } catch (XMLStreamException xse) {</span>
<span class="nc" id="L208">            logger.log(Level.WARNING, &quot;Error closing stream.&quot;, xse);</span>
        }

<span class="pc bpc" id="L211" title="1 of 2 branches missed.">        if (inputStream != null) {</span>
            try {
<span class="fc" id="L213">                inputStream.close();</span>
<span class="pc" id="L214">            } catch (IOException ioe) {</span>
<span class="nc" id="L215">                logger.log(Level.WARNING, &quot;Error closing stream.&quot;, ioe);</span>
            }
<span class="fc" id="L217">            inputStream = null;</span>
        }
<span class="fc" id="L219">    }</span>

    // @compat 0.10.x
    /**
     * Reads the identifier attribute.
     *
     * Normally a simple getAttribute() would be sufficient, but
     * while we are allowing both the obsolete ID_ATTRIBUTE and the correct
     * ID_ATTRIBUTE_TAG, this routine is useful.
     *
     * When 0.10.x is obsolete, remove this routine and replace its
     * uses with just getAttribute(in, ID_ATTRIBUTE_TAG, (String)null)
     * or equivalent.
     *
     * @return The identifier found, or null if none present.
     */
    public String readId() {
<span class="fc" id="L236">        String id = getAttribute(FreeColObject.ID_ATTRIBUTE_TAG, (String)null);</span>
<span class="fc bfc" id="L237" title="All 2 branches covered.">        if (id == null) {</span>
<span class="fc" id="L238">            id = getAttribute(FreeColObject.ID_ATTRIBUTE, (String)null);</span>
        }
<span class="fc" id="L240">        return id;</span>
    }
    // end @compat 0.10.x

    /**
     * Is the stream at the given tag?
     *
     * @param tag The tag to test.
     * @return True if at the given tag.
     */
    public boolean atTag(String tag) {
<span class="nc" id="L251">        return getLocalName().equals(tag);</span>
    }

    /**
     * Expect a particular tag.
     *
     * @param tag The expected tag name.
     * @exception XMLStreamException if the expected tag is not found.
     */
    public void expectTag(String tag) throws XMLStreamException {
<span class="fc" id="L261">        final String endTag = getLocalName();</span>
<span class="pc bpc" id="L262" title="1 of 2 branches missed.">        if (!endTag.equals(tag)) {</span>
<span class="nc" id="L263">            throw new XMLStreamException(&quot;Parse error, &quot; + tag</span>
<span class="nc" id="L264">                + &quot; expected, not: &quot; + endTag);</span>
        }
<span class="fc" id="L266">    }</span>

    /**
     * Close the current tag, checking that it did indeed close correctly.
     *
     * @param tag The expected tag name.
     * @exception XMLStreamException if a closing tag is not found.
     */
    public void closeTag(String tag) throws XMLStreamException {
<span class="pc bpc" id="L275" title="1 of 2 branches missed.">        if (nextTag() != XMLStreamConstants.END_ELEMENT) {</span>
<span class="nc" id="L276">            throw new XMLStreamException(&quot;Parse error, END_ELEMENT expected,&quot;</span>
<span class="nc" id="L277">                + &quot; not: &quot; + getLocalName());</span>
        }
<span class="fc" id="L279">        expectTag(tag);</span>
<span class="fc" id="L280">    }</span>

    /**
     * Extract the current tag and its attributes from an input stream.
     * Useful for error messages.
     *
     * @return A simple display of the stream state.
     */
    public String currentTag() {
<span class="nc" id="L289">        StringBuilder sb = new StringBuilder(getLocalName());</span>
<span class="nc" id="L290">        sb.append(&quot;, attributes:&quot;);</span>
<span class="nc" id="L291">        int n = getAttributeCount();</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">        for (int i = 0; i &lt; n; i++) {</span>
<span class="nc" id="L293">            sb.append(&quot; &quot;).append(getAttributeLocalName(i))</span>
<span class="nc" id="L294">                .append(&quot;=\&quot;&quot;).append(getAttributeValue(i)).append(&quot;\&quot;&quot;);</span>
        }
<span class="nc" id="L296">        return sb.toString();</span>
    }

    /**
     * Is there an attribute present in the stream?
     *
     * @param attributeName An attribute name
     * @return True if the attribute is present.
     */
    public boolean hasAttribute(String attributeName) {
<span class="fc bfc" id="L306" title="All 2 branches covered.">        return getParent().getAttributeValue(null, attributeName) != null;</span>
    }

    /**
     * Gets a boolean from an attribute in a stream.
     *
     * @param attributeName The attribute name.
     * @param defaultValue The default value.
     * @return The boolean attribute value, or the default value if none found.
     */
    public boolean getAttribute(String attributeName, boolean defaultValue) {
<span class="fc" id="L317">        final String attrib = getParent().getAttributeValue(null,</span>
<span class="fc" id="L318">                                                            attributeName);</span>
<span class="fc bfc" id="L319" title="All 2 branches covered.">        return (attrib == null) ? defaultValue</span>
<span class="fc" id="L320">            : Boolean.parseBoolean(attrib);</span>
    }

    /**
     * Gets a float from an attribute in a stream.
     *
     * @param attributeName The attribute name.
     * @param defaultValue The default value.
     * @return The float attribute value, or the default value if none found.
     */
    public float getAttribute(String attributeName, float defaultValue) {
<span class="fc" id="L331">        final String attrib = getParent().getAttributeValue(null,</span>
<span class="fc" id="L332">                                                            attributeName);</span>
<span class="fc" id="L333">        float result = defaultValue;</span>
<span class="fc bfc" id="L334" title="All 2 branches covered.">        if (attrib != null) {</span>
            try {
<span class="fc" id="L336">                result = Float.parseFloat(attrib);</span>
<span class="pc" id="L337">            } catch (NumberFormatException e) {</span>
<span class="nc" id="L338">                logger.warning(attributeName + &quot; is not a float: &quot; + attrib);</span>
            }
        }
<span class="fc" id="L341">        return result;</span>
    }

    /**
     * Gets an int from an attribute in a stream.
     *
     * @param attributeName The attribute name.
     * @param defaultValue The default value.
     * @return The int attribute value, or the default value if none found.
     */
    public int getAttribute(String attributeName, int defaultValue) {
<span class="fc" id="L352">        final String attrib = getParent().getAttributeValue(null,</span>
<span class="fc" id="L353">                                                            attributeName);</span>
<span class="fc" id="L354">        int result = defaultValue;</span>
<span class="fc bfc" id="L355" title="All 2 branches covered.">        if (attrib != null) {</span>
            try {
<span class="fc" id="L357">                result = Integer.decode(attrib);</span>
<span class="pc" id="L358">            } catch (NumberFormatException e) {</span>
<span class="nc" id="L359">                logger.warning(attributeName + &quot; is not an integer: &quot; + attrib);</span>
            }
        }
<span class="fc" id="L362">        return result;</span>
    }

    /**
     * Gets a long from an attribute in a stream.
     *
     * @param attributeName The attribute name.
     * @param defaultValue The default value.
     * @return The long attribute value, or the default value if none found.
     */
    public long getAttribute(String attributeName, long defaultValue) {
<span class="nc" id="L373">        final String attrib = getParent().getAttributeValue(null,</span>
<span class="nc" id="L374">                                                            attributeName);</span>
<span class="nc" id="L375">        long result = defaultValue;</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">        if (attrib != null) {</span>
            try {
<span class="nc" id="L378">                result = Long.decode(attrib);</span>
<span class="nc" id="L379">            } catch (NumberFormatException e) {</span>
<span class="nc" id="L380">                logger.warning(attributeName + &quot; is not a long: &quot; + attrib);</span>
            }
        }
<span class="nc" id="L383">        return result;</span>
    }

    /**
     * Gets a string from an attribute in a stream.
     *
     * @param attributeName The attribute name.
     * @param defaultValue The default value.
     * @return The string attribute value, or the default value if none found.
     */
    public String getAttribute(String attributeName, String defaultValue) {
<span class="fc" id="L394">        final String attrib = getParent().getAttributeValue(null,</span>
<span class="fc" id="L395">                                                            attributeName);</span>
<span class="fc bfc" id="L396" title="All 2 branches covered.">        return (attrib == null) ? defaultValue</span>
<span class="fc" id="L397">            : attrib;</span>
    }

    /**
     * Gets an enum from an attribute in a stream.
     *
     * @param &lt;T&gt; The expected enum type.
     * @param attributeName The attribute name.
     * @param returnClass The class of the return value.
     * @param defaultValue The default value.
     * @return The enum attribute value, or the default value if none found.
     */
    public &lt;T extends Enum&lt;T&gt;&gt; T getAttribute(String attributeName,
                                              Class&lt;T&gt; returnClass,
                                              T defaultValue) {
<span class="fc" id="L412">        final String attrib = getParent().getAttributeValue(null,</span>
<span class="fc" id="L413">                                                            attributeName);</span>
<span class="fc" id="L414">        T result = defaultValue;</span>
<span class="fc bfc" id="L415" title="All 2 branches covered.">        if (attrib != null) {</span>
            try {
<span class="fc" id="L417">                result = Enum.valueOf(returnClass,</span>
<span class="fc" id="L418">                                      attrib.toUpperCase(Locale.US));</span>
<span class="pc" id="L419">            } catch (Exception e) {</span>
<span class="nc" id="L420">                logger.warning(attributeName + &quot; is not a &quot;</span>
<span class="nc" id="L421">                    + defaultValue.getClass().getName() + &quot;: &quot; + attrib);</span>
            }
        }
<span class="fc" id="L424">        return result;</span>
    }

    /**
     * Gets a FreeCol object from an attribute in a stream.
     *
     * @param &lt;T&gt; The expected attribute type.
     * @param game The &lt;code&gt;Game&lt;/code&gt; to look in.
     * @param attributeName The attribute name.
     * @param returnClass The &lt;code&gt;FreeColObject&lt;/code&gt; type to expect.
     * @param defaultValue The default value.
     * @return The &lt;code&gt;FreeColObject&lt;/code&gt; found, or the default
     *     value if not.
     * @exception XMLStreamException if the wrong class was passed.
     */
    public &lt;T extends FreeColObject&gt; T getAttribute(Game game,
        String attributeName, Class&lt;T&gt; returnClass,
        T defaultValue) throws XMLStreamException {

<span class="nc" id="L443">        final String attrib =</span>
        // @compat 0.10.7
<span class="nc bnc" id="L445" title="All 2 branches missed.">            (FreeColObject.ID_ATTRIBUTE_TAG.equals(attributeName)) ? readId() :</span>
        // end @compat
<span class="nc" id="L447">            getAttribute(attributeName, (String)null);</span>

<span class="nc bnc" id="L449" title="All 2 branches missed.">        if (attrib == null) return defaultValue;</span>
<span class="nc" id="L450">        FreeColObject fco = lookup(game, attrib);</span>
        try {
<span class="nc" id="L452">            return returnClass.cast(fco);</span>
<span class="nc" id="L453">        } catch (ClassCastException cce) {</span>
<span class="nc" id="L454">            throw new XMLStreamException(cce);</span>
        }
    }

    /**
     * Get a FreeCol AI object from an attribute in a stream.
     *
     * @param &lt;T&gt; The expected attribute type.
     * @param aiMain The &lt;code&gt;AIMain&lt;/code&gt; that contains the object.
     * @param attributeName The attribute name.
     * @param returnClass The &lt;code&gt;AIObject&lt;/code&gt; type to expect.
     * @param defaultValue The default value.
     * @return The &lt;code&gt;AIObject&lt;/code&gt; found, or the default value if not.
     */
    public &lt;T extends AIObject&gt; T getAttribute(AIMain aiMain,
        String attributeName, Class&lt;T&gt; returnClass, T defaultValue) {
<span class="nc" id="L470">        final String attrib =</span>
        // @compat 0.10.7
<span class="nc bnc" id="L472" title="All 2 branches missed.">            (FreeColObject.ID_ATTRIBUTE_TAG.equals(attributeName)) ? readId() :</span>
        // end @compat
<span class="nc" id="L474">            getAttribute(attributeName, (String)null);</span>

<span class="nc bnc" id="L476" title="All 2 branches missed.">        return (attrib == null) ? defaultValue</span>
<span class="nc" id="L477">            : aiMain.getAIObject(attrib, returnClass);</span>
    }

    /**
     * Find a new location from a stream attribute.  This is necessary
     * because &lt;code&gt;Location&lt;/code&gt; is an interface.
     *
     * @param game The &lt;code&gt;Game&lt;/code&gt; to look in.
     * @param attributeName The attribute to check.
     * @param make If true, try to make the location if it is not found.
     * @return The &lt;code&gt;Location&lt;/code&gt; found.
     * @exception XMLStreamException if a problem was encountered
     *     during parsing.
     */
    public Location getLocationAttribute(Game game, String attributeName,
        boolean make) throws XMLStreamException {

<span class="nc bnc" id="L494" title="All 2 branches missed.">        if (attributeName == null) return null;</span>

<span class="nc" id="L496">        final String attrib =</span>
        // @compat 0.10.7
<span class="nc bnc" id="L498" title="All 2 branches missed.">            (FreeColObject.ID_ATTRIBUTE_TAG.equals(attributeName)) ? readId() :</span>
        // end @compat
<span class="nc" id="L500">            getAttribute(attributeName, (String)null);</span>

<span class="nc bnc" id="L502" title="All 2 branches missed.">        if (attrib != null) {</span>
<span class="nc" id="L503">            FreeColObject fco = lookup(game, attrib);</span>
<span class="nc bnc" id="L504" title="All 4 branches missed.">            if (fco == null &amp;&amp; make) {</span>
<span class="nc" id="L505">                Class&lt;? extends FreeColGameObject&gt; c</span>
<span class="nc" id="L506">                    = game.getLocationClass(attrib);</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">                if (c != null) {</span>
<span class="nc" id="L508">                    fco = makeFreeColGameObject(game, attributeName, c,</span>
<span class="nc bnc" id="L509" title="All 2 branches missed.">                        getReadScope() == ReadScope.SERVER);</span>
                }
            }
<span class="nc bnc" id="L512" title="All 2 branches missed.">            if (fco instanceof Location) return (Location)fco;</span>
<span class="nc" id="L513">                logger.warning(&quot;Not a location: &quot; + attrib);</span>
        }
<span class="nc" id="L515">        return null;</span>
    }

    /**
     * Reads an XML-representation of a list of some general type.
     *
     * @param &lt;T&gt; The list member type.
     * @param tag The tag for the list.
     * @param type The type of the items to be added.  This type
     *     needs to have a constructor accepting a single &lt;code&gt;String&lt;/code&gt;.
     * @return The list.
     * @exception XMLStreamException if a problem was encountered
     *     during parsing.
     */
    public &lt;T&gt; List&lt;T&gt; readList(String tag, Class&lt;T&gt; type)
        throws XMLStreamException {

<span class="nc" id="L532">        expectTag(tag);</span>

<span class="nc" id="L534">        final int length = getAttribute(FreeColObject.ARRAY_SIZE_TAG, -1);</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">        if (length &lt; 0) return Collections.&lt;T&gt;emptyList();</span>

<span class="nc" id="L537">        List&lt;T&gt; list = new ArrayList&lt;&gt;(length);</span>
<span class="nc bnc" id="L538" title="All 2 branches missed.">        for (int x = 0; x &lt; length; x++) {</span>
            try {
<span class="nc" id="L540">                final String value = getAttribute(&quot;x&quot; + x, (String)null);</span>
<span class="nc" id="L541">                T object = null;</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">                if (value != null) {</span>
<span class="nc" id="L543">                    Constructor&lt;T&gt; c = type.getConstructor(type);</span>
<span class="nc" id="L544">                    object = c.newInstance(new Object[] {value});</span>
                }
<span class="nc" id="L546">                list.add(object);</span>
<span class="nc" id="L547">            } catch (IllegalAccessException|InstantiationException</span>
<span class="nc" id="L548">                |InvocationTargetException|NoSuchMethodException e) {</span>
<span class="nc" id="L549">                throw new RuntimeException(e);</span>
            }
        }

<span class="nc" id="L553">        closeTag(tag);</span>
<span class="nc" id="L554">        return list;</span>
    }

    /**
     * Reads an XML-representation of a list of
     * &lt;code&gt;FreeColSpecObjectType&lt;/code&gt;s.
     *
     * @param &lt;T&gt; The list member type.
     * @param tag The tag for the list.
     * @param spec The &lt;code&gt;Specification&lt;/code&gt; to find items in.
     * @param type The type of the items to be added.  The type must exist
     *     in the supplied specification.
     * @return The list.
     * @exception XMLStreamException if a problem was encountered
     *     during parsing.
     */
    public &lt;T extends FreeColSpecObjectType&gt; List&lt;T&gt; readList(Specification spec,
        String tag, Class&lt;T&gt; type) throws XMLStreamException {

<span class="nc" id="L573">        expectTag(tag);</span>

<span class="nc" id="L575">        final int length = getAttribute(FreeColObject.ARRAY_SIZE_TAG, -1);</span>
<span class="nc bnc" id="L576" title="All 2 branches missed.">        if (length &lt; 0) return Collections.&lt;T&gt;emptyList();</span>

<span class="nc" id="L578">        List&lt;T&gt; list = new ArrayList&lt;&gt;(length);</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">        for (int x = 0; x &lt; length; x++) {</span>
<span class="nc" id="L580">            T value = getType(spec, &quot;x&quot; + x, type, (T)null); </span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">            if (value == null) logger.warning(&quot;Null list value(&quot; + x + &quot;)&quot;);</span>
<span class="nc" id="L582">            list.add(value);</span>
        }

<span class="nc" id="L585">        closeTag(tag);</span>
<span class="nc" id="L586">        return list;</span>
    }

    /**
     * Find a &lt;code&gt;FreeColGameObject&lt;/code&gt; of a given class
     * from a stream attribute.
     *
     * Use this routine when the object is optionally already be
     * present in the game.
     *
     * @param &lt;T&gt; The actual return type.
     * @param game The &lt;code&gt;Game&lt;/code&gt; to look in.
     * @param attributeName The attribute name.
     * @param returnClass The class to expect.
     * @param defaultValue A default value to return if not found.
     * @param required If true a null result should throw an exception.
     * @return The &lt;code&gt;FreeColGameObject&lt;/code&gt; found, or the default
     *     value if not found.
     * @exception XMLStreamException if the attribute is missing.
     */
    public &lt;T extends FreeColGameObject&gt; T findFreeColGameObject(Game game,
        String attributeName, Class&lt;T&gt; returnClass, T defaultValue,
        boolean required) throws XMLStreamException {

<span class="nc" id="L610">        T ret = getAttribute(game, attributeName, returnClass, (T)null);</span>
<span class="nc bnc" id="L611" title="All 2 branches missed.">        if (ret == (T)null) {</span>
<span class="nc bnc" id="L612" title="All 2 branches missed.">            if (required) {</span>
<span class="nc" id="L613">                throw new XMLStreamException(&quot;Missing &quot; + attributeName</span>
<span class="nc" id="L614">                    + &quot; for &quot; + returnClass.getName() + &quot;: &quot; + currentTag());</span>
            } else {
<span class="nc" id="L616">                ret = defaultValue;</span>
            }
        }
<span class="nc" id="L619">        return ret;</span>
    }

    /**
     * Either get an existing &lt;code&gt;FreeColGameObject&lt;/code&gt; from a stream
     * attribute or create it if it does not exist.
     *
     * Use this routine when the object may not necessarily already be
     * present in the game, but is expected to be defined eventually.
     *
     * @param &lt;T&gt; The actual return type.
     * @param game The &lt;code&gt;Game&lt;/code&gt; to look in.
     * @param attributeName The required attribute name.
     * @param returnClass The class of object.
     * @param required If true a null result should throw an exception.
     * @return The &lt;code&gt;FreeColGameObject&lt;/code&gt; found or made, or null
     *     if the attribute was not present.
     * @exception XMLStreamException if a problem was encountered
     *     during parsing.
     */
    public &lt;T extends FreeColGameObject&gt; T makeFreeColGameObject(Game game,
        String attributeName, Class&lt;T&gt; returnClass,
        boolean required) throws XMLStreamException {
<span class="nc" id="L642">        final String id =</span>
            // @compat 0.10.7
<span class="nc bnc" id="L644" title="All 2 branches missed.">            (FreeColObject.ID_ATTRIBUTE_TAG.equals(attributeName)) ? readId() :</span>
            // end @compat
<span class="nc" id="L646">            getAttribute(attributeName, (String)null);</span>

<span class="nc bnc" id="L648" title="All 2 branches missed.">        if (id == null) {</span>
<span class="nc bnc" id="L649" title="All 2 branches missed.">            if (required) {</span>
<span class="nc" id="L650">                throw new XMLStreamException(&quot;Missing &quot; + attributeName</span>
<span class="nc" id="L651">                    + &quot; for &quot; + returnClass.getName() + &quot;: &quot; + currentTag());</span>
            }
        } else {
<span class="nc" id="L654">            FreeColObject fco = lookup(game, id);</span>
<span class="nc bnc" id="L655" title="All 2 branches missed.">            if (fco == null) {</span>
<span class="nc" id="L656">                T ret = game.newInstance(returnClass,</span>
<span class="nc bnc" id="L657" title="All 2 branches missed.">                    getReadScope() == ReadScope.SERVER);</span>
<span class="nc bnc" id="L658" title="All 2 branches missed.">                if (ret == null) {</span>
<span class="nc" id="L659">                    String err = &quot;Failed to create &quot; + returnClass.getName()</span>
<span class="nc" id="L660">                        + &quot; with id: &quot; + id;</span>
<span class="nc bnc" id="L661" title="All 2 branches missed.">                    if (required) {</span>
<span class="nc" id="L662">                        throw new XMLStreamException(err);</span>
                    } else {
<span class="nc" id="L664">                        logger.warning(err);</span>
                    }
<span class="nc" id="L666">                } else {</span>
<span class="nc bnc" id="L667" title="All 2 branches missed.">                    if (shouldIntern()) {</span>
<span class="nc" id="L668">                        ret.internId(id);</span>
<span class="nc" id="L669">                    } else {</span>
<span class="nc" id="L670">                        uninterned.put(id, ret);</span>
                    }
                }
<span class="nc" id="L673">                return ret;</span>
            } else {
                try {
<span class="nc" id="L676">                    return returnClass.cast(fco);</span>
<span class="nc" id="L677">                } catch (ClassCastException cce) {</span>
<span class="nc" id="L678">                    throw new XMLStreamException(cce);</span>
                }
            }
        }
<span class="nc" id="L682">        return null;</span>
    }

    /**
     * Do a normal interning read of a &lt;code&gt;FreeColGameObject&lt;/code&gt;.
     *
     * @param &lt;T&gt; The actual return type.
     * @param game The &lt;code&gt;Game&lt;/code&gt; to look in.
     * @param returnClass The class to expect.
     * @return The &lt;code&gt;FreeColGameObject&lt;/code&gt; found, or null there
     *     was no ID_ATTRIBUTE_TAG present.
     * @exception XMLStreamException if there is problem reading the stream.
     */
    private &lt;T extends FreeColGameObject&gt; T internedRead(Game game,
        Class&lt;T&gt; returnClass) throws XMLStreamException {

<span class="nc" id="L698">        T ret = makeFreeColGameObject(game, FreeColObject.ID_ATTRIBUTE_TAG, </span>
<span class="nc" id="L699">                                      returnClass, false);</span>
<span class="nc bnc" id="L700" title="All 2 branches missed.">        if (ret != null) ret.readFromXML(this);</span>
<span class="nc" id="L701">        return ret;</span>
    }

    /**
     * Do a special non-interning read of a &lt;code&gt;FreeColObject&lt;/code&gt;.
     *
     * @param &lt;T&gt; The actual return type.
     * @param game The &lt;code&gt;Game&lt;/code&gt; to look in.
     * @param returnClass The class to expect.
     * @return The &lt;code&gt;FreeColObject&lt;/code&gt; found, or null there
     *     was no ID_ATTRIBUTE_TAG present.
     * @exception XMLStreamException if there is problem reading the stream.
     */
    private &lt;T extends FreeColObject&gt; T uninternedRead(Game game,
        Class&lt;T&gt; returnClass) throws XMLStreamException {

<span class="nc" id="L717">        T ret = FreeColGameObject.newInstance(game, returnClass);</span>
<span class="nc bnc" id="L718" title="All 2 branches missed.">        if (ret == null) {</span>
<span class="nc" id="L719">            throw new XMLStreamException(&quot;Could not create instance of &quot;</span>
<span class="nc" id="L720">                + returnClass.getName());</span>
        }
<span class="nc" id="L722">        String id = readId();</span>
<span class="nc bnc" id="L723" title="All 2 branches missed.">        if (id == null) {</span>
<span class="nc" id="L724">            throw new XMLStreamException(&quot;Object identifier not found.&quot;);</span>
        }
<span class="nc" id="L726">        uninterned.put(id, ret);</span>
<span class="nc" id="L727">        ret.readFromXML(this);</span>
<span class="nc" id="L728">        return ret;</span>
    }

    /**
     * Reads a &lt;code&gt;FreeColGameObject&lt;/code&gt; from a stream.
     * Expects the object to be identified by the standard ID_ATTRIBUTE_TAG.
     *
     * Use this routine when the object may or may not have been
     * referenced and created-by-id in this game, but this is the
     * point where it is authoritatively defined.
     *
     * @param &lt;T&gt; The actual return type.
     * @param game The &lt;code&gt;Game&lt;/code&gt; to look in.
     * @param returnClass The class to expect.
     * @return The &lt;code&gt;FreeColGameObject&lt;/code&gt; found, or null there
     *     was no ID_ATTRIBUTE_TAG present.
     * @exception XMLStreamException if there is problem reading the stream.
     */
    public &lt;T extends FreeColGameObject&gt; T readFreeColGameObject(Game game,
        Class&lt;T&gt; returnClass) throws XMLStreamException {
<span class="nc bnc" id="L748" title="All 2 branches missed.">        return (shouldIntern())</span>
<span class="nc" id="L749">            ? internedRead(game, returnClass)</span>
<span class="nc" id="L750">            : uninternedRead(game, returnClass);</span>
    }

    /**
     * Find a FreeCol AI object from an attribute in a stream.
     *
     * @param &lt;T&gt; The actual return type.
     * @param aiMain The &lt;code&gt;AIMain&lt;/code&gt; that contains the object.
     * @param attributeName The attribute name.
     * @param returnClass The &lt;code&gt;AIObject&lt;/code&gt; type to expect.
     * @param defaultValue The default value.
     * @param required If true a null result should throw an exception.
     * @exception XMLStreamException if there is problem reading the stream.
     * @return The &lt;code&gt;AIObject&lt;/code&gt; found, or the default value if not.
     */
    public &lt;T extends AIObject&gt; T findAIObject(AIMain aiMain,
        String attributeName, Class&lt;T&gt; returnClass, T defaultValue,
        boolean required) throws XMLStreamException {

<span class="nc" id="L769">        T ret = getAttribute(aiMain, attributeName, returnClass, (T)null);</span>
<span class="nc bnc" id="L770" title="All 2 branches missed.">        if (ret == (T)null) {</span>
<span class="nc bnc" id="L771" title="All 2 branches missed.">            if (required) {</span>
<span class="nc" id="L772">                throw new XMLStreamException(&quot;Missing &quot; + attributeName</span>
<span class="nc" id="L773">                    + &quot; for &quot; + returnClass.getName() + &quot;: &quot; + currentTag());</span>
            } else {
<span class="nc" id="L775">                ret = defaultValue;</span>
            }
        }
<span class="nc" id="L778">        return ret;</span>
    }

    /**
     * Either get an existing &lt;code&gt;AIObject&lt;/code&gt; from a stream
     * attribute or create it if it does not exist.
     *
     * Use this routine when the object may not necessarily already be
     * present in the game, but is expected to be defined eventually.
     *
     * @param &lt;T&gt; The actual return type.
     * @param aiMain The &lt;code&gt;AIMain&lt;/code&gt; that contains the object.
     * @param attributeName The attribute name.
     * @param returnClass The &lt;code&gt;AIObject&lt;/code&gt; type to expect.
     * @param defaultValue The default value.
     * @param required If true, throw exceptions on missing data.
     * @exception XMLStreamException if there is problem reading the stream.
     * @return The &lt;code&gt;AIObject&lt;/code&gt; found, or the default value if not.
     */
    public &lt;T extends AIObject&gt; T makeAIObject(AIMain aiMain,
        String attributeName, Class&lt;T&gt; returnClass, T defaultValue,
        boolean required) throws XMLStreamException {

<span class="nc" id="L801">        final String id =</span>
            // @compat 0.10.7
<span class="nc bnc" id="L803" title="All 2 branches missed.">            (FreeColObject.ID_ATTRIBUTE_TAG.equals(attributeName)) ? readId() :</span>
            // end @compat
<span class="nc" id="L805">            getAttribute(attributeName, (String)null);</span>

<span class="nc" id="L807">        T ret = null;</span>
<span class="nc bnc" id="L808" title="All 2 branches missed.">        if (id == null) {</span>
<span class="nc bnc" id="L809" title="All 2 branches missed.">            if (required) {</span>
<span class="nc" id="L810">                throw new XMLStreamException(&quot;Missing &quot; + attributeName</span>
<span class="nc" id="L811">                    + &quot; for &quot; + returnClass.getName() + &quot;: &quot; + currentTag());</span>
            }
        } else {
<span class="nc" id="L814">            ret = aiMain.getAIObject(id, returnClass);</span>
<span class="nc bnc" id="L815" title="All 2 branches missed.">            if (ret == null) {</span>
                try {
<span class="nc" id="L817">                    Constructor&lt;T&gt; c = returnClass.getConstructor(AIMain.class,</span>
<span class="nc" id="L818">                                                                  String.class);</span>
<span class="nc" id="L819">                    ret = returnClass.cast(c.newInstance(aiMain, id));</span>
<span class="nc bnc" id="L820" title="All 4 branches missed.">                    if (required &amp;&amp; ret == null) {</span>
<span class="nc" id="L821">                        throw new XMLStreamException(&quot;Constructed null &quot;</span>
<span class="nc" id="L822">                            + returnClass.getName() + &quot; for &quot; + id</span>
<span class="nc" id="L823">                            + &quot;: &quot; + currentTag());</span>
                    }
                } catch (NoSuchMethodException | SecurityException 
                        | InstantiationException | IllegalAccessException 
                        | IllegalArgumentException | InvocationTargetException 
<span class="nc" id="L828">                        | XMLStreamException e) {</span>
<span class="nc bnc" id="L829" title="All 2 branches missed.">                    if (required) {</span>
<span class="nc" id="L830">                        throw new XMLStreamException(e);</span>
                    } else {
<span class="nc" id="L832">                        logger.log(Level.WARNING, &quot;Failed to create AIObject: &quot;</span>
<span class="nc" id="L833">                                   + id, e);</span>
                    }
                }
            }
        }
<span class="nc" id="L838">        return ret;</span>
    }

    /**
     * Should the game object type being read clear its containers before
     * reading the child elements?
     *
     * Usually true, but not if the type is extending another one.
     *
     * @return True if the containers should be cleared.
     */
    public boolean shouldClearContainers() {
<span class="fc bfc" id="L850" title="All 2 branches covered.">        return !hasAttribute(FreeColSpecObjectType.EXTENDS_TAG)</span>
<span class="fc bfc" id="L851" title="All 2 branches covered.">            &amp;&amp; !hasAttribute(FreeColSpecObjectType.PRESERVE_TAG);</span>
    }

    /**
     * Get a FreeColSpecObjectType by identifier from a stream from a
     * specification.
     *
     * @param &lt;T&gt; The actual return type.
     * @param spec The &lt;code&gt;Specification&lt;/code&gt; to look in.
     * @param attributeName the name of the attribute identifying the
     *     &lt;code&gt;FreeColSpecObjectType&lt;/code&gt;.
     * @param returnClass The expected class of the return value.
     * @param defaultValue A default value to return if the attributeName 
     *     attribute is not present.
     * @return The &lt;code&gt;FreeColSpecObjectType&lt;/code&gt; found, or the
     *     &lt;code&gt;defaultValue&lt;/code&gt;.
     */
    public &lt;T extends FreeColSpecObjectType&gt; T getType(Specification spec,
        String attributeName, Class&lt;T&gt; returnClass, T defaultValue) {

<span class="fc" id="L871">        final String attrib =</span>
        // @compat 0.10.7
<span class="fc bfc" id="L873" title="All 2 branches covered.">            (FreeColObject.ID_ATTRIBUTE_TAG.equals(attributeName)) ? readId() :</span>
        // end @compat
<span class="fc" id="L875">            getAttribute(attributeName, (String)null);</span>

<span class="fc bfc" id="L877" title="All 2 branches covered.">        return (attrib == null) ? defaultValue</span>
<span class="fc" id="L878">            : spec.getType(attrib, returnClass);</span>
    }

    // @compat 0.10.7
    public &lt;T extends FreeColSpecObjectType&gt; T getRole(Specification spec,
        String attributeName, Class&lt;T&gt; returnClass, T defaultValue) {

<span class="fc" id="L885">        String attrib =</span>
<span class="pc bpc" id="L886" title="1 of 2 branches missed.">            (FreeColObject.ID_ATTRIBUTE_TAG.equals(attributeName)) ? readId() :</span>
<span class="fc" id="L887">            getAttribute(attributeName, (String)null);</span>

<span class="pc bpc" id="L889" title="1 of 2 branches missed.">        if (attrib == null) {</span>
<span class="nc" id="L890">            return defaultValue;</span>
        }
<span class="fc" id="L892">        attrib = Role.fixRoleId(attrib);</span>
<span class="fc" id="L893">        return spec.getType(attrib, returnClass);</span>
    }
    // end @compat

    /**
     * Copy a FreeColObject by serializing it and reading back the result
     * with a non-interning stream.
     *
     * @param &lt;T&gt; The actual return type.
     * @param game The &lt;code&gt;Game&lt;/code&gt; to look in.
     * @param returnClass The class to expect.
     * @return The copied &lt;code&gt;FreeColObject&lt;/code&gt; found, or null there
     *     was no ID_ATTRIBUTE_TAG present.
     * @exception XMLStreamException if there is problem reading the stream.
     */
    public &lt;T extends FreeColObject&gt; T copy(Game game, Class&lt;T&gt; returnClass)
        throws XMLStreamException {

<span class="nc" id="L911">        setReadScope(ReadScope.NOINTERN);</span>
<span class="nc" id="L912">        nextTag();</span>
<span class="nc" id="L913">        return uninternedRead(game, returnClass);</span>
    }

    /**
     * Seek to an identifier in this stream.
     *
     * @param id The identifier to find.
     * @return This &lt;code&gt;FreeColXMLReader&lt;/code&gt; positioned such that the 
     *     required identifier is current, or null on error or if not found.
     * @exception XMLStreamException if a problem was encountered
     *     during parsing.
     */
    public FreeColXMLReader seek(String id) throws XMLStreamException {
<span class="nc" id="L926">        nextTag();</span>
<span class="nc bnc" id="L927" title="All 2 branches missed.">        for (int type = getEventType(); type != XMLEvent.END_DOCUMENT;</span>
<span class="nc" id="L928">             type = getEventType()) {</span>
<span class="nc bnc" id="L929" title="All 2 branches missed.">            if (type == XMLEvent.START_ELEMENT</span>
<span class="nc bnc" id="L930" title="All 2 branches missed.">                &amp;&amp; id.equals(readId())) return this;</span>
<span class="nc" id="L931">            nextTag();</span>
        }
<span class="nc" id="L933">        return null;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span>net.sf.freecol.tools (2) (May 15, 2016 11:18:55 PM)</div></body></html>