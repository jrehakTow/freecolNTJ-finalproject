<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>EuropeanAIPlayer.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">net.sf.freecol.tools (2) (May 15, 2016 11:18:55 PM)</a> &gt; <a href="../../index.html" class="el_group">FreeCol</a> &gt; <a href="../index.html" class="el_bundle">src</a> &gt; <a href="index.source.html" class="el_package">net.sf.freecol.server.ai</a> &gt; <span class="el_source">EuropeanAIPlayer.java</span></div><h1>EuropeanAIPlayer.java</h1><pre class="source lang-java linenums">/**
 *  Copyright (C) 2002-2016   The FreeCol Team
 *
 *  This file is part of FreeCol.
 *
 *  FreeCol is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  FreeCol is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with FreeCol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package net.sf.freecol.server.ai;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map.Entry;
import java.util.Random;
import java.util.Set;
import java.util.function.ToDoubleFunction;
import java.util.logging.Level;
import java.util.logging.Logger;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import javax.xml.stream.XMLStreamException;

import net.sf.freecol.common.i18n.Messages;
import net.sf.freecol.common.io.FreeColXMLReader;
import net.sf.freecol.common.model.Ability;
import net.sf.freecol.common.model.Building;
import net.sf.freecol.common.model.Colony;
import net.sf.freecol.common.model.Constants;
import net.sf.freecol.common.model.DiplomaticTrade;
import net.sf.freecol.common.model.DiplomaticTrade.TradeStatus;
import net.sf.freecol.common.model.Europe;
import net.sf.freecol.common.model.FeatureContainer;
import net.sf.freecol.common.model.FoundingFather;
import net.sf.freecol.common.model.Game;
import net.sf.freecol.common.model.GameOptions;
import net.sf.freecol.common.model.GoldTradeItem;
import net.sf.freecol.common.model.Goods;
import net.sf.freecol.common.model.GoodsType;
import net.sf.freecol.common.model.HistoryEvent;
import net.sf.freecol.common.model.IndianSettlement;
import net.sf.freecol.common.model.Location;
import net.sf.freecol.common.model.Map;
import net.sf.freecol.common.model.Market;
import net.sf.freecol.common.model.Modifier;
import net.sf.freecol.common.model.NationSummary;
import net.sf.freecol.common.model.PathNode;
import net.sf.freecol.common.model.Player;
import net.sf.freecol.common.model.Player.PlayerType;
import net.sf.freecol.common.model.Stance;
import net.sf.freecol.common.model.Role;
import net.sf.freecol.common.model.Settlement;
import net.sf.freecol.common.model.Specification;
import net.sf.freecol.common.model.StanceTradeItem;
import net.sf.freecol.common.model.Tension;
import net.sf.freecol.common.model.Tile;
import net.sf.freecol.common.model.TradeItem;
import net.sf.freecol.common.model.Turn;
import net.sf.freecol.common.model.Unit;
import net.sf.freecol.common.model.Unit.UnitState;
import net.sf.freecol.common.model.UnitType;
import net.sf.freecol.common.model.pathfinding.CostDeciders;
import net.sf.freecol.common.model.pathfinding.GoalDeciders;
import static net.sf.freecol.common.util.CollectionUtils.*;
import net.sf.freecol.common.util.LogBuilder;
import net.sf.freecol.common.util.RandomChoice;
import static net.sf.freecol.common.util.RandomUtils.*;

import net.sf.freecol.server.ai.GoodsWish;
import net.sf.freecol.server.ai.mission.BuildColonyMission;
import net.sf.freecol.server.ai.mission.CashInTreasureTrainMission;
import net.sf.freecol.server.ai.mission.DefendSettlementMission;
import net.sf.freecol.server.ai.mission.IdleAtSettlementMission;
import net.sf.freecol.server.ai.mission.Mission;
import net.sf.freecol.server.ai.mission.MissionaryMission;
import net.sf.freecol.server.ai.mission.PioneeringMission;
import net.sf.freecol.server.ai.mission.PrivateerMission;
import net.sf.freecol.server.ai.mission.ScoutingMission;
import net.sf.freecol.server.ai.mission.TransportMission;
import net.sf.freecol.server.ai.mission.UnitSeekAndDestroyMission;
import net.sf.freecol.server.ai.mission.UnitWanderHostileMission;
import net.sf.freecol.server.ai.mission.WishRealizationMission;
import net.sf.freecol.server.ai.mission.WorkInsideColonyMission;
import net.sf.freecol.server.ai.ValuedAIObject;
import net.sf.freecol.server.ai.WorkerWish;
import net.sf.freecol.server.model.ServerPlayer;


/**
 * Objects of this class contains AI-information for a single European
 * {@link Player} and is used for controlling this player.
 *
 * The method {@link #startWorking} gets called by the
 * {@link AIInGameInputHandler} when it is this player's turn.
 */
public class EuropeanAIPlayer extends MissionAIPlayer {

<span class="nc" id="L114">    private static final Logger logger = Logger.getLogger(EuropeanAIPlayer.class.getName());</span>

    /** Maximum number of turns to travel to a building site. */
    private static final int buildingRange = 5;

    /** Maximum number of turns to travel to a cash in location. */
    private static final int cashInRange = 20;

    /** Maximum number of turns to travel to a missionary target. */
    private static final int missionaryRange = 20;

    /**
     * Maximum number of turns to travel to make progress on
     * pioneering.  This is low-ish because it is usually more
     * efficient to ship the tools where they are needed and either
     * create a new pioneer on site or send a hardy pioneer on
     * horseback.  The AI is probably smart enough to do the former
     * already, and one day the latter.
     */
    private static final int pioneeringRange = 10;

    /**
     * Maximum number of turns to travel to a privateering target.
     * Low number because of large naval moves.
     */
    private static final int privateerRange = 1;

    /** Maximum number of turns to travel to a scouting target. */
    private static final int scoutingRange = 20;

    /** A comparator to sort units by decreasing builder score. */
<span class="nc" id="L145">    private static final Comparator&lt;AIUnit&gt; builderComparator</span>
<span class="nc" id="L146">        = Comparator.comparingInt(AIUnit::getBuilderScore).reversed();</span>

    /**
     * A comparator to sort units by suitability for a PioneeringMission.
     *
     * We do not check if a unit is near to a colony that can provide tools,
     * as that is likely to be too expensive.  FIXME: perhaps we should.
     */
<span class="nc" id="L154">    public static final Comparator&lt;AIUnit&gt; pioneerComparator</span>
<span class="nc" id="L155">        = Comparator.comparingInt(AIUnit::getPioneerScore).reversed();</span>

    /**
     * A comparator to sort units by suitability for a ScoutingMission.
     *
     * We do not check if a unit is near to a colony that can provide horses,
     * as that is likely to be too expensive.  FIXME: perhaps we should.
     */
<span class="nc" id="L163">    public static final Comparator&lt;AIUnit&gt; scoutComparator</span>
<span class="nc" id="L164">        = Comparator.comparingInt(AIUnit::getScoutScore).reversed();</span>


    // These should be final, but need the spec.

    /** Cheat chances. */
    private static int liftBoycottCheatPercent;
    private static int equipScoutCheatPercent;
    private static int equipPioneerCheatPercent;
    private static int landUnitCheatPercent;
    private static int offensiveLandUnitCheatPercent;
    private static int offensiveNavalUnitCheatPercent;
    private static int transportNavalUnitCheatPercent;
    /** The pioneer role. */
<span class="nc" id="L178">    private static Role pioneerRole = null;</span>
    /** The scouting role. */
<span class="nc" id="L180">    private static Role scoutRole = null;</span>

    // Caches/internals.  Do not serialize.

    /**
     * Stores temporary information for sessions (trading with another
     * player etc).
     */
<span class="nc" id="L188">    private final java.util.Map&lt;String, Integer&gt; sessionRegister</span>
<span class="nc" id="L189">        = new HashMap&lt;&gt;();</span>

    /**
     * A cached map of Tile to best TileImprovementPlan.
     * Used to choose a tile improvement for a pioneer to work on.
     */
<span class="nc" id="L195">    private final java.util.Map&lt;Tile, TileImprovementPlan&gt; tipMap</span>
<span class="nc" id="L196">        = new HashMap&lt;&gt;();</span>

    /**
     * A cached map of destination Location to Wishes awaiting transport.
     */
<span class="nc" id="L201">    private final java.util.Map&lt;Location, List&lt;Wish&gt;&gt; transportDemand</span>
<span class="nc" id="L202">        = new HashMap&lt;&gt;();</span>

    /** A cached list of transportables awaiting transport. */
<span class="nc" id="L205">    private final List&lt;TransportableAIObject&gt; transportSupply</span>
<span class="nc" id="L206">        = new ArrayList&lt;&gt;();</span>

    /**
     * A mapping of goods type to the goods wishes where a colony has
     * requested that goods type.  Used to retarget goods that have
     * gone astray.
     */
<span class="nc" id="L213">    private final java.util.Map&lt;GoodsType, List&lt;GoodsWish&gt;&gt; goodsWishes</span>
<span class="nc" id="L214">        = new HashMap&lt;&gt;();</span>

    /**
     * A mapping of unit type to the worker wishes for that type.
     * Used to allocate WishRealizationMissions for units.
     */
<span class="nc" id="L220">    private final java.util.Map&lt;UnitType, List&lt;WorkerWish&gt;&gt; workerWishes</span>
<span class="nc" id="L221">        = new HashMap&lt;&gt;();</span>

    /**
     * A mapping of contiguity number to number of wagons needed in
     * that landmass.
     */
<span class="nc" id="L227">    private final java.util.Map&lt;Integer, Integer&gt; wagonsNeeded</span>
<span class="nc" id="L228">        = new HashMap&lt;&gt;();</span>

    /** The colonies that start the turn badly defended. */
<span class="nc" id="L231">    private final List&lt;AIColony&gt; badlyDefended = new ArrayList&lt;&gt;();</span>

    /**
     * Current estimate of the number of new
     * &lt;code&gt;BuildColonyMission&lt;/code&gt;s to create.
     */
<span class="nc" id="L237">    private int nBuilders = 0;</span>

    /**
     * Current estimate of the number of new
     * &lt;code&gt;PioneeringMission&lt;/code&gt;s to create.
     */
<span class="nc" id="L243">    private int nPioneers = 0;</span>

    /**
     * Current estimate of the number of new
     * &lt;code&gt;ScoutingMission&lt;/code&gt;s to create.
     */
<span class="nc" id="L249">    private int nScouts = 0;</span>

    /** Count of the number of transports needing a naval unit. */
<span class="nc" id="L252">    private int nNavalCarrier = 0;</span>


    /**
     * Creates a new &lt;code&gt;EuropeanAIPlayer&lt;/code&gt;.
     *
     * @param aiMain The main AI-class.
     * @param player The player that should be associated with this
     *            &lt;code&gt;AIPlayer&lt;/code&gt;.
     */
    public EuropeanAIPlayer(AIMain aiMain, ServerPlayer player) {
<span class="nc" id="L263">        super(aiMain, player);</span>

<span class="nc bnc" id="L265" title="All 2 branches missed.">        uninitialized = getPlayer() == null;</span>
<span class="nc" id="L266">    }</span>

    /**
     * Creates a new &lt;code&gt;AIPlayer&lt;/code&gt;.
     *
     * @param aiMain The main AI-object.
     * @param xr The input stream containing the XML.
     * @throws XMLStreamException if a problem was encountered during parsing.
     */
    public EuropeanAIPlayer(AIMain aiMain,
                            FreeColXMLReader xr) throws XMLStreamException {
<span class="nc" id="L277">        super(aiMain, xr);</span>

<span class="nc bnc" id="L279" title="All 2 branches missed.">        uninitialized = getPlayer() == null;</span>
<span class="nc" id="L280">    }</span>


    /**
     * Initialize the static fields that would be final but for
     * needing the specification.
     *
     * @param spec The &lt;code&gt;Specification&lt;/code&gt; to initialize from.
     */
    public static synchronized void initializeFromSpecification(Specification spec) {
<span class="nc bnc" id="L290" title="All 2 branches missed.">        if (pioneerRole != null) return;</span>
<span class="nc" id="L291">        pioneerRole = spec.getRoleWithAbility(Ability.IMPROVE_TERRAIN, null);</span>
<span class="nc" id="L292">        scoutRole = spec.getRoleWithAbility(Ability.SPEAK_WITH_CHIEF, null);</span>
<span class="nc" id="L293">        liftBoycottCheatPercent</span>
<span class="nc" id="L294">            = spec.getInteger(GameOptions.LIFT_BOYCOTT_CHEAT);</span>
<span class="nc" id="L295">        equipScoutCheatPercent</span>
<span class="nc" id="L296">            = spec.getInteger(GameOptions.EQUIP_SCOUT_CHEAT);</span>
<span class="nc" id="L297">        equipPioneerCheatPercent</span>
<span class="nc" id="L298">            = spec.getInteger(GameOptions.EQUIP_PIONEER_CHEAT);</span>
<span class="nc" id="L299">        landUnitCheatPercent</span>
<span class="nc" id="L300">            = spec.getInteger(GameOptions.LAND_UNIT_CHEAT);</span>
<span class="nc" id="L301">        offensiveLandUnitCheatPercent</span>
<span class="nc" id="L302">            = spec.getInteger(GameOptions.OFFENSIVE_LAND_UNIT_CHEAT);</span>
<span class="nc" id="L303">        offensiveNavalUnitCheatPercent</span>
<span class="nc" id="L304">            = spec.getInteger(GameOptions.OFFENSIVE_NAVAL_UNIT_CHEAT);</span>
<span class="nc" id="L305">        transportNavalUnitCheatPercent</span>
<span class="nc" id="L306">            = spec.getInteger(GameOptions.TRANSPORT_NAVAL_UNIT_CHEAT);</span>
<span class="nc" id="L307">    }</span>

    /**
     * Get the list of badly defended colonies.
     *
     * @return A list of &lt;code&gt;AIColony&lt;/code&gt;s that were badly
     *     defended at the start of this turn.
     */
    protected List&lt;AIColony&gt; getBadlyDefended() {
<span class="nc" id="L316">        return badlyDefended;</span>
    }

    /**
     * Simple initialization of AI missions given that we know the starting
     * conditions.
     *
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     */
    private void initializeMissions(LogBuilder lb) {
<span class="nc" id="L326">        final AIMain aiMain = getAIMain();</span>
<span class="nc" id="L327">        List&lt;AIUnit&gt; aiUnits = getAIUnits();</span>
<span class="nc" id="L328">        lb.add(&quot;\n  Initialize &quot;);</span>
        
        // Find all the carriers with potential colony builders on board,
        // give them missions.
<span class="nc" id="L332">        final Map map = getGame().getMap();</span>
<span class="nc" id="L333">        final int maxRange = map.getWidth() + map.getHeight();</span>
        Location target;
        Mission m;
        TransportMission tm;
<span class="nc bnc" id="L337" title="All 2 branches missed.">        for (AIUnit aiCarrier : aiUnits) {</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">            if (aiCarrier.hasMission()) continue;</span>
<span class="nc" id="L339">            Unit carrier = aiCarrier.getUnit();</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">            if (!carrier.isNaval()) continue;</span>
<span class="nc" id="L341">            target = null;</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">            for (Unit u : carrier.getUnitList()) {</span>
<span class="nc" id="L343">                AIUnit aiu = aiMain.getAIUnit(u);</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">                for (int range = buildingRange; range &lt; maxRange;</span>
<span class="nc" id="L345">                     range += buildingRange) {</span>
<span class="nc" id="L346">                    target = BuildColonyMission.findTarget(aiu, range, false);</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">                    if (target != null) break;</span>
                }
<span class="nc bnc" id="L349" title="All 2 branches missed.">                if (target == null) {</span>
<span class="nc" id="L350">                    throw new RuntimeException(&quot;Initial colony fail!&quot;);</span>
                }
<span class="nc bnc" id="L352" title="All 2 branches missed.">                if ((m = getBuildColonyMission(aiu, target)) != null) {</span>
<span class="nc" id="L353">                    lb.add(m, &quot;, &quot;);</span>
                }
            }
            // Initialize the carrier mission after the cargo units
            // have a valid mission so that the transport list and
            // mission target do not break.
<span class="nc" id="L359">            tm = (TransportMission)getTransportMission(aiCarrier);</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">            if (tm != null) {</span>
<span class="nc" id="L361">                lb.add(tm);</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">                for (Unit u : carrier.getUnitList()) {</span>
<span class="nc" id="L363">                    AIUnit aiu = getAIMain().getAIUnit(u);</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">                    if (aiu == null) continue;</span>
<span class="nc" id="L365">                    tm.queueTransportable(aiu, false, lb);</span>
                }
            }
        }

        // Put in some backup missions.
<span class="nc" id="L371">        lb.mark();</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">        for (AIUnit aiu : aiUnits) {</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">            if (aiu.hasMission()) continue;</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">            if ((m = getSimpleMission(aiu)) != null) lb.add(m, &quot;, &quot;);</span>
        }
<span class="nc bnc" id="L376" title="All 2 branches missed.">        if (lb.grew(&quot;\n  Backup: &quot;)) lb.shrink(&quot;, &quot;);</span>
<span class="nc" id="L377">    }</span>

    /**
     * Cheat by adding gold to guarantee the player has a minimum amount.
     *
     * @param amount The minimum amount of gold required.
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     */
    public void cheatGold(int amount, LogBuilder lb) {
<span class="nc" id="L386">        final Player player = getPlayer();</span>
<span class="nc" id="L387">        int gold = player.getGold();</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">        if (gold &lt; amount) {</span>
<span class="nc" id="L389">            amount -= gold;</span>
<span class="nc" id="L390">            player.modifyGold(amount);</span>
<span class="nc" id="L391">            lb.add(&quot;added &quot;, amount, &quot; gold&quot;);</span>
        }
<span class="nc" id="L393">        player.logCheat(amount + &quot; gold&quot;);</span>
<span class="nc" id="L394">    }</span>

    /**
     * Cheats for the AI.  Please try to centralize cheats here.
     *
     * FIXME: Remove when the AI is good enough.
     *
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     */
    private void cheat(LogBuilder lb) {
<span class="nc" id="L404">        final AIMain aiMain = getAIMain();</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">        if (!aiMain.getFreeColServer().getSinglePlayer()) return;</span>

<span class="nc" id="L407">        final Player player = getPlayer();</span>
<span class="nc bnc" id="L408" title="All 2 branches missed.">        if (player.getPlayerType() != PlayerType.COLONIAL) return;</span>
<span class="nc" id="L409">        lb.mark();</span>

<span class="nc" id="L411">        final Specification spec = getSpecification();</span>
<span class="nc" id="L412">        final Game game = getGame();</span>
<span class="nc" id="L413">        final Market market = player.getMarket();</span>
<span class="nc" id="L414">        final Europe europe = player.getEurope();</span>
<span class="nc" id="L415">        final Random air = getAIRandom();</span>
<span class="nc" id="L416">        final List&lt;GoodsType&gt; arrears = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">        if (market != null) {</span>
<span class="nc" id="L418">            arrears.addAll(transform(spec.getGoodsTypeList(),</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">                    gt -&gt; market.getArrears(gt) &gt; 0, Collectors.toList()));</span>
        }
<span class="nc" id="L421">        final int nCheats = arrears.size() + 6; // 6 cheats + arrears</span>
<span class="nc" id="L422">        int[] randoms = randomInts(logger, &quot;cheats&quot;, air, 100, nCheats);</span>
<span class="nc" id="L423">        int cheatIndex = 0;</span>

<span class="nc bnc" id="L425" title="All 2 branches missed.">        for (GoodsType goodsType : arrears) {</span>
<span class="nc bnc" id="L426" title="All 2 branches missed.">            if (randoms[cheatIndex++] &lt; liftBoycottCheatPercent) {</span>
<span class="nc" id="L427">                market.setArrears(goodsType, 0);</span>
                // Just remove one goods party modifier (we can not
                // currently identify which modifier applies to which
                // goods type, but that is not worth fixing for the
                // benefit of `temporary' cheat code).  If we do not
                // do this, AI colonies accumulate heaps of party
                // modifiers because of the cheat boycott removal.
<span class="nc bnc" id="L434" title="All 2 branches missed.">                findOne: for (Colony c : player.getColonies()) {</span>
<span class="nc bnc" id="L435" title="All 2 branches missed.">                    for (Modifier m : c.getModifiers()) {</span>
<span class="nc bnc" id="L436" title="All 2 branches missed.">                        if (Specification.COLONY_GOODS_PARTY_SOURCE == m.getSource()) {</span>
<span class="nc" id="L437">                            c.removeModifier(m);</span>
<span class="nc" id="L438">                            lb.add(&quot;lift-boycott at &quot;, c, &quot;, &quot;);</span>
<span class="nc" id="L439">                            player.logCheat(&quot;lift boycott at &quot; + c.getName());</span>
<span class="nc" id="L440">                            break findOne;</span>
                        }
                    }
                }
            }
        }
    
<span class="nc bnc" id="L447" title="All 2 branches missed.">        if (!europe.isEmpty()</span>
<span class="nc bnc" id="L448" title="All 2 branches missed.">            &amp;&amp; scoutsNeeded() &gt; 0</span>
<span class="nc bnc" id="L449" title="All 2 branches missed.">            &amp;&amp; randoms[cheatIndex++] &lt; equipScoutCheatPercent) {</span>
<span class="nc bnc" id="L450" title="All 2 branches missed.">            for (Unit u : europe.getUnitList()) {</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">                if (u.hasDefaultRole()</span>
<span class="nc bnc" id="L452" title="All 2 branches missed.">                    &amp;&amp; u.hasAbility(Ability.CAN_BE_EQUIPPED)) {</span>
<span class="nc" id="L453">                    cheatGold(europe.priceGoods(u.getGoodsDifference(scoutRole, 1)), lb);</span>
                    if
<span class="nc bnc" id="L455" title="All 2 branches missed.">            (getAIUnit(u).equipForRole(spec.getRoleWithAbility(Ability.SPEAK_WITH_CHIEF, null))) {</span>
<span class="nc" id="L456">                        lb.add(&quot; to equip scout &quot;, u, &quot;, &quot;);</span>
<span class="nc" id="L457">                        player.logCheat(&quot;Equip scout &quot; + u.toShortString());</span>
                    }
<span class="nc" id="L459">                    break;</span>
                }
            }
        }

<span class="nc bnc" id="L464" title="All 2 branches missed.">        if (!europe.isEmpty()</span>
<span class="nc bnc" id="L465" title="All 2 branches missed.">            &amp;&amp; pioneersNeeded() &gt; 0</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">            &amp;&amp; randoms[cheatIndex++] &lt; equipPioneerCheatPercent) {</span>
<span class="nc bnc" id="L467" title="All 2 branches missed.">            for (Unit u : europe.getUnitList()) {</span>
<span class="nc bnc" id="L468" title="All 2 branches missed.">                if (u.hasDefaultRole()</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">                    &amp;&amp; u.hasAbility(Ability.CAN_BE_EQUIPPED)) {</span>
<span class="nc" id="L470">                    cheatGold(europe.priceGoods(u.getGoodsDifference(pioneerRole, 1)), lb);</span>
<span class="nc bnc" id="L471" title="All 2 branches missed.">                    if (getAIUnit(u).equipForRole(spec.getRoleWithAbility(Ability.IMPROVE_TERRAIN, null))) {</span>
<span class="nc" id="L472">                        lb.add(&quot; to equip pioneer &quot;, u, &quot;, &quot;);</span>
<span class="nc" id="L473">                        player.logCheat(&quot;Equip pioneer &quot; + u.toShortString());</span>
                    }
<span class="nc" id="L475">                    break;</span>
                }
            }
        }

<span class="nc bnc" id="L480" title="All 2 branches missed.">        if (randoms[cheatIndex++] &lt; landUnitCheatPercent) {</span>
<span class="nc" id="L481">            final Comparator&lt;WorkerWish&gt; comp</span>
<span class="nc" id="L482">                = Comparator.comparingInt(ValuedAIObject::getValue);</span>
<span class="nc" id="L483">            Stream&lt;WorkerWish&gt; values = workerWishes.keySet().stream()</span>
<span class="nc bnc" id="L484" title="All 4 branches missed.">                .filter(ut -&gt; ut != null &amp;&amp; ut.isAvailableTo(player)</span>
<span class="nc bnc" id="L485" title="All 2 branches missed.">                    &amp;&amp; europe.getUnitPrice(ut) != UNDEFINED)</span>
<span class="nc" id="L486">                .map(ut -&gt; workerWishes.get(ut))</span>
<span class="nc bnc" id="L487" title="All 4 branches missed.">                .filter(wl -&gt; wl != null &amp;&amp; !wl.isEmpty())</span>
<span class="nc" id="L488">                .map(wl -&gt; wl.get(0));</span>
<span class="nc" id="L489">            WorkerWish bestWish = maximize(values, comp);</span>

<span class="nc bnc" id="L491" title="All 2 branches missed.">            int cost = (bestWish != null)</span>
<span class="nc" id="L492">                ? europe.getUnitPrice(bestWish.getUnitType())</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">                : (player.getImmigration() &lt; player.getImmigrationRequired() / 2)</span>
<span class="nc" id="L494">                ? player.getRecruitPrice()</span>
<span class="nc" id="L495">                : INFINITY;</span>
<span class="nc bnc" id="L496" title="All 2 branches missed.">            if (cost != INFINITY) {</span>
<span class="nc" id="L497">                cheatGold(cost, lb);</span>
                AIUnit aiu;
<span class="nc bnc" id="L499" title="All 2 branches missed.">                if (bestWish == null) {</span>
<span class="nc bnc" id="L500" title="All 2 branches missed.">                    if ((aiu = recruitAIUnitInEurope(-1)) != null) {</span>
                        // let giveNormalMissions look after the mission
<span class="nc" id="L502">                        lb.add(&quot; to recruit &quot;, aiu.getUnit(), &quot;, &quot;);</span>
                    }
<span class="nc" id="L504">                } else {</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">                    if ((aiu = trainAIUnitInEurope(bestWish.getUnitType())) != null) {</span>
<span class="nc" id="L506">                        Mission m = getWishRealizationMission(aiu, bestWish);</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">                        if (m != null) {</span>
<span class="nc" id="L508">                            lb.add(&quot; to train for &quot;, m, &quot;, &quot;);</span>
<span class="nc" id="L509">                        } else {</span>
<span class="nc" id="L510">                            lb.add(&quot; to train &quot;, aiu.getUnit(), &quot;, &quot;);</span>
                        }
                    }
                }
<span class="nc bnc" id="L514" title="All 2 branches missed.">                if (aiu != null) player.logCheat(&quot;Make &quot; + aiu.getUnit());</span>
            }
        }

<span class="nc bnc" id="L518" title="All 2 branches missed.">        if (game.getTurn().getNumber() &gt; 300</span>
<span class="nc bnc" id="L519" title="All 2 branches missed.">            &amp;&amp; player.isAtWar()</span>
<span class="nc bnc" id="L520" title="All 2 branches missed.">            &amp;&amp; randoms[cheatIndex++] &lt; offensiveLandUnitCheatPercent) {</span>
            // - collect enemies, prefer not to antagonize the strong or
            //   crush the weak
<span class="nc" id="L523">            List&lt;Player&gt; enemies = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L524">            List&lt;Player&gt; preferred = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L525" title="All 2 branches missed.">            for (Player p : game.getLivePlayers(player)) {</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">                if (player.atWarWith(p)) {</span>
<span class="nc" id="L527">                    enemies.add(p);</span>
<span class="nc" id="L528">                    double strength = getStrengthRatio(p);</span>
<span class="nc bnc" id="L529" title="All 4 branches missed.">                    if (strength &lt; 3.0/2.0 &amp;&amp; strength &gt; 2.0/3.0) {</span>
<span class="nc" id="L530">                        preferred.add(p);</span>
                    }
                }
            }
<span class="nc bnc" id="L534" title="All 2 branches missed.">            if (!preferred.isEmpty()) {</span>
<span class="nc" id="L535">                enemies.clear();</span>
<span class="nc" id="L536">                enemies.addAll(preferred);</span>
            }
<span class="nc" id="L538">            List&lt;Colony&gt; colonies = player.getColonies();</span>
            // Find a target to attack.
<span class="nc" id="L540">            Location target = null;</span>
            // Few colonies?  Attack the weakest European port
<span class="nc bnc" id="L542" title="All 2 branches missed.">            if (colonies.size() &lt; 3) {</span>
<span class="nc" id="L543">                final Comparator&lt;Colony&gt; targetScore</span>
<span class="nc" id="L544">                    = cachingDoubleComparator(c -&gt; {</span>
<span class="nc" id="L545">                            double score = 100000.0 / c.getUnitCount();</span>
<span class="nc" id="L546">                            Building stockade = c.getStockade();</span>
<span class="nc bnc" id="L547" title="All 2 branches missed.">                            return (stockade == null) ? 1.0</span>
<span class="nc" id="L548">                                : score / (stockade.getLevel() + 1.5);</span>
                        });
<span class="nc" id="L550">                target = maximize(enemies.stream()</span>
<span class="nc" id="L551">                    .filter(Player::isEuropean)</span>
<span class="nc" id="L552">                    .flatMap(p -&gt; p.getColonies().stream()),</span>
<span class="nc" id="L553">                    Colony::isConnectedPort, targetScore);</span>
            }
            // Otherwise attack something near a weak colony
<span class="nc bnc" id="L556" title="All 4 branches missed.">            if (target == null &amp;&amp; !colonies.isEmpty()) {</span>
<span class="nc" id="L557">                List&lt;AIColony&gt; bad = new ArrayList&lt;&gt;(getBadlyDefended());</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">                if (bad.isEmpty()) bad.addAll(getAIColonies());</span>
<span class="nc" id="L559">                AIColony defend = getRandomMember(logger,</span>
<span class="nc" id="L560">                    &quot;AIColony to defend&quot;, bad, air);</span>
<span class="nc" id="L561">                Tile center = defend.getColony().getTile();</span>
<span class="nc" id="L562">                Tile t = game.getMap().searchCircle(center,</span>
<span class="nc" id="L563">                    GoalDeciders.getEnemySettlementGoalDecider(enemies),</span>
<span class="nc" id="L564">                    30);</span>
<span class="nc bnc" id="L565" title="All 2 branches missed.">                if (t != null) target = t.getSettlement();</span>
            }
<span class="nc bnc" id="L567" title="All 2 branches missed.">            if (target != null) {</span>
<span class="nc" id="L568">                List&lt;Unit&gt; mercs = ((ServerPlayer)player)</span>
<span class="nc" id="L569">                    .createUnits(player.getMonarch().getMercenaries(air),</span>
<span class="nc" id="L570">                                 europe);</span>
<span class="nc bnc" id="L571" title="All 2 branches missed.">                for (Unit u : mercs) {</span>
<span class="nc" id="L572">                    AIUnit aiu = getAIUnit(u);</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">                    if (aiu == null) continue; // Can not happen</span>
<span class="nc" id="L574">                    player.logCheat(&quot;Enlist &quot; + aiu.getUnit());</span>
<span class="nc" id="L575">                    Mission m = getSeekAndDestroyMission(aiu, target);</span>
<span class="nc bnc" id="L576" title="All 2 branches missed.">                    if (m != null) {</span>
<span class="nc" id="L577">                        lb.add(&quot;enlisted &quot;, m, &quot;, &quot;);</span>
<span class="nc" id="L578">                    } else {</span>
<span class="nc" id="L579">                        lb.add(&quot;enlisted &quot;, aiu.getUnit(), &quot;, &quot;);</span>
                    }
                }
            }
        }
            
        // Always cheat a new armed ship if the navy is destroyed,
        // otherwise if the navy is below average the chance to cheat
        // is proportional to how badly below average.
<span class="nc" id="L588">        double naval = getNavalStrengthRatio();</span>
<span class="nc bnc" id="L589" title="All 2 branches missed.">        int nNaval = (player.getUnitCount(true) == 0) ? 100</span>
<span class="nc bnc" id="L590" title="All 4 branches missed.">            : (0.0f &lt; naval &amp;&amp; naval &lt; 0.5f)</span>
<span class="nc" id="L591">            ? (int)(naval * offensiveNavalUnitCheatPercent)</span>
<span class="nc" id="L592">            : -1;</span>
<span class="nc bnc" id="L593" title="All 2 branches missed.">        if (randoms[cheatIndex++] &lt; nNaval) {</span>
<span class="nc" id="L594">            cheatUnit(transform(spec.getUnitTypeList(),</span>
<span class="nc bnc" id="L595" title="All 2 branches missed.">                    ut -&gt; ut.hasAbility(Ability.NAVAL_UNIT)</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">                        &amp;&amp; ut.isAvailableTo(player)</span>
<span class="nc bnc" id="L597" title="All 2 branches missed.">                        &amp;&amp; ut.hasPrice()</span>
<span class="nc bnc" id="L598" title="All 2 branches missed.">                        &amp;&amp; ut.isOffensive(),</span>
<span class="nc" id="L599">                    ut -&gt; new RandomChoice&lt;&gt;(ut, 100000 / europe.getUnitPrice(ut)),</span>
<span class="nc" id="L600">                    Collectors.toList()), &quot;offensive-naval&quot;, lb);</span>
        }
        // Only cheat carriers if they have work to do.
<span class="nc bnc" id="L603" title="All 2 branches missed.">        int nCarrier = (nNavalCarrier &gt; 0) ? transportNavalUnitCheatPercent</span>
<span class="nc" id="L604">            : -1;</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">        if (randoms[cheatIndex++] &lt; nCarrier) {</span>
<span class="nc" id="L606">            cheatUnit(transform(spec.getUnitTypeList(),</span>
<span class="nc bnc" id="L607" title="All 2 branches missed.">                    ut -&gt; ut.hasAbility(Ability.NAVAL_UNIT)</span>
<span class="nc bnc" id="L608" title="All 2 branches missed.">                        &amp;&amp; ut.isAvailableTo(player)</span>
<span class="nc bnc" id="L609" title="All 2 branches missed.">                        &amp;&amp; ut.hasPrice()</span>
<span class="nc bnc" id="L610" title="All 2 branches missed.">                        &amp;&amp; ut.getSpace() &gt; 0,</span>
<span class="nc" id="L611">                    ut -&gt; new RandomChoice&lt;&gt;(ut, 100000 / europe.getUnitPrice(ut)),</span>
<span class="nc" id="L612">                    Collectors.toList()), &quot;transport-naval&quot;, lb);</span>
        }

<span class="nc bnc" id="L615" title="All 2 branches missed.">        if (lb.grew(&quot;\n  Cheats: &quot;)) lb.shrink(&quot;, &quot;);</span>
<span class="nc" id="L616">    }</span>

    /**
     * Cheat-build a unit in Europe.
     *
     * @param rc A list of random choices to choose from.
     * @param what A description of the unit.
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     * @return The &lt;code&gt;AIUnit&lt;/code&gt; built.
     */
    private AIUnit cheatUnit(List&lt;RandomChoice&lt;UnitType&gt;&gt; rc, String what,
                             LogBuilder lb) {
<span class="nc" id="L628">        UnitType unitToPurchase</span>
<span class="nc" id="L629">            = RandomChoice.getWeightedRandom(logger, &quot;Cheat which unit&quot;,</span>
<span class="nc" id="L630">                                             rc, getAIRandom());</span>
<span class="nc bnc" id="L631" title="All 2 branches missed.">        return (unitToPurchase == null) ? null</span>
<span class="nc" id="L632">            : cheatUnit(unitToPurchase, what, lb);</span>
    }

    /**
     * Cheat-build a unit in Europe.
     *
     * @param unitType The &lt;code&gt;UnitType&lt;/code&gt; to build.
     * @param what A description of the unit.
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     * @return The &lt;code&gt;AIUnit&lt;/code&gt; built.
     */
    private AIUnit cheatUnit(UnitType unitType, String what, LogBuilder lb) {
<span class="nc" id="L644">        final Player player = getPlayer();</span>
<span class="nc" id="L645">        final Europe europe = player.getEurope();</span>
<span class="nc" id="L646">        int cost = europe.getUnitPrice(unitType);</span>
<span class="nc" id="L647">        cheatGold(cost, lb);</span>
<span class="nc" id="L648">        AIUnit result = trainAIUnitInEurope(unitType);</span>
<span class="nc" id="L649">        lb.add(&quot; to build &quot;, what, &quot; &quot;, unitType.getSuffix(),</span>
<span class="nc bnc" id="L650" title="All 2 branches missed.">            ((result != null) ? &quot;&quot; : &quot;(failed)&quot;), &quot;, &quot;);</span>
<span class="nc bnc" id="L651" title="All 2 branches missed.">        if (result == null) return null;</span>
<span class="nc" id="L652">        player.logCheat(&quot;Build &quot; + result.getUnit());</span>
<span class="nc" id="L653">        return result;</span>
    }

    /**
     * Assign transportable units and goods to available carriers.
     *
     * These supply driven assignments supplement the demand driven
     * calls inside TransportMission.
     *
     * @param transportables A list of &lt;code&gt;TransportableAIObject&lt;/code&gt;s to
     *     allocated transport for.
     * @param missions A list of &lt;code&gt;TransportMission&lt;/code&gt;s to potentially
     *     assign more transportables to.
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     */
    public void allocateTransportables(List&lt;TransportableAIObject&gt; transportables,
                                        List&lt;TransportMission&gt; missions,
                                        LogBuilder lb) {
<span class="nc bnc" id="L671" title="All 2 branches missed.">        if (transportables.isEmpty()) return;</span>
<span class="nc bnc" id="L672" title="All 2 branches missed.">        if (missions.isEmpty()) return;</span>

<span class="nc" id="L674">        lb.add(&quot;\n  Allocate Transport cargo=&quot;, transportables.size(),</span>
<span class="nc" id="L675">               &quot; carriers=&quot;, missions.size());</span>
        //for (TransportableAIObject t : urgent) lb.add(&quot; &quot;, t);
        //lb.add(&quot; -&gt;&quot;);
        //for (Mission m : missions) lb.add(&quot; &quot;, m);

<span class="nc" id="L680">        LogBuilder lb2 = new LogBuilder(0);</span>
        TransportMission best;
        float bestValue;
        boolean present;
<span class="nc" id="L684">        int i = 0;</span>
<span class="nc bnc" id="L685" title="All 2 branches missed.">        outer: while (i &lt; transportables.size()) {</span>
<span class="nc bnc" id="L686" title="All 2 branches missed.">            if (missions.isEmpty()) break;</span>
<span class="nc" id="L687">            TransportableAIObject t = transportables.get(i);</span>
<span class="nc" id="L688">            lb.add(&quot; for &quot;, t);</span>
<span class="nc" id="L689">            best = null;</span>
<span class="nc" id="L690">            bestValue = 0.0f;</span>
<span class="nc" id="L691">            present = false;</span>
<span class="nc bnc" id="L692" title="All 2 branches missed.">            for (TransportMission tm : missions) {</span>
<span class="nc bnc" id="L693" title="All 2 branches missed.">                if (!tm.spaceAvailable(t)) continue;</span>
<span class="nc" id="L694">                Cargo cargo = tm.makeCargo(t, lb2);</span>
<span class="nc bnc" id="L695" title="All 2 branches missed.">                if (cargo == null) { // Serious problem with this cargo</span>
<span class="nc" id="L696">                    transportables.remove(i);</span>
<span class="nc" id="L697">                    continue outer;</span>
                }
<span class="nc" id="L699">                int turns = cargo.getTurns();</span>
                float value;
<span class="nc bnc" id="L701" title="All 2 branches missed.">                if (turns == 0) {</span>
<span class="nc" id="L702">                    value = tm.destinationCapacity();</span>
<span class="nc bnc" id="L703" title="All 2 branches missed.">                    if (!present) bestValue = 0.0f; // reset</span>
<span class="nc" id="L704">                    present = true;</span>
<span class="nc" id="L705">                } else {</span>
<span class="nc bnc" id="L706" title="All 2 branches missed.">                    value = (present) ? -1.0f</span>
<span class="nc" id="L707">                        : (float)t.getTransportPriority() / turns;</span>
                }
<span class="nc bnc" id="L709" title="All 2 branches missed.">                if (bestValue &lt; value) {</span>
<span class="nc" id="L710">                    bestValue = value;</span>
<span class="nc" id="L711">                    best = tm;</span>
                }
            }
<span class="nc bnc" id="L714" title="All 2 branches missed.">            if (best == null) {</span>
<span class="nc" id="L715">                lb.add(&quot; nothing found&quot;);</span>
<span class="nc" id="L716">            } else {</span>
<span class="nc" id="L717">                lb.add(&quot; &quot;, best.getUnit(), &quot; chosen&quot;);</span>
<span class="nc bnc" id="L718" title="All 2 branches missed.">                if (best.queueTransportable(t, false, lb)) {</span>
<span class="nc" id="L719">                    claimTransportable(t);</span>
<span class="nc bnc" id="L720" title="All 2 branches missed.">                    if (best.destinationCapacity() &lt;= 0) {</span>
<span class="nc" id="L721">                        missions.remove(best);</span>
                    }
<span class="nc" id="L723">                } else {</span>
<span class="nc" id="L724">                    missions.remove(best);</span>
                }
            }
<span class="nc" id="L727">            i++;</span>
        }
<span class="nc" id="L729">    }</span>

    /**
     * Brings gifts to nice players with nearby colonies.
     *
     * FIXME: European players can also bring gifts!  However, this
     * might be folded into a trade mission, since European gifts are
     * just a special case of trading.
     *
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     */
    private void bringGifts(LogBuilder lb) {
<span class="nc" id="L741">        return;</span>
    }

    /**
     * Demands goods from players with nearby colonies.
     *
     * FIXME: European players can also demand tribute!
     *
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     */
    private void demandTribute(LogBuilder lb) {
<span class="nc" id="L752">        return;</span>
    }


    // Tile Improvement handling

    /**
     * Rebuilds a map of locations to TileImprovementPlans.
     *
     * Called by startWorking at the start of every turn.
     * Public for the test suite.
     *
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     */
    public void buildTipMap(LogBuilder lb) {
<span class="nc" id="L767">        tipMap.clear();</span>
<span class="nc bnc" id="L768" title="All 2 branches missed.">        for (AIColony aic : getAIColonies()) {</span>
<span class="nc bnc" id="L769" title="All 2 branches missed.">            for (TileImprovementPlan tip : aic.getTileImprovementPlans()) {</span>
<span class="nc bnc" id="L770" title="All 4 branches missed.">                if (tip == null || tip.isComplete()) {</span>
<span class="nc" id="L771">                    aic.removeTileImprovementPlan(tip);</span>
<span class="nc bnc" id="L772" title="All 2 branches missed.">                } else if (tip.getPioneer() != null) {</span>
                    // Do nothing, remove when complete
<span class="nc bnc" id="L774" title="All 2 branches missed.">                } else if (!tip.validate()) {</span>
<span class="nc" id="L775">                    aic.removeTileImprovementPlan(tip);</span>
<span class="nc" id="L776">                    tip.dispose();</span>
<span class="nc bnc" id="L777" title="All 2 branches missed.">                } else if (tip.getTarget() == null) {</span>
<span class="nc" id="L778">                    logger.warning(&quot;No target for tip: &quot; + tip);</span>
<span class="nc" id="L779">                } else {</span>
<span class="nc" id="L780">                    TileImprovementPlan other = tipMap.get(tip.getTarget());</span>
<span class="nc bnc" id="L781" title="All 4 branches missed.">                    if (other == null || other.getValue() &lt; tip.getValue()) {</span>
<span class="nc" id="L782">                        tipMap.put(tip.getTarget(), tip);</span>
                    }
                }
            }
        }
<span class="nc bnc" id="L787" title="All 2 branches missed.">        if (!tipMap.isEmpty()) {</span>
<span class="nc" id="L788">            lb.add(&quot;\n  Improvements:&quot;);</span>
<span class="nc bnc" id="L789" title="All 2 branches missed.">            for (Tile t : tipMap.keySet()) {</span>
<span class="nc" id="L790">                TileImprovementPlan tip = tipMap.get(t);</span>
<span class="nc" id="L791">                AIUnit pioneer = tip.getPioneer();</span>
<span class="nc" id="L792">                lb.add(&quot; &quot;, t, &quot;=&quot;, tip.getType().getSuffix());</span>
<span class="nc bnc" id="L793" title="All 2 branches missed.">                if (pioneer != null) lb.add(&quot;/&quot;, pioneer.getUnit());</span>
            }
        }                
<span class="nc" id="L796">    }</span>

    /**
     * Update the tip map with tips from a new colony.
     *
     * @param aic The new &lt;code&gt;AIColony&lt;/code&gt;.
     */
    private void updateTipMap(AIColony aic) {
<span class="nc bnc" id="L804" title="All 2 branches missed.">        for (TileImprovementPlan tip : aic.getTileImprovementPlans()) {</span>
<span class="nc" id="L805">            tipMap.put(tip.getTarget(), tip);</span>
        }
<span class="nc" id="L807">    }</span>

    /**
     * Gets the best plan for a tile from the tipMap.
     *
     * @param tile The &lt;code&gt;Tile&lt;/code&gt; to lookup.
     * @return The best plan for a tile.
     */
    public TileImprovementPlan getBestPlan(Tile tile) {
<span class="nc bnc" id="L816" title="All 2 branches missed.">        return (tipMap == null) ? null : tipMap.get(tile);</span>
    }

    /**
     * Gets the best plan for a colony from the tipMap.
     *
     * @param colony The &lt;code&gt;Colony&lt;/code&gt; to check.
     * @return The tile with the best plan for a colony, or null if none found.
     */
    public Tile getBestPlanTile(Colony colony) {
<span class="nc" id="L826">        final Comparator&lt;TileImprovementPlan&gt; comp</span>
<span class="nc" id="L827">            = Comparator.comparingInt(TileImprovementPlan::getValue);</span>
<span class="nc" id="L828">        TileImprovementPlan best</span>
<span class="nc" id="L829">            = maximize(map(colony.getOwnedTiles(), t -&gt; tipMap.get(t)),</span>
<span class="nc bnc" id="L830" title="All 2 branches missed.">                       tip -&gt; tip != null, comp);</span>
<span class="nc bnc" id="L831" title="All 2 branches missed.">        return (best == null) ? null : best.getTarget();</span>
    }

    /**
     * Remove a &lt;code&gt;TileImprovementPlan&lt;/code&gt; from the relevant colony.
     *
     * @param plan The &lt;code&gt;TileImprovementPlan&lt;/code&gt; to remove.
     */
    public void removeTileImprovementPlan(TileImprovementPlan plan) {
<span class="nc bnc" id="L840" title="All 2 branches missed.">        if (plan == null) return;</span>
<span class="nc bnc" id="L841" title="All 2 branches missed.">        if (plan.getTarget() != null) tipMap.remove(plan.getTarget());</span>
<span class="nc bnc" id="L842" title="All 2 branches missed.">        for (AIColony aic : getAIColonies()) {</span>
<span class="nc bnc" id="L843" title="All 2 branches missed.">            if (aic.removeTileImprovementPlan(plan)) break;</span>
        }
<span class="nc" id="L845">    }</span>


    // Transport handling

    /**
     * Update the transport of a unit following a target change.
     *
     * If the target has changed
     * - drop all non-boarded transport unless the target is the same
     * - dump boarded transport with no target
     * - requeue all boarded transport unless the target is the same
     *
     * @param aiu The &lt;code&gt;AIUnit&lt;/code&gt; to check.
     * @param oldTarget The old target &lt;code&gt;Location&lt;/code&gt;.
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     */
    public void updateTransport(AIUnit aiu, Location oldTarget, LogBuilder lb) {
<span class="nc" id="L863">        final AIUnit aiCarrier = aiu.getTransport();</span>
<span class="nc" id="L864">        final Mission newMission = aiu.getMission();</span>
<span class="nc bnc" id="L865" title="All 2 branches missed.">        final Location newTarget = (newMission == null) ? null</span>
<span class="nc" id="L866">            : newMission.getTarget();</span>
        TransportMission tm;
<span class="nc bnc" id="L868" title="All 2 branches missed.">        if (aiCarrier != null</span>
<span class="nc bnc" id="L869" title="All 2 branches missed.">            &amp;&amp; (tm = aiCarrier.getMission(TransportMission.class)) != null</span>
<span class="nc bnc" id="L870" title="All 2 branches missed.">            &amp;&amp; !Map.isSameLocation(oldTarget, newTarget)) {</span>
<span class="nc bnc" id="L871" title="All 2 branches missed.">            if (aiu.getUnit().getLocation() != aiCarrier.getUnit()) {</span>
<span class="nc" id="L872">                lb.add(&quot;, drop transport &quot;, aiCarrier.getUnit());</span>
<span class="nc" id="L873">                aiu.dropTransport();</span>
<span class="nc bnc" id="L874" title="All 2 branches missed.">            } else if (newTarget == null) {</span>
<span class="nc" id="L875">                tm.dumpTransportable(aiu, lb);</span>
<span class="nc" id="L876">            } else {</span>
<span class="nc" id="L877">                tm.requeueTransportable(aiu, lb);</span>
            }
        }
<span class="nc" id="L880">    }</span>

    /**
     * Checks if a transportable needs transport.
     *
     * @param t The &lt;code&gt;TransportableAIObject&lt;/code&gt; to check.
     * @return True if no transport is already present or the
     *     transportable is already aboard a carrier, and there is a
     *     well defined source and destination location.
     */
    private boolean requestsTransport(TransportableAIObject t) {
<span class="nc bnc" id="L891" title="All 2 branches missed.">        return t.getTransport() == null</span>
<span class="nc bnc" id="L892" title="All 2 branches missed.">            &amp;&amp; t.getTransportDestination() != null</span>
<span class="nc bnc" id="L893" title="All 2 branches missed.">            &amp;&amp; t.getTransportSource() != null</span>
<span class="nc bnc" id="L894" title="All 2 branches missed.">            &amp;&amp; !(t.getLocation() instanceof Unit);</span>
    }

    /**
     * Checks that the carrier assigned to a transportable is has a
     * transport mission and the transport is queued thereon.
     *
     * @param t The &lt;code&gt;TransportableAIObject&lt;/code&gt; to check.
     * @return True if all is well.
     */
    private boolean checkTransport(TransportableAIObject t) {
<span class="nc" id="L905">        AIUnit aiCarrier = t.getTransport();</span>
<span class="nc bnc" id="L906" title="All 2 branches missed.">        if (aiCarrier == null) return false;</span>
<span class="nc" id="L907">        TransportMission tm = aiCarrier.getMission(TransportMission.class);</span>
<span class="nc bnc" id="L908" title="All 4 branches missed.">        if (tm != null &amp;&amp; tm.isTransporting(t)) return true;</span>
<span class="nc" id="L909">        t.changeTransport(null);</span>
<span class="nc" id="L910">        return false;</span>
    }

    /**
     * Gets the needed wagons for a tile/contiguity.
     *
     * @param tile The &lt;code&gt;Tile&lt;/code&gt; to derive the contiguity from.
     * @return The number of wagons needed.
     */
    public int getNeededWagons(Tile tile) {
<span class="nc bnc" id="L920" title="All 2 branches missed.">        if (tile != null) {</span>
<span class="nc" id="L921">            int contig = tile.getContiguity();</span>
<span class="nc bnc" id="L922" title="All 2 branches missed.">            if (contig &gt; 0) {</span>
<span class="nc" id="L923">                Integer i = wagonsNeeded.get(contig);</span>
<span class="nc bnc" id="L924" title="All 2 branches missed.">                if (i != null) return i;</span>
            }
        }
<span class="nc" id="L927">        return 0;</span>
    }

    /**
     * Changes the needed wagons map for a specified tile/contiguity.
     * If the change is zero, that is a special flag that a connected
     * port is available, and thus that the map should be initialized
     * for that contiguity.
     *
     * @param tile The &lt;code&gt;Tile&lt;/code&gt; to derive the contiguity from.
     * @param amount The change to make.
     */
    private void changeNeedWagon(Tile tile, int amount) {
<span class="nc bnc" id="L940" title="All 2 branches missed.">        if (tile == null) return;</span>
<span class="nc" id="L941">        int contig = tile.getContiguity();</span>
<span class="nc bnc" id="L942" title="All 2 branches missed.">        if (contig &gt; 0) {</span>
<span class="nc" id="L943">            Integer i = wagonsNeeded.get(contig);</span>
<span class="nc bnc" id="L944" title="All 2 branches missed.">            if (i == null) {</span>
<span class="nc bnc" id="L945" title="All 2 branches missed.">                if (amount == 0) wagonsNeeded.put(contig, 0);</span>
<span class="nc" id="L946">            } else {</span>
<span class="nc" id="L947">                wagonsNeeded.put(contig, i + amount);</span>
            }
        }
<span class="nc" id="L950">    }</span>

    /**
     * Rebuild the transport maps.
     * Count the number of transports requiring naval/land carriers.
     *
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     */
    private void buildTransportMaps(LogBuilder lb) {
<span class="nc" id="L959">        transportDemand.clear();</span>
<span class="nc" id="L960">        transportSupply.clear();</span>
<span class="nc" id="L961">        wagonsNeeded.clear();</span>
<span class="nc" id="L962">        nNavalCarrier = 0;</span>

        // Prime the wagonsNeeded map with contiguities with a connected port
<span class="nc bnc" id="L965" title="All 2 branches missed.">        for (AIColony aic : getAIColonies()) {</span>
<span class="nc" id="L966">            Colony colony = aic.getColony();</span>
<span class="nc bnc" id="L967" title="All 2 branches missed.">            if (colony.isConnectedPort()) changeNeedWagon(colony.getTile(), 0);</span>
        }

<span class="nc bnc" id="L970" title="All 2 branches missed.">        for (AIUnit aiu : getAIUnits()) {</span>
<span class="nc bnc" id="L971" title="All 4 branches missed.">            if (aiu.hasMission() &amp;&amp; !aiu.getMission().isValid()) continue;</span>
<span class="nc" id="L972">            Unit u = aiu.getUnit();</span>
<span class="nc bnc" id="L973" title="All 2 branches missed.">            if (u.isCarrier()) {</span>
<span class="nc bnc" id="L974" title="All 2 branches missed.">                if (u.isNaval()) {</span>
<span class="nc" id="L975">                    nNavalCarrier--;</span>
<span class="nc" id="L976">                } else {</span>
<span class="nc" id="L977">                    changeNeedWagon(u.getTile(), -1);</span>
                }
<span class="nc" id="L979">            } else {</span>
<span class="nc" id="L980">                checkTransport(aiu);</span>
<span class="nc bnc" id="L981" title="All 2 branches missed.">                if (requestsTransport(aiu)) {</span>
<span class="nc" id="L982">                    transportSupply.add(aiu);</span>
<span class="nc" id="L983">                    aiu.incrementTransportPriority();</span>
<span class="nc" id="L984">                    nNavalCarrier++;</span>
                }
            }
        }

<span class="nc bnc" id="L989" title="All 2 branches missed.">        for (AIColony aic : getAIColonies()) {</span>
<span class="nc bnc" id="L990" title="All 2 branches missed.">            for (AIGoods aig : aic.getExportGoods()) {</span>
<span class="nc" id="L991">                checkTransport(aig);</span>
<span class="nc bnc" id="L992" title="All 2 branches missed.">                if (requestsTransport(aig)) {</span>
<span class="nc" id="L993">                    transportSupply.add(aig);</span>
<span class="nc" id="L994">                    aig.incrementTransportPriority();</span>
<span class="nc" id="L995">                    Location src = aig.getTransportSource();</span>
<span class="nc" id="L996">                    Location dst = aig.getTransportDestination();</span>
<span class="nc bnc" id="L997" title="All 2 branches missed.">                    if (!Map.isSameContiguity(src, dst)) {</span>
<span class="nc" id="L998">                        nNavalCarrier++;</span>
                    }
                }
            }
<span class="nc" id="L1002">            Colony colony = aic.getColony();</span>
<span class="nc bnc" id="L1003" title="All 2 branches missed.">            if (!colony.isConnectedPort()) {</span>
<span class="nc" id="L1004">                changeNeedWagon(colony.getTile(), 1);</span>
            }
        }

<span class="nc bnc" id="L1008" title="All 2 branches missed.">        for (Wish w : getWishes()) {</span>
<span class="nc" id="L1009">            TransportableAIObject t = w.getTransportable();</span>
<span class="nc bnc" id="L1010" title="All 4 branches missed.">            if (t != null &amp;&amp; t.getTransport() == null</span>
<span class="nc bnc" id="L1011" title="All 2 branches missed.">                &amp;&amp; t.getTransportDestination() != null) {</span>
<span class="nc" id="L1012">                Location loc = Location.upLoc(t.getTransportDestination());</span>
<span class="nc" id="L1013">                appendToMapList(transportDemand, loc, w);</span>
            }
        }

<span class="nc bnc" id="L1017" title="All 2 branches missed.">        if (!transportSupply.isEmpty()) {</span>
<span class="nc" id="L1018">            lb.add(&quot;\n  Transport Supply:&quot;);</span>
<span class="nc bnc" id="L1019" title="All 2 branches missed.">            for (TransportableAIObject t : transportSupply) {</span>
<span class="nc" id="L1020">                lb.add(&quot; &quot;, t.getTransportPriority(), &quot;+&quot;, t);</span>
            }
        }
<span class="nc bnc" id="L1023" title="All 2 branches missed.">        if (!transportDemand.isEmpty()) {</span>
<span class="nc" id="L1024">            lb.add(&quot;\n  Transport Demand:&quot;);</span>
<span class="nc bnc" id="L1025" title="All 2 branches missed.">            for (Location ld : transportDemand.keySet()) {</span>
<span class="nc" id="L1026">                lb.add(&quot;\n    &quot;, ld, &quot;[&quot;);</span>
<span class="nc bnc" id="L1027" title="All 2 branches missed.">                for (Wish w : transportDemand.get(ld)) lb.add(&quot; &quot;, w);</span>
<span class="nc" id="L1028">                lb.add(&quot; ]&quot;);</span>
            }
        }
<span class="nc" id="L1031">    }</span>

    /**
     * Gets the most urgent transportables.
     *
     * @return The most urgent 10% of the available transportables.
     */
    public List&lt;TransportableAIObject&gt; getUrgentTransportables() {
<span class="nc" id="L1039">        List&lt;TransportableAIObject&gt; urgent = new ArrayList&lt;&gt;(transportSupply);</span>
        // Do not let the list exceed 10% of all transports
<span class="nc" id="L1041">        Collections.sort(urgent);</span>
<span class="nc" id="L1042">        int urge = urgent.size();</span>
<span class="nc" id="L1043">        urge = Math.max(2, (urge + 5) / 10);</span>
<span class="nc bnc" id="L1044" title="All 2 branches missed.">        while (urgent.size() &gt; urge) urgent.remove(urge);</span>
<span class="nc" id="L1045">        return urgent;</span>
    }

    /**
     * Allows a TransportMission to signal that it has taken responsibility
     * for a TransportableAIObject.
     *
     * @param t The &lt;code&gt;TransportableAIObject&lt;/code&gt; being claimed.
     * @return True if the transportable was claimed from the supply map.
     */
    public boolean claimTransportable(TransportableAIObject t) {
<span class="nc" id="L1056">        return transportSupply.remove(t);</span>
    }

    /**
     * Rearrange colonies, collecting workers that now need a
     * WorkInsideColonyMission.
     *
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     * @return A collection of &lt;code&gt;AIUnit&lt;/code&gt;s that need work.
     */
    private Collection&lt;AIUnit&gt; rearrangeColonies(LogBuilder lb) {
<span class="nc" id="L1067">        Set&lt;AIUnit&gt; workers = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L1068" title="All 2 branches missed.">        for (AIColony aic : getAIColonies()) {</span>
<span class="nc" id="L1069">            workers.addAll(aic.rearrangeWorkers(lb));</span>
        }
<span class="nc" id="L1071">        return workers;</span>
    }


    // Wish handling

    /**
     * Suppress European trade in a goods type.  A goods party and
     * boycott is incoming.
     *
     * @param type The &lt;code&gt;GoodsType&lt;/code&gt; to suppress.
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     */
    private void suppressEuropeanTrade(GoodsType type, LogBuilder lb) {
<span class="nc" id="L1085">        final Player player = getPlayer();</span>
<span class="nc" id="L1086">        final Europe europe = player.getEurope();</span>

<span class="nc" id="L1088">        lb.add(&quot;  Suppressing trade in &quot;, type.getSuffix());</span>
<span class="nc" id="L1089">        List&lt;Unit&gt; units = new ArrayList&lt;&gt;(europe.getUnitList());</span>
<span class="nc" id="L1090">        units.addAll(player.getHighSeas().getUnitList());</span>
<span class="nc bnc" id="L1091" title="All 2 branches missed.">        for (Unit u : units) {</span>
            int amount;
            AIUnit aiu;
<span class="nc bnc" id="L1094" title="All 4 branches missed.">            if (u.isCarrier() &amp;&amp; (amount = u.getGoodsCount(type)) &gt; 0</span>
<span class="nc bnc" id="L1095" title="All 2 branches missed.">                &amp;&amp; (aiu = getAIUnit(u)) != null</span>
<span class="nc bnc" id="L1096" title="All 2 branches missed.">                &amp;&amp; AIMessage.askUnloadGoods(type, amount, aiu)) {</span>
<span class="nc" id="L1097">                lb.add(&quot;, &quot;, u, &quot; sold &quot;, amount);</span>
            }
        }
<span class="nc bnc" id="L1100" title="All 2 branches missed.">        for (AIUnit aiu : getAIUnits()) {</span>
<span class="nc" id="L1101">            TransportMission tm = aiu.getMission(TransportMission.class);</span>
<span class="nc bnc" id="L1102" title="All 2 branches missed.">            if (tm != null) tm.suppressEuropeanTrade(type, lb);</span>
        }           

<span class="nc" id="L1105">        int n = 0;</span>
<span class="nc" id="L1106">        List&lt;GoodsWish&gt; wishes = goodsWishes.get(type);</span>
<span class="nc bnc" id="L1107" title="All 2 branches missed.">        if (wishes != null) {</span>
<span class="nc bnc" id="L1108" title="All 2 branches missed.">            for (GoodsWish gw : wishes) {</span>
<span class="nc bnc" id="L1109" title="All 2 branches missed.">                if (gw.getGoodsType() == type</span>
<span class="nc bnc" id="L1110" title="All 2 branches missed.">                    &amp;&amp; gw.getDestination() == europe) {</span>
<span class="nc bnc" id="L1111" title="All 2 branches missed.">                    if (gw.getTransportable() instanceof AIGoods) {</span>
<span class="nc" id="L1112">                        AIGoods aig = (AIGoods)gw.getTransportable();</span>
<span class="nc" id="L1113">                        consumeGoodsWish(aig, gw);</span>
<span class="nc" id="L1114">                        aig.setTransportDestination(null);</span>
                    }
<span class="nc" id="L1116">                    gw.dispose();</span>
<span class="nc" id="L1117">                    n++;</span>
                }
            }
<span class="nc bnc" id="L1120" title="All 2 branches missed.">            if (n &gt; 0) lb.add(&quot;, dropped &quot;, n, &quot; goods wishes&quot;);</span>
        }
<span class="nc" id="L1122">        lb.add(&quot;.&quot;);</span>
<span class="nc" id="L1123">    }</span>
                
    /**
     * Gets a list of the wishes at a given location for a unit type.
     *
     * @param loc The &lt;code&gt;Location&lt;/code&gt; to look for wishes at.
     * @param type The &lt;code&gt;UnitType&lt;/code&gt; to look for.
     * @return A list of &lt;code&gt;WorkerWish&lt;/code&gt;es.
     */
    public List&lt;WorkerWish&gt; getWorkerWishesAt(Location loc, UnitType type) {
<span class="nc" id="L1133">        List&lt;Wish&gt; demand = transportDemand.get(Location.upLoc(loc));</span>
<span class="nc bnc" id="L1134" title="All 2 branches missed.">        return (demand == null) ? Collections.&lt;WorkerWish&gt;emptyList()</span>
<span class="nc" id="L1135">            : transform(demand,</span>
<span class="nc bnc" id="L1136" title="All 2 branches missed.">                        w -&gt; w instanceof WorkerWish</span>
<span class="nc bnc" id="L1137" title="All 2 branches missed.">                            &amp;&amp; ((WorkerWish)w).getUnitType() == type,</span>
<span class="nc" id="L1138">                        w -&gt; (WorkerWish)w, Collectors.toList());</span>
    }

    /**
     * Gets a list of the wishes at a given location for a goods type.
     *
     * @param loc The &lt;code&gt;Location&lt;/code&gt; to look for wishes at.
     * @param type The &lt;code&gt;GoodsType&lt;/code&gt; to look for.
     * @return A list of &lt;code&gt;GoodsWish&lt;/code&gt;es.
     */
    public List&lt;GoodsWish&gt; getGoodsWishesAt(Location loc, GoodsType type) {
<span class="nc" id="L1149">        List&lt;Wish&gt; demand = transportDemand.get(Location.upLoc(loc));</span>
<span class="nc bnc" id="L1150" title="All 2 branches missed.">        return (demand == null) ? Collections.&lt;GoodsWish&gt;emptyList()</span>
<span class="nc" id="L1151">            : transform(demand,</span>
<span class="nc bnc" id="L1152" title="All 2 branches missed.">                        w -&gt; w instanceof GoodsWish</span>
<span class="nc bnc" id="L1153" title="All 2 branches missed.">                            &amp;&amp; ((GoodsWish)w).getGoodsType() == type,</span>
<span class="nc" id="L1154">                        w -&gt; (GoodsWish)w, Collectors.toList());</span>
    }

    /**
     * Gets the best worker wish for a carrier unit.
     *
     * @param aiUnit The carrier &lt;code&gt;AIUnit&lt;/code&gt;.
     * @param unitType The &lt;code&gt;UnitType&lt;/code&gt; to find a wish for.
     * @return The best worker wish for the unit.
     */
    public WorkerWish getBestWorkerWish(AIUnit aiUnit, UnitType unitType) {
<span class="nc" id="L1165">        List&lt;WorkerWish&gt; wishes = workerWishes.get(unitType);</span>
<span class="nc bnc" id="L1166" title="All 2 branches missed.">        if (wishes == null) return null;</span>

<span class="nc" id="L1168">        final Unit carrier = aiUnit.getUnit();</span>
<span class="nc" id="L1169">        WorkerWish carried = null;</span>
<span class="nc" id="L1170">        WorkerWish other = null;</span>
<span class="nc" id="L1171">        double bestCarriedValue = -1.0, bestOtherValue = -1.0;</span>
<span class="nc bnc" id="L1172" title="All 2 branches missed.">        for (WorkerWish w : wishes) {</span>
<span class="nc" id="L1173">            int turns = carrier.getTurnsToReach(w.getDestination());</span>
<span class="nc bnc" id="L1174" title="All 2 branches missed.">            if (turns &lt; Unit.MANY_TURNS) {</span>
<span class="nc bnc" id="L1175" title="All 2 branches missed.">                if (bestCarriedValue &lt; (double)w.getValue() / turns) {</span>
<span class="nc" id="L1176">                    bestCarriedValue = (double)w.getValue() / turns;</span>
<span class="nc" id="L1177">                    carried = w;</span>
                }
<span class="nc" id="L1179">            } else {</span>
<span class="nc bnc" id="L1180" title="All 2 branches missed.">                if (bestOtherValue &lt; w.getValue()) {</span>
<span class="nc" id="L1181">                    bestOtherValue = w.getValue();</span>
<span class="nc" id="L1182">                    other = w;</span>
                }
            }
        }
<span class="nc bnc" id="L1186" title="All 4 branches missed.">        return (carried != null) ? carried : (other != null) ? other : null;</span>
    }

    /**
     * Gets the best goods wish for a carrier unit.
     *
     * @param aiUnit The carrier &lt;code&gt;AIUnit&lt;/code&gt;.
     * @param goodsType The &lt;code&gt;GoodsType&lt;/code&gt; to wish for.
     * @return The best &lt;code&gt;GoodsWish&lt;/code&gt; for the unit.
     */
    public GoodsWish getBestGoodsWish(AIUnit aiUnit, GoodsType goodsType) {
<span class="nc" id="L1197">        final Unit carrier = aiUnit.getUnit();</span>
<span class="nc" id="L1198">        final ToDoubleFunction&lt;GoodsWish&gt; wishValue</span>
<span class="nc" id="L1199">            = cacheDouble(gw -&gt; {</span>
<span class="nc" id="L1200">                    int turns = carrier.getTurnsToReach(carrier.getLocation(),</span>
<span class="nc" id="L1201">                                                        gw.getDestination());</span>
<span class="nc bnc" id="L1202" title="All 2 branches missed.">                    return (turns &gt;= Unit.MANY_TURNS) ? -1.0</span>
<span class="nc" id="L1203">                        : (double)gw.getValue() / turns;</span>
                });
<span class="nc" id="L1205">        final Comparator&lt;GoodsWish&gt; comp</span>
<span class="nc" id="L1206">            = Comparator.comparingDouble(wishValue);</span>

<span class="nc" id="L1208">        List&lt;GoodsWish&gt; wishes = goodsWishes.get(goodsType);</span>
<span class="nc bnc" id="L1209" title="All 2 branches missed.">        return (wishes == null) ? null</span>
<span class="nc bnc" id="L1210" title="All 2 branches missed.">            : maximize(wishes, gw -&gt; wishValue.applyAsDouble(gw) &gt; 0.0, comp);</span>
    }

    /**
     * Rebuilds the goods and worker wishes maps.
     *
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     */
    private void buildWishMaps(LogBuilder lb) {
<span class="nc bnc" id="L1219" title="All 2 branches missed.">        for (UnitType unitType : getSpecification().getUnitTypeList()) {</span>
<span class="nc" id="L1220">            List&lt;WorkerWish&gt; wl = workerWishes.get(unitType);</span>
<span class="nc bnc" id="L1221" title="All 2 branches missed.">            if (wl == null) {</span>
<span class="nc" id="L1222">                workerWishes.put(unitType, new ArrayList&lt;WorkerWish&gt;());</span>
<span class="nc" id="L1223">            } else {</span>
<span class="nc" id="L1224">                wl.clear();</span>
            }
        }
<span class="nc bnc" id="L1227" title="All 2 branches missed.">        for (GoodsType goodsType : getSpecification().getStorableGoodsTypeList()) {</span>
<span class="nc" id="L1228">            List&lt;GoodsWish&gt; gl = goodsWishes.get(goodsType);</span>
<span class="nc bnc" id="L1229" title="All 2 branches missed.">            if (gl == null) {</span>
<span class="nc" id="L1230">                goodsWishes.put(goodsType, new ArrayList&lt;GoodsWish&gt;());</span>
<span class="nc" id="L1231">            } else {</span>
<span class="nc" id="L1232">                gl.clear();</span>
            }
        }

<span class="nc bnc" id="L1236" title="All 2 branches missed.">        for (Wish w : getWishes()) {</span>
<span class="nc bnc" id="L1237" title="All 2 branches missed.">            if (w instanceof WorkerWish) {</span>
<span class="nc" id="L1238">                WorkerWish ww = (WorkerWish)w;</span>
<span class="nc bnc" id="L1239" title="All 2 branches missed.">                if (ww.getTransportable() == null) {</span>
<span class="nc" id="L1240">                    appendToMapList(workerWishes, ww.getUnitType(), ww);</span>
                }
<span class="nc bnc" id="L1242" title="All 2 branches missed.">            } else if (w instanceof GoodsWish) {</span>
<span class="nc" id="L1243">                GoodsWish gw = (GoodsWish)w;</span>
<span class="nc bnc" id="L1244" title="All 2 branches missed.">                if (gw.getDestination() instanceof Colony) {</span>
<span class="nc" id="L1245">                    appendToMapList(goodsWishes, gw.getGoodsType(), gw);</span>
                }
            }
        }

<span class="nc bnc" id="L1250" title="All 2 branches missed.">        if (!workerWishes.isEmpty()) {</span>
<span class="nc" id="L1251">            lb.add(&quot;\n  Wishes (workers):&quot;);</span>
<span class="nc bnc" id="L1252" title="All 2 branches missed.">            for (UnitType ut : workerWishes.keySet()) {</span>
<span class="nc" id="L1253">                List&lt;WorkerWish&gt; wl = workerWishes.get(ut);</span>
<span class="nc bnc" id="L1254" title="All 2 branches missed.">                if (!wl.isEmpty()) {</span>
<span class="nc" id="L1255">                    lb.add(&quot;\n    &quot;, ut.getSuffix(), &quot;:&quot;);</span>
<span class="nc bnc" id="L1256" title="All 2 branches missed.">                    for (WorkerWish ww : wl) {</span>
<span class="nc" id="L1257">                        lb.add(&quot; &quot;, ww.getDestination(),</span>
<span class="nc" id="L1258">                               &quot;(&quot;, ww.getValue(), &quot;)&quot;);</span>
                    }
                }
            }
        }
<span class="nc bnc" id="L1263" title="All 2 branches missed.">        if (!goodsWishes.isEmpty()) {</span>
<span class="nc" id="L1264">            lb.add(&quot;\n  Wishes (goods):&quot;);</span>
<span class="nc bnc" id="L1265" title="All 2 branches missed.">            for (GoodsType gt : goodsWishes.keySet()) {</span>
<span class="nc" id="L1266">                List&lt;GoodsWish&gt; gl = goodsWishes.get(gt);</span>
<span class="nc bnc" id="L1267" title="All 2 branches missed.">                if (!gl.isEmpty()) {</span>
<span class="nc" id="L1268">                    lb.add(&quot;\n    &quot;, gt.getSuffix(), &quot;:&quot;);</span>
<span class="nc bnc" id="L1269" title="All 2 branches missed.">                    for (GoodsWish gw : gl) {</span>
<span class="nc" id="L1270">                        lb.add(&quot; &quot;, gw.getDestination(),</span>
<span class="nc" id="L1271">                               &quot;(&quot;, gw.getValue(), &quot;)&quot;);</span>
                    }
                }
            }
        }
<span class="nc" id="L1276">    }</span>

    /**
     * Notify that a wish has been completed.  Called from AIColony.
     *
     * @param w The &lt;code&gt;Wish&lt;/code&gt; to complete.
     */
    @Override
    public void completeWish(Wish w) {
<span class="nc bnc" id="L1285" title="All 2 branches missed.">        if (w instanceof WorkerWish) {</span>
<span class="nc" id="L1286">            WorkerWish ww = (WorkerWish)w;</span>
<span class="nc" id="L1287">            List&lt;WorkerWish&gt; wl = workerWishes.get(ww.getUnitType());</span>
<span class="nc bnc" id="L1288" title="All 2 branches missed.">            if (wl != null) wl.remove(ww);</span>
<span class="nc bnc" id="L1289" title="All 2 branches missed.">        } else if (w instanceof GoodsWish) {</span>
<span class="nc" id="L1290">            GoodsWish gw = (GoodsWish)w;</span>
<span class="nc" id="L1291">            List&lt;GoodsWish&gt; gl = goodsWishes.get(gw.getGoodsType());</span>
<span class="nc bnc" id="L1292" title="All 2 branches missed.">            if (gl != null) gl.remove(gw);</span>
<span class="nc" id="L1293">        } else {</span>
<span class="nc" id="L1294">            throw new IllegalStateException(&quot;Bogus wish: &quot; + w);</span>
        }
<span class="nc" id="L1296">    }</span>

    /**
     * Consume a WorkerWish, yielding a WishRealizationMission for a unit.
     *
     * @param aiUnit The &lt;code&gt;AIUnit&lt;/code&gt; to check.
     * @param ww The &lt;code&gt;WorkerWish&lt;/code&gt; to consume.
     */
    public void consumeWorkerWish(AIUnit aiUnit, WorkerWish ww) {
<span class="nc" id="L1305">        final Unit unit = aiUnit.getUnit();</span>
<span class="nc" id="L1306">        List&lt;WorkerWish&gt; wwL = workerWishes.get(unit.getType());</span>
<span class="nc" id="L1307">        wwL.remove(ww);</span>
<span class="nc" id="L1308">        List&lt;Wish&gt; wl = transportDemand.get(ww.getDestination());</span>
<span class="nc bnc" id="L1309" title="All 2 branches missed.">        if (wl != null) wl.remove(ww);</span>
<span class="nc" id="L1310">        ww.setTransportable(aiUnit);</span>
<span class="nc" id="L1311">    }</span>

    /**
     * Consume a GoodsWish.
     *
     * @param aig The &lt;code&gt;AIGoods&lt;/code&gt; to use.
     * @param gw The &lt;code&gt;GoodsWish&lt;/code&gt; to consume.
     */
    public void consumeGoodsWish(AIGoods aig, GoodsWish gw) {
<span class="nc" id="L1320">        final Goods goods = aig.getGoods();</span>
<span class="nc" id="L1321">        List&lt;GoodsWish&gt; gwL = goodsWishes.get(goods.getType());</span>
<span class="nc" id="L1322">        gwL.remove(gw);</span>
<span class="nc" id="L1323">        List&lt;Wish&gt; wl = transportDemand.get(gw.getDestination());</span>
<span class="nc bnc" id="L1324" title="All 2 branches missed.">        if (wl != null) wl.remove(gw);</span>
<span class="nc" id="L1325">        gw.setTransportable(aig);</span>
<span class="nc" id="L1326">    }</span>


    // Useful public routines

    /**
     * Gets the number of units that should build a colony.
     *
     * This is the desired total number, not the actual number which would
     * take into account the number of existing BuildColonyMissions.
     *
     * @return The desired number of colony builders for this player.
     */
    public int buildersNeeded() {
<span class="nc" id="L1340">        Player player = getPlayer();</span>
<span class="nc bnc" id="L1341" title="All 2 branches missed.">        if (!player.canBuildColonies()) return 0;</span>

<span class="nc" id="L1343">        int nColonies = 0, nPorts = 0, nWorkers = 0, nEuropean = 0;</span>
<span class="nc bnc" id="L1344" title="All 2 branches missed.">        for (Settlement settlement : player.getSettlements()) {</span>
<span class="nc" id="L1345">            nColonies++;</span>
<span class="nc bnc" id="L1346" title="All 2 branches missed.">            if (settlement.isConnectedPort()) nPorts++;</span>
<span class="nc bnc" id="L1347" title="All 2 branches missed.">            for (Unit u : settlement.getUnitList()) {</span>
<span class="nc bnc" id="L1348" title="All 2 branches missed.">                if (u.isPerson()) nWorkers++;</span>
            }
<span class="nc bnc" id="L1350" title="All 2 branches missed.">            for (Unit u : settlement.getTile().getUnitList()) {</span>
<span class="nc bnc" id="L1351" title="All 2 branches missed.">                if (u.isPerson()) nWorkers++;</span>
            }
        }
<span class="nc" id="L1354">        Europe europe = player.getEurope();</span>
<span class="nc bnc" id="L1355" title="All 2 branches missed.">        nEuropean = (europe == null) ? 0</span>
<span class="nc" id="L1356">            : count(europe.getUnitList(), Unit::isPerson);</span>
            
        // If would be good to have at least two colonies, and at least
        // one port.  After that, determine the ratio of workers to colonies
        // (which should be the average colony size), and if that is above
        // a threshold, send out another colonist.
        // The threshold probably should be configurable.  2 is too
        // low IMHO as it makes a lot of brittle colonies, 3 is too
        // high at least initially as it makes it hard for the initial
        // colonies to become substantial.  For now, arbitrarily choose e.
<span class="nc bnc" id="L1366" title="All 4 branches missed.">        return (nColonies == 0 || nPorts == 0) ? 2</span>
<span class="nc bnc" id="L1367" title="All 4 branches missed.">            : ((nPorts &lt;= 1) &amp;&amp; (nWorkers + nEuropean) &gt;= 3) ? 1</span>
<span class="nc bnc" id="L1368" title="All 2 branches missed.">            : ((double)(nWorkers + nEuropean) / nColonies &gt; Math.E) ? 1</span>
<span class="nc" id="L1369">            : 0;</span>
    }

    /**
     * How many pioneers should we have?
     *
     * This is the desired total number, not the actual number which would
     * take into account the number of existing PioneeringMissions.
     *
     * @return The desired number of pioneers for this player.
     */
    public int pioneersNeeded() {
<span class="nc" id="L1381">        return (tipMap.size() + 1) / 2;</span>
    }

    /**
     * How many scouts should we have?
     *
     * This is the desired total number, not the actual number which would
     * take into account the number of existing ScoutingMissions.
     *
     * Current scheme for European AIs is to use up to three scouts in
     * the early part of the game, then one.
     *
     * @return The desired number of scouts for this player.
     */
    @Override
    public int scoutsNeeded() {
<span class="nc" id="L1397">        return 3 - (getGame().getTurn().getNumber() / 100);</span>
    }

    /**
     * Asks the server to recruit a unit in Europe on behalf of the AIPlayer.
     *
     * FIXME: Move this to a specialized Handler class (AIEurope?)
     * FIXME: Give protected access?
     *
     * @param slot The migration slot to recruit from.
     * @return The new AIUnit created by this action or null on failure.
     */
    public AIUnit recruitAIUnitInEurope(int slot) {
<span class="nc" id="L1410">        AIUnit aiUnit = null;</span>
<span class="nc" id="L1411">        Europe europe = getPlayer().getEurope();</span>
<span class="nc bnc" id="L1412" title="All 2 branches missed.">        if (europe == null) return null;</span>
<span class="nc" id="L1413">        int n = europe.getUnitCount();</span>
<span class="nc" id="L1414">        final String selectAbility = Ability.SELECT_RECRUIT;</span>
<span class="nc bnc" id="L1415" title="All 2 branches missed.">        if (!Europe.MigrationType.validMigrantSlot(slot)) {</span>
<span class="nc bnc" id="L1416" title="All 2 branches missed.">            slot = (getPlayer().hasAbility(selectAbility))</span>
<span class="nc" id="L1417">                ? Europe.MigrationType.getDefaultSlot()</span>
<span class="nc" id="L1418">                : Europe.MigrationType.getUnspecificSlot();</span>
        }
<span class="nc bnc" id="L1420" title="All 2 branches missed.">        if (AIMessage.askEmigrate(this, slot)</span>
<span class="nc bnc" id="L1421" title="All 2 branches missed.">            &amp;&amp; europe.getUnitCount() == n+1) {</span>
<span class="nc" id="L1422">            aiUnit = getAIUnit(europe.getUnitList().get(n));</span>
<span class="nc bnc" id="L1423" title="All 2 branches missed.">            if (aiUnit != null) addAIUnit(aiUnit);</span>
        }
<span class="nc" id="L1425">        return aiUnit;</span>
    }

    /**
     * Helper function for server communication - Ask the server
     * to train a unit in Europe on behalf of the AIGetPlayer().
     *
     * FIXME: Move this to a specialized Handler class (AIEurope?)
     * FIXME: Give protected access?
     *
     * @param unitType The &lt;code&gt;UnitType&lt;/code&gt; to train.
     * @return the new AIUnit created by this action. May be null.
     */
    public AIUnit trainAIUnitInEurope(UnitType unitType) {
<span class="nc bnc" id="L1439" title="All 2 branches missed.">        if (unitType==null) {</span>
<span class="nc" id="L1440">            throw new IllegalArgumentException(&quot;Invalid UnitType.&quot;);</span>
        }

<span class="nc" id="L1443">        AIUnit aiUnit = null;</span>
<span class="nc" id="L1444">        Europe europe = getPlayer().getEurope();</span>
<span class="nc bnc" id="L1445" title="All 2 branches missed.">        if (europe == null) return null;</span>
<span class="nc" id="L1446">        int n = europe.getUnitCount();</span>

<span class="nc bnc" id="L1448" title="All 2 branches missed.">        if (AIMessage.askTrainUnitInEurope(this, unitType)</span>
<span class="nc bnc" id="L1449" title="All 2 branches missed.">            &amp;&amp; europe.getUnitCount() == n+1) {</span>
<span class="nc" id="L1450">            aiUnit = getAIUnit(europe.getUnitList().get(n));</span>
<span class="nc bnc" id="L1451" title="All 2 branches missed.">            if (aiUnit != null) addAIUnit(aiUnit);</span>
        }
<span class="nc" id="L1453">        return aiUnit;</span>
    }

    /**
     * Gets the wishes for all this player's colonies, sorted by the
     * {@link Wish#getValue value}.
     *
     * @return A list of wishes.
     */
    public List&lt;Wish&gt; getWishes() {
<span class="nc" id="L1463">        List&lt;Wish&gt; wishes = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1464" title="All 2 branches missed.">        for (AIColony aic : getAIColonies()) {</span>
<span class="nc" id="L1465">            wishes.addAll(aic.getWishes());</span>
        }
<span class="nc" id="L1467">        Collections.sort(wishes);</span>
<span class="nc" id="L1468">        return wishes;</span>
    }


    // Diplomacy support

    /**
     * Determines the stances towards each player.
     *
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     */
    private void determineStances(LogBuilder lb) {
<span class="nc" id="L1480">        final ServerPlayer serverPlayer = (ServerPlayer)getPlayer();</span>
<span class="nc" id="L1481">        lb.mark();</span>

<span class="nc bnc" id="L1483" title="All 2 branches missed.">        for (Player p : getGame().getLivePlayers(serverPlayer)) {</span>
<span class="nc" id="L1484">            Stance newStance = determineStance(p);</span>
<span class="nc bnc" id="L1485" title="All 2 branches missed.">            if (newStance != serverPlayer.getStance(p)) {</span>
<span class="nc bnc" id="L1486" title="All 4 branches missed.">                if (newStance == Stance.WAR &amp;&amp; peaceHolds(p)) {</span>
                    ; // Peace treaty holds for now
<span class="nc" id="L1488">                } else {</span>
<span class="nc" id="L1489">                    getAIMain().getFreeColServer().getInGameController()</span>
<span class="nc" id="L1490">                        .changeStance(serverPlayer, newStance,</span>
<span class="nc" id="L1491">                                      (ServerPlayer)p, true);</span>
<span class="nc" id="L1492">                    lb.add(&quot; &quot;, p.getDebugName(), &quot;-&gt;&quot;, newStance, &quot;, &quot;);</span>
                }
            }
        }
<span class="nc bnc" id="L1496" title="All 2 branches missed.">        if (lb.grew(&quot;\n  Stance changes:&quot;)) lb.shrink(&quot;, &quot;);</span>
<span class="nc" id="L1497">    }</span>

    /**
     * See if a recent peace treaty still has force.
     *
     * @param p The &lt;code&gt;Player&lt;/code&gt; to check for a peace treaty with.
     * @return True if peace gets another chance.
     */
    private boolean peaceHolds(Player p) {
<span class="nc" id="L1506">        final Player player = getPlayer();</span>
<span class="nc" id="L1507">        final Turn turn = getGame().getTurn();</span>
<span class="nc" id="L1508">        final double peaceProb = getSpecification()</span>
<span class="nc" id="L1509">            .getInteger(GameOptions.PEACE_PROBABILITY) / 100.0;</span>

<span class="nc" id="L1511">        int peaceTurn = -1;</span>
<span class="nc bnc" id="L1512" title="All 2 branches missed.">        for (HistoryEvent h : player.getHistory()) {</span>
<span class="nc bnc" id="L1513" title="All 2 branches missed.">            if (p.getId().equals(h.getPlayerId())</span>
<span class="nc bnc" id="L1514" title="All 2 branches missed.">                &amp;&amp; h.getTurn().getNumber() &gt; peaceTurn) {</span>
<span class="nc bnc" id="L1515" title="All 3 branches missed.">                switch (h.getEventType()) {</span>
                case MAKE_PEACE: case FORM_ALLIANCE:
<span class="nc" id="L1517">                    peaceTurn = h.getTurn().getNumber();</span>
<span class="nc" id="L1518">                    break;</span>
                case DECLARE_WAR:
<span class="nc" id="L1520">                    peaceTurn = -1;</span>
<span class="nc" id="L1521">                    break;</span>
                default:
                    break;
                }
            }
        }
<span class="nc bnc" id="L1527" title="All 2 branches missed.">        if (peaceTurn &lt; 0) return false;</span>

<span class="nc" id="L1529">        int n = turn.getNumber() - peaceTurn;</span>
<span class="nc" id="L1530">        float prob = (float)Math.pow(peaceProb, n);</span>
        // Apply Franklin's modifier
<span class="nc" id="L1532">        prob = p.applyModifiers(prob, turn, Modifier.PEACE_TREATY);</span>
<span class="nc bnc" id="L1533" title="All 4 branches missed.">        return prob &gt; 0.0f</span>
<span class="nc" id="L1534">            &amp;&amp; (randomInt(logger, &quot;Peace holds?&quot;,  getAIRandom(), 100)</span>
<span class="nc" id="L1535">                &lt; (int)(100.0f * prob));</span>
    }


    /**
     * Get a nation summary for another player.
     *
     * @param other The other &lt;code&gt;Player&lt;/code&gt; to get the summary for.
     * @return The current &lt;code&gt;NationSummary&lt;/code&gt; for a player.
     */
    protected NationSummary getNationSummary(Player other) {
<span class="nc" id="L1546">        final Player player = getPlayer();</span>
<span class="nc" id="L1547">        NationSummary ns = player.getNationSummary(other);</span>
<span class="nc bnc" id="L1548" title="All 2 branches missed.">        if (ns != null) return ns;</span>
<span class="nc" id="L1549">        AIMessage.askNationSummary(this, other);</span>
<span class="nc" id="L1550">        return player.getNationSummary(other);</span>
    }

    /**
     * Get the land force strength ratio of this player with respect
     * to another.
     *
     * @param other The other &lt;code&gt;Player&lt;/code&gt;.
     * @return The strength ratio (strength/sum(strengths)).
     */
    protected double getStrengthRatio(Player other) {
<span class="nc" id="L1561">        return getPlayer().getStrengthRatio(other, false);</span>
    }

    /**
     * Is this player lagging in naval strength?  Calculate the ratio
     * of its naval strength to the average strength of other European
     * colonial powers.
     *
     * @return The naval strength ratio, or negative if there are no other
     *     European colonial nations.
     */
    protected double getNavalStrengthRatio() {
<span class="nc" id="L1573">        final Player player = getPlayer();</span>
<span class="nc" id="L1574">        double navalAverage = 0.0;</span>
<span class="nc" id="L1575">        double navalStrength = 0.0;</span>
<span class="nc" id="L1576">        int nPlayers = 0;</span>
<span class="nc bnc" id="L1577" title="All 2 branches missed.">        for (Player p : getGame().getLiveEuropeanPlayers(player)) {</span>
<span class="nc bnc" id="L1578" title="All 2 branches missed.">            if (p.isREF()) continue;</span>
<span class="nc" id="L1579">            NationSummary ns = getNationSummary(p);</span>
<span class="nc bnc" id="L1580" title="All 2 branches missed.">            if (p == player) {</span>
<span class="nc" id="L1581">                navalStrength = ns.getNavalStrength();</span>
<span class="nc" id="L1582">            } else {</span>
<span class="nc" id="L1583">                int st = ns.getNavalStrength();</span>
<span class="nc bnc" id="L1584" title="All 2 branches missed.">                if (st &gt;= 0) navalAverage += st;</span>
<span class="nc" id="L1585">                nPlayers++;</span>
            }
        }
<span class="nc bnc" id="L1588" title="All 4 branches missed.">        if (nPlayers &lt;= 0 || navalStrength &lt; 0) return -1.0;</span>
<span class="nc" id="L1589">        navalAverage /= nPlayers;</span>
<span class="nc bnc" id="L1590" title="All 2 branches missed.">        return (navalAverage == 0.0) ? -1.0 : navalStrength / navalAverage;</span>
    }

    /**
     * Reject a trade agreement, except if a Franklin-derived stance
     * is supplied.
     *
     * @param stance A stance &lt;code&gt;TradeItem&lt;/code&gt;.
     * @param agreement The &lt;code&gt;DiplomaticTrade&lt;/code&gt; to reset.
     * @return The &lt;code&gt;TradeStatus&lt;/code&gt; for the agreement.
     */
    private TradeStatus rejectAgreement(TradeItem stance,
                                        DiplomaticTrade agreement) {
<span class="nc bnc" id="L1603" title="All 2 branches missed.">        if (stance == null) return TradeStatus.REJECT_TRADE;</span>
        
<span class="nc" id="L1605">        agreement.clear();</span>
<span class="nc" id="L1606">        agreement.add(stance);</span>
<span class="nc" id="L1607">        return TradeStatus.PROPOSE_TRADE;</span>
    }


    // Mission handling

    /**
     * Ensures all units have a mission.
     *
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     */
    protected void giveNormalMissions(LogBuilder lb) {
<span class="nc" id="L1619">        final AIMain aiMain = getAIMain();</span>
<span class="nc" id="L1620">        final Player player = getPlayer();</span>
<span class="nc" id="L1621">        java.util.Map&lt;Unit, String&gt; reasons = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1622">        BuildColonyMission bcm = null;</span>
        Mission m;

<span class="nc" id="L1625">        nBuilders = buildersNeeded();</span>
<span class="nc" id="L1626">        nPioneers = pioneersNeeded();</span>
<span class="nc" id="L1627">        nScouts = scoutsNeeded();</span>

<span class="nc" id="L1629">        List&lt;AIUnit&gt; aiUnits = getAIUnits();</span>
<span class="nc" id="L1630">        List&lt;AIUnit&gt; navalUnits = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1631">        List&lt;AIUnit&gt; done = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1632">        List&lt;TransportMission&gt; transportMissions = new ArrayList&lt;&gt;();</span>

        // For all units, check if it is a candidate for a new
        // mission.  If it is not a candidate remove it from the
        // aiUnits list (reporting why not).  Adjust the
        // Build/Pioneer/Scout counts according to the existing valid
        // missions.  Accumulate potentially usable transport missions.
<span class="nc" id="L1639">        lb.mark();</span>
<span class="nc bnc" id="L1640" title="All 2 branches missed.">        for (AIUnit aiUnit : aiUnits) {</span>
<span class="nc" id="L1641">            final Unit unit = aiUnit.getUnit();</span>
<span class="nc" id="L1642">            final Colony colony = unit.getColony();</span>
<span class="nc" id="L1643">            m = aiUnit.getMission();</span>
<span class="nc bnc" id="L1644" title="All 2 branches missed.">            final Location oldTarget = (m == null) ? null : m.getTarget();</span>

<span class="nc bnc" id="L1646" title="All 4 branches missed.">            if (!unit.isInitialized() || unit.isDisposed()) {</span>
<span class="nc" id="L1647">                reasons.put(unit, &quot;Invalid&quot;);</span>

<span class="nc bnc" id="L1649" title="All 2 branches missed.">            } else if (unit.isDamaged()) { // Damaged units must wait</span>
<span class="nc bnc" id="L1650" title="All 2 branches missed.">                if (!(m instanceof IdleAtSettlementMission)) {</span>
<span class="nc bnc" id="L1651" title="All 2 branches missed.">                    if ((m = getIdleAtSettlementMission(aiUnit)) != null) {</span>
<span class="nc" id="L1652">                        lb.add(&quot;, &quot;, m);</span>
                    }
                }
<span class="nc" id="L1655">                reasons.put(unit, &quot;Damaged&quot;);</span>
                    
<span class="nc bnc" id="L1657" title="All 2 branches missed.">            } else if (unit.getState() == UnitState.IN_COLONY</span>
<span class="nc bnc" id="L1658" title="All 2 branches missed.">                &amp;&amp; colony.getUnitCount() &lt;= 1) {</span>
                // The unit has its hand full keeping the colony alive.
<span class="nc bnc" id="L1660" title="All 2 branches missed.">                if (!(m instanceof WorkInsideColonyMission)</span>
<span class="nc bnc" id="L1661" title="All 2 branches missed.">                    &amp;&amp; (m = getWorkInsideColonyMission(aiUnit,</span>
<span class="nc" id="L1662">                            aiMain.getAIColony(colony))) != null) {</span>
<span class="nc" id="L1663">                    logger.warning(aiUnit + &quot; should WorkInsideColony at &quot;</span>
<span class="nc" id="L1664">                        + colony.getName());</span>
<span class="nc" id="L1665">                    lb.add(&quot;, &quot;, m);</span>
<span class="nc" id="L1666">                    updateTransport(aiUnit, oldTarget, lb);</span>
                }
<span class="nc" id="L1668">                reasons.put(unit, &quot;Vital&quot;);</span>

<span class="nc bnc" id="L1670" title="All 2 branches missed.">            } else if (unit.isInMission()) {</span>
<span class="nc" id="L1671">                reasons.put(unit, &quot;Mission&quot;);</span>

<span class="nc bnc" id="L1673" title="All 6 branches missed.">            } else if (m != null &amp;&amp; m.isValid() &amp;&amp; !m.isOneTime()) {</span>
<span class="nc bnc" id="L1674" title="All 2 branches missed.">                if (m instanceof BuildColonyMission) {</span>
<span class="nc" id="L1675">                    bcm = (BuildColonyMission)m;</span>
<span class="nc" id="L1676">                    nBuilders--;</span>
<span class="nc bnc" id="L1677" title="All 2 branches missed.">                } else if (m instanceof PioneeringMission) {</span>
<span class="nc" id="L1678">                    nPioneers--;</span>
<span class="nc bnc" id="L1679" title="All 2 branches missed.">                } else if (m instanceof ScoutingMission) {</span>
<span class="nc" id="L1680">                    nScouts--;</span>
<span class="nc bnc" id="L1681" title="All 2 branches missed.">                } else if (m instanceof TransportMission) {</span>
<span class="nc" id="L1682">                    TransportMission tm = (TransportMission)m;</span>
                    // Consider reassigning quiescent transport
                    // missions to privateer missions
<span class="nc bnc" id="L1685" title="All 4 branches missed.">                    if (tm.isEmpty() &amp;&amp; unit.isNaval()</span>
<span class="nc bnc" id="L1686" title="All 2 branches missed.">                        &amp;&amp; unit.isOffensiveUnit()) {</span>
<span class="nc" id="L1687">                        navalUnits.add(aiUnit);</span>
<span class="nc" id="L1688">                        done.add(aiUnit);</span>
<span class="nc" id="L1689">                        continue;</span>
                    }
                    // If there is capacity in this mission, consider adding
                    // more cargoes
<span class="nc bnc" id="L1693" title="All 2 branches missed.">                    if (tm.destinationCapacity() &gt; 0) {</span>
<span class="nc" id="L1694">                        transportMissions.add(tm);</span>
                    }
<span class="nc bnc" id="L1696" title="All 2 branches missed.">                } else if (m instanceof PrivateerMission) {</span>
<span class="nc bnc" id="L1697" title="All 2 branches missed.">                    if (!(m.getTarget() instanceof Unit)) {</span>
                        // Privateering but not chasing a unit, consider
                        // reassigning to transport.
<span class="nc" id="L1700">                        navalUnits.add(aiUnit);</span>
<span class="nc" id="L1701">                        done.add(aiUnit);</span>
<span class="nc" id="L1702">                        continue;</span>
                    }
                }
<span class="nc" id="L1705">                reasons.put(unit, &quot;Valid&quot;);</span>

<span class="nc bnc" id="L1707" title="All 2 branches missed.">            } else if (unit.isNaval()) {</span>
<span class="nc" id="L1708">                navalUnits.add(aiUnit);</span>

<span class="nc bnc" id="L1710" title="All 2 branches missed.">            } else if (unit.isAtSea()) { // Wait for it to emerge</span>
<span class="nc" id="L1711">                reasons.put(unit, &quot;At-Sea&quot;);</span>

            } else { // Needs mission
                continue;
            }                
<span class="nc" id="L1716">            done.add(aiUnit);</span>
        }
<span class="nc" id="L1718">        aiUnits.removeAll(done);</span>
<span class="nc" id="L1719">        done.clear();</span>

        // First try to satisfy the demand for missions with a defined
        // quota.  Builders first to keep weak players in the game,
        // scouts next as they are profitable.  Pile onto any existing
        // building mission if there are no colonies.
<span class="nc bnc" id="L1725" title="All 4 branches missed.">        if (!player.hasSettlements() &amp;&amp; bcm != null) {</span>
<span class="nc" id="L1726">            final Location bcmTarget = bcm.getTarget();</span>
<span class="nc" id="L1727">            Collections.sort(aiUnits, builderComparator);</span>
<span class="nc bnc" id="L1728" title="All 2 branches missed.">            for (AIUnit aiUnit : aiUnits) {</span>
<span class="nc bnc" id="L1729" title="All 2 branches missed.">                final Location oldTarget = ((m = aiUnit.getMission()) == null)</span>
<span class="nc" id="L1730">                    ? null : m.getTarget();</span>
<span class="nc bnc" id="L1731" title="All 2 branches missed.">                if ((m = getBuildColonyMission(aiUnit, bcmTarget)) == null)</span>
<span class="nc" id="L1732">                    continue;</span>
<span class="nc" id="L1733">                lb.add(&quot;, &quot;, m);</span>
<span class="nc" id="L1734">                updateTransport(aiUnit, oldTarget, lb);</span>
<span class="nc" id="L1735">                done.add(aiUnit);</span>
<span class="nc bnc" id="L1736" title="All 2 branches missed.">                if (requestsTransport(aiUnit)) transportSupply.add(aiUnit);</span>
<span class="nc" id="L1737">                reasons.put(aiUnit.getUnit(), &quot;0Builder&quot;);</span>
            }
<span class="nc" id="L1739">            aiUnits.removeAll(done);</span>
<span class="nc" id="L1740">            done.clear();</span>
        }
<span class="nc bnc" id="L1742" title="All 2 branches missed.">        if (nBuilders &gt; 0) {</span>
<span class="nc" id="L1743">            Collections.sort(aiUnits, builderComparator);</span>
<span class="nc bnc" id="L1744" title="All 2 branches missed.">            for (AIUnit aiUnit : aiUnits) {</span>
<span class="nc bnc" id="L1745" title="All 2 branches missed.">                final Location oldTarget = ((m = aiUnit.getMission()) == null)</span>
<span class="nc" id="L1746">                    ? null : m.getTarget();</span>
<span class="nc bnc" id="L1747" title="All 2 branches missed.">                if ((m = getBuildColonyMission(aiUnit, null)) == null)</span>
<span class="nc" id="L1748">                    continue;</span>
<span class="nc" id="L1749">                lb.add(&quot;, &quot;, m);</span>
<span class="nc" id="L1750">                updateTransport(aiUnit, oldTarget, lb);</span>
<span class="nc" id="L1751">                done.add(aiUnit);</span>
<span class="nc bnc" id="L1752" title="All 2 branches missed.">                if (requestsTransport(aiUnit)) transportSupply.add(aiUnit);</span>
<span class="nc" id="L1753">                reasons.put(aiUnit.getUnit(), &quot;Builder&quot; + nBuilders);</span>
<span class="nc bnc" id="L1754" title="All 2 branches missed.">                if (--nBuilders &lt;= 0) break;</span>
            }
<span class="nc" id="L1756">            aiUnits.removeAll(done);</span>
<span class="nc" id="L1757">            done.clear();</span>
        }
<span class="nc bnc" id="L1759" title="All 2 branches missed.">        if (nScouts &gt; 0) {</span>
<span class="nc" id="L1760">            Collections.sort(aiUnits, scoutComparator);</span>
<span class="nc bnc" id="L1761" title="All 2 branches missed.">            for (AIUnit aiUnit : aiUnits) {</span>
<span class="nc bnc" id="L1762" title="All 2 branches missed.">                final Location oldTarget = ((m = aiUnit.getMission()) == null)</span>
<span class="nc" id="L1763">                    ? null : m.getTarget();</span>
<span class="nc" id="L1764">                final Unit unit = aiUnit.getUnit();</span>
<span class="nc bnc" id="L1765" title="All 2 branches missed.">                if ((m = getScoutingMission(aiUnit)) == null) continue;</span>
<span class="nc" id="L1766">                lb.add(&quot;, &quot;, m);</span>
<span class="nc" id="L1767">                updateTransport(aiUnit, oldTarget, lb);</span>
<span class="nc" id="L1768">                done.add(aiUnit);</span>
<span class="nc bnc" id="L1769" title="All 2 branches missed.">                if (requestsTransport(aiUnit)) transportSupply.add(aiUnit);</span>
<span class="nc" id="L1770">                reasons.put(unit, &quot;Scout&quot; + nScouts);</span>
<span class="nc bnc" id="L1771" title="All 2 branches missed.">                if (--nScouts &lt;= 0) break;</span>
            }
<span class="nc" id="L1773">            aiUnits.removeAll(done);</span>
<span class="nc" id="L1774">            done.clear();</span>
        }
<span class="nc bnc" id="L1776" title="All 2 branches missed.">        if (nPioneers &gt; 0) {</span>
<span class="nc" id="L1777">            Collections.sort(aiUnits, pioneerComparator);</span>
<span class="nc bnc" id="L1778" title="All 2 branches missed.">            for (AIUnit aiUnit : aiUnits) {</span>
<span class="nc" id="L1779">                final Unit unit = aiUnit.getUnit();</span>
<span class="nc bnc" id="L1780" title="All 2 branches missed.">                final Location oldTarget = ((m = aiUnit.getMission()) == null)</span>
<span class="nc" id="L1781">                    ? null : m.getTarget();</span>
<span class="nc bnc" id="L1782" title="All 2 branches missed.">                if ((m = getPioneeringMission(aiUnit, null)) == null) continue;</span>
<span class="nc" id="L1783">                lb.add(&quot;, &quot;, m);</span>
<span class="nc" id="L1784">                updateTransport(aiUnit, oldTarget, lb);</span>
<span class="nc" id="L1785">                done.add(aiUnit);</span>
<span class="nc bnc" id="L1786" title="All 2 branches missed.">                if (requestsTransport(aiUnit)) transportSupply.add(aiUnit);</span>
<span class="nc" id="L1787">                reasons.put(unit, &quot;Pioneer&quot; + nPioneers);</span>
<span class="nc bnc" id="L1788" title="All 2 branches missed.">                if (--nPioneers &lt;= 0) break;</span>
            }
<span class="nc" id="L1790">            aiUnits.removeAll(done);</span>
<span class="nc" id="L1791">            done.clear();</span>
        }

        // Give the remaining land units a valid mission.
<span class="nc bnc" id="L1795" title="All 2 branches missed.">        for (AIUnit aiUnit : aiUnits) {</span>
<span class="nc" id="L1796">            final Unit unit = aiUnit.getUnit();</span>
<span class="nc bnc" id="L1797" title="All 2 branches missed.">            final Location oldTarget = ((m = aiUnit.getMission()) == null)</span>
<span class="nc" id="L1798">                ? null : m.getTarget();</span>
<span class="nc bnc" id="L1799" title="All 2 branches missed.">            if ((m = getSimpleMission(aiUnit)) == null) continue;</span>
<span class="nc" id="L1800">            lb.add(&quot;, &quot;, m);</span>
<span class="nc" id="L1801">            updateTransport(aiUnit, oldTarget, lb);</span>
<span class="nc" id="L1802">            reasons.put(unit, &quot;New-Land&quot;);</span>
<span class="nc" id="L1803">            done.add(aiUnit);</span>
<span class="nc bnc" id="L1804" title="All 2 branches missed.">            if (requestsTransport(aiUnit)) transportSupply.add(aiUnit);</span>
        }
<span class="nc" id="L1806">        aiUnits.removeAll(done);</span>
<span class="nc" id="L1807">        done.clear();</span>

        // Process the free naval units, possibly adding to the usable
        // transport missions.
<span class="nc bnc" id="L1811" title="All 2 branches missed.">        for (AIUnit aiUnit : navalUnits) {</span>
<span class="nc" id="L1812">            final Unit unit = aiUnit.getUnit();</span>
<span class="nc bnc" id="L1813" title="All 4 branches missed.">            Mission old = ((m = aiUnit.getMission()) != null &amp;&amp; m.isValid())</span>
<span class="nc" id="L1814">                ? m : null;</span>
<span class="nc bnc" id="L1815" title="All 2 branches missed.">            if ((m = getSimpleMission(aiUnit)) == null) continue;</span>
<span class="nc bnc" id="L1816" title="All 2 branches missed.">            lb.add(&quot;, &quot;, m, ((m == old) ? &quot; (preserved)&quot; : &quot; (new)&quot;));</span>
<span class="nc" id="L1817">            reasons.put(unit, &quot;New-Naval&quot;);</span>
<span class="nc" id="L1818">            done.add(aiUnit);</span>
<span class="nc bnc" id="L1819" title="All 2 branches missed.">            if (m instanceof TransportMission) {</span>
<span class="nc" id="L1820">                TransportMission tm = (TransportMission)m;</span>
<span class="nc bnc" id="L1821" title="All 2 branches missed.">                if (tm.destinationCapacity() &gt; 0) {</span>
<span class="nc" id="L1822">                    transportMissions.add(tm);</span>
                }
                // A new transport mission might have retargeted
                // its passengers into new valid missions.
<span class="nc bnc" id="L1826" title="All 2 branches missed.">                for (Unit u : aiUnit.getUnit().getUnitList()) {</span>
<span class="nc" id="L1827">                    AIUnit aiu = getAIUnit(u);</span>
<span class="nc" id="L1828">                    Mission um = aiu.getMission();</span>
<span class="nc bnc" id="L1829" title="All 4 branches missed.">                    if (um != null &amp;&amp; um.isValid()</span>
<span class="nc bnc" id="L1830" title="All 2 branches missed.">                        &amp;&amp; aiUnits.contains(aiu)) {</span>
<span class="nc" id="L1831">                        aiUnits.remove(aiu);</span>
<span class="nc" id="L1832">                        reasons.put(aiu.getUnit(), &quot;TNew&quot;);</span>
                    }
                }
            }
        }
<span class="nc" id="L1837">        navalUnits.removeAll(done);</span>
<span class="nc" id="L1838">        done.clear();</span>

        // Give remaining units the fallback mission.
<span class="nc" id="L1841">        aiUnits.addAll(navalUnits);</span>
<span class="nc" id="L1842">        List&lt;Colony&gt; ports = null;</span>
<span class="nc" id="L1843">        int nPorts = player.getNumberOfPorts();</span>
<span class="nc bnc" id="L1844" title="All 2 branches missed.">        for (AIUnit aiUnit : aiUnits) {</span>
<span class="nc" id="L1845">            final Unit unit = aiUnit.getUnit();</span>
<span class="nc" id="L1846">            m = aiUnit.getMission();</span>
<span class="nc bnc" id="L1847" title="All 2 branches missed.">            final Location oldTarget = (m == null) ? null : m.getTarget();</span>
<span class="nc bnc" id="L1848" title="All 6 branches missed.">            if (m != null &amp;&amp; m.isValid() &amp;&amp; !m.isOneTime()) {</span>
<span class="nc" id="L1849">                logger.warning(&quot;Trying fallback mission for unit &quot; + unit</span>
<span class="nc" id="L1850">                    + &quot; with valid mission &quot; + m</span>
<span class="nc" id="L1851">                    + &quot; reason &quot; + reasons.get(unit));</span>
<span class="nc" id="L1852">                continue;</span>
            }

<span class="nc bnc" id="L1855" title="All 6 branches missed.">            if (unit.isInEurope() &amp;&amp; unit.isPerson() &amp;&amp; nPorts &gt; 0) {</span>
                // Choose a port to add to
<span class="nc bnc" id="L1857" title="All 2 branches missed.">                if (ports == null) ports = player.getPorts();</span>
<span class="nc" id="L1858">                Colony c = ports.remove(0);</span>
<span class="nc" id="L1859">                AIColony aic = aiMain.getAIColony(c);</span>
<span class="nc bnc" id="L1860" title="All 2 branches missed.">                if ((m = getWorkInsideColonyMission(aiUnit, aic)) != null) {</span>
<span class="nc" id="L1861">                    lb.add(&quot;, &quot;, m);</span>
<span class="nc" id="L1862">                    updateTransport(aiUnit, oldTarget, lb);</span>
<span class="nc" id="L1863">                    reasons.put(unit, &quot;To-work&quot;);</span>
<span class="nc" id="L1864">                    ports.add(c);</span>
                }

<span class="nc bnc" id="L1867" title="All 2 branches missed.">            } else if (m instanceof IdleAtSettlementMission) {</span>
<span class="nc" id="L1868">                reasons.put(unit, &quot;Idle&quot;); // already idle</span>
<span class="nc" id="L1869">            } else {</span>
<span class="nc bnc" id="L1870" title="All 2 branches missed.">                if ((m = getIdleAtSettlementMission(aiUnit)) != null) {</span>
<span class="nc" id="L1871">                    lb.add(&quot;, &quot;, m);</span>
<span class="nc" id="L1872">                    updateTransport(aiUnit, oldTarget, lb);</span>
<span class="nc" id="L1873">                    reasons.put(unit, &quot;Idle&quot;);</span>
                }
            }
        }
<span class="nc" id="L1877">        lb.grew(&quot;\n  Mission changes&quot;);</span>

        // Now see if transport can be found
<span class="nc" id="L1880">        allocateTransportables(getUrgentTransportables(),</span>
<span class="nc" id="L1881">                               transportMissions, lb);</span>

        // Log
<span class="nc bnc" id="L1884" title="All 2 branches missed.">        if (!aiUnits.isEmpty()) {</span>
<span class="nc" id="L1885">            lb.add(&quot;\n  Free Land Units:&quot;);</span>
<span class="nc bnc" id="L1886" title="All 2 branches missed.">            for (AIUnit aiu : aiUnits) {</span>
<span class="nc" id="L1887">                lb.add(&quot; &quot;, aiu.getUnit());</span>
            }
        }
<span class="nc bnc" id="L1890" title="All 2 branches missed.">        if (!navalUnits.isEmpty()) {</span>
<span class="nc" id="L1891">            lb.add(&quot;\n  Free Naval Units:&quot;);</span>
<span class="nc bnc" id="L1892" title="All 2 branches missed.">            for (AIUnit aiu : navalUnits) {</span>
<span class="nc" id="L1893">                lb.add(&quot; &quot;, aiu.getUnit());</span>
            }
        }
<span class="nc" id="L1896">        lb.add(&quot;\n  Missions(colonies=&quot;, player.getSettlements().size(),</span>
<span class="nc" id="L1897">            &quot; builders=&quot;, nBuilders,</span>
<span class="nc" id="L1898">            &quot; pioneers=&quot;, nPioneers,</span>
<span class="nc" id="L1899">            &quot; scouts=&quot;, nScouts,</span>
<span class="nc" id="L1900">            &quot; naval-carriers=&quot;, nNavalCarrier,</span>
<span class="nc" id="L1901">            &quot;)&quot;);</span>
<span class="nc" id="L1902">        logMissions(reasons, lb);</span>
<span class="nc" id="L1903">    }</span>

    /**
     * Choose a mission for an AIUnit.
     *
     * @param aiUnit The &lt;code&gt;AIUnit&lt;/code&gt; to choose for.
     * @return A suitable &lt;code&gt;Mission&lt;/code&gt;, or null if none found.
     */
    public Mission getSimpleMission(AIUnit aiUnit) {
<span class="nc" id="L1912">        final Unit unit = aiUnit.getUnit();</span>
        Mission m, ret;
<span class="nc bnc" id="L1914" title="All 4 branches missed.">        final Mission old = ((m = aiUnit.getMission()) != null &amp;&amp; m.isValid())</span>
<span class="nc" id="L1915">            ? m : null;</span>

<span class="nc bnc" id="L1917" title="All 2 branches missed.">        if (unit.isNaval()) {</span>
<span class="nc bnc" id="L1918" title="All 2 branches missed.">            ret = (old instanceof PrivateerMission) ? old</span>
<span class="nc bnc" id="L1919" title="All 2 branches missed.">                : ((m = getPrivateerMission(aiUnit, null)) != null) ? m</span>
<span class="nc bnc" id="L1920" title="All 2 branches missed.">                : (old instanceof TransportMission) ? old</span>
<span class="nc bnc" id="L1921" title="All 2 branches missed.">                : ((m = getTransportMission(aiUnit)) != null) ? m</span>
<span class="nc bnc" id="L1922" title="All 2 branches missed.">                : (old instanceof UnitSeekAndDestroyMission) ? old</span>
<span class="nc bnc" id="L1923" title="All 2 branches missed.">                : ((m = getSeekAndDestroyMission(aiUnit, 8)) != null) ? m</span>
<span class="nc bnc" id="L1924" title="All 2 branches missed.">                : (old instanceof UnitWanderHostileMission) ? old</span>
<span class="nc" id="L1925">                : getWanderHostileMission(aiUnit);</span>

<span class="nc bnc" id="L1927" title="All 2 branches missed.">        } else if (unit.isCarrier()) {</span>
<span class="nc" id="L1928">            ret = getTransportMission(aiUnit);</span>

<span class="nc" id="L1930">        } else {</span>
            // CashIn missions are obvious
<span class="nc bnc" id="L1932" title="All 2 branches missed.">            ret = (old instanceof CashInTreasureTrainMission) ? old</span>
<span class="nc bnc" id="L1933" title="All 2 branches missed.">                : ((m = getCashInTreasureTrainMission(aiUnit)) != null) ? m</span>

                // Working in colony is obvious
<span class="nc bnc" id="L1936" title="All 2 branches missed.">                : (unit.isInColony()</span>
<span class="nc bnc" id="L1937" title="All 2 branches missed.">                    &amp;&amp; old instanceof WorkInsideColonyMission) ? old</span>
<span class="nc bnc" id="L1938" title="All 2 branches missed.">                : (unit.isInColony()</span>
<span class="nc bnc" id="L1939" title="All 2 branches missed.">                    &amp;&amp; (m = getWorkInsideColonyMission(aiUnit, null)) != null) ? m</span>

                // Try to maintain local defence
<span class="nc bnc" id="L1942" title="All 2 branches missed.">                : (old instanceof DefendSettlementMission) ? old</span>
<span class="nc bnc" id="L1943" title="All 2 branches missed.">                : ((m = getDefendCurrentSettlementMission(aiUnit)) != null) ? m</span>

                // REF override
<span class="nc bnc" id="L1946" title="All 2 branches missed.">                : (unit.hasAbility(Ability.REF_UNIT))</span>
<span class="nc bnc" id="L1947" title="All 2 branches missed.">                ? ((old instanceof UnitSeekAndDestroyMission) ? old</span>
<span class="nc bnc" id="L1948" title="All 2 branches missed.">                    : ((m = getSeekAndDestroyMission(aiUnit, 12)) != null) ? m</span>
<span class="nc" id="L1949">                    : (m = getWanderHostileMission(aiUnit)))</span>

                // Favour wish realization for expert units
<span class="nc bnc" id="L1952" title="All 4 branches missed.">                : (unit.isColonist() &amp;&amp; unit.getSkillLevel() &gt; 0</span>
<span class="nc bnc" id="L1953" title="All 2 branches missed.">                    &amp;&amp; old instanceof WishRealizationMission) ? old</span>
<span class="nc bnc" id="L1954" title="All 4 branches missed.">                : (unit.isColonist() &amp;&amp; unit.getSkillLevel() &gt; 0</span>
<span class="nc bnc" id="L1955" title="All 2 branches missed.">                    &amp;&amp; (m = getWishRealizationMission(aiUnit, null)) != null) ? m</span>

                // Ordinary defence
<span class="nc bnc" id="L1958" title="All 2 branches missed.">                : ((m = getDefendSettlementMission(aiUnit, false)) != null) ? m</span>

                // Try nearby offence
<span class="nc bnc" id="L1961" title="All 2 branches missed.">                : (old instanceof UnitSeekAndDestroyMission) ? old</span>
<span class="nc bnc" id="L1962" title="All 2 branches missed.">                : ((m = getSeekAndDestroyMission(aiUnit, 8)) != null) ? m</span>

                // Missionary missions are only available to some units
<span class="nc bnc" id="L1965" title="All 2 branches missed.">                : (old instanceof MissionaryMission) ? old</span>
<span class="nc bnc" id="L1966" title="All 2 branches missed.">                : ((m = getMissionaryMission(aiUnit)) != null) ? m</span>

                // Try to satisfy any remaining wishes, such as population
<span class="nc bnc" id="L1969" title="All 2 branches missed.">                : (old instanceof WishRealizationMission) ? old</span>
<span class="nc bnc" id="L1970" title="All 2 branches missed.">                : ((m = getWishRealizationMission(aiUnit, null)) != null) ? m</span>

                // Another try to defend, with relaxed cost decider
<span class="nc bnc" id="L1973" title="All 2 branches missed.">                : ((m = getDefendSettlementMission(aiUnit, true)) != null) ? m</span>

                // Another try to attack, at longer range
<span class="nc bnc" id="L1976" title="All 2 branches missed.">                : ((m = getSeekAndDestroyMission(aiUnit, 16)) != null) ? m</span>

                // Leftover offensive units should go out looking for trouble
<span class="nc bnc" id="L1979" title="All 2 branches missed.">                : (old instanceof UnitWanderHostileMission) ? old</span>
<span class="nc bnc" id="L1980" title="All 2 branches missed.">                : ((m = getWanderHostileMission(aiUnit)) != null) ? m</span>

<span class="nc" id="L1982">                : null;</span>
        }
<span class="nc" id="L1984">        return ret;</span>
    }

    // Mission creation convenience routines.
    // Aggregated here for uniformity.  Might have been more logical
    // to disperse them to the individual classes.

    /**
     * Gets a new BuildColonyMission for a unit.
     *
     * @param aiUnit The &lt;code&gt;AIUnit&lt;/code&gt; to check.
     * @param target An optional target &lt;code&gt;Location&lt;/code&gt;.
     * @return A new mission, or null if impossible.
     */
    public Mission getBuildColonyMission(AIUnit aiUnit, Location target) {
<span class="nc" id="L1999">        String reason = BuildColonyMission.invalidReason(aiUnit);</span>
<span class="nc bnc" id="L2000" title="All 2 branches missed.">        if (reason != null) return null;</span>
<span class="nc" id="L2001">        final Unit unit = aiUnit.getUnit();</span>
<span class="nc bnc" id="L2002" title="All 2 branches missed.">        if (target == null) {</span>
<span class="nc" id="L2003">            target = BuildColonyMission.findTarget(aiUnit, buildingRange,</span>
<span class="nc" id="L2004">                                                   unit.isInEurope());</span>
        }
<span class="nc bnc" id="L2006" title="All 2 branches missed.">        return (target == null) ? null</span>
<span class="nc" id="L2007">            : new BuildColonyMission(getAIMain(), aiUnit, target);</span>
    }

    /**
     * Gets a new CashInTreasureTrainMission for a unit.
     *
     * @param aiUnit The &lt;code&gt;AIUnit&lt;/code&gt; to check.
     * @return A new mission, or null if impossible.
     */
    public Mission getCashInTreasureTrainMission(AIUnit aiUnit) {
<span class="nc" id="L2017">        String reason = CashInTreasureTrainMission.invalidReason(aiUnit);</span>
<span class="nc bnc" id="L2018" title="All 2 branches missed.">        if (reason != null) return null;</span>
<span class="nc" id="L2019">        final Unit unit = aiUnit.getUnit();</span>
<span class="nc" id="L2020">        Location loc = CashInTreasureTrainMission.findTarget(aiUnit,</span>
<span class="nc" id="L2021">            cashInRange, unit.isInEurope());</span>
<span class="nc bnc" id="L2022" title="All 2 branches missed.">        return (loc == null) ? null</span>
<span class="nc" id="L2023">            : new CashInTreasureTrainMission(getAIMain(), aiUnit, loc);</span>
    }

    /**
     * Gets a new DefendSettlementMission for a unit.
     *
     * @param aiUnit The &lt;code&gt;AIUnit&lt;/code&gt; to check.
     * @param relaxed Use a relaxed cost decider to choose the target.
     * @return A new mission, or null if impossible.
     */
    public Mission getDefendSettlementMission(AIUnit aiUnit, boolean relaxed) {
<span class="nc bnc" id="L2034" title="All 2 branches missed.">        if (DefendSettlementMission.invalidReason(aiUnit) != null) return null;</span>
<span class="nc" id="L2035">        final Unit unit = aiUnit.getUnit();</span>
<span class="nc" id="L2036">        final Location loc = unit.getLocation();</span>
<span class="nc" id="L2037">        double worstValue = 1000000.0;</span>
<span class="nc" id="L2038">        Colony worstColony = null;</span>
<span class="nc bnc" id="L2039" title="All 2 branches missed.">        for (AIColony aic : getAIColonies()) {</span>
<span class="nc" id="L2040">            Colony colony = aic.getColony();</span>
<span class="nc bnc" id="L2041" title="All 2 branches missed.">            if (aic.isBadlyDefended()) {</span>
<span class="nc bnc" id="L2042" title="All 2 branches missed.">                if (unit.isAtLocation(colony.getTile())) {</span>
<span class="nc" id="L2043">                    worstColony = colony;</span>
<span class="nc" id="L2044">                    break;</span>
                }
<span class="nc" id="L2046">                int ttr = 1 + unit.getTurnsToReach(loc, colony.getTile(),</span>
<span class="nc" id="L2047">                    unit.getCarrier(),</span>
<span class="nc bnc" id="L2048" title="All 2 branches missed.">                    ((relaxed) ? CostDeciders.numberOfTiles() : null));</span>
<span class="nc bnc" id="L2049" title="All 2 branches missed.">                if (ttr &gt;= Unit.MANY_TURNS) continue;</span>
<span class="nc" id="L2050">                double value = colony.getDefenceRatio() * 100.0 / ttr;</span>
<span class="nc bnc" id="L2051" title="All 2 branches missed.">                if (worstValue &gt; value) {</span>
<span class="nc" id="L2052">                    worstValue = value;</span>
<span class="nc" id="L2053">                    worstColony = colony;</span>
                }
            }
        }
<span class="nc bnc" id="L2057" title="All 2 branches missed.">        return (worstColony == null) ? null</span>
<span class="nc" id="L2058">            : getDefendSettlementMission(aiUnit, worstColony);</span>
    }

    /**
     * Gets a new MissionaryMission for a unit.
     *
     * @param aiUnit The &lt;code&gt;AIUnit&lt;/code&gt; to check.
     * @return A new mission, or null if impossible.
     */
    public Mission getMissionaryMission(AIUnit aiUnit) {
<span class="nc bnc" id="L2068" title="All 2 branches missed.">        if (MissionaryMission.prepare(aiUnit) != null) return null;</span>
<span class="nc" id="L2069">        Location loc = MissionaryMission.findTarget(aiUnit, missionaryRange,</span>
<span class="nc" id="L2070">                                                    true);</span>
<span class="nc bnc" id="L2071" title="All 2 branches missed.">        if (loc == null) {</span>
<span class="nc" id="L2072">            aiUnit.equipForRole(getSpecification().getDefaultRole());</span>
<span class="nc" id="L2073">            return null;</span>
        }
<span class="nc" id="L2075">        return new MissionaryMission(getAIMain(), aiUnit, loc);</span>
    }

    /**
     * Gets a new PioneeringMission for a unit.
     *
     * FIXME: pioneers to make roads between colonies
     *
     * @param aiUnit The &lt;code&gt;AIUnit&lt;/code&gt; to check.
     * @param target An optional target &lt;code&gt;Location&lt;/code&gt;.
     * @return A new mission, or null if impossible.
     */
    public Mission getPioneeringMission(AIUnit aiUnit, Location target) {
<span class="nc bnc" id="L2088" title="All 2 branches missed.">        if (PioneeringMission.prepare(aiUnit) != null) return null;</span>
<span class="nc bnc" id="L2089" title="All 2 branches missed.">        if (target == null) {</span>
<span class="nc" id="L2090">            target = PioneeringMission.findTarget(aiUnit, pioneeringRange,</span>
<span class="nc" id="L2091">                                                  true);</span>
        }
<span class="nc bnc" id="L2093" title="All 2 branches missed.">        if (target == null) {</span>
<span class="nc" id="L2094">            Unit unit = aiUnit.getUnit();</span>
<span class="nc bnc" id="L2095" title="All 4 branches missed.">            if (unit.isInEurope() || unit.getSettlement() != null) {</span>
<span class="nc" id="L2096">                aiUnit.equipForRole(getSpecification().getDefaultRole());</span>
            }
<span class="nc" id="L2098">            return null;</span>
        }
<span class="nc" id="L2100">        return new PioneeringMission(getAIMain(), aiUnit, target);</span>
    }

    /**
     * Gets a new PrivateerMission for a unit.
     *
     * @param aiUnit The &lt;code&gt;AIUnit&lt;/code&gt; to check.
     * @param target An optional target &lt;code&gt;Location&lt;/code&gt;.
     * @return A new mission, or null if impossible.
     */
    public Mission getPrivateerMission(AIUnit aiUnit, Location target) {
<span class="nc bnc" id="L2111" title="All 2 branches missed.">        if (PrivateerMission.invalidReason(aiUnit) != null) return null;</span>
<span class="nc bnc" id="L2112" title="All 2 branches missed.">        if (target == null) {</span>
<span class="nc" id="L2113">            target = PrivateerMission.findTarget(aiUnit, privateerRange, true);</span>
        }
<span class="nc bnc" id="L2115" title="All 2 branches missed.">        return (target == null) ? null</span>
<span class="nc" id="L2116">            : new PrivateerMission(getAIMain(), aiUnit, target);</span>
    }

    /**
     * Gets a new ScoutingMission for a unit.
     *
     * @param aiUnit The &lt;code&gt;AIUnit&lt;/code&gt; to check.
     * @return A new mission, or null if impossible.
     */
    public Mission getScoutingMission(AIUnit aiUnit) {
<span class="nc bnc" id="L2126" title="All 2 branches missed.">        if (ScoutingMission.prepare(aiUnit) != null) return null;</span>
<span class="nc" id="L2127">        Location loc = ScoutingMission.findTarget(aiUnit, scoutingRange, true);</span>
<span class="nc bnc" id="L2128" title="All 2 branches missed.">        if (loc == null) {</span>
<span class="nc" id="L2129">            Unit unit = aiUnit.getUnit();</span>
<span class="nc bnc" id="L2130" title="All 4 branches missed.">            if (unit.isInEurope() || unit.getSettlement() != null) {</span>
<span class="nc" id="L2131">                aiUnit.equipForRole(getSpecification().getDefaultRole());</span>
            }
<span class="nc" id="L2133">            return null;</span>
        }            
<span class="nc" id="L2135">        return new ScoutingMission(getAIMain(), aiUnit, loc);</span>
    }

    /**
     * Gets a new TransportMission for a unit.
     *
     * @param aiUnit The &lt;code&gt;AIUnit&lt;/code&gt; to check.
     * @return A new mission, or null if impossible.
     */
    public Mission getTransportMission(AIUnit aiUnit) {
<span class="nc bnc" id="L2145" title="All 2 branches missed.">        if (TransportMission.invalidReason(aiUnit) != null) return null;</span>
<span class="nc" id="L2146">        return new TransportMission(getAIMain(), aiUnit);</span>
    }

    /**
     * Gets a new WishRealizationMission for a unit.
     *
     * @param aiUnit The &lt;code&gt;AIUnit&lt;/code&gt; to check.
     * @param wish An optional &lt;code&gt;WorkerWish&lt;/code&gt; to realize.
     * @return A new mission, or null if impossible.
     */
    public Mission getWishRealizationMission(AIUnit aiUnit, WorkerWish wish) {
<span class="nc bnc" id="L2157" title="All 2 branches missed.">        if (WishRealizationMission.invalidReason(aiUnit) != null) return null;</span>
<span class="nc" id="L2158">        final Unit unit = aiUnit.getUnit();</span>
<span class="nc bnc" id="L2159" title="All 2 branches missed.">        if (wish == null) {</span>
<span class="nc" id="L2160">            wish = getBestWorkerWish(aiUnit, unit.getType());</span>
        }
<span class="nc bnc" id="L2162" title="All 2 branches missed.">        if (wish == null) return null;</span>
<span class="nc" id="L2163">        consumeWorkerWish(aiUnit, wish);</span>
<span class="nc" id="L2164">        return new WishRealizationMission(getAIMain(), aiUnit, wish);</span>
    }

    /**
     * Gets a WorkInsideColonyMission for a unit.
     *
     * @param aiUnit The &lt;code&gt;AIUnit&lt;/code&gt; to check.
     * @param aiColony An optional &lt;code&gt;AIColony&lt;/code&gt; to work at.
     * @return A new mission, or null if impossible.
     */
    public Mission getWorkInsideColonyMission(AIUnit aiUnit,
                                              AIColony aiColony) {
<span class="nc bnc" id="L2176" title="All 2 branches missed.">        if (WorkInsideColonyMission.invalidReason(aiUnit) != null) return null;</span>
<span class="nc bnc" id="L2177" title="All 2 branches missed.">        if (aiColony == null) {</span>
<span class="nc" id="L2178">            aiColony = getAIColony(aiUnit.getUnit().getColony());</span>
        }
<span class="nc bnc" id="L2180" title="All 2 branches missed.">        return (aiColony == null) ? null</span>
<span class="nc" id="L2181">            : new WorkInsideColonyMission(getAIMain(), aiUnit, aiColony);</span>
    }


    // AIPlayer interface

    /**
     * {@inheritDoc}
     */
    @Override
    protected Stance determineStance(Player other) {
<span class="nc" id="L2192">        final Player player = getPlayer();</span>
<span class="nc bnc" id="L2193" title="All 2 branches missed.">        return (other.isREF())</span>
<span class="nc bnc" id="L2194" title="All 2 branches missed.">            ? ((player.getREFPlayer() == other) </span>
                // At war with our REF if rebel, otherwise at peace.
<span class="nc bnc" id="L2196" title="All 2 branches missed.">                ? ((player.isRebel()) ? Stance.WAR : Stance.PEACE)</span>
                // Do not mess with other player's REF unless they conquer
                // their rebellious colonies.
<span class="nc bnc" id="L2199" title="All 2 branches missed.">                : ((!other.getRebels().isEmpty()) ? Stance.PEACE</span>
<span class="nc" id="L2200">                    : super.determineStance(other)))</span>
            // Use normal stance determination for non-REF nations.
<span class="nc" id="L2202">            : super.determineStance(other);</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public void removeAIColony(AIColony aic) {
<span class="nc" id="L2210">        final Colony colony = aic.getColony();</span>
        
<span class="nc" id="L2212">        Set&lt;TileImprovementPlan&gt; tips = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L2213" title="All 2 branches missed.">        for (Tile t : colony.getOwnedTiles()) {</span>
<span class="nc" id="L2214">            TileImprovementPlan tip = tipMap.remove(t);</span>
<span class="nc bnc" id="L2215" title="All 2 branches missed.">            if (tip != null) tips.add(tip);</span>
        }

<span class="nc bnc" id="L2218" title="All 2 branches missed.">        for (AIGoods aig : aic.getExportGoods()) {</span>
<span class="nc bnc" id="L2219" title="All 2 branches missed.">            if (Map.isSameLocation(aig.getLocation(), colony)) {</span>
<span class="nc" id="L2220">                aig.changeTransport(null);</span>
<span class="nc" id="L2221">                aig.dispose();</span>
            }
        }

<span class="nc" id="L2225">        transportDemand.remove(colony);</span>

<span class="nc" id="L2227">        Set&lt;Wish&gt; wishes = new HashSet&lt;&gt;(aic.getWishes());</span>
<span class="nc bnc" id="L2228" title="All 2 branches missed.">        for (AIUnit aiu : getAIUnits()) {</span>
<span class="nc" id="L2229">            PioneeringMission pm = aiu.getMission(PioneeringMission.class);</span>
<span class="nc bnc" id="L2230" title="All 2 branches missed.">            if (pm != null) {</span>
<span class="nc bnc" id="L2231" title="All 2 branches missed.">                if (tips.contains(pm.getTileImprovementPlan())) {</span>
<span class="nc" id="L2232">                    logger.info(pm + &quot; collapses with loss of &quot; + colony);</span>
<span class="nc" id="L2233">                    aiu.changeMission(null);</span>
                }
<span class="nc" id="L2235">                continue;</span>
            }
            WishRealizationMission
<span class="nc" id="L2238">                wm = aiu.getMission(WishRealizationMission.class);</span>
<span class="nc bnc" id="L2239" title="All 2 branches missed.">            if (wm != null) {</span>
<span class="nc bnc" id="L2240" title="All 2 branches missed.">                if (wishes.contains(wm.getWish())) {</span>
<span class="nc" id="L2241">                    logger.info(wm + &quot; collapses with loss of &quot; + colony);</span>
<span class="nc" id="L2242">                    aiu.changeMission(null);</span>
                }
                continue;
            }
        }
<span class="nc" id="L2247">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public void startWorking() {
<span class="nc" id="L2254">        final Player player = getPlayer();</span>
<span class="nc" id="L2255">        final Turn turn = getGame().getTurn();</span>
<span class="nc" id="L2256">        final Specification spec = getSpecification();</span>
<span class="nc" id="L2257">        initializeFromSpecification(spec);</span>

        // This is happening, very rarely.  Hopefully now fixed by
        // synchronizing access to AIMain.aiObjects.
<span class="nc bnc" id="L2261" title="All 2 branches missed.">        if (getAIMain().getAIPlayer(player) != this) {</span>
<span class="nc" id="L2262">            throw new RuntimeException(&quot;EuropeanAIPlayer integrity fail&quot;);</span>
        }
<span class="nc" id="L2264">        sessionRegister.clear();</span>
<span class="nc" id="L2265">        clearAIUnits();</span>
<span class="nc" id="L2266">        player.clearNationCache();</span>
<span class="nc" id="L2267">        badlyDefended.clear();</span>

        // Note call to getAIUnits().  This triggers
        // AIPlayer.createAIUnits which we want to do early, certainly
        // before cheat() or other operations that might make new units
        // happen.
<span class="nc" id="L2273">        LogBuilder lb = new LogBuilder(1024);</span>
<span class="nc" id="L2274">        int colonyCount = getAIColonies().size();</span>
<span class="nc" id="L2275">        lb.add(player.getDebugName(),</span>
<span class="nc" id="L2276">               &quot; in &quot;, turn, &quot;/&quot;, turn.getNumber(),</span>
<span class="nc" id="L2277">               &quot; units=&quot;, getAIUnits().size(),</span>
<span class="nc" id="L2278">               &quot; colonies=&quot;, colonyCount,</span>
<span class="nc bnc" id="L2279" title="All 2 branches missed.">               &quot; declare=&quot;, (player.checkDeclareIndependence() == null),</span>
<span class="nc" id="L2280">               &quot; v-land-REF=&quot;, player.getRebelStrengthRatio(false),</span>
<span class="nc" id="L2281">               &quot; v-naval-REF=&quot;, player.getRebelStrengthRatio(true));</span>
<span class="nc bnc" id="L2282" title="All 2 branches missed.">        if (turn.isFirstTurn()) initializeMissions(lb);</span>
<span class="nc" id="L2283">        determineStances(lb);</span>

<span class="nc bnc" id="L2285" title="All 2 branches missed.">        if (colonyCount &gt; 0) {</span>
<span class="nc" id="L2286">            lb.add(&quot;\n  Badly defended:&quot;); // FIXME: prioritize defence</span>
<span class="nc bnc" id="L2287" title="All 2 branches missed.">            for (AIColony aic : getAIColonies()) {</span>
<span class="nc bnc" id="L2288" title="All 2 branches missed.">                if (aic.isBadlyDefended()) {</span>
<span class="nc" id="L2289">                    badlyDefended.add(aic);</span>
<span class="nc" id="L2290">                    lb.add(&quot; &quot;, aic.getColony());</span>
                }
            }

<span class="nc" id="L2294">            lb.add(&quot;\n  Update colonies:&quot;);</span>
<span class="nc bnc" id="L2295" title="All 2 branches missed.">            for (AIColony aic : getAIColonies()) aic.update(lb);</span>

<span class="nc" id="L2297">            buildTipMap(lb);</span>
<span class="nc" id="L2298">            buildWishMaps(lb);</span>
        }
<span class="nc" id="L2300">        cheat(lb);</span>
<span class="nc" id="L2301">        buildTransportMaps(lb);</span>

        // Note order of operations below.  We allow rearrange et al to run
        // even when there are no movable units left because this expedites
        // mission assignment.
<span class="nc" id="L2306">        List&lt;AIUnit&gt; aiUnits = getAIUnits();</span>
<span class="nc bnc" id="L2307" title="All 2 branches missed.">        for (int i = 0; i &lt; 3; i++) {</span>
<span class="nc" id="L2308">            rearrangeColonies(lb);</span>
<span class="nc" id="L2309">            giveNormalMissions(lb);</span>
<span class="nc" id="L2310">            bringGifts(lb);</span>
<span class="nc" id="L2311">            demandTribute(lb);</span>
<span class="nc bnc" id="L2312" title="All 2 branches missed.">            if (aiUnits.isEmpty()) break;</span>
<span class="nc" id="L2313">            aiUnits = doMissions(aiUnits, lb);</span>
        }
<span class="nc" id="L2315">        lb.log(logger, Level.FINE);</span>

<span class="nc" id="L2317">        clearAIUnits();</span>
<span class="nc" id="L2318">        tipMap.clear();</span>
<span class="nc" id="L2319">        transportDemand.clear();</span>
<span class="nc" id="L2320">        transportSupply.clear();</span>
<span class="nc" id="L2321">        wagonsNeeded.clear();</span>
<span class="nc" id="L2322">        goodsWishes.clear();</span>
<span class="nc" id="L2323">        workerWishes.clear();</span>
<span class="nc" id="L2324">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    protected List&lt;AIUnit&gt; doMissions(List&lt;AIUnit&gt; aiUnits, LogBuilder lb) {
<span class="nc" id="L2331">        lb.add(&quot;\n  Do missions:&quot;);</span>
<span class="nc" id="L2332">        List&lt;AIUnit&gt; result = new ArrayList&lt;&gt;();</span>

        // For all units, do their mission and collect the ones that need
        // to be revisited.
<span class="nc bnc" id="L2336" title="All 2 branches missed.">        for (AIUnit aiu : aiUnits) {</span>
<span class="nc" id="L2337">            final Unit unit = aiu.getUnit();</span>
<span class="nc bnc" id="L2338" title="All 4 branches missed.">            if (unit == null || unit.isDisposed()) continue;</span>

            // giveNormalMissions should have given all units a
            // mission, but TransportMissions may have delivered a
            // unit and completed its WishRealizationMission, so it is
            // possible for a null mission to happen here.  Refer such
            // units back to giveNormalMissions.
<span class="nc" id="L2345">            final Mission oldMission = aiu.getMission();</span>
<span class="nc bnc" id="L2346" title="All 2 branches missed.">            if (oldMission == null) {</span>
<span class="nc" id="L2347">                result.add(aiu);</span>
<span class="nc" id="L2348">                continue;</span>
            }
<span class="nc" id="L2350">            final Location oldTarget = oldMission.getTarget();</span>
<span class="nc" id="L2351">            final Location oldLocation = unit.getLocation();</span>
<span class="nc" id="L2352">            final Colony oldColony = oldLocation.getColony();</span>

            // Do the mission.  Clean up dead units.
<span class="nc" id="L2355">            lb.add(&quot;\n  &quot;, unit, &quot; &quot;);</span>
            try {
<span class="nc" id="L2357">                aiu.doMission(lb);</span>
<span class="nc" id="L2358">            } catch (Exception e) {</span>
<span class="nc" id="L2359">                lb.add(&quot;, EXCEPTION: &quot;, e.getMessage());</span>
<span class="nc" id="L2360">                logger.log(Level.WARNING, &quot;doMissions failed for: &quot; + aiu, e);</span>
            }
<span class="nc bnc" id="L2362" title="All 4 branches missed.">            if (unit.isDisposed() || unit.getLocation() == null) {</span>
<span class="nc" id="L2363">                aiu.dropTransport();</span>
<span class="nc" id="L2364">                lb.add(&quot;, DIED.&quot;);</span>
<span class="nc" id="L2365">                continue;</span>
            }
            
<span class="nc" id="L2368">            updateTransport(aiu, oldTarget, lb);</span>
            // Check again that the unit is alive, updateTransport() can
            // cause unit to disembark onto a fatal LCR!
<span class="nc bnc" id="L2371" title="All 4 branches missed.">            if (unit.isDisposed() || unit.getLocation() == null) {</span>
<span class="nc" id="L2372">                lb.add(&quot;, DIED.&quot;);</span>
<span class="nc" id="L2373">                continue;</span>
            }
            
            // Units with moves left should be requeued.  If they are on a
            // carrier the carrier needs to have moves left.
<span class="nc bnc" id="L2378" title="All 4 branches missed.">            if (unit.getMovesLeft() &gt; 0 &amp;&amp; (!unit.isOnCarrier()</span>
<span class="nc bnc" id="L2379" title="All 2 branches missed.">                    || unit.getCarrier().getMovesLeft() &gt; 0)) {</span>
<span class="nc" id="L2380">                lb.add(&quot;+&quot;);</span>
<span class="nc" id="L2381">                result.add(aiu);</span>
<span class="nc" id="L2382">            } else {</span>
<span class="nc" id="L2383">                lb.add(&quot;.&quot;);</span>
            }

            // Immediately update a newly built colony so that other
            // units that are about to wake up can see its tile
            // improvement plans.
<span class="nc" id="L2389">            Colony newColony = unit.getLocation().getColony();</span>
<span class="nc bnc" id="L2390" title="All 4 branches missed.">            if (oldColony == null &amp;&amp; newColony != null</span>
<span class="nc bnc" id="L2391" title="All 2 branches missed.">                &amp;&amp; Map.isSameLocation(oldLocation, newColony)) {</span>
<span class="nc" id="L2392">                AIColony aiColony = getAIColony(newColony);</span>
<span class="nc" id="L2393">                aiColony.update(lb);</span>
<span class="nc" id="L2394">                updateTipMap(aiColony);</span>
            }
        }
<span class="nc" id="L2397">        return result;</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public int adjustMission(AIUnit aiUnit, PathNode path, Class type,
                             int value) {
<span class="nc bnc" id="L2406" title="All 2 branches missed.">        if (value &gt; 0) {</span>
<span class="nc bnc" id="L2407" title="All 2 branches missed.">            if (type == DefendSettlementMission.class) {</span>
                // Reduce value in proportion to the number of defenders.
<span class="nc" id="L2409">                Location loc = DefendSettlementMission.extractTarget(aiUnit, path);</span>
<span class="nc bnc" id="L2410" title="All 2 branches missed.">                if (!(loc instanceof Colony)) {</span>
<span class="nc" id="L2411">                    throw new IllegalStateException(&quot;European players defend colonies: &quot; + loc);</span>
                }
<span class="nc" id="L2413">                Colony colony = (Colony)loc;</span>
<span class="nc" id="L2414">                int defenders = getSettlementDefenders(colony);</span>
<span class="nc" id="L2415">                value -= 25 * defenders;</span>
                // Reduce value according to the stockade level.
<span class="nc bnc" id="L2417" title="All 2 branches missed.">                if (colony.hasStockade()) {</span>
<span class="nc bnc" id="L2418" title="All 2 branches missed.">                    if (defenders &gt; colony.getStockade().getLevel() + 1) {</span>
<span class="nc" id="L2419">                        value -= 100 * colony.getStockade().getLevel();</span>
<span class="nc" id="L2420">                    } else {</span>
<span class="nc" id="L2421">                        value -= 20 * colony.getStockade().getLevel();</span>
                    }
                }
            }
        }
<span class="nc" id="L2426">        return value;</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public Boolean indianDemand(Unit unit, Colony colony,
                                GoodsType goods, int gold, Boolean accept) {
        // FIXME: make a better choice, check whether the colony is
        // well defended
<span class="nc bnc" id="L2437" title="All 2 branches missed.">        return !&quot;conquest&quot;.equals(getAIAdvantage());</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public TradeStatus acceptDiplomaticTrade(DiplomaticTrade agreement) {
<span class="nc" id="L2445">        final Player player = getPlayer();</span>
<span class="nc" id="L2446">        final Player other = agreement.getOtherPlayer(player);</span>
        // final Market market = player.getMarket();
<span class="nc" id="L2448">        final boolean franklin</span>
<span class="nc" id="L2449">            = other.hasAbility(Ability.ALWAYS_OFFERED_PEACE);</span>
<span class="nc" id="L2450">        final java.util.Map&lt;TradeItem, Integer&gt; scores = new HashMap&lt;&gt;();</span>
<span class="nc" id="L2451">        TradeItem peace = null;</span>
        // TradeItem cash = null;
<span class="nc" id="L2453">        LogBuilder lb = new LogBuilder(64);</span>
<span class="nc" id="L2454">        lb.add(&quot;Evaluate trade offer to &quot;, player.getName(),</span>
<span class="nc" id="L2455">            &quot; from &quot;, other.getName());</span>
<span class="nc" id="L2456">        TradeStatus result = null;</span>

<span class="nc" id="L2458">        int unacceptable = 0;</span>
<span class="nc bnc" id="L2459" title="All 2 branches missed.">        for (TradeItem item : agreement.getTradeItems()) {</span>
<span class="nc bnc" id="L2460" title="All 2 branches missed.">            if (item instanceof StanceTradeItem) {</span>
<span class="nc" id="L2461">                getNationSummary(other); // Freshen the name summary cache</span>
            }                    
<span class="nc" id="L2463">            int value = item.evaluateFor(player);</span>
<span class="nc bnc" id="L2464" title="All 2 branches missed.">            if (item instanceof StanceTradeItem) { // Handle some special cases</span>
<span class="nc bnc" id="L2465" title="All 3 branches missed.">                switch (item.getStance()) {</span>
                case ALLIANCE: case CEASE_FIRE:
<span class="nc bnc" id="L2467" title="All 2 branches missed.">                    if (franklin) {</span>
<span class="nc" id="L2468">                        peace = item;</span>
<span class="nc" id="L2469">                        value = 0;</span>
                    }
<span class="nc" id="L2471">                    break;</span>
                case PEACE:
<span class="nc bnc" id="L2473" title="All 2 branches missed.">                    if (agreement.getContext() == DiplomaticTrade.TradeContext.CONTACT) {</span>
<span class="nc" id="L2474">                        peace = item;</span>
<span class="nc" id="L2475">                        value = 0;</span>
                    }
                    break;
                }
            }
<span class="nc bnc" id="L2480" title="All 2 branches missed.">            if (value == Integer.MIN_VALUE) {</span>
<span class="nc" id="L2481">                unacceptable++;</span>
<span class="nc bnc" id="L2482" title="All 2 branches missed.">            } else if (item.getSource() == player) {</span>
<span class="nc" id="L2483">                value = -value;</span>
            }
<span class="nc" id="L2485">            scores.put(item, value);</span>
<span class="nc" id="L2486">            lb.add(&quot;, &quot;, Messages.message(item.getLabel()), &quot; = &quot;, value);</span>
        }
<span class="nc" id="L2488">        lb.add(&quot;.&quot;);</span>
        
        // If too many items are unacceptable, reject
<span class="nc" id="L2491">        double ratio = (double)unacceptable</span>
<span class="nc" id="L2492">            / (unacceptable + agreement.getTradeItems().size());</span>
<span class="nc bnc" id="L2493" title="All 2 branches missed.">        if (ratio &gt; 0.5 - 0.5 * agreement.getVersion()) {</span>
<span class="nc" id="L2494">            result = rejectAgreement(peace, agreement);</span>
<span class="nc" id="L2495">            lb.add(&quot;  Too many (&quot;, unacceptable, &quot;) unacceptable.&quot;);</span>
        }

<span class="nc" id="L2498">        int value = 0;</span>
<span class="nc bnc" id="L2499" title="All 2 branches missed.">        if (result == null) {</span>
            // Dump the unacceptable offers, sum the rest
<span class="nc bnc" id="L2501" title="All 2 branches missed.">            for (Entry&lt;TradeItem, Integer&gt; entry : scores.entrySet()) {</span>
<span class="nc bnc" id="L2502" title="All 2 branches missed.">                if (entry.getValue() == Integer.MIN_VALUE) {</span>
<span class="nc" id="L2503">                    agreement.remove(entry.getKey());</span>
<span class="nc" id="L2504">                    lb.add(&quot;  Dropped invalid &quot;, entry.getKey(), &quot;.&quot;);</span>
<span class="nc" id="L2505">                } else {</span>
<span class="nc" id="L2506">                    value += entry.getValue();</span>
<span class="nc" id="L2507">                    lb.add(&quot;  Added valid &quot;, entry.getKey(), &quot;, total = &quot;, value,</span>
<span class="nc" id="L2508">                           &quot;.&quot;);</span>
                }
            }
            // If the result is non-negative,
            // accept/propose-without-unacceptable
<span class="nc bnc" id="L2513" title="All 2 branches missed.">            if (value &gt;= 0) {</span>
<span class="nc bnc" id="L2514" title="All 2 branches missed.">                result = (agreement.getContext()</span>
<span class="nc" id="L2515">                    == DiplomaticTrade.TradeContext.CONTACT</span>
<span class="nc bnc" id="L2516" title="All 2 branches missed.">                    &amp;&amp; agreement.getVersion() == 0) ? TradeStatus.PROPOSE_TRADE</span>
<span class="nc bnc" id="L2517" title="All 2 branches missed.">                    : (unacceptable == 0) ? TradeStatus.ACCEPT_TRADE</span>
<span class="nc bnc" id="L2518" title="All 2 branches missed.">                    : (agreement.isEmpty()) ? TradeStatus.REJECT_TRADE</span>
<span class="nc" id="L2519">                    : TradeStatus.PROPOSE_TRADE;</span>
            }
<span class="nc" id="L2521">            lb.add(&quot;  Total = &quot;, value, &quot;.&quot;);</span>
        }

<span class="nc bnc" id="L2524" title="All 2 branches missed.">        if (result == null) { // Give up?</span>
<span class="nc" id="L2525">            if (randomInt(logger, &quot;Enough diplomacy?&quot;, getAIRandom(),</span>
<span class="nc bnc" id="L2526" title="All 2 branches missed.">                          1 + agreement.getVersion()) &gt; 5) {</span>
<span class="nc" id="L2527">                result = rejectAgreement(peace, agreement);</span>
<span class="nc" id="L2528">                lb.add(&quot;  Ran out of patience at &quot;, agreement.getVersion(), &quot;.&quot;);</span>
            }
        }

<span class="nc bnc" id="L2532" title="All 2 branches missed.">        if (result == null) {</span>
            // Dump the negative offers until the sum is positive.
            // Return a proposal with items we like/can accept, or reject
            // if none are left.
<span class="nc bnc" id="L2536" title="All 2 branches missed.">            for (Entry&lt;TradeItem, Integer&gt; e</span>
<span class="nc" id="L2537">                     : mapEntriesByValue(scores, ascendingIntegerComparator)) {</span>
<span class="nc bnc" id="L2538" title="All 2 branches missed.">                if (value &gt; 0) break;</span>
<span class="nc" id="L2539">                TradeItem item = e.getKey();</span>
<span class="nc" id="L2540">                value -= e.getValue();</span>
<span class="nc bnc" id="L2541" title="All 4 branches missed.">                if (value &gt;= 50 &amp;&amp; item instanceof GoldTradeItem) {</span>
                    // Counter offer smaller amount of gold, FIXME: magic#
<span class="nc" id="L2543">                    GoldTradeItem gti = (GoldTradeItem)item;</span>
<span class="nc" id="L2544">                    gti.setGold(gti.getGold() - value / 2);</span>
<span class="nc" id="L2545">                    value /= 2;</span>
<span class="nc" id="L2546">                    lb.add(&quot;  Reducing gold item to &quot;, gti.getGold(), &quot;.&quot;);</span>
<span class="nc" id="L2547">                    break;</span>
                }
<span class="nc" id="L2549">                agreement.remove(item);</span>
<span class="nc" id="L2550">                lb.add(&quot;  Dropped &quot;, item, &quot;, value now = &quot;, value, &quot;.&quot;);</span>
            }
<span class="nc bnc" id="L2552" title="All 4 branches missed.">            if (value &gt; 0 &amp;&amp; !agreement.isEmpty()) {</span>
<span class="nc" id="L2553">                result = TradeStatus.PROPOSE_TRADE;</span>
<span class="nc" id="L2554">                lb.add(&quot;  Pruned until acceptable at &quot;, value, &quot;.&quot;);</span>
<span class="nc" id="L2555">            } else {</span>
<span class="nc" id="L2556">                result = rejectAgreement(peace, agreement);</span>
<span class="nc" id="L2557">                lb.add(&quot;  Agreement unsalvageable at &quot;, value, &quot;.&quot;);</span>
            }
        }

<span class="nc" id="L2561">        lb.add(&quot; =&gt; &quot;, result);</span>
<span class="nc" id="L2562">        lb.log(logger, Level.INFO);</span>
<span class="nc" id="L2563">        return result;</span>
    }


    /**
     * {@inheritDoc}
     */
    @Override
    public void registerSellGoods(Goods goods) {
<span class="nc" id="L2572">        String goldKey = &quot;tradeGold#&quot; + goods.getType().getId()</span>
<span class="nc" id="L2573">            + &quot;#&quot; + goods.getAmount() + &quot;#&quot; + goods.getLocation().getId();</span>
<span class="nc" id="L2574">        sessionRegister.put(goldKey, null);</span>
<span class="nc" id="L2575">    }</span>

    /**
     * {@inheritDoc}
     */
    @Override
    public int buyProposition(Unit unit, Settlement settlement, Goods goods,
                              int gold) {
<span class="nc" id="L2583">        logger.finest(&quot;Entering method buyProposition&quot;);</span>
<span class="nc" id="L2584">        final Specification spec = getSpecification();</span>
<span class="nc" id="L2585">        Player buyer = unit.getOwner();</span>
<span class="nc" id="L2586">        IndianSettlement is = (IndianSettlement)settlement;</span>
<span class="nc" id="L2587">        String goldKey = &quot;tradeGold#&quot; + goods.getType().getId()</span>
<span class="nc" id="L2588">            + &quot;#&quot; + goods.getAmount() + &quot;#&quot; + settlement.getId();</span>
<span class="nc" id="L2589">        String hagglingKey = &quot;tradeHaggling#&quot; + unit.getId();</span>
<span class="nc" id="L2590">        Integer registered = sessionRegister.get(goldKey);</span>
<span class="nc bnc" id="L2591" title="All 2 branches missed.">        if (registered == null) {</span>
<span class="nc" id="L2592">            int price = is.getPriceToSell(goods)</span>
<span class="nc" id="L2593">                + getPlayer().getTension(buyer).getValue();</span>
<span class="nc bnc" id="L2594" title="All 2 branches missed.">            if (is.hasMissionary(buyer)</span>
<span class="nc bnc" id="L2595" title="All 2 branches missed.">                &amp;&amp; spec.getBoolean(GameOptions.ENHANCED_MISSIONARIES)) {</span>
<span class="nc" id="L2596">                Unit u = is.getMissionary();</span>
<span class="nc" id="L2597">                price = (int)FeatureContainer.applyModifiers(price,</span>
<span class="nc" id="L2598">                    getGame().getTurn(), u.getMissionaryTradeModifiers(false));</span>
            }
<span class="nc" id="L2600">            sessionRegister.put(goldKey, price);</span>
<span class="nc" id="L2601">            return price;</span>
        } else {
<span class="nc" id="L2603">            int price = registered;</span>
<span class="nc bnc" id="L2604" title="All 4 branches missed.">            if (price &lt; 0 || price == gold) {</span>
<span class="nc" id="L2605">                return price;</span>
<span class="nc bnc" id="L2606" title="All 2 branches missed.">            } else if (gold &lt; (price * 9) / 10) {</span>
<span class="nc" id="L2607">                logger.warning(&quot;Cheating attempt: sending a offer too low&quot;);</span>
<span class="nc" id="L2608">                sessionRegister.put(goldKey, -1);</span>
<span class="nc" id="L2609">                return Constants.NO_TRADE;</span>
            } else {
<span class="nc" id="L2611">                int haggling = 1;</span>
<span class="nc bnc" id="L2612" title="All 2 branches missed.">                if (sessionRegister.containsKey(hagglingKey)) {</span>
<span class="nc" id="L2613">                    haggling = sessionRegister.get(hagglingKey);</span>
                }
<span class="nc" id="L2615">                if (randomInt(logger, &quot;Buy gold&quot;, getAIRandom(),</span>
<span class="nc bnc" id="L2616" title="All 2 branches missed.">                              3 + haggling) &lt;= 3) {</span>
<span class="nc" id="L2617">                    sessionRegister.put(goldKey, gold);</span>
<span class="nc" id="L2618">                    sessionRegister.put(hagglingKey, haggling + 1);</span>
<span class="nc" id="L2619">                    return gold;</span>
                } else {
<span class="nc" id="L2621">                    sessionRegister.put(goldKey, -1);</span>
<span class="nc" id="L2622">                    return Constants.NO_TRADE_HAGGLE;</span>
                }
            }
        }
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public int sellProposition(Unit unit, Settlement settlement, Goods goods, 
                               int gold) {
<span class="nc" id="L2634">        logger.finest(&quot;Entering method sellProposition&quot;);</span>
<span class="nc" id="L2635">        Colony colony = (Colony) settlement;</span>
<span class="nc" id="L2636">        Player otherPlayer = unit.getOwner();</span>
        // don't pay for more than fits in the warehouse
<span class="nc" id="L2638">        int amount = colony.getWarehouseCapacity()</span>
<span class="nc" id="L2639">            - colony.getGoodsCount(goods.getType());</span>
<span class="nc" id="L2640">        amount = Math.min(amount, goods.getAmount());</span>
        // get a good price
<span class="nc" id="L2642">        Tension.Level tensionLevel = getPlayer().getTension(otherPlayer).getLevel();</span>
<span class="nc" id="L2643">        int percentage = (9 - tensionLevel.ordinal()) * 10;</span>
        // what we could get for the goods in Europe (minus taxes)
<span class="nc" id="L2645">        int netProfits = ((100 - getPlayer().getTax())</span>
<span class="nc" id="L2646">                          * getPlayer().getMarket().getSalePrice(goods.getType(), amount)) / 100;</span>
<span class="nc" id="L2647">        return (netProfits * percentage) / 100;</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public boolean acceptTax(int tax) {
<span class="nc" id="L2655">        boolean ret = true;</span>
<span class="nc" id="L2656">        LogBuilder lb = new LogBuilder(64);</span>
<span class="nc" id="L2657">        Goods toBeDestroyed = getPlayer().getMostValuableGoods();</span>
<span class="nc" id="L2658">        lb.add(&quot;Tax demand to &quot;, getPlayer().getName(), &quot; of &quot;, tax, &quot;% with &quot;,</span>
<span class="nc" id="L2659">            getPlayer().getMostValuableGoods(), &quot; &quot;);</span>
<span class="nc bnc" id="L2660" title="All 2 branches missed.">        GoodsType goodsType = (toBeDestroyed == null) ? null</span>
<span class="nc" id="L2661">            : toBeDestroyed.getType();</span>

<span class="nc bnc" id="L2663" title="All 2 branches missed.">        if (tax &lt;= 2) {</span>
            // Accept small increase.
<span class="nc" id="L2665">            ret = true;</span>
<span class="nc" id="L2666">            lb.add(&quot;accepted: small rise.&quot;);</span>
<span class="nc bnc" id="L2667" title="All 2 branches missed.">        } else if (toBeDestroyed == null) {</span>
            // Is this cheating to look at what the crown will destroy?
<span class="nc" id="L2669">            ret = false;</span>
<span class="nc" id="L2670">            lb.add(&quot;rejected: no-goods-under-threat.&quot;);</span>
<span class="nc bnc" id="L2671" title="All 2 branches missed.">        } else if (goodsType.isFoodType()) {</span>
<span class="nc" id="L2672">            ret = false;</span>
<span class="nc" id="L2673">            lb.add(&quot;rejected: food-type.&quot;);</span>
<span class="nc bnc" id="L2674" title="All 2 branches missed.">        } else if (goodsType.isBreedable()) {</span>
            // Refuse if we already have this type under production in
            // multiple places.
<span class="nc" id="L2677">            int n = count(getPlayer().getSettlements(),</span>
<span class="nc bnc" id="L2678" title="All 2 branches missed.">                s -&gt; s.getGoodsCount(goodsType) &gt; 0);</span>
<span class="nc bnc" id="L2679" title="All 2 branches missed.">            ret = n &lt; 2;</span>
<span class="nc bnc" id="L2680" title="All 2 branches missed.">            if (ret) {</span>
<span class="nc" id="L2681">                lb.add(&quot;accepted: breedable-type-&quot;, goodsType.getSuffix(), </span>
<span class="nc" id="L2682">                       &quot;-missing.&quot;);</span>
<span class="nc" id="L2683">            } else {</span>
<span class="nc" id="L2684">                lb.add(&quot;rejected: breedable-type-&quot;, goodsType.getSuffix(),</span>
<span class="nc" id="L2685">                       &quot;-present-in-&quot;, n, &quot;-settlements.&quot;);</span>
            }
<span class="nc bnc" id="L2687" title="All 2 branches missed.">        } else if (goodsType.isMilitaryGoods()</span>
<span class="nc bnc" id="L2688" title="All 2 branches missed.">            || goodsType.isTradeGoods()</span>
<span class="nc bnc" id="L2689" title="All 2 branches missed.">            || goodsType.isBuildingMaterial()) {</span>
            // By age 3 we should be able to produce enough ourselves.
            // FIXME: check whether we have an armory, at least
<span class="nc" id="L2692">            int turn = getGame().getTurn().getNumber();</span>
<span class="nc bnc" id="L2693" title="All 2 branches missed.">            ret = turn &lt; 300;</span>
<span class="nc bnc" id="L2694" title="All 2 branches missed.">            lb.add(((ret) ? &quot;accepted&quot; : &quot;rejected&quot;),</span>
<span class="nc" id="L2695">                   &quot;: special-goods-in-turn-&quot;, turn, &quot;.&quot;);</span>
<span class="nc" id="L2696">        } else {</span>
            // FIXME: consider the amount of goods produced. If we
            // depend on shipping huge amounts of cheap goods, we
            // don't want these goods to be boycotted.
<span class="nc" id="L2700">            final List&lt;GoodsType&gt; goodsTypes = getSpecification()</span>
<span class="nc" id="L2701">                .getStorableGoodsTypeList();</span>
<span class="nc" id="L2702">            int averageIncome = sum(goodsTypes,</span>
<span class="nc" id="L2703">                gt -&gt; getPlayer().getIncomeAfterTaxes(gt)) / goodsTypes.size();</span>
<span class="nc" id="L2704">            int income = getPlayer().getIncomeAfterTaxes(toBeDestroyed.getType());</span>
<span class="nc bnc" id="L2705" title="All 4 branches missed.">            ret = income &lt;= 0 || income &gt; averageIncome;</span>
<span class="nc bnc" id="L2706" title="All 2 branches missed.">            lb.add(((ret) ? &quot;accepted&quot; : &quot;rejected&quot;),</span>
<span class="nc" id="L2707">                &quot;: goods(&quot;, goodsType.getSuffix(), &quot;)-with-income(&quot;, income,</span>
<span class="nc bnc" id="L2708" title="All 2 branches missed.">                ((ret) ? &quot;)non-positive-or-more-than(&quot; : &quot;)less-than-average(&quot;),</span>
<span class="nc" id="L2709">                averageIncome, &quot;).&quot;);</span>
        }
<span class="nc bnc" id="L2711" title="All 2 branches missed.">        if (!ret) suppressEuropeanTrade(goodsType, lb);</span>
<span class="nc" id="L2712">        lb.log(logger, Level.INFO);</span>
<span class="nc" id="L2713">        return ret;</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public boolean acceptMercenaries() {
<span class="nc bnc" id="L2721" title="All 4 branches missed.">        return getPlayer().isAtWar() || &quot;conquest&quot;.equals(getAIAdvantage());</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public FoundingFather selectFoundingFather(List&lt;FoundingFather&gt; ffs) {
<span class="nc" id="L2729">        final int age = getGame().getAge();</span>
<span class="nc" id="L2730">        FoundingFather bestFather = null;</span>
<span class="nc" id="L2731">        int bestWeight = Integer.MIN_VALUE;</span>
<span class="nc bnc" id="L2732" title="All 2 branches missed.">        for (FoundingFather father : ffs) {</span>
<span class="nc bnc" id="L2733" title="All 2 branches missed.">            if (father == null) continue;</span>

            // For the moment, arbitrarily: always choose the one
            // offering custom houses.  Allowing the AI to build CH
            // early alleviates the complexity problem of handling all
            // TransportMissions correctly somewhat.
<span class="nc bnc" id="L2739" title="All 2 branches missed.">            if (father.hasAbility(Ability.BUILD_CUSTOM_HOUSE)) {</span>
<span class="nc" id="L2740">                bestFather = father;</span>
<span class="nc" id="L2741">                break;</span>
            }

<span class="nc" id="L2744">            int weight = father.getWeight(age);</span>
<span class="nc bnc" id="L2745" title="All 2 branches missed.">            if (weight &gt; bestWeight) {</span>
<span class="nc" id="L2746">                bestWeight = weight;</span>
<span class="nc" id="L2747">                bestFather = father;</span>
            }
        }
<span class="nc" id="L2750">        return bestFather;</span>
    }


    // Serialization

    /**
     * {@inheritDoc}
     */
    @Override
<span class="nc" id="L2760">    public String getXMLTagName() { return getTagName(); }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span>net.sf.freecol.tools (2) (May 15, 2016 11:18:55 PM)</div></body></html>